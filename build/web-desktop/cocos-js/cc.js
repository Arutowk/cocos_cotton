System.register([],(function(t,e){"use strict";return{execute:function(){function n(t){var e,n;return e=(t>65535)<<4,e|=n=((t>>>=e)>255)<<3,e|=n=((t>>>=n)>15)<<2,(e|=n=((t>>>=n)>3)<<1)|(t>>>=n)>>1}function i(t){var e=32;return(t&=-t)&&e--,65535&t&&(e-=16),16711935&t&&(e-=8),252645135&t&&(e-=4),858993459&t&&(e-=2),1431655765&t&&(e-=1),e}function r(t){return--t,t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,1+(t|=t>>>16)}t({BitMask:ne,CCClass:Je,CacheMode:void 0,DebugMode:void 0,ECollider2DType:void 0,EJoint2DType:void 0,EPhysics2DDrawFlags:void 0,ERaycast2DType:void 0,ERigidBody2DType:void 0,Enum:ie,Eventify:Jl,ExtrapolationMode:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,KeyCode:void 0,Overflow:void 0,Physics2DManifoldType:void 0,PhysicsGroup:void 0,PipelineEventType:void 0,QuatInterpolationMode:void 0,RealInterpolationMode:void 0,SystemEventType:void 0,TangentWeightMode:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:CE,WorldNode3DToWorldNodeUI:AE,absMax:Sn,absMaxComponent:xn,approx:rn,assert:S,assertID:O,bezier:If,bezierByTime:Xf,ccenum:ae,clamp:on,clamp01:an,color:Tn,computeRatioByType:rG,createDefaultPipeline:SM,debug:C,deserialize:Bh,earcut:pJ,enumerableProps:Cn,equals:nn,error:x,errorID:D,find:vD,fragmentText:Vk,getBaselineOffset:function(){return 0},getError:N,getPathFromRoot:function(t,e){for(var n=t,i="";null!==n&&n!==e;)i=n.name+"/"+i,n=n.parent;return i.slice(0,-1)},getSerializationMetadata:function(t){return t[mc]},getWorldTransformUntilRoot:OU,instantiate:Kh,inverseLerp:yn,isCustomTargetModifier:UU,isDisplayStats:L,isElementModifier:VU,isPropertyModifier:GU,isUnicodeCJK:Lk,isUnicodeSpace:Fk,isValid:_l,lerp:sn,log:g,logID:w,markAsWarning:void 0,mat4:jn,murmurhash2_32_gc:po,nextPow2:mn,pingPong:gn,pseudoRandom:fn,pseudoRandomRange:pn,pseudoRandomRangeInt:dn,quat:Gn,randomRange:hn,randomRangeInt:_n,rect:ei,removeProperty:void 0,repeat:vn,replaceProperty:void 0,safeMeasureText:zk,sampleAnimationCurve:iG,setDefaultLogTimes:function(t){t>0&&(W=t)},setDisplayStats:F,size:$n,toDegree:ln,toRadian:cn,v2:Yn,v3:In,v4:Jn,warn:y,warnID:I});var o=new Array(256);!function(t){for(var e=0;e<256;++e){var n=e,i=e,r=7;for(n>>>=1;n;n>>>=1)i<<=1,i|=1&n,--r;t[e]=i<<r&255}}(o);var a=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:2147483647,INT_MIN:-2147483648,sign:function(t){return(t>0)-(t<0)},abs:function(t){var e=t>>31;return(t^e)-e},min:function(t,e){return e^(t^e)&-(t<e)},max:function(t,e){return t^(t^e)&-(t<e)},isPow2:function(t){return!(t&t-1||!t)},log2:n,log10:function(t){return t>=1e9?9:t>=1e8?8:t>=1e7?7:t>=1e6?6:t>=1e5?5:t>=1e4?4:t>=1e3?3:t>=100?2:t>=10?1:0},popCount:function(t){return 16843009*((t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135)>>>24},countTrailingZeros:i,nextPow2:r,prevPow2:function(t){return t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,(t|=t>>>16)-(t>>>1)},parity:function(t){return t^=t>>>16,t^=t>>>8,t^=t>>>4,27030>>>(t&=15)&1},reverse:function(t){return o[255&t]<<24|o[t>>>8&255]<<16|o[t>>>16&255]<<8|o[t>>>24&255]},interleave2:function(t,e){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))<<1},deinterleave2:function(t,e){return(t=65535&((t=16711935&((t=252645135&((t=858993459&((t=t>>>e&1431655765)|t>>>1))|t>>>2))|t>>>4))|t>>>16))<<16>>16},interleave3:function(t,e,n){return t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2),(t|=(e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2))<<1)|(n=1227133513&((n=3272356035&((n=251719695&((n=4278190335&((n&=1023)|n<<16))|n<<8))|n<<4))|n<<2))<<2},deinterleave3:function(t,e){return(t=1023&((t=4278190335&((t=251719695&((t=3272356035&((t=t>>>e&1227133513)|t>>>2))|t>>>4))|t>>>8))|t>>>16))<<22>>22},nextCombination:function(t){var e=t|t-1;return e+1|(~e&-~e)-1>>>i(t)+1}});t("bits",a);var s="undefined"==typeof window?global:window,c=t("cclegacy",{_global:s});c.internal={},s.CC_BUILD=!0,s.CC_TEST=!1,s.CC_EDITOR=false,s.CC_PREVIEW=!1,s.CC_DEV=!1,s.CC_DEBUG=!1,s.CC_JSB=!1,s.CC_BYTEDANCE=!1,s.CC_WECHAT=!1,s.CC_ALIPAY=!1,s.CC_XIAOMI=!1,s.CC_BAIDU=!1,s.CC_COCOSPLAY=!1,s.CC_HUAWEI=!1,s.CC_OPPO=!1,s.CC_VIVO=!1,s.CC_MINIGAME=!1,s.CC_RUNTIME_BASED=!1,s.CC_SUPPORT_JIT=!0;var l=t("VERSION","3.4.2");s.CocosEngine=c.ENGINE_VERSION=l,s.cc=c;var u="https://github.com/cocos-creator/engine/blob/develop/EngineErrorMap.md",h=null,_=console.log.bind(console),f=_,p=_,d=function(t,e){if(!t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];console.log("ASSERT: "+v.apply(void 0,[e].concat(i)))}},m=_;function v(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return c.js.formatStr.apply(null,[t].concat(n))}function g(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return _.apply(void 0,[t].concat(n))}function y(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return f.apply(void 0,[t].concat(n))}function x(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return p.apply(void 0,[t].concat(n))}function S(t,e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return d.apply(void 0,[t,e].concat(i))}function C(){return m.apply(void 0,arguments)}function A(t){if(_=f=p=d=m=function(){},t!==B.NONE){if(t>B.ERROR){var e=function(t){if(c.game.canvas){if(!h){var e=document.createElement("Div");e.setAttribute("id","logInfoDiv"),e.setAttribute("width","200"),e.setAttribute("height",c.game.canvas.height);var n=e.style;n.zIndex="99999",n.position="absolute",n.top=n.left="0",(h=document.createElement("textarea")).setAttribute("rows","20"),h.setAttribute("cols","30"),h.setAttribute("disabled","true");var i=h.style;i.backgroundColor="transparent",i.borderBottom="1px solid #cccccc",i.borderTopWidth=i.borderLeftWidth=i.borderRightWidth="0px",i.borderTopStyle=i.borderLeftStyle=i.borderRightStyle="none",i.padding="0px",i.margin="0px",e.appendChild(h),c.game.canvas.parentNode.appendChild(e)}h.value=h.value+t+"\r\n",h.scrollTop=h.scrollHeight}};p=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];e("ERROR :  "+v.apply(void 0,[t].concat(i)))},d=function(t,n){if(!t){for(var i=arguments.length,r=new Array(i>2?i-2:0),o=2;o<i;o++)r[o-2]=arguments[o];e("ASSERT: "+v.apply(void 0,[n].concat(r)))}},t!==B.ERROR_FOR_WEB_PAGE&&(f=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];e("WARN :  "+v.apply(void 0,[t].concat(i)))}),t===B.INFO_FOR_WEB_PAGE&&(_=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];e(v.apply(void 0,[t].concat(i)))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),p=console.error.bind?console.error.bind(console):function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return console.error.apply(console,[t].concat(n))},d=function(t,e){if(!t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];var o=v.apply(void 0,[e].concat(i));throw new Error(o)}});if(t!==B.ERROR&&(f=console.warn.bind?console.warn.bind(console):function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return console.warn.apply(console,[t].concat(n))}),t<=B.INFO&&(_=console.log.bind?console.log.bind(console):function(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return console.log.apply(console,[t].concat(n))}),t<=B.VERBOSE&&"function"==typeof console.debug){var n=console.debug.bind(console);m=function(){return n.apply(void 0,arguments)}}}}function b(t){x(t.stack||t)}function T(t){return function(e){for(var n=t+" "+e+", please go to "+u+"#"+e+" to see details.",i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];return 0===r.length?n:n+" Arguments: "+r.join(", ")}}var E=T("Log");function w(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];g(E.apply(void 0,[t].concat(n)))}var P=T("Warning");function I(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];y(P.apply(void 0,[t].concat(n)))}var R=T("Error");function D(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];x(R.apply(void 0,[t].concat(n)))}var B,M=T("Assert");function O(t,e){if(!t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];S(!1,M.apply(void 0,[e].concat(i)))}}function N(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return R.apply(void 0,[t].concat(n))}function L(){return!!c.profiler&&c.profiler.isShowingStats()}function F(t){c.profiler&&(t?c.profiler.showStats():c.profiler.hideStats(),c.game.config.showFPS=!!t)}!function(t){t[t.NONE=0]="NONE",t[t.VERBOSE=1]="VERBOSE",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",t[t.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",t[t.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE"}(B||(B=t("DebugMode",{})));var z,G,V,U,k,H,j=Object.freeze({__proto__:null,log:g,warn:y,error:x,assert:S,debug:C,_resetDebugSetting:A,_throw:b,logID:w,warnID:I,errorID:D,assertID:O,get DebugMode(){return B},getError:N,isDisplayStats:L,setDisplayStats:F}),W=10,q=0,X=new Map;function Y(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function K(t,e,n){return e&&Y(t.prototype,e),n&&Y(t,n),t}function J(){return(J=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i])}return t}).apply(this,arguments)}function Q(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,$(t,e)}function Z(t){return(Z=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function $(t,e){return($=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function tt(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}function et(t,e,n){return(et=tt()?Reflect.construct:function(t,e,n){var i=[null];i.push.apply(i,e);var r=new(Function.bind.apply(t,i));return n&&$(r,n.prototype),r}).apply(null,arguments)}function nt(t){var e="function"==typeof Map?new Map:void 0;return(nt=function(t){if(null===t||(n=t,-1===Function.toString.call(n).indexOf("[native code]")))return t;var n;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,i)}function i(){return et(t,arguments,Z(this).constructor)}return i.prototype=Object.create(t.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),$(i,t)})(t)}function it(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function rt(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function ot(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=function(t,e){if(t){if("string"==typeof t)return rt(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?rt(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0;return function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=t[Symbol.iterator]()).next.bind(n)}function at(t,e,n,i){n&&Object.defineProperty(t,e,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(i):void 0})}function st(t,e,n,i,r){var o={};return Object.keys(i).forEach((function(t){o[t]=i[t]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=n.slice().reverse().reduce((function(n,i){return i(t,e,n)||n}),o),r&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(r):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(t,e,o),o=null),o}U=function(t,e,n,i,r,o,a){var s=X.get(o);s&&s.logTimes>s.count&&(r("'%s' is deprecated, please use '%s' instead. "+a,t+"."+e,n+"."+i),s.count++)},z=t("replaceProperty",(function(t,e,n){null!=t&&n.forEach((function(n){var i=q++;X.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:W});var r=null!=n.target?n.target:t,o=null!=n.newName?n.newName:n.name,a=null!=n.targetName?n.targetName:e,s=r===t,c=n.suggest?"("+n.suggest+")":"";if(null!=n.customFunction)t[n.name]=function(){var t;return U(e,n.name,a,o,y,i,c),(t=n.customFunction).call.apply(t,[this].concat(Array.prototype.slice.call(arguments)))};else if(null!=n.customSetter||null!=n.customGetter){var l=null!=n.customSetter,u=null!=n.customGetter;l&&u?Object.defineProperty(t,n.name,{get:function(){return U(e,n.name,a,o,y,i,c),n.customGetter.call(this)},set:function(t){U(e,n.name,a,o,y,i,c),n.customSetter.call(this,t)},enumerable:!1}):l?Object.defineProperty(t,n.name,{set:function(t){U(e,n.name,a,o,y,i,c),n.customSetter.call(this,t)},enumerable:!1}):u&&Object.defineProperty(t,n.name,{get:function(){return U(e,n.name,a,o,y,i,c),n.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(t,n.name,{get:function(){return U(e,n.name,a,o,y,i,c),s?this[o]:r[o]},set:function(t){U(e,n.name,a,o,y,i,c),s?this[o]=t:r[o]=t},enumerable:!1})}))})),H=function(t,e,n,i,r){var o=X.get(i);o&&o.logTimes>o.count&&(n("'%s' has been removed. "+r,t+"."+e),o.count++)},G=t("removeProperty",(function(t,e,n){null!=t&&n.forEach((function(n){var i=q++;X.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:W});var r=n.suggest?"("+n.suggest+")":"";Object.defineProperty(t,n.name,{get:function(){return H(e,n.name,x,i,r)},set:function(){H(e,n.name,x,i,r)},enumerable:!1})}))})),k=function(t,e,n,i,r){var o=X.get(i);o&&o.logTimes>o.count&&(n("'%s' is deprecated. "+r,t+"."+e),o.count++)},V=t("markAsWarning",(function(t,e,n){null!=t&&n.forEach((function(n){var i=n.name,r=Object.getOwnPropertyDescriptor(t,i);if(r&&r.configurable){var o=q++;X.set(o,{id:o,count:0,logTimes:void 0!==n.logTimes?n.logTimes:W});var a=n.suggest?"("+n.suggest+")":"";if(void 0!==r.value)if("function"==typeof r.value){var s=r.value;t[i]=function(){return k(e,i,y,o,a),s.call.apply(s,[this].concat(Array.prototype.slice.call(arguments)))}}else{var c=r.value;Object.defineProperty(t,i,{configurable:!0,get:function(){return k(e,i,y,o,a),c}}),r.writable&&Object.defineProperty(t,i,{set:function(t){k(e,i,y,o,a),c=t}})}else!function(e,n,i,r,o,a){if(e.get){var s=e.get;e.get=function(){return k(n,i,r,o,a),s.call(this)}}if(e.set){var c=e.set;e.set=function(t){k(n,i,r,o,a),c.call(this,t)}}Object.defineProperty(t,i,e)}(r,e,i,y,o,a);Object.defineProperty(t,i,{enumerable:!1})}}))}));var ct=function(){function t(t){this.i=0,this.array=t}var e=t.prototype;return e.remove=function(t){var e=this.array.indexOf(t);e>=0&&this.removeAt(e)},e.removeAt=function(t){this.array.splice(t,1),t<=this.i&&--this.i},e.fastRemove=function(t){var e=this.array.indexOf(t);e>=0&&this.fastRemoveAt(e)},e.fastRemoveAt=function(t){var e=this.array;e[t]=e[e.length-1],--e.length,t<=this.i&&--this.i},e.push=function(t){this.array.push(t)},K(t,[{key:"length",get:function(){return this.array.length},set:function(t){this.array.length=t,this.i>=t&&(this.i=t-1)}}]),t}();function lt(t,e){t.splice(e,1)}function ut(t,e){var n=t.length;e<0||e>=n||(t[e]=t[n-1],t.length=n-1)}function ht(t,e){var n=t.indexOf(e);return n>=0&&(lt(t,n),!0)}function _t(t,e){return t.indexOf(e)>=0}var ft=Object.freeze({__proto__:null,removeAt:lt,fastRemoveAt:ut,remove:ht,fastRemove:function(t,e){var n=t.indexOf(e);n>=0&&(t[n]=t[t.length-1],--t.length)},removeIf:function(t,e){var n=t.findIndex(e);if(n>=0){var i=t[n];return lt(t,n),i}},verifyType:function(t,e){if(t&&t.length>0)for(var n,i=ot(t);!(n=i()).done;)if(!(n.value instanceof e))return w(1300),!1;return!0},removeArray:function(t,e){for(var n=0,i=e.length;n<i;n++)ht(t,e[n])},appendObjectsAt:function(t,e,n){return t.splice.apply(t,[n,0].concat(e)),t},contains:_t,copy:function(t){for(var e=t.length,n=new Array(e),i=0;i<e;i+=1)n[i]=t[i];return n},MutableForwardIterator:ct}),pt=function(){function t(t){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=t?t+".":""}return t.prototype.getNewId=function(){return this.prefix+ ++this.id},t}();pt.global=new pt("global");var dt=new pt("TmpCId."),mt="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),vt="__cid__";function gt(t){return"number"==typeof t||t instanceof Number}function yt(t){return"string"==typeof t||t instanceof String}function xt(t){for(var e in t)return!1;return!0}var St,Ct=(St={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(t,e,n,i,r){St.value=n,St.writable=i,St.enumerable=r,Object.defineProperty(t,e,St),St.value=void 0}),At=function(){var t={get:void 0,set:void 0,enumerable:!1};return function(e,n,i,r,o,a){void 0===o&&(o=!1),void 0===a&&(a=!1),"boolean"==typeof r&&(o=r,r=void 0),t.get=i,t.set=r,t.enumerable=o,t.configurable=a,Object.defineProperty(e,n,t),t.get=void 0,t.set=void 0}}(),bt=function(){var t={get:void 0,enumerable:!1,configurable:!1};return function(e,n,i,r,o){t.get=i,t.enumerable=r,t.configurable=o,Object.defineProperty(e,n,t),t.get=void 0}}(),Tt=function(){var t={set:void 0,enumerable:!1,configurable:!1};return function(e,n,i,r,o){t.set=i,t.enumerable=r,t.configurable=o,Object.defineProperty(e,n,t),t.set=void 0}}();function Et(t){var e=Object.create(null);return t&&(e["."]=1,e["/"]=1,delete e["."],delete e["/"]),e}function wt(t){if("function"==typeof t){var e=t.prototype;if(e&&e.hasOwnProperty("__classname__")&&e.__classname__)return e.__classname__;var n="";if(t.name&&(n=t.name),t.toString){var i,r=t.toString();(i="["===r.charAt(0)?r.match(/\[\w+\s*(\w+)\]/):r.match(/function\s*(\w+)/))&&2===i.length&&(n=i[1])}return"Object"!==n?n:""}return t&&t.constructor?wt(t.constructor):""}function Pt(t,e,n,i){var r=/([^.]+)$/,o=r.exec(e)[0],a=r.exec(n)[0];function s(){return this[a]}i?At(t,o,s,(function(t){this[a]=t})):bt(t,o,s)}function It(t,e,n,i){for(var r in n)Pt(t,e+"."+r,n[r],i)}var Rt=/(%d)|(%s)/,Dt=/%s/;function Bt(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];if(0===arguments.length)return"";if(0===n.length)return""+t;var r="string"==typeof t&&Rt.test(t);if(r)for(var o,a=ot(n);!(o=a()).done;){var s=o.value,c="number"==typeof s?Rt:Dt;if(c.test(t)){var l=""+s;t=t.replace(c,l)}else t+=" "+s}else for(var u,h=ot(n);!(u=h()).done;){var _=u.value;t+=" "+_}return t}function Mt(){for(var t=arguments.length-1,e=new Array(t),n=0;n<t;++n)e[n]=arguments[n+1];return e}function Ot(t,e){for(;t;){var n=Object.getOwnPropertyDescriptor(t,e);if(n)return n;t=Object.getPrototypeOf(t)}return null}function Nt(t,e,n){var i=Ot(e,t);i&&Object.defineProperty(n,t,i)}function Lt(t){t=t||{};for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){D(5402,a);continue}for(var s in a)s in t||Nt(s,a,t)}}return t}function Ft(t){t=t||{};for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){D(5403,a);continue}for(var s in a)Nt(s,a,t)}}return t}function zt(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t.prototype=Object.create(e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),t}function Gt(t){var e=t.prototype,n=e&&Object.getPrototypeOf(e);return n&&n.constructor}function Vt(t,e){if(t&&e){if("function"!=typeof t)return!1;if("function"!=typeof e)return!1;if(t===e)return!0;for(;;){if(!(t=Gt(t)))return!1;if(t===e)return!0}}return!1}function Ut(t){for(var e=0,n=Object.keys(t);e<n.length;e++)delete t[n[e]]}var kt=Et(!0),Ht=Et(!0);function jt(t,e){return function(n,i){if(i.prototype.hasOwnProperty(t)&&delete e[i.prototype[t]],Ct(i.prototype,t,n),n){var r=e[n];r&&r!==i?x("A Class already exists with the same "+t+' : "'+n+'".'):e[n]=i}}}var Wt=jt("__cid__",kt),qt=jt("__classname__",Ht);function Xt(t,e){if(qt(t,e),!e.prototype.hasOwnProperty(vt)){var n=t||dt.getNewId();n&&Wt(n,e)}}function Yt(t,e){var n=Ht[e],i=kt[e],r=!0;if(n&&n!==t&&(x('"'+e+'" has already been set as name or alias of another class.'),r=!1),i&&i!==t&&(x('"'+e+'" has already been set as id or alias of another class.'),r=!1),r){var o=t[mt];o||(o=[],t[mt]=o),o.push(e),Ht[e]=t,kt[e]=t}}function Kt(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];for(var i=0,r=e;i<r.length;i++){var o=r[i],a=o.prototype,s=a.__cid__;s&&delete kt[s];var c=a.__classname__;c&&delete Ht[c];var l=a[mt];if(l)for(var u=0;u<l.length;++u){var h=l[u];delete Ht[h],delete kt[h]}}}function Jt(t){return kt[t]}function Qt(t){return Ht[t]}function Zt(t,e){if(e=void 0===e||e,"function"==typeof t&&t.prototype.hasOwnProperty(vt))return t.prototype.__cid__;if(t&&t.constructor){var n=t.constructor.prototype;if(n&&n.hasOwnProperty(vt))return t.__cid__}return""}var $t=function(){var t=e.prototype;function e(t,e){this.count=void 0,this._pool=void 0,this._cleanup=void 0;var n=void 0===e?t:e,i=void 0===e?null:t;this.count=0,this._pool=new Array(n),this._cleanup=i}return t.get=function(){return this._get()},t._get=function(){if(this.count>0){--this.count;var t=this._pool[this.count];return this._pool[this.count]=null,t}return null},t.put=function(t){var e=this._pool;if(this.count<e.length){if(this._cleanup&&!1===this._cleanup(t))return;e[this.count]=t,++this.count}},t.resize=function(t){t>=0&&(this._pool.length=t,this.count>t&&(this.count=t))},e}(),te=ft,ee={IDGenerator:pt,Pool:$t,array:ft,isNumber:gt,isString:yt,isEmptyObject:xt,getPropertyDescriptor:Ot,addon:Lt,mixin:Ft,extend:zt,getSuper:Gt,isChildClassOf:Vt,clear:Ut,value:Ct,getset:At,get:bt,set:Tt,unregisterClass:Kt,getClassName:wt,setClassName:Xt,setClassAlias:Yt,getClassByName:Qt,get _registeredClassNames(){return J({},Ht)},set _registeredClassNames(t){Ut(Ht),Object.assign(Ht,t)},get _registeredClassIds(){return J({},kt)},set _registeredClassIds(t){Ut(kt),Object.assign(kt,t)},_getClassId:Zt,_setClassId:Wt,_getClassById:Jt,obsolete:Pt,obsoletes:It,formatStr:Bt,shiftArguments:Mt,createMap:Et};function ne(t){if("__bitmask__"in t)return t;Ct(t,"__bitmask__",null,!0);for(var e=-1,n=Object.keys(t),i=0;i<n.length;i++){var r=n[i],o=t[r];if(-1===o)o=++e,t[r]=o;else if("number"==typeof o)e=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&Ct(t,a,r)}return t}function ie(t){return"__enums__"in t?t:(Ct(t,"__enums__",null,!0),ie.update(t))}function re(t){t.hasOwnProperty("__enums__")}function oe(t){re(t);var e=t.__enums__||[];for(var n in e.length=0,t){var i=t[n];Number.isInteger(i)&&e.push({name:n,value:i})}return e.sort((function(t,e){return t.value-e.value})),t.__enums__=e,e}function ae(t){"__enums__"in t||Ct(t,"__enums__",null,!0)}c.js=ee,t("js",Object.freeze({__proto__:null,array:te,js:ee,IDGenerator:pt,Pool:$t,isNumber:gt,isString:yt,isEmptyObject:xt,value:Ct,getset:At,get:bt,set:Tt,createMap:Et,getClassName:wt,obsolete:Pt,obsoletes:It,formatStr:Bt,shiftArguments:Mt,getPropertyDescriptor:Ot,addon:Lt,mixin:Ft,extend:zt,getSuper:Gt,isChildClassOf:Vt,clear:Ut,_idToClass:kt,_nameToClass:Ht,_setClassId:Wt,setClassName:Xt,setClassAlias:Yt,unregisterClass:Kt,_getClassById:Jt,getClassByName:Qt,_getClassId:Zt})),ne.isBitMask=function(t){return t&&t.hasOwnProperty("__bitmask__")},ne.getList=function(t){if(t.__bitmask__)return t.__bitmask__;var e=t.__bitmask__=[];for(var n in t){var i=t[n];Number.isInteger(i)&&e.push({name:n,value:i})}return e.sort((function(t,e){return t.value-e.value})),e},c.BitMask=ne,ie.update=function(t){for(var e=-1,n=Object.keys(t),i=0;i<n.length;i++){var r=n[i],o=t[r];if(-1===o)o=++e,t[r]=o;else if("number"==typeof o)e=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&Ct(t,a,r)}return Array.isArray(t.__enums__)&&oe(t),t},ie||(ie=t("Enum",{})),ie.isEnum=function(t){return t&&t.hasOwnProperty("__enums__")},ie.getList=function(t){return re(t),t.__enums__?t.__enums__:oe(t)},c.Enum=ie;var se=t("ValueType",function(){function t(){}var e=t.prototype;return e.clone=function(){return D(100,wt(this)+".clone"),this},e.equals=function(){return!1},e.set=function(){D(100,wt(this)+".set")},e.toString=function(){return""+{}},t}());Xt("cc.ValueType",se),c.ValueType=se;var ce=t("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,ENABLE_ANTIALIAS_FXAA:!1,ENABLE_BLOOM:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20,ENABLE_WEBGL_HIGHP_STRUCT_VALUES:!1,BATCHER2D_MEM_INCREMENT:144});c.macro=ce;for(var le=/^(?:cc|dragonBones|sp|ccsg)\..+/,ue=new Array(123),he=0;he<123;++he)ue[he]=64;for(var _e=0;_e<64;++_e)ue["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(_e)]=_e;var fe=ue;function pe(t,e,n){function i(t,e,n,i){var r=Object.getOwnPropertyDescriptor(t,e);if(r)r.get&&(t[n]=r.get),r.set&&i&&(t[i]=r.set);else{var o=t[n];At(t,e,o,t[i])}}for(var r,o=t.prototype,a=0;a<e.length;a++){var s=(r=e[a])[0].toUpperCase()+r.slice(1);i(o,r,"get"+s,"set"+s)}for(r in n){var c=n[r];i(o,r,c[0],c[1])}}function de(t,e,n,i){var r=t[e];r?Array.isArray(r)?i?(r.push(r[0]),r[0]=n):r.push(n):t[e]=i?[n,r]:[r,n]:t[e]=n}function me(t,e){if("function"==typeof t.contains)return t.contains(e);if("function"==typeof t.compareDocumentPosition)return!!(16&t.compareDocumentPosition(e));var n=e.parentNode;if(n)do{if(n===t)return!0;n=n.parentNode}while(null!==n);return!1}function ve(t){return"object"==typeof window&&"function"==typeof Node?t instanceof Node:t&&"object"==typeof t&&"number"==typeof t.nodeType&&"string"==typeof t.nodeName}function ge(t,e,n){t&&setTimeout((function(){t(e,n)}),0)}function ye(t){return!(!t||t.constructor!==Object)&&xt(t)}function xe(t,e,n){if(e>n){var i=e;e=n,n=i}return t<e?e:t<n?t:n}function Se(t){return t*ce.RAD}function Ce(t){return t*ce.DEG}c.misc={BUILTIN_CLASSID_RE:le,BASE64_VALUES:fe,propertyDefine:pe,pushToMap:de,contains:me,isDomNode:ve,callInNextTick:ge,isPlainEmptyObj_DEV:ye,clampf:xe,degreesToRadians:Se,radiansToDegrees:Ce},t("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:le,BASE64_VALUES:fe,propertyDefine:pe,pushToMap:de,contains:me,isDomNode:ve,callInNextTick:ge,tryCatchFunctor_EDITOR:function(t){return Function("target","try {\n  target."+t+"();\n}\ncatch (e) {\n  cc._throw(e);\n}")},isPlainEmptyObj_DEV:ye,clampf:xe,degreesToRadians:Se,radiansToDegrees:Ce}));var Ae="$_$";function be(t,e){var n=e?Object.create(e):{};return Ct(t,"__attrs__",n),n}function Te(t){if("function"!=typeof t)return be(t,we(t.constructor));for(var e,n=c.Class.getInheritanceChain(t),i=n.length-1;i>=0;i--){var r=n[i];r.hasOwnProperty("__attrs__")&&r.__attrs__||be(r,(e=n[i+1])&&e.__attrs__)}return be(t,(e=n[0])&&e.__attrs__),t.__attrs__}function Ee(t,e){var n=we(t),i=e+Ae,r={};for(var o in n)o.startsWith(i)&&(r[o.slice(i.length)]=n[o]);return r}function we(t){return t.hasOwnProperty("__attrs__")&&t.__attrs__||Te(t)}function Pe(t,e,n,i){we(t)[e+Ae+n]=i}var Ie=function(){function t(t,e){this.name=void 0,this.default=void 0,this.name=t,this.default=e}return t.prototype.toString=function(){return this.name},t}(),Re=t("CCInteger",new Ie("Integer",0));c.Integer=Re,c.CCInteger=Re;var De=t("CCFloat",new Ie("Float",0));c.Float=De,c.CCFloat=De;var Be=t("CCBoolean",new Ie("Boolean",!1));c.Boolean=Be,c.CCBoolean=Be;var Me=t("CCString",new Ie("String",""));function Oe(t,e){return function(n,i){var r='"'+wt(n)+"."+i+'"',o=Ee(n,i),a=o.type;if(a===Re||a===De?a="Number":a!==Me&&a!==Be||(a=""+a),a===t){if(o.hasOwnProperty("default")){var s=o.default;if(void 0!==s&&!Array.isArray(s)&&!ye(s)){var c=typeof s,l=t.toLowerCase();if(c===l)if("object"===l){if(!s||s instanceof o.ctor)return;I(3605,r,wt(o.ctor))}else"Number"!==t&&I(3606,e,r,t);else{if("function"===c)return;t===Me.default&&null==s?I(3607,r):I(3611,e,r,c)}delete o.type}}}else I(3604,r)}}c.String=Me,c.CCString=Me;var Ne=Object.freeze({__proto__:null,DELIMETER:Ae,createAttrsSingle:be,createAttrs:Te,attr:Ee,getClassAttrs:we,setClassAttr:Pe,PrimitiveType:Ie,CCInteger:Re,CCFloat:De,CCBoolean:Be,CCString:Me,getTypeChecker_ET:Oe,getObjTypeChecker_ET:function(t){return function(e,n){Oe("Object","type")(e,n);var i=we(e)[n+Ae+"default"],r=c.Class.getDefault(i);if(!Array.isArray(r)&&Vt(t,c.ValueType)){var o=wt(t),a=Bt('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',wt(e),n,o);i?g(a):I(3612,a,o,wt(e),n,o)}}}}),Le={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function Fe(t,e,n,i){if(!t.get&&!t.set&&t.hasOwnProperty("default")){var r="_N$"+e;t.get=function(){return this[r]},t.set=function(t){var e=this[r];this[r]=t,n.call(this,e)};var o={};for(var a in i[r]=o,Le){var s=Le[a];t.hasOwnProperty(a)&&(o[a]=t[a],s.canUsedInGet||delete t[a])}}}function ze(t,e,n,i){if(Array.isArray(e)){if(!(e.length>0))return D(5508,n,i);t.type=e=e[0]}"function"==typeof e&&(e===String?t.type=c.String:e===Boolean?t.type=c.Boolean:e===Number&&(t.type=c.Float))}function Ge(t,e,n){var i=t?{_short:!0}:{_short:!0,default:e};return n&&(i.type=n),i}function Ve(t,e){if(!t||t.constructor!==Object){if(Array.isArray(t)&&t.length>0)return Ge(e,[],t);if("function"==typeof t){var n=t;return Ge(e,Vt(n,c.ValueType)?new n:null,n)}return Ge(e,t instanceof Ie?t.default:t)}return null}var Ue=[];function ke(){return Ue[Ue.length-1]}c._RF={push:function(t,e,n,i){void 0===n&&(n=e,e=""),Ue.push({uuid:e,script:n,module:t,exports:t.exports,beh:null,importMeta:i})},pop:function(){var t=Ue.pop(),e=t.module,n=e.exports;if(n===t.exports){for(var i in n)return;e.exports=n=t.cls}},peek:ke};var He=Ae,je={datas:null,push:function(t){if(this.datas)this.datas.push(t);else{this.datas=[t];var e=this;setTimeout((function(){e.init()}),0)}},init:function(){var t=this.datas;if(t){for(var e=0;e<t.length;++e){var n=t[e],i=n.cls,r=n.props;"function"==typeof r&&(r=r());var o=wt(i);r?Ke(i,o,r,i.$super,n.mixins):D(3633,o)}this.datas=null}}};function We(t,e,n,i){!function(t,e){!function(t,e){t.indexOf(e)<0&&t.push(e)}(t.__props__,e)}(t,n),Ze(t,i,e,n)}function qe(t,e,n,i){var r=i.get;i.set,r&&(Ze(t,i,e,n),Pe(t,n,"serializable",!1))}function Xe(t){return"function"==typeof t?t():t}function Ye(t,e,n){for(var i in e)t.hasOwnProperty(i)||n&&!n(i)||Object.defineProperty(t,i,Ot(e,i))}function Ke(t,e,n,i,r){if(t.__props__=[],i&&i.__props__&&(t.__props__=i.__props__.slice()),r)for(var o=0;o<r.length;++o){var a=r[o];a.__props__&&(t.__props__=t.__props__.concat(a.__props__.filter((function(e){return t.__props__.indexOf(e)<0}))))}if(n)for(var s in function(t,e){for(var n in t){var i=t[n],r=Ve(i,!1);if(r&&(i=t[n]=r),i){var o=i.notify;o&&Fe(i,n,o,t),"type"in i&&ze(i,i.type,e,n)}}}(n,e),n){var c=n[s];c.get||c.set?qe(t,e,s,c):We(t,e,s,c)}var l=we(t);t.__values__=t.__props__.filter((function(t){return!1!==l[t+He+"serializable"]}))}function Je(t){var e=t.name,n=t.extends,i=t.mixins,r=function(t,e,n,i){var r=c.Component,o=ke();if(o&&Vt(e,r)){if(Vt(o.cls,r))return D(3615),null;t=t||o.script}var a=function(t,e,n,i){var r=i.ctor,o=[r],a=r;Ct(a,"__ctors__",o.length>0?o:null,!0);var s=a.prototype;if(e&&(a.$super=e),n){for(var c=n.length-1;c>=0;c--){var l=n[c];Ye(s,l.prototype),Je._isCCClass(l)&&Ye(we(a),we(l))}s.constructor=a}return Xt(t,a),a}(t,e,n,i);if(o)if(Vt(e,r)){var s=o.uuid;s&&Wt(s,a),o.cls=a}else Vt(o.cls,r)||(o.cls=a);return a}(e,n,i,t);e||(e=c.js.getClassName(r)),r._sealed=!0,n&&(n._sealed=!1);var o=t.properties;"function"==typeof o||n&&null===n.__props__||i&&i.some((function(t){return null===t.__props__}))?(je.push({cls:r,props:o,mixins:i}),r.__props__=r.__values__=null):Ke(r,e,o,n,t.mixins);var a=t.editor;return a&&Vt(n,c.Component)&&c.Component._registerEditorProps(r,a),r}Je._isCCClass=function(t){var e;return null==t||null===(e=t.hasOwnProperty)||void 0===e?void 0:e.call(t,"__ctors__")},Je.fastDefine=function(t,e,n){Xt(t,e);for(var i=e.__props__=e.__values__=Object.keys(n),r=we(e),o=0;o<i.length;o++){var a=i[o];r[a+He+"visible"]=!1,r[a+He+"default"]=n[a]}},Je.Attr=Ne,Je.attr=Ee,Je.getInheritanceChain=function(t){for(var e=[];t=Gt(t);)t!==Object&&e.push(t);return e};var Qe={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function Ze(t,e,n,i){var r=null,o="";function a(){return o=i+He,r=we(t)}"type"in e&&void 0===e.type&&I(3660,i,n);var s=e.type;s&&(Qe[s]?(r||a())[o+"type"]=s:"Object"===s||("object"==typeof s?ie.isEnum(s)?((r||a())[o+"type"]="Enum",r[o+"enumList"]=ie.getList(s)):ne.isBitMask(s)&&((r||a())[o+"type"]="BitMask",r[o+"bitmaskList"]=ne.getList(s)):"function"==typeof s&&((r||a())[o+"type"]="Object",r[o+"ctor"]=s))),"default"in e&&((r||a())[o+"default"]=e.default);var c,l=function(t,n){if(t in e){var i=e[t];typeof i===n&&((r||a())[o+t]=i)}};e.editorOnly&&((r||a())[o+"editorOnly"]=!0),e.__noImplicit?(r||a())[o+"serializable"]=null!==(c=e.serializable)&&void 0!==c&&c:!1===e.serializable&&((r||a())[o+"serializable"]=!1),l("formerlySerializedAs","string");var u=e.range;u&&Array.isArray(u)&&u.length>=2&&((r||a())[o+"min"]=u[0],r[o+"max"]=u[1],u.length>2&&(r[o+"step"]=u[2])),l("min","number"),l("max","number"),l("step","number")}Je.isArray=function(t){return t=Xe(t),Array.isArray(t)},Je.getDefault=Xe,Je.escapeForJS=function(t){return JSON.stringify(t).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},Je.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,Je.getNewValueTypeCode=function(t){for(var e=wt(t),n=t.constructor,i="new "+e+"(",r=0;r<n.__props__.length;r++)i+=t[n.__props__[r]],r<n.__props__.length-1&&(i+=",");return i+")"},c.Class=Je;var $e=Math.PI/180,tn=180/Math.PI,en=t("EPSILON",1e-6);function nn(t,e){return Math.abs(t-e)<=en*Math.max(1,Math.abs(t),Math.abs(e))}function rn(t,e,n){return n=n||en,Math.abs(t-e)<=n}function on(t,e,n){if(e>n){var i=e;e=n,n=i}return t<e?e:t>n?n:t}function an(t){return t<0?0:t>1?1:t}function sn(t,e,n){return t+(e-t)*n}function cn(t){return t*$e}function ln(t){return t*tn}var un=t("random",Math.random);function hn(t,e){return Math.random()*(e-t)+t}function _n(t,e){return Math.floor(hn(t,e))}function fn(t){return(t=(9301*t+49297)%233280)/233280}function pn(t,e,n){return fn(t)*(n-e)+e}function dn(t,e,n){return Math.floor(pn(t,e,n))}function mn(t){return--t,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t}function vn(t,e){return t-Math.floor(t/e)*e}function gn(t,e){return t=vn(t,2*e),e-Math.abs(t-e)}function yn(t,e,n){return(n-t)/(e-t)}function xn(t){return Math.abs(t.x)>Math.abs(t.y)?Math.abs(t.x)>Math.abs(t.z)?t.x:t.z:Math.abs(t.y)>Math.abs(t.z)?t.y:t.z}function Sn(t,e){return Math.abs(t)>Math.abs(e)?t:e}function Cn(t,e){e.forEach((function(e){Object.defineProperty(t,e,{enumerable:!0})}))}var An=1/255,bn=t("Color",function(t){function e(e,n,i,r){var o;return(o=t.call(this)||this)._val=0,"string"==typeof e?o.fromHEX(e):void 0!==n?o.set(e,n,i,r):o.set(e),o}Q(e,t),e.clone=function(t){var n=new e;return t._val?n._val=t._val:n._val=(t.a<<24>>>0)+(t.b<<16)+(t.g<<8)+t.r,n},e.copy=function(t,e){return t.r=e.r,t.g=e.g,t.b=e.b,t.a=e.a,t},e.set=function(t,e,n,i,r){return t.r=e,t.g=n,t.b=i,t.a=r,t},e.fromHEX=function(t,e){e=0===e.indexOf("#")?e.substring(1):e,t.r=parseInt(e.substr(0,2),16)||0,t.g=parseInt(e.substr(2,2),16)||0,t.b=parseInt(e.substr(4,2),16)||0;var n=parseInt(e.substr(6,2),16);return t.a=Number.isNaN(n)?255:n,t._val=(t.a<<24>>>0)+(t.b<<16)+(t.g<<8)+t.r,t},e.add=function(t,e,n){return t.r=e.r+n.r,t.g=e.g+n.g,t.b=e.b+n.b,t.a=e.a+n.a,t},e.subtract=function(t,e,n){return t.r=e.r-n.r,t.g=e.g-n.g,t.b=e.b-n.b,t.a=e.a-n.a,t},e.multiply=function(t,e,n){return t.r=e.r*n.r,t.g=e.g*n.g,t.b=e.b*n.b,t.a=e.a*n.a,t},e.divide=function(t,e,n){return t.r=e.r/n.r,t.g=e.g/n.g,t.b=e.b/n.b,t.a=e.a/n.a,t},e.scale=function(t,e,n){return t.r=e.r*n,t.g=e.g*n,t.b=e.b*n,t.a=e.a*n,t},e.lerp=function(t,e,n,i){var r=e.r,o=e.g,a=e.b,s=e.a;return r+=(n.r-r)*i,o+=(n.g-o)*i,a+=(n.b-a)*i,s+=(n.a-s)*i,t._val=Math.floor((s<<24>>>0)+(a<<16)+(o<<8)+r),t},e.toArray=function(t,n,i){void 0===i&&(i=0);var r=n instanceof e||n.a>1?1/255:1;return t[i+0]=n.r*r,t[i+1]=n.g*r,t[i+2]=n.b*r,t[i+3]=n.a*r,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),e.r=255*t[n+0],e.g=255*t[n+1],e.b=255*t[n+2],e.a=255*t[n+3],e},e.strictEquals=function(t,e){return t.r===e.r&&t.g===e.g&&t.b===e.b&&t.a===e.a},e.equals=function(t,e,n){return void 0===n&&(n=en),Math.abs(t.r-e.r)<=n*Math.max(1,Math.abs(t.r),Math.abs(e.r))&&Math.abs(t.g-e.g)<=n*Math.max(1,Math.abs(t.g),Math.abs(e.g))&&Math.abs(t.b-e.b)<=n*Math.max(1,Math.abs(t.b),Math.abs(e.b))&&Math.abs(t.a-e.a)<=n*Math.max(1,Math.abs(t.a),Math.abs(e.a))},e.hex=function(t){return(255*t.r<<24|255*t.g<<16|255*t.b<<8|255*t.a)>>>0};var n=e.prototype;return n.clone=function(){var t=new e;return t._val=this._val,t},n.equals=function(t){return t&&this._val===t._val},n.lerp=function(t,e){var n=this.r,i=this.g,r=this.b,o=this.a;return n+=(t.r-n)*e,i+=(t.g-i)*e,r+=(t.b-r)*e,o+=(t.a-o)*e,this._val=Math.floor((o<<24>>>0)+(r<<16)+(i<<8)+n),this},n.toString=function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"},n.toCSS=function(t){return void 0===t&&(t="rgba"),"rgba"===t?"rgba("+this.r+","+this.g+","+this.b+","+(this.a*An).toFixed(2)+")":"rgb"===t?"rgb("+this.r+","+this.g+","+this.b+")":"#"+this.toHEX(t)},n.fromHEX=function(t){t=0===t.indexOf("#")?t.substring(1):t;var e=parseInt(t.substr(0,2),16)||0,n=parseInt(t.substr(2,2),16)||0,i=parseInt(t.substr(4,2),16)||0,r=parseInt(t.substr(6,2),16);return r=Number.isNaN(r)?255:r,this._val=(r<<24>>>0)+(i<<16)+(n<<8)+(0|e),this},n.toHEX=function(t){void 0===t&&(t="#rrggbb");var e="0",n=[(this.r<16?e:"")+this.r.toString(16),(this.g<16?e:"")+this.g.toString(16),(this.b<16?e:"")+this.b.toString(16)];return"#rgb"===t?(n[0]=n[0][0],n[1]=n[1][0],n[2]=n[2][0]):"#rrggbbaa"===t&&n.push((this.a<16?e:"")+this.a.toString(16)),n.join("")},n.toRGBValue=function(){return 16777215&this._val},n.fromHSV=function(t,e,n){var i=0,r=0,o=0;if(0===e)i=r=o=n;else if(0===n)i=r=o=0;else{1===t&&(t=0),t*=6;var a=Math.floor(t),s=t-a,c=n*(1-e),l=n*(1-e*s),u=n*(1-e*(1-s));switch(a){case 0:i=n,r=u,o=c;break;case 1:i=l,r=n,o=c;break;case 2:i=c,r=n,o=u;break;case 3:i=c,r=l,o=n;break;case 4:i=u,r=c,o=n;break;case 5:i=n,r=c,o=l}}return i*=255,r*=255,o*=255,this._val=(this.a<<24>>>0)+(o<<16)+(r<<8)+(0|i),this},n.toHSV=function(){var t=this.r*An,e=this.g*An,n=this.b*An,i={h:0,s:0,v:0},r=Math.max(t,e,n),o=Math.min(t,e,n),a=0;return i.v=r,i.s=r?(r-o)/r:0,i.s?(a=r-o,i.h=t===r?(e-n)/a:e===r?2+(n-t)/a:4+(t-e)/a,i.h/=6,i.h<0&&(i.h+=1)):i.h=0,i},n.set=function(t,e,n,i){return"object"==typeof t?null!=t._val?this._val=t._val:(e=t.g||0,n=t.b||0,i="number"==typeof t.a?t.a:255,t=t.r||0,this._val=(i<<24>>>0)+(n<<16)+(e<<8)+(0|t)):(t=t||0,e=e||0,n=n||0,i="number"==typeof i?i:255,this._val=(i<<24>>>0)+(n<<16)+(e<<8)+(0|t)),this},n.multiply=function(t){var e=(255&this._val)*t.r>>8,n=(65280&this._val)*t.g>>8,i=(16711680&this._val)*t.b>>8,r=((4278190080&this._val)>>>8)*t.a;return this._val=4278190080&r|16711680&i|65280&n|255&e,this},n._set_r_unsafe=function(t){return this._val=(4294967040&this._val|t)>>>0,this},n._set_g_unsafe=function(t){return this._val=(4294902015&this._val|t<<8)>>>0,this},n._set_b_unsafe=function(t){return this._val=(4278255615&this._val|t<<16)>>>0,this},n._set_a_unsafe=function(t){return this._val=(16777215&this._val|t<<24)>>>0,this},K(e,[{key:"r",get:function(){return 255&this._val},set:function(t){t=~~on(t,0,255),this._val=(4294967040&this._val|t)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(t){t=~~on(t,0,255),this._val=(4294902015&this._val|t<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(t){t=~~on(t,0,255),this._val=(4278255615&this._val|t<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(t){t=~~on(t,0,255),this._val=(16777215&this._val|t<<24)>>>0}},{key:"x",get:function(){return this.r*An},set:function(t){this.r=255*t}},{key:"y",get:function(){return this.g*An},set:function(t){this.g=255*t}},{key:"z",get:function(){return this.b*An},set:function(t){this.b=255*t}},{key:"w",get:function(){return this.a*An},set:function(t){this.a=255*t}}]),e}(se));function Tn(t,e,n,i){return new bn(t,e,n,i)}bn.WHITE=Object.freeze(new bn(255,255,255,255)),bn.GRAY=Object.freeze(new bn(127,127,127,255)),bn.BLACK=Object.freeze(new bn(0,0,0,255)),bn.TRANSPARENT=Object.freeze(new bn(0,0,0,0)),bn.RED=Object.freeze(new bn(255,0,0,255)),bn.GREEN=Object.freeze(new bn(0,255,0,255)),bn.BLUE=Object.freeze(new bn(0,0,255,255)),bn.CYAN=Object.freeze(new bn(0,255,255,255)),bn.MAGENTA=Object.freeze(new bn(255,0,255,255)),bn.YELLOW=Object.freeze(new bn(255,255,0,255)),Je.fastDefine("cc.Color",bn,{r:0,g:0,b:0,a:255}),c.Color=bn,c.color=Tn;var En=t("Vec3",function(t){function e(e,n,i){var r;return r=t.call(this)||this,e&&"object"==typeof e?(r.x=e.x,r.y=e.y,r.z=e.z):(r.x=e||0,r.y=n||0,r.z=i||0),r}Q(e,t),e.zero=function(t){return t.x=0,t.y=0,t.z=0,t},e.clone=function(t){return new e(t.x,t.y,t.z)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t},e.set=function(t,e,n,i){return t.x=e,t.y=n,t.z=i,t},e.add=function(t,e,n){return t.x=e.x+n.x,t.y=e.y+n.y,t.z=e.z+n.z,t},e.subtract=function(t,e,n){return t.x=e.x-n.x,t.y=e.y-n.y,t.z=e.z-n.z,t},e.multiply=function(t,e,n){return t.x=e.x*n.x,t.y=e.y*n.y,t.z=e.z*n.z,t},e.divide=function(t,e,n){return t.x=e.x/n.x,t.y=e.y/n.y,t.z=e.z/n.z,t},e.ceil=function(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t.z=Math.ceil(e.z),t},e.floor=function(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t.z=Math.floor(e.z),t},e.min=function(t,e,n){return t.x=Math.min(e.x,n.x),t.y=Math.min(e.y,n.y),t.z=Math.min(e.z,n.z),t},e.max=function(t,e,n){return t.x=Math.max(e.x,n.x),t.y=Math.max(e.y,n.y),t.z=Math.max(e.z,n.z),t},e.round=function(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t.z=Math.round(e.z),t},e.multiplyScalar=function(t,e,n){return t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t},e.scaleAndAdd=function(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t.z=e.z+n.z*i,t},e.distance=function(t,e){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z;return Math.sqrt(n*n+i*i+r*r)},e.squaredDistance=function(t,e){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z;return n*n+i*i+r*r},e.len=function(t){var e=t.x,n=t.y,i=t.z;return Math.sqrt(e*e+n*n+i*i)},e.lengthSqr=function(t){var e=t.x,n=t.y,i=t.z;return e*e+n*n+i*i},e.negate=function(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t},e.invert=function(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t},e.invertSafe=function(t,e){var n=e.x,i=e.y,r=e.z;return Math.abs(n)<en?t.x=0:t.x=1/n,Math.abs(i)<en?t.y=0:t.y=1/i,Math.abs(r)<en?t.z=0:t.z=1/r,t},e.normalize=function(t,e){var n=e.x,i=e.y,r=e.z,o=n*n+i*i+r*r;return o>0&&(o=1/Math.sqrt(o),t.x=n*o,t.y=i*o,t.z=r*o),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},e.cross=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=n.x,s=n.y,c=n.z;return t.x=r*c-o*s,t.y=o*a-i*c,t.z=i*s-r*a,t},e.lerp=function(t,e,n,i){return t.x=e.x+i*(n.x-e.x),t.y=e.y+i*(n.y-e.y),t.z=e.z+i*(n.z-e.z),t},e.random=function(t,e){e=e||1;var n=2*un()*Math.PI,i=2*un()-1,r=Math.sqrt(1-i*i);return t.x=r*Math.cos(n)*e,t.y=r*Math.sin(n)*e,t.z=i*e,t},e.transformMat4=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=n.m03*i+n.m07*r+n.m11*o+n.m15;return a=a?Math.abs(1/a):1,t.x=(n.m00*i+n.m04*r+n.m08*o+n.m12)*a,t.y=(n.m01*i+n.m05*r+n.m09*o+n.m13)*a,t.z=(n.m02*i+n.m06*r+n.m10*o+n.m14)*a,t},e.transformMat4Normal=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=n.m03*i+n.m07*r+n.m11*o;return a=a?Math.abs(1/a):1,t.x=(n.m00*i+n.m04*r+n.m08*o)*a,t.y=(n.m01*i+n.m05*r+n.m09*o)*a,t.z=(n.m02*i+n.m06*r+n.m10*o)*a,t},e.transformMat3=function(t,e,n){var i=e.x,r=e.y,o=e.z;return t.x=i*n.m00+r*n.m03+o*n.m06,t.y=i*n.m01+r*n.m04+o*n.m07,t.z=i*n.m02+r*n.m05+o*n.m08,t},e.transformAffine=function(t,e,n){var i=e.x,r=e.y,o=e.z;return t.x=n.m00*i+n.m04*r+n.m08*o+n.m12,t.y=n.m01*i+n.m05*r+n.m09*o+n.m13,t.x=n.m02*i+n.m06*r+n.m10*o+n.m14,t},e.transformQuat=function(t,e,n){var i=n.w*e.x+n.y*e.z-n.z*e.y,r=n.w*e.y+n.z*e.x-n.x*e.z,o=n.w*e.z+n.x*e.y-n.y*e.x,a=-n.x*e.x-n.y*e.y-n.z*e.z;return t.x=i*n.w+a*-n.x+r*-n.z-o*-n.y,t.y=r*n.w+a*-n.y+o*-n.x-i*-n.z,t.z=o*n.w+a*-n.z+i*-n.y-r*-n.x,t},e.transformRTS=function(t,e,n,i,r){var o=e.x*r.x,a=e.y*r.y,s=e.z*r.z,c=n.w*o+n.y*s-n.z*a,l=n.w*a+n.z*o-n.x*s,u=n.w*s+n.x*a-n.y*o,h=-n.x*o-n.y*a-n.z*s;return t.x=c*n.w+h*-n.x+l*-n.z-u*-n.y+i.x,t.y=l*n.w+h*-n.y+u*-n.x-c*-n.z+i.y,t.z=u*n.w+h*-n.z+c*-n.y-l*-n.x+i.z,t},e.transformInverseRTS=function(t,e,n,i,r){var o=e.x-i.x,a=e.y-i.y,s=e.z-i.z,c=n.w*o-n.y*s+n.z*a,l=n.w*a-n.z*o+n.x*s,u=n.w*s-n.x*a+n.y*o,h=n.x*o+n.y*a+n.z*s;return t.x=(c*n.w+h*n.x+l*n.z-u*n.y)/r.x,t.y=(l*n.w+h*n.y+u*n.x-c*n.z)/r.y,t.z=(u*n.w+h*n.z+c*n.y-l*n.x)/r.z,t},e.rotateX=function(t,e,n,i){var r=e.x-n.x,o=e.y-n.y,a=e.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r,u=o*s-a*c,h=o*c+a*s;return t.x=l+n.x,t.y=u+n.y,t.z=h+n.z,t},e.rotateY=function(t,e,n,i){var r=e.x-n.x,o=e.y-n.y,a=e.z-n.z,s=Math.cos(i),c=Math.sin(i),l=a*c+r*s,u=o,h=a*s-r*c;return t.x=l+n.x,t.y=u+n.y,t.z=h+n.z,t},e.rotateZ=function(t,e,n,i){var r=e.x-n.x,o=e.y-n.y,a=e.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r*s-o*c,u=r*c+o*s,h=a;return t.x=l+n.x,t.y=u+n.y,t.z=h+n.z,t},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.x,t[n+1]=e.y,t[n+2]=e.z,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.x=e[n+0],t.y=e[n+1],t.z=e[n+2],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z},e.equals=function(t,e,n){void 0===n&&(n=en);var i=t.x,r=t.y,o=t.z,a=e.x,s=e.y,c=e.z;return Math.abs(i-a)<=n*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-s)<=n*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(o-c)<=n*Math.max(1,Math.abs(o),Math.abs(c))},e.angle=function(t,n){e.normalize(wn,t),e.normalize(Pn,n);var i=e.dot(wn,Pn);return i>1?0:i<-1?Math.PI:Math.acos(i)},e.projectOnPlane=function(t,n,i){return e.subtract(t,n,e.project(t,n,i))},e.project=function(t,n,i){var r=e.lengthSqr(i);return r<1e-6?e.set(t,0,0,0):e.multiplyScalar(t,i,e.dot(n,i)/r)};var n=e.prototype;return n.clone=function(){return new e(this.x,this.y,this.z)},n.set=function(t,e,n){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z):(this.x=t||0,this.y=e||0,this.z=n||0),this},n.equals=function(t,e){return void 0===e&&(e=en),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))},n.equals3f=function(t,e,n,i){return void 0===i&&(i=en),Math.abs(this.x-t)<=i*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=i*Math.max(1,Math.abs(this.y),Math.abs(e))&&Math.abs(this.z-n)<=i*Math.max(1,Math.abs(this.z),Math.abs(n))},n.strictEquals=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z},n.strictEquals3f=function(t,e,n){return this.x===t&&this.y===e&&this.z===n},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+")"},n.lerp=function(t,e){return this.x+=e*(t.x-this.x),this.y+=e*(t.y-this.y),this.z+=e*(t.z-this.z),this},n.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},n.add3f=function(t,e,n){return this.x+=t,this.y+=e,this.z+=n,this},n.subtract=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},n.subtract3f=function(t,e,n){return this.x-=t,this.y-=e,this.z-=n,this},n.multiplyScalar=function(t){return"object"==typeof t&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x*=t,this.y*=t,this.z*=t,this},n.multiply=function(t){return"object"!=typeof t&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this.z*=t.z,this},n.multiply3f=function(t,e,n){return this.x*=t,this.y*=e,this.z*=n,this},n.divide=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},n.divide3f=function(t,e,n){return this.x/=t,this.y/=e,this.z/=n,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},n.clampf=function(t,e){return this.x=on(this.x,t.x,e.x),this.y=on(this.y,t.y,e.y),this.z=on(this.z,t.z,e.z),this},n.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},n.cross=function(t){var e=this.x,n=this.y,i=this.z,r=t.x,o=t.y,a=t.z;return this.x=n*a-i*o,this.y=i*r-e*a,this.z=e*o-n*r,this},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z},n.normalize=function(){var t=this.x,e=this.y,n=this.z,i=t*t+e*e+n*n;return i>0&&(i=1/Math.sqrt(i),this.x=t*i,this.y=e*i,this.z=n*i),this},n.transformMat4=function(t){var e=this.x,n=this.y,i=this.z,r=t.m03*e+t.m07*n+t.m11*i+t.m15;return r=r?1/r:1,this.x=(t.m00*e+t.m04*n+t.m08*i+t.m12)*r,this.y=(t.m01*e+t.m05*n+t.m09*i+t.m13)*r,this.z=(t.m02*e+t.m06*n+t.m10*i+t.m14)*r,this},e}(se));En.UNIT_X=Object.freeze(new En(1,0,0)),En.UNIT_Y=Object.freeze(new En(0,1,0)),En.UNIT_Z=Object.freeze(new En(0,0,1)),En.RIGHT=Object.freeze(new En(1,0,0)),En.UP=Object.freeze(new En(0,1,0)),En.FORWARD=Object.freeze(new En(0,0,-1)),En.ZERO=Object.freeze(new En(0,0,0)),En.ONE=Object.freeze(new En(1,1,1)),En.NEG_ONE=Object.freeze(new En(-1,-1,-1));var wn=new En,Pn=new En;function In(t,e,n){return new En(t,e,n)}Je.fastDefine("cc.Vec3",En,{x:0,y:0,z:0}),c.Vec3=En,c.v3=In;var Rn=t("Mat3",function(t){function e(e,n,i,r,o,a,s,c,l){var u;return void 0===e&&(e=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),u=t.call(this)||this,"object"==typeof e?(u.m00=e.m00,u.m01=e.m01,u.m02=e.m02,u.m03=e.m03,u.m04=e.m04,u.m05=e.m05,u.m06=e.m06,u.m07=e.m07,u.m08=e.m08):(u.m00=e,u.m01=n,u.m02=i,u.m03=r,u.m04=o,u.m05=a,u.m06=s,u.m07=c,u.m08=l),u}Q(e,t),e.clone=function(t){return new e(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)},e.copy=function(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t},e.set=function(t,e,n,i,r,o,a,s,c,l){return t.m00=e,t.m01=n,t.m02=i,t.m03=r,t.m04=o,t.m05=a,t.m06=s,t.m07=c,t.m08=l,t},e.identity=function(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t},e.transpose=function(t,e){if(t===e){var n=e.m01,i=e.m02,r=e.m05;t.m01=e.m03,t.m02=e.m06,t.m03=n,t.m05=e.m07,t.m06=i,t.m07=r}else t.m00=e.m00,t.m01=e.m03,t.m02=e.m06,t.m03=e.m01,t.m04=e.m04,t.m05=e.m07,t.m06=e.m02,t.m07=e.m05,t.m08=e.m08;return t},e.invert=function(t,e){var n=e.m00,i=e.m01,r=e.m02,o=e.m03,a=e.m04,s=e.m05,c=e.m06,l=e.m07,u=e.m08,h=u*a-s*l,_=-u*o+s*c,f=l*o-a*c,p=n*h+i*_+r*f;return 0===p?(t.m00=0,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=0,t.m06=0,t.m07=0,t.m08=0,t):(p=1/p,t.m00=h*p,t.m01=(-u*i+r*l)*p,t.m02=(s*i-r*a)*p,t.m03=_*p,t.m04=(u*n-r*c)*p,t.m05=(-s*n+r*o)*p,t.m06=f*p,t.m07=(-l*n+i*c)*p,t.m08=(a*n-i*o)*p,t)},e.determinant=function(t){var e=t.m00,n=t.m01,i=t.m02,r=t.m03,o=t.m04,a=t.m05,s=t.m06,c=t.m07,l=t.m08;return e*(l*o-a*c)+n*(-l*r+a*s)+i*(c*r-o*s)},e.multiply=function(t,e,n){var i=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,_=n.m00,f=n.m01,p=n.m02,d=n.m03,m=n.m04,v=n.m05,g=n.m06,y=n.m07,x=n.m08;return t.m00=_*i+f*a+p*l,t.m01=_*r+f*s+p*u,t.m02=_*o+f*c+p*h,t.m03=d*i+m*a+v*l,t.m04=d*r+m*s+v*u,t.m05=d*o+m*c+v*h,t.m06=g*i+y*a+x*l,t.m07=g*r+y*s+x*u,t.m08=g*o+y*c+x*h,t},e.multiplyMat4=function(t,e,n){var i=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,_=n.m00,f=n.m01,p=n.m02,d=n.m04,m=n.m05,v=n.m06,g=n.m08,y=n.m09,x=n.m10;return t.m00=_*i+f*a+p*l,t.m01=_*r+f*s+p*u,t.m02=_*o+f*c+p*h,t.m03=d*i+m*a+v*l,t.m04=d*r+m*s+v*u,t.m05=d*o+m*c+v*h,t.m06=g*i+y*a+x*l,t.m07=g*r+y*s+x*u,t.m08=g*o+y*c+x*h,t},e.transform=function(t,e,n){var i=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,_=n.x,f=n.y;return t.m00=i,t.m01=r,t.m02=o,t.m03=a,t.m04=s,t.m05=c,t.m06=_*i+f*a+l,t.m07=_*r+f*s+u,t.m08=_*o+f*c+h,t},e.scale=function(t,e,n){var i=n.x,r=n.y;return t.m00=i*e.m00,t.m01=i*e.m01,t.m02=i*e.m02,t.m03=r*e.m03,t.m04=r*e.m04,t.m05=r*e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t},e.rotate=function(t,e,n){var i=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,_=Math.sin(n),f=Math.cos(n);return t.m00=f*i+_*a,t.m01=f*r+_*s,t.m02=f*o+_*c,t.m03=f*a-_*i,t.m04=f*s-_*r,t.m05=f*c-_*o,t.m06=l,t.m07=u,t.m08=h,t},e.fromMat4=function(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m04,t.m04=e.m05,t.m05=e.m06,t.m06=e.m08,t.m07=e.m09,t.m08=e.m10,t},e.fromViewUp=function(t,n,i){return En.lengthSqr(n)<en*en?(e.identity(t),t):(i=i||En.UNIT_Y,En.normalize(Dn,En.cross(Dn,i,n)),En.lengthSqr(Dn)<en*en?(e.identity(t),t):(En.cross(Bn,n,Dn),e.set(t,Dn.x,Dn.y,Dn.z,Bn.x,Bn.y,Bn.z,n.x,n.y,n.z),t))},e.fromTranslation=function(t,e){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=e.x,t.m07=e.y,t.m08=1,t},e.fromScaling=function(t,e){return t.m00=e.x,t.m01=0,t.m02=0,t.m03=0,t.m04=e.y,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t},e.fromRotation=function(t,e){var n=Math.sin(e),i=Math.cos(e);return t.m00=i,t.m01=n,t.m02=0,t.m03=-n,t.m04=i,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t},e.fromQuat=function(t,e){var n=e.x,i=e.y,r=e.z,o=e.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,_=r*a,f=r*s,p=r*c,d=o*a,m=o*s,v=o*c;return t.m00=1-h-p,t.m03=u-v,t.m06=_+m,t.m01=u+v,t.m04=1-l-p,t.m07=f-d,t.m02=_-m,t.m05=f+d,t.m08=1-l-h,t},e.inverseTransposeMat4=function(t,e){var n=e.m00,i=e.m01,r=e.m02,o=e.m03,a=e.m04,s=e.m05,c=e.m06,l=e.m07,u=e.m08,h=e.m09,_=e.m10,f=e.m11,p=e.m12,d=e.m13,m=e.m14,v=e.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,C=i*l-o*s,A=r*l-o*c,b=u*d-h*p,T=u*m-_*p,E=u*v-f*p,w=h*m-_*d,P=h*v-f*d,I=_*v-f*m,R=g*I-y*P+x*w+S*E-C*T+A*b;return R?(R=1/R,t.m00=(s*I-c*P+l*w)*R,t.m01=(c*E-a*I-l*T)*R,t.m02=(a*P-s*E+l*b)*R,t.m03=(r*P-i*I-o*w)*R,t.m04=(n*I-r*E+o*T)*R,t.m05=(i*E-n*P-o*b)*R,t.m06=(d*A-m*C+v*S)*R,t.m07=(m*x-p*A-v*y)*R,t.m08=(p*C-d*x+v*g)*R,t):null},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.m00,t[n+1]=e.m01,t[n+2]=e.m02,t[n+3]=e.m03,t[n+4]=e.m04,t[n+5]=e.m05,t[n+6]=e.m06,t[n+7]=e.m07,t[n+8]=e.m08,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.m00=e[n+0],t.m01=e[n+1],t.m02=e[n+2],t.m03=e[n+3],t.m04=e[n+4],t.m05=e[n+5],t.m06=e[n+6],t.m07=e[n+7],t.m08=e[n+8],t},e.add=function(t,e,n){return t.m00=e.m00+n.m00,t.m01=e.m01+n.m01,t.m02=e.m02+n.m02,t.m03=e.m03+n.m03,t.m04=e.m04+n.m04,t.m05=e.m05+n.m05,t.m06=e.m06+n.m06,t.m07=e.m07+n.m07,t.m08=e.m08+n.m08,t},e.subtract=function(t,e,n){return t.m00=e.m00-n.m00,t.m01=e.m01-n.m01,t.m02=e.m02-n.m02,t.m03=e.m03-n.m03,t.m04=e.m04-n.m04,t.m05=e.m05-n.m05,t.m06=e.m06-n.m06,t.m07=e.m07-n.m07,t.m08=e.m08-n.m08,t},e.multiplyScalar=function(t,e,n){return t.m00=e.m00*n,t.m01=e.m01*n,t.m02=e.m02*n,t.m03=e.m03*n,t.m04=e.m04*n,t.m05=e.m05*n,t.m06=e.m06*n,t.m07=e.m07*n,t.m08=e.m08*n,t},e.multiplyScalarAndAdd=function(t,e,n,i){return t.m00=n.m00*i+e.m00,t.m01=n.m01*i+e.m01,t.m02=n.m02*i+e.m02,t.m03=n.m03*i+e.m03,t.m04=n.m04*i+e.m04,t.m05=n.m05*i+e.m05,t.m06=n.m06*i+e.m06,t.m07=n.m07*i+e.m07,t.m08=n.m08*i+e.m08,t},e.strictEquals=function(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08},e.equals=function(t,e,n){return void 0===n&&(n=en),Math.abs(t.m00-e.m00)<=n*Math.max(1,Math.abs(t.m00),Math.abs(e.m00))&&Math.abs(t.m01-e.m01)<=n*Math.max(1,Math.abs(t.m01),Math.abs(e.m01))&&Math.abs(t.m02-e.m02)<=n*Math.max(1,Math.abs(t.m02),Math.abs(e.m02))&&Math.abs(t.m03-e.m03)<=n*Math.max(1,Math.abs(t.m03),Math.abs(e.m03))&&Math.abs(t.m04-e.m04)<=n*Math.max(1,Math.abs(t.m04),Math.abs(e.m04))&&Math.abs(t.m05-e.m05)<=n*Math.max(1,Math.abs(t.m05),Math.abs(e.m05))&&Math.abs(t.m06-e.m06)<=n*Math.max(1,Math.abs(t.m06),Math.abs(e.m06))&&Math.abs(t.m07-e.m07)<=n*Math.max(1,Math.abs(t.m07),Math.abs(e.m07))&&Math.abs(t.m08-e.m08)<=n*Math.max(1,Math.abs(t.m08),Math.abs(e.m08))};var n=e.prototype;return n.clone=function(){var t=this;return new e(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)},n.set=function(t,e,n,i,r,o,a,s,c){return void 0===t&&(t=1),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=1),"object"==typeof t?(this.m00=t.m00,this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08):(this.m00=t,this.m01=e,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c),this},n.equals=function(t,e){return void 0===e&&(e=en),Math.abs(this.m00-t.m00)<=e*Math.max(1,Math.abs(this.m00),Math.abs(t.m00))&&Math.abs(this.m01-t.m01)<=e*Math.max(1,Math.abs(this.m01),Math.abs(t.m01))&&Math.abs(this.m02-t.m02)<=e*Math.max(1,Math.abs(this.m02),Math.abs(t.m02))&&Math.abs(this.m03-t.m03)<=e*Math.max(1,Math.abs(this.m03),Math.abs(t.m03))&&Math.abs(this.m04-t.m04)<=e*Math.max(1,Math.abs(this.m04),Math.abs(t.m04))&&Math.abs(this.m05-t.m05)<=e*Math.max(1,Math.abs(this.m05),Math.abs(t.m05))&&Math.abs(this.m06-t.m06)<=e*Math.max(1,Math.abs(this.m06),Math.abs(t.m06))&&Math.abs(this.m07-t.m07)<=e*Math.max(1,Math.abs(this.m07),Math.abs(t.m07))&&Math.abs(this.m08-t.m08)<=e*Math.max(1,Math.abs(this.m08),Math.abs(t.m08))},n.strictEquals=function(t){return this.m00===t.m00&&this.m01===t.m01&&this.m02===t.m02&&this.m03===t.m03&&this.m04===t.m04&&this.m05===t.m05&&this.m06===t.m06&&this.m07===t.m07&&this.m08===t.m08},n.toString=function(){var t=this;return"[\n"+t.m00+", "+t.m01+", "+t.m02+",\n"+t.m03+",\n"+t.m04+", "+t.m05+",\n"+t.m06+", "+t.m07+",\n"+t.m08+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this},n.transpose=function(){var t=this.m01,e=this.m02,n=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=t,this.m05=this.m07,this.m06=e,this.m07=n,this},n.invert=function(){var t=this.m00,e=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=c*r-o*s,u=-c*i+o*a,h=s*i-r*a,_=t*l+e*u+n*h;return 0===_?(this.set(0,0,0,0,0,0,0,0,0),this):(_=1/_,this.m00=l*_,this.m01=(-c*e+n*s)*_,this.m02=(o*e-n*r)*_,this.m03=u*_,this.m04=(c*t-n*a)*_,this.m05=(-o*t+n*i)*_,this.m06=h*_,this.m07=(-s*t+e*a)*_,this.m08=(r*t-e*i)*_,this)},n.determinant=function(){var t=this.m00,e=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08;return t*(c*r-o*s)+e*(-c*i+o*a)+n*(s*i-r*a)},n.add=function(t){return this.m00+=t.m00,this.m01+=t.m01,this.m02+=t.m02,this.m03+=t.m03,this.m04+=t.m04,this.m05+=t.m05,this.m06+=t.m06,this.m07+=t.m07,this.m08+=t.m08,this},n.subtract=function(t){return this.m00-=t.m00,this.m01-=t.m01,this.m02-=t.m02,this.m03-=t.m03,this.m04-=t.m04,this.m05-=t.m05,this.m06-=t.m06,this.m07-=t.m07,this.m08-=t.m08,this},n.multiply=function(t){var e=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=t.m00,h=t.m01,_=t.m02,f=t.m03,p=t.m04,d=t.m05,m=t.m06,v=t.m07,g=t.m08;return this.m00=u*e+h*r+_*s,this.m01=u*n+h*o+_*c,this.m02=u*i+h*a+_*l,this.m03=f*e+p*r+d*s,this.m04=f*n+p*o+d*c,this.m05=f*i+p*a+d*l,this.m06=m*e+v*r+g*s,this.m07=m*n+v*o+g*c,this.m08=m*i+v*a+g*l,this},n.multiplyScalar=function(t){return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=t,this.m05*=t,this.m06*=t,this.m07*=t,this.m08*=t,this},n.scale=function(t){var e=t.x,n=t.y;return this.m00=e*this.m00,this.m01=e*this.m01,this.m02=e*this.m02,this.m03=n*this.m03,this.m04=n*this.m04,this.m05=n*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this},n.rotate=function(t){var e=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=Math.sin(t),h=Math.cos(t);return this.m00=h*e+u*r,this.m01=h*n+u*o,this.m02=h*i+u*a,this.m03=h*r-u*e,this.m04=h*o-u*n,this.m05=h*a-u*i,this.m06=s,this.m07=c,this.m08=l,this},n.fromQuat=function(t){var e=t.x,n=t.y,i=t.z,r=t.w,o=e+e,a=n+n,s=i+i,c=e*o,l=n*o,u=n*a,h=i*o,_=i*a,f=i*s,p=r*o,d=r*a,m=r*s;return this.m00=1-u-f,this.m03=l-m,this.m06=h+d,this.m01=l+m,this.m04=1-c-f,this.m07=_-p,this.m02=h-d,this.m05=_+p,this.m08=1-c-u,this},e}(se));Rn.IDENTITY=Object.freeze(new Rn);var Dn=new En,Bn=new En;Je.fastDefine("cc.Mat3",Rn,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),c.Mat3=Rn;var Mn=t("Quat",function(t){function e(e,n,i,r){var o;return o=t.call(this)||this,e&&"object"==typeof e?(o.x=e.x,o.y=e.y,o.z=e.z,o.w=e.w):(o.x=e||0,o.y=n||0,o.z=i||0,o.w=null!=r?r:1),o}Q(e,t),e.clone=function(t){return new e(t.x,t.y,t.z,t.w)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t},e.set=function(t,e,n,i,r){return t.x=e,t.y=n,t.z=i,t.w=r,t},e.identity=function(t){return t.x=0,t.y=0,t.z=0,t.w=1,t},e.rotationTo=function(t,n,i){var r=En.dot(n,i);return r<-.999999?(En.cross(Ln,En.UNIT_X,n),Ln.length()<1e-6&&En.cross(Ln,En.UNIT_Y,n),En.normalize(Ln,Ln),e.fromAxisAngle(t,Ln,Math.PI),t):r>.999999?(t.x=0,t.y=0,t.z=0,t.w=1,t):(En.cross(Ln,n,i),t.x=Ln.x,t.y=Ln.y,t.z=Ln.z,t.w=1+r,e.normalize(t,t))},e.getAxisAngle=function(t,e){var n=2*Math.acos(e.w),i=Math.sin(n/2);return 0!==i?(t.x=e.x/i,t.y=e.y/i,t.z=e.z/i):(t.x=1,t.y=0,t.z=0),n},e.multiply=function(t,e,n){var i=e.x*n.w+e.w*n.x+e.y*n.z-e.z*n.y,r=e.y*n.w+e.w*n.y+e.z*n.x-e.x*n.z,o=e.z*n.w+e.w*n.z+e.x*n.y-e.y*n.x,a=e.w*n.w-e.x*n.x-e.y*n.y-e.z*n.z;return t.x=i,t.y=r,t.z=o,t.w=a,t},e.multiplyScalar=function(t,e,n){return t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t.w=e.w*n,t},e.scaleAndAdd=function(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t.z=e.z+n.z*i,t.w=e.w+n.w*i,t},e.rotateX=function(t,e,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=e.x,a=e.y,s=e.z,c=e.w;return t.x=o*r+c*i,t.y=a*r+s*i,t.z=s*r-a*i,t.w=c*r-o*i,t},e.rotateY=function(t,e,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=e.x,a=e.y,s=e.z,c=e.w;return t.x=o*r-s*i,t.y=a*r+c*i,t.z=s*r+o*i,t.w=c*r-a*i,t},e.rotateZ=function(t,e,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=e.x,a=e.y,s=e.z,c=e.w;return t.x=o*r+a*i,t.y=a*r-o*i,t.z=s*r+c*i,t.w=c*r-s*i,t},e.rotateAround=function(t,n,i,r){return e.invert(On,n),En.transformQuat(Ln,i,On),e.fromAxisAngle(On,Ln,r),e.multiply(t,n,On),t},e.rotateAroundLocal=function(t,n,i,r){return e.fromAxisAngle(On,i,r),e.multiply(t,n,On),t},e.calculateW=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=Math.sqrt(Math.abs(1-e.x*e.x-e.y*e.y-e.z*e.z)),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w},e.lerp=function(t,e,n,i){return t.x=e.x+i*(n.x-e.x),t.y=e.y+i*(n.y-e.y),t.z=e.z+i*(n.z-e.z),t.w=e.w+i*(n.w-e.w),t},e.slerp=function(t,e,n,i){var r=0,o=0,a=n.x,s=n.y,c=n.z,l=n.w,u=e.x*n.x+e.y*n.y+e.z*n.z+e.w*n.w;if(u<0&&(u=-u,a=-a,s=-s,c=-c,l=-l),1-u>1e-6){var h=Math.acos(u),_=Math.sin(h);r=Math.sin((1-i)*h)/_,o=Math.sin(i*h)/_}else r=1-i,o=i;return t.x=r*e.x+o*a,t.y=r*e.y+o*s,t.z=r*e.z+o*c,t.w=r*e.w+o*l,t},e.sqlerp=function(t,n,i,r,o,a){return e.slerp(On,n,o,a),e.slerp(Nn,i,r,a),e.slerp(t,On,Nn,2*a*(1-a)),t},e.invert=function(t,e){var n=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w,i=n?1/n:0;return t.x=-e.x*i,t.y=-e.y*i,t.z=-e.z*i,t.w=e.w*i,t},e.conjugate=function(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=e.w,t},e.len=function(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w)},e.lengthSqr=function(t){return t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w},e.normalize=function(t,e){var n=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w;return n>0&&(n=1/Math.sqrt(n),t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t.w=e.w*n),t},e.fromAxes=function(t,n,i,r){return Rn.set(Fn,n.x,n.y,n.z,i.x,i.y,i.z,r.x,r.y,r.z),e.normalize(t,e.fromMat3(t,Fn))},e.fromViewUp=function(t,n,i){return Rn.fromViewUp(Fn,n,i),e.normalize(t,e.fromMat3(t,Fn))},e.fromAxisAngle=function(t,e,n){n*=.5;var i=Math.sin(n);return t.x=i*e.x,t.y=i*e.y,t.z=i*e.z,t.w=Math.cos(n),t},e.fromMat3=function(t,e){var n=e.m00,i=e.m03,r=e.m06,o=e.m01,a=e.m04,s=e.m07,c=e.m02,l=e.m05,u=e.m08,h=n+a+u;if(h>0){var _=.5/Math.sqrt(h+1);t.w=.25/_,t.x=(l-s)*_,t.y=(r-c)*_,t.z=(o-i)*_}else if(n>a&&n>u){var f=2*Math.sqrt(1+n-a-u);t.w=(l-s)/f,t.x=.25*f,t.y=(i+o)/f,t.z=(r+c)/f}else if(a>u){var p=2*Math.sqrt(1+a-n-u);t.w=(r-c)/p,t.x=(i+o)/p,t.y=.25*p,t.z=(s+l)/p}else{var d=2*Math.sqrt(1+u-n-a);t.w=(o-i)/d,t.x=(r+c)/d,t.y=(s+l)/d,t.z=.25*d}return t},e.fromEuler=function(t,e,n,i){e*=zn,n*=zn,i*=zn;var r=Math.sin(e),o=Math.cos(e),a=Math.sin(n),s=Math.cos(n),c=Math.sin(i),l=Math.cos(i);return t.x=r*s*l+o*a*c,t.y=o*a*l+r*s*c,t.z=o*s*c-r*a*l,t.w=o*s*l-r*a*c,t},e.fromAngleZ=function(t,e){return e*=zn,t.x=t.y=0,t.z=Math.sin(e),t.w=Math.cos(e),t},e.toAxisX=function(t,e){var n=2*e.y,i=2*e.z;return t.x=1-n*e.y-i*e.z,t.y=n*e.x+i*e.w,t.z=i*e.x+n*e.w,t},e.toAxisY=function(t,e){var n=2*e.x,i=2*e.y,r=2*e.z;return t.x=i*e.x-r*e.w,t.y=1-n*e.x-r*e.z,t.z=r*e.y+n*e.w,t},e.toAxisZ=function(t,e){var n=2*e.x,i=2*e.y,r=2*e.z;return t.x=r*e.x-i*e.w,t.y=r*e.y-n*e.w,t.z=1-n*e.x-i*e.y,t},e.toEuler=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=e.w,s=0,c=0,l=0,u=i*r+o*a;if(u>.499999)s=0,c=ln(2*Math.atan2(i,a)),l=90;else if(u<-.499999)s=0,c=-ln(2*Math.atan2(i,a)),l=-90;else{var h=i*i,_=r*r,f=o*o;s=ln(Math.atan2(2*i*a-2*r*o,1-2*h-2*f)),c=ln(Math.atan2(2*r*a-2*i*o,1-2*_-2*f)),l=ln(Math.asin(2*u)),n&&(s=-180*Math.sign(s+1e-6)+s,c=-180*Math.sign(c+1e-6)+c,l=180*Math.sign(l+1e-6)-l)}return t.x=s,t.y=c,t.z=l,t},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.x,t[n+1]=e.y,t[n+2]=e.z,t[n+3]=e.w,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.x=e[n+0],t.y=e[n+1],t.z=e[n+2],t.w=e[n+3],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w},e.equals=function(t,e,n){return void 0===n&&(n=en),Math.abs(t.x-e.x)<=n*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=n*Math.max(1,Math.abs(t.y),Math.abs(e.y))&&Math.abs(t.z-e.z)<=n*Math.max(1,Math.abs(t.z),Math.abs(e.z))&&Math.abs(t.w-e.w)<=n*Math.max(1,Math.abs(t.w),Math.abs(e.w))};var n=e.prototype;return n.clone=function(){return new e(this.x,this.y,this.z,this.w)},n.set=function(t,e,n,i){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=n||0,this.w=null!=i?i:1),this},n.equals=function(t,e){return void 0===e&&(e=en),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))&&Math.abs(this.w-t.w)<=e*Math.max(1,Math.abs(this.w),Math.abs(t.w))},n.strictEquals=function(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},n.getEulerAngles=function(t){return e.toEuler(t,this)},n.lerp=function(t,e){return this.x+=e*(t.x-this.x),this.y+=e*(t.y-this.y),this.z+=e*(t.z-this.z),this.w+=e*(t.w-this.w),this},n.slerp=function(t,n){return e.slerp(this,this,t,n)},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},e}(se));Mn.IDENTITY=Object.freeze(new Mn);var On=new Mn,Nn=new Mn,Ln=new En,Fn=new Rn,zn=.5*Math.PI/180;function Gn(t,e,n,i){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),new Mn(t,e,n,i)}Je.fastDefine("cc.Quat",Mn,{x:0,y:0,z:0,w:1}),c.Quat=Mn,c.quat=Gn;var Vn=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]),Un=t("Mat4",function(t){function e(e,n,i,r,o,a,s,c,l,u,h,_,f,p,d,m){var v;return void 0===e&&(e=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=1),void 0===_&&(_=0),void 0===f&&(f=0),void 0===p&&(p=0),void 0===d&&(d=0),void 0===m&&(m=1),(v=t.call(this)||this).m00=void 0,v.m01=void 0,v.m02=void 0,v.m03=void 0,v.m04=void 0,v.m05=void 0,v.m06=void 0,v.m07=void 0,v.m08=void 0,v.m09=void 0,v.m10=void 0,v.m11=void 0,v.m12=void 0,v.m13=void 0,v.m14=void 0,v.m15=void 0,"object"==typeof e?(v.m00=e.m00,v.m01=e.m01,v.m02=e.m02,v.m03=e.m03,v.m04=e.m04,v.m05=e.m05,v.m06=e.m06,v.m07=e.m07,v.m08=e.m08,v.m09=e.m09,v.m10=e.m10,v.m11=e.m11,v.m12=e.m12,v.m13=e.m13,v.m14=e.m14,v.m15=e.m15):(v.m00=e,v.m01=n,v.m02=i,v.m03=r,v.m04=o,v.m05=a,v.m06=s,v.m07=c,v.m08=l,v.m09=u,v.m10=h,v.m11=_,v.m12=f,v.m13=p,v.m14=d,v.m15=m),v}Q(e,t),e.clone=function(t){return new e(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08,t.m09,t.m10,t.m11,t.m12,t.m13,t.m14,t.m15)},e.copy=function(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t},e.set=function(t,e,n,i,r,o,a,s,c,l,u,h,_,f,p,d,m){return t.m00=e,t.m01=n,t.m02=i,t.m03=r,t.m04=o,t.m05=a,t.m06=s,t.m07=c,t.m08=l,t.m09=u,t.m10=h,t.m11=_,t.m12=f,t.m13=p,t.m14=d,t.m15=m,t},e.identity=function(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.transpose=function(t,e){if(t===e){var n=e.m01,i=e.m02,r=e.m03,o=e.m06,a=e.m07,s=e.m11;t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=n,t.m06=e.m09,t.m07=e.m13,t.m08=i,t.m09=o,t.m11=e.m14,t.m12=r,t.m13=a,t.m14=s}else t.m00=e.m00,t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=e.m01,t.m05=e.m05,t.m06=e.m09,t.m07=e.m13,t.m08=e.m02,t.m09=e.m06,t.m10=e.m10,t.m11=e.m14,t.m12=e.m03,t.m13=e.m07,t.m14=e.m11,t.m15=e.m15;return t},e.invert=function(t,e){var n=e.m00,i=e.m01,r=e.m02,o=e.m03,a=e.m04,s=e.m05,c=e.m06,l=e.m07,u=e.m08,h=e.m09,_=e.m10,f=e.m11,p=e.m12,d=e.m13,m=e.m14,v=e.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,C=i*l-o*s,A=r*l-o*c,b=u*d-h*p,T=u*m-_*p,E=u*v-f*p,w=h*m-_*d,P=h*v-f*d,I=_*v-f*m,R=g*I-y*P+x*w+S*E-C*T+A*b;return 0===R?(t.m00=0,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=0,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=0,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=0,t):(R=1/R,t.m00=(s*I-c*P+l*w)*R,t.m01=(r*P-i*I-o*w)*R,t.m02=(d*A-m*C+v*S)*R,t.m03=(_*C-h*A-f*S)*R,t.m04=(c*E-a*I-l*T)*R,t.m05=(n*I-r*E+o*T)*R,t.m06=(m*x-p*A-v*y)*R,t.m07=(u*A-_*x+f*y)*R,t.m08=(a*P-s*E+l*b)*R,t.m09=(i*E-n*P-o*b)*R,t.m10=(p*C-d*x+v*g)*R,t.m11=(h*x-u*C-f*g)*R,t.m12=(s*T-a*w-c*b)*R,t.m13=(n*w-i*T+r*b)*R,t.m14=(d*y-p*S-m*g)*R,t.m15=(u*S-h*y+_*g)*R,t)},e.determinant=function(t){var e=t.m00,n=t.m01,i=t.m02,r=t.m03,o=t.m04,a=t.m05,s=t.m06,c=t.m07,l=t.m08,u=t.m09,h=t.m10,_=t.m11,f=t.m12,p=t.m13,d=t.m14,m=t.m15;return(e*a-n*o)*(h*m-_*d)-(e*s-i*o)*(u*m-_*p)+(e*c-r*o)*(u*d-h*p)+(n*s-i*a)*(l*m-_*f)-(n*c-r*a)*(l*d-h*f)+(i*c-r*s)*(l*p-u*f)},e.multiply=function(t,e,n){var i=e.m00,r=e.m01,o=e.m02,a=e.m03,s=e.m04,c=e.m05,l=e.m06,u=e.m07,h=e.m08,_=e.m09,f=e.m10,p=e.m11,d=e.m12,m=e.m13,v=e.m14,g=e.m15,y=n.m00,x=n.m01,S=n.m02,C=n.m03;return t.m00=y*i+x*s+S*h+C*d,t.m01=y*r+x*c+S*_+C*m,t.m02=y*o+x*l+S*f+C*v,t.m03=y*a+x*u+S*p+C*g,y=n.m04,x=n.m05,S=n.m06,C=n.m07,t.m04=y*i+x*s+S*h+C*d,t.m05=y*r+x*c+S*_+C*m,t.m06=y*o+x*l+S*f+C*v,t.m07=y*a+x*u+S*p+C*g,y=n.m08,x=n.m09,S=n.m10,C=n.m11,t.m08=y*i+x*s+S*h+C*d,t.m09=y*r+x*c+S*_+C*m,t.m10=y*o+x*l+S*f+C*v,t.m11=y*a+x*u+S*p+C*g,y=n.m12,x=n.m13,S=n.m14,C=n.m15,t.m12=y*i+x*s+S*h+C*d,t.m13=y*r+x*c+S*_+C*m,t.m14=y*o+x*l+S*f+C*v,t.m15=y*a+x*u+S*p+C*g,t},e.transform=function(t,e,n){var i=n.x,r=n.y,o=n.z;if(e===t)t.m12=e.m00*i+e.m04*r+e.m08*o+e.m12,t.m13=e.m01*i+e.m05*r+e.m09*o+e.m13,t.m14=e.m02*i+e.m06*r+e.m10*o+e.m14,t.m15=e.m03*i+e.m07*r+e.m11*o+e.m15;else{var a=e.m00,s=e.m01,c=e.m02,l=e.m03,u=e.m04,h=e.m05,_=e.m06,f=e.m07,p=e.m08,d=e.m09,m=e.m10,v=e.m11;e.m12,e.m13,e.m14,e.m15,t.m00=a,t.m01=s,t.m02=c,t.m03=l,t.m04=u,t.m05=h,t.m06=_,t.m07=f,t.m08=p,t.m09=d,t.m10=m,t.m11=v,t.m12=a*i+u*r+p*o+e.m12,t.m13=s*i+h*r+d*o+e.m13,t.m14=c*i+_*r+m*o+e.m14,t.m15=l*i+f*r+v*o+e.m15}return t},e.translate=function(t,e,n){return console.warn("function changed"),e===t?(t.m12+=n.x,t.m13+=n.y,t.m14+=n.z):(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12+=n.x,t.m13+=n.y,t.m14+=n.z,t.m15=e.m15),t},e.scale=function(t,e,n){var i=n.x,r=n.y,o=n.z;return t.m00=e.m00*i,t.m01=e.m01*i,t.m02=e.m02*i,t.m03=e.m03*i,t.m04=e.m04*r,t.m05=e.m05*r,t.m06=e.m06*r,t.m07=e.m07*r,t.m08=e.m08*o,t.m09=e.m09*o,t.m10=e.m10*o,t.m11=e.m11*o,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t},e.rotate=function(t,e,n,i){var r=i.x,o=i.y,a=i.z,s=Math.sqrt(r*r+o*o+a*a);if(Math.abs(s)<en)return null;r*=s=1/s,o*=s,a*=s;var c=Math.sin(n),l=Math.cos(n),u=1-l,h=e.m00,_=e.m01,f=e.m02,p=e.m03,d=e.m04,m=e.m05,v=e.m06,g=e.m07,y=e.m08,x=e.m09,S=e.m10,C=e.m11,A=r*r*u+l,b=o*r*u+a*c,T=a*r*u-o*c,E=r*o*u-a*c,w=o*o*u+l,P=a*o*u+r*c,I=r*a*u+o*c,R=o*a*u-r*c,D=a*a*u+l;return t.m00=h*A+d*b+y*T,t.m01=_*A+m*b+x*T,t.m02=f*A+v*b+S*T,t.m03=p*A+g*b+C*T,t.m04=h*E+d*w+y*P,t.m05=_*E+m*w+x*P,t.m06=f*E+v*w+S*P,t.m07=p*E+g*w+C*P,t.m08=h*I+d*R+y*D,t.m09=_*I+m*R+x*D,t.m10=f*I+v*R+S*D,t.m11=p*I+g*R+C*D,e!==t&&(t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t},e.rotateX=function(t,e,n){var i=Math.sin(n),r=Math.cos(n),o=e.m04,a=e.m05,s=e.m06,c=e.m07,l=e.m08,u=e.m09,h=e.m10,_=e.m11;return e!==t&&(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m04=o*r+l*i,t.m05=a*r+u*i,t.m06=s*r+h*i,t.m07=c*r+_*i,t.m08=l*r-o*i,t.m09=u*r-a*i,t.m10=h*r-s*i,t.m11=_*r-c*i,t},e.rotateY=function(t,e,n){var i=Math.sin(n),r=Math.cos(n),o=e.m00,a=e.m01,s=e.m02,c=e.m03,l=e.m08,u=e.m09,h=e.m10,_=e.m11;return e!==t&&(t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=o*r-l*i,t.m01=a*r-u*i,t.m02=s*r-h*i,t.m03=c*r-_*i,t.m08=o*i+l*r,t.m09=a*i+u*r,t.m10=s*i+h*r,t.m11=c*i+_*r,t},e.rotateZ=function(t,e,n){var i=Math.sin(n),r=Math.cos(n),o=e.m00,a=e.m01,s=e.m02,c=e.m03,l=e.m04,u=e.m05,h=e.m06,_=e.m07;return e!==t&&(t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=o*r+l*i,t.m01=a*r+u*i,t.m02=s*r+h*i,t.m03=c*r+_*i,t.m04=l*r-o*i,t.m05=u*r-a*i,t.m06=h*r-s*i,t.m07=_*r-c*i,t},e.fromTranslation=function(t,e){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=e.x,t.m13=e.y,t.m14=e.z,t.m15=1,t},e.fromScaling=function(t,e){return t.m00=e.x,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=e.y,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=e.z,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromRotation=function(t,e,n){var i=n.x,r=n.y,o=n.z,a=Math.sqrt(i*i+r*r+o*o);if(Math.abs(a)<en)return null;i*=a=1/a,r*=a,o*=a;var s=Math.sin(e),c=Math.cos(e),l=1-c;return t.m00=i*i*l+c,t.m01=r*i*l+o*s,t.m02=o*i*l-r*s,t.m03=0,t.m04=i*r*l-o*s,t.m05=r*r*l+c,t.m06=o*r*l+i*s,t.m07=0,t.m08=i*o*l+r*s,t.m09=r*o*l-i*s,t.m10=o*o*l+c,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromXRotation=function(t,e){var n=Math.sin(e),i=Math.cos(e);return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=i,t.m06=n,t.m07=0,t.m08=0,t.m09=-n,t.m10=i,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromYRotation=function(t,e){var n=Math.sin(e),i=Math.cos(e);return t.m00=i,t.m01=0,t.m02=-n,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=n,t.m09=0,t.m10=i,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromZRotation=function(t,e){var n=Math.sin(e),i=Math.cos(e);return t.m00=i,t.m01=n,t.m02=0,t.m03=0,t.m04=-n,t.m05=i,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.fromRT=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=e.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,_=i*l,f=r*c,p=r*l,d=o*l,m=a*s,v=a*c,g=a*l;return t.m00=1-(f+d),t.m01=h+g,t.m02=_-v,t.m03=0,t.m04=h-g,t.m05=1-(u+d),t.m06=p+m,t.m07=0,t.m08=_+v,t.m09=p-m,t.m10=1-(u+f),t.m11=0,t.m12=n.x,t.m13=n.y,t.m14=n.z,t.m15=1,t},e.getTranslation=function(t,e){return t.x=e.m12,t.y=e.m13,t.z=e.m14,t},e.getScaling=function(t,e){var n=Hn.m00=e.m00,i=Hn.m01=e.m01,r=Hn.m02=e.m02,o=Hn.m03=e.m04,a=Hn.m04=e.m05,s=Hn.m05=e.m06,c=Hn.m06=e.m08,l=Hn.m07=e.m09,u=Hn.m08=e.m10;return t.x=Math.sqrt(n*n+i*i+r*r),t.y=Math.sqrt(o*o+a*a+s*s),t.z=Math.sqrt(c*c+l*l+u*u),Rn.determinant(Hn)<0&&(t.x*=-1),t},e.getRotation=function(t,e){var n=e.m00+e.m05+e.m10,i=0;return n>0?(i=2*Math.sqrt(n+1),t.w=.25*i,t.x=(e.m06-e.m09)/i,t.y=(e.m08-e.m02)/i,t.z=(e.m01-e.m04)/i):e.m00>e.m05&&e.m00>e.m10?(i=2*Math.sqrt(1+e.m00-e.m05-e.m10),t.w=(e.m06-e.m09)/i,t.x=.25*i,t.y=(e.m01+e.m04)/i,t.z=(e.m08+e.m02)/i):e.m05>e.m10?(i=2*Math.sqrt(1+e.m05-e.m00-e.m10),t.w=(e.m08-e.m02)/i,t.x=(e.m01+e.m04)/i,t.y=.25*i,t.z=(e.m06+e.m09)/i):(i=2*Math.sqrt(1+e.m10-e.m00-e.m05),t.w=(e.m01-e.m04)/i,t.x=(e.m08+e.m02)/i,t.y=(e.m06+e.m09)/i,t.z=.25*i),t},e.toRTS=function(t,e,n,i){i.x=En.set(kn,t.m00,t.m01,t.m02).length(),Hn.m00=t.m00/i.x,Hn.m01=t.m01/i.x,Hn.m02=t.m02/i.x,i.y=En.set(kn,t.m04,t.m05,t.m06).length(),Hn.m03=t.m04/i.y,Hn.m04=t.m05/i.y,Hn.m05=t.m06/i.y,i.z=En.set(kn,t.m08,t.m09,t.m10).length(),Hn.m06=t.m08/i.z,Hn.m07=t.m09/i.z,Hn.m08=t.m10/i.z,Rn.determinant(Hn)<0&&(i.x*=-1,Hn.m00*=-1,Hn.m01*=-1,Hn.m02*=-1),Mn.fromMat3(e,Hn),En.set(n,t.m12,t.m13,t.m14)},e.fromRTS=function(t,e,n,i){var r=e.x,o=e.y,a=e.z,s=e.w,c=r+r,l=o+o,u=a+a,h=r*c,_=r*l,f=r*u,p=o*l,d=o*u,m=a*u,v=s*c,g=s*l,y=s*u,x=i.x,S=i.y,C=i.z;return t.m00=(1-(p+m))*x,t.m01=(_+y)*x,t.m02=(f-g)*x,t.m03=0,t.m04=(_-y)*S,t.m05=(1-(h+m))*S,t.m06=(d+v)*S,t.m07=0,t.m08=(f+g)*C,t.m09=(d-v)*C,t.m10=(1-(h+p))*C,t.m11=0,t.m12=n.x,t.m13=n.y,t.m14=n.z,t.m15=1,t},e.fromRTSOrigin=function(t,e,n,i,r){var o=e.x,a=e.y,s=e.z,c=e.w,l=o+o,u=a+a,h=s+s,_=o*l,f=o*u,p=o*h,d=a*u,m=a*h,v=s*h,g=c*l,y=c*u,x=c*h,S=i.x,C=i.y,A=i.z,b=r.x,T=r.y,E=r.z;return t.m00=(1-(d+v))*S,t.m01=(f+x)*S,t.m02=(p-y)*S,t.m03=0,t.m04=(f-x)*C,t.m05=(1-(_+v))*C,t.m06=(m+g)*C,t.m07=0,t.m08=(p+y)*A,t.m09=(m-g)*A,t.m10=(1-(_+d))*A,t.m11=0,t.m12=n.x+b-(t.m00*b+t.m04*T+t.m08*E),t.m13=n.y+T-(t.m01*b+t.m05*T+t.m09*E),t.m14=n.z+E-(t.m02*b+t.m06*T+t.m10*E),t.m15=1,t},e.fromQuat=function(t,e){var n=e.x,i=e.y,r=e.z,o=e.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,_=r*a,f=r*s,p=r*c,d=o*a,m=o*s,v=o*c;return t.m00=1-h-p,t.m01=u+v,t.m02=_-m,t.m03=0,t.m04=u-v,t.m05=1-l-p,t.m06=f+d,t.m07=0,t.m08=_+m,t.m09=f-d,t.m10=1-l-h,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t},e.frustum=function(t,e,n,i,r,o,a){var s=1/(n-e),c=1/(r-i),l=1/(o-a);return t.m00=2*o*s,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=2*o*c,t.m06=0,t.m07=0,t.m08=(n+e)*s,t.m09=(r+i)*c,t.m10=(a+o)*l,t.m11=-1,t.m12=0,t.m13=0,t.m14=a*o*2*l,t.m15=0,t},e.perspective=function(t,e,n,i,r,o,a,s,c){void 0===o&&(o=!0),void 0===a&&(a=-1),void 0===s&&(s=1),void 0===c&&(c=0);var l=1/Math.tan(e/2),u=1/(i-r),h=o?l/n:l,_=(o?l:l*n)*s,f=Vn[c];return t.m00=h*f[0],t.m01=h*f[1],t.m02=0,t.m03=0,t.m04=_*f[2],t.m05=_*f[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=(r-a*i)*u,t.m11=-1,t.m12=0,t.m13=0,t.m14=r*i*u*(1-a),t.m15=0,t},e.ortho=function(t,e,n,i,r,o,a,s,c,l){void 0===s&&(s=-1),void 0===c&&(c=1),void 0===l&&(l=0);var u=1/(e-n),h=1/(i-r)*c,_=1/(o-a),f=-2*u,p=-2*h,d=(e+n)*u,m=(r+i)*h,v=Vn[l];return t.m00=f*v[0],t.m01=f*v[1],t.m02=0,t.m03=0,t.m04=p*v[2],t.m05=p*v[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=_*(1-s),t.m11=0,t.m12=d*v[0]+m*v[2],t.m13=d*v[1]+m*v[3],t.m14=(o-s*a)*_,t.m15=1,t},e.lookAt=function(t,e,n,i){var r=e.x,o=e.y,a=e.z,s=i.x,c=i.y,l=i.z,u=r-n.x,h=o-n.y,_=a-n.z,f=1/Math.sqrt(u*u+h*h+_*_),p=c*(_*=f)-l*(h*=f),d=l*(u*=f)-s*_,m=s*h-c*u,v=h*(m*=f=1/Math.sqrt(p*p+d*d+m*m))-_*(d*=f),g=_*(p*=f)-u*m,y=u*d-h*p;return t.m00=p,t.m01=v,t.m02=u,t.m03=0,t.m04=d,t.m05=g,t.m06=h,t.m07=0,t.m08=m,t.m09=y,t.m10=_,t.m11=0,t.m12=-(p*r+d*o+m*a),t.m13=-(v*r+g*o+y*a),t.m14=-(u*r+h*o+_*a),t.m15=1,t},e.inverseTranspose=function(t,e){var n=e.m00,i=e.m01,r=e.m02,o=e.m03,a=e.m04,s=e.m05,c=e.m06,l=e.m07,u=e.m08,h=e.m09,_=e.m10,f=e.m11,p=e.m12,d=e.m13,m=e.m14,v=e.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,C=i*l-o*s,A=r*l-o*c,b=u*d-h*p,T=u*m-_*p,E=u*v-f*p,w=h*m-_*d,P=h*v-f*d,I=_*v-f*m,R=g*I-y*P+x*w+S*E-C*T+A*b;return R?(R=1/R,t.m00=(s*I-c*P+l*w)*R,t.m01=(c*E-a*I-l*T)*R,t.m02=(a*P-s*E+l*b)*R,t.m03=0,t.m04=(r*P-i*I-o*w)*R,t.m05=(n*I-r*E+o*T)*R,t.m06=(i*E-n*P-o*b)*R,t.m07=0,t.m08=(d*A-m*C+v*S)*R,t.m09=(m*x-p*A-v*y)*R,t.m10=(p*C-d*x+v*g)*R,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t):null},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.m00,t[n+1]=e.m01,t[n+2]=e.m02,t[n+3]=e.m03,t[n+4]=e.m04,t[n+5]=e.m05,t[n+6]=e.m06,t[n+7]=e.m07,t[n+8]=e.m08,t[n+9]=e.m09,t[n+10]=e.m10,t[n+11]=e.m11,t[n+12]=e.m12,t[n+13]=e.m13,t[n+14]=e.m14,t[n+15]=e.m15,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.m00=e[n+0],t.m01=e[n+1],t.m02=e[n+2],t.m03=e[n+3],t.m04=e[n+4],t.m05=e[n+5],t.m06=e[n+6],t.m07=e[n+7],t.m08=e[n+8],t.m09=e[n+9],t.m10=e[n+10],t.m11=e[n+11],t.m12=e[n+12],t.m13=e[n+13],t.m14=e[n+14],t.m15=e[n+15],t},e.add=function(t,e,n){return t.m00=e.m00+n.m00,t.m01=e.m01+n.m01,t.m02=e.m02+n.m02,t.m03=e.m03+n.m03,t.m04=e.m04+n.m04,t.m05=e.m05+n.m05,t.m06=e.m06+n.m06,t.m07=e.m07+n.m07,t.m08=e.m08+n.m08,t.m09=e.m09+n.m09,t.m10=e.m10+n.m10,t.m11=e.m11+n.m11,t.m12=e.m12+n.m12,t.m13=e.m13+n.m13,t.m14=e.m14+n.m14,t.m15=e.m15+n.m15,t},e.subtract=function(t,e,n){return t.m00=e.m00-n.m00,t.m01=e.m01-n.m01,t.m02=e.m02-n.m02,t.m03=e.m03-n.m03,t.m04=e.m04-n.m04,t.m05=e.m05-n.m05,t.m06=e.m06-n.m06,t.m07=e.m07-n.m07,t.m08=e.m08-n.m08,t.m09=e.m09-n.m09,t.m10=e.m10-n.m10,t.m11=e.m11-n.m11,t.m12=e.m12-n.m12,t.m13=e.m13-n.m13,t.m14=e.m14-n.m14,t.m15=e.m15-n.m15,t},e.multiplyScalar=function(t,e,n){return t.m00=e.m00*n,t.m01=e.m01*n,t.m02=e.m02*n,t.m03=e.m03*n,t.m04=e.m04*n,t.m05=e.m05*n,t.m06=e.m06*n,t.m07=e.m07*n,t.m08=e.m08*n,t.m09=e.m09*n,t.m10=e.m10*n,t.m11=e.m11*n,t.m12=e.m12*n,t.m13=e.m13*n,t.m14=e.m14*n,t.m15=e.m15*n,t},e.multiplyScalarAndAdd=function(t,e,n,i){return t.m00=e.m00+n.m00*i,t.m01=e.m01+n.m01*i,t.m02=e.m02+n.m02*i,t.m03=e.m03+n.m03*i,t.m04=e.m04+n.m04*i,t.m05=e.m05+n.m05*i,t.m06=e.m06+n.m06*i,t.m07=e.m07+n.m07*i,t.m08=e.m08+n.m08*i,t.m09=e.m09+n.m09*i,t.m10=e.m10+n.m10*i,t.m11=e.m11+n.m11*i,t.m12=e.m12+n.m12*i,t.m13=e.m13+n.m13*i,t.m14=e.m14+n.m14*i,t.m15=e.m15+n.m15*i,t},e.strictEquals=function(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08&&t.m09===e.m09&&t.m10===e.m10&&t.m11===e.m11&&t.m12===e.m12&&t.m13===e.m13&&t.m14===e.m14&&t.m15===e.m15},e.equals=function(t,e,n){return void 0===n&&(n=en),Math.abs(t.m00-e.m00)<=n*Math.max(1,Math.abs(t.m00),Math.abs(e.m00))&&Math.abs(t.m01-e.m01)<=n*Math.max(1,Math.abs(t.m01),Math.abs(e.m01))&&Math.abs(t.m02-e.m02)<=n*Math.max(1,Math.abs(t.m02),Math.abs(e.m02))&&Math.abs(t.m03-e.m03)<=n*Math.max(1,Math.abs(t.m03),Math.abs(e.m03))&&Math.abs(t.m04-e.m04)<=n*Math.max(1,Math.abs(t.m04),Math.abs(e.m04))&&Math.abs(t.m05-e.m05)<=n*Math.max(1,Math.abs(t.m05),Math.abs(e.m05))&&Math.abs(t.m06-e.m06)<=n*Math.max(1,Math.abs(t.m06),Math.abs(e.m06))&&Math.abs(t.m07-e.m07)<=n*Math.max(1,Math.abs(t.m07),Math.abs(e.m07))&&Math.abs(t.m08-e.m08)<=n*Math.max(1,Math.abs(t.m08),Math.abs(e.m08))&&Math.abs(t.m09-e.m09)<=n*Math.max(1,Math.abs(t.m09),Math.abs(e.m09))&&Math.abs(t.m10-e.m10)<=n*Math.max(1,Math.abs(t.m10),Math.abs(e.m10))&&Math.abs(t.m11-e.m11)<=n*Math.max(1,Math.abs(t.m11),Math.abs(e.m11))&&Math.abs(t.m12-e.m12)<=n*Math.max(1,Math.abs(t.m12),Math.abs(e.m12))&&Math.abs(t.m13-e.m13)<=n*Math.max(1,Math.abs(t.m13),Math.abs(e.m13))&&Math.abs(t.m14-e.m14)<=n*Math.max(1,Math.abs(t.m14),Math.abs(e.m14))&&Math.abs(t.m15-e.m15)<=n*Math.max(1,Math.abs(t.m15),Math.abs(e.m15))};var n=e.prototype;return n.clone=function(){return new e(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08,this.m09,this.m10,this.m11,this.m12,this.m13,this.m14,this.m15)},n.set=function(t,e,n,i,r,o,a,s,c,l,u,h,_,f,p,d){return void 0===t&&(t=1),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===p&&(p=0),void 0===d&&(d=1),"object"==typeof t?(this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08,this.m09=t.m09,this.m10=t.m10,this.m11=t.m11,this.m12=t.m12,this.m13=t.m13,this.m14=t.m14,this.m15=t.m15,this.m00=t.m00):(this.m01=e,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c,this.m09=l,this.m10=u,this.m11=h,this.m12=_,this.m13=f,this.m14=p,this.m15=d,this.m00=t),this},n.equals=function(t,e){return void 0===e&&(e=en),Math.abs(this.m00-t.m00)<=e*Math.max(1,Math.abs(this.m00),Math.abs(t.m00))&&Math.abs(this.m01-t.m01)<=e*Math.max(1,Math.abs(this.m01),Math.abs(t.m01))&&Math.abs(this.m02-t.m02)<=e*Math.max(1,Math.abs(this.m02),Math.abs(t.m02))&&Math.abs(this.m03-t.m03)<=e*Math.max(1,Math.abs(this.m03),Math.abs(t.m03))&&Math.abs(this.m04-t.m04)<=e*Math.max(1,Math.abs(this.m04),Math.abs(t.m04))&&Math.abs(this.m05-t.m05)<=e*Math.max(1,Math.abs(this.m05),Math.abs(t.m05))&&Math.abs(this.m06-t.m06)<=e*Math.max(1,Math.abs(this.m06),Math.abs(t.m06))&&Math.abs(this.m07-t.m07)<=e*Math.max(1,Math.abs(this.m07),Math.abs(t.m07))&&Math.abs(this.m08-t.m08)<=e*Math.max(1,Math.abs(this.m08),Math.abs(t.m08))&&Math.abs(this.m09-t.m09)<=e*Math.max(1,Math.abs(this.m09),Math.abs(t.m09))&&Math.abs(this.m10-t.m10)<=e*Math.max(1,Math.abs(this.m10),Math.abs(t.m10))&&Math.abs(this.m11-t.m11)<=e*Math.max(1,Math.abs(this.m11),Math.abs(t.m11))&&Math.abs(this.m12-t.m12)<=e*Math.max(1,Math.abs(this.m12),Math.abs(t.m12))&&Math.abs(this.m13-t.m13)<=e*Math.max(1,Math.abs(this.m13),Math.abs(t.m13))&&Math.abs(this.m14-t.m14)<=e*Math.max(1,Math.abs(this.m14),Math.abs(t.m14))&&Math.abs(this.m15-t.m15)<=e*Math.max(1,Math.abs(this.m15),Math.abs(t.m15))},n.strictEquals=function(t){return this.m00===t.m00&&this.m01===t.m01&&this.m02===t.m02&&this.m03===t.m03&&this.m04===t.m04&&this.m05===t.m05&&this.m06===t.m06&&this.m07===t.m07&&this.m08===t.m08&&this.m09===t.m09&&this.m10===t.m10&&this.m11===t.m11&&this.m12===t.m12&&this.m13===t.m13&&this.m14===t.m14&&this.m15===t.m15},n.toString=function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},n.zero=function(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this},n.transpose=function(){var t=this.m01,e=this.m02,n=this.m03,i=this.m06,r=this.m07,o=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=t,this.m06=this.m09,this.m07=this.m13,this.m08=e,this.m09=i,this.m11=this.m14,this.m12=n,this.m13=r,this.m14=o,this},n.invert=function(){var t=this.m00,e=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,p=this.m14,d=this.m15,m=t*o-e*r,v=t*a-n*r,g=t*s-i*r,y=e*a-n*o,x=e*s-i*o,S=n*s-i*a,C=c*f-l*_,A=c*p-u*_,b=c*d-h*_,T=l*p-u*f,E=l*d-h*f,w=u*d-h*p,P=m*w-v*E+g*T+y*b-x*A+S*C;return 0===P?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(P=1/P,this.m00=(o*w-a*E+s*T)*P,this.m01=(n*E-e*w-i*T)*P,this.m02=(f*S-p*x+d*y)*P,this.m03=(u*x-l*S-h*y)*P,this.m04=(a*b-r*w-s*A)*P,this.m05=(t*w-n*b+i*A)*P,this.m06=(p*g-_*S-d*v)*P,this.m07=(c*S-u*g+h*v)*P,this.m08=(r*E-o*b+s*C)*P,this.m09=(e*b-t*E-i*C)*P,this.m10=(_*x-f*g+d*m)*P,this.m11=(l*g-c*x-h*m)*P,this.m12=(o*A-r*T-a*C)*P,this.m13=(t*T-e*A+n*C)*P,this.m14=(f*v-_*y-p*m)*P,this.m15=(c*y-l*v+u*m)*P,this)},n.determinant=function(){var t=this.m00,e=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,p=this.m14,d=this.m15;return(t*o-e*r)*(u*d-h*p)-(t*a-n*r)*(l*d-h*f)+(t*s-i*r)*(l*p-u*f)+(e*a-n*o)*(c*d-h*_)-(e*s-i*o)*(c*p-u*_)+(n*s-i*a)*(c*f-l*_)},n.add=function(t){return this.m00+=t.m00,this.m01+=t.m01,this.m02+=t.m02,this.m03+=t.m03,this.m04+=t.m04,this.m05+=t.m05,this.m06+=t.m06,this.m07+=t.m07,this.m08+=t.m08,this.m09+=t.m09,this.m10+=t.m10,this.m11+=t.m11,this.m12+=t.m12,this.m13+=t.m13,this.m14+=t.m14,this.m15+=t.m15,this},n.subtract=function(t){return this.m00-=t.m00,this.m01-=t.m01,this.m02-=t.m02,this.m03-=t.m03,this.m04-=t.m04,this.m05-=t.m05,this.m06-=t.m06,this.m07-=t.m07,this.m08-=t.m08,this.m09-=t.m09,this.m10-=t.m10,this.m11-=t.m11,this.m12-=t.m12,this.m13-=t.m13,this.m14-=t.m14,this.m15-=t.m15,this},n.multiply=function(t){var e=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=this.m09,h=this.m10,_=this.m11,f=this.m12,p=this.m13,d=this.m14,m=this.m15,v=t.m00,g=t.m01,y=t.m02,x=t.m03;return this.m00=v*e+g*o+y*l+x*f,this.m01=v*n+g*a+y*u+x*p,this.m02=v*i+g*s+y*h+x*d,this.m03=v*r+g*c+y*_+x*m,v=t.m04,g=t.m05,y=t.m06,x=t.m07,this.m04=v*e+g*o+y*l+x*f,this.m05=v*n+g*a+y*u+x*p,this.m06=v*i+g*s+y*h+x*d,this.m07=v*r+g*c+y*_+x*m,v=t.m08,g=t.m09,y=t.m10,x=t.m11,this.m08=v*e+g*o+y*l+x*f,this.m09=v*n+g*a+y*u+x*p,this.m10=v*i+g*s+y*h+x*d,this.m11=v*r+g*c+y*_+x*m,v=t.m12,g=t.m13,y=t.m14,x=t.m15,this.m12=v*e+g*o+y*l+x*f,this.m13=v*n+g*a+y*u+x*p,this.m14=v*i+g*s+y*h+x*d,this.m15=v*r+g*c+y*_+x*m,this},n.multiplyScalar=function(t){return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=t,this.m05*=t,this.m06*=t,this.m07*=t,this.m08*=t,this.m09*=t,this.m10*=t,this.m11*=t,this.m12*=t,this.m13*=t,this.m14*=t,this.m15*=t,this},n.translate=function(t){return console.warn("function changed"),this.m12+=t.x,this.m13+=t.y,this.m14+=t.z,this},n.scale=function(t){var e=t.x,n=t.y,i=t.z;return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=n,this.m05*=n,this.m06*=n,this.m07*=n,this.m08*=i,this.m09*=i,this.m10*=i,this.m11*=i,this},n.rotate=function(t,e){var n=e.x,i=e.y,r=e.z,o=Math.sqrt(n*n+i*i+r*r);if(Math.abs(o)<en)return null;n*=o=1/o,i*=o,r*=o;var a=Math.sin(t),s=Math.cos(t),c=1-s,l=this.m00,u=this.m01,h=this.m02,_=this.m03,f=this.m04,p=this.m05,d=this.m06,m=this.m07,v=this.m08,g=this.m09,y=this.m10,x=this.m11,S=n*n*c+s,C=i*n*c+r*a,A=r*n*c-i*a,b=n*i*c-r*a,T=i*i*c+s,E=r*i*c+n*a,w=n*r*c+i*a,P=i*r*c-n*a,I=r*r*c+s;return this.m00=l*S+f*C+v*A,this.m01=u*S+p*C+g*A,this.m02=h*S+d*C+y*A,this.m03=_*S+m*C+x*A,this.m04=l*b+f*T+v*E,this.m05=u*b+p*T+g*E,this.m06=h*b+d*T+y*E,this.m07=_*b+m*T+x*E,this.m08=l*w+f*P+v*I,this.m09=u*w+p*P+g*I,this.m10=h*w+d*P+y*I,this.m11=_*w+m*P+x*I,this},n.getTranslation=function(t){return t.x=this.m12,t.y=this.m13,t.z=this.m14,t},n.getScale=function(t){var e=Hn.m00=this.m00,n=Hn.m01=this.m01,i=Hn.m02=this.m02,r=Hn.m03=this.m04,o=Hn.m04=this.m05,a=Hn.m05=this.m06,s=Hn.m06=this.m08,c=Hn.m07=this.m09,l=Hn.m08=this.m10;return t.x=Math.sqrt(e*e+n*n+i*i),t.y=Math.sqrt(r*r+o*o+a*a),t.z=Math.sqrt(s*s+c*c+l*l),Rn.determinant(Hn)<0&&(t.x*=-1),t},n.getRotation=function(t){var e=this.m00+this.m05+this.m10,n=0;return e>0?(n=2*Math.sqrt(e+1),t.w=.25*n,t.x=(this.m06-this.m09)/n,t.y=(this.m08-this.m02)/n,t.z=(this.m01-this.m04)/n):this.m00>this.m05&&this.m00>this.m10?(n=2*Math.sqrt(1+this.m00-this.m05-this.m10),t.w=(this.m06-this.m09)/n,t.x=.25*n,t.y=(this.m01+this.m04)/n,t.z=(this.m08+this.m02)/n):this.m05>this.m10?(n=2*Math.sqrt(1+this.m05-this.m00-this.m10),t.w=(this.m08-this.m02)/n,t.x=(this.m01+this.m04)/n,t.y=.25*n,t.z=(this.m06+this.m09)/n):(n=2*Math.sqrt(1+this.m10-this.m00-this.m05),t.w=(this.m01-this.m04)/n,t.x=(this.m08+this.m02)/n,t.y=(this.m06+this.m09)/n,t.z=.25*n),t},n.fromRTS=function(t,e,n){var i=t.x,r=t.y,o=t.z,a=t.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,_=i*l,f=r*c,p=r*l,d=o*l,m=a*s,v=a*c,g=a*l,y=n.x,x=n.y,S=n.z;return this.m00=(1-(f+d))*y,this.m01=(h+g)*y,this.m02=(_-v)*y,this.m03=0,this.m04=(h-g)*x,this.m05=(1-(u+d))*x,this.m06=(p+m)*x,this.m07=0,this.m08=(_+v)*S,this.m09=(p-m)*S,this.m10=(1-(u+f))*S,this.m11=0,this.m12=e.x,this.m13=e.y,this.m14=e.z,this.m15=1,this},n.fromQuat=function(t){var e=t.x,n=t.y,i=t.z,r=t.w,o=e+e,a=n+n,s=i+i,c=e*o,l=n*o,u=n*a,h=i*o,_=i*a,f=i*s,p=r*o,d=r*a,m=r*s;return this.m00=1-u-f,this.m01=l+m,this.m02=h-d,this.m03=0,this.m04=l-m,this.m05=1-c-f,this.m06=_+p,this.m07=0,this.m08=h+d,this.m09=_-p,this.m10=1-c-u,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},e}(se));Un.IDENTITY=Object.freeze(new Un);var kn=new En,Hn=new Rn;function jn(t,e,n,i,r,o,a,s,c,l,u,h,_,f,p,d){return new Un(t,e,n,i,r,o,a,s,c,l,u,h,_,f,p,d)}Je.fastDefine("cc.Mat4",Un,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),c.Mat4=Un,c.mat4=jn;var Wn=t("Vec2",function(t){function e(e,n){var i;return i=t.call(this)||this,e&&"object"==typeof e?(i.x=e.x,i.y=e.y):(i.x=e||0,i.y=n||0),i}Q(e,t),e.clone=function(t){return new e(t.x,t.y)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t},e.set=function(t,e,n){return t.x=e,t.y=n,t},e.add=function(t,e,n){return t.x=e.x+n.x,t.y=e.y+n.y,t},e.subtract=function(t,e,n){return t.x=e.x-n.x,t.y=e.y-n.y,t},e.multiply=function(t,e,n){return t.x=e.x*n.x,t.y=e.y*n.y,t},e.divide=function(t,e,n){return t.x=e.x/n.x,t.y=e.y/n.y,t},e.ceil=function(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t},e.floor=function(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t},e.min=function(t,e,n){return t.x=Math.min(e.x,n.x),t.y=Math.min(e.y,n.y),t},e.max=function(t,e,n){return t.x=Math.max(e.x,n.x),t.y=Math.max(e.y,n.y),t},e.round=function(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t},e.multiplyScalar=function(t,e,n){return t.x=e.x*n,t.y=e.y*n,t},e.scaleAndAdd=function(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t},e.distance=function(t,e){var n=e.x-t.x,i=e.y-t.y;return Math.sqrt(n*n+i*i)},e.squaredDistance=function(t,e){var n=e.x-t.x,i=e.y-t.y;return n*n+i*i},e.len=function(t){var e=t.x,n=t.y;return Math.sqrt(e*e+n*n)},e.lengthSqr=function(t){var e=t.x,n=t.y;return e*e+n*n},e.negate=function(t,e){return t.x=-e.x,t.y=-e.y,t},e.inverse=function(t,e){return t.x=1/e.x,t.y=1/e.y,t},e.inverseSafe=function(t,e){var n=e.x,i=e.y;return Math.abs(n)<en?t.x=0:t.x=1/n,Math.abs(i)<en?t.y=0:t.y=1/i,t},e.normalize=function(t,e){var n=e.x,i=e.y,r=n*n+i*i;return r>0&&(r=1/Math.sqrt(r),t.x=n*r,t.y=i*r),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y},e.cross=function(t,e,n){return t instanceof En?(t.x=t.y=0,t.z=e.x*n.y-e.y*n.x,t):t.x*e.y-t.y*e.x},e.lerp=function(t,e,n,i){var r=e.x,o=e.y;return t.x=r+i*(n.x-r),t.y=o+i*(n.y-o),t},e.random=function(t,e){e=e||1;var n=2*un()*Math.PI;return t.x=Math.cos(n)*e,t.y=Math.sin(n)*e,t},e.transformMat3=function(t,e,n){var i=e.x,r=e.y;return t.x=n.m00*i+n.m03*r+n.m06,t.y=n.m01*i+n.m04*r+n.m07,t},e.transformMat4=function(t,e,n){var i=e.x,r=e.y;return t.x=n.m00*i+n.m04*r+n.m12,t.y=n.m01*i+n.m05*r+n.m13,t},e.str=function(t){return"Vec2("+t.x+", "+t.y+")"},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.x,t[n+1]=e.y,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.x=e[n+0],t.y=e[n+1],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y},e.equals=function(t,e,n){return void 0===n&&(n=en),Math.abs(t.x-e.x)<=n*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=n*Math.max(1,Math.abs(t.y),Math.abs(e.y))},e.angle=function(t,n){e.normalize(qn,t),e.normalize(Xn,n);var i=e.dot(qn,Xn);return i>1?0:i<-1?Math.PI:Math.acos(i)};var n=e.prototype;return n.clone=function(){return new e(this.x,this.y)},n.set=function(t,e){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y):(this.x=t||0,this.y=e||0),this},n.equals=function(t,e){return void 0===e&&(e=en),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))},n.equals2f=function(t,e,n){return void 0===n&&(n=en),Math.abs(this.x-t)<=n*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=n*Math.max(1,Math.abs(this.y),Math.abs(e))},n.strictEquals=function(t){return t&&this.x===t.x&&this.y===t.y},n.strictEquals2f=function(t,e){return this.x===t&&this.y===e},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+")"},n.lerp=function(t,e){var n=this.x,i=this.y;return this.x=n+e*(t.x-n),this.y=i+e*(t.y-i),this},n.clampf=function(t,e){return this.x=on(this.x,t.x,e.x),this.y=on(this.y,t.y,e.y),this},n.add=function(t){return this.x+=t.x,this.y+=t.y,this},n.add2f=function(t,e){return this.x+=t,this.y+=e,this},n.subtract=function(t){return this.x-=t.x,this.y-=t.y,this},n.subtract2f=function(t,e){return this.x-=t,this.y-=e,this},n.multiplyScalar=function(t){return"object"==typeof t&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=t,this.y*=t,this},n.multiply=function(t){return"object"!=typeof t&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this},n.multiply2f=function(t,e){return this.x*=t,this.y*=e,this},n.divide=function(t){return this.x/=t.x,this.y/=t.y,this},n.divide2f=function(t,e){return this.x/=t,this.y/=e,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this},n.dot=function(t){return this.x*t.x+this.y*t.y},n.cross=function(t){return this.x*t.y-this.y*t.x},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y},n.normalize=function(){var t=this.x,e=this.y,n=t*t+e*e;return n>0&&(n=1/Math.sqrt(n),this.x*=n,this.y*=n),this},n.angle=function(t){var e=this.lengthSqr(),n=t.lengthSqr();if(0===e||0===n)return console.warn("Can't get angle between zero vector"),0;var i=this.dot(t)/Math.sqrt(e*n);return i=on(i,-1,1),Math.acos(i)},n.signAngle=function(t){var e=this.angle(t);return this.cross(t)<0?-e:e},n.rotate=function(t){var e=this.x,n=this.y,i=Math.sin(t),r=Math.cos(t);return this.x=r*e-i*n,this.y=i*e+r*n,this},n.project=function(t){var e=this.dot(t)/t.dot(t);return this.x=t.x*e,this.y=t.y*e,this},n.transformMat4=function(t){var e=this.x,n=this.y;return this.x=t.m00*e+t.m04*n+t.m12,this.y=t.m01*e+t.m05*n+t.m13,this},e}(se));Wn.ZERO=Object.freeze(new Wn(0,0)),Wn.ONE=Object.freeze(new Wn(1,1)),Wn.NEG_ONE=Object.freeze(new Wn(-1,-1)),Wn.UNIT_X=Object.freeze(new Wn(1,0)),Wn.UNIT_Y=Object.freeze(new Wn(0,1));var qn=new Wn,Xn=new Wn;function Yn(t,e){return new Wn(t,e)}Je.fastDefine("cc.Vec2",Wn,{x:0,y:0}),c.Vec2=Wn,c.v2=Yn;var Kn=t("Vec4",function(t){function e(e,n,i,r){var o;return o=t.call(this)||this,e&&"object"==typeof e?(o.x=e.x,o.y=e.y,o.z=e.z,o.w=e.w):(o.x=e||0,o.y=n||0,o.z=i||0,o.w=r||0),o}Q(e,t),e.clone=function(t){return new e(t.x,t.y,t.z,t.w)},e.copy=function(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t},e.set=function(t,e,n,i,r){return t.x=e,t.y=n,t.z=i,t.w=r,t},e.add=function(t,e,n){return t.x=e.x+n.x,t.y=e.y+n.y,t.z=e.z+n.z,t.w=e.w+n.w,t},e.subtract=function(t,e,n){return t.x=e.x-n.x,t.y=e.y-n.y,t.z=e.z-n.z,t.w=e.w-n.w,t},e.multiply=function(t,e,n){return t.x=e.x*n.x,t.y=e.y*n.y,t.z=e.z*n.z,t.w=e.w*n.w,t},e.divide=function(t,e,n){return t.x=e.x/n.x,t.y=e.y/n.y,t.z=e.z/n.z,t.w=e.w/n.w,t},e.ceil=function(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t.z=Math.ceil(e.z),t.w=Math.ceil(e.w),t},e.floor=function(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t.z=Math.floor(e.z),t.w=Math.floor(e.w),t},e.min=function(t,e,n){return t.x=Math.min(e.x,n.x),t.y=Math.min(e.y,n.y),t.z=Math.min(e.z,n.z),t.w=Math.min(e.w,n.w),t},e.max=function(t,e,n){return t.x=Math.max(e.x,n.x),t.y=Math.max(e.y,n.y),t.z=Math.max(e.z,n.z),t.w=Math.max(e.w,n.w),t},e.round=function(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t.z=Math.round(e.z),t.w=Math.round(e.w),t},e.multiplyScalar=function(t,e,n){return t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t.w=e.w*n,t},e.scaleAndAdd=function(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t.z=e.z+n.z*i,t.w=e.w+n.w*i,t},e.distance=function(t,e){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z,o=e.w-t.w;return Math.sqrt(n*n+i*i+r*r+o*o)},e.squaredDistance=function(t,e){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z,o=e.w-t.w;return n*n+i*i+r*r+o*o},e.len=function(t){var e=t.x,n=t.y,i=t.z,r=t.w;return Math.sqrt(e*e+n*n+i*i+r*r)},e.lengthSqr=function(t){var e=t.x,n=t.y,i=t.z,r=t.w;return e*e+n*n+i*i+r*r},e.negate=function(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=-e.w,t},e.inverse=function(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t.w=1/e.w,t},e.inverseSafe=function(t,e){var n=e.x,i=e.y,r=e.z,o=e.w;return Math.abs(n)<en?t.x=0:t.x=1/n,Math.abs(i)<en?t.y=0:t.y=1/i,Math.abs(r)<en?t.z=0:t.z=1/r,Math.abs(o)<en?t.w=0:t.w=1/o,t},e.normalize=function(t,e){var n=e.x,i=e.y,r=e.z,o=e.w,a=n*n+i*i+r*r+o*o;return a>0&&(a=1/Math.sqrt(a),t.x=n*a,t.y=i*a,t.z=r*a,t.w=o*a),t},e.dot=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w},e.lerp=function(t,e,n,i){return t.x=e.x+i*(n.x-e.x),t.y=e.y+i*(n.y-e.y),t.z=e.z+i*(n.z-e.z),t.w=e.w+i*(n.w-e.w),t},e.random=function(t,e){e=e||1;var n=2*un()*Math.PI,i=2*un()-1,r=Math.sqrt(1-i*i);return t.x=r*Math.cos(n)*e,t.y=r*Math.sin(n)*e,t.z=i*e,t.w=0,t},e.transformMat4=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=e.w;return t.x=n.m00*i+n.m04*r+n.m08*o+n.m12*a,t.y=n.m01*i+n.m05*r+n.m09*o+n.m13*a,t.z=n.m02*i+n.m06*r+n.m10*o+n.m14*a,t.w=n.m03*i+n.m07*r+n.m11*o+n.m15*a,t},e.transformAffine=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=e.w;return t.x=n.m00*i+n.m01*r+n.m02*o+n.m03*a,t.y=n.m04*i+n.m05*r+n.m06*o+n.m07*a,t.x=n.m08*i+n.m09*r+n.m10*o+n.m11*a,t.w=e.w,t},e.transformQuat=function(t,e,n){var i=e.x,r=e.y,o=e.z,a=n.x,s=n.y,c=n.z,l=n.w,u=l*i+s*o-c*r,h=l*r+c*i-a*o,_=l*o+a*r-s*i,f=-a*i-s*r-c*o;return t.x=u*l+f*-a+h*-c-_*-s,t.y=h*l+f*-s+_*-a-u*-c,t.z=_*l+f*-c+u*-s-h*-a,t.w=e.w,t},e.toArray=function(t,e,n){return void 0===n&&(n=0),t[n+0]=e.x,t[n+1]=e.y,t[n+2]=e.z,t[n+3]=e.w,t},e.fromArray=function(t,e,n){return void 0===n&&(n=0),t.x=e[n+0],t.y=e[n+1],t.z=e[n+2],t.w=e[n+3],t},e.strictEquals=function(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w},e.equals=function(t,e,n){return void 0===n&&(n=en),Math.abs(t.x-e.x)<=n*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=n*Math.max(1,Math.abs(t.y),Math.abs(e.y))&&Math.abs(t.z-e.z)<=n*Math.max(1,Math.abs(t.z),Math.abs(e.z))&&Math.abs(t.w-e.w)<=n*Math.max(1,Math.abs(t.w),Math.abs(e.w))};var n=e.prototype;return n.clone=function(){return new e(this.x,this.y,this.z,this.w)},n.set=function(t,e,n,i){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=n||0,this.w=i||0),this},n.equals=function(t,e){return void 0===e&&(e=en),Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))&&Math.abs(this.w-t.w)<=e*Math.max(1,Math.abs(this.w),Math.abs(t.w))},n.equals4f=function(t,e,n,i,r){return void 0===r&&(r=en),Math.abs(this.x-t)<=r*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=r*Math.max(1,Math.abs(this.y),Math.abs(e))&&Math.abs(this.z-n)<=r*Math.max(1,Math.abs(this.z),Math.abs(n))&&Math.abs(this.w-i)<=r*Math.max(1,Math.abs(this.w),Math.abs(i))},n.strictEquals=function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},n.strictEquals4f=function(t,e,n,i){return this.x===t&&this.y===e&&this.z===n&&this.w===i},n.lerp=function(t,e){var n=this.x,i=this.y,r=this.z,o=this.w;return this.x=n+e*(t.x-n),this.y=i+e*(t.y-i),this.z=r+e*(t.z-r),this.w=o+e*(t.w-o),this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+", "+this.w.toFixed(2)+")"},n.clampf=function(t,e){return this.x=on(this.x,t.x,e.x),this.y=on(this.y,t.y,e.y),this.z=on(this.z,t.z,e.z),this.w=on(this.w,t.w,e.w),this},n.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this},n.add4f=function(t,e,n,i){return this.x+=t,this.y+=e,this.z+=n,this.w+=i,this},n.subtract=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this},n.subtract4f=function(t,e,n,i){return this.x-=t,this.y-=e,this.z-=n,this.w-=i,this},n.multiplyScalar=function(t){return"object"==typeof t&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},n.multiply=function(t){return"object"!=typeof t&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this},n.multiply4f=function(t,e,n,i){return this.x*=t,this.y*=e,this.z*=n,this.w*=i,this},n.divide=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this},n.divide4f=function(t,e,n,i){return this.x/=t,this.y/=e,this.z/=n,this.w/=i,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},n.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},n.cross=function(t){var e=this.x,n=this.y,i=this.z,r=t.x,o=t.y,a=t.z;return this.x=n*a-i*o,this.y=i*r-e*a,this.z=e*o-n*r,this},n.length=function(){var t=this.x,e=this.y,n=this.z,i=this.w;return Math.sqrt(t*t+e*e+n*n+i*i)},n.lengthSqr=function(){var t=this.x,e=this.y,n=this.z,i=this.w;return t*t+e*e+n*n+i*i},n.normalize=function(){var t=this.x,e=this.y,n=this.z,i=this.w,r=t*t+e*e+n*n+i*i;return r>0&&(r=1/Math.sqrt(r),this.x=t*r,this.y=e*r,this.z=n*r,this.w=i*r),this},n.transformMat4=function(t){var e=this.x,n=this.y,i=this.z,r=this.w;return this.x=t.m00*e+t.m04*n+t.m08*i+t.m12*r,this.y=t.m01*e+t.m05*n+t.m09*i+t.m13*r,this.z=t.m02*e+t.m06*n+t.m10*i+t.m14*r,this.w=t.m03*e+t.m07*n+t.m11*i+t.m15*r,this},e}(se));function Jn(t,e,n,i){return new Kn(t,e,n,i)}Kn.ZERO=Object.freeze(new Kn(0,0,0,0)),Kn.ONE=Object.freeze(new Kn(1,1,1,1)),Kn.NEG_ONE=Object.freeze(new Kn(-1,-1,-1,-1)),Je.fastDefine("cc.Vec4",Kn,{x:0,y:0,z:0,w:0}),c.Vec4=Kn,c.v4=Jn,z(Wn,"Vec2",[{name:"sub",newName:"subtract",target:Wn,targetName:"Vec2"},{name:"mul",newName:"multiply",target:Wn,targetName:"Vec2"},{name:"div",newName:"divide",target:Wn,targetName:"Vec2"},{name:"dist",newName:"distance",target:Wn,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:Wn,targetName:"Vec2"},{name:"mag",newName:"len",target:Wn,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:Wn,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Wn,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Wn,targetName:"Vec2"}]),z(Wn.prototype,"Vec2",[{name:"mag",newName:"length",target:Wn.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:Wn.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Wn.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Wn.prototype,targetName:"Vec2"}]),z(En,"Vec3",[{name:"sub",newName:"subtract",target:En,targetName:"Vec3"},{name:"mul",newName:"multiply",target:En,targetName:"Vec3"},{name:"div",newName:"divide",target:En,targetName:"Vec3"},{name:"dist",newName:"distance",target:En,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:En,targetName:"Vec3"},{name:"mag",newName:"len",target:En,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:En,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:En,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:En,targetName:"Vec3"}]),z(En.prototype,"Vec3",[{name:"mag",newName:"length",target:En.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:En.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:En.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:En.prototype,targetName:"Vec3"}]),z(Kn,"Vec4",[{name:"sub",newName:"subtract",target:Kn,targetName:"Vec4"},{name:"mul",newName:"multiply",target:Kn,targetName:"Vec4"},{name:"div",newName:"divide",target:Kn,targetName:"Vec4"},{name:"dist",newName:"distance",target:Kn,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:Kn,targetName:"Vec4"},{name:"mag",newName:"len",target:Kn,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:Kn,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Kn,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Kn,targetName:"Vec4"}]),z(Kn.prototype,"Vec4",[{name:"mag",newName:"length",target:Kn.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:Kn.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Kn.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Kn.prototype,targetName:"Vec4"}]),z(Mn,"Quat",[{name:"mag",newName:"len",target:Mn,targetName:"Quat"},{name:"mul",newName:"multiply",target:Mn,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:Mn,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:Mn,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Mn,targetName:"Quat"}]),z(Mn.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:Mn.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Mn.prototype,targetName:"Quat"}]),z(bn,"Color",[{name:"sub",newName:"subtract",target:bn,targetName:"Color"},{name:"mul",newName:"multiply",target:bn,targetName:"Color"},{name:"div",newName:"divide",target:bn,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:bn,targetName:"Color"},{name:"fromHex",newName:"fromHEX",customFunction:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];var i=e[1].toString(16);return c.Color.fromHEX(e[0],i)}}]),z(Rn,"Mat3",[{name:"sub",newName:"subtract",target:Rn,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Rn,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Rn,targetName:"Mat3"},{name:"transfrom",newName:"transform",target:Rn,targetName:"Mat3"}]),z(Rn.prototype,"Mat3",[{name:"sub",newName:"subtract",target:Rn.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Rn.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:Rn.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Rn.prototype,targetName:"Mat3"}]),z(Un,"Mat4",[{name:"sub",newName:"subtract",target:Un,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Un,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Un,targetName:"Mat4"}]),z(Un.prototype,"Mat4",[{name:"sub",newName:"subtract",target:Un.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:Un.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:Un.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:Un.prototype,targetName:"Mat4"}]);var Qn=t("AffineTransform",function(){function t(t,e,n,i,r,o){void 0===t&&(t=1),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),this.a=t,this.b=e,this.c=n,this.d=i,this.tx=r,this.ty=o}return t.identity=function(){return new t},t.clone=function(e){return new t(e.a,e.b,e.c,e.d,e.tx,e.ty)},t.concat=function(t,e,n){var i=e.a,r=e.b,o=e.c,a=e.d,s=e.tx,c=e.ty;t.a=i*n.a+r*n.c,t.b=i*n.b+r*n.d,t.c=o*n.a+a*n.c,t.d=o*n.b+a*n.d,t.tx=s*n.a+c*n.c+n.tx,t.ty=s*n.b+c*n.d+n.ty},t.invert=function(t,e){var n=1/(e.a*e.d-e.b*e.c);t.a=n*e.d,t.b=-n*e.b,t.c=-n*e.c,t.d=n*e.a,t.tx=n*(e.c*e.ty-e.d*e.tx),t.ty=n*(e.b*e.tx-e.a*e.ty)},t.fromMat4=function(t,e){t.a=e.m00,t.b=e.m01,t.c=e.m04,t.d=e.m05,t.tx=e.m12,t.ty=e.m13},t.transformVec2=function(t,e,n,i){var r,o;void 0===i?(i=n,r=e.x,o=e.y):(r=e,o=n),t.x=i.a*r+i.c*o+i.tx,t.y=i.b*r+i.d*o+i.ty},t.transformSize=function(t,e,n){t.width=n.a*e.width+n.c*e.height,t.height=n.b*e.width+n.d*e.height},t.transformRect=function(t,e,n){var i=e.x+e.width,r=e.y+e.height,o=n.a*e.x+n.c*e.y+n.tx,a=n.b*e.x+n.d*e.y+n.ty,s=n.a*i+n.c*e.y+n.tx,c=n.b*i+n.d*e.y+n.ty,l=n.a*e.x+n.c*r+n.tx,u=n.b*e.x+n.d*r+n.ty,h=n.a*i+n.c*r+n.tx,_=n.b*i+n.d*r+n.ty,f=Math.min(o,s,l,h),p=Math.max(o,s,l,h),d=Math.min(a,c,u,_),m=Math.max(a,c,u,_);t.x=f,t.y=d,t.width=p-f,t.height=m-d},t.transformObb=function(t,e,n,i,r,o){var a=o.a*r.x+o.c*r.y+o.tx,s=o.b*r.x+o.d*r.y+o.ty,c=o.a*r.width,l=o.b*r.width,u=o.c*r.height,h=o.d*r.height;e.x=a,e.y=s,n.x=c+a,n.y=l+s,t.x=u+a,t.y=h+s,i.x=c+u+a,i.y=l+h+s},t}());c.AffineTransform=Qn;var Zn=t("Size",function(t){function e(e,n){var i;return i=t.call(this)||this,e&&"object"==typeof e?(i.width=e.width,i.height=e.height):(i.width=e||0,i.height=n||0),i}Q(e,t),e.lerp=function(t,e,n,i){return t.width=e.width+(n.width-e.width)*i,t.height=e.height+(n.height-e.height)*i,t};var n=e.prototype;return n.clone=function(){return new e(this.width,this.height)},n.set=function(t,e){return t&&"object"==typeof t?(this.height=t.height,this.width=t.width):(this.width=t||0,this.height=e||0),this},n.equals=function(t){return this.width===t.width&&this.height===t.height},n.lerp=function(t,e){return this.width+=(t.width-this.width)*e,this.height+=(t.height-this.height)*e,this},n.toString=function(){return"("+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},K(e,[{key:"x",get:function(){return this.width},set:function(t){this.width=t}},{key:"y",get:function(){return this.height},set:function(t){this.height=t}}]),e}(se));function $n(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),new Zn(t,e)}Zn.ZERO=Object.freeze(new Zn(0,0)),Zn.ONE=Object.freeze(new Zn(1,1)),Je.fastDefine("cc.Size",Zn,{width:0,height:0}),c.size=$n,c.Size=Zn;var ti=t("Rect",function(t){function e(e,n,i,r){var o;return o=t.call(this)||this,e&&"object"==typeof e?(o.y=e.y,o.width=e.width,o.height=e.height,o.x=e.x):(o.x=e||0,o.y=n||0,o.width=i||0,o.height=r||0),o}Q(e,t),e.fromMinMax=function(t,e,n){var i=Math.min(e.x,n.x),r=Math.min(e.y,n.y),o=Math.max(e.x,n.x),a=Math.max(e.y,n.y);return t.x=i,t.y=r,t.width=o-i,t.height=a-r,t},e.lerp=function(t,e,n,i){var r=e.x,o=e.y,a=e.width,s=e.height;return t.x=r+(n.x-r)*i,t.y=o+(n.y-o)*i,t.width=a+(n.width-a)*i,t.height=s+(n.height-s)*i,t},e.intersection=function(t,e,n){var i=e.x,r=e.y,o=e.x+e.width,a=e.y+e.height,s=n.x,c=n.y,l=n.x+n.width,u=n.y+n.height;return t.x=Math.max(i,s),t.y=Math.max(r,c),t.width=Math.min(o,l)-t.x,t.height=Math.min(a,u)-t.y,t},e.union=function(t,e,n){var i=e.x,r=e.y,o=e.width,a=e.height,s=n.x,c=n.y,l=n.width,u=n.height;return t.x=Math.min(i,s),t.y=Math.min(r,c),t.width=Math.max(i+o,s+l)-t.x,t.height=Math.max(r+a,c+u)-t.y,t};var n=e.prototype;return n.clone=function(){return new e(this.x,this.y,this.width,this.height)},n.set=function(t,e,n,i){return t&&"object"==typeof t?(this.y=t.y,this.width=t.width,this.height=t.height,this.x=t.x):(this.x=t||0,this.y=e||0,this.width=n||0,this.height=i||0),this},n.equals=function(t){return this.x===t.x&&this.y===t.y&&this.width===t.width&&this.height===t.height},n.lerp=function(t,e){var n=this.x,i=this.y,r=this.width,o=this.height;return this.x=n+(t.x-n)*e,this.y=i+(t.y-i)*e,this.width=r+(t.width-r)*e,this.height=o+(t.height-o)*e,this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},n.intersects=function(t){var e=this.x+this.width,n=this.y+this.height,i=t.x+t.width,r=t.y+t.height;return!(e<t.x||i<this.x||n<t.y||r<this.y)},n.contains=function(t){return this.x<=t.x&&this.x+this.width>=t.x&&this.y<=t.y&&this.y+this.height>=t.y},n.containsRect=function(t){return this.x<=t.x&&this.x+this.width>=t.x+t.width&&this.y<=t.y&&this.y+this.height>=t.y+t.height},n.transformMat4=function(t){var e=this.x,n=this.y,i=e+this.width,r=n+this.height,o=t.m00*e+t.m04*n+t.m12,a=t.m01*e+t.m05*n+t.m13,s=t.m00*i+t.m04*n+t.m12,c=t.m01*i+t.m05*n+t.m13,l=t.m00*e+t.m04*r+t.m12,u=t.m01*e+t.m05*r+t.m13,h=t.m00*i+t.m04*r+t.m12,_=t.m01*i+t.m05*r+t.m13,f=Math.min(o,s,l,h),p=Math.max(o,s,l,h),d=Math.min(a,c,u,_),m=Math.max(a,c,u,_);return this.x=f,this.y=d,this.width=p-f,this.height=m-d,this},n.transformMat4ToPoints=function(t,e,n,i,r){var o=this.x,a=this.y,s=o+this.width,c=a+this.height;e.x=t.m00*o+t.m04*a+t.m12,e.y=t.m01*o+t.m05*a+t.m13,r.x=t.m00*s+t.m04*a+t.m12,r.y=t.m01*s+t.m05*a+t.m13,n.x=t.m00*o+t.m04*c+t.m12,n.y=t.m01*o+t.m05*c+t.m13,i.x=t.m00*s+t.m04*c+t.m12,i.y=t.m01*s+t.m05*c+t.m13},K(e,[{key:"xMin",get:function(){return this.x},set:function(t){this.width+=this.x-t,this.x=t}},{key:"yMin",get:function(){return this.y},set:function(t){this.height+=this.y-t,this.y=t}},{key:"xMax",get:function(){return this.x+this.width},set:function(t){this.width=t-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(t){this.height=t-this.y}},{key:"center",get:function(){return new Wn(this.x+.5*this.width,this.y+.5*this.height)},set:function(t){this.x=t.x-.5*this.width,this.y=t.y-.5*this.height}},{key:"origin",get:function(){return new Wn(this.x,this.y)},set:function(t){this.x=t.x,this.y=t.y}},{key:"size",get:function(){return new Zn(this.width,this.height)},set:function(t){this.width=t.width,this.height=t.height}},{key:"z",get:function(){return this.width},set:function(t){this.width=t}},{key:"w",get:function(){return this.height},set:function(t){this.height=t}}]),e}(se));function ei(t,e,n,i){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),new ti(t,e,n,i)}Je.fastDefine("cc.Rect",ti,{x:0,y:0,width:0,height:0}),c.Rect=ti,c.rect=ei;var ni=t("MATH_FLOAT_ARRAY",Float64Array),ii=t("MathBase",function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e.createFloatArray=function(t){return new ni(t)},K(e,[{key:"array",get:function(){return this._array}}]),e}(se)),ri=Object.freeze({__proto__:null,bits:a,Vec2:Wn,v2:Yn,Vec3:En,v3:In,Vec4:Kn,v4:Jn,Quat:Mn,quat:Gn,Mat3:Rn,Mat4:Un,mat4:jn,AffineTransform:Qn,Size:Zn,size:$n,Rect:ti,rect:ei,Color:bn,color:Tn,EPSILON:en,equals:nn,approx:rn,clamp:on,clamp01:an,lerp:sn,toRadian:cn,toDegree:ln,random:un,randomRange:hn,randomRangeInt:_n,pseudoRandom:fn,pseudoRandomRange:pn,pseudoRandomRangeInt:dn,nextPow2:mn,repeat:vn,pingPong:gn,inverseLerp:yn,absMaxComponent:xn,absMax:Sn,enumerableProps:Cn,MATH_FLOAT_ARRAY:ni,MathBase:ii});t("math",ri);var oi,ai,si,ci,li,ui,hi,_i,fi,pi,di,mi,vi,gi,yi,xi,Si,Ci,Ai,bi,Ti,Ei,wi,Pi,Ii,Ri,Di,Bi,Mi,Oi,Ni,Li,Fi,zi,Gi,Vi,Ui,ki,Hi,ji,Wi,qi=function(t,e,n){for(var i=0;i<e.length;++i)t.length<=i&&t.push(new n),t[i].copy(e[i]);t.length=e.length};!function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.SWAPCHAIN=1]="SWAPCHAIN",t[t.BUFFER=2]="BUFFER",t[t.TEXTURE=3]="TEXTURE",t[t.RENDER_PASS=4]="RENDER_PASS",t[t.FRAMEBUFFER=5]="FRAMEBUFFER",t[t.SAMPLER=6]="SAMPLER",t[t.SHADER=7]="SHADER",t[t.DESCRIPTOR_SET_LAYOUT=8]="DESCRIPTOR_SET_LAYOUT",t[t.PIPELINE_LAYOUT=9]="PIPELINE_LAYOUT",t[t.PIPELINE_STATE=10]="PIPELINE_STATE",t[t.DESCRIPTOR_SET=11]="DESCRIPTOR_SET",t[t.INPUT_ASSEMBLER=12]="INPUT_ASSEMBLER",t[t.COMMAND_BUFFER=13]="COMMAND_BUFFER",t[t.QUEUE=14]="QUEUE",t[t.QUERY_POOL=15]="QUERY_POOL",t[t.GLOBAL_BARRIER=16]="GLOBAL_BARRIER",t[t.TEXTURE_BARRIER=17]="TEXTURE_BARRIER",t[t.BUFFER_BARRIER=18]="BUFFER_BARRIER",t[t.COUNT=19]="COUNT"}(oi||(oi={})),function(t){t[t.UNREADY=0]="UNREADY",t[t.FAILED=1]="FAILED",t[t.SUCCESS=2]="SUCCESS"}(ai||(ai={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.GLES2=1]="GLES2",t[t.GLES3=2]="GLES3",t[t.METAL=3]="METAL",t[t.VULKAN=4]="VULKAN",t[t.WEBGL=5]="WEBGL",t[t.WEBGL2=6]="WEBGL2",t[t.WEBGPU=7]="WEBGPU"}(si||(si={})),function(t){t[t.IDENTITY=0]="IDENTITY",t[t.ROTATE_90=1]="ROTATE_90",t[t.ROTATE_180=2]="ROTATE_180",t[t.ROTATE_270=3]="ROTATE_270"}(ci||(ci={})),function(t){t[t.COLOR_FLOAT=0]="COLOR_FLOAT",t[t.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",t[t.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",t[t.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",t[t.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",t[t.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",t[t.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",t[t.FORMAT_SRGB=7]="FORMAT_SRGB",t[t.FORMAT_ETC1=8]="FORMAT_ETC1",t[t.FORMAT_ETC2=9]="FORMAT_ETC2",t[t.FORMAT_DXT=10]="FORMAT_DXT",t[t.FORMAT_PVRTC=11]="FORMAT_PVRTC",t[t.FORMAT_ASTC=12]="FORMAT_ASTC",t[t.FORMAT_RGB8=13]="FORMAT_RGB8",t[t.ELEMENT_INDEX_UINT=14]="ELEMENT_INDEX_UINT",t[t.INSTANCED_ARRAYS=15]="INSTANCED_ARRAYS",t[t.MULTIPLE_RENDER_TARGETS=16]="MULTIPLE_RENDER_TARGETS",t[t.BLEND_MINMAX=17]="BLEND_MINMAX",t[t.COMPUTE_SHADER=18]="COMPUTE_SHADER",t[t.INPUT_ATTACHMENT_BENEFIT=19]="INPUT_ATTACHMENT_BENEFIT",t[t.COUNT=20]="COUNT"}(li||(li={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.A8=1]="A8",t[t.L8=2]="L8",t[t.LA8=3]="LA8",t[t.R8=4]="R8",t[t.R8SN=5]="R8SN",t[t.R8UI=6]="R8UI",t[t.R8I=7]="R8I",t[t.R16F=8]="R16F",t[t.R16UI=9]="R16UI",t[t.R16I=10]="R16I",t[t.R32F=11]="R32F",t[t.R32UI=12]="R32UI",t[t.R32I=13]="R32I",t[t.RG8=14]="RG8",t[t.RG8SN=15]="RG8SN",t[t.RG8UI=16]="RG8UI",t[t.RG8I=17]="RG8I",t[t.RG16F=18]="RG16F",t[t.RG16UI=19]="RG16UI",t[t.RG16I=20]="RG16I",t[t.RG32F=21]="RG32F",t[t.RG32UI=22]="RG32UI",t[t.RG32I=23]="RG32I",t[t.RGB8=24]="RGB8",t[t.SRGB8=25]="SRGB8",t[t.RGB8SN=26]="RGB8SN",t[t.RGB8UI=27]="RGB8UI",t[t.RGB8I=28]="RGB8I",t[t.RGB16F=29]="RGB16F",t[t.RGB16UI=30]="RGB16UI",t[t.RGB16I=31]="RGB16I",t[t.RGB32F=32]="RGB32F",t[t.RGB32UI=33]="RGB32UI",t[t.RGB32I=34]="RGB32I",t[t.RGBA8=35]="RGBA8",t[t.BGRA8=36]="BGRA8",t[t.SRGB8_A8=37]="SRGB8_A8",t[t.RGBA8SN=38]="RGBA8SN",t[t.RGBA8UI=39]="RGBA8UI",t[t.RGBA8I=40]="RGBA8I",t[t.RGBA16F=41]="RGBA16F",t[t.RGBA16UI=42]="RGBA16UI",t[t.RGBA16I=43]="RGBA16I",t[t.RGBA32F=44]="RGBA32F",t[t.RGBA32UI=45]="RGBA32UI",t[t.RGBA32I=46]="RGBA32I",t[t.R5G6B5=47]="R5G6B5",t[t.R11G11B10F=48]="R11G11B10F",t[t.RGB5A1=49]="RGB5A1",t[t.RGBA4=50]="RGBA4",t[t.RGB10A2=51]="RGB10A2",t[t.RGB10A2UI=52]="RGB10A2UI",t[t.RGB9E5=53]="RGB9E5",t[t.DEPTH=54]="DEPTH",t[t.DEPTH_STENCIL=55]="DEPTH_STENCIL",t[t.BC1=56]="BC1",t[t.BC1_ALPHA=57]="BC1_ALPHA",t[t.BC1_SRGB=58]="BC1_SRGB",t[t.BC1_SRGB_ALPHA=59]="BC1_SRGB_ALPHA",t[t.BC2=60]="BC2",t[t.BC2_SRGB=61]="BC2_SRGB",t[t.BC3=62]="BC3",t[t.BC3_SRGB=63]="BC3_SRGB",t[t.BC4=64]="BC4",t[t.BC4_SNORM=65]="BC4_SNORM",t[t.BC5=66]="BC5",t[t.BC5_SNORM=67]="BC5_SNORM",t[t.BC6H_UF16=68]="BC6H_UF16",t[t.BC6H_SF16=69]="BC6H_SF16",t[t.BC7=70]="BC7",t[t.BC7_SRGB=71]="BC7_SRGB",t[t.ETC_RGB8=72]="ETC_RGB8",t[t.ETC2_RGB8=73]="ETC2_RGB8",t[t.ETC2_SRGB8=74]="ETC2_SRGB8",t[t.ETC2_RGB8_A1=75]="ETC2_RGB8_A1",t[t.ETC2_SRGB8_A1=76]="ETC2_SRGB8_A1",t[t.ETC2_RGBA8=77]="ETC2_RGBA8",t[t.ETC2_SRGB8_A8=78]="ETC2_SRGB8_A8",t[t.EAC_R11=79]="EAC_R11",t[t.EAC_R11SN=80]="EAC_R11SN",t[t.EAC_RG11=81]="EAC_RG11",t[t.EAC_RG11SN=82]="EAC_RG11SN",t[t.PVRTC_RGB2=83]="PVRTC_RGB2",t[t.PVRTC_RGBA2=84]="PVRTC_RGBA2",t[t.PVRTC_RGB4=85]="PVRTC_RGB4",t[t.PVRTC_RGBA4=86]="PVRTC_RGBA4",t[t.PVRTC2_2BPP=87]="PVRTC2_2BPP",t[t.PVRTC2_4BPP=88]="PVRTC2_4BPP",t[t.ASTC_RGBA_4X4=89]="ASTC_RGBA_4X4",t[t.ASTC_RGBA_5X4=90]="ASTC_RGBA_5X4",t[t.ASTC_RGBA_5X5=91]="ASTC_RGBA_5X5",t[t.ASTC_RGBA_6X5=92]="ASTC_RGBA_6X5",t[t.ASTC_RGBA_6X6=93]="ASTC_RGBA_6X6",t[t.ASTC_RGBA_8X5=94]="ASTC_RGBA_8X5",t[t.ASTC_RGBA_8X6=95]="ASTC_RGBA_8X6",t[t.ASTC_RGBA_8X8=96]="ASTC_RGBA_8X8",t[t.ASTC_RGBA_10X5=97]="ASTC_RGBA_10X5",t[t.ASTC_RGBA_10X6=98]="ASTC_RGBA_10X6",t[t.ASTC_RGBA_10X8=99]="ASTC_RGBA_10X8",t[t.ASTC_RGBA_10X10=100]="ASTC_RGBA_10X10",t[t.ASTC_RGBA_12X10=101]="ASTC_RGBA_12X10",t[t.ASTC_RGBA_12X12=102]="ASTC_RGBA_12X12",t[t.ASTC_SRGBA_4X4=103]="ASTC_SRGBA_4X4",t[t.ASTC_SRGBA_5X4=104]="ASTC_SRGBA_5X4",t[t.ASTC_SRGBA_5X5=105]="ASTC_SRGBA_5X5",t[t.ASTC_SRGBA_6X5=106]="ASTC_SRGBA_6X5",t[t.ASTC_SRGBA_6X6=107]="ASTC_SRGBA_6X6",t[t.ASTC_SRGBA_8X5=108]="ASTC_SRGBA_8X5",t[t.ASTC_SRGBA_8X6=109]="ASTC_SRGBA_8X6",t[t.ASTC_SRGBA_8X8=110]="ASTC_SRGBA_8X8",t[t.ASTC_SRGBA_10X5=111]="ASTC_SRGBA_10X5",t[t.ASTC_SRGBA_10X6=112]="ASTC_SRGBA_10X6",t[t.ASTC_SRGBA_10X8=113]="ASTC_SRGBA_10X8",t[t.ASTC_SRGBA_10X10=114]="ASTC_SRGBA_10X10",t[t.ASTC_SRGBA_12X10=115]="ASTC_SRGBA_12X10",t[t.ASTC_SRGBA_12X12=116]="ASTC_SRGBA_12X12",t[t.COUNT=117]="COUNT"}(ui||(ui={})),function(t){t[t.NONE=0]="NONE",t[t.UNORM=1]="UNORM",t[t.SNORM=2]="SNORM",t[t.UINT=3]="UINT",t[t.INT=4]="INT",t[t.UFLOAT=5]="UFLOAT",t[t.FLOAT=6]="FLOAT"}(hi||(hi={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.BOOL=1]="BOOL",t[t.BOOL2=2]="BOOL2",t[t.BOOL3=3]="BOOL3",t[t.BOOL4=4]="BOOL4",t[t.INT=5]="INT",t[t.INT2=6]="INT2",t[t.INT3=7]="INT3",t[t.INT4=8]="INT4",t[t.UINT=9]="UINT",t[t.UINT2=10]="UINT2",t[t.UINT3=11]="UINT3",t[t.UINT4=12]="UINT4",t[t.FLOAT=13]="FLOAT",t[t.FLOAT2=14]="FLOAT2",t[t.FLOAT3=15]="FLOAT3",t[t.FLOAT4=16]="FLOAT4",t[t.MAT2=17]="MAT2",t[t.MAT2X3=18]="MAT2X3",t[t.MAT2X4=19]="MAT2X4",t[t.MAT3X2=20]="MAT3X2",t[t.MAT3=21]="MAT3",t[t.MAT3X4=22]="MAT3X4",t[t.MAT4X2=23]="MAT4X2",t[t.MAT4X3=24]="MAT4X3",t[t.MAT4=25]="MAT4",t[t.SAMPLER1D=26]="SAMPLER1D",t[t.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",t[t.SAMPLER2D=28]="SAMPLER2D",t[t.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",t[t.SAMPLER3D=30]="SAMPLER3D",t[t.SAMPLER_CUBE=31]="SAMPLER_CUBE",t[t.SAMPLER=32]="SAMPLER",t[t.TEXTURE1D=33]="TEXTURE1D",t[t.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",t[t.TEXTURE2D=35]="TEXTURE2D",t[t.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",t[t.TEXTURE3D=37]="TEXTURE3D",t[t.TEXTURE_CUBE=38]="TEXTURE_CUBE",t[t.IMAGE1D=39]="IMAGE1D",t[t.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",t[t.IMAGE2D=41]="IMAGE2D",t[t.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",t[t.IMAGE3D=43]="IMAGE3D",t[t.IMAGE_CUBE=44]="IMAGE_CUBE",t[t.SUBPASS_INPUT=45]="SUBPASS_INPUT",t[t.COUNT=46]="COUNT"}(_i||(_i={})),function(t){t[t.NONE=0]="NONE",t[t.TRANSFER_SRC=1]="TRANSFER_SRC",t[t.TRANSFER_DST=2]="TRANSFER_DST",t[t.INDEX=4]="INDEX",t[t.VERTEX=8]="VERTEX",t[t.UNIFORM=16]="UNIFORM",t[t.STORAGE=32]="STORAGE",t[t.INDIRECT=64]="INDIRECT"}(fi||(fi={})),function(t){t[t.NONE=0]="NONE"}(pi||(pi={})),function(t){t[t.NONE=0]="NONE",t[t.READ_ONLY=1]="READ_ONLY",t[t.WRITE_ONLY=2]="WRITE_ONLY",t[t.READ_WRITE=3]="READ_WRITE"}(di||(di={})),function(t){t[t.NONE=0]="NONE",t[t.DEVICE=1]="DEVICE",t[t.HOST=2]="HOST"}(mi||(mi={})),function(t){t[t.TEX1D=0]="TEX1D",t[t.TEX2D=1]="TEX2D",t[t.TEX3D=2]="TEX3D",t[t.CUBE=3]="CUBE",t[t.TEX1D_ARRAY=4]="TEX1D_ARRAY",t[t.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(vi||(vi={})),function(t){t[t.NONE=0]="NONE",t[t.TRANSFER_SRC=1]="TRANSFER_SRC",t[t.TRANSFER_DST=2]="TRANSFER_DST",t[t.SAMPLED=4]="SAMPLED",t[t.STORAGE=8]="STORAGE",t[t.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",t[t.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",t[t.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT"}(gi||(gi={})),function(t){t[t.NONE=0]="NONE",t[t.GEN_MIPMAP=1]="GEN_MIPMAP",t[t.GENERAL_LAYOUT=2]="GENERAL_LAYOUT"}(yi||(yi={})),function(t){t[t.ONE=0]="ONE",t[t.MULTIPLE_PERFORMANCE=1]="MULTIPLE_PERFORMANCE",t[t.MULTIPLE_BALANCE=2]="MULTIPLE_BALANCE",t[t.MULTIPLE_QUALITY=3]="MULTIPLE_QUALITY"}(xi||(xi={})),function(t){t[t.OFF=0]="OFF",t[t.ON=1]="ON",t[t.RELAXED=2]="RELAXED",t[t.MAILBOX=3]="MAILBOX",t[t.HALF=4]="HALF"}(Si||(Si={})),function(t){t[t.NONE=0]="NONE",t[t.POINT=1]="POINT",t[t.LINEAR=2]="LINEAR",t[t.ANISOTROPIC=3]="ANISOTROPIC"}(Ci||(Ci={})),function(t){t[t.WRAP=0]="WRAP",t[t.MIRROR=1]="MIRROR",t[t.CLAMP=2]="CLAMP",t[t.BORDER=3]="BORDER"}(Ai||(Ai={})),function(t){t[t.NEVER=0]="NEVER",t[t.LESS=1]="LESS",t[t.EQUAL=2]="EQUAL",t[t.LESS_EQUAL=3]="LESS_EQUAL",t[t.GREATER=4]="GREATER",t[t.NOT_EQUAL=5]="NOT_EQUAL",t[t.GREATER_EQUAL=6]="GREATER_EQUAL",t[t.ALWAYS=7]="ALWAYS"}(bi||(bi={})),function(t){t[t.ZERO=0]="ZERO",t[t.KEEP=1]="KEEP",t[t.REPLACE=2]="REPLACE",t[t.INCR=3]="INCR",t[t.DECR=4]="DECR",t[t.INVERT=5]="INVERT",t[t.INCR_WRAP=6]="INCR_WRAP",t[t.DECR_WRAP=7]="DECR_WRAP"}(Ti||(Ti={})),function(t){t[t.ZERO=0]="ZERO",t[t.ONE=1]="ONE",t[t.SRC_ALPHA=2]="SRC_ALPHA",t[t.DST_ALPHA=3]="DST_ALPHA",t[t.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",t[t.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",t[t.SRC_COLOR=6]="SRC_COLOR",t[t.DST_COLOR=7]="DST_COLOR",t[t.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",t[t.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",t[t.CONSTANT_COLOR=11]="CONSTANT_COLOR",t[t.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",t[t.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",t[t.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(Ei||(Ei={})),function(t){t[t.ADD=0]="ADD",t[t.SUB=1]="SUB",t[t.REV_SUB=2]="REV_SUB",t[t.MIN=3]="MIN",t[t.MAX=4]="MAX"}(wi||(wi={})),function(t){t[t.NONE=0]="NONE",t[t.R=1]="R",t[t.G=2]="G",t[t.B=4]="B",t[t.A=8]="A",t[t.ALL=15]="ALL"}(Pi||(Pi={})),function(t){t[t.NONE=0]="NONE",t[t.VERTEX=1]="VERTEX",t[t.CONTROL=2]="CONTROL",t[t.EVALUATION=4]="EVALUATION",t[t.GEOMETRY=8]="GEOMETRY",t[t.FRAGMENT=16]="FRAGMENT",t[t.COMPUTE=32]="COMPUTE",t[t.ALL=63]="ALL"}(Ii||(Ii={})),function(t){t[t.LOAD=0]="LOAD",t[t.CLEAR=1]="CLEAR",t[t.DISCARD=2]="DISCARD"}(Ri||(Ri={})),function(t){t[t.STORE=0]="STORE",t[t.DISCARD=1]="DISCARD"}(Di||(Di={})),function(t){t[t.NONE=0]="NONE",t[t.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",t[t.INDEX_BUFFER=2]="INDEX_BUFFER",t[t.VERTEX_BUFFER=3]="VERTEX_BUFFER",t[t.VERTEX_SHADER_READ_UNIFORM_BUFFER=4]="VERTEX_SHADER_READ_UNIFORM_BUFFER",t[t.VERTEX_SHADER_READ_TEXTURE=5]="VERTEX_SHADER_READ_TEXTURE",t[t.VERTEX_SHADER_READ_OTHER=6]="VERTEX_SHADER_READ_OTHER",t[t.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=7]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",t[t.FRAGMENT_SHADER_READ_TEXTURE=8]="FRAGMENT_SHADER_READ_TEXTURE",t[t.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=9]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",t[t.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=10]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",t[t.FRAGMENT_SHADER_READ_OTHER=11]="FRAGMENT_SHADER_READ_OTHER",t[t.COLOR_ATTACHMENT_READ=12]="COLOR_ATTACHMENT_READ",t[t.DEPTH_STENCIL_ATTACHMENT_READ=13]="DEPTH_STENCIL_ATTACHMENT_READ",t[t.COMPUTE_SHADER_READ_UNIFORM_BUFFER=14]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",t[t.COMPUTE_SHADER_READ_TEXTURE=15]="COMPUTE_SHADER_READ_TEXTURE",t[t.COMPUTE_SHADER_READ_OTHER=16]="COMPUTE_SHADER_READ_OTHER",t[t.TRANSFER_READ=17]="TRANSFER_READ",t[t.HOST_READ=18]="HOST_READ",t[t.PRESENT=19]="PRESENT",t[t.VERTEX_SHADER_WRITE=20]="VERTEX_SHADER_WRITE",t[t.FRAGMENT_SHADER_WRITE=21]="FRAGMENT_SHADER_WRITE",t[t.COLOR_ATTACHMENT_WRITE=22]="COLOR_ATTACHMENT_WRITE",t[t.DEPTH_STENCIL_ATTACHMENT_WRITE=23]="DEPTH_STENCIL_ATTACHMENT_WRITE",t[t.COMPUTE_SHADER_WRITE=24]="COMPUTE_SHADER_WRITE",t[t.TRANSFER_WRITE=25]="TRANSFER_WRITE",t[t.HOST_PREINITIALIZED=26]="HOST_PREINITIALIZED",t[t.HOST_WRITE=27]="HOST_WRITE"}(Bi||(Bi={})),function(t){t[t.NONE=0]="NONE",t[t.SAMPLE_ZERO=1]="SAMPLE_ZERO",t[t.AVERAGE=2]="AVERAGE",t[t.MIN=3]="MIN",t[t.MAX=4]="MAX"}(Mi||(Mi={})),function(t){t[t.GRAPHICS=0]="GRAPHICS",t[t.COMPUTE=1]="COMPUTE",t[t.RAY_TRACING=2]="RAY_TRACING"}(Oi||(Oi={})),function(t){t[t.POINT_LIST=0]="POINT_LIST",t[t.LINE_LIST=1]="LINE_LIST",t[t.LINE_STRIP=2]="LINE_STRIP",t[t.LINE_LOOP=3]="LINE_LOOP",t[t.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",t[t.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",t[t.ISO_LINE_LIST=6]="ISO_LINE_LIST",t[t.TRIANGLE_LIST=7]="TRIANGLE_LIST",t[t.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=9]="TRIANGLE_FAN",t[t.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",t[t.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",t[t.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",t[t.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(Ni||(Ni={})),function(t){t[t.FILL=0]="FILL",t[t.POINT=1]="POINT",t[t.LINE=2]="LINE"}(Li||(Li={})),function(t){t[t.GOURAND=0]="GOURAND",t[t.FLAT=1]="FLAT"}(Fi||(Fi={})),function(t){t[t.NONE=0]="NONE",t[t.FRONT=1]="FRONT",t[t.BACK=2]="BACK"}(zi||(zi={})),function(t){t[t.NONE=0]="NONE",t[t.LINE_WIDTH=1]="LINE_WIDTH",t[t.DEPTH_BIAS=2]="DEPTH_BIAS",t[t.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",t[t.DEPTH_BOUNDS=8]="DEPTH_BOUNDS",t[t.STENCIL_WRITE_MASK=16]="STENCIL_WRITE_MASK",t[t.STENCIL_COMPARE_MASK=32]="STENCIL_COMPARE_MASK"}(Gi||(Gi={})),function(t){t[t.FRONT=1]="FRONT",t[t.BACK=2]="BACK",t[t.ALL=3]="ALL"}(Vi||(Vi={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",t[t.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",t[t.STORAGE_BUFFER=4]="STORAGE_BUFFER",t[t.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",t[t.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",t[t.SAMPLER=32]="SAMPLER",t[t.TEXTURE=64]="TEXTURE",t[t.STORAGE_IMAGE=128]="STORAGE_IMAGE",t[t.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT"}(Ui||(Ui={})),function(t){t[t.GRAPHICS=0]="GRAPHICS",t[t.COMPUTE=1]="COMPUTE",t[t.TRANSFER=2]="TRANSFER"}(ki||(ki={})),function(t){t[t.OCCLUSION=0]="OCCLUSION",t[t.PIPELINE_STATISTICS=1]="PIPELINE_STATISTICS",t[t.TIMESTAMP=2]="TIMESTAMP"}(Hi||(Hi={})),function(t){t[t.PRIMARY=0]="PRIMARY",t[t.SECONDARY=1]="SECONDARY"}(ji||(ji={})),function(t){t[t.NONE=0]="NONE",t[t.COLOR=1]="COLOR",t[t.DEPTH=2]="DEPTH",t[t.STENCIL=4]="STENCIL",t[t.DEPTH_STENCIL=6]="DEPTH_STENCIL",t[t.ALL=7]="ALL"}(Wi||(Wi={}));var Xi,Yi=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this.x=t,this.y=e,this.z=n}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},t}(),Ki=function(){function t(t,e,n,i,r,o,a,s,c,l,u,h,_,f,p,d,m,v,g,y,x,S){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=1),void 0===p&&(p=0),void 0===d&&(d=0),void 0===m&&(m=new Yi),void 0===v&&(v=new Yi),void 0===g&&(g=!1),void 0===y&&(y=-1),void 0===x&&(x=1),void 0===S&&(S=1),this.maxVertexAttributes=t,this.maxVertexUniformVectors=e,this.maxFragmentUniformVectors=n,this.maxTextureUnits=i,this.maxImageUnits=r,this.maxVertexTextureUnits=o,this.maxColorRenderTargets=a,this.maxShaderStorageBufferBindings=s,this.maxShaderStorageBlockSize=c,this.maxUniformBufferBindings=l,this.maxUniformBlockSize=u,this.maxTextureSize=h,this.maxCubeMapTextureSize=_,this.uboOffsetAlignment=f,this.maxComputeSharedMemorySize=p,this.maxComputeWorkGroupInvocations=d,this.maxComputeWorkGroupSize=m,this.maxComputeWorkGroupCount=v,this.supportQuery=g,this.clipSpaceMinZ=y,this.screenSpaceSignY=x,this.clipSpaceSignY=S}return t.prototype.copy=function(t){return this.maxVertexAttributes=t.maxVertexAttributes,this.maxVertexUniformVectors=t.maxVertexUniformVectors,this.maxFragmentUniformVectors=t.maxFragmentUniformVectors,this.maxTextureUnits=t.maxTextureUnits,this.maxImageUnits=t.maxImageUnits,this.maxVertexTextureUnits=t.maxVertexTextureUnits,this.maxColorRenderTargets=t.maxColorRenderTargets,this.maxShaderStorageBufferBindings=t.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=t.maxShaderStorageBlockSize,this.maxUniformBufferBindings=t.maxUniformBufferBindings,this.maxUniformBlockSize=t.maxUniformBlockSize,this.maxTextureSize=t.maxTextureSize,this.maxCubeMapTextureSize=t.maxCubeMapTextureSize,this.uboOffsetAlignment=t.uboOffsetAlignment,this.maxComputeSharedMemorySize=t.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=t.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(t.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(t.maxComputeWorkGroupCount),this.supportQuery=t.supportQuery,this.clipSpaceMinZ=t.clipSpaceMinZ,this.screenSpaceSignY=t.screenSpaceSignY,this.clipSpaceSignY=t.clipSpaceSignY,this},t}(),Ji=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this.x=t,this.y=e,this.z=n}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},t}(),Qi=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=t,this.y=e,this.width=n,this.height=i}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this},t}(),Zi=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=1),this.width=t,this.height=e,this.depth=n}return t.prototype.copy=function(t){return this.width=t.width,this.height=t.height,this.depth=t.depth,this},t}(),$i=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=1),this.mipLevel=t,this.baseArrayLayer=e,this.layerCount=n}return t.prototype.copy=function(t){return this.mipLevel=t.mipLevel,this.baseArrayLayer=t.baseArrayLayer,this.layerCount=t.layerCount,this},t}(),tr=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=1),void 0===n&&(n=0),void 0===i&&(i=1),this.baseMipLevel=t,this.levelCount=e,this.baseArrayLayer=n,this.layerCount=i}return t.prototype.copy=function(t){return this.baseMipLevel=t.baseMipLevel,this.levelCount=t.levelCount,this.baseArrayLayer=t.baseArrayLayer,this.layerCount=t.layerCount,this},t}(),er=function(){function t(t,e,n,i,r){void 0===t&&(t=new $i),void 0===e&&(e=new Ji),void 0===n&&(n=new $i),void 0===i&&(i=new Ji),void 0===r&&(r=new Zi),this.srcSubres=t,this.srcOffset=e,this.dstSubres=n,this.dstOffset=i,this.extent=r}return t.prototype.copy=function(t){return this.srcSubres.copy(t.srcSubres),this.srcOffset.copy(t.srcOffset),this.dstSubres.copy(t.dstSubres),this.dstOffset.copy(t.dstOffset),this.extent.copy(t.extent),this},t}(),nr=function(){function t(t,e,n,i,r,o){void 0===t&&(t=new $i),void 0===e&&(e=new Ji),void 0===n&&(n=new Zi),void 0===i&&(i=new $i),void 0===r&&(r=new Ji),void 0===o&&(o=new Zi),this.srcSubres=t,this.srcOffset=e,this.srcExtent=n,this.dstSubres=i,this.dstOffset=r,this.dstExtent=o}return t.prototype.copy=function(t){return this.srcSubres.copy(t.srcSubres),this.srcOffset.copy(t.srcOffset),this.srcExtent.copy(t.srcExtent),this.dstSubres.copy(t.dstSubres),this.dstOffset.copy(t.dstOffset),this.dstExtent.copy(t.dstExtent),this},t}(),ir=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=new Ji),void 0===i&&(i=new Zi),void 0===r&&(r=new $i),this.buffStride=t,this.buffTexHeight=e,this.texOffset=n,this.texExtent=i,this.texSubres=r}return t.prototype.copy=function(t){return this.buffStride=t.buffStride,this.buffTexHeight=t.buffTexHeight,this.texOffset.copy(t.texOffset),this.texExtent.copy(t.texExtent),this.texSubres.copy(t.texSubres),this},t}(),rr=function(){function t(t,e,n,i,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),this.left=t,this.top=e,this.width=n,this.height=i,this.minDepth=r,this.maxDepth=o}return t.prototype.copy=function(t){return this.left=t.left,this.top=t.top,this.width=t.width,this.height=t.height,this.minDepth=t.minDepth,this.maxDepth=t.maxDepth,this},t}(),or=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=n,this.w=i}return t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},t}(),ar=function(){function t(t,e,n){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===n&&(n=0),this.bufferOffsets=t,this.samplerOffsets=e,this.flexibleSet=n}return t.prototype.copy=function(t){return this.bufferOffsets=t.bufferOffsets.slice(),this.samplerOffsets=t.samplerOffsets.slice(),this.flexibleSet=t.flexibleSet,this},t}(),sr=function(){function t(t,e,n,i){void 0===t&&(t=null),void 0===e&&(e=Si.ON),void 0===n&&(n=0),void 0===i&&(i=0),this.windowHandle=t,this.vsyncMode=e,this.width=n,this.height=i}return t.prototype.copy=function(t){return this.windowHandle=t.windowHandle,this.vsyncMode=t.vsyncMode,this.width=t.width,this.height=t.height,this},t}(),cr=function(){function t(t){void 0===t&&(t=new ar),this.bindingMappingInfo=t}return t.prototype.copy=function(t){return this.bindingMappingInfo.copy(t.bindingMappingInfo),this},t}(),lr=function(){function t(t,e,n,i,r){void 0===t&&(t=fi.NONE),void 0===e&&(e=mi.NONE),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=pi.NONE),this.usage=t,this.memUsage=e,this.size=n,this.stride=i,this.flags=r}return t.prototype.copy=function(t){return this.usage=t.usage,this.memUsage=t.memUsage,this.size=t.size,this.stride=t.stride,this.flags=t.flags,this},t}(),ur=function(){function t(t,e,n){void 0===t&&(t=null),void 0===e&&(e=0),void 0===n&&(n=0),this.buffer=t,this.offset=e,this.range=n}return t.prototype.copy=function(t){return this.buffer=t.buffer,this.offset=t.offset,this.range=t.range,this},t}(),hr=function(){function t(t,e,n,i,r,o,a){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),this.vertexCount=t,this.firstVertex=e,this.indexCount=n,this.firstIndex=i,this.vertexOffset=r,this.instanceCount=o,this.firstInstance=a}return t.prototype.copy=function(t){return this.vertexCount=t.vertexCount,this.firstVertex=t.firstVertex,this.indexCount=t.indexCount,this.firstIndex=t.firstIndex,this.vertexOffset=t.vertexOffset,this.instanceCount=t.instanceCount,this.firstInstance=t.firstInstance,this},t}(),_r=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=null),void 0===r&&(r=0),this.groupCountX=t,this.groupCountY=e,this.groupCountZ=n,this.indirectBuffer=i,this.indirectOffset=r}return t.prototype.copy=function(t){return this.groupCountX=t.groupCountX,this.groupCountY=t.groupCountY,this.groupCountZ=t.groupCountZ,this.indirectBuffer=t.indirectBuffer,this.indirectOffset=t.indirectOffset,this},t}(),fr=function(){function t(t){void 0===t&&(t=[]),this.drawInfos=t}return t.prototype.copy=function(t){return qi(this.drawInfos,t.drawInfos,hr),this},t}(),pr=function(){function t(t,e,n,i,r,o,a,s,c,l,u){void 0===t&&(t=vi.TEX2D),void 0===e&&(e=gi.NONE),void 0===n&&(n=ui.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=yi.NONE),void 0===a&&(a=1),void 0===s&&(s=1),void 0===c&&(c=xi.ONE),void 0===l&&(l=1),void 0===u&&(u=0),this.type=t,this.usage=e,this.format=n,this.width=i,this.height=r,this.flags=o,this.layerCount=a,this.levelCount=s,this.samples=c,this.depth=l,this.externalRes=u}return t.prototype.copy=function(t){return this.type=t.type,this.usage=t.usage,this.format=t.format,this.width=t.width,this.height=t.height,this.flags=t.flags,this.layerCount=t.layerCount,this.levelCount=t.levelCount,this.samples=t.samples,this.depth=t.depth,this.externalRes=t.externalRes,this},t}(),dr=function(){function t(t,e,n,i,r,o,a){void 0===t&&(t=null),void 0===e&&(e=vi.TEX2D),void 0===n&&(n=ui.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=1),this.texture=t,this.type=e,this.format=n,this.baseLevel=i,this.levelCount=r,this.baseLayer=o,this.layerCount=a}return t.prototype.copy=function(t){return this.texture=t.texture,this.type=t.type,this.format=t.format,this.baseLevel=t.baseLevel,this.levelCount=t.levelCount,this.baseLayer=t.baseLayer,this.layerCount=t.layerCount,this},t}(),mr=function(){function t(t,e,n,i,r,o,a,s){void 0===t&&(t=Ci.LINEAR),void 0===e&&(e=Ci.LINEAR),void 0===n&&(n=Ci.NONE),void 0===i&&(i=Ai.WRAP),void 0===r&&(r=Ai.WRAP),void 0===o&&(o=Ai.WRAP),void 0===a&&(a=0),void 0===s&&(s=bi.ALWAYS),this.minFilter=t,this.magFilter=e,this.mipFilter=n,this.addressU=i,this.addressV=r,this.addressW=o,this.maxAnisotropy=a,this.cmpFunc=s}return t.prototype.copy=function(t){return this.minFilter=t.minFilter,this.magFilter=t.magFilter,this.mipFilter=t.mipFilter,this.addressU=t.addressU,this.addressV=t.addressV,this.addressW=t.addressW,this.maxAnisotropy=t.maxAnisotropy,this.cmpFunc=t.cmpFunc,this},t}(),vr=function(){function t(t,e,n){void 0===t&&(t=""),void 0===e&&(e=_i.UNKNOWN),void 0===n&&(n=0),this.name=t,this.type=e,this.count=n}return t.prototype.copy=function(t){return this.name=t.name,this.type=t.type,this.count=t.count,this},t}(),gr=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=[]),void 0===r&&(r=0),this.set=t,this.binding=e,this.name=n,this.members=i,this.count=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,qi(this.members,t.members,vr),this.count=t.count,this},t}(),yr=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=_i.UNKNOWN),void 0===r&&(r=0),this.set=t,this.binding=e,this.name=n,this.type=i,this.count=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this},t}(),xr=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=t,this.binding=e,this.name=n,this.count=i}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this},t}(),Sr=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=_i.UNKNOWN),void 0===r&&(r=0),this.set=t,this.binding=e,this.name=n,this.type=i,this.count=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this},t}(),Cr=function(){function t(t,e,n,i,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=_i.UNKNOWN),void 0===r&&(r=0),void 0===o&&(o=di.READ_WRITE),this.set=t,this.binding=e,this.name=n,this.type=i,this.count=r,this.memoryAccess=o}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this.memoryAccess=t.memoryAccess,this},t}(),Ar=function(){function t(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=0),void 0===r&&(r=di.READ_WRITE),this.set=t,this.binding=e,this.name=n,this.count=i,this.memoryAccess=r}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this.memoryAccess=t.memoryAccess,this},t}(),br=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=t,this.binding=e,this.name=n,this.count=i}return t.prototype.copy=function(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this},t}(),Tr=function(){function t(t,e){void 0===t&&(t=Ii.NONE),void 0===e&&(e=""),this.stage=t,this.source=e}return t.prototype.copy=function(t){return this.stage=t.stage,this.source=t.source,this},t}(),Er=function(){function t(t,e,n,i,r,o){void 0===t&&(t=""),void 0===e&&(e=ui.UNKNOWN),void 0===n&&(n=!1),void 0===i&&(i=0),void 0===r&&(r=!1),void 0===o&&(o=0),this.name=t,this.format=e,this.isNormalized=n,this.stream=i,this.isInstanced=r,this.location=o}return t.prototype.copy=function(t){return this.name=t.name,this.format=t.format,this.isNormalized=t.isNormalized,this.stream=t.stream,this.isInstanced=t.isInstanced,this.location=t.location,this},t}(),wr=function(){function t(t,e,n,i,r,o,a,s,c,l){void 0===t&&(t=""),void 0===e&&(e=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=[]),void 0===o&&(o=[]),void 0===a&&(a=[]),void 0===s&&(s=[]),void 0===c&&(c=[]),void 0===l&&(l=[]),this.name=t,this.stages=e,this.attributes=n,this.blocks=i,this.buffers=r,this.samplerTextures=o,this.samplers=a,this.textures=s,this.images=c,this.subpassInputs=l}return t.prototype.copy=function(t){return this.name=t.name,qi(this.stages,t.stages,Tr),qi(this.attributes,t.attributes,Er),qi(this.blocks,t.blocks,gr),qi(this.buffers,t.buffers,Ar),qi(this.samplerTextures,t.samplerTextures,yr),qi(this.samplers,t.samplers,xr),qi(this.textures,t.textures,Sr),qi(this.images,t.images,Cr),qi(this.subpassInputs,t.subpassInputs,br),this},t}(),Pr=function(){function t(t,e,n,i){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===n&&(n=null),void 0===i&&(i=null),this.attributes=t,this.vertexBuffers=e,this.indexBuffer=n,this.indirectBuffer=i}return t.prototype.copy=function(t){return qi(this.attributes,t.attributes,Er),this.vertexBuffers=t.vertexBuffers.slice(),this.indexBuffer=t.indexBuffer,this.indirectBuffer=t.indirectBuffer,this},t}(),Ir=function(){function t(t,e,n,i,r,o,a){void 0===t&&(t=ui.UNKNOWN),void 0===e&&(e=xi.ONE),void 0===n&&(n=Ri.CLEAR),void 0===i&&(i=Di.STORE),void 0===r&&(r=[]),void 0===o&&(o=[Bi.COLOR_ATTACHMENT_WRITE]),void 0===a&&(a=!1),this.format=t,this.sampleCount=e,this.loadOp=n,this.storeOp=i,this.beginAccesses=r,this.endAccesses=o,this.isGeneralLayout=a}return t.prototype.copy=function(t){return this.format=t.format,this.sampleCount=t.sampleCount,this.loadOp=t.loadOp,this.storeOp=t.storeOp,this.beginAccesses=t.beginAccesses.slice(),this.endAccesses=t.endAccesses.slice(),this.isGeneralLayout=t.isGeneralLayout,this},t}(),Rr=function(){function t(t,e,n,i,r,o,a,s,c){void 0===t&&(t=ui.UNKNOWN),void 0===e&&(e=xi.ONE),void 0===n&&(n=Ri.CLEAR),void 0===i&&(i=Di.STORE),void 0===r&&(r=Ri.CLEAR),void 0===o&&(o=Di.STORE),void 0===a&&(a=[]),void 0===s&&(s=[Bi.DEPTH_STENCIL_ATTACHMENT_WRITE]),void 0===c&&(c=!1),this.format=t,this.sampleCount=e,this.depthLoadOp=n,this.depthStoreOp=i,this.stencilLoadOp=r,this.stencilStoreOp=o,this.beginAccesses=a,this.endAccesses=s,this.isGeneralLayout=c}return t.prototype.copy=function(t){return this.format=t.format,this.sampleCount=t.sampleCount,this.depthLoadOp=t.depthLoadOp,this.depthStoreOp=t.depthStoreOp,this.stencilLoadOp=t.stencilLoadOp,this.stencilStoreOp=t.stencilStoreOp,this.beginAccesses=t.beginAccesses.slice(),this.endAccesses=t.endAccesses.slice(),this.isGeneralLayout=t.isGeneralLayout,this},t}(),Dr=function(){function t(t,e,n,i,r,o,a,s){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=-1),void 0===o&&(o=-1),void 0===a&&(a=Mi.NONE),void 0===s&&(s=Mi.NONE),this.inputs=t,this.colors=e,this.resolves=n,this.preserves=i,this.depthStencil=r,this.depthStencilResolve=o,this.depthResolveMode=a,this.stencilResolveMode=s}return t.prototype.copy=function(t){return this.inputs=t.inputs.slice(),this.colors=t.colors.slice(),this.resolves=t.resolves.slice(),this.preserves=t.preserves.slice(),this.depthStencil=t.depthStencil,this.depthStencilResolve=t.depthStencilResolve,this.depthResolveMode=t.depthResolveMode,this.stencilResolveMode=t.stencilResolveMode,this},t}(),Br=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=[]),void 0===i&&(i=[]),this.srcSubpass=t,this.dstSubpass=e,this.srcAccesses=n,this.dstAccesses=i}return t.prototype.copy=function(t){return this.srcSubpass=t.srcSubpass,this.dstSubpass=t.dstSubpass,this.srcAccesses=t.srcAccesses.slice(),this.dstAccesses=t.dstAccesses.slice(),this},t}(),Mr=function(){function t(t,e,n,i){void 0===t&&(t=[]),void 0===e&&(e=new Rr),void 0===n&&(n=[]),void 0===i&&(i=[]),this.colorAttachments=t,this.depthStencilAttachment=e,this.subpasses=n,this.dependencies=i}return t.prototype.copy=function(t){return qi(this.colorAttachments,t.colorAttachments,Ir),this.depthStencilAttachment.copy(t.depthStencilAttachment),qi(this.subpasses,t.subpasses,Dr),qi(this.dependencies,t.dependencies,Br),this},t}(),Or=function(){function t(t,e){void 0===t&&(t=[]),void 0===e&&(e=[]),this.prevAccesses=t,this.nextAccesses=e}return t.prototype.copy=function(t){return this.prevAccesses=t.prevAccesses.slice(),this.nextAccesses=t.nextAccesses.slice(),this},t}(),Nr=function(){function t(t,e,n,i,r){void 0===t&&(t=[]),void 0===e&&(e=[]),void 0===n&&(n=!1),void 0===i&&(i=null),void 0===r&&(r=null),this.prevAccesses=t,this.nextAccesses=e,this.discardContents=n,this.srcQueue=i,this.dstQueue=r}return t.prototype.copy=function(t){return this.prevAccesses=t.prevAccesses.slice(),this.nextAccesses=t.nextAccesses.slice(),this.discardContents=t.discardContents,this.srcQueue=t.srcQueue,this.dstQueue=t.dstQueue,this},t}(),Lr=function(){function t(t,e,n){void 0===t&&(t=null),void 0===e&&(e=[]),void 0===n&&(n=null),this.renderPass=t,this.colorTextures=e,this.depthStencilTexture=n}return t.prototype.copy=function(t){return this.renderPass=t.renderPass,this.colorTextures=t.colorTextures.slice(),this.depthStencilTexture=t.depthStencilTexture,this},t}(),Fr=function(){function t(t,e,n,i,r){void 0===t&&(t=-1),void 0===e&&(e=Ui.UNKNOWN),void 0===n&&(n=0),void 0===i&&(i=Ii.NONE),void 0===r&&(r=[]),this.binding=t,this.descriptorType=e,this.count=n,this.stageFlags=i,this.immutableSamplers=r}return t.prototype.copy=function(t){return this.binding=t.binding,this.descriptorType=t.descriptorType,this.count=t.count,this.stageFlags=t.stageFlags,this.immutableSamplers=t.immutableSamplers.slice(),this},t}(),zr=function(){function t(t){void 0===t&&(t=[]),this.bindings=t}return t.prototype.copy=function(t){return qi(this.bindings,t.bindings,Fr),this},t}(),Gr=function(){function t(t){void 0===t&&(t=null),this.layout=t}return t.prototype.copy=function(t){return this.layout=t.layout,this},t}(),Vr=function(){function t(t){void 0===t&&(t=[]),this.setLayouts=t}return t.prototype.copy=function(t){return this.setLayouts=t.setLayouts.slice(),this},t}(),Ur=function(){function t(t){void 0===t&&(t=[]),this.attributes=t}return t.prototype.copy=function(t){return qi(this.attributes,t.attributes,Er),this},t}(),kr=function(){function t(t,e){void 0===t&&(t=null),void 0===e&&(e=ji.PRIMARY),this.queue=t,this.type=e}return t.prototype.copy=function(t){return this.queue=t.queue,this.type=t.type,this},t}(),Hr=function(){function t(t){void 0===t&&(t=ki.GRAPHICS),this.type=t}return t.prototype.copy=function(t){return this.type=t.type,this},t}(),jr=function(){function t(t,e,n){void 0===t&&(t=Hi.OCCLUSION),void 0===e&&(e=65536),void 0===n&&(n=!0),this.type=t,this.maxQueryObjects=e,this.forceWait=n}return t.prototype.copy=function(t){return this.type=t.type,this.maxQueryObjects=t.maxQueryObjects,this.forceWait=t.forceWait,this},t}(),Wr=function(t,e,n,i,r,o,a,s){void 0===t&&(t=""),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=hi.NONE),void 0===r&&(r=!1),void 0===o&&(o=!1),void 0===a&&(a=!1),void 0===s&&(s=!1),this.name=t,this.size=e,this.count=n,this.type=i,this.hasAlpha=r,this.hasDepth=o,this.hasStencil=a,this.isCompressed=s},qr=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.bufferSize=t,this.textureSize=e}return t.prototype.copy=function(t){return this.bufferSize=t.bufferSize,this.textureSize=t.textureSize,this},t}(),Xr=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this.writeMask=t,this.compareMask=e,this.reference=n}return t.prototype.copy=function(t){return this.writeMask=t.writeMask,this.compareMask=t.compareMask,this.reference=t.reference,this},t}(),Yr=function(){function t(t,e,n,i,r,o,a,s,c,l,u){void 0===t&&(t=new rr),void 0===e&&(e=new Qi),void 0===n&&(n=new or),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=new Xr),void 0===u&&(u=new Xr),this.viewport=t,this.scissor=e,this.blendConstant=n,this.lineWidth=i,this.depthBiasConstant=r,this.depthBiasClamp=o,this.depthBiasSlope=a,this.depthMinBounds=s,this.depthMaxBounds=c,this.stencilStatesFront=l,this.stencilStatesBack=u}return t.prototype.copy=function(t){return this.viewport.copy(t.viewport),this.scissor.copy(t.scissor),this.blendConstant.copy(t.blendConstant),this.lineWidth=t.lineWidth,this.depthBiasConstant=t.depthBiasConstant,this.depthBiasClamp=t.depthBiasClamp,this.depthBiasSlope=t.depthBiasSlope,this.depthMinBounds=t.depthMinBounds,this.depthMaxBounds=t.depthMaxBounds,this.stencilStatesFront.copy(t.stencilStatesFront),this.stencilStatesBack.copy(t.stencilStatesBack),this},t}(),Kr=function(){function t(e){this._objectType=oi.UNKNOWN,this._objectID=0,this._typedID=0,this._objectType=e,this._objectID=t._idTable[oi.UNKNOWN]++,this._typedID=t._idTable[e]++}return K(t,[{key:"objectType",get:function(){return this._objectType}},{key:"objectID",get:function(){return this._objectID}},{key:"typedID",get:function(){return this._typedID}}]),t}();Kr._idTable=Array(oi.COUNT).fill(65536),function(t){t.ATTR_POSITION="a_position",t.ATTR_NORMAL="a_normal",t.ATTR_TANGENT="a_tangent",t.ATTR_BITANGENT="a_bitangent",t.ATTR_WEIGHTS="a_weights",t.ATTR_JOINTS="a_joints",t.ATTR_COLOR="a_color",t.ATTR_COLOR1="a_color1",t.ATTR_COLOR2="a_color2",t.ATTR_TEX_COORD="a_texCoord",t.ATTR_TEX_COORD1="a_texCoord1",t.ATTR_TEX_COORD2="a_texCoord2",t.ATTR_TEX_COORD3="a_texCoord3",t.ATTR_TEX_COORD4="a_texCoord4",t.ATTR_TEX_COORD5="a_texCoord5",t.ATTR_TEX_COORD6="a_texCoord6",t.ATTR_TEX_COORD7="a_texCoord7",t.ATTR_TEX_COORD8="a_texCoord8",t.ATTR_BATCH_ID="a_batch_id",t.ATTR_BATCH_UV="a_batch_uv"}(Xi||(Xi={}));var Jr=Object.freeze([new Wr("UNKNOWN",0,0,hi.NONE,!1,!1,!1,!1),new Wr("A8",1,1,hi.UNORM,!0,!1,!1,!1),new Wr("L8",1,1,hi.UNORM,!1,!1,!1,!1),new Wr("LA8",1,2,hi.UNORM,!0,!1,!1,!1),new Wr("R8",1,1,hi.UNORM,!1,!1,!1,!1),new Wr("R8SN",1,1,hi.SNORM,!1,!1,!1,!1),new Wr("R8UI",1,1,hi.UINT,!1,!1,!1,!1),new Wr("R8I",1,1,hi.INT,!1,!1,!1,!1),new Wr("R16F",2,1,hi.FLOAT,!1,!1,!1,!1),new Wr("R16UI",2,1,hi.UINT,!1,!1,!1,!1),new Wr("R16I",2,1,hi.INT,!1,!1,!1,!1),new Wr("R32F",4,1,hi.FLOAT,!1,!1,!1,!1),new Wr("R32UI",4,1,hi.UINT,!1,!1,!1,!1),new Wr("R32I",4,1,hi.INT,!1,!1,!1,!1),new Wr("RG8",2,2,hi.UNORM,!1,!1,!1,!1),new Wr("RG8SN",2,2,hi.SNORM,!1,!1,!1,!1),new Wr("RG8UI",2,2,hi.UINT,!1,!1,!1,!1),new Wr("RG8I",2,2,hi.INT,!1,!1,!1,!1),new Wr("RG16F",4,2,hi.FLOAT,!1,!1,!1,!1),new Wr("RG16UI",4,2,hi.UINT,!1,!1,!1,!1),new Wr("RG16I",4,2,hi.INT,!1,!1,!1,!1),new Wr("RG32F",8,2,hi.FLOAT,!1,!1,!1,!1),new Wr("RG32UI",8,2,hi.UINT,!1,!1,!1,!1),new Wr("RG32I",8,2,hi.INT,!1,!1,!1,!1),new Wr("RGB8",3,3,hi.UNORM,!1,!1,!1,!1),new Wr("SRGB8",3,3,hi.UNORM,!1,!1,!1,!1),new Wr("RGB8SN",3,3,hi.SNORM,!1,!1,!1,!1),new Wr("RGB8UI",3,3,hi.UINT,!1,!1,!1,!1),new Wr("RGB8I",3,3,hi.INT,!1,!1,!1,!1),new Wr("RGB16F",6,3,hi.FLOAT,!1,!1,!1,!1),new Wr("RGB16UI",6,3,hi.UINT,!1,!1,!1,!1),new Wr("RGB16I",6,3,hi.INT,!1,!1,!1,!1),new Wr("RGB32F",12,3,hi.FLOAT,!1,!1,!1,!1),new Wr("RGB32UI",12,3,hi.UINT,!1,!1,!1,!1),new Wr("RGB32I",12,3,hi.INT,!1,!1,!1,!1),new Wr("RGBA8",4,4,hi.UNORM,!0,!1,!1,!1),new Wr("BGRA8",4,4,hi.UNORM,!0,!1,!1,!1),new Wr("SRGB8_A8",4,4,hi.UNORM,!0,!1,!1,!1),new Wr("RGBA8SN",4,4,hi.SNORM,!0,!1,!1,!1),new Wr("RGBA8UI",4,4,hi.UINT,!0,!1,!1,!1),new Wr("RGBA8I",4,4,hi.INT,!0,!1,!1,!1),new Wr("RGBA16F",8,4,hi.FLOAT,!0,!1,!1,!1),new Wr("RGBA16UI",8,4,hi.UINT,!0,!1,!1,!1),new Wr("RGBA16I",8,4,hi.INT,!0,!1,!1,!1),new Wr("RGBA32F",16,4,hi.FLOAT,!0,!1,!1,!1),new Wr("RGBA32UI",16,4,hi.UINT,!0,!1,!1,!1),new Wr("RGBA32I",16,4,hi.INT,!0,!1,!1,!1),new Wr("R5G6B5",2,3,hi.UNORM,!1,!1,!1,!1),new Wr("R11G11B10F",4,3,hi.FLOAT,!1,!1,!1,!1),new Wr("RGB5A1",2,4,hi.UNORM,!0,!1,!1,!1),new Wr("RGBA4",2,4,hi.UNORM,!0,!1,!1,!1),new Wr("RGB10A2",2,4,hi.UNORM,!0,!1,!1,!1),new Wr("RGB10A2UI",2,4,hi.UINT,!0,!1,!1,!1),new Wr("RGB9E5",2,4,hi.FLOAT,!0,!1,!1,!1),new Wr("DEPTH",4,1,hi.FLOAT,!1,!0,!1,!1),new Wr("DEPTH_STENCIL",5,2,hi.FLOAT,!1,!0,!0,!1),new Wr("BC1",1,3,hi.UNORM,!1,!1,!1,!0),new Wr("BC1_ALPHA",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("BC1_SRGB",1,3,hi.UNORM,!1,!1,!1,!0),new Wr("BC1_SRGB_ALPHA",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("BC2",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("BC2_SRGB",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("BC3",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("BC3_SRGB",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("BC4",1,1,hi.UNORM,!1,!1,!1,!0),new Wr("BC4_SNORM",1,1,hi.SNORM,!1,!1,!1,!0),new Wr("BC5",1,2,hi.UNORM,!1,!1,!1,!0),new Wr("BC5_SNORM",1,2,hi.SNORM,!1,!1,!1,!0),new Wr("BC6H_UF16",1,3,hi.UFLOAT,!1,!1,!1,!0),new Wr("BC6H_SF16",1,3,hi.FLOAT,!1,!1,!1,!0),new Wr("BC7",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("BC7_SRGB",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ETC_RGB8",1,3,hi.UNORM,!1,!1,!1,!0),new Wr("ETC2_RGB8",1,3,hi.UNORM,!1,!1,!1,!0),new Wr("ETC2_SRGB8",1,3,hi.UNORM,!1,!1,!1,!0),new Wr("ETC2_RGB8_A1",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ETC2_SRGB8_A1",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ETC2_RGBA8",2,4,hi.UNORM,!0,!1,!1,!0),new Wr("ETC2_SRGB8_A8",2,4,hi.UNORM,!0,!1,!1,!0),new Wr("EAC_R11",1,1,hi.UNORM,!1,!1,!1,!0),new Wr("EAC_R11SN",1,1,hi.SNORM,!1,!1,!1,!0),new Wr("EAC_RG11",2,2,hi.UNORM,!1,!1,!1,!0),new Wr("EAC_RG11SN",2,2,hi.SNORM,!1,!1,!1,!0),new Wr("PVRTC_RGB2",2,3,hi.UNORM,!1,!1,!1,!0),new Wr("PVRTC_RGBA2",2,4,hi.UNORM,!0,!1,!1,!0),new Wr("PVRTC_RGB4",2,3,hi.UNORM,!1,!1,!1,!0),new Wr("PVRTC_RGBA4",2,4,hi.UNORM,!0,!1,!1,!0),new Wr("PVRTC2_2BPP",2,4,hi.UNORM,!0,!1,!1,!0),new Wr("PVRTC2_4BPP",2,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_4x4",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_5x4",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_5x5",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_6x5",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_6x6",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_8x5",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_8x6",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_8x8",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_10x5",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_10x6",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_10x8",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_10x10",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_12x10",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_RGBA_12x12",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_4x4",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_5x4",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_5x5",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_6x5",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_6x6",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_8x5",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_8x6",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_8x8",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_10x5",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_10x6",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_10x8",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_10x10",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_12x10",1,4,hi.UNORM,!0,!1,!1,!0),new Wr("ASTC_SRGBA_12x12",1,4,hi.UNORM,!0,!1,!1,!0)]),Qr=Ui.UNIFORM_BUFFER|Ui.DYNAMIC_UNIFORM_BUFFER|Ui.STORAGE_BUFFER|Ui.DYNAMIC_STORAGE_BUFFER,Zr=Ui.SAMPLER_TEXTURE|Ui.SAMPLER|Ui.TEXTURE|Ui.STORAGE_IMAGE|Ui.INPUT_ATTACHMENT,$r=Ui.DYNAMIC_STORAGE_BUFFER|Ui.DYNAMIC_UNIFORM_BUFFER;function to(t){return t>0&&0==(t&t-1)}function eo(t,e,n,i){if(!Jr[t].isCompressed)return e*n*i*Jr[t].size;switch(t){case ui.BC1:case ui.BC1_ALPHA:case ui.BC1_SRGB:case ui.BC1_SRGB_ALPHA:return Math.ceil(e/4)*Math.ceil(n/4)*8*i;case ui.BC2:case ui.BC2_SRGB:case ui.BC3:case ui.BC3_SRGB:case ui.BC4:case ui.BC4_SNORM:case ui.BC6H_SF16:case ui.BC6H_UF16:case ui.BC7:case ui.BC7_SRGB:return Math.ceil(e/4)*Math.ceil(n/4)*16*i;case ui.BC5:case ui.BC5_SNORM:return Math.ceil(e/4)*Math.ceil(n/4)*32*i;case ui.ETC_RGB8:case ui.ETC2_RGB8:case ui.ETC2_SRGB8:case ui.ETC2_RGB8_A1:case ui.EAC_R11:case ui.EAC_R11SN:return Math.ceil(e/4)*Math.ceil(n/4)*8*i;case ui.ETC2_RGBA8:case ui.ETC2_SRGB8_A1:case ui.EAC_RG11:case ui.EAC_RG11SN:return Math.ceil(e/4)*Math.ceil(n/4)*16*i;case ui.PVRTC_RGB2:case ui.PVRTC_RGBA2:case ui.PVRTC2_2BPP:return Math.ceil(Math.max(e,16)*Math.max(n,8)/4)*i;case ui.PVRTC_RGB4:case ui.PVRTC_RGBA4:case ui.PVRTC2_4BPP:return Math.ceil(Math.max(e,8)*Math.max(n,8)/2)*i;case ui.ASTC_RGBA_4X4:case ui.ASTC_SRGBA_4X4:return Math.ceil(e/4)*Math.ceil(n/4)*16*i;case ui.ASTC_RGBA_5X4:case ui.ASTC_SRGBA_5X4:return Math.ceil(e/5)*Math.ceil(n/4)*16*i;case ui.ASTC_RGBA_5X5:case ui.ASTC_SRGBA_5X5:return Math.ceil(e/5)*Math.ceil(n/5)*16*i;case ui.ASTC_RGBA_6X5:case ui.ASTC_SRGBA_6X5:return Math.ceil(e/6)*Math.ceil(n/5)*16*i;case ui.ASTC_RGBA_6X6:case ui.ASTC_SRGBA_6X6:return Math.ceil(e/6)*Math.ceil(n/6)*16*i;case ui.ASTC_RGBA_8X5:case ui.ASTC_SRGBA_8X5:return Math.ceil(e/8)*Math.ceil(n/5)*16*i;case ui.ASTC_RGBA_8X6:case ui.ASTC_SRGBA_8X6:return Math.ceil(e/8)*Math.ceil(n/6)*16*i;case ui.ASTC_RGBA_8X8:case ui.ASTC_SRGBA_8X8:return Math.ceil(e/8)*Math.ceil(n/8)*16*i;case ui.ASTC_RGBA_10X5:case ui.ASTC_SRGBA_10X5:return Math.ceil(e/10)*Math.ceil(n/5)*16*i;case ui.ASTC_RGBA_10X6:case ui.ASTC_SRGBA_10X6:return Math.ceil(e/10)*Math.ceil(n/6)*16*i;case ui.ASTC_RGBA_10X8:case ui.ASTC_SRGBA_10X8:return Math.ceil(e/10)*Math.ceil(n/8)*16*i;case ui.ASTC_RGBA_10X10:case ui.ASTC_SRGBA_10X10:return Math.ceil(e/10)*Math.ceil(n/10)*16*i;case ui.ASTC_RGBA_12X10:case ui.ASTC_SRGBA_12X10:return Math.ceil(e/12)*Math.ceil(n/10)*16*i;case ui.ASTC_RGBA_12X12:case ui.ASTC_SRGBA_12X12:return Math.ceil(e/12)*Math.ceil(n/12)*16*i;default:return 0}}function no(t,e,n,i,r){for(var o=0,a=0;a<r;++a)o+=eo(t,e,n,i),e=Math.max(e>>1,1),n=Math.max(n>>1,1);return o}var io=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function ro(t){return io[t]||0}function oo(t){var e=t.size/t.count;switch(t.type){case hi.UNORM:case hi.UINT:switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case hi.SNORM:case hi.INT:switch(e){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case hi.FLOAT:return Float32Array}return Float32Array}var ao=Object.freeze({__proto__:null,get ObjectType(){return oi},get Status(){return ai},get API(){return si},get SurfaceTransform(){return ci},get Feature(){return li},get Format(){return ui},get FormatType(){return hi},get Type(){return _i},get BufferUsageBit(){return fi},get BufferFlagBit(){return pi},get MemoryAccessBit(){return di},get MemoryUsageBit(){return mi},get TextureType(){return vi},get TextureUsageBit(){return gi},get TextureFlagBit(){return yi},get SampleCount(){return xi},get VsyncMode(){return Si},get Filter(){return Ci},get Address(){return Ai},get ComparisonFunc(){return bi},get StencilOp(){return Ti},get BlendFactor(){return Ei},get BlendOp(){return wi},get ColorMask(){return Pi},get ShaderStageFlagBit(){return Ii},get LoadOp(){return Ri},get StoreOp(){return Di},get AccessType(){return Bi},get ResolveMode(){return Mi},get PipelineBindPoint(){return Oi},get PrimitiveMode(){return Ni},get PolygonMode(){return Li},get ShadeModel(){return Fi},get CullMode(){return zi},get DynamicStateFlagBit(){return Gi},get StencilFace(){return Vi},get DescriptorType(){return Ui},get QueueType(){return ki},get QueryType(){return Hi},get CommandBufferType(){return ji},get ClearFlagBit(){return Wi},Size:Yi,DeviceCaps:Ki,Offset:Ji,Rect:Qi,Extent:Zi,TextureSubresLayers:$i,TextureSubresRange:tr,TextureCopy:er,TextureBlit:nr,BufferTextureCopy:ir,Viewport:rr,Color:or,BindingMappingInfo:ar,SwapchainInfo:sr,DeviceInfo:cr,BufferInfo:lr,BufferViewInfo:ur,DrawInfo:hr,DispatchInfo:_r,IndirectBuffer:fr,TextureInfo:pr,TextureViewInfo:dr,SamplerInfo:mr,Uniform:vr,UniformBlock:gr,UniformSamplerTexture:yr,UniformSampler:xr,UniformTexture:Sr,UniformStorageImage:Cr,UniformStorageBuffer:Ar,UniformInputAttachment:br,ShaderStage:Tr,Attribute:Er,ShaderInfo:wr,InputAssemblerInfo:Pr,ColorAttachment:Ir,DepthStencilAttachment:Rr,SubpassInfo:Dr,SubpassDependency:Br,RenderPassInfo:Mr,GlobalBarrierInfo:Or,TextureBarrierInfo:Nr,FramebufferInfo:Lr,DescriptorSetLayoutBinding:Fr,DescriptorSetLayoutInfo:zr,DescriptorSetInfo:Gr,PipelineLayoutInfo:Vr,InputState:Ur,CommandBufferInfo:kr,QueueInfo:Hr,QueryPoolInfo:jr,FormatInfo:Wr,MemoryStatus:qr,DynamicStencilStates:Xr,DynamicStates:Yr,GFXObject:Kr,get AttributeName(){return Xi},FormatInfos:Jr,DESCRIPTOR_BUFFER_TYPE:Qr,DESCRIPTOR_SAMPLER_TYPE:Zr,DESCRIPTOR_DYNAMIC_TYPE:$r,DRAW_INFO_SIZE:28,IsPowerOf2:to,FormatSize:eo,FormatSurfaceSize:no,GetTypeSize:ro,getTypedArrayConstructor:oo}),so=function(t){function e(){var e;return(e=t.call(this,oi.BUFFER)||this)._usage=fi.NONE,e._memUsage=mi.NONE,e._size=0,e._stride=1,e._count=0,e._flags=pi.NONE,e._isBufferView=!1,e}return Q(e,t),K(e,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}}]),e}(Kr),co=function(t){function e(){var e;return(e=t.call(this,oi.COMMAND_BUFFER)||this)._queue=null,e._type=ji.PRIMARY,e._numDrawCalls=0,e._numInstances=0,e._numTris=0,e}return Q(e,t),K(e,[{key:"type",get:function(){return this._type}},{key:"queue",get:function(){return this._queue}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),e}(Kr),lo=function(){function t(){this._gfxAPI=si.UNKNOWN,this._renderer="",this._vendor="",this._features=new Array(li.COUNT),this._queue=null,this._cmdBuff=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new qr,this._caps=new Ki,this._bindingMappingInfo=new ar,this._samplers=new Map,this._globalBarriers=new Map,this._textureBarriers=new Map}return t.prototype.hasFeature=function(t){return this._features[t]},K(t,[{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"commandBuffer",get:function(){return this._cmdBuff}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"capabilities",get:function(){return this._caps}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}}]),t}();lo.canvas=void 0;var uo=function(t){function e(){var e;return(e=t.call(this,oi.SWAPCHAIN)||this)._transform=ci.IDENTITY,e._colorTexture=null,e._depthStencilTexture=null,e}return Q(e,t),K(e,[{key:"colorTexture",get:function(){return this._colorTexture}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}},{key:"surfaceTransform",get:function(){return this._transform}},{key:"width",get:function(){return this._colorTexture.width}},{key:"height",get:function(){return this._colorTexture.height}}]),e}(Kr),ho=function(t){function e(){var e;return(e=t.call(this,oi.FRAMEBUFFER)||this)._renderPass=null,e._colorTextures=[],e._depthStencilTexture=null,e}return Q(e,t),K(e,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTextures",get:function(){return this._colorTextures}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}}]),e}(Kr),_o=String.prototype.charCodeAt;function fo(t){return this[t]}function po(t,e){for(var n=t.length,i=e^n,r=0,o="string"==typeof t?_o:fo;n>=4;){var a=255&o.call(t,r)|(255&o.call(t,++r))<<8|(255&o.call(t,++r))<<16|(255&o.call(t,++r))<<24;a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),n-=4,++r}switch(n){case 3:i^=(255&o.call(t,r+2))<<16;case 2:i^=(255&o.call(t,r+1))<<8;case 1:i=1540483477*(65535&(i^=255&o.call(t,r)))+((1540483477*(i>>>16)&65535)<<16)}return i=1540483477*(65535&(i^=i>>>13))+((1540483477*(i>>>16)&65535)<<16),(i^=i>>>15)>>>0}var mo=function(t){function e(){var e;return(e=t.call(this,oi.INPUT_ASSEMBLER)||this)._attributes=[],e._attributesHash=0,e._vertexBuffers=[],e._indexBuffer=null,e._indirectBuffer=null,e._drawInfo=new hr,e}Q(e,t);var n=e.prototype;return n.getVertexBuffer=function(t){return void 0===t&&(t=0),t<this._vertexBuffers.length?this._vertexBuffers[t]:null},n.computeAttributesHash=function(){for(var t="attrs",e=0;e<this.attributes.length;++e){var n=this.attributes[e];t+=","+n.name+","+n.format+","+n.isNormalized+","+n.stream+","+n.isInstanced}return po(t,666)},K(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"attributesHash",get:function(){return this._attributesHash}},{key:"vertexCount",get:function(){return this._drawInfo.vertexCount},set:function(t){this._drawInfo.vertexCount=t}},{key:"firstVertex",get:function(){return this._drawInfo.firstVertex},set:function(t){this._drawInfo.firstVertex=t}},{key:"indexCount",get:function(){return this._drawInfo.indexCount},set:function(t){this._drawInfo.indexCount=t}},{key:"firstIndex",get:function(){return this._drawInfo.firstIndex},set:function(t){this._drawInfo.firstIndex=t}},{key:"vertexOffset",get:function(){return this._drawInfo.vertexOffset},set:function(t){this._drawInfo.vertexOffset=t}},{key:"instanceCount",get:function(){return this._drawInfo.instanceCount},set:function(t){this._drawInfo.instanceCount=t}},{key:"firstInstance",get:function(){return this._drawInfo.firstInstance},set:function(t){this._drawInfo.firstInstance=t}},{key:"drawInfo",get:function(){return this._drawInfo}}]),e}(Kr),vo=function(t){function e(){var e;return(e=t.call(this,oi.DESCRIPTOR_SET)||this)._layout=null,e._buffers=[],e._textures=[],e._samplers=[],e._isDirty=!1,e}Q(e,t);var n=e.prototype;return n.bindBuffer=function(t,e,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[t],r=this._layout.bindings[i];if(r&&r.descriptorType&Qr){var o=this._layout.descriptorIndices[t];this._buffers[o+n]!==e&&(this._buffers[o+n]=e,this._isDirty=!0)}},n.bindSampler=function(t,e,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[t],r=this._layout.bindings[i];if(r&&r.descriptorType&Zr){var o=this._layout.descriptorIndices[t];this._samplers[o+n]!==e&&(this._samplers[o+n]=e,this._isDirty=!0)}},n.bindTexture=function(t,e,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[t],r=this._layout.bindings[i];if(r&&r.descriptorType&Zr){var o=this._layout.descriptorIndices[t];this._textures[o+n]!==e&&(this._textures[o+n]=e,this._isDirty=!0)}},n.getBuffer=function(t,e){void 0===e&&(e=0);var n=this._layout.descriptorIndices[t];return this._buffers[n+e]},n.getSampler=function(t,e){void 0===e&&(e=0);var n=this._layout.descriptorIndices[t];return this._samplers[n+e]},n.getTexture=function(t,e){void 0===e&&(e=0);var n=this._layout.descriptorIndices[t];return this._textures[n+e]},K(e,[{key:"layout",get:function(){return this._layout}}]),e}(Kr),go=function(t){function e(){var e;return(e=t.call(this,oi.DESCRIPTOR_SET_LAYOUT)||this)._bindings=[],e._bindingIndices=[],e._descriptorIndices=[],e}return Q(e,t),K(e,[{key:"bindings",get:function(){return this._bindings}},{key:"bindingIndices",get:function(){return this._bindingIndices}},{key:"descriptorIndices",get:function(){return this._descriptorIndices}}]),e}(Kr),yo=function(t){function e(){var e;return(e=t.call(this,oi.PIPELINE_LAYOUT)||this)._setLayouts=[],e}return Q(e,t),K(e,[{key:"setLayouts",get:function(){return this._setLayouts}}]),e}(Kr),xo=function(){function t(t,e,n,i,r,o,a,s,c,l,u,h){void 0===t&&(t=!1),void 0===e&&(e=Li.FILL),void 0===n&&(n=Fi.GOURAND),void 0===i&&(i=zi.BACK),void 0===r&&(r=!0),void 0===o&&(o=!1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=!0),void 0===u&&(u=!1),void 0===h&&(h=1),this.isDiscard=t,this.polygonMode=e,this.shadeModel=n,this.cullMode=i,this.isFrontFaceCCW=r,this.depthBiasEnabled=o,this.depthBias=a,this.depthBiasClamp=s,this.depthBiasSlop=c,this.isDepthClip=l,this.isMultisample=u,this.lineWidth=h}var e=t.prototype;return e.reset=function(){this.isDiscard=!1,this.polygonMode=Li.FILL,this.shadeModel=Fi.GOURAND,this.cullMode=zi.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1},e.assign=function(t){Object.assign(this,t)},e.destroy=function(){},K(t,[{key:"native",get:function(){return this}}]),t}(),So=function(){function t(t,e,n,i,r,o,a,s,c,l,u,h,_,f,p,d,m,v,g){void 0===t&&(t=!0),void 0===e&&(e=!0),void 0===n&&(n=bi.LESS),void 0===i&&(i=!1),void 0===r&&(r=bi.ALWAYS),void 0===o&&(o=65535),void 0===a&&(a=65535),void 0===s&&(s=Ti.KEEP),void 0===c&&(c=Ti.KEEP),void 0===l&&(l=Ti.KEEP),void 0===u&&(u=1),void 0===h&&(h=!1),void 0===_&&(_=bi.ALWAYS),void 0===f&&(f=65535),void 0===p&&(p=65535),void 0===d&&(d=Ti.KEEP),void 0===m&&(m=Ti.KEEP),void 0===v&&(v=Ti.KEEP),void 0===g&&(g=1),this.depthTest=t,this.depthWrite=e,this.depthFunc=n,this.stencilTestFront=i,this.stencilFuncFront=r,this.stencilReadMaskFront=o,this.stencilWriteMaskFront=a,this.stencilFailOpFront=s,this.stencilZFailOpFront=c,this.stencilPassOpFront=l,this.stencilRefFront=u,this.stencilTestBack=h,this.stencilFuncBack=_,this.stencilReadMaskBack=f,this.stencilWriteMaskBack=p,this.stencilFailOpBack=d,this.stencilZFailOpBack=m,this.stencilPassOpBack=v,this.stencilRefBack=g}var e=t.prototype;return e.reset=function(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=bi.LESS,this.stencilTestFront=!1,this.stencilFuncFront=bi.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=Ti.KEEP,this.stencilZFailOpFront=Ti.KEEP,this.stencilPassOpFront=Ti.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=bi.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=Ti.KEEP,this.stencilZFailOpBack=Ti.KEEP,this.stencilPassOpBack=Ti.KEEP,this.stencilRefBack=1},e.assign=function(t){Object.assign(this,t)},e.destroy=function(){},K(t,[{key:"native",get:function(){return this}}]),t}(),Co=function(){function t(t,e,n,i,r,o,a,s){void 0===t&&(t=!1),void 0===e&&(e=Ei.ONE),void 0===n&&(n=Ei.ZERO),void 0===i&&(i=wi.ADD),void 0===r&&(r=Ei.ONE),void 0===o&&(o=Ei.ZERO),void 0===a&&(a=wi.ADD),void 0===s&&(s=Pi.ALL),this.blend=t,this.blendSrc=e,this.blendDst=n,this.blendEq=i,this.blendSrcAlpha=r,this.blendDstAlpha=o,this.blendAlphaEq=a,this.blendColorMask=s}var e=t.prototype;return e.reset=function(){this.blend=!1,this.blendSrc=Ei.ONE,this.blendDst=Ei.ZERO,this.blendEq=wi.ADD,this.blendSrcAlpha=Ei.ONE,this.blendDstAlpha=Ei.ZERO,this.blendAlphaEq=wi.ADD,this.blendColorMask=Pi.ALL},e.assign=function(t){Object.assign(this,t)},e.destroy=function(){},t}(),Ao=function(){function t(t,e,n,i){void 0===t&&(t=!1),void 0===e&&(e=!1),void 0===n&&(n=new or),void 0===i&&(i=[new Co]),this.isA2C=t,this.isIndepend=e,this.blendColor=n,this.targets=i}var e=t.prototype;return e.setTarget=function(t,e){var n=this.targets[t];n||(n=this.targets[t]=new Co),Object.assign(n,e)},e.reset=function(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()},e.destroy=function(){},K(t,[{key:"native",get:function(){return this}}]),t}(),bo=function(t,e,n,i,r,o,a,s,c,l){void 0===t&&(t=null),void 0===e&&(e=null),void 0===n&&(n=null),void 0===i&&(i=new Ur),void 0===r&&(r=new xo),void 0===o&&(o=new So),void 0===a&&(a=new Ao),void 0===s&&(s=Ni.TRIANGLE_LIST),void 0===c&&(c=Gi.NONE),void 0===l&&(l=Oi.GRAPHICS),this.shader=t,this.pipelineLayout=e,this.renderPass=n,this.inputState=i,this.rasterizerState=r,this.depthStencilState=o,this.blendState=a,this.primitive=s,this.dynamicStates=c,this.bindPoint=l},To=function(t){function e(){var e;return(e=t.call(this,oi.PIPELINE_STATE)||this)._shader=null,e._pipelineLayout=null,e._primitive=Ni.TRIANGLE_LIST,e._is=null,e._rs=new xo,e._dss=new So,e._bs=new Ao,e._dynamicStates=Gi.NONE,e._renderPass=null,e}return Q(e,t),K(e,[{key:"shader",get:function(){return this._shader}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"renderPass",get:function(){return this._renderPass}}]),e}(Kr),Eo=function(t){function e(){var e;return(e=t.call(this,oi.QUEUE)||this)._type=ki.GRAPHICS,e}return Q(e,t),K(e,[{key:"type",get:function(){return this._type}}]),e}(Kr),wo=function(t){function e(){var e;return(e=t.call(this,oi.RENDER_PASS)||this)._colorInfos=[],e._depthStencilInfo=null,e._subpasses=[],e._hash=0,e}return Q(e,t),e.prototype.computeHash=function(){var t="";if(this._subpasses.length)for(var e=0;e<this._subpasses.length;++e){var n=this._subpasses[e];if(n.inputs.length){t+="ia";for(var i=0;i<n.inputs.length;++i){var r=this._colorInfos[n.inputs[i]];t+=","+r.format+","+r.sampleCount}}if(n.colors.length){t+="ca";for(var o=0;o<n.inputs.length;++o){var a=this._colorInfos[n.inputs[o]];t+=","+a.format+","+a.sampleCount}}if(n.depthStencil>=0){var s=this._colorInfos[n.depthStencil];t+="ds,"+s.format+","+s.sampleCount}}else{t+="ca";for(var c=0;c<this._colorInfos.length;++c){var l=this._colorInfos[c];t+=","+l.format+","+l.sampleCount}var u=this._depthStencilInfo;u&&(t+="ds,"+u.format+","+u.sampleCount)}return po(t,666)},K(e,[{key:"colorAttachments",get:function(){return this._colorInfos}},{key:"depthStencilAttachment",get:function(){return this._depthStencilInfo}},{key:"subPasses",get:function(){return this._subpasses}},{key:"hash",get:function(){return this._hash}}]),e}(Kr),Po=function(t){function e(e,n){var i;return(i=t.call(this,oi.SAMPLER)||this)._info=new mr,i._hash=0,i._info.copy(e),i._hash=n,i}return Q(e,t),e.computeHash=function(t){var e=t.minFilter;return e|=t.magFilter<<2,e|=t.mipFilter<<4,e|=t.addressU<<6,e|=t.addressV<<8,e|=t.addressW<<10,(e|=t.maxAnisotropy<<12)|t.cmpFunc<<16},e.unpackFromHash=function(t){var e=new mr;return e.minFilter=(3&t)>>0,e.magFilter=(3&t)>>2,e.mipFilter=(3&t)>>4,e.addressU=(3&t)>>6,e.addressV=(3&t)>>8,e.addressW=(3&t)>>10,e.maxAnisotropy=(15&t)>>12,e.cmpFunc=(7&t)>>16,e},K(e,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),e}(Kr),Io=function(t){function e(){var e;return(e=t.call(this,oi.SHADER)||this)._name="",e._stages=[],e._attributes=[],e._blocks=[],e._samplers=[],e}return Q(e,t),K(e,[{key:"name",get:function(){return this._name}},{key:"attributes",get:function(){return this._attributes}},{key:"blocks",get:function(){return this._blocks}},{key:"samplers",get:function(){return this._samplers}}]),e}(Kr),Ro=function(t){function e(){var e;return(e=t.call(this,oi.TEXTURE)||this)._type=vi.TEX2D,e._usage=gi.NONE,e._format=ui.UNKNOWN,e._width=0,e._height=0,e._depth=1,e._layerCount=1,e._levelCount=1,e._samples=xi.ONE,e._flags=yi.NONE,e._isPowerOf2=!1,e._size=0,e}return Q(e,t),K(e,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"layerCount",get:function(){return this._layerCount}},{key:"levelCount",get:function(){return this._levelCount}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}}]),e}(Kr),Do=function(t){function e(e,n){var i;return(i=t.call(this,oi.GLOBAL_BARRIER)||this)._info=new Or,i._hash=0,i._info.copy(e),i._hash=n,i}return Q(e,t),e.computeHash=function(t){for(var e="prev:",n=0;n<t.prevAccesses.length;++n)e+=" "+t.prevAccesses[n];e+="next:";for(var i=0;i<t.nextAccesses.length;++i)e+=" "+t.nextAccesses[i];return po(e,666)},K(e,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),e}(Kr),Bo=function(t){function e(e,n){var i;return(i=t.call(this,oi.TEXTURE_BARRIER)||this)._info=new Nr,i._hash=0,i._info.copy(e),i._hash=n,i}return Q(e,t),e.computeHash=function(t){for(var e="prev:",n=0;n<t.prevAccesses.length;++n)e+=" "+t.prevAccesses[n];e+="next:";for(var i=0;i<t.nextAccesses.length;++i)e+=" "+t.nextAccesses[i];return e+=t.discardContents,e+=t.srcQueue?t.srcQueue.type:0,po(e+=t.dstQueue?t.dstQueue.type:0,666)},K(e,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),e}(Kr),Mo={Device:lo,Swapchain:uo,Buffer:so,Texture:Ro,Sampler:Po,Shader:Io,InputAssembler:mo,RenderPass:wo,Framebuffer:ho,DescriptorSet:vo,DescriptorSetLayout:go,PipelineLayout:yo,PipelineState:To,CommandBuffer:co,Queue:Eo,GlobalBarrier:Do,TextureBarrier:Bo,RasterizerState:xo,BlendState:Ao,BlendTarget:Co,DepthStencilState:So,PipelineStateInfo:bo};Object.assign(Mo,ao),c.gfx=Mo;var Oo={Obj:"GFXObject",DRAW_INFO_SIZE:"GFX_DRAW_INFO_SIZE",DESCRIPTOR_BUFFER_TYPE:"",DESCRIPTOR_SAMPLER_TYPE:"",DESCRIPTOR_DYNAMIC_TYPE:"",getTypedArrayConstructor:""};for(var No in c.gfx)if("__esModule"!==No){var Lo=Oo[No];""===Lo?Lo=No:void 0===Lo&&(Lo="GFX"+No),z(c,"cc",[{name:Lo,newName:No,target:c.gfx,targetName:"cc.gfx"}])}t("gfx",Object.freeze({__proto__:null,DescriptorSet:vo,Buffer:so,CommandBuffer:co,get ObjectType(){return oi},get Status(){return ai},get API(){return si},get SurfaceTransform(){return ci},get Feature(){return li},get Format(){return ui},get FormatType(){return hi},get Type(){return _i},get BufferUsageBit(){return fi},get BufferFlagBit(){return pi},get MemoryAccessBit(){return di},get MemoryUsageBit(){return mi},get TextureType(){return vi},get TextureUsageBit(){return gi},get TextureFlagBit(){return yi},get SampleCount(){return xi},get VsyncMode(){return Si},get Filter(){return Ci},get Address(){return Ai},get ComparisonFunc(){return bi},get StencilOp(){return Ti},get BlendFactor(){return Ei},get BlendOp(){return wi},get ColorMask(){return Pi},get ShaderStageFlagBit(){return Ii},get LoadOp(){return Ri},get StoreOp(){return Di},get AccessType(){return Bi},get ResolveMode(){return Mi},get PipelineBindPoint(){return Oi},get PrimitiveMode(){return Ni},get PolygonMode(){return Li},get ShadeModel(){return Fi},get CullMode(){return zi},get DynamicStateFlagBit(){return Gi},get StencilFace(){return Vi},get DescriptorType(){return Ui},get QueueType(){return ki},get QueryType(){return Hi},get CommandBufferType(){return ji},get ClearFlagBit(){return Wi},Size:Yi,DeviceCaps:Ki,Offset:Ji,Rect:Qi,Extent:Zi,TextureSubresLayers:$i,TextureSubresRange:tr,TextureCopy:er,TextureBlit:nr,BufferTextureCopy:ir,Viewport:rr,Color:or,BindingMappingInfo:ar,SwapchainInfo:sr,DeviceInfo:cr,BufferInfo:lr,BufferViewInfo:ur,DrawInfo:hr,DispatchInfo:_r,IndirectBuffer:fr,TextureInfo:pr,TextureViewInfo:dr,SamplerInfo:mr,Uniform:vr,UniformBlock:gr,UniformSamplerTexture:yr,UniformSampler:xr,UniformTexture:Sr,UniformStorageImage:Cr,UniformStorageBuffer:Ar,UniformInputAttachment:br,ShaderStage:Tr,Attribute:Er,ShaderInfo:wr,InputAssemblerInfo:Pr,ColorAttachment:Ir,DepthStencilAttachment:Rr,SubpassInfo:Dr,SubpassDependency:Br,RenderPassInfo:Mr,GlobalBarrierInfo:Or,TextureBarrierInfo:Nr,FramebufferInfo:Lr,DescriptorSetLayoutBinding:Fr,DescriptorSetLayoutInfo:zr,DescriptorSetInfo:Gr,PipelineLayoutInfo:Vr,InputState:Ur,CommandBufferInfo:kr,QueueInfo:Hr,QueryPoolInfo:jr,FormatInfo:Wr,MemoryStatus:qr,DynamicStencilStates:Xr,DynamicStates:Yr,GFXObject:Kr,get AttributeName(){return Xi},FormatInfos:Jr,DESCRIPTOR_BUFFER_TYPE:Qr,DESCRIPTOR_SAMPLER_TYPE:Zr,DESCRIPTOR_DYNAMIC_TYPE:$r,DRAW_INFO_SIZE:28,IsPowerOf2:to,FormatSize:eo,FormatSurfaceSize:no,GetTypeSize:ro,getTypedArrayConstructor:oo,Device:lo,Swapchain:uo,Framebuffer:ho,InputAssembler:mo,DescriptorSetLayout:go,PipelineLayout:yo,RasterizerState:xo,DepthStencilState:So,BlendTarget:Co,BlendState:Ao,PipelineStateInfo:bo,PipelineState:To,Queue:Eo,RenderPass:wo,Sampler:Po,Shader:Io,Texture:Ro,GlobalBarrier:Do,TextureBarrier:Bo}));var Fo=new En,zo=new En,Go=new En,Vo=new En,Uo=new En,ko=new En,Ho=new Array(3),jo=new Array(3);function Wo(t,e){return En.dot(e.n,t)-e.d}function qo(t,e,n){return En.copy(t,e),En.subtract(Uo,n.center,n.halfExtents),En.add(ko,n.center,n.halfExtents),t.x=t.x<Uo.x?Uo.x:t.x,t.y=t.y<Uo.y?Uo.y:t.y,t.z=t.z<Uo.z?Uo.z:t.z,t.x=t.x>ko.x?ko.x:t.x,t.y=t.y>ko.y?ko.y:t.y,t.z=t.z>ko.z?ko.z:t.z,t}function Xo(t,e,n){En.set(Fo,n.orientation.m00,n.orientation.m01,n.orientation.m02),En.set(zo,n.orientation.m03,n.orientation.m04,n.orientation.m05),En.set(Go,n.orientation.m06,n.orientation.m07,n.orientation.m08),Ho[0]=Fo,Ho[1]=zo,Ho[2]=Go,jo[0]=n.halfExtents.x,jo[1]=n.halfExtents.y,jo[2]=n.halfExtents.z,En.subtract(Vo,e,n.center),En.set(t,n.center.x,n.center.y,n.center.z);for(var i=0;i<3;i++){var r=En.dot(Vo,Ho[i]);r>jo[i]&&(r=jo[i]),r<-jo[i]&&(r=-jo[i]),t.x+=r*Ho[i].x,t.y+=r*Ho[i].y,t.z+=r*Ho[i].z}return t}var Yo=Object.freeze({__proto__:null,point_plane:Wo,pt_point_plane:function(t,e,n){var i=Wo(e,n);return En.subtract(t,e,En.multiplyScalar(t,n.n,i))},pt_point_aabb:qo,pt_point_obb:Xo,pt_point_line:function(t,e,n,i){En.subtract(Fo,n,i);var r=Fo,o=En.lengthSqr(r);if(0==o)En.copy(t,n);else{En.subtract(Fo,e,n);var a=En.dot(Fo,r)/o;a<0?En.copy(t,n):a>1?En.copy(t,i):En.scaleAndAdd(t,n,r,a)}}}),Ko={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512},Jo=function(){function t(t,e,n,i,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.s=void 0,this.e=void 0,this._type=void 0,this._type=Ko.SHAPE_LINE,this.s=new En(t,e,n),this.e=new En(i,r,o)}return t.create=function(e,n,i,r,o,a){return new t(e,n,i,r,o,a)},t.clone=function(e){return new t(e.s.x,e.s.y,e.s.z,e.e.x,e.e.y,e.e.z)},t.copy=function(t,e){return En.copy(t.s,e.s),En.copy(t.e,e.e),t},t.fromPoints=function(t,e,n){return En.copy(t.s,e),En.copy(t.e,n),t},t.set=function(t,e,n,i,r,o,a){return t.s.x=e,t.s.y=n,t.s.z=i,t.e.x=r,t.e.y=o,t.e.z=a,t},t.len=function(t){return En.distance(t.s,t.e)},t.prototype.length=function(){return En.distance(this.s,this.e)},K(t,[{key:"type",get:function(){return this._type}}]),t}(),Qo=function(){function t(t,e,n,i,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.o=void 0,this.d=void 0,this._type=void 0,this._type=Ko.SHAPE_RAY,this.o=new En(t,e,n),this.d=new En(i,r,o)}return t.create=function(e,n,i,r,o,a){return void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),new t(e,n,i,r,o,a)},t.clone=function(e){return new t(e.o.x,e.o.y,e.o.z,e.d.x,e.d.y,e.d.z)},t.copy=function(t,e){return En.copy(t.o,e.o),En.copy(t.d,e.d),t},t.fromPoints=function(t,e,n){return En.copy(t.o,e),En.normalize(t.d,En.subtract(t.d,n,e)),t},t.set=function(t,e,n,i,r,o,a){return t.o.x=e,t.o.y=n,t.o.z=i,t.d.x=r,t.d.y=o,t.d.z=a,t},t.prototype.computeHit=function(t,e){En.normalize(t,this.d),En.scaleAndAdd(t,this.o,t,e)},K(t,[{key:"type",get:function(){return this._type}}]),t}(),Zo=new En,$o=new En,ta=new En,ea=new En;function na(t){return Math.max(Math.max(t.x,t.y),t.z)}var ia,ra=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),this._center=new En(0,0,0),this._radius=0,this._type=void 0,this._type=Ko.SHAPE_SPHERE,this._center=new En(t,e,n),this._radius=i}t.create=function(e,n,i,r){return new t(e,n,i,r)},t.clone=function(e){return new t(e.center.x,e.center.y,e.center.z,e.radius)},t.copy=function(t,e){return En.copy(t.center,e.center),t.radius=e.radius,t},t.fromPoints=function(t,e,n){return En.multiplyScalar(t.center,En.add(Zo,e,n),.5),t.radius=.5*En.subtract(Zo,n,e).length(),t},t.set=function(t,e,n,i,r){return t.center.x=e,t.center.y=n,t.center.z=i,t.radius=r,t};var e=t.prototype;return e.destroy=function(){},e.clone=function(){return t.clone(this)},e.copy=function(e){return t.copy(this,e)},e.getBoundary=function(t,e){En.set(t,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),En.set(e,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)},e.transform=function(t,e,n,i,r){En.transformMat4(r.center,this.center,t),r.radius=this.radius*na(i)},e.translateAndRotate=function(t,e,n){En.transformMat4(n.center,this.center,t)},e.setScale=function(t,e){e.radius=this.radius*na(t)},e.mergePoint=function(t){this.radius<0&&(this.center.set(t),this.radius=0),En.subtract($o,t,this.center);var e=$o.length();if(e>this.radius){var n=.5*(e-this.radius);this.radius+=n,En.multiplyScalar($o,$o,n/e),En.add(this.center,this.center,$o)}},e.mergePoints=function(t){var e=t.length;if(!(e<1)){this.radius=-1;for(var n=0;n<e;n++)this.mergePoint(t[n])}},e.mergeAABB=function(t){t.getBoundary(ta,ea),this.mergePoint(ta),this.mergePoint(ea)},K(t,[{key:"center",get:function(){return this._center},set:function(t){this._center=t}},{key:"radius",get:function(){return this._radius},set:function(t){this._radius=t}},{key:"type",get:function(){return this._type}}]),t}(),oa=function(){function t(t,e,n,i,r,o,a,s,c){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=1),void 0===c&&(c=0),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=Ko.SHAPE_TRIANGLE,this.a=new En(t,e,n),this.b=new En(i,r,o),this.c=new En(a,s,c)}return t.create=function(e,n,i,r,o,a,s,c,l){return void 0===e&&(e=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),new t(e,n,i,r,o,a,s,c,l)},t.clone=function(e){return new t(e.a.x,e.a.y,e.a.z,e.b.x,e.b.y,e.b.z,e.c.x,e.c.y,e.c.z)},t.copy=function(t,e){return En.copy(t.a,e.a),En.copy(t.b,e.b),En.copy(t.c,e.c),t},t.fromPoints=function(t,e,n,i){return En.copy(t.a,e),En.copy(t.b,n),En.copy(t.c,i),t},t.set=function(t,e,n,i,r,o,a,s,c,l){return t.a.x=e,t.a.y=n,t.a.z=i,t.b.x=r,t.b.y=o,t.b.z=a,t.c.x=s,t.c.y=c,t.c.z=l,t},K(t,[{key:"type",get:function(){return this._type}}]),t}();!function(t){t[t.ALL=0]="ALL",t[t.CLOSEST=1]="CLOSEST",t[t.ANY=2]="ANY"}(ia||(ia={}));var aa,sa,ca,la,ua,ha,_a,fa,pa=(aa=new En(0,0,0),function(t,e){var n=En.dot(t.d,e.n);if(Math.abs(n)<Number.EPSILON)return 0;En.multiplyScalar(aa,e.n,e.d);var i=En.dot(En.subtract(aa,aa,t.o),e.n)/n;return i<0?0:i}),da=(sa=new En(0,0,0),ca=new En(0,0,0),la=new En(0,0,0),ua=new En(0,0,0),ha=new En(0,0,0),function(t,e,n){En.subtract(sa,e.b,e.a),En.subtract(ca,e.c,e.a),En.cross(la,t.d,ca);var i=En.dot(sa,la);if(i<Number.EPSILON&&(!n||i>-Number.EPSILON))return 0;var r=1/i;En.subtract(ua,t.o,e.a);var o=En.dot(ua,la)*r;if(o<0||o>1)return 0;En.cross(ha,ua,sa);var a=En.dot(t.d,ha)*r;if(a<0||o+a>1)return 0;var s=En.dot(ca,ha)*r;return s<0?0:s}),ma=function(){var t=new En(0,0,0);return function(e,n){var i=n.radius,r=n.center,o=e.o,a=e.d,s=i*i;En.subtract(t,r,o);var c=t.lengthSqr(),l=En.dot(t,a),u=s-(c-l*l);if(u<0)return 0;var h=Math.sqrt(u),_=c<s?l+h:l-h;return _<0?0:_}}(),va=(_a=new En,fa=new En,function(t,e){return En.subtract(_a,e.center,e.halfExtents),En.add(fa,e.center,e.halfExtents),ga(t,_a,fa)});function ga(t,e,n){var i=t.o,r=t.d,o=1/r.x,a=1/r.y,s=1/r.z,c=(e.x-i.x)*o,l=(n.x-i.x)*o,u=(e.y-i.y)*a,h=(n.y-i.y)*a,_=(e.z-i.z)*s,f=(n.z-i.z)*s,p=Math.max(Math.max(Math.min(c,l),Math.min(u,h)),Math.min(_,f)),d=Math.min(Math.min(Math.max(c,l),Math.max(u,h)),Math.max(_,f));return d<0||p>d?0:p>0?p:d}var ya,xa,Sa,Ca,Aa=function(){var t=new En,e=new En,n=new En,i=new En,r=new En,o=new En,a=new En,s=new Array(3),c=new Array(3),l=new Array(3),u=new Array(6);return function(h,_){s[0]=_.halfExtents.x,s[1]=_.halfExtents.y,s[2]=_.halfExtents.z,t=_.center,e=h.o,n=h.d,En.set(i,_.orientation.m00,_.orientation.m01,_.orientation.m02),En.set(r,_.orientation.m03,_.orientation.m04,_.orientation.m05),En.set(o,_.orientation.m06,_.orientation.m07,_.orientation.m08),En.subtract(a,t,e),c[0]=En.dot(i,n),c[1]=En.dot(r,n),c[2]=En.dot(o,n),l[0]=En.dot(i,a),l[1]=En.dot(r,a),l[2]=En.dot(o,a);for(var f=0;f<3;++f){if(0===c[f]){if(-l[f]-s[f]>0||-l[f]+s[f]<0)return 0;c[f]=1e-7}u[2*f+0]=(l[f]+s[f])/c[f],u[2*f+1]=(l[f]-s[f])/c[f]}var p=Math.max(Math.max(Math.min(u[0],u[1]),Math.min(u[2],u[3])),Math.min(u[4],u[5])),d=Math.min(Math.min(Math.max(u[0],u[1]),Math.max(u[2],u[3])),Math.max(u[4],u[5]));return d<0||p>d?0:p>0?p:d}}(),ba=function(){var t=new En,e=new En,n=new En,i=new En,r=new En,o=new En,a=new En,s=new ra;return function(c,l){var u=l.radius*l.radius,h=En.normalize(t,c.d),_=l.ellipseCenter0,f=l.ellipseCenter1,p=En.subtract(e,f,_);if(p.equals(En.ZERO))return s.radius=l.radius,s.center.set(l.ellipseCenter0),cs.raySphere(c,s);var d=c.o,m=En.subtract(n,d,_),v=En.cross(i,h,p),g=v.lengthSqr();if(0===g){s.radius=l.radius;var y=En.subtract(r,f,d);return m.lengthSqr()<y.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),cs.raySphere(c,s)}var x=En.cross(r,m,p),S=p.lengthSqr(),C=2*En.dot(v,x),A=C*C-4*g*(x.lengthSqr()-u*S);if(A<0)return 0;var b=(-C-Math.sqrt(A))/(2*g);if(b<0){s.radius=l.radius;var T=En.subtract(o,f,d);return m.lengthSqr()<T.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),cs.raySphere(c,s)}var E=En.scaleAndAdd(o,c.o,h,b),w=En.subtract(a,E,_),P=En.dot(w,p)/S;return P>=0&&P<=1?b:P<0?(s.radius=l.radius,s.center.set(l.ellipseCenter0),cs.raySphere(c,s)):P>1?(s.radius=l.radius,s.center.set(l.ellipseCenter1),cs.raySphere(c,s)):0}}(),Ta=(ya=oa.create(),xa={distance:1/0,doubleSided:!1,mode:ia.ANY},Sa=0,Ca=function(t,e,n,i,r,o){t===ia.CLOSEST?(Sa>e||0===Sa)&&(Sa=e,o&&(0===o.length?o.push({distance:e,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}):(o[0].distance=e,o[0].vertexIndex0=n/3,o[0].vertexIndex1=i/3,o[0].vertexIndex2=r/3))):(Sa=e,o&&o.push({distance:e,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}))},function(t,e,n){if(Sa=0,0===e.geometricInfo.positions.length)return Sa;var i=void 0===n?xa:n;if(ga(t,e.geometricInfo.boundingBox.min,e.geometricInfo.boundingBox.max)){var r=e.primitiveMode,o=e.geometricInfo;!function(t,e,n,i,r){if(n===Ni.TRIANGLE_LIST)for(var o=e.length,a=0;a<o;a+=3){var s=3*e[a],c=3*e[a+1],l=3*e[a+2];En.set(ya.a,t[s],t[s+1],t[s+2]),En.set(ya.b,t[c],t[c+1],t[c+2]),En.set(ya.c,t[l],t[l+1],t[l+2]);var u=cs.rayTriangle(i,ya,r.doubleSided);if(!(0===u||u>r.distance)&&(Ca(r.mode,u,s,c,l,r.result),r.mode===ia.ANY))return u}else if(n===Ni.TRIANGLE_STRIP)for(var h=e.length-2,_=0,f=0;f<h;f+=1){var p=3*e[f-_],d=3*e[f+_+1],m=3*e[f+2];En.set(ya.a,t[p],t[p+1],t[p+2]),En.set(ya.b,t[d],t[d+1],t[d+2]),En.set(ya.c,t[m],t[m+1],t[m+2]),_=~_;var v=cs.rayTriangle(i,ya,r.doubleSided);if(!(0===v||v>r.distance)&&(Ca(r.mode,v,p,d,m,r.result),r.mode===ia.ANY))return v}else if(n===Ni.TRIANGLE_FAN){var g=e.length-1,y=3*e[0];En.set(ya.a,t[y],t[y+1],t[y+2]);for(var x=1;x<g;x+=1){var S=3*e[x],C=3*e[x+1];En.set(ya.b,t[S],t[S+1],t[S+2]),En.set(ya.c,t[C],t[C+1],t[C+2]);var A=cs.rayTriangle(i,ya,r.doubleSided);if(!(0===A||A>r.distance)&&(Ca(r.mode,A,y,S,C,r.result),r.mode===ia.ANY))return A}}}(o.positions,o.indices,r,t,i)}return Sa}),Ea=function(){var t=0,e={distance:1/0,doubleSided:!1,mode:ia.ANY};return function(n,i,r){t=0;var o=void 0===r?e:r,a=i.renderingSubMeshes.length,s=i.struct.minPosition,c=i.struct.maxPosition;if(s&&c&&!ga(n,s,c))return t;for(var l=0;l<a;l++){var u=i.renderingSubMeshes[l],h=Ta(n,u,o);if(h)if(o.mode===ia.CLOSEST)(0===t||t>h)&&(t=h,o.subIndices&&(o.subIndices[0]=l));else if(t=h,o.subIndices&&o.subIndices.push(l),o.mode===ia.ANY)return h}return t&&o.mode===ia.CLOSEST&&(o.result&&(o.result[0].distance=t,o.result.length=1),o.subIndices&&(o.subIndices.length=1)),t}}(),wa=function(){var t=0,e={distance:1/0,doubleSided:!1,mode:ia.ANY},n=new Qo,i=new Un;return function(r,o,a){t=0;var s=void 0===a?e:a,c=o.worldBounds;if(c&&!va(r,c))return t;Qo.copy(n,r),o.node&&(Un.invert(i,o.node.getWorldMatrix(i)),En.transformMat4(n.o,r.o,i),En.transformMat4Normal(n.d,r.d,i));for(var l=o.subModels,u=0;u<l.length;u++){var h=l[u].subMesh,_=Ta(n,h,s);if(_)if(s.mode===ia.CLOSEST)(0===t||t>_)&&(t=_,s.subIndices&&(s.subIndices[0]=u));else if(t=_,s.subIndices&&s.subIndices.push(u),s.mode===ia.ANY)return _}return t&&s.mode===ia.CLOSEST&&(s.result&&(s.result[0].distance=t,s.result.length=1),s.subIndices&&(s.subIndices.length=1)),t}}(),Pa=function(){var t=new En(0,0,0);return function(e,n){En.subtract(t,e.e,e.s);var i=(n.d-En.dot(e.s,n.n))/En.dot(t,n.n);return i<0||i>1?0:i}}(),Ia=function(){var t=new En(0,0,0),e=new En(0,0,0),n=new En(0,0,0),i=new En(0,0,0),r=new En(0,0,0),o=new En(0,0,0);return function(a,s,c){En.subtract(t,s.b,s.a),En.subtract(e,s.c,s.a),En.subtract(n,a.s,a.e),En.cross(r,t,e);var l=En.dot(n,r);if(l<=0)return 0;En.subtract(i,a.s,s.a);var u=En.dot(i,r);if(u<0||u>l)return 0;En.cross(o,n,i);var h=En.dot(e,o);if(h<0||h>l)return 0;var _=-En.dot(t,o);if(_<0||h+_>l)return 0;if(c){var f=1/l,p=1-(h*=f)-(_*=f);En.set(c,s.a.x*p+s.b.x*h+s.c.x*_,s.a.y*p+s.b.y*h+s.c.y*_,s.a.z*p+s.b.z*h+s.c.z*_)}return 1}}(),Ra=new Qo;function Da(t,e){Ra.o.set(t.s),En.subtract(Ra.d,t.e,t.s),Ra.d.normalize();var n=va(Ra,e);return n<=t.length()?n:0}function Ba(t,e){Ra.o.set(t.s),En.subtract(Ra.d,t.e,t.s),Ra.d.normalize();var n=Aa(Ra,e);return n<=t.length()?n:0}function Ma(t,e){Ra.o.set(t.s),En.subtract(Ra.d,t.e,t.s),Ra.d.normalize();var n=ma(Ra,e);return n<=t.length()?n:0}var Oa,Na,La,Fa,za=(Oa=new En,Na=new En,La=new En,Fa=new En,function(t,e){return En.subtract(Oa,t.center,t.halfExtents),En.add(Na,t.center,t.halfExtents),En.subtract(La,e.center,e.halfExtents),En.add(Fa,e.center,e.halfExtents),Oa.x<=Fa.x&&Na.x>=La.x&&Oa.y<=Fa.y&&Na.y>=La.y&&Oa.z<=Fa.z&&Na.z>=La.z});function Ga(t,e,n,i,r,o){En.set(o[0],t.x+n.x*e.x+i.x*e.y+r.x*e.z,t.y+n.y*e.x+i.y*e.y+r.y*e.z,t.z+n.z*e.x+i.z*e.y+r.z*e.z),En.set(o[1],t.x-n.x*e.x+i.x*e.y+r.x*e.z,t.y-n.y*e.x+i.y*e.y+r.y*e.z,t.z-n.z*e.x+i.z*e.y+r.z*e.z),En.set(o[2],t.x+n.x*e.x-i.x*e.y+r.x*e.z,t.y+n.y*e.x-i.y*e.y+r.y*e.z,t.z+n.z*e.x-i.z*e.y+r.z*e.z),En.set(o[3],t.x+n.x*e.x+i.x*e.y-r.x*e.z,t.y+n.y*e.x+i.y*e.y-r.y*e.z,t.z+n.z*e.x+i.z*e.y-r.z*e.z),En.set(o[4],t.x-n.x*e.x-i.x*e.y-r.x*e.z,t.y-n.y*e.x-i.y*e.y-r.y*e.z,t.z-n.z*e.x-i.z*e.y-r.z*e.z),En.set(o[5],t.x+n.x*e.x-i.x*e.y-r.x*e.z,t.y+n.y*e.x-i.y*e.y-r.y*e.z,t.z+n.z*e.x-i.z*e.y-r.z*e.z),En.set(o[6],t.x-n.x*e.x+i.x*e.y-r.x*e.z,t.y-n.y*e.x+i.y*e.y-r.y*e.z,t.z-n.z*e.x+i.z*e.y-r.z*e.z),En.set(o[7],t.x-n.x*e.x-i.x*e.y+r.x*e.z,t.y-n.y*e.x-i.y*e.y+r.y*e.z,t.z-n.z*e.x-i.z*e.y+r.z*e.z)}function Va(t,e){for(var n=En.dot(e,t[0]),i=n,r=1;r<8;++r){var o=En.dot(e,t[r]);n=o<n?o:n,i=o>i?o:i}return[n,i]}var Ua,ka,Ha,ja=function(){for(var t=new Array(15),e=0;e<15;e++)t[e]=new En(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new En(0,0,0),i[r]=new En(0,0,0);var o=new En,a=new En;return function(e,r){En.set(t[0],1,0,0),En.set(t[1],0,1,0),En.set(t[2],0,0,1),En.set(t[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),En.set(t[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),En.set(t[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var s=0;s<3;++s)En.cross(t[6+3*s],t[s],t[3]),En.cross(t[7+3*s],t[s],t[4]),En.cross(t[7+3*s],t[s],t[5]);En.subtract(o,e.center,e.halfExtents),En.add(a,e.center,e.halfExtents),function(t,e,n){En.set(n[0],t.x,e.y,e.z),En.set(n[1],t.x,e.y,t.z),En.set(n[2],t.x,t.y,e.z),En.set(n[3],t.x,t.y,t.z),En.set(n[4],e.x,e.y,e.z),En.set(n[5],e.x,e.y,t.z),En.set(n[6],e.x,t.y,e.z),En.set(n[7],e.x,t.y,t.z)}(o,a,n),Ga(r.center,r.halfExtents,t[3],t[4],t[5],i);for(var c=0;c<15;++c){var l=Va(n,t[c]),u=Va(i,t[c]);if(u[0]>l[1]||l[0]>u[1])return 0}return 1}}(),Wa=function(t,e){var n=t.halfExtents.x*Math.abs(e.n.x)+t.halfExtents.y*Math.abs(e.n.y)+t.halfExtents.z*Math.abs(e.n.z),i=En.dot(e.n,t.center);return i+n<e.d?-1:i-n>e.d?0:1},qa=function(t,e){for(var n=0;n<e.planes.length;n++)if(-1===Wa(t,e.planes[n]))return 0;return 1},Xa=function(){for(var t=new Array(8),e=0,n=0,i=0;i<t.length;i++)t[i]=new En(0,0,0);return function(i,r){for(var o=0,a=!1,s=0;s<r.planes.length;s++){if(-1===(o=Wa(i,r.planes[s])))return 0;1===o&&(a=!0)}if(!a)return 1;for(var c=0;c<r.vertices.length;c++)En.subtract(t[c],r.vertices[c],i.center);e=0,n=0;for(var l=0;l<r.vertices.length;l++)t[l].x>i.halfExtents.x?e++:t[l].x<-i.halfExtents.x&&n++;if(e===r.vertices.length||n===r.vertices.length)return 0;e=0,n=0;for(var u=0;u<r.vertices.length;u++)t[u].y>i.halfExtents.y?e++:t[u].y<-i.halfExtents.y&&n++;if(e===r.vertices.length||n===r.vertices.length)return 0;e=0,n=0;for(var h=0;h<r.vertices.length;h++)t[h].z>i.halfExtents.z?e++:t[h].z<-i.halfExtents.z&&n++;return e===r.vertices.length||n===r.vertices.length?0:1}}(),Ya=(Ua=new En(0,0,0),ka=new Rn,function(t,e){return En.subtract(Ua,e,t.center),En.transformMat3(Ua,Ua,Rn.transpose(ka,t.orientation)),n=Ua,i=t.halfExtents,Math.abs(n.x)<i.x&&Math.abs(n.y)<i.y&&Math.abs(n.z)<i.z;var n,i}),Ka=(Ha=function(t,e,n,i){return Math.abs(t.x*e+t.y*n+t.z*i)},function(t,e){var n=t.halfExtents.x*Ha(e.n,t.orientation.m00,t.orientation.m01,t.orientation.m02)+t.halfExtents.y*Ha(e.n,t.orientation.m03,t.orientation.m04,t.orientation.m05)+t.halfExtents.z*Ha(e.n,t.orientation.m06,t.orientation.m07,t.orientation.m08),i=En.dot(e.n,t.center);return i+n<e.d?-1:i-n>e.d?0:1}),Ja=function(t,e){for(var n=0;n<e.planes.length;n++)if(-1===Ka(t,e.planes[n]))return 0;return 1},Qa=function(){for(var t=new Array(8),e=0,n=0,i=0,r=0;r<t.length;r++)t[r]=new En(0,0,0);var o=function(t,e,n,i){return t.x*e+t.y*n+t.z*i};return function(r,a){for(var s=0,c=!1,l=0;l<a.planes.length;l++){if(-1===(s=Ka(r,a.planes[l])))return 0;1===s&&(c=!0)}if(!c)return 1;for(var u=0;u<a.vertices.length;u++)En.subtract(t[u],a.vertices[u],r.center);n=0,i=0;for(var h=0;h<a.vertices.length;h++)(e=o(t[h],r.orientation.m00,r.orientation.m01,r.orientation.m02))>r.halfExtents.x?n++:e<-r.halfExtents.x&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var _=0;_<a.vertices.length;_++)(e=o(t[_],r.orientation.m03,r.orientation.m04,r.orientation.m05))>r.halfExtents.y?n++:e<-r.halfExtents.y&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var f=0;f<a.vertices.length;f++)(e=o(t[f],r.orientation.m06,r.orientation.m07,r.orientation.m08))>r.halfExtents.z?n++:e<-r.halfExtents.z&&i++;return n===a.vertices.length||i===a.vertices.length?0:1}}(),Za=function(){for(var t=new Array(15),e=0;e<15;e++)t[e]=new En(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new En(0,0,0),i[r]=new En(0,0,0);return function(e,r){En.set(t[0],e.orientation.m00,e.orientation.m01,e.orientation.m02),En.set(t[1],e.orientation.m03,e.orientation.m04,e.orientation.m05),En.set(t[2],e.orientation.m06,e.orientation.m07,e.orientation.m08),En.set(t[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),En.set(t[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),En.set(t[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var o=0;o<3;++o)En.cross(t[6+3*o],t[o],t[3]),En.cross(t[7+3*o],t[o],t[4]),En.cross(t[8+3*o],t[o],t[5]);Ga(e.center,e.halfExtents,t[0],t[1],t[2],n),Ga(r.center,r.halfExtents,t[3],t[4],t[5],i);for(var a=0;a<15;++a){var s=Va(n,t[a]),c=Va(i,t[a]);if(c[0]>s[1]||s[0]>c[1])return 0}return 1}}(),$a=function(){for(var t=new ra,e=new En,n=new En,i=new En,r=new Array(8),o=0;o<8;o++)r[o]=new En;for(var a=new Array(8),s=0;s<8;s++)a[s]=new En;return function(o,s){if(0===En.squaredDistance(s.ellipseCenter0,s.ellipseCenter1))return t.radius=s.radius,t.center.set(s.ellipseCenter0),cs.sphereOBB(t,o);e.x=o.orientation.m00,e.y=o.orientation.m01,e.z=o.orientation.m02,n.x=o.orientation.m03,n.y=o.orientation.m04,n.z=o.orientation.m05,i.x=o.orientation.m06,i.y=o.orientation.m07,i.z=o.orientation.m08,Ga(o.center,o.halfExtents,e,n,i,r);var c=a,l=En.copy(c[0],e),u=En.copy(c[1],n),h=En.copy(c[2],i);En.subtract(c[3],s.center,o.center).normalize();var _=En.subtract(c[4],s.ellipseCenter0,s.ellipseCenter1);_.normalize(),En.cross(c[5],l,_),En.cross(c[6],u,_),En.cross(c[7],h,_);for(var f=0;f<8;++f){var p=Va(r,c[f]),d=En.dot(c[f],s.ellipseCenter0),m=En.dot(c[f],s.ellipseCenter1),v=Math.max(d,m),g=Math.min(d,m)-s.radius,y=v+s.radius;if(g>p[1]||p[0]>y)return 0}return 1}}(),ts=function(t,e){var n=En.dot(e.n,t.center),i=t.radius*e.n.length();return n+i<e.d?-1:n-i>e.d?0:1},es=function(t,e){for(var n=0;n<e.planes.length;n++)if(-1===ts(t,e.planes[n]))return 0;return 1},ns=function(){var t=new En(0,0,0),e=[1,-1,1,-1,1,-1];return function(n,i){for(var r=0;r<6;r++){var o=i.planes[r],a=n.radius,s=n.center,c=o.n,l=o.d,u=En.dot(c,s);if(u+a<l)return 0;if(!(u-a>l)){En.add(t,s,En.multiplyScalar(t,c,a));for(var h=0;h<6;h++)if(h!==r&&h!==r+e[r]){var _=i.planes[h];if(En.dot(_.n,t)<_.d)return 0}}}return 1}}(),is=function(t,e){var n=t.radius+e.radius;return En.squaredDistance(t.center,e.center)<n*n},rs=function(){var t=new En;return function(e,n){return qo(t,e.center,n),En.squaredDistance(e.center,t)<e.radius*e.radius}}(),os=function(){var t=new En;return function(e,n){return Xo(t,e.center,n),En.squaredDistance(e.center,t)<e.radius*e.radius}}(),as=function(){var t=new En,e=new En;return function(n,i){var r=n.radius+i.radius,o=r*r,a=En.squaredDistance(i.ellipseCenter0,i.ellipseCenter1);if(0===a)return En.squaredDistance(n.center,i.center)<o;En.subtract(t,n.center,i.ellipseCenter0),En.subtract(e,i.ellipseCenter1,i.ellipseCenter0);var s=En.dot(t,e)/a;return s<0?En.squaredDistance(n.center,i.ellipseCenter0)<o:s>1?En.squaredDistance(n.center,i.ellipseCenter1)<o:(En.scaleAndAdd(t,i.ellipseCenter0,e,s),En.squaredDistance(n.center,t)<o)}}(),ss=function(){var t=new En,e=new En,n=new En,i=new En,r=new En,o=new En;return function(a,s){var c,l,u=En.subtract(t,a.ellipseCenter1,a.ellipseCenter0),h=En.subtract(e,s.ellipseCenter1,s.ellipseCenter0),_=En.subtract(n,a.ellipseCenter0,s.ellipseCenter0),f=En.dot(u,u),p=En.dot(u,h),d=En.dot(h,h),m=En.dot(u,_),v=En.dot(h,_),g=f*d-p*p,y=g,x=g;g<en?(c=0,y=1,l=v,x=d):(l=f*v-p*m,(c=p*v-d*m)<0?(c=0,l=v,x=d):c>y&&(c=y,l=v+p,x=d)),l<0?(l=0,-m<0?c=0:-m>f?c=y:(c=-m,y=f)):l>x&&(l=x,-m+p<0?c=0:-m+p>f?c=y:(c=-m+p,y=f));var S=Math.abs(c)<en?0:c/y,C=Math.abs(l)<en?0:l/x,A=i;A.set(_),A.add(En.multiplyScalar(r,u,S)),A.subtract(En.multiplyScalar(o,h,C));var b=a.radius+s.radius;return A.lengthSqr()<b*b}}(),cs={raySphere:ma,rayAABB:va,rayOBB:Aa,rayPlane:pa,rayTriangle:da,rayCapsule:ba,raySubMesh:Ta,rayMesh:Ea,rayModel:wa,lineSphere:Ma,lineAABB:Da,lineOBB:Ba,linePlane:Pa,lineTriangle:Ia,sphereWithSphere:is,sphereAABB:rs,sphereOBB:os,spherePlane:ts,sphereFrustum:es,sphereFrustumAccurate:ns,sphereCapsule:as,aabbWithAABB:za,aabbWithOBB:ja,aabbPlane:Wa,aabbFrustum:qa,aabbFrustumAccurate:Xa,obbWithOBB:Za,obbPlane:Ka,obbFrustum:Ja,obbFrustumAccurate:Qa,obbPoint:Ya,obbCapsule:$a,capsuleWithCapsule:ss,resolve:function(t,e,n){void 0===n&&(n=null);var i=t._type,r=e._type,o=this[i|r];return i<r?o(t,e,n):o(e,t,n)}};cs[Ko.SHAPE_RAY|Ko.SHAPE_SPHERE]=ma,cs[Ko.SHAPE_RAY|Ko.SHAPE_AABB]=va,cs[Ko.SHAPE_RAY|Ko.SHAPE_OBB]=Aa,cs[Ko.SHAPE_RAY|Ko.SHAPE_PLANE]=pa,cs[Ko.SHAPE_RAY|Ko.SHAPE_TRIANGLE]=da,cs[Ko.SHAPE_RAY|Ko.SHAPE_CAPSULE]=ba,cs[Ko.SHAPE_LINE|Ko.SHAPE_SPHERE]=Ma,cs[Ko.SHAPE_LINE|Ko.SHAPE_AABB]=Da,cs[Ko.SHAPE_LINE|Ko.SHAPE_OBB]=Ba,cs[Ko.SHAPE_LINE|Ko.SHAPE_PLANE]=Pa,cs[Ko.SHAPE_LINE|Ko.SHAPE_TRIANGLE]=Ia,cs[Ko.SHAPE_SPHERE]=is,cs[Ko.SHAPE_SPHERE|Ko.SHAPE_AABB]=rs,cs[Ko.SHAPE_SPHERE|Ko.SHAPE_OBB]=os,cs[Ko.SHAPE_SPHERE|Ko.SHAPE_PLANE]=ts,cs[Ko.SHAPE_SPHERE|Ko.SHAPE_FRUSTUM]=es,cs[Ko.SHAPE_SPHERE|Ko.SHAPE_FRUSTUM_ACCURATE]=ns,cs[Ko.SHAPE_SPHERE|Ko.SHAPE_CAPSULE]=as,cs[Ko.SHAPE_AABB]=za,cs[Ko.SHAPE_AABB|Ko.SHAPE_OBB]=ja,cs[Ko.SHAPE_AABB|Ko.SHAPE_PLANE]=Wa,cs[Ko.SHAPE_AABB|Ko.SHAPE_FRUSTUM]=qa,cs[Ko.SHAPE_AABB|Ko.SHAPE_FRUSTUM_ACCURATE]=Xa,cs[Ko.SHAPE_OBB]=Za,cs[Ko.SHAPE_OBB|Ko.SHAPE_PLANE]=Ka,cs[Ko.SHAPE_OBB|Ko.SHAPE_FRUSTUM]=Ja,cs[Ko.SHAPE_OBB|Ko.SHAPE_FRUSTUM_ACCURATE]=Qa,cs[Ko.SHAPE_OBB|Ko.SHAPE_CAPSULE]=$a,cs[Ko.SHAPE_CAPSULE]=ss,z(Jo.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),G(cs,"intersect",[{name:"line_quad"}]);var ls,us,hs,_s,fs,ps,ds,ms=new En(0,0,0),vs=new En(0,0,0),gs=c.mat4(),ys=c.v4(),xs=function(){function t(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=1),void 0===n&&(n=0),void 0===i&&(i=0),this.n=void 0,this.d=void 0,this._type=void 0,this._type=Ko.SHAPE_PLANE,this.n=new En(t,e,n),this.d=i}return t.create=function(e,n,i,r){return new t(e,n,i,r)},t.clone=function(e){return new t(e.n.x,e.n.y,e.n.z,e.d)},t.copy=function(t,e){return En.copy(t.n,e.n),t.d=e.d,t},t.fromPoints=function(t,e,n,i){return En.subtract(ms,n,e),En.subtract(vs,i,e),En.normalize(t.n,En.cross(t.n,ms,vs)),t.d=En.dot(t.n,e),t},t.set=function(t,e,n,i,r){return t.n.x=e,t.n.y=n,t.n.z=i,t.d=r,t},t.fromNormalAndPoint=function(t,e,n){return En.copy(t.n,e),t.d=En.dot(e,n),t},t.normalize=function(t,e){var n=e.n.length();return En.normalize(t.n,e.n),n>0&&(t.d=e.d/n),t},t.prototype.transform=function(t){Un.invert(gs,t),Un.transpose(gs,gs),Kn.set(ys,this.n.x,this.n.y,this.n.z,this.d),Kn.transformMat4(ys,ys,gs),En.set(this.n,ys.x,ys.y,ys.z),this.d=ys.w},K(t,[{key:"type",get:function(){return this._type}},{key:"x",get:function(){return this.n.x},set:function(t){this.n.x=t}},{key:"y",get:function(){return this.n.y},set:function(t){this.n.y=t}},{key:"z",get:function(){return this.n.z},set:function(t){this.n.z=t}},{key:"w",get:function(){return this.d},set:function(t){this.d=t}}]),t}(),Ss=function(){function t(t,e,n){this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=n*(1<<e)}return t.prototype.allocateNewChunk=function(){return new ArrayBuffer(this._chunkSize)},t}();!function(t){t[t.UINT32=0]="UINT32",t[t.FLOAT32=1]="FLOAT32",t[t.NEVER=2]="NEVER"}(ds||(ds={}));var Cs,As,bs=function(){function t(t,e,n,i,r){void 0===r&&(r=8),this._dataType=void 0,this._dataMembers=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freeLists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=i.COUNT,this._entryBits=r,this._dataType=e,this._dataMembers=n,this._stride=4*this._elementCount,this._entriesPerChunk=1<<r,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new Ss(t,r,this._stride);var o=ds.NEVER,a=!1,s=!1;for(var c in e){if(a=this._hasFloat32,(s=this._hasUint32)&&a)break;o=e[c],a||o!==ds.FLOAT32?s||o!==ds.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}var e=t.prototype;return e.alloc=function(){for(var t=0;t<this._freeLists.length;t++){var e=this._freeLists[t];if(e.length){var n=e[e.length-1];return e.length--,(t<<this._entryBits)+n+this._poolFlag}}for(var i=this._nativePool.allocateNewChunk(),r=[],o=[],a=[],s=this._hasFloat32,c=this._hasUint32,l=0;l<this._entriesPerChunk;l++)s&&r.push(new Float32Array(i,this._stride*l,this._elementCount)),c&&o.push(new Uint32Array(i,this._stride*l,this._elementCount)),l&&a.push(l);return c&&this._uint32BufferViews.push(o),s&&this._float32BufferViews.push(r),this._freeLists.push(a),this._arrayBuffers.push(i),(t<<this._entryBits)+this._poolFlag},e.getBuffer=function(t){var e=(this._chunkMask&t)>>this._entryBits,n=this._entryMask&t;return(this._hasFloat32?this._float32BufferViews:this._uint32BufferViews)[e][n]},e.getTypedArray=function(t,e){var n=(this._chunkMask&t)>>this._entryBits,i=this._entryMask&t,r=e,o=(this._dataType[e]===ds.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][i],a=this._dataMembers[e];return o.subarray(r,r+a)},e.free=function(t){var e=(this._chunkMask&t)>>this._entryBits,n=this._entryMask&t;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[e][n].fill(0),this._freeLists[e].push(n)},t}();!function(t){t[t.NODE=0]="NODE",t[t.PASS=1]="PASS",t[t.AABB=2]="AABB"}(Cs||(Cs={})),function(t){t[t.DIRTY_FLAG=0]="DIRTY_FLAG",t[t.LAYER=1]="LAYER",t[t.WORLD_SCALE=2]="WORLD_SCALE",t[t.WORLD_POSITION=5]="WORLD_POSITION",t[t.WORLD_ROTATION=8]="WORLD_ROTATION",t[t.WORLD_MATRIX=12]="WORLD_MATRIX",t[t.LOCAL_SCALE=28]="LOCAL_SCALE",t[t.LOCAL_POSITION=31]="LOCAL_POSITION",t[t.LOCAL_ROTATION=34]="LOCAL_ROTATION",t[t.COUNT=38]="COUNT"}(As||(As={}));var Ts,Es=((ls={})[As.DIRTY_FLAG]=ds.UINT32,ls[As.LAYER]=ds.UINT32,ls[As.WORLD_SCALE]=ds.FLOAT32,ls[As.WORLD_POSITION]=ds.FLOAT32,ls[As.WORLD_ROTATION]=ds.FLOAT32,ls[As.WORLD_MATRIX]=ds.FLOAT32,ls[As.LOCAL_SCALE]=ds.FLOAT32,ls[As.LOCAL_POSITION]=ds.FLOAT32,ls[As.LOCAL_ROTATION]=ds.FLOAT32,ls[As.COUNT]=ds.NEVER,ls),ws=((us={})[As.DIRTY_FLAG]=As.LAYER-As.DIRTY_FLAG,us[As.LAYER]=As.WORLD_SCALE-As.LAYER,us[As.WORLD_SCALE]=As.WORLD_POSITION-As.WORLD_SCALE,us[As.WORLD_POSITION]=As.WORLD_ROTATION-As.WORLD_POSITION,us[As.WORLD_ROTATION]=As.WORLD_MATRIX-As.WORLD_ROTATION,us[As.WORLD_MATRIX]=As.LOCAL_SCALE-As.WORLD_MATRIX,us[As.LOCAL_SCALE]=As.LOCAL_POSITION-As.LOCAL_SCALE,us[As.LOCAL_POSITION]=As.LOCAL_ROTATION-As.LOCAL_POSITION,us[As.LOCAL_ROTATION]=As.COUNT-As.LOCAL_ROTATION,us[As.COUNT]=1,us),Ps=new bs(Cs.NODE,Es,ws,As);!function(t){t[t.PRIORITY=0]="PRIORITY",t[t.STAGE=1]="STAGE",t[t.PHASE=2]="PHASE",t[t.PRIMITIVE=3]="PRIMITIVE",t[t.BATCHING_SCHEME=4]="BATCHING_SCHEME",t[t.DYNAMIC_STATE=5]="DYNAMIC_STATE",t[t.HASH=6]="HASH",t[t.COUNT=7]="COUNT"}(Ts||(Ts={}));var Is,Rs=((hs={})[Ts.PRIORITY]=ds.UINT32,hs[Ts.STAGE]=ds.UINT32,hs[Ts.PHASE]=ds.UINT32,hs[Ts.PRIMITIVE]=ds.UINT32,hs[Ts.BATCHING_SCHEME]=ds.UINT32,hs[Ts.DYNAMIC_STATE]=ds.UINT32,hs[Ts.HASH]=ds.UINT32,hs[Ts.COUNT]=ds.NEVER,hs),Ds=((_s={})[Ts.PRIORITY]=Ts.STAGE-Ts.PRIORITY,_s[Ts.STAGE]=Ts.PHASE-Ts.STAGE,_s[Ts.PHASE]=Ts.PRIMITIVE-Ts.PHASE,_s[Ts.PRIMITIVE]=Ts.BATCHING_SCHEME-Ts.PRIMITIVE,_s[Ts.BATCHING_SCHEME]=Ts.DYNAMIC_STATE-Ts.BATCHING_SCHEME,_s[Ts.DYNAMIC_STATE]=Ts.HASH-Ts.DYNAMIC_STATE,_s[Ts.HASH]=Ts.COUNT-Ts.HASH,_s[Ts.COUNT]=1,_s),Bs=new bs(Cs.PASS,Rs,Ds,Ts);!function(t){t[t.CENTER=0]="CENTER",t[t.HALFEXTENTS=3]="HALFEXTENTS",t[t.COUNT=6]="COUNT"}(Is||(Is={}));var Ms=((fs={})[Is.CENTER]=ds.FLOAT32,fs[Is.HALFEXTENTS]=ds.FLOAT32,fs[Is.COUNT]=ds.NEVER,fs),Os=((ps={})[Is.CENTER]=Is.HALFEXTENTS-Is.CENTER,ps[Is.HALFEXTENTS]=Is.COUNT-Is.HALFEXTENTS,ps[Is.COUNT]=1,ps),Ns=new bs(Cs.AABB,Ms,Os,Is),Ls=new En,Fs=new En,zs=new En,Gs=new En,Vs=new Rn,Us=function(t,e,n){Vs.m00=Math.abs(n.m00),Vs.m01=Math.abs(n.m01),Vs.m02=Math.abs(n.m02),Vs.m03=Math.abs(n.m04),Vs.m04=Math.abs(n.m05),Vs.m05=Math.abs(n.m06),Vs.m06=Math.abs(n.m08),Vs.m07=Math.abs(n.m09),Vs.m08=Math.abs(n.m10),En.transformMat3(t,e,Vs)},ks=function(){function t(t,e,n,i,r,o){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._aabbHandle=0,this._type=Ko.SHAPE_AABB,this.center=new En(t,e,n),this.halfExtents=new En(i,r,o)}t.create=function(e,n,i,r,o,a){return new t(e,n,i,r,o,a)},t.clone=function(e){return new t(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z)},t.copy=function(t,e){return En.copy(t.center,e.center),En.copy(t.halfExtents,e.halfExtents),t},t.fromPoints=function(t,e,n){return En.add(Ls,n,e),En.subtract(Fs,n,e),En.multiplyScalar(t.center,Ls,.5),En.multiplyScalar(t.halfExtents,Fs,.5),t},t.set=function(t,e,n,i,r,o,a){return t.center.set(e,n,i),t.halfExtents.set(r,o,a),t},t.merge=function(e,n,i){return En.subtract(Ls,n.center,n.halfExtents),En.subtract(Fs,i.center,i.halfExtents),En.add(zs,n.center,n.halfExtents),En.add(Gs,i.center,i.halfExtents),En.max(Gs,zs,Gs),En.min(zs,Ls,Fs),t.fromPoints(e,zs,Gs)},t.toBoundingSphere=function(t,e){return t.center.set(e.center),t.radius=e.halfExtents.length(),t},t.transform=function(t,e,n){return En.transformMat4(t.center,e.center,n),Us(t.halfExtents,e.halfExtents,n),t};var e=t.prototype;return e.getBoundary=function(t,e){En.subtract(t,this.center,this.halfExtents),En.add(e,this.center,this.halfExtents)},e.transform=function(t,e,n,i,r){En.transformMat4(r.center,this.center,t),Us(r.halfExtents,this.halfExtents,t)},e.clone=function(){return t.clone(this)},e.copy=function(e){return t.copy(this,e)},e.mergePoint=function(t){this.getBoundary(Ls,Fs),t.x<Ls.x&&(Ls.x=t.x),t.y<Ls.y&&(Ls.y=t.y),t.z<Ls.z&&(Ls.z=t.z),t.x>Fs.x&&(Fs.x=t.x),t.y>Fs.y&&(Fs.y=t.y),t.z>Fs.z&&(Fs.z=t.z),En.add(zs,Ls,Fs),this.center.set(En.multiplyScalar(zs,zs,.5)),this.halfExtents.set(Fs.x-zs.x,Fs.y-zs.y,Fs.z-zs.z)},e.mergePoints=function(t){if(!(t.length<1))for(var e=0;e<t.length;e++)this.mergePoint(t[e])},e.mergeFrustum=function(t){return this.mergePoints(t.vertices)},K(t,[{key:"type",get:function(){return this._type}},{key:"native",get:function(){return this._nativeObj}}]),t}(),Hs=new En,js=new En,Ws=new Rn,qs=function(){function t(t,e,n,i,r,o,a,s,c,l,u,h,_,f,p){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===p&&(p=1),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=Ko.SHAPE_OBB,this.center=new En(t,e,n),this.halfExtents=new En(i,r,o),this.orientation=new Rn(a,s,c,l,u,h,_,f,p)}t.create=function(e,n,i,r,o,a,s,c,l,u,h,_,f,p,d){return new t(e,n,i,r,o,a,s,c,l,u,h,_,f,p,d)},t.clone=function(e){return new t(e.center.x,e.center.y,e.center.z,e.halfExtents.x,e.halfExtents.y,e.halfExtents.z,e.orientation.m00,e.orientation.m01,e.orientation.m02,e.orientation.m03,e.orientation.m04,e.orientation.m05,e.orientation.m06,e.orientation.m07,e.orientation.m08)},t.copy=function(t,e){return En.copy(t.center,e.center),En.copy(t.halfExtents,e.halfExtents),Rn.copy(t.orientation,e.orientation),t},t.fromPoints=function(t,e,n){return En.multiplyScalar(t.center,En.add(Hs,e,n),.5),En.multiplyScalar(t.halfExtents,En.subtract(js,n,e),.5),Rn.identity(t.orientation),t},t.set=function(t,e,n,i,r,o,a,s,c,l,u,h,_,f,p,d){return En.set(t.center,e,n,i),En.set(t.halfExtents,r,o,a),Rn.set(t.orientation,s,c,l,u,h,_,f,p,d),t};var e=t.prototype;return e.getBoundary=function(t,e){!function(t,e,n){Ws.m00=Math.abs(n.m00),Ws.m01=Math.abs(n.m01),Ws.m02=Math.abs(n.m02),Ws.m03=Math.abs(n.m03),Ws.m04=Math.abs(n.m04),Ws.m05=Math.abs(n.m05),Ws.m06=Math.abs(n.m06),Ws.m07=Math.abs(n.m07),Ws.m08=Math.abs(n.m08),En.transformMat3(t,e,Ws)}(Hs,this.halfExtents,this.orientation),En.subtract(t,this.center,Hs),En.add(e,this.center,Hs)},e.transform=function(t,e,n,i,r){En.transformMat4(r.center,this.center,t),Rn.fromQuat(r.orientation,n),En.multiply(r.halfExtents,this.halfExtents,i)},e.translateAndRotate=function(t,e,n){En.transformMat4(n.center,this.center,t),Rn.fromQuat(n.orientation,e)},e.setScale=function(t,e){En.multiply(e.halfExtents,this.halfExtents,t)},K(t,[{key:"type",get:function(){return this._type}}]),t}(),Xs=function(){function t(t,e,n){void 0===t&&(t=.5),void 0===e&&(e=.5),void 0===n&&(n=1),this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=Ko.SHAPE_CAPSULE,this.radius=t,this.halfHeight=e,this.axis=n,this.center=new En,this.rotation=new Mn,this.ellipseCenter0=new En(0,e,0),this.ellipseCenter1=new En(0,-e,0),this.updateCache()}var e=t.prototype;return e.transform=function(t,e,n,i,r){var o=i,a=xn(o);r.radius=this.radius*Math.abs(a);var s=(this.halfHeight+this.radius)*Math.abs(o.y)-r.radius;s<0&&(s=0),r.halfHeight=s,En.transformMat4(r.center,this.center,t),Mn.multiply(r.rotation,this.rotation,n),r.updateCache()},e.updateCache=function(){this.updateLocalCenter(),En.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),En.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)},e.updateLocalCenter=function(){var t=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(t,0,0),this.ellipseCenter1.set(-t,0,0);break;case 1:this.ellipseCenter0.set(0,t,0),this.ellipseCenter1.set(0,-t,0);break;case 2:this.ellipseCenter0.set(0,0,t),this.ellipseCenter1.set(0,0,-t)}},K(t,[{key:"type",get:function(){return this._type}}]),t}(),Ys=new Array(8);Ys[0]=new En(1,1,1),Ys[1]=new En(-1,1,1),Ys[2]=new En(-1,-1,1),Ys[3]=new En(1,-1,1),Ys[4]=new En(1,1,-1),Ys[5]=new En(-1,1,-1),Ys[6]=new En(-1,-1,-1),Ys[7]=new En(1,-1,-1);var Ks,Js,Qs=new En,Zs=new En,$s=new En,tc=function(){function t(){this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=Ko.SHAPE_FRUSTUM,this.planes=new Array(6);for(var t=0;t<6;++t)this.planes[t]=xs.create(0,0,0,0);this.vertices=new Array(8);for(var e=0;e<8;++e)this.vertices[e]=new En}t.createFromAABB=function(t,e){var n=new En,i=new En;return En.subtract(n,e.center,e.halfExtents),En.add(i,e.center,e.halfExtents),t.vertices[0].set(n.x,i.y,n.z),t.vertices[1].set(i.x,i.y,n.z),t.vertices[2].set(i.x,n.y,n.z),t.vertices[3].set(n.x,n.y,n.z),t.vertices[4].set(n.x,i.y,i.z),t.vertices[5].set(i.x,i.y,i.z),t.vertices[6].set(i.x,n.y,i.z),t.vertices[7].set(n.x,n.y,i.z),t._type!==Ko.SHAPE_FRUSTUM_ACCURATE||t.updatePlanes(),t},t.split=function(t,e,n,i,r){var o=Math.tan(.5*e.fov),a=o*e.aspect;Qs.set(i*a,i*o,i),Zs.set(r*a,r*o,r);var s=t.vertices;return $s.set(Qs.x,Qs.y,Qs.z),En.transformMat4(s[0],$s,n),$s.set(-Qs.x,Qs.y,Qs.z),En.transformMat4(s[1],$s,n),$s.set(-Qs.x,-Qs.y,Qs.z),En.transformMat4(s[2],$s,n),$s.set(Qs.x,-Qs.y,Qs.z),En.transformMat4(s[3],$s,n),$s.set(Zs.x,Zs.y,Zs.z),En.transformMat4(s[4],$s,n),$s.set(-Zs.x,Zs.y,Zs.z),En.transformMat4(s[5],$s,n),$s.set(-Zs.x,-Zs.y,Zs.z),En.transformMat4(s[6],$s,n),$s.set(Zs.x,-Zs.y,Zs.z),En.transformMat4(s[7],$s,n),t.updatePlanes(),t},t.create=function(){return new t},t.clone=function(e){return t.copy(new t,e)},t.copy=function(t,e){t._type=e._type;for(var n=0;n<6;++n)xs.copy(t.planes[n],e.planes[n]);for(var i=0;i<8;++i)En.copy(t.vertices[i],e.vertices[i]);return t};var e=t.prototype;return e.update=function(t,e){if(En.set(this.planes[0].n,t.m03+t.m00,t.m07+t.m04,t.m11+t.m08),this.planes[0].d=-(t.m15+t.m12),En.set(this.planes[1].n,t.m03-t.m00,t.m07-t.m04,t.m11-t.m08),this.planes[1].d=-(t.m15-t.m12),En.set(this.planes[2].n,t.m03+t.m01,t.m07+t.m05,t.m11+t.m09),this.planes[2].d=-(t.m15+t.m13),En.set(this.planes[3].n,t.m03-t.m01,t.m07-t.m05,t.m11-t.m09),this.planes[3].d=-(t.m15-t.m13),En.set(this.planes[4].n,t.m03+t.m02,t.m07+t.m06,t.m11+t.m10),this.planes[4].d=-(t.m15+t.m14),En.set(this.planes[5].n,t.m03-t.m02,t.m07-t.m06,t.m11-t.m10),this.planes[5].d=-(t.m15-t.m14),this._type===Ko.SHAPE_FRUSTUM_ACCURATE){for(var n=0;n<6;n++){var i=this.planes[n],r=1/i.n.length();En.multiplyScalar(i.n,i.n,r),i.d*=r}for(var o=0;o<8;o++)En.transformMat4(this.vertices[o],Ys[o],e)}},e.transform=function(t){if(this._type===Ko.SHAPE_FRUSTUM_ACCURATE){for(var e=0;e<8;e++)En.transformMat4(this.vertices[e],this.vertices[e],t);xs.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),xs.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),xs.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),xs.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),xs.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),xs.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])}},e.updatePlanes=function(){xs.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),xs.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),xs.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),xs.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),xs.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),xs.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])},K(t,[{key:"accurate",set:function(t){this._type=t?Ko.SHAPE_FRUSTUM_ACCURATE:Ko.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}}]),t}();tc.createOrtho=function(t,e,n,i,r,o){var a=e/2,s=n/2;En.set($s,a,s,-i),En.transformMat4(t.vertices[0],$s,o),En.set($s,-a,s,-i),En.transformMat4(t.vertices[1],$s,o),En.set($s,-a,-s,-i),En.transformMat4(t.vertices[2],$s,o),En.set($s,a,-s,-i),En.transformMat4(t.vertices[3],$s,o),En.set($s,a,s,-r),En.transformMat4(t.vertices[4],$s,o),En.set($s,-a,s,-r),En.transformMat4(t.vertices[5],$s,o),En.set($s,-a,-s,-r),En.transformMat4(t.vertices[6],$s,o),En.set($s,a,-s,-r),En.transformMat4(t.vertices[7],$s,o),xs.fromPoints(t.planes[0],t.vertices[1],t.vertices[6],t.vertices[5]),xs.fromPoints(t.planes[1],t.vertices[3],t.vertices[4],t.vertices[7]),xs.fromPoints(t.planes[2],t.vertices[6],t.vertices[3],t.vertices[7]),xs.fromPoints(t.planes[3],t.vertices[0],t.vertices[5],t.vertices[4]),xs.fromPoints(t.planes[4],t.vertices[2],t.vertices[0],t.vertices[3]),xs.fromPoints(t.planes[5],t.vertices[7],t.vertices[5],t.vertices[6])},function(t){t[t.Default=0]="Default",t[t.Normal=1]="Normal",t[t.Loop=2]="Loop",t[t.ShouldWrap=4]="ShouldWrap",t[t.Clamp=8]="Clamp",t[t.PingPong=22]="PingPong",t[t.Reverse=36]="Reverse"}(Ks||(Ks={})),function(t){t[t.Default=Ks.Default]="Default",t[t.Normal=Ks.Normal]="Normal",t[t.Reverse=Ks.Reverse]="Reverse",t[t.Loop=Ks.Loop]="Loop",t[t.LoopReverse=Ks.Loop|Ks.Reverse]="LoopReverse",t[t.PingPong=Ks.PingPong]="PingPong",t[t.PingPongReverse=Ks.PingPong|Ks.Reverse]="PingPongReverse"}(Js||(Js={})),ae(Js);var ec=function(){function t(t){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,t&&this.set(t)}return t.prototype.set=function(t){this.ratio=t.ratio,this.time=t.time,this.direction=t.direction,this.stopped=t.stopped,this.iterations=t.iterations,this.frameIndex=t.frameIndex},t}();function nc(t,e,n){void 0===n&&(n=1e-6);for(var i=0,r=t.length-1,o=r>>>1;i<=r;o=i+r>>>1){var a=t[o];if(a>e+n)r=o-1;else{if(!(a<e-n))return o;i=o+1}}return~i}var ic=function(){},rc=function(){return ic},oc=ac((function(){}));function ac(t){return function(e){return"function"==typeof e?t(e):function(n){return t(n,e)}}}function sc(t){return function(e){return function(n){!function(t,e,n){var i=lc(t);if(i){var r=uc(i,"proto");uc(r,"editor")[e]=n}}(n,t,e)}}}var cc="__ccclassCache__";function lc(t){return uc(t,cc)}function uc(t,e){return t[e]||(t[e]={})}var hc=ac((function(t,e){var n=ee.getSuper(t);n===Object&&(n=null);var i={name:e,extends:n,ctor:t},r=t[cc];if(r){var o=r.proto;o&&ee.mixin(i,o),t[cc]=void 0}return Je(i)})),_c=sc("requireComponent"),fc=sc("executionOrder"),pc=oc;function dc(t,e,n){var i=null;function r(t,e,n){var r=lc(t.constructor);if(r){var o=uc(r,"proto"),a=uc(o,"properties");!function(t,e,n,i,r,o){var a,s=r&&(r.get||r.set);i&&(a=Ve(i,s));var c=e[n],l=ee.mixin(c||{},a||i||{});if(s)r.get&&(l.get=r.get),r.set&&(l.set=r.set);else if(r)r.initializer&&(l.default=function(t){var e;try{e=t()}catch(e){return t}return"object"!=typeof e||null===e?e:t}(r.initializer));else{var u=o.default||(o.default=function(t){var e;try{e=new t}catch(t){return{}}return e}(t));u.hasOwnProperty(n)&&(l.default=u[n])}e[n]=l}(t.constructor,a,e,i,n,r)}}return void 0===t?dc({type:void 0}):void 0===e?(i=t,r):void r(t,e,n)}var mc=Symbol("cc:SerializationMetadata"),vc=function(t,e,n){return dc(xc({}))(t,e,n)};function gc(t){return dc(xc({formerlySerializedAs:t}))}var yc=function(t,e,n){return dc({editorOnly:!0})(t,e,n)};function xc(t){return t.__noImplicit=!0,"serializable"in t||(t.serializable=!0),t}var Sc=ic,Cc=oc,Ac=rc,bc=oc,Tc=rc,Ec=rc,wc=rc,Pc=ic,Ic=rc,Rc=ic,Dc=rc,Bc=rc,Mc=rc,Oc=rc,Nc=rc,Lc=rc,Fc=ic,zc=rc,Gc=ic,Vc=ic,Uc=Wc(Re),kc=Wc(De),Hc=Wc(Be),jc=Wc(Me);function Wc(t){return dc({type:t})}var qc,Xc,Yc,Kc,Jc,Qc,Zc,$c,tl,el=function(t,e,n){return dc({__noImplicit:!0,override:!0})(t,e,n)},nl=hc("cc.KeyframeCurve")((qc=Symbol.iterator,Qc=function(){function t(){at(this,"_times",Kc,this),at(this,"_values",Jc,this)}var e=t.prototype;return e[qc]=function(){var t=this,e=0;return{next:function(){if(e>=t._times.length)return{done:!0,value:void 0};var n=[t._times[e],t._values[e]];return++e,{done:!1,value:n}}}},e.keyframes=function(){return this},e.times=function(){return this._times},e.values=function(){return this._values},e.getKeyframeTime=function(t){return this._times[t]},e.getKeyframeValue=function(t){return this._values[t]},e.addKeyFrame=function(t,e){return this._insertNewKeyframe(t,e)},e.removeKeyframe=function(t){this._times.splice(t,1),this._values.splice(t,1)},e.indexOfKeyframe=function(t){return nc(this._times,t)},e.updateTime=function(t,e){var n=this._values[t];this.removeKeyframe(t),this._insertNewKeyframe(e,n)},e.assignSorted=function(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.slice());else{var n=Array.from(t);this.setKeyframes(n.map((function(t){return t[0]})),n.map((function(t){return t[1]})))}},e.clear=function(){this._times.length=0,this._values.length=0},e.searchKeyframe=function(t){return nc(this._times,t)},e.setKeyframes=function(t,e){t.length,e.length,function(t){t.every((function(t,e,n){return 0===e||t>n[e-1]||rn(t,n[e-1],1e-6)}))}(t),this._times=t,this._values=e},e._insertNewKeyframe=function(t,e){var n=this._times,i=this._values,r=n.length,o=nc(n,t);if(o>=0)return o;var a=~o;return 0===a?(n.unshift(t),i.unshift(e)):a===r?(n.push(t),i.push(e)):(n.splice(a-1,0,t),i.splice(a-1,0,e)),a},K(t,[{key:"keyFramesCount",get:function(){return this._times.length}},{key:"rangeMin",get:function(){return this._times[0]}},{key:"rangeMax",get:function(){return this._times[this._values.length-1]}}]),t}(),Kc=st((Yc=Qc).prototype,"_times",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Jc=st(Yc.prototype,"_values",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Xc=Yc))||Xc;function il(t){return t>-1e-9&&t<1e-9}!function(t){t[t.LINEAR=0]="LINEAR",t[t.CONSTANT=1]="CONSTANT",t[t.CUBIC=2]="CUBIC"}(Zc||(Zc=t("RealInterpolationMode",{}))),function(t){t[t.LINEAR=0]="LINEAR",t[t.CLAMP=1]="CLAMP",t[t.LOOP=2]="LOOP",t[t.PING_PONG=3]="PING_PONG"}($c||($c=t("ExtrapolationMode",{}))),function(t){t[t.NONE=0]="NONE",t[t.LEFT=1]="LEFT",t[t.RIGHT=2]="RIGHT",t[t.BOTH=3]="BOTH"}(tl||(tl=t("TangentWeightMode",{})));var rl,ol=t("editorExtrasTag","__editorExtras__"),al=function(){},sl=Object.freeze({__proto__:null,uniquelyReferenced:Sc,ccclass:hc,property:dc,requireComponent:_c,executionOrder:fc,disallowMultiple:pc,allowReplicated:function(t){Je.Attr.setClassAttr(t,"replicated","visible",!0)},executeInEditMode:Cc,menu:Ac,playOnFocus:bc,inspector:Tc,icon:Ec,help:wc,type:Wc,integer:Uc,float:kc,boolean:Hc,string:jc});t("_decorator",sl);var cl=1<<22,ll=[],ul=t("CCObject",function(){function t(t){void 0===t&&(t=""),this._objFlags=void 0,this._name=void 0,this._name=t,this._objFlags=0}t._deferredDestroy=function(){for(var t=ll.length,e=0;e<t;++e){var n=ll[e];1&n._objFlags||n._destroyImmediate()}t===ll.length?ll.length=0:ll.splice(0,t)};var e=t.prototype;return e.destroy=function(){return 1&this._objFlags?(I(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,ll.push(this),0))},e._destruct=function(){var t=this.constructor,e=t.__destruct__;e||(e=function(t,e){var n,i=t instanceof c._BaseNode||t instanceof c.Component,r=i?"_id":null,o={};for(n in t)if(t.hasOwnProperty(n)){if(n===r)continue;switch(typeof t[n]){case"string":o[n]="";break;case"object":case"function":o[n]=null}}if(Je._isCCClass(e))for(var a=c.Class.Attr.getClassAttrs(e),s=e.__props__,l=0;l<s.length;l++){var u=(n=s[l])+c.Class.Attr.DELIMETER+"default";if(u in a){if(i&&"_id"===n)continue;switch(typeof a[u]){case"string":o[n]="";break;case"object":case"function":o[n]=null;break;case"undefined":o[n]=void 0}}}var h="";for(n in o){var _;_=Je.IDENTIFIER_RE.test(n)?"o."+n+"=":"o["+Je.escapeForJS(n)+"]=";var f=o[n];""===f&&(f='""'),h+=_+f+";\n"}return Function("o",h)}(this,t),Ct(t,"__destruct__",e,!0)),e(this)},e._destroyImmediate=function(){1&this._objFlags?D(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)},K(t,[{key:"name",get:function(){return this._name},set:function(t){this._name=t}},{key:"hideFlags",get:function(){return this._objFlags&t.Flags.AllHideMasks},set:function(e){var n=e&t.Flags.AllHideMasks;this._objFlags=this._objFlags&~t.Flags.AllHideMasks|n}},{key:"replicated",get:function(){return!!(this._objFlags&cl)},set:function(t){t?this._objFlags|=cl:this._objFlags&=-4194305}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),t}()),hl=ul.prototype;function _l(t,e){return"object"==typeof t?!(!t||t._objFlags&(e?5:1)):void 0!==t}hl._deserialize=null,hl._onPreDestroy=null,Je.fastDefine("cc.Object",ul,((rl={_name:"",_objFlags:0})[ol]={},rl)),Je.Attr.setClassAttr(ul,ol,"editorOnly",!0),Je.Attr.setClassAttr(ul,"replicated","visible",!1),Ct(ul,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),c.isValid=_l,c.Object=ul;var fl=function(){function t(t){this._map=null,this._count=0,t?(this._map=t,this._count=Object.keys(t).length):(this._map=ee.createMap(!0),this._count=0)}var e=t.prototype;return e.add=function(t,e){return t in this._map||this._count++,this._map[t]=e},e.get=function(t){return this._map[t]},e.has=function(t){return t in this._map},e.remove=function(t){var e=this._map[t];return t in this._map&&(delete this._map[t],this._count--),e},e.clear=function(){0!==this._count&&(this._map=ee.createMap(!0),this._count=0)},e.forEach=function(t){for(var e in this._map)t(this._map[e],e)},e.find=function(t){for(var e in this._map)if(t(this._map[e],e))return this._map[e];return null},e.destroy=function(){this._map=null},K(t,[{key:"count",get:function(){return this._count}}]),t}(),pl=function(){function t(e,n){this.id=t._pipelineId++,this.name="",this.pipes=[],this.name=e;for(var i=0,r=n.length;i<r;i++)this.pipes.push(n[i])}var e=t.prototype;return e.insert=function(t,e){return e>this.pipes.length?(I(4921),this):(this.pipes.splice(e,0,t),this)},e.append=function(t){return this.pipes.push(t),this},e.remove=function(t){return this.pipes.splice(t,1),this},e.sync=function(t){var e=this.pipes;if(0===e.length)return null;t.isFinish=!1;for(var n=0,i=e.length;n<i;){var r=(0,e[n])(t);if(r)return t.isFinish=!0,r;++n!==i&&(t.input=t.output,t.output=null)}return t.isFinish=!0,t.output},e.async=function(t){0!==this.pipes.length&&(t.isFinish=!1,this._flow(0,t))},e._flow=function(t,e){var n=this;(0,this.pipes[t])(e,(function(i){i?(e.isFinish=!0,e.dispatch("complete",i)):++t<n.pipes.length?(e.input=e.output,e.output=null,n._flow(t,e)):(e.isFinish=!0,e.dispatch("complete",i,e.output))}))},t}();pl._pipelineId=0,function(){function t(t){if(this._weakMap={},void 0===window.WeakRef)throw new Error("this platform does not support WeakRef!");if(t)for(var e in t)this._weakMap[e]=new WeakRef(t[e])}var e=t.prototype;e.add=function(t,e){return this._weakMap[t]=new WeakRef(e),e},e.has=function(t){return t in this._weakMap&&!!this._weakMap[t].deref()},e.get=function(t){return this._weakMap[t]&&this._weakMap[t].deref()},e.remove=function(t){var e=this._weakMap[t];return delete this._weakMap[t],e&&e.deref()},e.clear=function(){this._weakMap=ee.createMap(!0)},e.forEach=function(t){for(var e in this._weakMap){var n=this.get(e);n&&t(n,e)}},e.find=function(t){for(var e in this._weakMap){var n=this.get(e);if(n&&t(n,e))return this._weakMap[e].deref()}return null},e.destroy=function(){this._weakMap={}},K(t,[{key:"count",get:function(){return Object.values(this._weakMap).filter((function(t){return t.deref()})).length}}])}();var dl,ml=new fl,vl=new fl,gl=new fl,yl=new fl,xl=new pl("normal load",[]),Sl=new pl("fetch",[]),Cl=new pl("transform url",[]);!function(t){t.UUID="uuid",t.PATH="path",t.DIR="dir",t.URL="url",t.SCENE="scene"}(dl||(dl={}));var Al,bl={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};!function(t){t.RESOURCES="resources",t.MAIN="main",t.START_SCENE="start-scene"}(Al||(Al={}));var Tl=function(){function t(e){this.id=t._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(e)}t.create=function(e){var n;return 0!==t._deadPool.length?(n=t._deadPool.pop()).set(e):n=new t(e),n};var e=t.prototype;return e.set=function(t){void 0===t&&(t=Object.create(null)),this.onComplete=t.onComplete||null,this.onProgress=t.onProgress||null,this.onError=t.onError||null,this.source=this.input=t.input,this.output=null,this.progress=t.progress,this.options=t.options||Object.create(null)},e.dispatch=function(t,e,n,i,r){switch(t){case"complete":this.onComplete&&this.onComplete(e,n);break;case"progress":this.onProgress&&this.onProgress(e,n,i,r);break;case"error":this.onError&&this.onError(e,n,i,r);break;default:var o="on"+t[0].toUpperCase()+t.substr(1);"function"==typeof this[o]&&this[o](e,n,i,r)}},e.recycle=function(){t._deadPool.length!==t.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,t._deadPool.push(this))},t}();Tl.MAX_DEAD_NUM=500,Tl._taskId=0,Tl._deadPool=[];var El="0123456789abcdef".split(""),wl=["","","",""],Pl=wl.concat(wl,"-",wl,"-",wl,"-",wl,"-",wl,wl,wl),Il=Pl.map((function(t,e){return"-"===t?NaN:e})).filter(isFinite);function Rl(t){var e=t.split("@")[0];if(22!==e.length)return t;Pl[0]=t[0],Pl[1]=t[1];for(var n=2,i=2;n<22;n+=2){var r=fe[t.charCodeAt(n)],o=fe[t.charCodeAt(n+1)];Pl[Il[i++]]=El[r>>2],Pl[Il[i++]]=El[(3&r)<<2|o>>4],Pl[Il[i++]]=El[15&o]}return t.replace(e,Pl.join(""))}var Dl=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function Bl(t){var e=Dl.exec(t);return e?e[1]:""}function Ml(t,e){(e=e||Object.create(null)).__isNative__=e.isNative,e.ext=e.nativeExt;var n=yl.find((function(e){return!!e.getAssetInfo(t)}));return n&&(e.bundle=n.name),Ll(t,e)}function Ol(t){return!!t&&(t instanceof c.SceneAsset||t instanceof c.Scene)}function Nl(t){return t&&(46===t.charCodeAt(0)&&47===t.charCodeAt(1)?t=t.slice(2):47===t.charCodeAt(0)&&(t=t.slice(1))),t}function Ll(t,e){var n=Tl.create({input:t,options:e}),i=[];try{for(var r,o=ot(Cl.sync(n));!(r=o()).done;){var a=r.value,s=a.url;a.recycle(),i.push(s)}}catch(t){for(var c,l=ot(n.output);!(c=l()).done;)c.value.recycle();x(t.message,t.stack)}return n.recycle(),i.length>1?i:i[0]}var Fl=Object.freeze({__proto__:null,getUuidFromURL:Bl,getUrlWithUuid:Ml,isScene:Ol,normalize:Nl,transform:Ll,decodeUuid:Rl}),zl=new(function(){function t(){this._pools=[],this._lastShrinkPassed=0,this.shrinkTimeSpan=5}var e=t.prototype;return e.addContainer=function(t){-1===t._poolHandle&&(t._poolHandle=this._pools.length,this._pools.push(t))},e.removeContainer=function(t){-1!==t._poolHandle&&(this._pools[this._pools.length-1]._poolHandle=t._poolHandle,ee.array.fastRemoveAt(this._pools,t._poolHandle),t._poolHandle=-1)},e.tryShrink=function(){for(var t=0;t<this._pools.length;t++)this._pools[t].tryShrink()},e.update=function(t){this._lastShrinkPassed+=t,this._lastShrinkPassed>this.shrinkTimeSpan&&(this.tryShrink(),this._lastShrinkPassed-=this.shrinkTimeSpan)},t}()),Gl=function(){function t(){this._poolHandle=-1,zl.addContainer(this)}return t.prototype.destroy=function(){zl.removeContainer(this)},t}(),Vl=t("Pool",function(t){function e(e,n,i){var r;(r=t.call(this)||this)._ctor=void 0,r._elementsPerBatch=void 0,r._nextAvail=void 0,r._freepool=[],r._dtor=void 0,r._ctor=e,r._dtor=i||null,r._elementsPerBatch=Math.max(n,1),r._nextAvail=r._elementsPerBatch-1;for(var o=0;o<r._elementsPerBatch;++o)r._freepool.push(e());return r}Q(e,t);var n=e.prototype;return n.alloc=function(){if(this._nextAvail<0){this._freepool.length=this._elementsPerBatch;for(var t=0;t<this._elementsPerBatch;t++)this._freepool[t]=this._ctor();this._nextAvail=this._elementsPerBatch-1}return this._freepool[this._nextAvail--]},n.free=function(t){this._freepool[++this._nextAvail]=t},n.freeArray=function(t){this._freepool.length=this._nextAvail+1,Array.prototype.push.apply(this._freepool,t),this._nextAvail+=t.length},n.tryShrink=function(){if(this._nextAvail>>1>this._elementsPerBatch){if(this._dtor)for(var t=this._nextAvail>>1;t<=this._nextAvail;t++)this._dtor(this._freepool[t]);this._freepool.length=this._nextAvail>>1,this._nextAvail=this._freepool.length-1}},n.destroy=function(){var e=arguments.length>0?arguments[0]:null;e&&I(14100);var n=e||this._dtor;if(n)for(var i=0;i<=this._nextAvail;i++)n(this._freepool[i]);this._freepool.length=0,this._nextAvail=-1,t.prototype.destroy.call(this)},e}(Gl)),Ul=t("RecyclePool",function(t){function e(e,n,i){var r;(r=t.call(this)||this)._fn=void 0,r._dtor=null,r._count=0,r._data=void 0,r._initSize=0,r._fn=e,r._dtor=i||null,r._data=new Array(n),r._initSize=n;for(var o=0;o<n;++o)r._data[o]=e();return r}Q(e,t);var n=e.prototype;return n.reset=function(){this._count=0},n.resize=function(t){if(t>this._data.length)for(var e=this._data.length;e<t;++e)this._data[e]=this._fn()},n.add=function(){return this._count>=this._data.length&&this.resize(this._data.length<<1),this._data[this._count++]},n.destroy=function(){if(this._dtor)for(var e=0;e<this._data.length;e++)this._dtor(this._data[e]);this._data.length=0,this._count=0,t.prototype.destroy.call(this)},n.tryShrink=function(){if(this._data.length>>2>this._count){var t=Math.max(this._initSize,this._data.length>>1);if(this._dtor)for(var e=t;e<this._data.length;e++)this._dtor(this._data[e]);this._data.length=t}},n.removeAt=function(t){if(!(t>=this._count)){var e=this._count-1,n=this._data[t];this._data[t]=this._data[e],this._data[e]=n,this._count-=1}},K(e,[{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),e}(Gl)),kl=t("CachedArray",function(t){function e(e,n){var i;return(i=t.call(this)||this).array=void 0,i.length=0,i._compareFn=void 0,i._initSize=0,i.array=new Array(e),i._initSize=e,i.length=0,i._compareFn=void 0!==n?n:function(t,e){return t-e},i}Q(e,t);var n=e.prototype;return n.push=function(t){this.array[this.length++]=t},n.pop=function(){return this.array[--this.length]},n.get=function(t){return this.array[t]},n.clear=function(){this.length=0},n.destroy=function(){this.length=0,this.array.length=0,t.prototype.destroy.call(this)},n.tryShrink=function(){this.array.length>>2>this.length&&(this.array.length=Math.max(this._initSize,this.array.length>>1))},n.sort=function(){this.array.length=this.length,this.array.sort(this._compareFn)},n.concat=function(t){for(var e=0;e<t.length;++e)this.array[this.length++]=t[e]},n.fastRemove=function(t){if(!(t>=this.length||t<0)){var e=--this.length;this.array[t]=this.array[e]}},n.indexOf=function(t){for(var e=0,n=this.length;e<n;++e)if(this.array[e]===t)return e;return-1},e}(Gl));t("memop",Object.freeze({__proto__:null,Pool:Vl,RecyclePool:Ul,CachedArray:kl}));var Hl=te.fastRemoveAt;function jl(){}var Wl=function(){function t(){this.callback=jl,this.target=void 0,this.once=!1}var e=t.prototype;return e.set=function(t,e,n){this.callback=t||jl,this.target=e,this.once=!!n},e.reset=function(){this.target=void 0,this.callback=jl,this.once=!1},e.check=function(){return!(this.target instanceof ul&&!_l(this.target,!0))},t}(),ql=new Vl((function(){return new Wl}),32),Xl=function(){function t(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}var e=t.prototype;return e.removeByCallback=function(t){for(var e=0;e<this.callbackInfos.length;++e){var n=this.callbackInfos[e];n&&n.callback===t&&(n.reset(),ql.free(n),Hl(this.callbackInfos,e),--e)}},e.removeByTarget=function(t){for(var e=0;e<this.callbackInfos.length;++e){var n=this.callbackInfos[e];n&&n.target===t&&(n.reset(),ql.free(n),Hl(this.callbackInfos,e),--e)}},e.cancel=function(t){var e=this.callbackInfos[t];e&&(e.reset(),this.isInvoking?this.callbackInfos[t]=null:Hl(this.callbackInfos,t),ql.free(e)),this.containCanceled=!0},e.cancelAll=function(){for(var t=0;t<this.callbackInfos.length;t++){var e=this.callbackInfos[t];e&&(e.reset(),ql.free(e),this.callbackInfos[t]=null)}this.containCanceled=!0},e.purgeCanceled=function(){for(var t=this.callbackInfos.length-1;t>=0;--t)this.callbackInfos[t]||Hl(this.callbackInfos,t);this.containCanceled=!1},e.clear=function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1},t}(),Yl=new Vl((function(){return new Xl}),16),Kl=function(){function t(){this._callbackTable=Et(!0),this._offCallback=void 0}var e=t.prototype;return e.on=function(t,e,n,i){if(!this.hasEventListener(t,e,n)){var r=this._callbackTable[t];r||(r=this._callbackTable[t]=Yl.alloc());var o=ql.alloc();o.set(e,n,i),r.callbackInfos.push(o)}return e},e.hasEventListener=function(t,e,n){var i=this._callbackTable&&this._callbackTable[t];if(!i)return!1;var r=i.callbackInfos;if(!e){if(i.isInvoking){for(var o=0;o<r.length;++o)if(r[o])return!0;return!1}return r.length>0}for(var a=0;a<r.length;++a){var s=r[a];if(s&&s.check()&&s.callback===e&&s.target===n)return!0}return!1},e.removeAll=function(t){var e=typeof t;if("string"===e||"number"===e){var n=this._callbackTable&&this._callbackTable[t];n&&(n.isInvoking?n.cancelAll():(n.clear(),Yl.free(n),delete this._callbackTable[t]))}else if(t)for(var i in this._callbackTable){var r=this._callbackTable[i];if(r.isInvoking)for(var o=r.callbackInfos,a=0;a<o.length;++a){var s=o[a];s&&s.target===t&&r.cancel(a)}else r.removeByTarget(t)}},e.off=function(t,e,n){var i,r=this._callbackTable&&this._callbackTable[t];if(r){var o=r.callbackInfos;if(e)for(var a=0;a<o.length;++a){var s=o[a];if(s&&s.callback===e&&s.target===n){r.cancel(a);break}}else this.removeAll(t)}null===(i=this._offCallback)||void 0===i||i.call(this)},e.emit=function(t,e,n,i,r,o){var a=this._callbackTable&&this._callbackTable[t];if(a){var s=!a.isInvoking;a.isInvoking=!0;for(var c=a.callbackInfos,l=0,u=c.length;l<u;++l){var h=c[l];if(h){var _=h.callback,f=h.target;h.once&&this.off(t,_,f),h.check()?f?_.call(f,e,n,i,r,o):_(e,n,i,r,o):this.off(t,_,f)}}s&&(a.isInvoking=!1,a.containCanceled&&a.purgeCanceled())}},e.clear=function(){for(var t in this._callbackTable){var e=this._callbackTable[t];e&&(e.clear(),Yl.free(e),delete this._callbackTable[t])}},e._registerOffCallback=function(t){this._offCallback=t},t}();function Jl(t){for(var e=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._callbackTable=Et(!0),e}Q(e,t);var n=e.prototype;return n.once=function(t,e,n){return this.on(t,e,n,!0)},n.targetOff=function(t){this.removeAll(t)},e}(t),n=Kl.prototype,i=Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n)),r=0;r<i.length;++r){var o=i[r];if(!(o in e.prototype)){var a=Object.getOwnPropertyDescriptor(n,o);a&&Object.defineProperty(e.prototype,o,a)}}return e}var Ql=t("EventTarget",Jl((function(){})));c.EventTarget=Ql;var Zl,$l,tu,eu,nu,iu,ru,ou=new(function(){function t(){this._finalizationRegistry=null}var e=t.prototype;return e.registerGCObject=function(t){return t},e.unregisterGCObject=function(){},e.init=function(){},e.finalizationRegistryCallback=function(t){t.isValid&&t.destroy()},e.destroy=function(){},t}()),au=hc("cc.GCObject")(Zl=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return e=t.call.apply(t,[this].concat(i))||this,ou.registerGCObject(it(e))||it(e)}Q(e,t);var n=e.prototype;return n.equals=function(t){return!!t&&t===this},n.destroy=function(){return ou.unregisterGCObject(this),t.prototype.destroy.call(this)},e}(ul))||Zl;!function(t){t.UNKNOWN="unknown",t.WECHAT="wechat",t.ANDROID="androidbrowser",t.IE="ie",t.EDGE="edge",t.QQ="qqbrowser",t.MOBILE_QQ="mqqbrowser",t.UC="ucbrowser",t.UCBS="ucbs",t.BROWSER_360="360browser",t.BAIDU_APP="baiduboxapp",t.BAIDU="baidubrowser",t.MAXTHON="maxthon",t.OPERA="opera",t.OUPENG="oupeng",t.MIUI="miuibrowser",t.FIREFOX="firefox",t.SAFARI="safari",t.CHROME="chrome",t.LIEBAO="liebao",t.QZONE="qzone",t.SOUGOU="sogou",t.HUAWEI="huawei"}($l||($l={})),function(t){t.UNKNOWN="unknown",t.ENGLISH="en",t.CHINESE="zh",t.FRENCH="fr",t.ITALIAN="it",t.GERMAN="de",t.SPANISH="es",t.DUTCH="du",t.RUSSIAN="ru",t.KOREAN="ko",t.JAPANESE="ja",t.HUNGARIAN="hu",t.PORTUGUESE="pt",t.ARABIC="ar",t.NORWEGIAN="no",t.POLISH="pl",t.TURKISH="tr",t.UKRAINIAN="uk",t.ROMANIAN="ro",t.BULGARIAN="bg"}(tu||(tu={})),function(t){t[t.NONE=0]="NONE",t[t.LAN=1]="LAN",t[t.WWAN=2]="WWAN"}(eu||(eu={})),function(t){t.UNKNOWN="Unknown",t.IOS="iOS",t.ANDROID="Android",t.WINDOWS="Windows",t.LINUX="Linux",t.OSX="OS X",t.OHOS="OHOS"}(nu||(nu={})),function(t){t.UNKNOWN="UNKNOWN",t.EDITOR_PAGE="EDITOR_PAGE",t.EDITOR_CORE="EDITOR_CORE",t.MOBILE_BROWSER="MOBILE_BROWSER",t.DESKTOP_BROWSER="DESKTOP_BROWSER",t.WIN32="WIN32",t.ANDROID="ANDROID",t.IOS="IOS",t.MACOS="MACOS",t.OHOS="OHOS",t.WECHAT_GAME="WECHAT_GAME",t.BAIDU_MINI_GAME="BAIDU_MINI_GAME",t.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",t.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",t.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",t.OPPO_MINI_GAME="OPPO_MINI_GAME",t.VIVO_MINI_GAME="VIVO_MINI_GAME",t.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",t.COCOSPLAY="COCOSPLAY",t.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",t.QTT_MINI_GAME="QTT_MINI_GAME"}(iu||(iu={})),function(t){t.WEBP="WEBP",t.IMAGE_BITMAP="IMAGE_BITMAP",t.WEB_VIEW="WEB_VIEW",t.VIDEO_PLAYER="VIDEO_PLAYER",t.SAFE_AREA="SAFE_AREA",t.INPUT_TOUCH="INPUT_TOUCH",t.EVENT_KEYBOARD="EVENT_KEYBOARD",t.EVENT_MOUSE="EVENT_MOUSE",t.EVENT_TOUCH="EVENT_TOUCH",t.EVENT_ACCELEROMETER="EVENT_ACCELEROMETER"}(ru||(ru={}));var su,cu,lu,uu,hu=new(function(t){function e(){var e,n,i;(i=t.call(this)||this).networkType=void 0,i.isNative=void 0,i.isBrowser=void 0,i.isMobile=void 0,i.isLittleEndian=void 0,i.platform=void 0,i.language=void 0,i.nativeLanguage=void 0,i.os=void 0,i.osVersion=void 0,i.osMainVersion=void 0,i.browserType=void 0,i.browserVersion=void 0,i._battery=void 0,i._featureMap=void 0;var r,o=window.navigator,a=o.userAgent.toLowerCase();null===(e=o.getBattery)||void 0===e||e.call(o).then((function(t){i._battery=t})),i.networkType=eu.LAN,i.isNative=!1,i.isBrowser=!0,i.isMobile=/mobile|android|iphone|ipad/.test(a),i.platform=i.isMobile?iu.MOBILE_BROWSER:iu.DESKTOP_BROWSER,i.isLittleEndian=(r=new ArrayBuffer(2),new DataView(r).setInt16(0,256,!0),256===new Int16Array(r)[0]);var s=o.language;i.nativeLanguage=s.toLowerCase(),s=(s=s||o.browserLanguage)?s.split("-")[0]:tu.ENGLISH,i.language=s;var c=!1,l=!1,u="",h=0,_=/android\s*(\d+(?:\.\d+)*)/i.exec(a)||/android\s*(\d+(?:\.\d+)*)/i.exec(o.platform);_&&(c=!0,u=_[1]||"",h=parseInt(u)||0),(_=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(a))?(l=!0,u=_[2]||"",h=parseInt(u)||0):(/(iPhone|iPad|iPod)/.exec(o.platform)||"MacIntel"===o.platform&&o.maxTouchPoints&&o.maxTouchPoints>1)&&(l=!0,u="",h=0);var f=nu.UNKNOWN;-1!==o.appVersion.indexOf("Win")?f=nu.WINDOWS:l?f=nu.IOS:-1!==o.appVersion.indexOf("Mac")?f=nu.OSX:-1!==o.appVersion.indexOf("X11")&&-1===o.appVersion.indexOf("Linux")?f=nu.LINUX:c?f=nu.ANDROID:-1===o.appVersion.indexOf("Linux")&&-1===a.indexOf("ubuntu")||(f=nu.LINUX),i.os=f,i.osVersion=u,i.osMainVersion=h,i.browserType=$l.UNKNOWN;var p=/wechat|weixin|micromessenger/i.exec(a)||/mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(a)||/qq|qqbrowser|ucbrowser|ubrowser|edge|HuaweiBrowser/i.exec(a)||/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(a),d=p?p[0].toLowerCase():nu.UNKNOWN;("safari"===d&&c||"qq"===d&&/android.*applewebkit/i.test(a))&&(d=$l.ANDROID);var m={micromessenger:$l.WECHAT,wechat:$l.WECHAT,weixin:$l.WECHAT,trident:$l.IE,edge:$l.EDGE,"360 aphone":$l.BROWSER_360,mxbrowser:$l.MAXTHON,"opr/":$l.OPERA,ubrowser:$l.UC,huaweibrowser:$l.HUAWEI};i.browserType=m[d]||d,i.browserVersion="";var v=/(mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui(?:.hybrid)?)(mobile)?(browser)?\/?([\d.]+)/i.exec(a);v||(v=/(qq|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i.exec(a)),i.browserVersion=v?v[4]:"";var g,y=document.createElement("canvas");y.getContext("2d");try{g=y.toDataURL("image/webp").startsWith("data:image/webp")}catch(t){g=!1}var x=!1;"undefined"!=typeof createImageBitmap&&"undefined"!=typeof Blob&&(y.width=y.height=2,createImageBitmap(y,{}).then((function(t){x=!0,null==t||t.close()})).catch((function(){})));var S=void 0!==document.documentElement.ontouchstart||void 0!==document.ontouchstart,C=void 0!==document.documentElement.onmouseup;return i._featureMap=((n={})[ru.WEBP]=g,n[ru.IMAGE_BITMAP]=x,n[ru.WEB_VIEW]=!0,n[ru.VIDEO_PLAYER]=!0,n[ru.SAFE_AREA]=!1,n[ru.INPUT_TOUCH]=S,n[ru.EVENT_KEYBOARD]=void 0!==document.documentElement.onkeyup,n[ru.EVENT_MOUSE]=C,n[ru.EVENT_TOUCH]=S||C,n[ru.EVENT_ACCELEROMETER]=void 0!==window.DeviceMotionEvent||void 0!==window.DeviceOrientationEvent,n),i._registerEvent(),i}Q(e,t);var n=e.prototype;return n._registerEvent=function(){var t,e=this;t=void 0!==document.hidden?"hidden":void 0!==document.mozHidden?"mozHidden":void 0!==document.msHidden?"msHidden":void 0!==document.webkitHidden?"webkitHidden":"hidden";var n=!1,i=function(){n||(n=!0,e.emit("hide"))},r=function(t,i,r,o,a){n&&(n=!1,e.emit("show",t,i,r,o,a))};if(t)for(var o=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],a=0;a<o.length;a++)document.addEventListener(o[a],(function(e){var n=document[t];(n=n||e.hidden)?i():r()}));else window.addEventListener("blur",i),window.addEventListener("focus",r);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(window.onfocus=r),"onpageshow"in window&&"onpagehide"in window&&(window.addEventListener("pagehide",i),window.addEventListener("pageshow",r),document.addEventListener("pagehide",i),document.addEventListener("pageshow",r))},n.hasFeature=function(t){return this._featureMap[t]},n.getBatteryLevel=function(){return this._battery?this._battery.level:1},n.triggerGC=function(){},n.openURL=function(t){window.open(t)},n.now=function(){return Date.now?Date.now():+new Date},n.restartJSVM=function(){},n.close=function(){this.emit("close"),window.close()},e}(Ql)),_u=/(\.[^\.\/\?\\]*)(\?.*)?$/,fu=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,pu=/[^\.\/]+\/\.\.\//;function du(){for(var t="",e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];t=(t+(""===t?"":"/")+a).replace(/(\/|\\\\)$/,"")}return t}function mu(t){var e=_u.exec(t);return e?e[1]:""}function vu(t){if(t){var e=t.lastIndexOf(".");if(-1!==e)return t.substring(0,e)}return t}function gu(t,e){var n=t.indexOf("?");n>0&&(t=t.substring(0,n));var i=/(\/|\\)([^\/\\]+)$/g.exec(t.replace(/(\/|\\)$/,""));if(!i)return t;var r=i[2];return e&&t.substring(t.length-e.length).toLowerCase()===e.toLowerCase()?r.substring(0,r.length-e.length):r}function yu(t){var e=fu.exec(t);return e?e[2]:""}function xu(t,e){e=e||"";var n=t.indexOf("?"),i="";return n>0&&(i=t.substring(n),t=t.substring(0,n)),(n=t.lastIndexOf("."))<0?t+e+i:t.substring(0,n)+e+i}function Su(t,e,n){if(0===e.indexOf("."))return xu(t,e);var i=t.indexOf("?"),r="",o=n?mu(t):"";return i>0&&(r=t.substring(i),t=t.substring(0,i)),i=(i=t.lastIndexOf("/"))<=0?0:i+1,t.substring(0,i)+e+o+r}function Cu(t){var e=t=String(t);do{e=t,t=t.replace(pu,"")}while(e.length!==t.length);return t}function Au(t){return t.replace(/[\/\\]$/,"")}function bu(){return hu.os===nu.WINDOWS?"\\":"/"}t("path",Object.freeze({__proto__:null,join:du,extname:mu,mainFileName:vu,basename:gu,dirname:yu,changeExtname:xu,changeBasename:Su,_normalize:Cu,stripSep:Au,getSeperator:bu}));var Tu,Eu,wu,Pu=t("Asset",hc("cc.Asset")((uu=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).loaded=!0,at(e,"_native",lu,it(e)),e._nativeUrl="",e._file=null,e._ref=0,Object.defineProperty(it(e),"_uuid",{value:"",writable:!0}),e}Q(e,t),e.deserialize=function(t){return c.deserialize(t)};var n=e.prototype;return n.toString=function(){return this.nativeUrl},n.serialize=function(){},n._setRawAsset=function(t,e){void 0===e&&(e=!0),this._native=!1!==e?t||"":"/"+t},n.addRef=function(){return this._ref++,this},n.decRef=function(t){return void 0===t&&(t=!0),this._ref>0&&this._ref--,t&&c.assetManager._releaseManager.tryRelease(this),this},n.onLoaded=function(){},n.initDefault=function(t){t&&(this._uuid=t),this.isDefault=!0},n.validate=function(){return!0},n.destroy=function(){return C(N(12101,this._uuid)),t.prototype.destroy.call(this)},K(e,[{key:"nativeUrl",get:function(){if(!this._nativeUrl){if(!this._native)return"";var t=this._native;if(47===t.charCodeAt(0))return t.slice(1);46===t.charCodeAt(0)?this._nativeUrl=Ml(this._uuid,{nativeExt:t,isNative:!0}):this._nativeUrl=Ml(this._uuid,{__nativeName__:t,nativeExt:mu(t),isNative:!0})}return this._nativeUrl}},{key:"_nativeAsset",get:function(){return this._file},set:function(t){this._file=t}},{key:"_nativeDep",get:function(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}},{key:"refCount",get:function(){return this._ref}}]),e}(Jl(au)),lu=st((cu=uu).prototype,"_native",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),st(cu.prototype,"_nativeAsset",[dc],Object.getOwnPropertyDescriptor(cu.prototype,"_nativeAsset"),cu.prototype),su=cu))||su);Pu.prototype.createNode=null,c.Asset=Pu;var Iu=t("Script",hc("cc.Script")(Tu=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e}(Pu))||Tu);c._Script=Iu;var Ru=t("JavaScript",hc("cc.JavaScript")(Eu=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e}(Iu))||Eu);c._JavaScript=Ru;var Du,Bu,Mu,Ou,Nu,Lu,Fu,zu,Gu,Vu,Uu,ku=t("TypeScript",hc("cc.TypeScript")(wu=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e}(Iu))||wu);c._TypeScript=ku;var Hu,ju,Wu,qu,Xu=new pt("Comp"),Yu=ul.Flags.IsOnLoadCalled,Ku=t("Component",(Du=hc("cc.Component"),Bu=Dc(),Mu=Wc(Iu),Ou=Bc(),Du((Uu=Vu=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"node",Fu,it(e)),at(e,"_enabled",zu,it(e)),at(e,"__prefab",Gu,it(e)),e._sceneGetter=null,e._id=Xu.getNewId(),e}Q(e,t);var n=e.prototype;return n._getRenderScene=function(){return this._sceneGetter?this._sceneGetter():this.node.scene.renderScene},n.addComponent=function(t){return this.node.addComponent(t)},n.getComponent=function(t){return this.node.getComponent(t)},n.getComponents=function(t){return this.node.getComponents(t)},n.getComponentInChildren=function(t){return this.node.getComponentInChildren(t)},n.getComponentsInChildren=function(t){return this.node.getComponentsInChildren(t)},n.destroy=function(){return!!t.prototype.destroy.call(this)&&(this._enabled&&this.node.activeInHierarchy&&c.director._compScheduler.disableComp(this),!0)},n._onPreDestroy=function(){this.unscheduleAllCallbacks(),c.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)},n._instantiate=function(t){return t||(t=c.instantiate._clone(this,this)),t&&(t.node=null),t},n.schedule=function(t,e,n,i){void 0===e&&(e=0),void 0===n&&(n=c.macro.REPEAT_FOREVER),void 0===i&&(i=0),O(t,1619),O((e=e||0)>=0,1620),n=Number.isNaN(n)?c.macro.REPEAT_FOREVER:n,i=i||0;var r=c.director.getScheduler(),o=r.isTargetPaused(this);r.schedule(t,this,e,n,i,o)},n.scheduleOnce=function(t,e){void 0===e&&(e=0),this.schedule(t,0,0,e)},n.unschedule=function(t){t&&c.director.getScheduler().unschedule(t,this)},n.unscheduleAllCallbacks=function(){c.director.getScheduler().unscheduleAllForTarget(this)},K(e,[{key:"name",get:function(){if(this._name)return this._name;var t=wt(this),e=t.lastIndexOf(".");return e>=0&&(t=t.slice(e+1)),this.node?this.node.name+"<"+t+">":t},set:function(t){this._name=t}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(t){if(this._enabled!==t&&(this._enabled=t,this.node.activeInHierarchy)){var e=c.director._compScheduler;t?e.enableComp(this):e.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&Yu}}]),e}(ul),Vu.system=null,st((Lu=Uu).prototype,"__scriptAsset",[Bu,Mu,Ou,Vc],Object.getOwnPropertyDescriptor(Lu.prototype,"__scriptAsset"),Lu.prototype),Fu=st(Lu.prototype,"node",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zu=st(Lu.prototype,"_enabled",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Gu=st(Lu.prototype,"__prefab",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Nu=Lu))||Nu)),Ju=Ku.prototype;Ju.update=null,Ju.lateUpdate=null,Ju.__preload=null,Ju.onLoad=null,Ju.start=null,Ju.onEnable=null,Ju.onDisable=null,Ju.onDestroy=null,Ju.onFocusInEditor=null,Ju.onLostFocusInEditor=null,Ju.resetInEditor=null,Ju._getLocalBounds=null,Ju.onRestore=null,Ku._requireComponent=null,Ku._executionOrder=0,Ct(Ku,"_registerEditorProps",(function(t,e){var n=e.requireComponent;n&&(Array.isArray(n)&&(n=n.filter(Boolean)),t._requireComponent=n);var i=e.executionOrder;i&&"number"==typeof i&&(t._executionOrder=i)})),c.Component=Ku;var Qu,Zu=t("MissingScript",hc("cc.MissingScript")(Hu=Tc()((qu=function(t){function e(){var e;return at(e=t.call(this)||this,"_$erialized",Wu,it(e)),e}return Q(e,t),e.safeFindClass=function(t){var e=Jt(t);if(e)return e;c.deserialize.reportMissingClass(t)},e.prototype.onLoad=function(){I(4600,this.node.name)},e}(Ku),Wu=st((ju=qu).prototype,"_$erialized",[vc,yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hu=ju))||Hu)||Hu);c._MissingScript=Zu;try{var $u=Zu.__values__;0!==$u.length&&"_$erialized"===$u[$u.length-1]||(x("The '_$erialized' prop in MissingScript is missing. Please contact jare."),x("    Error props: ['"+$u+"']"))}catch(jo){x("Error when checking MissingScript 5, "+jo)}!function(t){t[t.PORTRAIT=1]="PORTRAIT",t[t.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",t[t.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",t[t.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",t[t.LANDSCAPE=12]="LANDSCAPE",t[t.AUTO=13]="AUTO"}(Qu||(Qu={}));var th,eh={auto:Qu.AUTO,landscape:Qu.LANDSCAPE,portrait:Qu.PORTRAIT};!function(t){t[t.Unknown=0]="Unknown",t[t.SubFrame=1]="SubFrame",t[t.BrowserWindow=2]="BrowserWindow",t[t.Fullscreen=3]="Fullscreen"}(th||(th={}));var nh=new(function(t){function e(){var e,n,i,r,o,a;(e=t.call(this)||this).isFrameRotated=!1,e.handleResizeEvent=!0,e._gameFrame=void 0,e._gameContainer=void 0,e._gameCanvas=void 0,e._isProportionalToFrame=!1,e._cachedFrameStyle={width:"0px",height:"0px"},e._cachedContainerStyle={width:"0px",height:"0px"},e._cbToUpdateFrameBuffer=void 0,e._supportFullScreen=!1,e._touchEventName=void 0,e._onFullscreenChange=void 0,e._onFullscreenError=void 0,e._orientationChangeTimeoutId=-1,e._cachedFrameSize=new Zn(0,0),e._exactFitScreen=!1,e._fn={},e._fnGroup=[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement","fullscreenerror"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement","fullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement","msfullscreenerror"]],e._resolutionScale=1,e._orientation=Qu.AUTO,e._gameFrame=document.getElementById("GameDiv"),e._gameContainer=document.getElementById("Cocos3dGameContainer"),e._gameCanvas=document.getElementById("GameCanvas"),e._gameFrame||(e._gameFrame=document.createElement("div"),e._gameFrame.setAttribute("id","GameDiv"),null===(n=e._gameCanvas)||void 0===n||null===(i=n.parentNode)||void 0===i||i.insertBefore(e._gameFrame,e._gameCanvas),e._gameFrame.appendChild(e._gameCanvas)),e._gameContainer||(e._gameContainer=document.createElement("div"),e._gameContainer.setAttribute("id","Cocos3dGameContainer"),null===(r=e._gameCanvas)||void 0===r||null===(o=r.parentNode)||void 0===o||o.insertBefore(e._gameContainer,e._gameCanvas),e._gameContainer.appendChild(e._gameCanvas));for(var s=e._fnGroup,c=0;c<s.length;c++)if(a=s[c],void 0!==document[a[1]]){for(var l=0;l<a.length;l++)e._fn[s[0][l]]=a[l];break}return e._supportFullScreen=void 0!==e._fn.requestFullscreen,e._touchEventName="ontouchstart"in window?"touchend":"mousedown",e._registerEvent(),e}Q(e,t);var n=e.prototype;return n.init=function(t,e){this._cbToUpdateFrameBuffer=e,this.orientation=eh[t.configOrientation],this._exactFitScreen=t.exactFitScreen,this._resizeFrame()},n.requestFullScreen=function(){var t=this;return new Promise((function(e,n){t.isFullScreen?e():(t._cachedFrameSize=t.windowSize,t._doRequestFullScreen().then((function(){e()})).catch((function(){var i=t._getFullscreenTarget();i?i.addEventListener(t._touchEventName,(function(){t._doRequestFullScreen().then((function(){e()})).catch(n)}),{once:!0,capture:!0}):n(new Error("Cannot access fullscreen target"))})))}))},n.exitFullScreen=function(){var t=this;return new Promise((function(e,n){var i=document[t._fn.exitFullscreen]();window.Promise&&i instanceof Promise?i.then((function(){t.windowSize=t._cachedFrameSize,e()})).catch(n):(t.windowSize=t._cachedFrameSize,e())}))},n._registerEvent=function(){var t=this;document.addEventListener(this._fn.fullscreenerror,(function(){var e;null===(e=t._onFullscreenError)||void 0===e||e.call(t)})),window.addEventListener("resize",(function(){t.handleResizeEvent&&t._resizeFrame()})),"function"==typeof window.matchMedia&&function e(){var n,i,r=window.devicePixelRatio;null===(n=window.matchMedia("(resolution: "+r+"dppx)"))||void 0===n||null===(i=n.addEventListener)||void 0===i||i.call(n,"change",(function(){t.emit("window-resize"),e()}),{once:!0})}(),window.addEventListener("orientationchange",(function(){-1!==t._orientationChangeTimeoutId&&clearTimeout(t._orientationChangeTimeoutId),t._orientationChangeTimeoutId=setTimeout((function(){t.handleResizeEvent&&(t._updateFrameState(),t._resizeFrame(),t.emit("orientation-change"),t._orientationChangeTimeoutId=-1)}),200)})),document.addEventListener(this._fn.fullscreenchange,(function(){var e;null===(e=t._onFullscreenChange)||void 0===e||e.call(t),t.emit("fullscreen-change")}))},n._convertToSizeInCssPixels=function(t){var e=t.clone(),n=this.devicePixelRatio;return e.width/=n,e.height/=n,e},n._resizeFrame=function(t){if(this._gameFrame){if(this._gameFrame.style.display="flex",this._gameFrame.style["justify-content"]="center",this._gameFrame.style["align-items"]="center",this._windowType===th.SubFrame){if(!t)return void this._updateContainer();this._gameFrame.style.width=t.width+"px",this._gameFrame.style.height=t.height+"px"}else{var e=window.innerWidth,n=window.innerHeight;this.isFrameRotated?(this._gameFrame.style["-webkit-transform"]="rotate(90deg)",this._gameFrame.style.transform="rotate(90deg)",this._gameFrame.style["-webkit-transform-origin"]="0px 0px 0px",this._gameFrame.style.transformOrigin="0px 0px 0px",this._gameFrame.style.margin="0 0 0 "+e+"px",this._gameFrame.style.width=n+"px",this._gameFrame.style.height=e+"px"):(this._gameFrame.style["-webkit-transform"]="rotate(0deg)",this._gameFrame.style.transform="rotate(0deg)",this._gameFrame.style.margin="0px auto",this._gameFrame.style.width=e+"px",this._gameFrame.style.height=n+"px")}this._updateContainer()}},n._getFullscreenTarget=function(){var t=this._windowType;return t===th.Fullscreen?document[this._fn.fullscreenElement]:t===th.SubFrame?this._gameFrame:document.body},n._doRequestFullScreen=function(){var t=this;return new Promise((function(e,n){if(t._supportFullScreen){var i=t._getFullscreenTarget();if(i){t._onFullscreenChange=void 0,t._onFullscreenError=void 0;var r=i[t._fn.requestFullscreen]();window.Promise&&r instanceof Promise?r.then(e).catch(n):(t._onFullscreenChange=e,t._onFullscreenError=n)}else n(new Error("Cannot access fullscreen target"))}else n(new Error("fullscreen is not supported"))}))},n._updateFrameState=function(){var t=this.orientation,e=window.innerWidth>window.innerHeight;this.isFrameRotated=hu.isMobile&&(e&&t===Qu.PORTRAIT||!e&&t===Qu.LANDSCAPE)},n._updateContainer=function(){if(this._gameContainer){if(this.isProportionalToFrame){if(!this._gameFrame)return void I(9201);var t,e,n=c.view.getDesignResolutionSize(),i=this._gameFrame,r=i.clientWidth,o=i.clientHeight,a=n.width,s=n.height,l=r/a,u=o/s,h=this._gameContainer.style;l<u?(t=r,e=s*l):(t=a*u,e=o),h.width=t+"px",h.height=e+"px"}else{var _=this._gameContainer.style;_.width="100%",_.height="100%"}!this._gameFrame||this._cachedFrameStyle.width===this._gameFrame.style.width&&this._cachedFrameStyle.height===this._gameFrame.style.height&&this._cachedContainerStyle.width===this._gameContainer.style.width&&this._cachedContainerStyle.height===this._gameContainer.style.height||(this.emit("window-resize"),this._cachedFrameStyle.width=this._gameFrame.style.width,this._cachedFrameStyle.height=this._gameFrame.style.height,this._cachedContainerStyle.width=this._gameContainer.style.width,this._cachedContainerStyle.height=this._gameContainer.style.height)}else I(9201)},K(e,[{key:"supportFullScreen",get:function(){return this._supportFullScreen}},{key:"isFullScreen",get:function(){return!!this._supportFullScreen&&!!document[this._fn.fullscreenElement]}},{key:"devicePixelRatio",get:function(){var t;return Math.min(null!==(t=window.devicePixelRatio)&&void 0!==t?t:1,2)}},{key:"windowSize",get:function(){var t=this._windowSizeInCssPixels,e=this.devicePixelRatio;return t.width*=e,t.height*=e,t},set:function(t){this._windowType===th.SubFrame?this._resizeFrame(this._convertToSizeInCssPixels(t)):I(9202)}},{key:"resolution",get:function(){var t=this.windowSize,e=this.resolutionScale;return new Zn(t.width*e,t.height*e)}},{key:"resolutionScale",get:function(){return this._resolutionScale},set:function(t){var e;t!==this._resolutionScale&&(this._resolutionScale=t,null===(e=this._cbToUpdateFrameBuffer)||void 0===e||e.call(this))}},{key:"orientation",get:function(){return this._orientation},set:function(t){this._orientation!==t&&(this._orientation=t,this._updateFrameState())}},{key:"safeAreaEdge",get:function(){return{top:0,bottom:0,left:0,right:0}}},{key:"isProportionalToFrame",get:function(){return this._isProportionalToFrame},set:function(t){this._isProportionalToFrame!==t&&(this._isProportionalToFrame=t,this._updateContainer())}},{key:"_windowSizeInCssPixels",get:function(){if(this.isProportionalToFrame)return this._gameContainer?new Zn(this._gameContainer.clientWidth,this._gameContainer.clientHeight):(I(9201),new Zn(0,0));var t,e,n;switch(this._windowType){case th.SubFrame:return this._gameFrame?new Zn(this._gameFrame.clientWidth,this._gameFrame.clientHeight):(I(9201),new Zn(0,0));case th.Fullscreen:return t=this._getFullscreenTarget(),e=this.isFrameRotated?t.clientHeight:t.clientWidth,n=this.isFrameRotated?t.clientWidth:t.clientHeight,new Zn(e,n);case th.BrowserWindow:return e=this.isFrameRotated?window.innerHeight:window.innerWidth,n=this.isFrameRotated?window.innerWidth:window.innerHeight,new Zn(e,n);case th.Unknown:default:return new Zn(0,0)}}},{key:"_windowType",get:function(){return this.isFullScreen?th.Fullscreen:this._gameFrame?this._exactFitScreen?th.BrowserWindow:th.SubFrame:(I(9201),th.Unknown)}}]),e}(Ql)),ih=function(){function t(){}var e=t.prototype;return e._init=function(t){nh.init(t,(function(){var t,e=c.director;(null===(t=e.root)||void 0===t?void 0:t.pipeline)?e.root.pipeline.pipelineSceneData.shadingScale=nh.resolutionScale:I(1220)}))},e.fullScreen=function(){return nh.isFullScreen},e.requestFullScreen=function(t,e,n){return arguments.length>0&&I(1400,"screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)","screen.requestFullScreen(): Promise"),nh.requestFullScreen().then((function(){null==e||e()})).catch((function(t){console.error(t),null==n||n()}))},e.exitFullScreen=function(){return nh.exitFullScreen()},e.autoFullScreen=function(t,e){var n;null===(n=this.requestFullScreen(t,e))||void 0===n||n.catch((function(){}))},e.disableAutoFullScreen=function(){},K(t,[{key:"devicePixelRatio",get:function(){return nh.devicePixelRatio}},{key:"windowSize",get:function(){return nh.windowSize},set:function(t){nh.windowSize=t}},{key:"resolution",get:function(){return nh.resolution}},{key:"supportsFullScreen",get:function(){return nh.supportFullScreen}}]),t}(),rh=t("screen",new ih);c.screen=rh;var oh=t("sys",{Feature:ru,hasFeature:function(t){return hu.hasFeature(t)},NetworkType:eu,Language:tu,OS:nu,Platform:iu,BrowserType:$l,isNative:hu.isNative,isBrowser:hu.isBrowser,isMobile:hu.isMobile,isLittleEndian:hu.isLittleEndian,platform:hu.platform,language:hu.language,languageCode:hu.nativeLanguage,os:hu.os,osVersion:hu.osVersion,osMainVersion:hu.osMainVersion,browserType:hu.browserType,browserVersion:hu.browserVersion,windowPixelResolution:rh.windowSize,capabilities:{canvas:!0,opengl:!0,webp:hu.hasFeature(ru.WEBP),imageBitmap:hu.hasFeature(ru.IMAGE_BITMAP),touches:hu.hasFeature(ru.INPUT_TOUCH),mouse:hu.hasFeature(ru.EVENT_MOUSE),keyboard:hu.hasFeature(ru.EVENT_KEYBOARD),accelerometer:hu.hasFeature(ru.EVENT_ACCELEROMETER)},localStorage:{},getNetworkType:function(){return hu.networkType},getBatteryLevel:function(){return hu.getBatteryLevel()},garbageCollect:function(){hu.triggerGC()},isObjectValid:function(t){return null!=t},dump:function(){var t="";t+="isMobile : "+this.isMobile+"\r\n",t+="language : "+this.language+"\r\n",t+="browserType : "+this.browserType+"\r\n",t+="browserVersion : "+this.browserVersion+"\r\n",t+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",t+="os : "+this.os+"\r\n",t+="osVersion : "+this.osVersion+"\r\n",t+="platform : "+this.platform+"\r\n",g(t+="Using "+(c.game.renderType===c.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n")},openURL:function(t){hu.openURL(t)},now:function(){return hu.now()},restartVM:function(){hu.restartJSVM()},getSafeAreaRect:function(){var t=c.view,e=nh.safeAreaEdge,n=nh.windowSize,i=new Wn(e.left,e.bottom),r=new Wn(n.width-e.right,n.height-e.top);t._convertToUISpace(i),t._convertToUISpace(r);var o=i.x,a=i.y,s=r.x-i.x,l=r.y-i.y;return new ti(o,a,s,l)}});!function(){try{var t=oh.localStorage=window.localStorage;t.setItem("storage",""),t.removeItem("storage"),t=null}catch(t){var e=function(){I(5200)};oh.localStorage={getItem:e,setItem:e,clear:e,removeItem:e}}oh.__isWebIOS14OrIPadOS14Env=(oh.os===nu.IOS||oh.os===nu.OSX)&&hu.isBrowser&&/(OS 14)|(Version\/14)/.test(window.navigator.userAgent)}(),c.sys=oh;var ah=t("serializeTag",Symbol("[[Serialize]]")),sh=t("deserializeTag",Symbol("[[Deserialize]]")),ch=function(){function t(t,e){this._document=void 0,this._chunks=void 0,this._document=t,this._chunks=e}return K(t,[{key:"document",get:function(){return this._document}},{key:"chunks",get:function(){return this._chunks}}]),t}();function lh(t){var e=t;return{chunks:e.chunks,document:e.document}}function uh(t){if(t.length<16)throw new hh(N(13102));var e=new DataView(t.buffer,t.byteOffset,t.byteLength);if(1313817411!==e.getUint32(0,!0))throw new hh(N(13100));var n=e.getUint32(4,!0);if(1!==n)throw new hh(N(13101,n));if(e.getUint32(8,!0)!==e.byteLength)throw new hh(N(13102));var i=12,r=e.getUint32(i,!0);i+=4;var o=new Uint8Array(e.buffer,i+e.byteOffset,r);i+=r;var a,s=function(t){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(t);if("Buffer"in globalThis)return globalThis.Buffer.from(t.buffer,t.byteOffset,t.byteLength).toString();throw new Error(N(13104))}(o);try{a=JSON.parse(s)}catch(t){throw new hh(t)}for(var c=[];i<e.byteLength;){i%8!=0&&(i+=8-i%8);var l=e.getUint32(i,!0);i+=4,c.push(new Uint8Array(e.buffer,i+e.byteOffset,l)),i+=l}if(i!==e.byteLength)throw new hh(N(13102));return new ch(a,c)}var hh=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e}(nt(Error));function _h(t,e,n,i,r){if(e instanceof c.ValueType){r||t.push("if(prop){");var o=wt(e);t.push("s._deserializeFastDefinedObject(o"+n+",prop,"+o+");"),r||t.push("}else o"+n+"=null;")}else t.push("\nif (prop) {\n    s._deserializeAndAssignField(o, prop, "+i+");\n} else {\n    o"+n+"=null;\n}\n")}!function(){function t(){this._viewOrPaddings=[],this._length=0}var e=t.prototype;e.alignAs=function(t){if(0!==t){var e=this._length%t;if(0!==e){var n=t-e;return this._viewOrPaddings.push(n),this._length+=n,n}}return 0},e.append=function(t){var e=this._length;return this._viewOrPaddings.push(t),this._length+=t.byteLength,e},e.get=function(){var t=new Uint8Array(this._length),e=0;return this._viewOrPaddings.forEach((function(n){"number"==typeof n?e+=n:(t.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength),e),e+=n.byteLength)})),t},K(t,[{key:"byteLength",get:function(){return this._length}}])}(),c.internal.parseCCONJson=lh,c.internal.decodeCCONBinary=uh,c.internal.CCON=ch;var fh="$_$default",ph="$_$formerlySerializedAs",dh=function(t){function e(){return t.call(this,(function(t){t.clear()}),1)||this}return Q(e,t),e.prototype.get=function(t,e,n,i,r){var o=this._get();return o?(o.reset(t,e,n,i,r),o):new mh(t,e,n,i,r)},e}($t),mh=function(){function t(t,e,n,i){this.deserializedList=void 0,this.deserializedData=void 0,this._ignoreEditorOnly=void 0,this.result=t,this.customEnv=i,this.deserializedList=[],this.deserializedData=null,this._classFinder=e,this._reportMissingClass=n,this._onDereferenced=null==e?void 0:e.onDereferenced}var e=t.prototype;return e.reset=function(t,e,n,i){this.result=t,this.customEnv=i,this._classFinder=e,this._reportMissingClass=n,this._onDereferenced=null==e?void 0:e.onDereferenced},e.clear=function(){this.result=null,this.customEnv=null,this.deserializedList.length=0,this.deserializedData=null,this._classFinder=null,this._reportMissingClass=null,this._onDereferenced=null},e.deserialize=function(t){var e,n=!1;t instanceof ch?(n=!0,e=t.document,t.chunks.length>0&&(t.chunks.length,this._mainBinChunk=t.chunks[0])):e=t,this._serializedData=e,this._context={fromCCON:n};var i=Array.isArray(e)?e[0]:e;return this.deserializedData=this._deserializeObject(i,0),this._serializedData=void 0,this._mainBinChunk=void 0,this._context=void 0,this.deserializedData},e._deserializeObject=function(t,e,n,i){switch(t.__type__){case"TypedArray":return this._deserializeTypedArrayView(t);case"TypedArrayRef":return this._deserializeTypedArrayViewRef(t);default:return t.__type__?this._deserializeTypeTaggedObject(t,e,n,i):Array.isArray(t)?this._deserializeArray(t):this._deserializePlainObject(t)}},e._deserializeTypedArrayView=function(t){return globalThis[t.ctor].from(t.array)},e._deserializeTypedArrayViewRef=function(t){var e=t.offset,n=t.length,i=t.ctor;return new globalThis[i](this._mainBinChunk.buffer,this._mainBinChunk.byteOffset+e,n)},e._deserializeArray=function(t){for(var e,n=new Array(t.length),i=0;i<t.length;i++)"object"==typeof(e=t[i])&&e?this._deserializeAndAssignField(n,e,""+i)&&(n[i]=null):n[i]=e;return n},e._deserializePlainObject=function(t){var e={};return this._fillPlainObject(e,t),e},e._deserializeTypeTaggedObject=function(t,e,n,i){var r=this,o=t.__type__,a=this._classFinder(o,t,n,i);if(!a)return this._classFinder===Jt&&this._reportMissingClass(o),null;var s=function(t){var n=new t;return e>=0&&(r.deserializedList[e]=n),n}(a);return this._deserializeInto(t,s,a),s},e._deserializeInto=function(t,e,n,i){void 0===i&&(i=!1),i||!e[sh]?e._deserialize?e._deserialize(t.content,this):c.Class._isCCClass(n)?this._deserializeFireClass(e,t,n):this._deserializeFastDefinedObject(e,t,n):this._runCustomizedDeserialize(t,e,n)},e._runCustomizedDeserialize=function(t,e,n){var i=this,r={readProperty:function(e){var n=t[e];return"object"==typeof n&&n?i._deserializeObjectField(n):n},readThis:function(){i._deserializeInto(t,e,n,!0)},readSuper:function(){var r=Gt(n);r&&i._deserializeInto(t,e,r)}};e[sh](r,this._context)},e._deserializeFireClass=function(t,e,n){var i;if(n.hasOwnProperty("__deserialize__"))i=n.__deserialize__;else{i=function(t,e){for(var n=we(e),i=e.__values__,r=["var prop;"],o=le.test(Zt(e)),a=0;a<i.length;a++){var s=i[a],l=void 0,u=void 0;Je.IDENTIFIER_RE.test(s)?(u='"'+s+'"',l="."+s):l="["+(u=Je.escapeForJS(s))+"]";var h=l;if(n[s+ph]){var _=n[s+ph];h=Je.IDENTIFIER_RE.test(_)?"."+_:"["+Je.escapeForJS(_)+"]"}r.push("prop=d"+h+";"),r.push('if(typeof prop!=="undefined"){');var f=Je.getDefault(n[s+fh]);if(o){var p=void 0,d=n[s+"$_$type"];if(void 0===f&&d)p=d instanceof Ie;else{var m=typeof f;p="string"===m||"number"===m||"boolean"===m}p?r.push("o"+l+"=prop;"):_h(r,f,l,u,!0)}else r.push('if(typeof prop!=="object"){o'+l+"=prop;}else{"),_h(r,f,l,u,!1),r.push("}");r.push("}")}return(c.js.isChildClassOf(e,c._BaseNode)||c.js.isChildClassOf(e,c.Component))&&r.push("d._id&&(o._id=d._id);"),"_$erialized"===i[i.length-1]&&(r.push("o._$erialized=JSON.parse(JSON.stringify(d));"),r.push("s._fillPlainObject(o._$erialized,d);")),Function("s","o","d","k",r.join(""))}(0,n);try{if(n===Zu){var r=n.__values__;0!==r.length&&"_$erialized"===r[r.length-1]||(x("The '_$erialized' prop of MissingScript is missing. Will force the raw data to be save."),x("    Error props: ['"+r+"']. Please contact jare."));var o=i;i=function(t,e,n,i){try{JSON.parse(JSON.stringify(n._$erialized))||x("Unable to load previously serialized data. "+JSON.stringify(n))}catch(t){x("Error when checking MissingScript 7, "+t)}o(t,e,n,i)}}}catch(t){x("Error when checking MissingScript 6, "+t)}Ct(n,"__deserialize__",i,!0)}i(this,t,e,n)},e._deserializeAndAssignField=function(t,e,n){var i=e.__id__;if("number"==typeof i){var r=this.deserializedList[i];if(r)t[n]=r;else{var o,a=this._serializedData[i];t[n]=this._deserializeObject(a,i,void 0,n),null===(o=this._onDereferenced)||void 0===o||o.call(this,this.deserializedList,i,t,n)}}else{var s=e.__uuid__;if(s){var c=e.__expectedType__;this.result.push(t,n,s,c)}else t[n]=this._deserializeObject(e,-1)}return!1},e._deserializeObjectField=function(t){var e=t.__id__;if("number"==typeof e){var n=this.deserializedList[e];if(n)return n;var i=this._serializedData[e];return this._deserializeObject(i,e,void 0,void 0)}if(t.__uuid__)throw t.__expectedType__,new Error("Asset reference field serialization is currently not supported in custom serialization.");return this._deserializeObject(t,-1)},e._fillPlainObject=function(t,e){for(var n in e)if(e.hasOwnProperty(n)){var i=e[n];"object"!=typeof i?"__type__"!==n&&(t[n]=i):i?this._deserializeAndAssignField(t,i,n)&&(t[n]=null):t[n]=null}},e._deserializeFastDefinedObject=function(t,e,n){if(n===c.Vec2)return t.x=e.x||0,void(t.y=e.y||0);if(n===c.Vec3)return t.x=e.x||0,t.y=e.y||0,void(t.z=e.z||0);if(n!==c.Color){if(n===c.Size)return t.width=e.width||0,void(t.height=e.height||0);for(var i=we(n),r=n.__values__,o=0;o<r.length;o++){var a=r[o],s=e[a];void 0!==s||e.hasOwnProperty(a)||(s=Je.getDefault(i[a+fh])),"object"!=typeof s?t[a]=s:s?this._deserializeAndAssignField(t,s,a):t[a]=null}}else{t.r=e.r||0,t.g=e.g||0,t.b=e.b||0;var l=e.a;t.a=void 0===l?255:l}},t}();mh.pool=new dh;var vh=[Wn,En,Kn,Mn,bn,Zn,ti,Un];function gh(t,e){t.x=e[1],t.y=e[2],t.z=e[3],t.w=e[4]}var yh=[function(t,e){t.x=e[1],t.y=e[2]},function(t,e){t.x=e[1],t.y=e[2],t.z=e[3]},gh,gh,function(t,e){t._val=e[1]},function(t,e){t.width=e[1],t.height=e[2]},function(t,e){t.x=e[1],t.y=e[2],t.width=e[3],t.height=e[4]},function(t,e){Un.fromArray(t,e,1)}],xh=t("Details",function(){function t(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}var e=t.prototype;return e.init=function(t){t?(this.uuidObjList=t[8],this.uuidPropList=t[9],this.uuidList=t[10]):this.uuidList||(this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this.uuidTypeList=[])},e.reset=function(){this.uuidList&&(this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,this.uuidTypeList.length=0)},e.push=function(t,e,n,i){this.uuidObjList.push(t),this.uuidPropList.push(e),this.uuidList.push(n),this.uuidTypeList.push(i||"")},t}());function Sh(t,e){for(var n=t[4][e[0]],i=n[0],r=new(0,i[0]),o=i[1],a=i[2],s=n[n.length-1],c=1;c<s;++c)r[o[n[c]]]=e[c];for(;c<e.length;++c){var l=o[n[c]],u=i[n[c]+a];(0,wh[u])(t,r,l,e[c])}return r}function Ch(t,e,n){var i=new e;return i._deserialize?i._deserialize(n,t[0]):D(5303,wt(e)),i}function Ah(t,e,n,i){i>=0?e[n]=t[5][i]:t[7][3*~i]=e}function bh(t){return function(e,n,i,r){n[i]=r;for(var o=0;o<r.length;++o)t(e,r,o,r[o])}}function Th(t,e,n,i){e[n]=null,t[8][i]=e}function Eh(t,e,n,i){e[n]=Sh(t,i)}xh.pool=new $t((function(t){t.reset()}),5),xh.pool.get=function(){return this._get()||new xh};var wh=new Array(13);function Ph(t,e,n){return t||n(e),Object}function Ih(t,e,n,i,r,o,a){var s=t(e);if(!s){if(r)return void(n[i]=function(e,n,i){return function(){var r=t(i)||Ph(o,i,a);return e[n]=r,new r}}(n,i,e));s=Ph(o,e,a)}n[i]=s}function Rh(t,e,n,i){for(var r=n||Jt,o=t[3],a=0;a<o.length;++a){var s=o[a];"string"!=typeof s?Ih(r,s[0],s,0,e,n,i):Ih(r,s,o,a,e,n,i)}}function Dh(t){var e=t[4];if(e)for(var n=t[3],i=0;i<e.length;++i){var r=e[i];r[0]=n[r[0]]}}function Bh(t,e,n){"string"==typeof t&&(t=JSON.parse(t));var i,r=!e;if(e=e||xh.pool.get(),function(t){if(Array.isArray(t)){var e=t[0];return"number"==typeof e||e instanceof Mh}return!1}(t)){e.init(t),n=n||{};var o,a=t[0],s=!1;if("object"==typeof a&&(s=a.preprocessed,a=a.version),a<1)throw new Error(N(5304,a));n._version=a,n.result=e,t[0]=n,s||(Rh(t,!1,n.classFinder,null!==(o=n.reportMissingClass)&&void 0!==o?o:Bh.reportMissingClass),Dh(t)),c.game._isCloning=!0;var l=t[5],u=function(t){var e=t[5],n=t[6],i=0===n?0:n.length,r=e[e.length-1],o=e.length-i;"number"!=typeof r?r=0:(r<0&&(r=~r),--o);for(var a=0;a<o;++a)e[a]=Sh(t,e[a]);for(var s=t[3],c=0;c<i;++c,++a){var l=n[c],u=e[a];if(l>=0){var h=s[l];e[a]=Ch(t,h,u)}else(0,wh[l=~l])(t,e,a,u)}return r}(t);c.game._isCloning=!1,t[7]&&function(t,e,n){for(var i=t.length-1,r=0,o=3*t[i];r<o;r+=3){var a=t[r],s=e[t[r+2]],c=t[r+1];c>=0?a[n[c]]=s:a[~c]=s}for(;r<i;r+=3){var l=e[t[r]],u=e[t[r+2]],h=t[r+1];h>=0?l[n[h]]=u:l[~h]=u}}(t[7],l,t[2]),function(t){for(var e=t[5],n=t[2],i=t[1],r=t[8],o=t[9],a=t[10],s=0;s<r.length;++s){var c=r[s];"number"==typeof c&&(r[s]=e[c]);var l=o[s];"number"==typeof l&&(l=l>=0?n[l]:~l,o[s]=l);var u=a[s];"number"==typeof u&&(a[s]=i[u])}}(t),i=l[u]}else i=function(t,e,n){var i,r=(n=n||{}).classFinder||Jt,o=n.createAssetRefs||oh.platform===iu.EDITOR_CORE,a=n.customEnv,s=n.ignoreEditorOnly,l=null!==(i=n.reportMissingClass)&&void 0!==i?i:c.deserialize.reportMissingClass;e.init();var u=mh.pool.get(e,r,l,a,s);c.game._isCloning=!0;var h=u.deserialize(t);return c.game._isCloning=!1,mh.pool.put(u),o&&e.assignAssetsBy(EditorExtends.serialize.asAsset),h}(t,e,n);return r&&xh.pool.put(e),i}wh[0]=function(t,e,n,i){e[n]=i},wh[1]=Ah,wh[2]=bh(Ah),wh[3]=bh(Th),wh[4]=Eh,wh[5]=function(t,e,n,i){yh[i[0]](e[n],i)},wh[6]=Th,wh[7]=function(t,e,n,i){e[n].set(i)},wh[8]=function(t,e,n,i){var r=new vh[i[0]];yh[i[0]](r,i),e[n]=r},wh[9]=bh(Eh),wh[10]=function(t,e,n,i){var r=t[3][i[0]];e[n]=Ch(t,r,i[1])},wh[11]=function(t,e,n,i){var r=i[0];e[n]=r;for(var o=1;o<i.length;o+=3){var a=i[o],s=i[o+1],c=i[o+2];(0,wh[s])(t,r,a,c)}},wh[12]=function(t,e,n,i){var r=i[0];e[n]=r;for(var o=0;o<r.length;++o){var a=r[o],s=i[o+1];0!==s&&(0,wh[s])(t,r,o,a)}},Bh.Details=xh,Bh.reportMissingClass=function(t){D(5302,t)};var Mh=function(t){this.preprocessed=!0,this.version=t};function Oh(t,e,n){return[1,0,0,[t],0,n?[e,-1]:[e],[0],0,[],[],[]]}c.deserialize=Bh;var Nh,Lh,Fh,zh,Gh,Vh,Uh,kh,Hh,jh,Wh,qh=ul.Flags.Destroyed,Xh=ul.Flags.PersistentMask,Yh=[];function Kh(t){var e;if(t instanceof ul){if(t._instantiate)return c.game._isCloning=!0,e=t._instantiate(null,!0),c.game._isCloning=!1,e;if(t instanceof c.Asset)throw new TypeError(N(6903))}return c.game._isCloning=!0,e=Jh(t),c.game._isCloning=!1,e}function Jh(t,e){var n;Qh(t,n=t._iN$t?t._iN$t:t.constructor?new(0,t.constructor):Object.create(null),e);for(var i=0,r=Yh.length;i<r;++i)Yh[i]._iN$t=null;return Yh.length=0,n}function Qh(t,e,n){ee.value(t,"_iN$t",e,!0),Yh.push(t);var i=t.constructor;if(c.Class._isCCClass(i))!function(t,e,n,i){for(var r=t.__values__,o=0;o<r.length;o++){var a=r[o],s=e[a];if("object"==typeof s&&s){var c=n[a];c instanceof se&&c.constructor===s.constructor?c.set(s):n[a]=s._iN$t||Zh(s,i)}else n[a]=s}}(i,t,e,n);else for(var r in t)if(t.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r||"__prefab"===r)){var o=t[r];if("object"==typeof o&&o){if(o===e)continue;e[r]=o._iN$t||Zh(o,n)}else e[r]=o}t instanceof ul&&(e._objFlags&=Xh)}function Zh(t,e){if(t instanceof se)return t.clone();if(t instanceof c.Asset)return t;var n;if(ArrayBuffer.isView(t)){var i=t.length;n=new t.constructor(i),t._iN$t=n,Yh.push(t);for(var r=0;r<i;++r)n[r]=t[r];return n}if(Array.isArray(t)){var o=t.length;n=new Array(o),t._iN$t=n,Yh.push(t);for(var a=0;a<o;++a){var s=t[a];n[a]="object"==typeof s&&s?s._iN$t||Zh(s,e):s}return n}if(t._objFlags&qh)return null;var l=t.constructor;if(c.Class._isCCClass(l)){if(e)if(e instanceof c.Component){if(t instanceof c._BaseNode||t instanceof c.Component)return t}else if(e instanceof c._BaseNode)if(t instanceof c._BaseNode){if(!t.isChildOf(e))return t}else if(t instanceof c.Component&&t.node&&!t.node.isChildOf(e))return t;n=new l}else if(l===Object)n={};else{if(l)return t;n=Object.create(null)}return Qh(t,n,e),n}function $h(t,e){return(e<<3)+t}function t_(t){return n_[t]}function e_(t){switch(t){case jh.Uint8:return Uint8Array;case jh.Uint16:return Uint16Array;case jh.Uint32:return Uint32Array;case jh.Int8:return Int8Array;case jh.Int16:return Int16Array;case jh.Int32:return Int32Array;case jh.Float32:return Float32Array;case jh.Float64:return Float64Array}}Kh._clone=Jh,c.instantiate=Kh,function(t){t[t.Uint8=0]="Uint8",t[t.Uint16=1]="Uint16",t[t.Uint32=2]="Uint32",t[t.Int8=3]="Int8",t[t.Int16=4]="Int16",t[t.Int32=5]="Int32",t[t.Float32=6]="Float32",t[t.Float64=7]="Float64"}(jh||(jh={})),function(t){t[t.Scalar=0]="Scalar",t[t.Vec2=1]="Vec2",t[t.Vec3=2]="Vec3",t[t.Vec4=3]="Vec4",t[t.Quat=4]="Quat",t[t.Mat4=5]="Mat4"}(Wh||(Wh={})),t("CompactValueTypeArray",hc("cc.CompactValueTypeArray")((kh=Uh=function(){function t(){at(this,"_byteOffset",Fh,this),at(this,"_unitCount",zh,this),at(this,"_unitElement",Gh,this),at(this,"_length",Vh,this)}return t.lengthFor=function(t,e,n){return t_(e).requiredUnits*t.length*e_(n).BYTES_PER_ELEMENT},t.compress=function(e,n,i,r,o,a){for(var s=t_(n),c=e_(i),l=s.requiredUnits*e.length,u=new c(r,o,l),h=0;h<e.length;++h)s.compress(u,h,e[h]);var _=new t;return _._unitElement=$h(i,n),_._byteOffset=a,_._unitCount=l,_._length=e.length,_},t.prototype.decompress=function(t){for(var e,n={storageUnit:7&(e=this._unitElement),elementType:e>>3},i=n.storageUnit,r=t_(n.elementType),o=new(e_(i))(t,this._byteOffset,this._unitCount),a=new Array(this._length),s=0;s<this._length;++s)a[s]=r.decompress(o,s);return a},t}(),Uh.StorageUnit=jh,Uh.ElementType=Wh,Fh=st((Lh=kh).prototype,"_byteOffset",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zh=st(Lh.prototype,"_unitCount",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Gh=st(Lh.prototype,"_unitElement",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $h(jh.Uint8,Wh.Scalar)}}),Vh=st(Lh.prototype,"_length",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Nh=Lh))||Nh);var n_=((Hh={})[Wh.Scalar]={requiredUnits:1,compress:function(t,e,n){t[e]=n},decompress:function(t,e){return t[e]}},Hh[Wh.Vec2]={requiredUnits:2,compress:function(t,e,n){t[2*e]=n.x,t[2*e+1]=n.y},decompress:function(t,e){return new En(t[2*e],t[2*e+1])}},Hh[Wh.Vec3]={requiredUnits:3,compress:function(t,e,n){t[3*e]=n.x,t[3*e+1]=n.y,t[3*e+2]=n.z},decompress:function(t,e){return new En(t[3*e],t[3*e+1],t[3*e+2])}},Hh[Wh.Vec4]={requiredUnits:4,compress:function(t,e,n){t[4*e]=n.x,t[4*e+1]=n.y,t[4*e+2]=n.z,t[4*e+3]=n.w},decompress:function(t,e){return new Kn(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])}},Hh[Wh.Quat]={requiredUnits:4,compress:function(t,e,n){t[4*e]=n.x,t[4*e+1]=n.y,t[4*e+2]=n.z,t[4*e+3]=n.w},decompress:function(t,e){return new Mn(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])}},Hh[Wh.Mat4]={requiredUnits:16,compress:function(t,e,n){Un.toArray(t,n,16*e)},decompress:function(t,e){return Un.fromArray(new Un,t,16*e)}},Hh);function i_(){return 0}function r_(t){return t}function o_(t){return t*t}function a_(t){return t*(2-t)}function s_(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)}function c_(t){return t*t*t}function l_(t){return--t*t*t+1}function u_(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)}function h_(t){return t*t*t*t}function __(t){return 1- --t*t*t*t}function f_(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)}function p_(t){return t*t*t*t*t}function d_(t){return--t*t*t*t*t+1}function m_(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)}function v_(t){return 1===t?1:1-Math.cos(t*Math.PI/2)}function g_(t){return Math.sin(t*Math.PI/2)}function y_(t){return.5*(1-Math.cos(Math.PI*t))}function x_(t){return 0===t?0:Math.pow(1024,t-1)}function S_(t){return 1===t?1:1-Math.pow(2,-10*t)}function C_(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))}function A_(t){return 1-Math.sqrt(1-t*t)}function b_(t){return Math.sqrt(1- --t*t)}function T_(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)}function E_(t){var e,n=.1;return 0===t?0:1===t?1:(!n||n<1?(n=1,e=.1):e=.4*Math.asin(1/n)/(2*Math.PI),-n*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4))}function w_(t){var e,n=.1;return 0===t?0:1===t?1:(!n||n<1?(n=1,e=.1):e=.4*Math.asin(1/n)/(2*Math.PI),n*Math.pow(2,-10*t)*Math.sin(2*(t-e)*Math.PI/.4)+1)}function P_(t){var e,n=.1;return 0===t?0:1===t?1:(!n||n<1?(n=1,e=.1):e=.4*Math.asin(1/n)/(2*Math.PI),(t*=2)<1?n*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*-.5:n*Math.pow(2,-10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*.5+1)}function I_(t){if(1===t)return 1;var e=1.70158;return t*t*((e+1)*t-e)}function R_(t){if(0===t)return 0;var e=1.70158;return--t*t*((e+1)*t+e)+1}function D_(t){var e=2.5949095;return(t*=2)<1?t*t*((e+1)*t-e)*.5:.5*((t-=2)*t*((e+1)*t+e)+2)}function B_(t){return 1-M_(1-t)}function M_(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375}function O_(t){return t<.5?.5*B_(2*t):.5*M_(2*t-1)+.5}function N_(t){return t<=0?0:t>=1?1:t*t*(3-2*t)}function L_(t){return t<=0?0:t>=1?1:t*t*t*(t*(6*t-15)+10)}c._decorator=sl;var F_=X_(o_,a_),z_=X_(c_,l_),G_=X_(h_,__),V_=X_(p_,d_),U_=X_(v_,g_),k_=X_(x_,S_),H_=X_(A_,b_),j_=X_(E_,w_),W_=X_(I_,R_),q_=X_(B_,M_);function X_(t,e){return function(n){return n<.5?e(2*n)/2:t(2*n-1)/2+.5}}var Y_,K_,J_=Object.freeze({__proto__:null,constant:i_,linear:r_,quadIn:o_,quadOut:a_,quadInOut:s_,cubicIn:c_,cubicOut:l_,cubicInOut:u_,quartIn:h_,quartOut:__,quartInOut:f_,quintIn:p_,quintOut:d_,quintInOut:m_,sineIn:v_,sineOut:g_,sineInOut:y_,expoIn:x_,expoOut:S_,expoInOut:C_,circIn:A_,circOut:b_,circInOut:T_,elasticIn:E_,elasticOut:w_,elasticInOut:P_,backIn:I_,backOut:R_,backInOut:D_,bounceIn:B_,bounceOut:M_,bounceInOut:O_,smooth:N_,fade:L_,quadOutIn:F_,cubicOutIn:z_,quartOutIn:G_,quintOutIn:V_,sineOutIn:U_,expoOutIn:k_,circOutIn:H_,elasticOutIn:j_,backOutIn:W_,bounceOutIn:q_});t("easing",J_),function(t){t[t.LINEAR=0]="LINEAR",t[t.CONSTANT=1]="CONSTANT",t[t.QUAD_IN=2]="QUAD_IN",t[t.QUAD_OUT=3]="QUAD_OUT",t[t.QUAD_IN_OUT=4]="QUAD_IN_OUT",t[t.QUAD_OUT_IN=5]="QUAD_OUT_IN",t[t.CUBIC_IN=6]="CUBIC_IN",t[t.CUBIC_OUT=7]="CUBIC_OUT",t[t.CUBIC_IN_OUT=8]="CUBIC_IN_OUT",t[t.CUBIC_OUT_IN=9]="CUBIC_OUT_IN",t[t.QUART_IN=10]="QUART_IN",t[t.QUART_OUT=11]="QUART_OUT",t[t.QUART_IN_OUT=12]="QUART_IN_OUT",t[t.QUART_OUT_IN=13]="QUART_OUT_IN",t[t.QUINT_IN=14]="QUINT_IN",t[t.QUINT_OUT=15]="QUINT_OUT",t[t.QUINT_IN_OUT=16]="QUINT_IN_OUT",t[t.QUINT_OUT_IN=17]="QUINT_OUT_IN",t[t.SINE_IN=18]="SINE_IN",t[t.SINE_OUT=19]="SINE_OUT",t[t.SINE_IN_OUT=20]="SINE_IN_OUT",t[t.SINE_OUT_IN=21]="SINE_OUT_IN",t[t.EXPO_IN=22]="EXPO_IN",t[t.EXPO_OUT=23]="EXPO_OUT",t[t.EXPO_IN_OUT=24]="EXPO_IN_OUT",t[t.EXPO_OUT_IN=25]="EXPO_OUT_IN",t[t.CIRC_IN=26]="CIRC_IN",t[t.CIRC_OUT=27]="CIRC_OUT",t[t.CIRC_IN_OUT=28]="CIRC_IN_OUT",t[t.CIRC_OUT_IN=29]="CIRC_OUT_IN",t[t.ELASTIC_IN=30]="ELASTIC_IN",t[t.ELASTIC_OUT=31]="ELASTIC_OUT",t[t.ELASTIC_IN_OUT=32]="ELASTIC_IN_OUT",t[t.ELASTIC_OUT_IN=33]="ELASTIC_OUT_IN",t[t.BACK_IN=34]="BACK_IN",t[t.BACK_OUT=35]="BACK_OUT",t[t.BACK_IN_OUT=36]="BACK_IN_OUT",t[t.BACK_OUT_IN=37]="BACK_OUT_IN",t[t.BOUNCE_IN=38]="BOUNCE_IN",t[t.BOUNCE_OUT=39]="BOUNCE_OUT",t[t.BOUNCE_IN_OUT=40]="BOUNCE_IN_OUT",t[t.BOUNCE_OUT_IN=41]="BOUNCE_OUT_IN",t[t.SMOOTH=42]="SMOOTH",t[t.FADE=43]="FADE"}(K_||(K_={}));var Q_,Z_,$_,tf,ef,nf=((Y_={})[K_.CONSTANT]=i_,Y_[K_.LINEAR]=r_,Y_[K_.QUAD_IN]=o_,Y_[K_.QUAD_OUT]=a_,Y_[K_.QUAD_IN_OUT]=s_,Y_[K_.QUAD_OUT_IN]=F_,Y_[K_.CUBIC_IN]=c_,Y_[K_.CUBIC_OUT]=l_,Y_[K_.CUBIC_IN_OUT]=u_,Y_[K_.CUBIC_OUT_IN]=z_,Y_[K_.QUART_IN]=h_,Y_[K_.QUART_OUT]=__,Y_[K_.QUART_IN_OUT]=f_,Y_[K_.QUART_OUT_IN]=G_,Y_[K_.QUINT_IN]=p_,Y_[K_.QUINT_OUT]=d_,Y_[K_.QUINT_IN_OUT]=m_,Y_[K_.QUINT_OUT_IN]=V_,Y_[K_.SINE_IN]=v_,Y_[K_.SINE_OUT]=g_,Y_[K_.SINE_IN_OUT]=y_,Y_[K_.SINE_OUT_IN]=U_,Y_[K_.EXPO_IN]=x_,Y_[K_.EXPO_OUT]=S_,Y_[K_.EXPO_IN_OUT]=C_,Y_[K_.EXPO_OUT_IN]=k_,Y_[K_.CIRC_IN]=A_,Y_[K_.CIRC_OUT]=b_,Y_[K_.CIRC_IN_OUT]=T_,Y_[K_.CIRC_OUT_IN]=H_,Y_[K_.ELASTIC_IN]=E_,Y_[K_.ELASTIC_OUT]=w_,Y_[K_.ELASTIC_IN_OUT]=P_,Y_[K_.ELASTIC_OUT_IN]=j_,Y_[K_.BACK_IN]=I_,Y_[K_.BACK_OUT]=R_,Y_[K_.BACK_IN_OUT]=D_,Y_[K_.BACK_OUT_IN]=W_,Y_[K_.BOUNCE_IN]=B_,Y_[K_.BOUNCE_OUT]=M_,Y_[K_.BOUNCE_IN_OUT]=O_,Y_[K_.BOUNCE_OUT_IN]=q_,Y_[K_.SMOOTH]=N_,Y_[K_.FADE]=L_,Y_);function rf(t){return nf[t]}var of,af,sf,cf=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).interpolationMode=Zc.LINEAR,e.tangentWeightMode=tl.NONE,e.value=0,e.rightTangent=0,e.rightTangentWeight=0,e.leftTangent=0,e.leftTangentWeight=0,e.easingMethod=K_.LINEAR,e}return Q(e,t),e}(al);function lf(t){var e=new cf;if("number"==typeof t)e.value=t;else{var n=t.interpolationMode,i=t.tangentWeightMode,r=t.value,o=t.rightTangent,a=t.rightTangentWeight,s=t.leftTangent,c=t.leftTangentWeight,l=t.easingMethod,u=t[ol];e.value=null!=r?r:e.value,e.rightTangent=null!=o?o:e.rightTangent,e.rightTangentWeight=null!=a?a:e.rightTangentWeight,e.leftTangent=null!=s?s:e.leftTangent,e.leftTangentWeight=null!=c?c:e.leftTangentWeight,e.interpolationMode=null!=n?n:e.interpolationMode,e.tangentWeightMode=null!=i?i:e.tangentWeightMode,e.easingMethod=null!=l?l:e.easingMethod,u&&(e[ol]=u)}return e}Je.fastDefine("cc.RealKeyframeValue",cf,{interpolationMode:Zc.LINEAR,tangentWeightMode:tl.NONE,value:0,rightTangent:0,rightTangentWeight:0,leftTangent:0,leftTangentWeight:0,easingMethod:K_.LINEAR}),Je.Attr.setClassAttr(cf,ol,"editorOnly",!0),(of=cf,null!==(sf=(af=of)[mc])&&void 0!==sf?sf:af[mc]={}).uniquelyReferenced=!0;var uf,hf=t("RealCurve",hc("cc.RealCurve")((ef=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"preExtrapolation",$_,it(e)),at(e,"postExtrapolation",tf,it(e)),e}Q(e,t);var n=e.prototype;return n.evaluate=function(t){var e=this._times,n=this._values,i=e.length;if(0===i)return 0;var r=e[0],o=e[i-1];if(t<r){var a=this.preExtrapolation,s=n[0];if(a===$c.CLAMP||i<2)return s.value;switch(a){case $c.LINEAR:return wf(r,n[0].value,e[1],n[1].value,t);case $c.LOOP:t=Tf(t,r,o);break;case $c.PING_PONG:t=Ef(t,r,o);break;default:return s.value}}else if(t>o){var c=this.postExtrapolation,l=n[i-1];if(c===$c.CLAMP||i<2)return l.value;switch(c){case $c.LINEAR:return wf(o,l.value,e[i-2],n[i-2].value,t);case $c.LOOP:t=Tf(t,r,o);break;case $c.PING_PONG:t=Ef(t,r,o);break;default:return l.value}}var u=nc(e,t);if(u>=0)return n[u].value;var h=~u,_=h-1,f=e[_],p=n[_],d=e[h];return function(t,e,n,i,r){var o=n-t;switch(e.interpolationMode){default:case Zc.CONSTANT:return e.value;case Zc.LINEAR:var a=e.easingMethod===K_.LINEAR?r:rf(e.easingMethod)(r);return sn(e.value,i.value,a);case Zc.CUBIC:var s=1/3,c=e.rightTangent,l=e.rightTangentWeight,u=0!=(e.tangentWeightMode&tl.RIGHT),h=i.leftTangent,_=i.leftTangentWeight,f=0!=(i.tangentWeightMode&tl.LEFT);if(u||f){var p=0;if(u)p=l;else{var d=o,m=o*c;p=Math.sqrt(d*d+m*m)*s}var v=Math.atan(c),g=Math.cos(v)*p+t,y=Math.sin(v)*p+e.value,x=0;if(f)x=_;else{var S=o,C=o*h;x=Math.sqrt(S*S+C*C)*s}var A=Math.atan(h),b=(g-t)/o,T=(-Math.cos(A)*x+n-t)/o,E=y,w=-Math.sin(A)*x+i.value,P=[0,0,0],I=function(t,e,n,i,r){var o=n/i,a=e/i,s=o*o,c=1/3*(-1/3*s+a),l=.5*(2/27*o*s-1/3*o*a+t/i),u=c*c*c,h=l*l+u,_=0;if(il(h)){if(il(l))return r[0]=0,1;var f=Math.cbrt(-l);return r[0]=2*f,r[1]=-f,2}if(h<0){var p=1/3*Math.acos(-l/Math.sqrt(-u)),d=2*Math.sqrt(-c);r[0]=d*Math.cos(p),r[1]=-d*Math.cos(p+Math.PI/3),r[2]=-d*Math.cos(p-Math.PI/3),_=3}else{var m=Math.sqrt(h),v=Math.cbrt(m-l),g=-Math.cbrt(m+l);r[0]=v+g,_=1}for(var y=1/3*o,x=0;x<_;++x)r[x]-=y;return _}(0-r,3*b,3*T-6*b,3*(b-T)+1,P),R=function(t,e,n){var i=n;if(1===e)i=t[0];else{i=-1/0;for(var r=0;r<e;++r){var o=t[r];o>=0&&o<=1&&o>i&&(i=o)}i===-1/0&&(i=0)}return i}(P,I,r);return Pf(e.value,E,w,i.value,R)}var D=e.value+s*c*o,B=i.value-s*h*o;return Pf(e.value,D,B,i.value,r)}}(f,p,d,n[h],(t-f)/(d-f))},n.addKeyFrame=function(e,n){return t.prototype.addKeyFrame.call(this,e,lf(n))},n.assignSorted=function(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.map((function(t){return lf(t)})));else{var n=Array.from(t);this.setKeyframes(n.map((function(t){return t[0]})),n.map((function(t){return lf(t[1])})))}},n.isConstant=function(t){if(this._values.length<=1)return!0;var e=this._values[0].value;return this._values.every((function(n){return rn(n.value,e,t)}))},n[ah]=function(t,e){if(e.toCCON){var n=this._times,i=this._values,r=n.length,o=new DataView(new ArrayBuffer(0+_f+_f+ff+pf*r+Cf*r)),a=0;o.setUint8(a,this.preExtrapolation),a+=_f,o.setUint8(a,this.postExtrapolation),a+=_f,o.setUint32(a,r,!0),a+=ff,n.forEach((function(t,e){return o.setFloat32(a+pf*e,t,!0)})),a+=pf*r;for(var s,c=ot(i);!(s=c()).done;){var l=s.value;a=Af(o,l,a)}var u=new Uint8Array(o.buffer,0,a);t.writeProperty("bytes",u);var h=i.map((function(t){return t[ol]}));h.some((function(t){return void 0!==t}))&&t.writeProperty("keyframeValueEditorExtras",h)}else t.writeThis()},n[sh]=function(t,e){if(e.fromCCON){var n=t.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0;this.preExtrapolation=i.getUint8(r),r+=_f,this.postExtrapolation=i.getUint8(r),r+=_f;var o=i.getUint32(r,!0);r+=ff;var a=Array.from({length:o},(function(t,e){return i.getFloat32(r+pf*e,!0)}));r+=pf*o;for(var s=new Array(o),c=0;c<o;++c){var l=lf({});r=bf(i,l,r),s[c]=l}n.byteLength;var u=t.readProperty("keyframeValueEditorExtras");u&&(u.length,u.forEach((function(t,e){return s[e][ol]=t}))),this._times=a,this._values=s}else t.readThis()},e}(nl),$_=st((Z_=ef).prototype,"preExtrapolation",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $c.CLAMP}}),tf=st(Z_.prototype,"postExtrapolation",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $c.CLAMP}}),Q_=Z_))||Q_);!function(t){t[t.VALUE=1]="VALUE",t[t.INTERPOLATION_MODE=2]="INTERPOLATION_MODE",t[t.TANGENT_WEIGHT_MODE=4]="TANGENT_WEIGHT_MODE",t[t.LEFT_TANGENT=8]="LEFT_TANGENT",t[t.LEFT_TANGENT_WEIGHT=16]="LEFT_TANGENT_WEIGHT",t[t.RIGHT_TANGENT=32]="RIGHT_TANGENT",t[t.RIGHT_TANGENT_WEIGHT=64]="RIGHT_TANGENT_WEIGHT"}(uf||(uf={}));var _f=1,ff=4,pf=4,df=lf({}),mf=df.interpolationMode,vf=df.tangentWeightMode,gf=df.leftTangent,yf=df.leftTangentWeight,xf=df.rightTangent,Sf=df.rightTangentWeight,Cf=26;function Af(t,e,n){var i=0,r=n,o=r;r+=4;var a=e.value,s=e.interpolationMode,c=e.tangentWeightMode,l=e.rightTangent,u=e.rightTangentWeight,h=e.leftTangent,_=e.leftTangentWeight,f=e.easingMethod;return t.setFloat32(r,a,!0),r+=4,s!==mf&&(i|=uf.INTERPOLATION_MODE,t.setUint8(r,s),r+=1),c!==vf&&(i|=uf.TANGENT_WEIGHT_MODE,t.setUint8(r,c),r+=1),h!==gf&&(i|=uf.LEFT_TANGENT,t.setFloat32(r,h,!0),r+=4),_!==yf&&(i|=uf.LEFT_TANGENT_WEIGHT,t.setFloat32(r,_,!0),r+=4),l!==xf&&(i|=uf.RIGHT_TANGENT,t.setFloat32(r,l,!0),r+=4),u!==Sf&&(i|=uf.RIGHT_TANGENT_WEIGHT,t.setFloat32(r,u,!0),r+=4),i|=f<<8,t.setUint32(o,i,!0),r}function bf(t,e,n){var i=n,r=t.getUint32(i,!0);i+=4,e.value=t.getFloat32(i,!0),i+=4,r&uf.INTERPOLATION_MODE&&(e.interpolationMode=t.getUint8(i),i+=1),r&uf.TANGENT_WEIGHT_MODE&&(e.tangentWeightMode=t.getUint8(i),i+=1),r&uf.LEFT_TANGENT&&(e.leftTangent=t.getFloat32(i,!0),i+=4),r&uf.LEFT_TANGENT_WEIGHT&&(e.leftTangentWeight=t.getFloat32(i,!0),i+=4),r&uf.RIGHT_TANGENT&&(e.rightTangent=t.getFloat32(i,!0),i+=4),r&uf.RIGHT_TANGENT_WEIGHT&&(e.rightTangentWeight=t.getFloat32(i,!0),i+=4);var o=(65280&r)>>8;return e.easingMethod=o,i}function Tf(t,e,n){return e+vn(t-e,n-e)}function Ef(t,e,n){return e+gn(t-e,n-e)}function wf(t,e,n,i,r){return e+(i-e)/(n-t)*(r-t)}function Pf(t,e,n,i,r){var o=1-r;return o*o*o*t+3*o*o*r*e+3*o*r*r*n+r*r*r*i}function If(t,e,n,i,r){var o=1-r;return o*(o*(t+(3*e-t)*r)+3*n*r*r)+i*r*r*r}c.bezier=If;var Rf,Df,Bf,Mf,Of,Nf,Lf,Ff,zf,Gf,Vf,Uf=Math.cos,kf=Math.acos,Hf=Math.max,jf=2*Math.PI,Wf=Math.sqrt;function qf(t){return t<0?-Math.pow(-t,1/3):Math.pow(t,1/3)}function Xf(t,e){var n=function(t,e){var n,i,r,o,a=e-0,s=e-t[0],c=3*a,l=3*s,u=3*(e-t[2]),h=1/(-a+l-u+(e-1)),_=1/3,f=(c-6*s+u)*h,p=f*_,d=(-c+l)*h,m=(3*d-f*f)*_,v=m*_,g=(2*f*f*f-9*f*d+a*h*27)/27,y=g/2,x=y*y+v*v*v;if(x<0){var S=-m*_,C=Wf(S*S*S),A=-g/(2*C),b=kf(A<-1?-1:A>1?1:A),T=2*qf(C);return i=T*Uf(b*_)-p,r=T*Uf((b+jf)*_)-p,o=T*Uf((b+2*jf)*_)-p,i>=0&&i<=1?r>=0&&r<=1?o>=0&&o<=1?Hf(i,r,o):Hf(i,r):o>=0&&o<=1?Hf(i,o):i:r>=0&&r<=1?o>=0&&o<=1?Hf(r,o):r:o}if(0===x)return r=-(n=y<0?qf(-y):-qf(y))-p,(i=2*n-p)>=0&&i<=1?r>=0&&r<=1?Hf(i,r):i:r;var E=Wf(x);return(n=qf(-y+E))-qf(y+E)-p}(t,e),i=t[1];return((1-n)*(i+(t[3]-i)*n)*3+n*n)*n}c.bezierByTime=Xf,function(t){t[t.SLERP=0]="SLERP",t[t.CONSTANT=1]="CONSTANT"}(Vf||(Vf=t("QuatInterpolationMode",{})));var Yf=hc("cc.QuatKeyframeValue")(Rf=Sc((Bf=st((Df=function(t){var e=void 0===t?{}:t,n=e.value,i=e.interpolationMode,r=e.easingMethod;at(this,"interpolationMode",Bf,this),at(this,"value",Mf,this),at(this,"easingMethod",Of,this),this.value=n?Mn.clone(n):this.value,this.interpolationMode=null!=i?i:this.interpolationMode,this.easingMethod=null!=r?r:this.easingMethod}).prototype,"interpolationMode",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Vf.SLERP}}),Mf=st(Df.prototype,"value",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mn.clone(Mn.IDENTITY)}}),Of=st(Df.prototype,"easingMethod",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return K_.LINEAR}}),Rf=Df))||Rf)||Rf;function Kf(t){return new Yf(t)}var Jf,Qf=t("QuatCurve",hc("cc.QuatCurve")((Gf=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"preExtrapolation",Ff,it(e)),at(e,"postExtrapolation",zf,it(e)),e}Q(e,t);var n=e.prototype;return n.evaluate=function(t,e){var n;null!==(n=e)&&void 0!==n||(e=new Mn);var i=this._times,r=this._values,o=this.postExtrapolation,a=this.preExtrapolation,s=i.length;if(0===s)return e;var c=i[0],l=i[s-1];if(t<c){var u=r[0];switch(a){case $c.LOOP:t=c+vn(t-c,l-c);break;case $c.PING_PONG:t=c+gn(t-c,l-c);break;case $c.CLAMP:default:return Mn.copy(e,u.value)}}else if(t>l){var h=r[s-1];switch(o){case $c.LOOP:t=c+vn(t-c,l-c);break;case $c.PING_PONG:t=c+gn(t-c,l-c);break;case $c.CLAMP:default:return Mn.copy(e,h.value)}}var _=nc(i,t);if(_>=0)return Mn.copy(e,r[_].value);var f=~_,p=f-1,d=i[p],m=r[p],v=i[f],g=r[f],y=(t-d)/(v-d);switch(m.interpolationMode){default:case Vf.CONSTANT:return Mn.copy(e,m.value);case Vf.SLERP:var x=m.easingMethod,S=x===K_.LINEAR?y:Array.isArray(x)?Xf(x,y):rf(x)(y);return Mn.slerp(e,m.value,g.value,S)}},n.addKeyFrame=function(e,n){var i=new Yf(n);return t.prototype.addKeyFrame.call(this,e,i)},n.assignSorted=function(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.map((function(t){return Kf(t)})));else{var n=Array.from(t);this.setKeyframes(n.map((function(t){return t[0]})),n.map((function(t){return Kf(t[1])})))}},n[ah]=function(t,e){if(e.toCCON){var n=this._times,i=this._values,r=!0;i.forEach((function(t,e,n){var i=n[0];r&&t.interpolationMode!==i.interpolationMode&&(r=!1)}));var o=n.length,a=cp*(r?1:o),s=i.reduce((function(t,e){var n=e.easingMethod;return t+(Array.isArray(n)?lp+4*hp:lp)}),0),c=0,l=new DataView(new ArrayBuffer(c+=rp+op+ap*o+4*sp*o+s+a+0)),u=0,h=0;r&&(h|=Jf.INTERPOLATION_MODE),l.setUint32(u,h,!0),u+=rp,l.setUint32(u,o,!0),u+=op,n.forEach((function(t,e){return l.setFloat32(u+ap*e,t,!0)})),u+=ap*o,i.forEach((function(t,e){var n=t.value,i=n.x,r=n.y,o=n.z,a=n.w,s=u+4*sp*e;l.setFloat32(s+0*sp,i,!0),l.setFloat32(s+1*sp,r,!0),l.setFloat32(s+2*sp,o,!0),l.setFloat32(s+3*sp,a,!0)})),u+=4*sp*o,i.forEach((function(t){var e=t.easingMethod;Array.isArray(e)?(l.setUint8(u,up),++u,l.setFloat32(u+0*hp,e[0],!0),l.setFloat32(u+1*hp,e[1],!0),l.setFloat32(u+2*hp,e[2],!0),l.setFloat32(u+3*hp,e[3],!0),u+=4*hp):(l.setUint8(u,e),++u)}));var _=u;u+=a;var f=_;i.forEach((function(t){var e=t.interpolationMode;l.setUint8(f,e),r||(f+=cp)}));var p=new Uint8Array(l.buffer);t.writeProperty("bytes",p)}else t.writeThis()},n[sh]=function(t,e){if(e.fromCCON){var n=t.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0,o=i.getUint32(r,!0);r+=rp;var a=o&Jf.INTERPOLATION_MODE,s=i.getUint32(r,!0);r+=op;var c=Array.from({length:s},(function(t,e){return i.getFloat32(r+ap*e,!0)})),l=r+=ap*s;r+=4*sp*s;var u=Array.from({length:s},(function(t,e){var n=l+4*sp*e,o=i.getFloat32(n+0*sp,!0),a=i.getFloat32(n+1*sp,!0),s=i.getFloat32(n+2*sp,!0),c=i.getFloat32(n+3*sp,!0),u=i.getUint8(r);++r;var h=Kf({value:{x:o,y:a,z:s,w:c}});return u!==up?h.easingMethod=u:(h.easingMethod=[i.getFloat32(r+0*hp,!0),i.getFloat32(r+1*hp,!0),i.getFloat32(r+2*hp,!0),i.getFloat32(r+3*hp,!0)],r+=4*hp),h}));if(a){var h=i.getUint8(r);++r;for(var _=0;_<s;++_)u[_].interpolationMode=h}else{for(var f=0;f<s;++f){var p=i.getUint8(r+f);u[f].interpolationMode=p}r+=s}this._times=c,this._values=u}else t.readThis()},e}(nl),Ff=st((Lf=Gf).prototype,"preExtrapolation",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $c.CLAMP}}),zf=st(Lf.prototype,"postExtrapolation",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $c.CLAMP}}),Nf=Lf))||Nf);!function(t){t[t.INTERPOLATION_MODE=1]="INTERPOLATION_MODE"}(Jf||(Jf={}));var Zf,$f,tp,ep,np,ip,rp=1,op=4,ap=4,sp=4,cp=1,lp=1,up=255,hp=4,_p=t("ObjectCurve",hc("cc.ObjectCurve")(Zf=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e.prototype.evaluate=function(t){var e=this.searchKeyframe(t);if(e>=0)return this._values[e];var n=on(~e-1,0,this._values.length-1);return this._values[n]},e}(nl))||Zf),fp=function(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0};Je.fastDefine("cc.Keyframe",fp,{time:0,value:0,inTangent:0,outTangent:0});var pp=function(){function t(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return t.prototype.evaluate=function(t){return e=t-this.time,n=this.coefficient,e*(e*(e*n[0]+n[1])+n[2])+n[3];var e,n},t}(),dp=hc("cc.AnimationCurve")((ip=np=function(){function t(t){if(void 0===t&&(t=null),at(this,"_curve",ep,this),this.cachedKey=void 0,t instanceof hf)this._curve=t;else{var e=new hf;this._curve=e,e.preExtrapolation=$c.LOOP,e.postExtrapolation=$c.CLAMP,t?e.assignSorted(t.map((function(t){return[t.time,{interpolationMode:Zc.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}]}))):e.assignSorted([[0,{interpolationMode:Zc.CUBIC,value:1}],[1,{interpolationMode:Zc.CUBIC,value:1}]])}this.cachedKey=new pp}var e=t.prototype;return e.addKey=function(t){t?this._curve.addKeyFrame(t.time,{interpolationMode:Zc.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}):this._curve.clear()},e.evaluate_slow=function(t){return this._curve.evaluate(t)},e.evaluate=function(t){var e=this.cachedKey,n=this._curve,i=n.keyFramesCount-1,r=t,o=t<0?n.preExtrapolation:n.postExtrapolation,a=n.getKeyframeTime(0),s=n.getKeyframeTime(i);switch(o){case $c.LOOP:r=vn(t-a,s-a)+a;break;case $c.PING_PONG:r=gn(t-a,s-a)+a;break;case $c.CLAMP:default:r=on(t,a,s)}if(r>=e.time&&r<e.endTime)return e.evaluate(r);var c=this.findIndex(e,r),l=Math.min(c+1,i);return this.calcOptimizedKey(e,c,l),e.evaluate(r)},e.calcOptimizedKey=function(t,e,n){var i=this._curve.getKeyframeTime(e),r=this._curve.getKeyframeTime(n),o=this._curve.getKeyframeValue(e),a=o.value,s=o.leftTangent,c=this._curve.getKeyframeValue(n),l=c.value,u=c.rightTangent;t.index=e,t.time=i,t.endTime=r;var h=r-i,_=l-a,f=1/(h*h),p=s*h,d=u*h;t.coefficient[0]=(p+d-_-_)*f/h,t.coefficient[1]=(_+_+_-p-p-d)*f,t.coefficient[2]=s,t.coefficient[3]=a},e.findIndex=function(t,e){var n=this._curve,i=n.keyFramesCount,r=t.index;if(-1!==r)if(e>n.getKeyframeTime(r))for(var o=0;o<3;o++){var a=r+o;if(a+1<i&&n.getKeyframeTime(a+1)>e)return a}else for(var s=0;s<3;s++){var c=r-s;if(c>=0&&n.getKeyframeTime(c-1)<=e)return c-1}for(var l,u=0,h=i;h-u>1;)l=Math.floor((u+h)/2),n.getKeyframeTime(l)>=e?h=l:u=l;return u},K(t,[{key:"_internalCurve",get:function(){return this._curve}},{key:"keyFrames",get:function(){return Array.from(this._curve.keyframes()).map((function(t){var e=t[0],n=t[1],i=new fp;return i.time=e,i.value=n.value,i.inTangent=n.leftTangent,i.outTangent=n.rightTangent,i}))},set:function(t){this._curve.assignSorted(t.map((function(t){return[t.time,{interpolationMode:Zc.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}]})))}},{key:"preWrapMode",get:function(){return vp(this._curve.preExtrapolation)},set:function(t){this._curve.preExtrapolation=mp(t)}},{key:"postWrapMode",get:function(){return vp(this._curve.postExtrapolation)},set:function(t){this._curve.postExtrapolation=mp(t)}}]),t}(),np.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],ep=st((tp=ip).prototype,"_curve",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),$f=tp))||$f;function mp(t){switch(t){default:case Ks.Default:case Ks.Normal:case Ks.Clamp:return $c.CLAMP;case Ks.PingPong:return $c.PING_PONG;case Ks.Loop:return $c.LOOP}}function vp(t){switch(t){default:case $c.LINEAR:case $c.CLAMP:return Ks.Clamp;case $c.PING_PONG:return Ks.PingPong;case $c.LOOP:return Ks.Loop}}function gp(t,e){console.warn(t+" is deprecated, please use "+e+" instead.")}z(cs,"intersect",[{name:"ray_aabb",newName:"rayAABB"},{name:"ray_plane",newName:"rayPlane"},{name:"ray_triangle",newName:"rayTriangle"},{name:"ray_sphere",newName:"raySphere"},{name:"ray_obb",newName:"rayOBB"},{name:"ray_capsule",newName:"rayCapsule"},{name:"ray_subMesh",newName:"raySubMesh"},{name:"ray_mesh",newName:"rayMesh"},{name:"ray_model",newName:"rayModel"},{name:"line_plane",newName:"linePlane"},{name:"line_triangle",newName:"lineTriangle"},{name:"line_aabb",newName:"lineAABB"},{name:"line_obb",newName:"lineOBB"},{name:"line_sphere",newName:"lineSphere"},{name:"aabb_aabb",newName:"aabbWithAABB"},{name:"aabb_obb",newName:"aabbWithOBB"},{name:"aabb_plane",newName:"aabbPlane"},{name:"aabb_frustum",newName:"aabbFrustum"},{name:"aabbFrustum_accurate",newName:"aabbFrustumAccurate"},{name:"obb_point",newName:"obbPoint"},{name:"obb_plane",newName:"obbPlane"},{name:"obb_frustum",newName:"obbFrustum"},{name:"obbFrustum_accurate",newName:"obbFrustumAccurate"},{name:"obb_obb",newName:"obbWithOBB"},{name:"obb_capsule",newName:"obbCapsule"},{name:"sphere_plane",newName:"spherePlane"},{name:"sphere_frustum",newName:"sphereFrustum"},{name:"sphereFrustum_accurate",newName:"sphereFrustumAccurate"},{name:"sphere_sphere",newName:"sphereWithSphere"},{name:"sphere_aabb",newName:"sphereAABB"},{name:"sphere_obb",newName:"sphereOBB"},{name:"sphere_capsule",newName:"sphereCapsule"},{name:"capsule_capsule",newName:"capsuleWithCapsule"}]);var yp=function(t){function e(){var e;return e=t.call(this)||this,gp("line","Line"),e}return Q(e,t),e}(Jo),xp=function(t){function e(){var e;return e=t.call(this)||this,gp("plane","Plane"),e}return Q(e,t),e}(xs),Sp=function(t){function e(){var e;return e=t.call(this)||this,gp("ray","Ray"),e}return Q(e,t),e}(Qo),Cp=function(t){function e(){var e;return e=t.call(this)||this,gp("triangle","Triangle"),e}return Q(e,t),e}(oa),Ap=function(t){function e(){var e;return e=t.call(this)||this,gp("sphere","Sphere"),e}return Q(e,t),e}(ra),bp=function(t){function e(){var e;return e=t.call(this)||this,gp("aabb","AABB"),e}return Q(e,t),e}(ks),Tp=function(t){function e(){var e;return e=t.call(this)||this,gp("obb","OBB"),e}return Q(e,t),e}(qs),Ep=function(t){function e(){var e;return e=t.call(this)||this,gp("capsule","Capsule"),e}return Q(e,t),e}(Xs),wp=function(t){function e(){var e;return e=t.call(this)||this,gp("frustum","Frustum"),e}return Q(e,t),e}(tc),Pp=Object.freeze({__proto__:null,distance:Yo,enums:Ko,intersect:cs,Line:Jo,Plane:xs,Ray:Qo,Triangle:oa,Sphere:ra,AABB:ks,OBB:qs,Capsule:Xs,Frustum:tc,Keyframe:fp,AnimationCurve:dp,get ERaycastMode(){return ia},line:yp,plane:xp,ray:Sp,triangle:Cp,sphere:Ap,aabb:bp,obb:Tp,capsule:Ep,frustum:wp});t("geometry",Pp);var Ip={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},Rp=t("Layers",function(){function t(){}return t.makeMaskInclude=function(t){for(var e,n=0,i=ot(t);!(e=i()).done;)n|=e.value;return n},t.makeMaskExclude=function(e){return~t.makeMaskInclude(e)},t.addLayer=function(e,n){if(void 0!==n)if(n>19||n<0)console.warn("maximum layers reached.");else{var i=1<<n;t.Enum[e],N(2104,e),t.Enum[e]=i,ee.value(t.Enum,String(i),e),t.BitMask[e]=i,ee.value(t.BitMask,String(i),e)}else console.warn("bitNum can't be undefined")},t.deleteLayer=function(e){if(e>19||e<0)console.warn("do not change buildin layers.");else{var n=1<<e;delete t.Enum[t.Enum[n]],delete t.Enum[n],delete t.BitMask[t.BitMask[n]],delete t.BitMask[n]}},t.nameToLayer=function(e){return void 0===e?(console.warn("name can't be undefined"),-1):n(t.Enum[e])},t.layerToName=function(e){return e>31||e<0?(console.warn("Unable to access unknown layer."),""):t.Enum[1<<e]},t}());Rp.Enum=ie(Ip),Rp.BitMask=ne(J({},Ip)),c.Layers=Rp;var Dp,Bp,Mp="MainFlow",Op="ForwardFlow",Np="ShadowFlow";!function(t){t[t.DEFAULT=100]="DEFAULT",t[t.UI=200]="UI"}(Dp||(Dp={})),c.RenderPassStage=Dp,function(t){t[t.MIN=0]="MIN",t[t.MAX=255]="MAX",t[t.DEFAULT=128]="DEFAULT"}(Bp||(Bp={}));var Lp,Fp={bindings:[],layouts:{}},zp={bindings:[],layouts:{}};!function(t){t[t.UBO_GLOBAL=0]="UBO_GLOBAL",t[t.UBO_CAMERA=1]="UBO_CAMERA",t[t.UBO_SHADOW=2]="UBO_SHADOW",t[t.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",t[t.SAMPLER_ENVIRONMENT=4]="SAMPLER_ENVIRONMENT",t[t.SAMPLER_SPOT_LIGHTING_MAP=5]="SAMPLER_SPOT_LIGHTING_MAP",t[t.SAMPLER_DIFFUSEMAP=6]="SAMPLER_DIFFUSEMAP",t[t.COUNT=7]="COUNT"}(Lp||(Lp={}));var Gp,Vp=Lp.SAMPLER_SHADOWMAP,Up=Lp.COUNT-Vp;!function(t){t[t.UBO_LOCAL=0]="UBO_LOCAL",t[t.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",t[t.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",t[t.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",t[t.UBO_MORPH=4]="UBO_MORPH",t[t.UBO_UI_LOCAL=5]="UBO_UI_LOCAL",t[t.SAMPLER_JOINTS=6]="SAMPLER_JOINTS",t[t.SAMPLER_MORPH_POSITION=7]="SAMPLER_MORPH_POSITION",t[t.SAMPLER_MORPH_NORMAL=8]="SAMPLER_MORPH_NORMAL",t[t.SAMPLER_MORPH_TANGENT=9]="SAMPLER_MORPH_TANGENT",t[t.SAMPLER_LIGHTMAP=10]="SAMPLER_LIGHTMAP",t[t.SAMPLER_SPRITE=11]="SAMPLER_SPRITE",t[t.SAMPLER_REFLECTION=12]="SAMPLER_REFLECTION",t[t.STORAGE_REFLECTION=13]="STORAGE_REFLECTION",t[t.COUNT=14]="COUNT"}(Gp||(Gp={}));var kp,Hp=Gp.SAMPLER_JOINTS,jp=Gp.COUNT-Hp;!function(t){t[t.GLOBAL=0]="GLOBAL",t[t.MATERIAL=1]="MATERIAL",t[t.LOCAL=2]="LOCAL"}(kp||(kp={}));var Wp=new ar;Wp.bufferOffsets=[0,Vp+Hp,Vp],Wp.samplerOffsets=[-Vp,Up+jp,Up-Hp],Wp.flexibleSet=1;var qp=function(){};qp.SIZE=4*(qp.COUNT=4+(qp.SCREEN_SIZE_OFFSET=4+(qp.NATIVE_SIZE_OFFSET=4+(qp.TIME_OFFSET=0)))),qp.NAME="CCGlobal",qp.BINDING=Lp.UBO_GLOBAL,qp.DESCRIPTOR=new Fr(qp.BINDING,Ui.UNIFORM_BUFFER,1,Ii.ALL),qp.LAYOUT=new gr(kp.GLOBAL,qp.BINDING,qp.NAME,[new vr("cc_time",_i.FLOAT4,1),new vr("cc_screenSize",_i.FLOAT4,1),new vr("cc_nativeSize",_i.FLOAT4,1)],1),Fp.layouts[qp.NAME]=qp.LAYOUT,Fp.bindings[qp.BINDING]=qp.DESCRIPTOR;var Xp=function(){};Xp.SIZE=4*(Xp.COUNT=4+(Xp.VIEW_PORT_OFFSET=4+(Xp.NEAR_FAR_OFFSET=4+(Xp.GLOBAL_FOG_ADD_OFFSET=4+(Xp.GLOBAL_FOG_BASE_OFFSET=4+(Xp.GLOBAL_FOG_COLOR_OFFSET=4+(Xp.AMBIENT_GROUND_OFFSET=4+(Xp.AMBIENT_SKY_OFFSET=4+(Xp.MAIN_LIT_COLOR_OFFSET=4+(Xp.MAIN_LIT_DIR_OFFSET=4+(Xp.EXPOSURE_OFFSET=4+(Xp.SCREEN_SCALE_OFFSET=4+(Xp.CAMERA_POS_OFFSET=16+(Xp.MAT_VIEW_PROJ_INV_OFFSET=16+(Xp.MAT_VIEW_PROJ_OFFSET=16+(Xp.MAT_PROJ_INV_OFFSET=16+(Xp.MAT_PROJ_OFFSET=16+(Xp.MAT_VIEW_INV_OFFSET=16+(Xp.MAT_VIEW_OFFSET=0))))))))))))))))))),Xp.NAME="CCCamera",Xp.BINDING=Lp.UBO_CAMERA,Xp.DESCRIPTOR=new Fr(Xp.BINDING,Ui.UNIFORM_BUFFER,1,Ii.ALL),Xp.LAYOUT=new gr(kp.GLOBAL,Xp.BINDING,Xp.NAME,[new vr("cc_matView",_i.MAT4,1),new vr("cc_matViewInv",_i.MAT4,1),new vr("cc_matProj",_i.MAT4,1),new vr("cc_matProjInv",_i.MAT4,1),new vr("cc_matViewProj",_i.MAT4,1),new vr("cc_matViewProjInv",_i.MAT4,1),new vr("cc_cameraPos",_i.FLOAT4,1),new vr("cc_screenScale",_i.FLOAT4,1),new vr("cc_exposure",_i.FLOAT4,1),new vr("cc_mainLitDir",_i.FLOAT4,1),new vr("cc_mainLitColor",_i.FLOAT4,1),new vr("cc_ambientSky",_i.FLOAT4,1),new vr("cc_ambientGround",_i.FLOAT4,1),new vr("cc_fogColor",_i.FLOAT4,1),new vr("cc_fogBase",_i.FLOAT4,1),new vr("cc_fogAdd",_i.FLOAT4,1),new vr("cc_nearFar",_i.FLOAT4,1),new vr("cc_viewPort",_i.FLOAT4,1)],1),Fp.layouts[Xp.NAME]=Xp.LAYOUT,Fp.bindings[Xp.BINDING]=Xp.DESCRIPTOR;var Yp=function(){};Yp.SIZE=4*(Yp.COUNT=4+(Yp.PLANAR_NORMAL_DISTANCE_INFO_OFFSET=4+(Yp.SHADOW_COLOR_OFFSET=4+(Yp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=4+(Yp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=4+(Yp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET=4+(Yp.SHADOW_PROJ_INFO_OFFSET=4+(Yp.SHADOW_PROJ_DEPTH_INFO_OFFSET=4+(Yp.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET=16+(Yp.MAT_LIGHT_VIEW_PROJ_OFFSET=16+(Yp.MAT_LIGHT_VIEW_OFFSET=16+(Yp.MAT_LIGHT_PLANE_PROJ_OFFSET=0)))))))))))),Yp.NAME="CCShadow",Yp.BINDING=Lp.UBO_SHADOW,Yp.DESCRIPTOR=new Fr(Yp.BINDING,Ui.UNIFORM_BUFFER,1,Ii.ALL),Yp.LAYOUT=new gr(kp.GLOBAL,Yp.BINDING,Yp.NAME,[new vr("cc_matLightPlaneProj",_i.MAT4,1),new vr("cc_matLightView",_i.MAT4,1),new vr("cc_matLightViewProj",_i.MAT4,1),new vr("cc_shadowInvProjDepthInfo",_i.FLOAT4,1),new vr("cc_shadowProjDepthInfo",_i.FLOAT4,1),new vr("cc_shadowProjInfo",_i.FLOAT4,1),new vr("cc_shadowNFLSInfo",_i.FLOAT4,1),new vr("cc_shadowWHPBInfo",_i.FLOAT4,1),new vr("cc_shadowLPNNInfo",_i.FLOAT4,1),new vr("cc_shadowColor",_i.FLOAT4,1),new vr("cc_planarNDInfo",_i.FLOAT4,1)],1),Fp.layouts[Yp.NAME]=Yp.LAYOUT,Fp.bindings[Yp.BINDING]=Yp.DESCRIPTOR;var Kp=Lp.SAMPLER_SHADOWMAP,Jp=new Fr(Kp,Ui.SAMPLER_TEXTURE,1,Ii.FRAGMENT),Qp=new yr(kp.GLOBAL,Kp,"cc_shadowMap",_i.SAMPLER2D,1);Fp.layouts.cc_shadowMap=Qp,Fp.bindings[Kp]=Jp;var Zp=Lp.SAMPLER_ENVIRONMENT,$p=new Fr(Zp,Ui.SAMPLER_TEXTURE,1,Ii.FRAGMENT),td=new yr(kp.GLOBAL,Zp,"cc_environment",_i.SAMPLER_CUBE,1);Fp.layouts.cc_environment=td,Fp.bindings[Zp]=$p;var ed=Lp.SAMPLER_DIFFUSEMAP,nd=new Fr(ed,Ui.SAMPLER_TEXTURE,1,Ii.FRAGMENT),id=new yr(kp.GLOBAL,ed,"cc_diffuseMap",_i.SAMPLER_CUBE,1);Fp.layouts.cc_diffuseMap=id,Fp.bindings[ed]=nd;var rd=Lp.SAMPLER_SPOT_LIGHTING_MAP,od=new Fr(rd,Ui.SAMPLER_TEXTURE,1,Ii.FRAGMENT),ad=new yr(kp.GLOBAL,rd,"cc_spotLightingMap",_i.SAMPLER2D,1);Fp.layouts.cc_spotLightingMap=ad,Fp.bindings[rd]=od;var sd=function(){};sd.SIZE=4*(sd.COUNT=4+(sd.LIGHTINGMAP_UVPARAM=16+(sd.MAT_WORLD_IT_OFFSET=16+(sd.MAT_WORLD_OFFSET=0)))),sd.NAME="CCLocal",sd.BINDING=Gp.UBO_LOCAL,sd.DESCRIPTOR=new Fr(sd.BINDING,Ui.UNIFORM_BUFFER,1,Ii.VERTEX|Ii.COMPUTE),sd.LAYOUT=new gr(kp.LOCAL,sd.BINDING,sd.NAME,[new vr("cc_matWorld",_i.MAT4,1),new vr("cc_matWorldIT",_i.MAT4,1),new vr("cc_lightingMapUVParam",_i.FLOAT4,1)],1),zp.layouts[sd.NAME]=sd.LAYOUT,zp.bindings[sd.BINDING]=sd.DESCRIPTOR;var cd=function(){};cd.SIZE=4*(cd.COUNT=4+(cd.WORLD_BOUND_HALF_EXTENTS=4+(cd.WORLD_BOUND_CENTER=0))),cd.NAME="CCWorldBound",cd.BINDING=Gp.UBO_LOCAL,cd.DESCRIPTOR=new Fr(cd.BINDING,Ui.UNIFORM_BUFFER,1,Ii.VERTEX|Ii.COMPUTE),cd.LAYOUT=new gr(kp.LOCAL,cd.BINDING,cd.NAME,[new vr("cc_worldBoundCenter",_i.FLOAT4,1),new vr("cc_worldBoundHalfExtents",_i.FLOAT4,1)],1),zp.layouts[cd.NAME]=cd.LAYOUT,zp.bindings[cd.BINDING]=cd.DESCRIPTOR;var ld="a_matWorld0",ud=function(){};ud.BATCHING_COUNT=10,ud.MAT_WORLDS_OFFSET=0,ud.SIZE=4*(ud.COUNT=16*ud.BATCHING_COUNT),ud.NAME="CCLocalBatched",ud.BINDING=Gp.UBO_LOCAL,ud.DESCRIPTOR=new Fr(ud.BINDING,Ui.UNIFORM_BUFFER,1,Ii.VERTEX|Ii.COMPUTE),ud.LAYOUT=new gr(kp.LOCAL,ud.BINDING,ud.NAME,[new vr("cc_matWorlds",_i.MAT4,ud.BATCHING_COUNT)],1),zp.layouts[ud.NAME]=ud.LAYOUT,zp.bindings[ud.BINDING]=ud.DESCRIPTOR;var hd=function(){};hd.LIGHTS_PER_PASS=1,hd.SIZE=4*(hd.COUNT=(hd.LIGHT_DIR_OFFSET=(hd.LIGHT_SIZE_RANGE_ANGLE_OFFSET=(hd.LIGHT_COLOR_OFFSET=(hd.LIGHT_POS_OFFSET=0)+4*hd.LIGHTS_PER_PASS)+4*hd.LIGHTS_PER_PASS)+4*hd.LIGHTS_PER_PASS)+4*hd.LIGHTS_PER_PASS),hd.NAME="CCForwardLight",hd.BINDING=Gp.UBO_FORWARD_LIGHTS,hd.DESCRIPTOR=new Fr(hd.BINDING,Ui.DYNAMIC_UNIFORM_BUFFER,1,Ii.FRAGMENT),hd.LAYOUT=new gr(kp.LOCAL,hd.BINDING,hd.NAME,[new vr("cc_lightPos",_i.FLOAT4,hd.LIGHTS_PER_PASS),new vr("cc_lightColor",_i.FLOAT4,hd.LIGHTS_PER_PASS),new vr("cc_lightSizeRangeAngle",_i.FLOAT4,hd.LIGHTS_PER_PASS),new vr("cc_lightDir",_i.FLOAT4,hd.LIGHTS_PER_PASS)],1),zp.layouts[hd.NAME]=hd.LAYOUT,zp.bindings[hd.BINDING]=hd.DESCRIPTOR;var _d=function(){};_d.LIGHTS_PER_PASS=10;var fd=function(){};fd.SIZE=4*(fd.COUNT=4+(fd.JOINTS_TEXTURE_INFO_OFFSET=0)),fd.NAME="CCSkinningTexture",fd.BINDING=Gp.UBO_SKINNING_TEXTURE,fd.DESCRIPTOR=new Fr(fd.BINDING,Ui.UNIFORM_BUFFER,1,Ii.VERTEX),fd.LAYOUT=new gr(kp.LOCAL,fd.BINDING,fd.NAME,[new vr("cc_jointTextureInfo",_i.FLOAT4,1)],1),zp.layouts[fd.NAME]=fd.LAYOUT,zp.bindings[fd.BINDING]=fd.DESCRIPTOR;var pd=function(){};pd.SIZE=4*(pd.COUNT=4+(pd.JOINTS_ANIM_INFO_OFFSET=0)),pd.NAME="CCSkinningAnimation",pd.BINDING=Gp.UBO_SKINNING_ANIMATION,pd.DESCRIPTOR=new Fr(pd.BINDING,Ui.UNIFORM_BUFFER,1,Ii.VERTEX),pd.LAYOUT=new gr(kp.LOCAL,pd.BINDING,pd.NAME,[new vr("cc_jointAnimInfo",_i.FLOAT4,1)],1),zp.layouts[pd.NAME]=pd.LAYOUT,zp.bindings[pd.BINDING]=pd.DESCRIPTOR;var dd="a_jointAnimInfo",md=function(){};md.SIZE=4*(md.COUNT=360+(md.JOINTS_OFFSET=0)),md.NAME="CCSkinning",md.BINDING=Gp.UBO_SKINNING_TEXTURE,md.DESCRIPTOR=new Fr(md.BINDING,Ui.UNIFORM_BUFFER,1,Ii.VERTEX),md.LAYOUT=new gr(kp.LOCAL,md.BINDING,md.NAME,[new vr("cc_joints",_i.FLOAT4,90)],1),zp.layouts[md.NAME]=md.LAYOUT,zp.bindings[md.BINDING]=md.DESCRIPTOR;var vd=function(){};vd.MAX_MORPH_TARGET_COUNT=60,vd.OFFSET_OF_WEIGHTS=0,vd.OFFSET_OF_VERTICES_COUNT=4+(vd.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=4+(vd.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*vd.MAX_MORPH_TARGET_COUNT)),vd.COUNT_BASE_4_BYTES=4*Math.ceil(vd.MAX_MORPH_TARGET_COUNT/4)+4,vd.SIZE=4*vd.COUNT_BASE_4_BYTES,vd.NAME="CCMorph",vd.BINDING=Gp.UBO_MORPH,vd.DESCRIPTOR=new Fr(vd.BINDING,Ui.UNIFORM_BUFFER,1,Ii.VERTEX),vd.LAYOUT=new gr(kp.LOCAL,vd.BINDING,vd.NAME,[new vr("cc_displacementWeights",_i.FLOAT4,vd.MAX_MORPH_TARGET_COUNT/4),new vr("cc_displacementTextureInfo",_i.FLOAT4,1)],1),zp.layouts[vd.NAME]=vd.LAYOUT,zp.bindings[vd.BINDING]=vd.DESCRIPTOR;var gd=function(){};gd.NAME="CCUILocal",gd.BINDING=Gp.UBO_UI_LOCAL,gd.DESCRIPTOR=new Fr(gd.BINDING,Ui.DYNAMIC_UNIFORM_BUFFER,1,Ii.VERTEX),gd.LAYOUT=new gr(kp.LOCAL,gd.BINDING,gd.NAME,[new vr("cc_local_data",_i.FLOAT4,1)],1),zp.layouts[gd.NAME]=gd.LAYOUT,zp.bindings[gd.BINDING]=gd.DESCRIPTOR;var yd=Gp.SAMPLER_JOINTS,xd=new Fr(yd,Ui.SAMPLER_TEXTURE,1,Ii.VERTEX),Sd=new yr(kp.LOCAL,yd,"cc_jointTexture",_i.SAMPLER2D,1);zp.layouts.cc_jointTexture=Sd,zp.bindings[yd]=xd;var Cd=Gp.SAMPLER_MORPH_POSITION,Ad=new Fr(Cd,Ui.SAMPLER_TEXTURE,1,Ii.VERTEX),bd=new yr(kp.LOCAL,Cd,"cc_PositionDisplacements",_i.SAMPLER2D,1);zp.layouts.cc_PositionDisplacements=bd,zp.bindings[Cd]=Ad;var Td=Gp.SAMPLER_MORPH_NORMAL,Ed=new Fr(Td,Ui.SAMPLER_TEXTURE,1,Ii.VERTEX),wd=new yr(kp.LOCAL,Td,"cc_NormalDisplacements",_i.SAMPLER2D,1);zp.layouts.cc_NormalDisplacements=wd,zp.bindings[Td]=Ed;var Pd=Gp.SAMPLER_MORPH_TANGENT,Id=new Fr(Pd,Ui.SAMPLER_TEXTURE,1,Ii.VERTEX),Rd=new yr(kp.LOCAL,Pd,"cc_TangentDisplacements",_i.SAMPLER2D,1);zp.layouts.cc_TangentDisplacements=Rd,zp.bindings[Pd]=Id;var Dd=Gp.SAMPLER_LIGHTMAP,Bd=new Fr(Dd,Ui.SAMPLER_TEXTURE,1,Ii.FRAGMENT),Md=new yr(kp.LOCAL,Dd,"cc_lightingMap",_i.SAMPLER2D,1);zp.layouts.cc_lightingMap=Md,zp.bindings[Dd]=Bd;var Od=Gp.SAMPLER_SPRITE,Nd=new Fr(Od,Ui.SAMPLER_TEXTURE,1,Ii.FRAGMENT),Ld=new yr(kp.LOCAL,Od,"cc_spriteTexture",_i.SAMPLER2D,1);zp.layouts.cc_spriteTexture=Ld,zp.bindings[Od]=Nd;var Fd=Gp.SAMPLER_REFLECTION,zd=new Fr(Fd,Ui.SAMPLER_TEXTURE,1,Ii.FRAGMENT),Gd=new yr(kp.LOCAL,Fd,"cc_reflectionTexture",_i.SAMPLER2D,1);zp.layouts.cc_reflectionTexture=Gd,zp.bindings[Fd]=zd;var Vd=Gp.STORAGE_REFLECTION,Ud=new Fr(Vd,Ui.STORAGE_IMAGE,1,Ii.COMPUTE),kd=new Cr(kp.LOCAL,Vd,"cc_reflectionStorage",_i.IMAGE2D,1);zp.layouts.cc_reflectionStorage=kd,zp.bindings[Vd]=Ud;var Hd,jd,Wd=Rp.makeMaskExclude([Rp.BitMask.UI_2D,Rp.BitMask.GIZMOS,Rp.BitMask.EDITOR,Rp.BitMask.SCENE_GIZMO,Rp.BitMask.PROFILER]),qd=Rp.makeMaskExclude([Rp.BitMask.UI_2D,Rp.BitMask.PROFILER]),Xd=Rp.Enum.ALL;function Yd(t){return t.hasFeature(li.COLOR_FLOAT)&&t.hasFeature(li.TEXTURE_FLOAT)&&!(t.gfxAPI===si.WEBGL)}t("pipeline",Object.freeze({__proto__:null,PIPELINE_FLOW_MAIN:Mp,PIPELINE_FLOW_FORWARD:Op,PIPELINE_FLOW_SHADOW:Np,PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return Dp},get RenderPriority(){return Bp},globalDescriptorSetLayout:Fp,localDescriptorSetLayout:zp,get PipelineGlobalBindings(){return Lp},get ModelLocalBindings(){return Gp},get SetIndex(){return kp},bindingMappingInfo:Wp,UBOGlobal:qp,UBOCamera:Xp,UBOShadow:Yp,UNIFORM_SHADOWMAP_BINDING:Kp,UNIFORM_ENVIRONMENT_BINDING:Zp,UNIFORM_DIFFUSEMAP_BINDING:ed,UNIFORM_SPOT_LIGHTING_MAP_TEXTURE_BINDING:rd,UBOLocal:sd,UBOWorldBound:cd,INST_MAT_WORLD:ld,UBOLocalBatched:ud,UBOForwardLight:hd,UBODeferredLight:_d,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:fd,UBOSkinningAnimation:pd,INST_JOINT_ANIM_INFO:dd,UBOSkinning:md,UBOMorph:vd,UBOUILocal:gd,UNIFORM_JOINT_TEXTURE_BINDING:yd,UNIFORM_POSITION_MORPH_TEXTURE_BINDING:Cd,UNIFORM_NORMAL_MORPH_TEXTURE_BINDING:Td,UNIFORM_TANGENT_MORPH_TEXTURE_BINDING:Pd,UNIFORM_LIGHTMAP_TEXTURE_BINDING:Dd,UNIFORM_SPRITE_TEXTURE_BINDING:Od,UNIFORM_REFLECTION_TEXTURE_BINDING:Fd,UNIFORM_REFLECTION_STORAGE_BINDING:Vd,CAMERA_DEFAULT_MASK:Wd,CAMERA_EDITOR_MASK:qd,MODEL_ALWAYS_MASK:Xd,supportsHalfFloatTexture:function(t){return t.hasFeature(li.COLOR_HALF_FLOAT)&&t.hasFeature(li.TEXTURE_HALF_FLOAT)&&!(t.gfxAPI===si.WEBGL)},supportsFloatTexture:Yd}));var Kd=4227858432,Jd=66060288,Qd=1044480,Zd=function(t,e,n,i){return void 0===i&&(i=0),e<<26&Kd|t<<20&Jd|n<<12&Qd|4095&i},$d=function(t){return(t&Kd)>>>26},tm=function(t){return(t&Jd)>>>20},em=function(t){return(t&Qd)>>>12},nm=function(t){return 4095&t},im=function(t,e){return 67108863&t|e<<26&Kd},rm=((Hd={})[_i.UNKNOWN]=function(){return console.warn("illegal uniform handle")},Hd[_i.INT]=function(t,e,n){return void 0===n&&(n=0),t[n]},Hd[_i.INT2]=function(t,e,n){return void 0===n&&(n=0),Wn.fromArray(e,t,n)},Hd[_i.INT3]=function(t,e,n){return void 0===n&&(n=0),En.fromArray(e,t,n)},Hd[_i.INT4]=function(t,e,n){return void 0===n&&(n=0),Kn.fromArray(e,t,n)},Hd[_i.FLOAT]=function(t,e,n){return void 0===n&&(n=0),t[n]},Hd[_i.FLOAT2]=function(t,e,n){return void 0===n&&(n=0),Wn.fromArray(e,t,n)},Hd[_i.FLOAT3]=function(t,e,n){return void 0===n&&(n=0),En.fromArray(e,t,n)},Hd[_i.FLOAT4]=function(t,e,n){return void 0===n&&(n=0),Kn.fromArray(e,t,n)},Hd[_i.MAT3]=function(t,e,n){return void 0===n&&(n=0),Rn.fromArray(e,t,n)},Hd[_i.MAT4]=function(t,e,n){return void 0===n&&(n=0),Un.fromArray(e,t,n)},Hd),om=((jd={})[_i.UNKNOWN]=function(){return console.warn("illegal uniform handle")},jd[_i.INT]=function(t,e,n){return void 0===n&&(n=0),t[n]=e},jd[_i.INT2]=function(t,e,n){return void 0===n&&(n=0),Wn.toArray(t,e,n)},jd[_i.INT3]=function(t,e,n){return void 0===n&&(n=0),En.toArray(t,e,n)},jd[_i.INT4]=function(t,e,n){return void 0===n&&(n=0),Kn.toArray(t,e,n)},jd[_i.FLOAT]=function(t,e,n){return void 0===n&&(n=0),t[n]=e},jd[_i.FLOAT2]=function(t,e,n){return void 0===n&&(n=0),Wn.toArray(t,e,n)},jd[_i.FLOAT3]=function(t,e,n){return void 0===n&&(n=0),En.toArray(t,e,n)},jd[_i.FLOAT4]=function(t,e,n){return void 0===n&&(n=0),Kn.toArray(t,e,n)},jd[_i.MAT3]=function(t,e,n){return void 0===n&&(n=0),Rn.toArray(t,e,n)},jd[_i.MAT4]=function(t,e,n){return void 0===n&&(n=0),Un.toArray(t,e,n)},jd),am=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function sm(t){switch(t){case _i.BOOL:case _i.INT:case _i.UINT:case _i.FLOAT:return am[0];case _i.BOOL2:case _i.INT2:case _i.UINT2:case _i.FLOAT2:return am[1];case _i.BOOL4:case _i.INT4:case _i.UINT4:case _i.FLOAT4:return am[2];case _i.MAT4:return am[3];case _i.SAMPLER2D:return"default-texture";case _i.SAMPLER_CUBE:return"default-cube-texture"}return am[0]}function cm(t,e){for(var n=Object.entries(e),i=!1,r=0;r<n.length;r++)t[n[r][0]]!==n[r][1]&&(t[n[r][0]]=n[r][1],i=!0);return i}var lm=new zr;function um(t){return Math.ceil(Math.log2(Math.max(t,2)))}function hm(t,e){switch(t.type){case"boolean":return"number"==typeof e?e.toString():e?"1":"0";case"string":return void 0!==e?e:t.options[0];case"number":return void 0!==e?e.toString():t.range[0].toString();default:return console.warn("unknown define type '"+t.type+"'"),"-1"}}function _m(t,e,n,i,r){for(var o=t.builtins[i],a=[],s=function(t){var e=o.blocks[t],i=n.layouts[e.name],s=i&&n.bindings.find((function(t){return t.binding===i.binding}));if(!(i&&s&&s.descriptorType&Qr))return console.warn("builtin UBO '"+e.name+"' not available!"),"continue";a.push(i),r&&!r.includes(s)&&r.push(s)},c=0;c<o.blocks.length;c++)s(c);Array.prototype.unshift.apply(e.shaderInfo.blocks,a);for(var l=[],u=function(t){var e=o.samplerTextures[t],i=n.layouts[e.name],a=i&&n.bindings.find((function(t){return t.binding===i.binding}));if(!(i&&a&&a.descriptorType&Zr))return console.warn("builtin samplerTexture '"+e.name+"' not available!"),"continue";l.push(i),r&&!r.includes(a)&&r.push(a)},h=0;h<o.samplerTextures.length;h++)u(h);Array.prototype.unshift.apply(e.shaderInfo.samplerTextures,l),r&&r.sort((function(t,e){return t.binding-e.binding}))}function fm(t){return t.members.reduce((function(t,e){return t+ro(e.type)*e.count}),0)}function pm(t,e){for(var n=0;n<t.length;n++){var i=t[n];if("!"===i[0]){if(e[i.slice(1)])return!1}else if(!e[i])return!1}return!0}function dm(t){switch(t.gfxAPI){case si.GLES2:case si.WEBGL:return"glsl1";case si.GLES3:case si.WEBGL2:return"glsl3";default:return"glsl4"}}var mm,vm,gm,ym,xm,Sm,Cm,Am,bm=new(function(){function t(){this._templates={},this._cache={},this._templateInfos={}}var e=t.prototype;return e.register=function(t){for(var e=0;e<t.shaders.length;e++)this.define(t.shaders[e]).effectName=t.name;for(var n=0;n<t.techniques.length;n++)for(var i=t.techniques[n],r=0;r<i.passes.length;r++){var o=i.passes[r];void 0!==o.propertyIndex&&void 0===o.properties&&(o.properties=i.passes[o.propertyIndex].properties)}},e.define=function(t){var e=this._templates[t.name];if(e&&e.hash===t.hash)return e;for(var n=J({},t),i=0,r=function(t){var e=n.defines[t],r=1;if("number"===e.type){var o=e.range;r=um(o[1]-o[0]+1),e._map=function(t){return t-o[0]}}else"string"===e.type?(r=um(e.options.length),e._map=function(t){return Math.max(0,e.options.findIndex((function(e){return e===t})))}):"boolean"===e.type&&(e._map=function(t){return t?1:0});e._offset=i,i+=r},o=0;o<n.defines.length;o++)r(o);for(var a in i>31&&(n.uber=!0),n.constantMacros="",n.builtins.statistics)n.constantMacros+="#define "+a+" "+n.builtins.statistics[a]+"\n";if(this._templates[t.name]=n,!this._templateInfos[n.hash]){var s={};s.samplerStartBinding=n.blocks.length,s.shaderInfo=new wr,s.blockSizes=[],s.bindings=[];for(var c=0;c<n.blocks.length;c++){var l=n.blocks[c];s.blockSizes.push(fm(l)),s.bindings.push(new Fr(l.binding,Ui.UNIFORM_BUFFER,1,l.stageFlags)),s.shaderInfo.blocks.push(new gr(kp.MATERIAL,l.binding,l.name,l.members.map((function(t){return new vr(t.name,t.type,t.count)})),1))}for(var u=0;u<n.samplerTextures.length;u++){var h=n.samplerTextures[u];s.bindings.push(new Fr(h.binding,Ui.SAMPLER_TEXTURE,h.count,h.stageFlags)),s.shaderInfo.samplerTextures.push(new yr(kp.MATERIAL,h.binding,h.name,h.type,h.count))}for(var _=0;_<n.samplers.length;_++){var f=n.samplers[_];s.bindings.push(new Fr(f.binding,Ui.SAMPLER,f.count,f.stageFlags)),s.shaderInfo.samplers.push(new xr(kp.MATERIAL,f.binding,f.name,f.count))}for(var p=0;p<n.textures.length;p++){var d=n.textures[p];s.bindings.push(new Fr(d.binding,Ui.TEXTURE,d.count,d.stageFlags)),s.shaderInfo.textures.push(new Sr(kp.MATERIAL,d.binding,d.name,d.type,d.count))}for(var m=0;m<n.buffers.length;m++){var v=n.buffers[m];s.bindings.push(new Fr(v.binding,Ui.STORAGE_BUFFER,1,v.stageFlags)),s.shaderInfo.buffers.push(new Ar(kp.MATERIAL,v.binding,v.name,1,v.memoryAccess))}for(var g=0;g<n.images.length;g++){var y=n.images[g];s.bindings.push(new Fr(y.binding,Ui.STORAGE_IMAGE,y.count,y.stageFlags)),s.shaderInfo.images.push(new Cr(kp.MATERIAL,y.binding,y.name,y.type,y.count,y.memoryAccess))}for(var x=0;x<n.subpassInputs.length;x++){var S=n.subpassInputs[x];s.bindings.push(new Fr(S.binding,Ui.INPUT_ATTACHMENT,S.count,S.stageFlags)),s.shaderInfo.subpassInputs.push(new br(kp.MATERIAL,S.binding,S.name,S.count))}s.gfxAttributes=[];for(var C=0;C<n.attributes.length;C++){var A=n.attributes[C];s.gfxAttributes.push(new Er(A.name,A.format,A.isNormalized,0,A.isInstanced,A.location))}_m(n,s,zp,"locals"),s.shaderInfo.stages.push(new Tr(Ii.VERTEX,"")),s.shaderInfo.stages.push(new Tr(Ii.FRAGMENT,"")),s.handleMap=function(t){for(var e={},n=0;n<t.blocks.length;n++)for(var i=t.blocks[n],r=i.members,o=0,a=0;a<r.length;a++){var s=r[a];e[s.name]=Zd(i.binding,s.type,s.count,o),o+=(ro(s.type)>>2)*s.count}for(var c=0;c<t.samplerTextures.length;c++){var l=t.samplerTextures[c];e[l.name]=Zd(l.binding,l.type,l.count)}return e}(n),s.setLayouts=[],this._templateInfos[n.hash]=s}return n},e.getTemplate=function(t){return this._templates[t]},e.getTemplateInfo=function(t){var e=this._templates[t].hash;return this._templateInfos[e]},e.getDescriptorSetLayout=function(t,e,n){void 0===n&&(n=!1);var i=this._templates[e],r=this._templateInfos[i.hash];return r.setLayouts.length||(lm.bindings=r.bindings,r.setLayouts[kp.MATERIAL]=t.createDescriptorSetLayout(lm),lm.bindings=zp.bindings,r.setLayouts[kp.LOCAL]=t.createDescriptorSetLayout(lm)),r.setLayouts[n?kp.LOCAL:kp.MATERIAL]},e.hasProgram=function(t){return void 0!==this._templates[t]},e.getKey=function(t,e){var n=this._templates[t],i=n.defines;if(n.uber){for(var r="",o=0;o<i.length;o++){var a=i[o],s=e[a.name];if(s&&a._map){var c=a._map(s);r+=""+a._offset+c+"|"}}return""+r+n.hash}for(var l=0,u=0;u<i.length;u++){var h=i[u],_=e[h.name];_&&h._map&&(l|=h._map(_)<<h._offset)}return l.toString(16)+"|"+n.hash},e.destroyShaderByDefines=function(t){var e=this,n=Object.keys(t);if(n.length)for(var i=n.map((function(e){var n=t[e];return"boolean"==typeof n&&(n=n?"1":"0"),new RegExp(""+e+n)})),r=Object.keys(this._cache).filter((function(t){return i.every((function(n){return n.test(e._cache[t].name)}))})),o=0;o<r.length;o++){var a=r[o],s=this._cache[a];C("destroyed shader "+s.name),s.destroy(),delete this._cache[a]}},e.getGFXShader=function(t,e,n,i,r){Object.assign(n,i.macros),r||(r=this.getKey(e,n));var o=this._cache[r];if(o)return o;var a=this._templates[e],s=this._templateInfos[a.hash];s.pipelineLayout||(this.getDescriptorSetLayout(t,e),_m(a,s,Fp,"globals"),s.setLayouts[kp.GLOBAL]=i.descriptorSetLayout,s.pipelineLayout=t.createPipelineLayout(new Vr(s.setLayouts)));var c=function(t,e){for(var n=[],i=0;i<e.length;i++){var r=e[i],o=r.name,a=t[o],s=hm(r,a),c=!a||"0"===a;n.push({name:o,value:s,isDefault:c})}return n}(n,a.defines),l=i.constantMacros+a.constantMacros+c.reduce((function(t,e){return t+"#define "+e.name+" "+e.value+"\n"}),""),u=a.glsl3,h=dm(t);return h?u=a[h]:console.error("Invalid GFX API!"),s.shaderInfo.stages[0].source=l+u.vert,s.shaderInfo.stages[1].source=l+u.frag,s.shaderInfo.attributes=function(t,e,n){for(var i=[],r=t.attributes,o=e.gfxAttributes,a=0;a<r.length;a++)pm(r[a].defines,n)&&i.push(o[a]);return i}(a,s,n),s.shaderInfo.name=function(t,e){return t+e.reduce((function(t,e){return e.isDefault?t:t+"|"+e.name+e.value}),"")}(e,c),this._cache[r]=t.createShader(s.shaderInfo)},t}());c.programLib=bm;var Tm=t("EffectAsset",hc("cc.EffectAsset")((Am=Cm=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"techniques",gm,it(e)),at(e,"shaders",ym,it(e)),at(e,"combinations",xm,it(e)),at(e,"hideInEditor",Sm,it(e)),e}Q(e,t),e.register=function(t){e._effects[t.name]=t},e.remove=function(t){if("string"!=typeof t)e._effects[t.name]&&e._effects[t.name].equals(t)&&delete e._effects[t.name];else{if(e._effects[t])return void delete e._effects[t];for(var n in e._effects)if(e._effects[n]._uuid===t)return void delete e._effects[n]}},e.get=function(t){if(e._effects[t])return e._effects[t];for(var n in e._effects)if(e._effects[n]._uuid===t)return e._effects[n];return null},e.getAll=function(){return e._effects};var n=e.prototype;return n.onLoaded=function(){bm.register(this),e.register(this),c.game.once(c.Game.EVENT_ENGINE_INITED,this._precompile,this)},n._precompile=function(){for(var t=this,e=c.director.root,n=function(n){var i=t.shaders[n],r=t.combinations[n];if(!r)return"continue";Object.keys(r).reduce((function(t,e){return t.reduce((function(t,n){for(var i=r[e],o=0;o<i.length;++o){var a=J({},n);a[e]=i[o],t.push(a)}return t}),[])}),[{}]).forEach((function(t){return bm.getGFXShader(e.device,i.name,t,e.pipeline)}))},i=0;i<this.shaders.length;i++)n(i)},n.destroy=function(){return e.remove(this),t.prototype.destroy.call(this)},n.initDefault=function(n){t.prototype.initDefault.call(this,n);var i=e.get("unlit");this.name="unlit",this.shaders=i.shaders,this.combinations=i.combinations,this.techniques=i.techniques},n.validate=function(){return this.techniques.length>0&&this.shaders.length>0},e}(Pu),Cm._effects={},gm=st((vm=Am).prototype,"techniques",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ym=st(vm.prototype,"shaders",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xm=st(vm.prototype,"combinations",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Sm=st(vm.prototype,"hideInEditor",[vc,yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),mm=vm))||mm);c.EffectAsset=Tm;var Em,wm,Pm,Im,Rm,Dm,Bm,Mm,Om,Nm,Lm,Fm,zm,Gm,Vm,Um=1024;!function(t){t[t.RGB565=ui.R5G6B5]="RGB565",t[t.RGB5A1=ui.RGB5A1]="RGB5A1",t[t.RGBA4444=ui.RGBA4]="RGBA4444",t[t.RGB888=ui.RGB8]="RGB888",t[t.RGB32F=ui.RGB32F]="RGB32F",t[t.RGBA8888=ui.RGBA8]="RGBA8888",t[t.RGBA32F=ui.RGBA32F]="RGBA32F",t[t.A8=ui.A8]="A8",t[t.I8=ui.L8]="I8",t[t.AI8=ui.LA8]="AI8",t[t.RGB_PVRTC_2BPPV1=ui.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",t[t.RGBA_PVRTC_2BPPV1=ui.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",t[t.RGB_A_PVRTC_2BPPV1=Um++]="RGB_A_PVRTC_2BPPV1",t[t.RGB_PVRTC_4BPPV1=ui.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",t[t.RGBA_PVRTC_4BPPV1=ui.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",t[t.RGB_A_PVRTC_4BPPV1=Um++]="RGB_A_PVRTC_4BPPV1",t[t.RGB_ETC1=ui.ETC_RGB8]="RGB_ETC1",t[t.RGBA_ETC1=Um++]="RGBA_ETC1",t[t.RGB_ETC2=ui.ETC2_RGB8]="RGB_ETC2",t[t.RGBA_ETC2=ui.ETC2_RGBA8]="RGBA_ETC2",t[t.RGBA_ASTC_4x4=ui.ASTC_RGBA_4X4]="RGBA_ASTC_4x4",t[t.RGBA_ASTC_5x4=ui.ASTC_RGBA_5X4]="RGBA_ASTC_5x4",t[t.RGBA_ASTC_5x5=ui.ASTC_RGBA_5X5]="RGBA_ASTC_5x5",t[t.RGBA_ASTC_6x5=ui.ASTC_RGBA_6X5]="RGBA_ASTC_6x5",t[t.RGBA_ASTC_6x6=ui.ASTC_RGBA_6X6]="RGBA_ASTC_6x6",t[t.RGBA_ASTC_8x5=ui.ASTC_RGBA_8X5]="RGBA_ASTC_8x5",t[t.RGBA_ASTC_8x6=ui.ASTC_RGBA_8X6]="RGBA_ASTC_8x6",t[t.RGBA_ASTC_8x8=ui.ASTC_RGBA_8X8]="RGBA_ASTC_8x8",t[t.RGBA_ASTC_10x5=ui.ASTC_RGBA_10X5]="RGBA_ASTC_10x5",t[t.RGBA_ASTC_10x6=ui.ASTC_RGBA_10X6]="RGBA_ASTC_10x6",t[t.RGBA_ASTC_10x8=ui.ASTC_RGBA_10X8]="RGBA_ASTC_10x8",t[t.RGBA_ASTC_10x10=ui.ASTC_RGBA_10X10]="RGBA_ASTC_10x10",t[t.RGBA_ASTC_12x10=ui.ASTC_RGBA_12X10]="RGBA_ASTC_12x10",t[t.RGBA_ASTC_12x12=ui.ASTC_RGBA_12X12]="RGBA_ASTC_12x12"}(Em||(Em={})),function(t){t[t.REPEAT=Ai.WRAP]="REPEAT",t[t.CLAMP_TO_EDGE=Ai.CLAMP]="CLAMP_TO_EDGE",t[t.MIRRORED_REPEAT=Ai.MIRROR]="MIRRORED_REPEAT",t[t.CLAMP_TO_BORDER=Ai.BORDER]="CLAMP_TO_BORDER"}(wm||(wm={})),function(t){t[t.NONE=Ci.NONE]="NONE",t[t.LINEAR=Ci.LINEAR]="LINEAR",t[t.NEAREST=Ci.POINT]="NEAREST"}(Pm||(Pm={})),ae(ui);var km,Hm,jm,Wm,qm=new pt("Tex"),Xm=hc("cc.TextureBase")((Vm=Gm=function(t){function e(){var e;return at(e=t.call(this)||this,"_format",Dm,it(e)),at(e,"_minFilter",Bm,it(e)),at(e,"_magFilter",Mm,it(e)),at(e,"_mipFilter",Om,it(e)),at(e,"_wrapS",Nm,it(e)),at(e,"_wrapT",Lm,it(e)),at(e,"_wrapR",Fm,it(e)),at(e,"_anisotropy",zm,it(e)),e._width=1,e._height=1,e._id=void 0,e._samplerInfo=new mr,e._gfxSampler=null,e._gfxDevice=null,e._textureHash=0,e._id=qm.getNewId(),e._gfxDevice=e._getGFXDevice(),e._textureHash=po(e._id,666),e}Q(e,t);var n=e.prototype;return n.getId=function(){return this._id},n.getPixelFormat=function(){return this._format},n.getAnisotropy=function(){return this._anisotropy},n.setWrapMode=function(t,e,n){void 0===n&&(n=t),this._wrapS=t,this._samplerInfo.addressU=t,this._wrapT=e,this._samplerInfo.addressV=e,this._wrapR=n,this._samplerInfo.addressW=n,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setFilters=function(t,e){this._minFilter=t,this._samplerInfo.minFilter=t,this._magFilter=e,this._samplerInfo.magFilter=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setMipFilter=function(t){this._mipFilter=t,this._samplerInfo.mipFilter=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setAnisotropy=function(t){this._anisotropy=t,this._samplerInfo.maxAnisotropy=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.destroy=function(){var e,n=t.prototype.destroy.call(this);return n&&(null===(e=c.director.root)||void 0===e?void 0:e.batcher2D)&&c.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),n},n.getHash=function(){return this._textureHash},n.getGFXTexture=function(){return null},n.getSamplerInfo=function(){return this._samplerInfo},n.getGFXSampler=function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo):D(9302)),this._gfxSampler},n._serialize=function(){return""},n._deserialize=function(t){var e=t.split(",");e.unshift(""),e.length>=5&&(this.setFilters(parseInt(e[1]),parseInt(e[2])),this.setWrapMode(parseInt(e[3]),parseInt(e[4]))),e.length>=7&&(this.setMipFilter(parseInt(e[5])),this.setAnisotropy(parseInt(e[6])))},n._getGFXDevice=function(){return c.director.root?c.director.root.device:null},n._getGFXFormat=function(){return this._getGFXPixelFormat(this._format)},n._setGFXFormat=function(t){this._format=void 0===t?Em.RGBA8888:t},n._getGFXPixelFormat=function(t){return t===Em.RGBA_ETC1?t=Em.RGB_ETC1:t===Em.RGB_A_PVRTC_4BPPV1?t=Em.RGB_PVRTC_4BPPV1:t===Em.RGB_A_PVRTC_2BPPV1&&(t=Em.RGB_PVRTC_2BPPV1),t},K(e,[{key:"isCompressed",get:function(){return this._format>=Em.RGB_ETC1&&this._format<=Em.RGBA_ASTC_12x12||this._format>=Em.RGB_A_PVRTC_2BPPV1&&this._format<=Em.RGBA_ETC1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),e}(Pu),Gm.PixelFormat=Em,Gm.WrapMode=wm,Gm.Filter=Pm,Dm=st((Rm=Vm).prototype,"_format",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Em.RGBA8888}}),Bm=st(Rm.prototype,"_minFilter",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pm.LINEAR}}),Mm=st(Rm.prototype,"_magFilter",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pm.LINEAR}}),Om=st(Rm.prototype,"_mipFilter",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pm.NONE}}),Nm=st(Rm.prototype,"_wrapS",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wm.REPEAT}}),Lm=st(Rm.prototype,"_wrapT",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wm.REPEAT}}),Fm=st(Rm.prototype,"_wrapR",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wm.REPEAT}}),zm=st(Rm.prototype,"_anisotropy",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Im=Rm))||Im;function Ym(t){return!!(c.sys.hasFeature(c.sys.Feature.IMAGE_BITMAP)&&t instanceof ImageBitmap)}c.TextureBase=Xm;var Km=t("ImageAsset",hc("cc.ImageAsset")((Wm=jm=function(t){function e(e){var n;return(n=t.call(this)||this)._nativeData=void 0,n._exportedExts=void 0,n._format=Em.RGBA8888,n._width=0,n._height=0,n._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==e&&n.reset(e),n}Q(e,t);var n=e.prototype;return n.reset=function(t){Ym(t)||t instanceof HTMLElement?this._nativeData=t:(this._nativeData=t,this._format=t.format)},n.destroy=function(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset("")):Ym(this.data)&&this.data.close&&this.data.close(),t.prototype.destroy.call(this)},n._serialize=function(){},n._deserialize=function(t){var n="";"string"==typeof t?n=t:(this._width=t.w,this._height=t.h,n=t.fmt);for(var i,r=c.director.root?c.director.root.device:null,o=n.split("_"),a=Number.MAX_VALUE,s=this._format,l="",u=c.macro.SUPPORT_TEXTURE_FORMATS,h=ot(o);!(i=h()).done;){var _=i.value.split("@"),f=parseInt(_[0],void 0),p=e.extnames[f]||_[0],d=u.indexOf(p);if(-1!==d&&d<a){var m=_[1]?parseInt(_[1]):this._format;if(!(".astc"!==p||r&&r.hasFeature(li.FORMAT_ASTC)))continue;if(!(".pvr"!==p||r&&r.hasFeature(li.FORMAT_PVRTC)))continue;if(!(m!==Em.RGB_ETC1&&m!==Em.RGBA_ETC1||r&&r.hasFeature(li.FORMAT_ETC1)))continue;if(!(m!==Em.RGB_ETC2&&m!==Em.RGBA_ETC2||r&&r.hasFeature(li.FORMAT_ETC2)))continue;if(".webp"===p&&!c.sys.hasFeature(c.sys.Feature.WEBP))continue;a=d,l=p,s=m}}l?(this._setRawAsset(l),this._format=s):I(3121)},n.initDefault=function(n){if(t.prototype.initDefault.call(this,n),e._sharedPlaceHolderCanvas)this.reset(e._sharedPlaceHolderCanvas);else{var i=document.createElement("canvas"),r=i.getContext("2d"),o=i.width=i.height=2;r.fillStyle="#ff00ff",r.fillRect(0,0,o,o),this.reset(i),e._sharedPlaceHolderCanvas=i}},n.validate=function(){return!!this.data},K(e,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(t){t instanceof HTMLElement||Ym(t)||(t.format=t.format||this._format),this.reset(t)}},{key:"data",get:function(){return this._nativeData&&((t=this._nativeData)instanceof HTMLImageElement||t instanceof HTMLCanvasElement||Ym(t))?this._nativeData:this._nativeData&&this._nativeData._data;var t}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=Em.RGB_ETC1&&this._format<=Em.RGBA_ASTC_12x12||this._format>=Em.RGB_A_PVRTC_2BPPV1&&this._format<=Em.RGBA_ETC1}},{key:"url",get:function(){return this.nativeUrl}}]),e}(Pu),jm.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],jm._sharedPlaceHolderCanvas=null,st((Hm=Wm).prototype,"_nativeAsset",[el],Object.getOwnPropertyDescriptor(Hm.prototype,"_nativeAsset"),Hm.prototype),km=Hm))||km);c.ImageAsset=Km;var Jm=new WeakMap,Qm=new WeakSet,Zm=new WeakSet;function $m(t,e){var n;n=Zu.safeFindClass;var i,r=xh.pool.get();try{i=Bh(t,r,{classFinder:n,customEnv:e})}catch(t){throw x(t),xh.pool.put(r),t}i._uuid=e.__uuid__||"";for(var o=r.uuidList,a=r.uuidObjList,s=r.uuidPropList,c=r.uuidTypeList||[],l=[],u=0;u<o.length;u++){var h=o[u];l[u]={uuid:Rl(h),owner:a[u],prop:s[u],type:ee._getClassById(c[u])}}return Jm.set(i,l),i._native&&Qm.add(i),xh.pool.put(r),i}var tv,ev=new(function(){function t(){this._depends=new fl}var e=t.prototype;return e.init=function(){this._depends.clear()},e.getNativeDep=function(t){var e=this._depends.get(t);return e&&e.nativeDep?J({},e.nativeDep):null},e.getDeps=function(t){return this._depends.has(t)?this._depends.get(t).deps:[]},e.getDepsRecursively=function(t){var e=Object.create(null),n=[];return this._descend(t,e,n),n},e.remove=function(t){this._depends.remove(t)},e.parse=function(t,e){var n,i,r=null;if(Array.isArray(e)||e.__type__||e instanceof ch){if(this._depends.has(t))return this._depends.get(t);if(!Array.isArray(e)||"number"==typeof(i=(n=e[5])[n.length-1])&&i<0)try{var o=$m(e,{__uuid__:t});(r=this._parseDepsFromAsset(o)).nativeDep&&(r.nativeDep.uuid=t),gl.add(t+"@import",o)}catch(e){vl.remove(t+"@import"),r={deps:[]}}else r={deps:this._parseDepsFromJson(e)}}else{if(this._depends.has(t)&&(r=this._depends.get(t)).parsedFromExistAsset)return r;r=this._parseDepsFromAsset(e)}return this._depends.add(t,r),r},e._parseDepsFromAsset=function(t){for(var e={deps:[],parsedFromExistAsset:!0},n=Jm.get(t),i=0,r=n.length;i<r;i++)e.deps.push(n[i].uuid);return Qm.has(t)&&(e.nativeDep=t._nativeDep),e},e._parseDepsFromJson=function(t){var e=function(t){return n=(e=t)[1],e[10].map((function(t){return n[t]}));var e,n}(t);return e.forEach((function(t,n){return e[n]=Rl(t)})),e},e._descend=function(t,e,n){for(var i=this.getDeps(t),r=0;r<i.length;r++){var o=i[r];e[o]||(e[o]=!0,n.push(o),this._descend(o,e,n))}},t}()),nv=[new ir];function iv(t){return t&&0==(t&t-1)}var rv,ov,av,sv,cv,lv,uv=hc("cc.SimpleTexture")(tv=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gfxTexture=null,e._mipmapLevel=1,e._textureWidth=0,e._textureHeight=0,e}Q(e,t);var n=e.prototype;return n.getGFXTexture=function(){return this._gfxTexture},n.destroy=function(){return this._tryDestroyTexture(),t.prototype.destroy.call(this)},n.updateImage=function(){this.updateMipmaps(0)},n.updateMipmaps=function(){},n.uploadData=function(t,e,n){if(void 0===e&&(e=0),void 0===n&&(n=0),this._gfxTexture&&!(this._mipmapLevel<=e)){var i=this._getGFXDevice();if(i){var r=nv[0];r.texExtent.width=this._textureWidth>>e,r.texExtent.height=this._textureHeight>>e,r.texSubres.mipLevel=e,r.texSubres.baseArrayLayer=n,ArrayBuffer.isView(t)?i.copyBuffersToTexture([t],this._gfxTexture,nv):i.copyTexImagesToTexture([t],this._gfxTexture,nv)}}},n._assignImage=function(t,e,n){var i=t.data;if(i&&(this.uploadData(i,e,n),this._checkTextureLoaded(),ce.CLEANUP_IMAGE_CACHE)){var r=ev.getDeps(this._uuid),o=r.indexOf(t._uuid);-1!==o&&(ut(r,o),t.decRef())}},n._checkTextureLoaded=function(){this._textureReady()},n._textureReady=function(){this.loaded=!0,this.emit("load")},n._setMipmapLevel=function(t){this._mipmapLevel=t<1?1:t},n._getGfxTextureCreateInfo=function(){return null},n._tryReset=function(){if(this._tryDestroyTexture(),0!==this._mipmapLevel){var t=this._getGFXDevice();t&&this._createTexture(t)}},n._createTexture=function(t){if(0!==this._width&&0!==this._height){var e=yi.NONE;this._mipFilter!==Pm.NONE&&function(t,e,n){return!(t.gfxAPI===si.WEBGL)||iv(e)&&iv(n)}(t,this._width,this._height)&&(this._mipmapLevel=function(t,e){for(var n=Math.max(t,e),i=0;n;)n>>=1,i++;return i}(this._width,this._height),e=yi.GEN_MIPMAP);var n=this._getGfxTextureCreateInfo({usage:gi.SAMPLED|gi.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:e});if(n){var i=t.createTexture(n);this._textureWidth=n.width,this._textureHeight=n.height,this._gfxTexture=i}}},n._tryDestroyTexture=function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)},K(e,[{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),e}(Xm))||tv;c.SimpleTexture=uv;var hv,_v,fv,pv,dv,mv,vv,gv=t("Texture2D",(rv=hc("cc.Texture2D"),ov=Wc([Km]),rv((lv=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_mipmaps",cv,it(e)),e}Q(e,t);var n=e.prototype;return n.initialize=function(){this.mipmaps=this._mipmaps},n.onLoaded=function(){this.initialize()},n.reset=function(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format),this._setMipmapLevel(t.mipmapLevel||1),this._tryReset()},n.create=function(t,e,n,i){void 0===n&&(n=Em.RGBA8888),void 0===i&&(i=1),this.reset({width:t,height:e,format:n,mipmapLevel:i})},n.toString=function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""},n.updateMipmaps=function(t,e){if(void 0===t&&(t=0),!(t>=this._mipmaps.length))for(var n=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t),i=0;i<n;++i){var r=t+i;this._assignImage(this._mipmaps[r],r)}},n.getHtmlElementObj=function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null},n.destroy=function(){return this._mipmaps=[],t.prototype.destroy.call(this)},n.description=function(){return"<cc.Texture2D | Name = "+(this._mipmaps[0]?this._mipmaps[0].url:"")+" | Dimension = "+this.width+" x "+this.height+">"},n.releaseTexture=function(){this.destroy()},n._serialize=function(){return null},n._deserialize=function(e,n){var i=e;t.prototype._deserialize.call(this,i.base,n),this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r)if(this._mipmaps[r]=new Km,i.mipmaps[r]){var o=i.mipmaps[r];n.result.push(this._mipmaps,""+r,o,ee._getClassId(Km))}},n._getGfxTextureCreateInfo=function(t){var e=new pr(vi.TEX2D);return e.width=this._width,e.height=this._height,Object.assign(e,t)},n.initDefault=function(e){t.prototype.initDefault.call(this,e);var n=new Km;n.initDefault(),this.image=n},n.validate=function(){return this.mipmaps&&0!==this.mipmaps.length},K(e,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(t){var e=this;if(this._mipmaps=t,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0];this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(t,n){e._assignImage(t,n)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(t){this.mipmaps=t?[t]:[]}}]),e}(uv),cv=st((sv=lv).prototype,"_mipmaps",[ov],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),av=sv))||av));c.Texture2D=gv,function(t){t[t.right=0]="right",t[t.left=1]="left",t[t.top=2]="top",t[t.bottom=3]="bottom",t[t.front=4]="front",t[t.back=5]="back"}(vv||(vv={}));var yv=t("TextureCube",hc("cc.TextureCube")((mv=dv=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"isRGBE",fv,it(e)),at(e,"_mipmaps",pv,it(e)),e}Q(e,t),e.fromTexture2DArray=function(t,n){for(var i=[],r=t.length/6,o=0;o<r;o++){var a=6*o;i.push({front:t[a+vv.front].image,back:t[a+vv.back].image,left:t[a+vv.left].image,right:t[a+vv.right].image,top:t[a+vv.top].image,bottom:t[a+vv.bottom].image})}return(n=n||new e).mipmaps=i,n};var n=e.prototype;return n.onLoaded=function(){this.mipmaps=this._mipmaps},n.reset=function(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format),this._setMipmapLevel(t.mipmapLevel||1),this._tryReset()},n.updateMipmaps=function(t,e){var n=this;if(void 0===t&&(t=0),!(t>=this._mipmaps.length))for(var i=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t),r=function(e){var i=t+e;xv(n._mipmaps[i],(function(t,e){n._assignImage(t,i,e)}))},o=0;o<i;++o)r(o)},n.destroy=function(){return this._mipmaps=[],t.prototype.destroy.call(this)},n.releaseTexture=function(){this.mipmaps=[]},n._serialize=function(){return null},n._deserialize=function(e,n){var i=e;t.prototype._deserialize.call(this,i.base,n),this.isRGBE=i.rgbe,this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r){this._mipmaps[r]={front:new Km,back:new Km,left:new Km,right:new Km,top:new Km,bottom:new Km};var o=i.mipmaps[r],a=ee._getClassId(Km);n.result.push(this._mipmaps[r],"front",o.front,a),n.result.push(this._mipmaps[r],"back",o.back,a),n.result.push(this._mipmaps[r],"left",o.left,a),n.result.push(this._mipmaps[r],"right",o.right,a),n.result.push(this._mipmaps[r],"top",o.top,a),n.result.push(this._mipmaps[r],"bottom",o.bottom,a)}},n._getGfxTextureCreateInfo=function(t){var e=new pr(vi.CUBE);return e.width=this._width,e.height=this._height,e.layerCount=6,Object.assign(e,t),e},n.initDefault=function(e){t.prototype.initDefault.call(this,e);var n=new Km;n.initDefault(),this.mipmaps=[{front:n,back:n,top:n,bottom:n,left:n,right:n}]},n.validate=function(){return 0!==this._mipmaps.length&&!this._mipmaps.find((function(t){return!(t.top&&t.bottom&&t.front&&t.back&&t.left&&t.right)}))},K(e,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(t){var e=this;if(this._mipmaps=t,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0].front;this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(t,n){xv(t,(function(t,i){e._assignImage(t,n,i)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(t){this.mipmaps=t?[t]:[]}}]),e}(uv),dv.FaceIndex=vv,fv=st((_v=mv).prototype,"isRGBE",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),pv=st(_v.prototype,"_mipmaps",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),hv=_v))||hv);function xv(t,e){e(t.front,vv.front),e(t.back,vv.back),e(t.left,vv.left),e(t.right,vv.right),e(t.top,vv.top),e(t.bottom,vv.bottom)}c.TextureCube=yv;var Sv,Cv,Av,bv=t("effects",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:2909832090,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:53,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:3507038093,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:0,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:2610213142,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1},{name:"a_dist",defines:[],format:11,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"occlusion-query",techniques:[{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blendColorMask:0}]},program:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",hash:1571978323,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:41,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCWorldBound",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:1250077034,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:63,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"USE_VK_SHADER",type:"boolean"},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position_starttime",defines:[],format:44,location:0},{name:"a_size_uv",defines:[],format:44,location:1},{name:"a_rotation_uv",defines:[],format:44,location:2},{name:"a_color",defines:[],format:44,location:3},{name:"a_dir_life",defines:[],format:44,location:4},{name:"a_rndSeed",defines:[],format:11,location:5},{name:"a_texCoord",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:7},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_color1",defines:["CC_RENDER_MODE"],format:44,location:9}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:1437790364,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:44,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:2554907268,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:32,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4},{name:"a_color1",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:7}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"spine",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine|sprite-vs:vert|sprite-fs:frag",hash:3192452405,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:[]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"TWO_COLORED",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2},{name:"a_color2",defines:["TWO_COLORED"],format:44,location:3}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:1770338543,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},SpecularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],linear:!0,type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},normalStrenth:{value:[1],type:13,handleInfo:["emissiveScaleParam",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},emissiveScaleParam:{type:16,value:[1,1,1,1]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs|standard-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"standard|standard-vs|standard-fs",hash:4038009253,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:222,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:65},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_TWOSIDE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13},{name:"a_texCoord1",defines:[],format:21,location:14}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:7},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:8},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:9}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:210600745,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:183,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:65},globals:{blocks:[{name:"CCShadow",defines:[]},{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_texCoord1",defines:[],format:21,location:13}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs|terrain-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs|terrain-fs",hash:3916952624,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:70,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:61},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_PBR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplerTextures:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:12},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:13},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:14}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:4270039829,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:68,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{linear:!0,type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:3319190198,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:197,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:41},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"bloom",techniques:[{passes:[{phase:"bloom-prefilter",program:"bloom|bloom-vs|prefilter-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-combine",program:"bloom|bloom-vs|combine-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"bloom|bloom-vs|prefilter-fs",hash:2185821616,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|downsample-fs",hash:1780231359,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|upsample-fs",hash:3580425335,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|combine-fs",hash:3457196798,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1},{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"deferred-lighting",techniques:[{passes:[{phase:"deferred-lighting",program:"deferred-lighting|lighting-vs|lighting-fs",depthStencilState:{depthFunc:4,depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"deferred-lighting|lighting-vs|lighting-fs",hash:3788484086,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCForwardLight",defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[{name:"depth_stencil",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:4},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:5},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:6}],images:[],textures:[],samplers:[],subpassInputs:[{name:"gbuffer_albedoMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:0},{name:"gbuffer_normalMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:1},{name:"gbuffer_emissiveMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:2}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:730673320,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:216,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"post-process",techniques:[{passes:[{phase:"post-process",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendSrcAlpha:2,blendDstAlpha:4}]},program:"post-process|post-process-vs|post-process-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"post-process|post-process-vs|post-process-fs",hash:3237848814,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"ANTIALIAS_TYPE",type:"number",range:[0,3]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:0}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:4277052359,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_environment",defines:[]}],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",priority:255,depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:179162168,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:60,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"splash-screen",techniques:[{name:"default",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},resolution:{value:[640,960],type:14,handleInfo:["u_buffer0",0,14]},percent:{value:[.5],type:13,handleInfo:["u_percent",0,13]},scale:{value:[200,500],type:14,handleInfo:["u_buffer1",0,14]},translate:{value:[320,480],type:14,handleInfo:["u_buffer1",2,14]},u_buffer0:{type:16,value:[640,960,0,0]},u_percent:{type:13,value:[.5]},u_buffer1:{type:16,value:[200,500,320,480]}}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:3189094080,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:6,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:21,location:0},{name:"a_texCoord",defines:[],format:21,location:1}],blocks:[{name:"Constant",defines:[],binding:0,stageFlags:1,members:[{name:"u_buffer0",type:16,count:1},{name:"u_buffer1",type:16,count:1},{name:"u_projection",type:25,count:1}]},{name:"Factor",defines:[],binding:1,stageFlags:16,members:[{name:"u_percent",type:13,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]}]),Tv={glsl1:[[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\nvec4 o = v_color;\n#ifdef GL_OES_standard_derivatives\nfloat aa = fwidth(v_dist);\n#else\nfloat aa = 0.05;\n#endif\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_worldBoundCenter;\nuniform highp vec4 cc_worldBoundHalfExtents;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nuniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nuniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nuniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nuniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nuniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nuniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture2D(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\nattribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 v_light;\nvarying vec2 uv0;\n#if TWO_COLORED\nattribute vec4 a_color2;\nvarying vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 v_light;\n#if TWO_COLORED\nvarying vec4 v_dark;\n#endif\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture2D(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture2D(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\n#if SAMPLE_FROM_RT\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\n#endif\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nattribute vec4 a_color;\nvarying vec4 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\n#if USE_VERTEX_COLOR\nvarying vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture2D(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture2D(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture2D(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nuniform highp mat4 cc_matLightView;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture2D(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 luv;\nvarying mediump vec3 diffuse;\nuniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 diffuse;\nvarying mediump vec3 luv;\nuniform vec4 metallic;\nuniform vec4 roughness;\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture2D(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture2D(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\nbaseColor += texture2D(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture2D(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture2D(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\nbaseNormal += texture2D(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture2D(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nvarying vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nattribute lowp vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform vec4 tilingOffset;\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture2D(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture2D(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\ngl_FragColor = vec4(color, 1.0);\n} else {\ngl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nvoid main() {\nvec4 hdrColor = texture2D(outputResultMap, v_uv);\nvec3 bloomColor = texture2D(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\ngl_FragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewProjInv;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp mat4 cc_matLightViewProj;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nvarying vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\nuniform sampler2D depth_stencil;\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gl_LastFragData[0];\nvec4 normalMap = gl_LastFragData[1];\nvec4 emissiveMap = gl_LastFragDat[2];\n#else\nvec4 albedoMap = texture2D(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture2D(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture2D(gbuffer_emissiveMap,v_uv);\n#endif\nfloat depth = texture2D(depth_stencil, v_uv).x;\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngl_FragData[2] = color;\n#else\ngl_FragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform mediump vec4 cc_planarNDInfo;\nvarying float v_dist;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\nvec4 texColor = texture2D(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nvarying vec2 v_uv;\nuniform sampler2D outputResultMap;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\ngl_FragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\ngl_FragColor = texture2D(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nvarying mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nuniform vec4 u_buffer0;\nuniform vec4 u_buffer1;\nuniform mat4 u_projection;\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform float u_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture2D(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}]],glsl3:[[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nin vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCWorldBound {\nhighp vec4 cc_worldBoundCenter;\nhighp vec4 cc_worldBoundHalfExtents;\n};\nin vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord;\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nlayout(std140) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nlayout(std140) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nlayout(std140) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nlayout(std140) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nlayout(std140) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nlayout(std140) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nout vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\n#if CC_DRAW_WIRE_FRAME\nin vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\nin vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 v_light;\nout vec2 uv0;\n#if TWO_COLORED\nin vec4 a_color2;\nout vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 v_light;\n#if TWO_COLORED\nin vec4 v_dark;\n#endif\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\n#if SAMPLE_FROM_RT\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nin vec4 a_color;\nout vec4 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\nout vec2 v_uv;\nout vec2 v_uv1;\n#if USE_NORMAL_MAP\nout vec3 v_tangent;\nout vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nout vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\n#if USE_VERTEX_COLOR\nin vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nin vec3 v_tangent;\nin vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\nout vec2 v_uv1;\nout vec4 v_worldPos;\nout float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec4 v_worldPos;\nin float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout highp vec3 v_position;\nout mediump vec3 v_normal;\n#if USE_NORMALMAP\nout mediump vec3 v_tangent;\nout mediump vec3 v_binormal;\n#endif\nout mediump vec2 uvw;\nout mediump vec2 uv0;\nout mediump vec2 uv1;\nout mediump vec2 uv2;\nout mediump vec2 uv3;\nout mediump vec3 luv;\nout mediump vec3 diffuse;\nlayout(std140) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin highp vec3 v_position;\nin mediump vec3 v_normal;\n#if USE_NORMALMAP\nin mediump vec3 v_tangent;\nin mediump vec3 v_binormal;\n#endif\nin mediump vec2 uvw;\nin mediump vec2 uv0;\nin mediump vec2 uv1;\nin mediump vec2 uv2;\nin mediump vec2 uv3;\nin mediump vec3 diffuse;\nin mediump vec3 luv;\nlayout(std140) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nin vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nin lowp vec4 a_color;\nout lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nout vec2 v_uv;\nlayout(std140) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nin vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\nfragColor = vec4(color, 1.0);\n} else {\nfragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvoid main() {\nvec4 hdrColor = texture(outputResultMap, v_uv);\nvec3 bloomColor = texture(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\nfragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nin vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nlayout(location = 0) inout vec4 gbuffer_albedoMap;\nlayout(location = 1) inout vec4 gbuffer_normalMap;\nlayout(location = 2) inout vec4 gbuffer_emissiveMap;\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\nuniform sampler2D depth_stencil;\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\nlayout(location = 0) out vec4 fragColor;\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gbuffer_albedoMap;\nvec4 normalMap = gbuffer_normalMap;\nvec4 emissiveMap = gbuffer_emissiveMap;\n#else\nvec4 albedoMap = texture(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(gbuffer_emissiveMap,v_uv);\n#endif\nfloat depth = texture(depth_stencil, v_uv).x;\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngbuffer_emissiveMap = color;\n#else\nfragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nout float v_dist;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nin vec2 v_uv;\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\nfragColor = texture(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nout mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\nvec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nlayout(std140) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nlayout(std140) uniform Factor {\nfloat u_percent;\n};\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]]},Ev=function(){function t(){this._device=null,this._resources={}}var e=t.prototype;return e.initBuiltinRes=function(t){var e=this;this._device=t;for(var n=this._resources,i=new Uint8Array(16),r=new Uint8Array(16),o=new Uint8Array(16),a=new Uint8Array(16),s=new Uint8Array(16),l=0,u=0;u<4;u++)i[l]=0,i[l+1]=0,i[l+2]=0,i[l+3]=255,r[l]=0,r[l+1]=0,r[l+2]=0,r[l+3]=0,o[l]=119,o[l+1]=119,o[l+2]=119,o[l+3]=255,a[l]=255,a[l+1]=255,a[l+2]=255,a[l+3]=255,s[l]=127,s[l+1]=127,s[l+2]=255,s[l+3]=255,l+=4;var h=new Uint8Array(1024);l=0;for(var _=0;_<256;_++)h[l]=221,h[l+1]=221,h[l+2]=221,h[l+3]=255,l+=4;l=0;for(var f=0;f<8;f++){for(var p=0;p<8;p++)h[l]=85,h[l+1]=85,h[l+2]=85,h[l+3]=255,l+=4;l+=32}l+=32;for(var d=0;d<8;d++){for(var m=0;m<8;m++)h[l]=85,h[l+1]=85,h[l+2]=85,h[l+3]=255,l+=4;l+=32}var v={width:2,height:2,_data:i,_compressed:!1,format:gv.PixelFormat.RGBA8888},g={width:2,height:2,_data:r,_compressed:!1,format:gv.PixelFormat.RGBA8888},y={width:2,height:2,_data:o,_compressed:!1,format:gv.PixelFormat.RGBA8888},x={width:2,height:2,_data:a,_compressed:!1,format:gv.PixelFormat.RGBA8888},S={width:2,height:2,_data:s,_compressed:!1,format:gv.PixelFormat.RGBA8888},C={width:16,height:16,_data:h,_compressed:!1,format:gv.PixelFormat.RGBA8888},A=new Km(v),b=new gv;b._uuid="black-texture",b.image=A,n[b._uuid]=b;var T=new Km(g),E=new gv;E._uuid="empty-texture",E.image=T,n[E._uuid]=E;var w=new yv;w._uuid="black-cube-texture",w.setMipFilter(yv.Filter.NEAREST),w.image={front:new Km(v),back:new Km(v),left:new Km(v),right:new Km(v),top:new Km(v),bottom:new Km(v)},n[w._uuid]=w;var P=new Km(y),I=new gv;I._uuid="grey-texture",I.image=P,n[I._uuid]=I;var R=new Km(x),D=new gv;D._uuid="white-texture",D.image=R,n[D._uuid]=D;var B=new yv;B._uuid="white-cube-texture",B.setMipFilter(yv.Filter.NEAREST),B.image={front:new Km(x),back:new Km(x),left:new Km(x),right:new Km(x),top:new Km(x),bottom:new Km(x)},n[B._uuid]=B;var M=new Km(S),O=new gv;O._uuid="normal-texture",O.image=M,n[O._uuid]=O;var N=new Km(C),L=new gv;L._uuid="default-texture",L.image=N,n[L._uuid]=L;var F=new yv;if(F.setMipFilter(yv.Filter.NEAREST),F._uuid="default-cube-texture",F.image={front:new Km(C),back:new Km(C),left:new Km(C),right:new Km(C),top:new Km(C),bottom:new Km(C)},n[F._uuid]=F,c.SpriteFrame){var z=new c.SpriteFrame,G=A,V=new gv;V.image=G,z.texture=V,z._uuid="default-spriteframe",n[z._uuid]=z}var U=dm(t);if(!U)return Promise.reject(Error("Failed to initialize builtin shaders: unknown device."));var k=Tv[U];return k?Promise.resolve().then((function(){bv.forEach((function(t,e){var n=Object.assign(new c.EffectAsset,t);n.shaders.forEach((function(t,n){var i=k[e][n];i&&(t[U]=i)})),n.hideInEditor=!0,n.onLoaded()})),e._initMaterials()})):Promise.reject(Error("Current device is requiring builtin shaders of version "+U+" but shaders of that version are not assembled in this build."))},e.get=function(t){return this._resources[t]},e._initMaterials=function(){var t=this._resources,e=[],n=new c.Material;n._uuid="standard-material",n.initialize({effectName:"standard"}),t[n._uuid]=n,e.push(n);var i=new c.Material;i._uuid="missing-effect-material",i.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),i.setProperty("mainColor",c.color("#ffff00")),t[i._uuid]=i,e.push(i);var r=new c.Material;r._uuid="missing-material",r.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),r.setProperty("mainColor",c.color("#ff00ff")),t[r._uuid]=r,e.push(r);var o=new c.Material;o._uuid="default-clear-stencil",o.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),t[o._uuid]=o,e.push(o);var a=new c.Material;a._uuid="ui-base-material",a.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),t[a._uuid]=a,e.push(a);var s=new c.Material;s._uuid="ui-sprite-material",s.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),t[s._uuid]=s,e.push(s);var l=new c.Material;l._uuid="ui-alpha-test-material",l.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),t[l._uuid]=l,e.push(l);var u=new c.Material;u._uuid="ui-sprite-gray-material",u.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),t[u._uuid]=u,e.push(u);var h=new c.Material;h._uuid="ui-sprite-alpha-sep-material",h.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),t[h._uuid]=h,e.push(h);var _=new c.Material;_._uuid="ui-sprite-gray-alpha-sep-material",_.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),t[_._uuid]=_,e.push(_);var f=new c.Material;f._uuid="ui-graphics-material",f.initialize({effectName:"graphics"}),t[f._uuid]=f,e.push(f);var p=new c.Material;p._uuid="default-particle-material",p.initialize({effectName:"particle"}),t[p._uuid]=p,e.push(p);var d=new c.Material;d._uuid="default-particle-gpu-material",d.initialize({effectName:"particle-gpu"}),t[d._uuid]=d,e.push(d);var m=new c.Material;m._uuid="default-trail-material",m.initialize({effectName:"particle-trail"}),t[m._uuid]=m,e.push(m);var v=new c.Material;v._uuid="default-billboard-material",v.initialize({effectName:"billboard"}),t[v._uuid]=v,e.push(v);var g=new c.Material;g._uuid="default-spine-material",g.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"spine"}),t[g._uuid]=g,e.push(g),c.game.on(c.Game.EVENT_GAME_INITED,(function(){for(var t=0;t<e.length;++t)for(var n=e[t],i=0;i<n.passes.length;++i)n.passes[i].tryCompile()}))},t}(),wv=t("builtinResMgr",c.builtinResMgr=new Ev),Pv=t("getPhaseID",(Sv=new Map,Cv=0,function(t){return"number"==typeof t?t:(Sv.has(t)||(Sv.set(t,1<<Cv),Cv++),Sv.get(t))})),Iv=t("InstancedBuffer",function(){function t(t){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=t.device,this.pass=t}var e=t.prototype;return e.destroy=function(){for(var t=0;t<this.instances.length;++t){var e=this.instances[t];e.vb.destroy(),e.ia.destroy()}this.instances.length=0},e.merge=function(t,e,n,i){void 0===i&&(i=null);var r=e.buffer.length;if(r){var o=t.inputAssembler,a=t.descriptorSet.getTexture(Dd),s=i;s||(s=t.shaders[n]);for(var c=t.descriptorSet,l=0;l<this.instances.length;++l){var u=this.instances[l];if(!(u.ia.indexBuffer!==o.indexBuffer||u.count>=1024)&&u.lightingMap===a&&u.stride===r){if(u.count>=u.capacity){u.capacity<<=1;var h=u.stride*u.capacity,_=u.data;u.data=new Uint8Array(h),u.data.set(_),u.vb.resize(h)}return u.shader!==s&&(u.shader=s),u.descriptorSet!==c&&(u.descriptorSet=c),u.data.set(e.buffer,u.stride*u.count++),void(this.hasPendingModels=!0)}}for(var f=this._device.createBuffer(new lr(fi.VERTEX|fi.TRANSFER_DST,mi.HOST|mi.DEVICE,32*r,r)),p=new Uint8Array(32*r),d=o.vertexBuffers.slice(),m=o.attributes.slice(),v=o.indexBuffer,g=0;g<e.attributes.length;g++){var y=e.attributes[g],x=new Er(y.name,y.format,y.isNormalized,d.length,!0);m.push(x)}p.set(e.buffer),d.push(f);var S=new Pr(m,d,v),C=this._device.createInputAssembler(S);this.instances.push({count:1,capacity:32,vb:f,data:p,ia:C,stride:r,shader:s,descriptorSet:c,lightingMap:a}),this.hasPendingModels=!0}},e.uploadBuffers=function(t){for(var e=0;e<this.instances.length;++e){var n=this.instances[e];n.count&&(n.ia.instanceCount=n.count,t.updateBuffer(n.vb,n.data))}},e.clear=function(){for(var t=0;t<this.instances.length;++t)this.instances[t].count=0;this.hasPendingModels=!1},t}()),Rv=function(){function t(t){this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=t.device}var e=t.prototype;return e.destroy=function(){for(var t=0;t<this.batches.length;++t){for(var e=this.batches[t],n=0;n<e.vbs.length;++n)e.vbs[n].destroy();e.vbIdx.destroy(),e.ia.destroy(),e.ubo.destroy()}this.batches.length=0},e.merge=function(t,e,n){var i=t.subMesh.flatBuffers;if(0!==i.length){for(var r=0,o=0,a=i[0].count,s=t.passes[e],c=t.shaders[e],l=t.descriptorSet,u=!1,h=0;h<this.batches.length;++h){var _=this.batches[h];if(_.vbs.length===i.length&&_.mergeCount<ud.BATCHING_COUNT){u=!0;for(var f=0;f<_.vbs.length;++f)if(_.vbs[f].stride!==i[f].stride){u=!1;break}if(u){for(var p=0;p<_.vbs.length;++p){var d=i[p],m=_.vbs[p],v=_.vbDatas[p];(r=(a+_.vbCount)*d.stride)>m.size&&(m.resize(r),_.vbDatas[p]=new Uint8Array(r),_.vbDatas[p].set(v)),_.vbDatas[p].set(d.buffer,_.vbCount*d.stride)}var g=_.vbIdxData;(o=4*(a+_.vbCount))>_.vbIdx.size&&(_.vbIdx.resize(o),_.vbIdxData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT),_.vbIdxData.set(g),g=_.vbIdxData);var y=_.vbCount,x=y+a,S=_.mergeCount;if(g[y]!==S||g[x-1]!==S)for(var C=y;C<x;C++)g[C]=S+.1;return Un.toArray(_.uboData,n.transform.worldMatrix,ud.MAT_WORLDS_OFFSET+16*_.mergeCount),_.mergeCount||(l.bindBuffer(ud.BINDING,_.ubo),l.update(),_.pass=s,_.shader=c,_.descriptorSet=l),++_.mergeCount,_.vbCount+=a,void(_.ia.vertexCount+=a)}}}for(var A=[],b=[],T=[],E=0;E<i.length;++E){var w=i[E],P=this._device.createBuffer(new lr(fi.VERTEX|fi.TRANSFER_DST,mi.HOST|mi.DEVICE,w.count*w.stride,w.stride));P.update(w.buffer.buffer),A.push(P),b.push(new Uint8Array(P.size)),T.push(P)}var I=this._device.createBuffer(new lr(fi.VERTEX|fi.TRANSFER_DST,mi.HOST|mi.DEVICE,4*a,4)),R=new Float32Array(a);R.fill(0),I.update(R),T.push(I);for(var D=t.inputAssembler.attributes,B=new Array(D.length+1),M=0;M<D.length;++M)B[M]=D[M];B[D.length]=new Er("a_dyn_batch_id",ui.R32F,!1,i.length);var O=new Pr(B,T),N=this._device.createInputAssembler(O),L=this._device.createBuffer(new lr(fi.UNIFORM|fi.TRANSFER_DST,mi.HOST|mi.DEVICE,ud.SIZE,ud.SIZE));l.bindBuffer(ud.BINDING,L),l.update();var F=new Float32Array(ud.COUNT);Un.toArray(F,n.transform.worldMatrix,ud.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:A,vbDatas:b,vbIdx:I,vbIdxData:R,vbCount:a,ia:N,ubo:L,uboData:F,pass:s,shader:c,descriptorSet:l})}},e.clear=function(){for(var t=0;t<this.batches.length;++t){var e=this.batches[t];e.vbCount=0,e.mergeCount=0,e.ia.vertexCount=0}},t}(),Dv=new lr(fi.UNIFORM|fi.TRANSFER_DST,mi.DEVICE),Bv=new ur(null),Mv=new Gr(null);!function(t){t[t.NONE=0]="NONE",t[t.INSTANCING=1]="INSTANCING",t[t.VB_MERGING=2]="VB_MERGING"}(Av||(Av={}));var Ov=function(){function t(t){this._rootBuffer=null,this._buffers=[],this._descriptorSet=null,this._pipelineLayout=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocksInt=[],this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._shader=null,this._bs=new Ao,this._dss=new So,this._rs=new xo,this._priority=Bp.DEFAULT,this._stage=Dp.DEFAULT,this._phase=Pv("default"),this._primitive=Ni.TRIANGLE_LIST,this._batchingScheme=Av.NONE,this._dynamicStates=Gi.NONE,this._instancedBuffers={},this._batchedBuffers={},this._hash=0,this._root=void 0,this._device=void 0,this._passHandle=0,this._rootBufferDirty=!1,this._root=t,this._device=t.device}t.fillPipelineInfo=function(t,e){void 0!==e.priority&&t._setPriority(e.priority),void 0!==e.primitive&&t._setPrimitive(e.primitive),void 0!==e.stage&&t._setStage(e.stage),void 0!==e.dynamicStates&&t._setDynamicState(e.dynamicStates),void 0!==e.phase&&t._setPhase(Pv(e.phase));var n=t._bs;if(e.blendState){var i=e.blendState,r=i.targets;r&&r.forEach((function(t,e){n.setTarget(e,t)})),void 0!==i.isA2C&&(n.isA2C=i.isA2C),void 0!==i.isIndepend&&(n.isIndepend=i.isIndepend),void 0!==i.blendColor&&(n.blendColor=i.blendColor)}t._rs.assign(e.rasterizerState),t._dss.assign(e.depthStencilState)},t.getPassHash=function(t){var e,n=bm.getKey(t.program,t.defines)+","+t._primitive+","+t._dynamicStates;return n+=function(t){for(var e,n=",bs,"+t.isA2C,i=ot(t.targets);!(e=i()).done;){var r=e.value;n+=",bt,"+r.blend+","+r.blendEq+","+r.blendAlphaEq+","+r.blendColorMask,n+=","+r.blendSrc+","+r.blendDst+","+r.blendSrcAlpha+","+r.blendDstAlpha}return n}(t._bs),n+=function(t){var e=",dss,"+t.depthTest+","+t.depthWrite+","+t.depthFunc;return e+=","+t.stencilTestFront+","+t.stencilFuncFront+","+t.stencilRefFront+","+t.stencilReadMaskFront,e+=","+t.stencilFailOpFront+","+t.stencilZFailOpFront+","+t.stencilPassOpFront+","+t.stencilWriteMaskFront,(e+=","+t.stencilTestBack+","+t.stencilFuncBack+","+t.stencilRefBack+","+t.stencilReadMaskBack)+","+t.stencilFailOpBack+","+t.stencilZFailOpBack+","+t.stencilPassOpBack+","+t.stencilWriteMaskBack}(t._dss),po(n+=",rs,"+(e=t._rs).cullMode+","+e.depthBias+","+e.isFrontFaceCCW,666)};var e=t.prototype;return e.initialize=function(t){this._doInit(t),this.resetUBOs(),this.resetTextures(),this.tryCompile()},e.getHandle=function(t,e,n){void 0===e&&(e=0),void 0===n&&(n=_i.UNKNOWN);var i=this._propertyHandleMap[t];return i?(n?i=im(i,n):e&&(i=im(i,$d(i)-e)),i+e):0},e.getBinding=function(e){var n=this.getHandle(e);return n?t.getBindingFromHandle(n):-1},e.setUniform=function(e,n){var i=t.getBindingFromHandle(e),r=t.getTypeFromHandle(e),o=t.getOffsetFromHandle(e),a=this._getBlockView(r,i);om[r](a,n,o),this._setRootBufferDirty(!0)},e.getUniform=function(e,n){var i=t.getBindingFromHandle(e),r=t.getTypeFromHandle(e),o=t.getOffsetFromHandle(e),a=this._getBlockView(r,i);return rm[r](a,n,o)},e.setUniformArray=function(e,n){for(var i=t.getBindingFromHandle(e),r=t.getTypeFromHandle(e),o=ro(r)>>2,a=this._getBlockView(r,i),s=t.getOffsetFromHandle(e),c=0;c<n.length;c++,s+=o)null!==n[c]&&om[r](a,n[c],s);this._setRootBufferDirty(!0)},e.bindTexture=function(t,e,n){this._descriptorSet.bindTexture(t,e,n||0)},e.bindSampler=function(t,e,n){this._descriptorSet.bindSampler(t,e,n||0)},e.setDynamicState=function(t,e){var n=this._dynamics[t];n&&n.value===e||(n.value=e,n.dirty=!0)},e.overridePipelineStates=function(){console.warn("base pass cannot override states, please use pass instance instead.")},e._setRootBufferDirty=function(t){this._rootBufferDirty=t},e.update=function(){this._descriptorSet?(this._rootBuffer&&this._rootBufferDirty&&(this._rootBuffer.update(this._rootBlock),this._setRootBufferDirty(!1)),this._descriptorSet.update()):D(12006)},e.getInstancedBuffer=function(t){return void 0===t&&(t=0),this._instancedBuffers[t]||(this._instancedBuffers[t]=new Iv(this))},e.getBatchedBuffer=function(t){return void 0===t&&(t=0),this._batchedBuffers[t]||(this._batchedBuffers[t]=new Rv(this))},e._initNative=function(){},e._destroy=function(){},e.destroy=function(){for(var t=0;t<this._shaderInfo.blocks.length;t++){var e=this._shaderInfo.blocks[t];this._buffers[e.binding].destroy()}for(var n in this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBuffer=null),this._instancedBuffers)this._instancedBuffers[n].destroy();for(var i in this._batchedBuffers)this._batchedBuffers[i].destroy();this._descriptorSet.destroy(),this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._destroy()},e.resetUniform=function(e){var n=this.getHandle(e);if(n){for(var i=t.getTypeFromHandle(n),r=t.getBindingFromHandle(n),o=t.getOffsetFromHandle(n),a=t.getCountFromHandle(n),s=this._getBlockView(i,r),c=this._properties[e],l=c&&c.value||sm(i),u=(ro(i)>>2)*a,h=0;h+l.length<=u;h+=l.length)s.set(l,o+h);this._setRootBufferDirty(!0)}},e.resetTexture=function(e,n){var i=this.getHandle(e);if(i){var r=t.getTypeFromHandle(i),o=t.getBindingFromHandle(i),a=this._properties[e],s=a&&a.value,c=s?s+"-texture":sm(r),l=wv.get(c),u=l&&l.getGFXTexture(),h=a&&void 0!==a.samplerHash?Po.unpackFromHash(a.samplerHash):l&&l.getSamplerInfo(),_=this._device.getSampler(h);this._descriptorSet.bindSampler(o,_,n),this._descriptorSet.bindTexture(o,u,n)}},e.resetUBOs=function(){for(var t=0;t<this._shaderInfo.blocks.length;t++)for(var e=this._shaderInfo.blocks[t],n=0,i=0;i<e.members.length;i++){for(var r=e.members[i],o=this._getBlockView(r.type,e.binding),a=this._properties[r.name],s=a&&a.value||sm(r.type),c=(ro(r.type)>>2)*r.count,l=0;l+s.length<=c;l+=s.length)o.set(s,n+l);n+=c}this._setRootBufferDirty(!0)},e.resetTextures=function(){for(var t=0;t<this._shaderInfo.samplerTextures.length;t++)for(var e=this._shaderInfo.samplerTextures[t],n=0;n<e.count;n++)this.resetTexture(e.name,n)},e.tryCompile=function(){var e=this._root.pipeline;if(!e)return!1;this._syncBatchingScheme();var n=bm.getGFXShader(this._device,this._programName,this._defines,e);return n?(this._shader=n,this._setPipelineLayout(bm.getTemplateInfo(this._programName).pipelineLayout),this._setHash(t.getPassHash(this)),!0):(console.warn("create shader "+this._programName+" failed"),!1)},e.getShaderVariant=function(t){if(void 0===t&&(t=null),!this._shader&&!this.tryCompile())return console.warn("pass resources incomplete"),null;if(!t)return this._shader;for(var e=this._root.pipeline,n=0;n<t.length;n++){var i=t[n];this._defines[i.name]=i.value}for(var r=bm.getGFXShader(this._device,this._programName,this._defines,e),o=0;o<t.length;o++){var a=t[o];delete this._defines[a.name]}return r},e.beginChangeStatesSilently=function(){},e.endChangeStatesSilently=function(){},e._setPriority=function(t){this._priority=t},e._setStage=function(t){this._stage=t},e._setPhase=function(t){this._phase=t},e._setPrimitive=function(t){this._primitive=t},e._setState=function(t,e,n,i){this._bs=t,this._dss=e,this._rs=n,this._descriptorSet=i},e._doInit=function(e,n){void 0===n&&(n=!1),this._initNative(),this._setPriority(Bp.DEFAULT),this._setStage(Dp.DEFAULT),this._setPhase(Pv("default")),this._setPrimitive(Ni.TRIANGLE_LIST),this._passIndex=e.passIndex,this._propertyIndex=void 0!==e.propertyIndex?e.propertyIndex:e.passIndex,this._programName=e.program,this._defines=n?J({},e.defines):e.defines,this._shaderInfo=bm.getTemplate(e.program),this._properties=e.properties||this._properties;var i=this._device;t.fillPipelineInfo(this,e),e.stateOverrides&&t.fillPipelineInfo(this,e.stateOverrides),Mv.layout=bm.getDescriptorSetLayout(this._device,e.program),this._descriptorSet=this._device.createDescriptorSet(Mv),this._setState(this._bs,this._dss,this._rs,this._descriptorSet);for(var r=this._shaderInfo.blocks,o=bm.getTemplateInfo(e.program),a=o.blockSizes,s=o.handleMap,c=i.capabilities.uboOffsetAlignment,l=[],u=0,h=0,_=0;_<r.length;_++){var f=a[_];l.push(h),h+=Math.ceil(f/c)*c,u=f}var p=l[l.length-1]+u;p&&(Dv.size=16*Math.ceil(p/16),this._rootBuffer=i.createBuffer(Dv),this._rootBlock=new ArrayBuffer(p));for(var d=0,m=0;d<r.length;d++){var v=r[d].binding,g=a[d];Bv.buffer=this._rootBuffer,Bv.offset=l[m++],Bv.range=16*Math.ceil(g/16);var y=this._buffers[v]=i.createBuffer(Bv);this._blocks[v]=new Float32Array(this._rootBlock,Bv.offset,g/Float32Array.BYTES_PER_ELEMENT),this._blocksInt[v]=new Int32Array(this._blocks[v].buffer,this._blocks[v].byteOffset,this._blocks[v].length),this._descriptorSet.bindBuffer(v,y)}var x=this._propertyHandleMap=s,S={};for(var C in this._properties){var A=this._properties[C];A.handleInfo&&(S[C]=this.getHandle.apply(this,A.handleInfo))}Object.assign(x,S)},e._syncBatchingScheme=function(){this._defines.USE_INSTANCING?this._device.hasFeature(li.INSTANCED_ARRAYS)?this._setBatchingScheme(Av.INSTANCING):(this._defines.USE_INSTANCING=!1,this._setBatchingScheme(Av.NONE)):this._defines.USE_BATCHING?this._setBatchingScheme(Av.VB_MERGING):this._setBatchingScheme(Av.NONE)},e._setBatchingScheme=function(t){this._batchingScheme=t},e._setDynamicState=function(t){this._dynamicStates=t},e._setHash=function(t){this._hash=t},e._getBlockView=function(t,e){return t<_i.FLOAT?this._blocksInt[e]:this._blocks[e]},e._setPipelineLayout=function(t){this._pipelineLayout=t},e._initPassFromTarget=function(t,e,n,i){this._initNative(),this._setPriority(t.priority),this._setStage(t.stage),this._setPhase(t.phase),this._setBatchingScheme(t.batchingScheme),this._setPrimitive(t.primitive),this._setDynamicState(t.dynamicStates),this._setState(n,e,t.rasterizerState,t.descriptorSet),this._passIndex=t.passIndex,this._propertyIndex=t.propertyIndex,this._programName=t.program,this._defines=t.defines,this._shaderInfo=t._shaderInfo,this._properties=t._properties,this._blocks=t._blocks,this._blocksInt=t._blocksInt,this._dynamics=t._dynamics,this._shader=t._shader,this._setPipelineLayout(bm.getTemplateInfo(this._programName).pipelineLayout),this._setHash(t._hash^i)},K(t,[{key:"native",get:function(){return this._nativeObj}},{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"localSetLayout",get:function(){return bm.getDescriptorSetLayout(this._device,this._programName,!0)}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"blocksInt",get:function(){return this._blocksInt}},{key:"rootBufferDirty",get:function(){return this._rootBufferDirty}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"phase",get:function(){return this._phase}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"batchingScheme",get:function(){return this._batchingScheme}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"hash",get:function(){return this._hash}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}}]),t}();Ov.getTypeFromHandle=$d,Ov.getBindingFromHandle=tm,Ov.getCountFromHandle=em,Ov.getOffsetFromHandle=nm;var Nv=t("PipelineStateManager",function(){function t(){}return t.getOrCreatePipelineState=function(t,e,n,i,r){var o=e.hash^i.hash^r.attributesHash^n.typedID,a=this._PSOHashMap.get(o);if(!a){var s=e.pipelineLayout,c=new Ur(r.attributes),l=new bo(n,s,i,c,e.rasterizerState,e.depthStencilState,e.blendState,e.primitive,e.dynamicStates);a=t.createPipelineState(l),this._PSOHashMap.set(o,a)}return a},t}());Nv._PSOHashMap=new Map;var Lv=new rr,Fv=new Qi;function zv(t,e){t.x=e.x*e.x,t.y=e.y*e.y,t.z=e.z*e.z}var Gv,Vv,Uv,kv,Hv,jv,Wv,qv,Xv,Yv,Kv=null;function Jv(t,e,n,i,r){if(i&&i.enabled&&r===Kv){var o=i.subModels[0],a=o.inputAssembler,s=o.passes,c=o.shaders,l=o.descriptorSet;Lv.width=Fv.width=r.window.width,Lv.height=Fv.height=r.window.height;var u=Nv.getOrCreatePipelineState(t,s[0],c[0],e,a);n.setViewport(Lv),n.setScissor(Fv),n.bindPipelineState(u),n.bindDescriptorSet(kp.MATERIAL,s[0].descriptorSet),n.bindDescriptorSet(kp.LOCAL,l),n.bindInputAssembler(a),n.draw(a)}}var Qv,Zv,$v,tg,eg,ng=new Kn,ig=t("Material",(Gv=hc("cc.Material"),Vv=Wc(Tm),Gv((Yv=function(t){function e(){var e;return at(e=t.call(this)||this,"_effectAsset",Hv,it(e)),at(e,"_techIdx",jv,it(e)),at(e,"_defines",Wv,it(e)),at(e,"_states",qv,it(e)),at(e,"_props",Xv,it(e)),e._passes=[],e._hash=0,e}Q(e,t),e.getHash=function(t){for(var e,n=0,i=ot(t.passes);!(e=i()).done;)n^=e.value.hash;return n};var n=e.prototype;return n.initialize=function(t){this._passes.length?I(12005):(this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),this._fillInfo(t),this._update())},n.reset=function(t){this.initialize(t)},n.destroy=function(){return this._doDestroy(),t.prototype.destroy.call(this)},n.recompileShaders=function(){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.overridePipelineStates=function(){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.onLoaded=function(){this._update()},n.resetUniforms=function(t){void 0===t&&(t=!0),this._props.length=this._passes.length;for(var e=0;e<this._props.length;e++)this._props[e]={};if(t)for(var n,i=ot(this._passes);!(n=i()).done;){var r=n.value;r.resetUBOs(),r.resetTextures()}},n.setProperty=function(t,e,n){var i=!1;if(void 0===n)for(var r=this._passes,o=r.length,a=0;a<o;a++){var s=r[a];this._uploadProperty(s,t,e)&&(this._props[s.propertyIndex][t]=e,i=!0)}else{if(n>=this._passes.length)return void console.warn("illegal pass index: "+n+".");var c=this._passes[n];this._uploadProperty(c,t,e)&&(this._props[c.propertyIndex][t]=e,i=!0)}i||console.warn("illegal property name: "+t+".")},n.getProperty=function(t,e){if(void 0===e)for(var n=this._props,i=n.length,r=0;r<i;r++){var o=n[r];if(t in o)return o[t]}else{if(e>=this._props.length)return console.warn("illegal pass index: "+e+"."),null;var a=this._props[this._passes[e].propertyIndex];if(t in a)return a[t]}return null},n.copy=function(t,e){this._techIdx=t._techIdx,this._props.length=t._props.length;for(var n=0;n<t._props.length;n++)this._props[n]=J({},t._props[n]);this._defines.length=t._defines.length;for(var i=0;i<t._defines.length;i++)this._defines[i]=J({},t._defines[i]);this._states.length=t._states.length;for(var r=0;r<t._states.length;r++)this._states[r]=J({},t._states[r]);this._effectAsset=t._effectAsset,e&&this._fillInfo(e),this._update()},n._fillInfo=function(t){void 0!==t.technique&&(this._techIdx=t.technique),t.effectAsset?this._effectAsset=t.effectAsset:t.effectName&&(this._effectAsset=Tm.get(t.effectName)),t.defines&&this._prepareInfo(t.defines,this._defines),t.states&&this._prepareInfo(t.states,this._states)},n._prepareInfo=function(t,e){var n=t;if(!Array.isArray(n)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;n=Array(i).fill(n)}for(var r=0;r<n.length;++r)Object.assign(e[r]||(e[r]={}),n[r])},n._createPasses=function(){var t=this._effectAsset.techniques[this._techIdx||0];if(!t)return[];for(var e=t.passes.length,n=[],i=0;i<e;++i){var r=t.passes[i],o=r.passIndex=i,a=r.defines=this._defines[o]||(this._defines[o]={});if(r.stateOverrides=this._states[o]||(this._states[o]={}),void 0!==r.propertyIndex&&Object.assign(a,this._defines[r.propertyIndex]),void 0!==r.embeddedMacros&&Object.assign(a,r.embeddedMacros),!r.switch||a[r.switch]){var s=new Ov(c.director.root);s.initialize(r),n.push(s)}}return n},n._update=function(t){var n=this;if(void 0===t&&(t=!0),this._effectAsset){this._passes=this._createPasses();var i=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=i,t)this._passes.forEach((function(t,e){var i=n._props[e];for(var r in i||(i=n._props[e]={}),void 0!==t.propertyIndex&&Object.assign(i,n._props[t.propertyIndex]),i)n._uploadProperty(t,r,i[r])}));else for(var r=0;r<this._props.length;r++)this._props[r]={}}this._hash=e.getHash(this)},n._uploadProperty=function(t,e,n){var i=t.getHandle(e);if(!i)return!1;if(Ov.getTypeFromHandle(i)<_i.SAMPLER1D)if(Array.isArray(n))t.setUniformArray(i,n);else if(null!==n){var r;if(null===(r=t.properties[e])||void 0===r?void 0:r.linear){var o=n;zv(ng,o),ng.w=o.w,n=ng}t.setUniform(i,n)}else t.resetUniform(e);else if(Array.isArray(n))for(var a=0;a<n.length;a++)this._bindTexture(t,i,n[a],a);else n?this._bindTexture(t,i,n):t.resetTexture(e);return!0},n._bindTexture=function(t,e,n,i){var r=Ov.getBindingFromHandle(e);if(n instanceof Ro)t.bindTexture(r,n,i);else if(n instanceof Xm){var o=n.getGFXTexture();if(!o||!o.width||!o.height)return;t.bindTexture(r,o,i),t.bindSampler(r,n.getGFXSampler(),i)}},n._doDestroy=function(){if(this._passes&&this._passes.length)for(var t,e=ot(this._passes);!(t=e()).done;)t.value.destroy();this._passes.length=0},n.initDefault=function(e){t.prototype.initDefault.call(this,e),this.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),this.setProperty("mainColor",new bn("#ff00ff"))},n.validate=function(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0},K(e,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}]),e}(Pu),Hv=st((kv=Yv).prototype,"_effectAsset",[Vv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jv=st(kv.prototype,"_techIdx",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Wv=st(kv.prototype,"_defines",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),qv=st(kv.prototype,"_states",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Xv=st(kv.prototype,"_props",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Uv=kv))||Uv));c.Material=ig,function(t){t[t.VERTICAL=0]="VERTICAL",t[t.HORIZONTAL=1]="HORIZONTAL"}(Qv||(Qv={})),function(t){t[t.ORTHO=0]="ORTHO",t[t.PERSPECTIVE=1]="PERSPECTIVE"}(Zv||(Zv={})),function(t){t[t.F1_8=0]="F1_8",t[t.F2_0=1]="F2_0",t[t.F2_2=2]="F2_2",t[t.F2_5=3]="F2_5",t[t.F2_8=4]="F2_8",t[t.F3_2=5]="F3_2",t[t.F3_5=6]="F3_5",t[t.F4_0=7]="F4_0",t[t.F4_5=8]="F4_5",t[t.F5_0=9]="F5_0",t[t.F5_6=10]="F5_6",t[t.F6_3=11]="F6_3",t[t.F7_1=12]="F7_1",t[t.F8_0=13]="F8_0",t[t.F9_0=14]="F9_0",t[t.F10_0=15]="F10_0",t[t.F11_0=16]="F11_0",t[t.F13_0=17]="F13_0",t[t.F14_0=18]="F14_0",t[t.F16_0=19]="F16_0",t[t.F18_0=20]="F18_0",t[t.F20_0=21]="F20_0",t[t.F22_0=22]="F22_0"}($v||($v={})),function(t){t[t.ISO100=0]="ISO100",t[t.ISO200=1]="ISO200",t[t.ISO400=2]="ISO400",t[t.ISO800=3]="ISO800"}(tg||(tg={})),function(t){t[t.D1=0]="D1",t[t.D2=1]="D2",t[t.D4=2]="D4",t[t.D8=3]="D8",t[t.D15=4]="D15",t[t.D30=5]="D30",t[t.D60=6]="D60",t[t.D125=7]="D125",t[t.D250=8]="D250",t[t.D500=9]="D500",t[t.D1000=10]="D1000",t[t.D2000=11]="D2000",t[t.D4000=12]="D4000"}(eg||(eg={}));var rg=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],og=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],ag=[100,200,400,800],sg=new En,cg=new En,lg=new Un,ug=Wi.STENCIL<<1,hg=[],_g=function(){function t(t){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=Qv.VERTICAL,this._fov=cn(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new or(.2,.2,.2,1),this._viewport=new ti(0,0,1,1),this._orientedViewport=new ti(0,0,1,1),this._curTransform=ci.IDENTITY,this._isProjDirty=!0,this._matView=new Un,this._matProj=new Un,this._matProjInv=new Un,this._matViewProj=new Un,this._matViewProjInv=new Un,this._frustum=new tc,this._forward=new En,this._position=new En,this._priority=0,this._aperture=$v.F16_0,this._apertureValue=void 0,this._shutter=eg.D125,this._shutterValue=0,this._iso=tg.ISO100,this._isoValue=0,this._ec=0,this._window=null,this._width=1,this._height=1,this._clearFlag=Wi.NONE,this._clearDepth=1,this._visibility=Wd,this._exposure=0,this._clearStencil=0,this._device=t,this._apertureValue=rg[this._aperture],this._shutterValue=og[this._shutter],this._isoValue=ag[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,!hg.length){var e=t.capabilities.clipSpaceSignY;hg[ci.IDENTITY]=new Un(1,0,0,0,0,e),hg[ci.ROTATE_90]=new Un(0,1,0,0,-e,0),hg[ci.ROTATE_180]=new Un(-1,0,0,0,0,-e),hg[ci.ROTATE_270]=new Un(0,-1,0,0,e,0)}}var e=t.prototype;return e._setWidth=function(t){this._width=t},e._setHeight=function(t){this._height=t},e._setScene=function(t){this._scene=t},e._updateAspect=function(t){if(void 0===t&&(t=!0),this._aspect=this.window.width*this._viewport.width/(this.window.height*this._viewport.height),t){var e=this.window.swapchain;(e&&e.surfaceTransform||ci.IDENTITY)%2&&(this._aspect=1/this._aspect)}this._isProjDirty=!0},e._init=function(){},e.initialize=function(t){this._init(t),this.node=t.node,this._setWidth(1),this._setHeight(1),this.clearFlag=Wi.NONE,this.clearDepth=1,this.visibility=Wd,this._name=t.name,this._proj=t.projection,this._priority=t.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(t.window)},e._destroy=function(){},e.destroy=function(){this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,this._destroy()},e.attachToScene=function(t){this._enabled=!0,this._setScene(t)},e.detachFromScene=function(){this._enabled=!1,this._setScene(null)},e.resize=function(t,e){this._window&&(this._setWidth(t),this._setHeight(e),this._updateAspect())},e.setFixedSize=function(t,e){this._setWidth(t),this._setHeight(e),this._updateAspect(!1),this.isWindowSize=!1},e.syncCameraEditor=function(){},e.update=function(t){var e;if(void 0===t&&(t=!1),this._node){var n=!1;(this._node.hasChangedFlags||t)&&(Un.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),n=!0);var i=null===(e=this.window)||void 0===e?void 0:e.swapchain,r=i&&i.surfaceTransform||ci.IDENTITY;if(this._isProjDirty||this._curTransform!==r){this._curTransform=r;var o=this._device.capabilities.clipSpaceSignY;if(this._proj===Zv.PERSPECTIVE)Un.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===Qv.VERTICAL,this._device.capabilities.clipSpaceMinZ,o,r);else{var a=this._orthoHeight*this._aspect,s=this._orthoHeight;Un.ortho(this._matProj,-a,a,-s,s,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,o,r)}Un.invert(this._matProjInv,this._matProj),n=!0,this._isProjDirty=!1}n&&(Un.multiply(this._matViewProj,this._matProj,this._matView),Un.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv))}},e.setViewportInOrientedSpace=function(t){var e,n=t.x,i=t.width,r=t.height,o=this._device.capabilities.screenSpaceSignY<0?1-t.y-r:t.y,a=null===(e=this.window)||void 0===e?void 0:e.swapchain;switch(a&&a.surfaceTransform||ci.IDENTITY){case ci.ROTATE_90:this._viewport.x=1-o-r,this._viewport.y=n,this._viewport.width=r,this._viewport.height=i;break;case ci.ROTATE_180:this._viewport.x=1-n-i,this._viewport.y=1-o-r,this._viewport.width=i,this._viewport.height=r;break;case ci.ROTATE_270:this._viewport.x=o,this._viewport.y=1-n-i,this._viewport.width=r,this._viewport.height=i;break;case ci.IDENTITY:this._viewport.x=n,this._viewport.y=o,this._viewport.width=i,this._viewport.height=r}this._orientedViewport.x=n,this._orientedViewport.y=o,this._orientedViewport.width=i,this._orientedViewport.height=r,this.resize(this.width,this.height)},e.changeTargetWindow=function(t){void 0===t&&(t=null),this._window&&this._window.detachCamera(this);var e=t||c.director.root.mainWindow;if(e){e.attachCamera(this),this.window=e;var n=e.swapchain;(n&&n.surfaceTransform||ci.IDENTITY)%2?this.resize(e.height,e.width):this.resize(e.width,e.height)}},e.detachCamera=function(){this._window&&this._window.detachCamera(this)},e.screenPointToRay=function(t,e,n){if(!this._node)return null;var i=this.width,r=this.height,o=this._orientedViewport.x*i,a=this._orientedViewport.y*r,s=this._orientedViewport.width*i,c=this._orientedViewport.height*r,l=this._proj===Zv.PERSPECTIVE,u=this._device.capabilities.clipSpaceSignY,h=Vn[this._curTransform];En.set(sg,(e-o)/s*2-1,(n-a)/c*2-1,l?1:-1);var _=sg.x,f=sg.y;return sg.x=_*h[0]+f*h[2]*u,sg.y=_*h[1]+f*h[3]*u,En.transformMat4(l?sg:t.o,sg,this._matViewProjInv),l?(this._node.getWorldPosition(cg),Qo.fromPoints(t,cg,sg)):En.transformQuat(t.d,En.FORWARD,this._node.worldRotation),t},e.screenToWorld=function(t,e){var n=this.width,i=this.height,r=this._orientedViewport.x*n,o=this._orientedViewport.y*i,a=this._orientedViewport.width*n,s=this._orientedViewport.height*i,c=this._device.capabilities.clipSpaceSignY,l=Vn[this._curTransform];if(this._proj===Zv.PERSPECTIVE){En.set(t,(e.x-r)/a*2-1,(e.y-o)/s*2-1,1);var u=t.x,h=t.y;t.x=u*l[0]+h*l[2]*c,t.y=u*l[1]+h*l[3]*c,En.transformMat4(t,t,this._matViewProjInv),this._node&&this._node.getWorldPosition(sg),En.lerp(t,sg,t,sn(this._nearClip/this._farClip,1,e.z))}else{En.set(t,(e.x-r)/a*2-1,(e.y-o)/s*2-1,2*e.z-1);var _=t.x,f=t.y;t.x=_*l[0]+f*l[2]*c,t.y=_*l[1]+f*l[3]*c,En.transformMat4(t,t,this._matViewProjInv)}return t},e.worldToScreen=function(t,e){var n=this._device.capabilities.clipSpaceSignY,i=Vn[this._curTransform];En.transformMat4(t,e,this._matViewProj);var r=t.x,o=t.y;t.x=r*i[0]+o*i[2]*n,t.y=r*i[1]+o*i[3]*n;var a=this.width,s=this.height,c=this._orientedViewport.x*a,l=this._orientedViewport.y*s,u=this._orientedViewport.width*a,h=this._orientedViewport.height*s;return t.x=c+.5*(t.x+1)*u,t.y=l+.5*(t.y+1)*h,t.z=.5*t.z+.5,t},e.worldMatrixToScreen=function(t,e,n,i){Un.multiply(t,this._matViewProj,e),Un.multiply(t,hg[this._curTransform],t);var r=n/2,o=i/2;return Un.identity(lg),Un.transform(lg,lg,En.set(sg,r,o,0)),Un.scale(lg,lg,En.set(sg,r,o,1)),Un.multiply(t,lg,t),t},e.setExposure=function(t){this._exposure=.833333/Math.pow(2,t)},e.updateExposure=function(){var t=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(t)},K(t,[{key:"node",get:function(){return this._node},set:function(t){this._node=t}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(t){this._orthoHeight=t,this._isProjDirty=!0}},{key:"projectionType",get:function(){return this._proj},set:function(t){this._proj=t,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(t){this._fovAxis=t,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(t){this._fov=t,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(t){this._nearClip=t,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(t){this._farClip=t,this._isProjDirty=!0}},{key:"clearColor",get:function(){return this._clearColor},set:function(t){this._clearColor.x=t.x,this._clearColor.y=t.y,this._clearColor.z=t.z,this._clearColor.w=t.w}},{key:"viewport",get:function(){return this._viewport},set:function(t){I(8302),this.setViewportInOrientedSpace(t)}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"frustum",get:function(){return this._frustum},set:function(t){this._frustum=t}},{key:"window",get:function(){return this._window},set:function(t){this._window=t}},{key:"forward",get:function(){return this._forward},set:function(t){this._forward=t}},{key:"position",get:function(){return this._position},set:function(t){this._position=t}},{key:"visibility",get:function(){return this._visibility},set:function(t){this._visibility=t}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t}},{key:"aperture",get:function(){return this._aperture},set:function(t){this._aperture=t,this._apertureValue=rg[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(t){this._shutter=t,this._shutterValue=og[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(t){this._iso=t,this._isoValue=ag[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",get:function(){return this._ec},set:function(t){this._ec=t}},{key:"exposure",get:function(){return this._exposure}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(t){this._clearFlag=t}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(t){this._clearDepth=t}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(t){this._clearStencil=t}},{key:"native",get:function(){return this._nativeObj}}],[{key:"standardExposureValue",get:function(){return 1/38400}},{key:"standardLightMeterScale",get:function(){return 1e4}}]),t}(),fg=ie({Low_256x256:256,Medium_512x512:512,High_1024x1024:1024,Ultra_2048x2048:2048}),pg=ie({Planar:0,ShadowMap:1}),dg=ie({HARD:0,SOFT:1,SOFT_2X:2}),mg=pg.ShadowMap+1,vg=function(){function t(){this.fixedSphere=new ra(0,0,0,.01),this.maxReceived=4,this.firstSetCSM=!1,this.shadowCameraFar=0,this.matShadowView=new Un,this.matShadowProj=new Un,this.matShadowViewProj=new Un,this._normal=new En(0,1,0),this._shadowColor=new bn(0,0,0,76),this._matLight=new Un,this._material=null,this._instancingMaterial=null,this._size=new Wn(512,512),this._enabled=!1,this._distance=0,this._type=mg,this._near=.1,this._far=10,this._invisibleOcclusionRange=200,this._shadowDistance=100,this._orthoSize=1,this._pcf=0,this._shadowMapDirty=!1,this._bias=0,this._normalBias=0,this._fixedArea=!1,this._saturation=.75}var e=t.prototype;return e.getPlanarShader=function(t){return this._material||(this._material=new ig,this._material.initialize({effectName:"planar-shadow"})),this._material.passes[0].getShaderVariant(t)},e.getPlanarInstanceShader=function(t){return this._instancingMaterial||(this._instancingMaterial=new ig,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}})),this._instancingMaterial.passes[0].getShaderVariant(t)},e._setEnable=function(t){this._enabled=t},e._setType=function(t){this._type=this.enabled?t:mg},e.initialize=function(t){this.near=t.near,this.far=t.far,this.invisibleOcclusionRange=t.invisibleOcclusionRange,this.shadowDistance=t.shadowDistance,this.orthoSize=t.orthoSize,this.size=t.size,this.pcf=t.pcf,this.normal=t.normal,this.distance=t.distance,this.shadowColor=t.shadowColor,this.bias=t.bias,this.normalBias=t.normalBias,this.maxReceived=t.maxReceived,this.fixedArea=t.fixedArea,this._setEnable(t.enabled),this._setType(t.type),this.saturation=t.saturation},e.activate=function(){this.enabled&&this.type===pg.Planar&&this._updatePlanarInfo()},e._updatePlanarInfo=function(){this._material||(this._material=new ig,this._material.initialize({effectName:"planar-shadow"})),this._instancingMaterial||(this._instancingMaterial=new ig,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}))},e._destroy=function(){},e.destroy=function(){this._destroy(),this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this.fixedSphere.destroy()},K(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._setEnable(t),this.activate()}},{key:"normal",get:function(){return this._normal},set:function(t){En.copy(this._normal,t)}},{key:"distance",get:function(){return this._distance},set:function(t){this._distance=t}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(t){this._shadowColor=t}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(t){this._invisibleOcclusionRange=t}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(t){this._shadowDistance=t}},{key:"type",get:function(){return this._type},set:function(t){this._setType(t),this.activate()}},{key:"near",get:function(){return this._near},set:function(t){this._near=t}},{key:"far",get:function(){return this._far},set:function(t){this._far=t}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(t){this._orthoSize=t}},{key:"size",get:function(){return this._size},set:function(t){this._size.set(t)}},{key:"pcf",get:function(){return this._pcf},set:function(t){this._pcf=t}},{key:"shadowMapDirty",get:function(){return this._shadowMapDirty},set:function(t){this._shadowMapDirty=t}},{key:"bias",get:function(){return this._bias},set:function(t){this._bias=t}},{key:"normalBias",get:function(){return this._normalBias},set:function(t){this._normalBias=t}},{key:"saturation",get:function(){return this._saturation},set:function(t){this._saturation=t}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(t){this._fixedArea=t}},{key:"matLight",get:function(){return this._matLight}},{key:"material",get:function(){return this._material}},{key:"instancingMaterial",get:function(){return this._instancingMaterial}},{key:"native",get:function(){return this._nativeObj}}]),t}();vg.MAX_FAR=2e3,vg.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),c.Shadows=vg;var gg=new En,yg=(new En,new En,new En),xg=new Un,Sg=new ks,Cg=new ks,Ag=!1,bg=ra.create(0,0,0,1),Tg=new ra,Eg=new tc;Eg.accurate=!0;var wg=new tc;wg.accurate=!0;var Pg=new tc,Ig=new Un,Rg=new Un,Dg=new Un,Bg=new Un,Mg=new Un,Og=new Un,Ng=new Un,Lg=new En,Fg=new Wn,zg=new En,Gg=new En,Vg=new En(0,0,0),Ug=(new ks,new Vl((function(){return{model:null,depth:0}}),128)),kg=new Vl((function(){return{model:null,depth:0}}),128),Hg=new Vl((function(){return{model:null,depth:0}}),128);function jg(t,e){var n=0;t.node&&(En.subtract(gg,t.node.worldPosition,e.position),n=En.dot(gg,e.forward));var i=Ug.alloc();return i.model=t,i.depth=n,i}function Wg(t,e){var n=0;t.node&&(En.subtract(gg,t.node.worldPosition,e.position),n=En.dot(gg,e.forward));var i=kg.alloc();return i.model=t,i.depth=n,i}function qg(t,e){var n=0;t.node&&(En.subtract(gg,t.node.worldPosition,e.position),n=En.dot(gg,e.forward));var i=Hg.alloc();return i.model=t,i.depth=n,i}function Xg(t,e,n){var i=e.direction,r=t.normal,o=t.distance+.001,a=1/En.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,_=r.z,f=t.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*o,f.m13=c*o,f.m14=l*o,f.m15=1,Un.toArray(n,f,Yp.MAT_LIGHT_PLANE_PROJ_OFFSET)}function Yg(t,e){En.normalize(gg,t.normal),e[Yp.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+0]=gg.x,e[Yp.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+1]=gg.y,e[Yp.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+2]=gg.z,e[Yp.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+3]=t.distance}function Kg(t,e){var n=t.pipelineSceneData.validPunctualLights;n.length=0;for(var i=e.scene.spotLights,r=0;r<i.length;r++){var o=i[r];o.baked||(ra.set(bg,o.position.x,o.position.y,o.position.z,o.range),cs.sphereFrustum(bg,e.frustum)&&n.push(o))}for(var a=e.scene.sphereLights,s=0;s<a.length;s++){var c=a[s];c.baked||(ra.set(bg,c.position.x,c.position.y,c.position.z,c.range),cs.sphereFrustum(bg,e.frustum)&&n.push(c))}}function Jg(t,e){var n=e.scene,i=n.mainLight,r=t.pipelineSceneData,o=r.shadows,a=r.skybox,s=r.renderObjects;Ug.freeArray(s),s.length=0;var c=r.castShadowObjects;Hg.freeArray(c),c.length=0,Ag=!1;var l=null;if(o.enabled&&(t.pipelineUBO.updateShadowUBORange(Yp.SHADOW_COLOR_OFFSET,o.shadowColor),o.type===pg.ShadowMap))if(l=t.pipelineSceneData.dirShadowObjects,kg.freeArray(l),l.length=0,i&&i.node)!function(t,e,n,i,r){var o=e.device;if(r.fixedArea){var a=r.orthoSize,s=r.orthoSize,c=r.near,l=r.far;Un.fromRT(Ig,n.node.getWorldRotation(),n.node.getWorldPosition()),Un.invert(Rg,Ig),Un.ortho(Bg,-a,a,-s,s,c,l,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),Un.multiply(Mg,Bg,Rg),Un.invert(Dg,Rg),r.matShadowView=Rg,r.matShadowProj=Bg,r.matShadowViewProj=Mg,tc.createOrtho(t,2*a,2*s,c,l,Dg)}else{var u=r.invisibleOcclusionRange,h=r.size.x;!function(t,e){if(e.node){var n=e.node,i=n.getWorldPosition(),r=n.getWorldRotation();Un.fromRT(t,r,i),t.m08*=-1,t.m09*=-1,t.m10*=-1}}(xg,i),tc.split(Eg,i,xg,.1,r.shadowDistance),wg=tc.clone(Eg),Un.fromRT(Ig,n.node.rotation,Vg),Un.invert(Rg,Ig),Un.invert(Dg,Rg);var _=Rg.clone();wg.transform(Rg),ks.fromPoints(Sg,new En(1e7,1e7,1e7),new En(-1e7,-1e7,-1e7)),Sg.mergeFrustum(wg);var f=2*Sg.halfExtents.z;yg.set(Sg.center.x,Sg.center.y,Sg.center.z+Sg.halfExtents.z+u),En.transformMat4(yg,yg,Dg),Un.fromRT(Ig,n.node.rotation,yg),Un.invert(Rg,Ig),Un.invert(Dg,Rg);var p=En.distance(Eg.vertices[0],Eg.vertices[6]);Tg.center.set(0,0,0),Tg.radius=-1,Tg.mergePoints(Eg.vertices);var d=.8*p+.4*Tg.radius;r.shadowCameraFar=f+u;var m=.5*d;if(Un.ortho(Bg,-m,m,-m,m,.1,r.shadowCameraFar,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),h>0){Un.multiply(Og,Bg,_),En.transformMat4(Lg,yg,Og);var v=2/h;Fg.set(v,v);var g=Lg.x%Fg.x,y=Lg.y%Fg.y;zg.set(Lg.x-g,Lg.y-y,Lg.z),Un.invert(Ng,Og),En.transformMat4(Gg,zg,Ng),Un.fromRT(Ig,n.node.rotation,Gg),Un.invert(Rg,Ig),Un.invert(Dg,Rg),tc.createOrtho(t,d,d,.1,r.shadowCameraFar,Dg)}else{for(var x=0;x<8;x++)t.vertices[x].set(0,0,0);t.updatePlanes()}Un.multiply(Mg,Bg,Rg),r.matShadowView=Rg,r.matShadowProj=Bg,r.matShadowViewProj=Mg}}(Pg,t,i,e,o);else{for(var u=0;u<8;u++)Pg.vertices[u].set(0,0,0);Pg.updatePlanes()}i&&o.type===pg.Planar&&function(t,e){var n=t.pipelineSceneData.shadows,i=e.direction,r=n.normal,o=n.distance+.001,a=1/En.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,_=r.z,f=n.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*o,f.m13=c*o,f.m14=l*o,f.m15=1,t.pipelineUBO.updateShadowUBORange(Yp.MAT_LIGHT_PLANE_PROJ_OFFSET,n.matLight)}(t,i),a.enabled&&a.model&&e.clearFlag&ug&&s.push(jg(a.model,e));for(var h=n.models,_=e.visibility,f=0;f<h.length;f++){var p=h[f];if(p.enabled&&(p.castShadow&&c.push(qg(p,e)),o.firstSetCSM&&p.worldBounds&&(Ag||(Cg.copy(p.worldBounds),Ag=!0),ks.merge(Cg,Cg,p.worldBounds)),p.node&&(_&p.node.layer)===p.node.layer||_&p.visFlags)){if(null!=l&&p.castShadow&&p.worldBounds&&cs.aabbFrustum(p.worldBounds,Pg)&&l.push(Wg(p,e)),p.worldBounds&&!cs.aabbFrustum(p.worldBounds,e.frustum))continue;s.push(jg(p,e))}}o.firstSetCSM&&(o.shadowDistance=2*Cg.halfExtents.length(),o.firstSetCSM=!1)}var Qg,Zg,$g,ty=new mr(Ci.LINEAR,Ci.LINEAR,Ci.NONE,Ai.CLAMP,Ai.CLAMP,Ai.CLAMP),ey=new mr(Ci.POINT,Ci.POINT,Ci.NONE,Ai.CLAMP,Ai.CLAMP,Ai.CLAMP),ny=function(){function t(t){this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=t.device,this._linearSampler=this._device.getSampler(ty),this._pointSampler=this._device.getSampler(ey);var e=new zr(Fp.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(e),this._globalDescriptorSet=this._device.createDescriptorSet(new Gr(this._descriptorSetLayout))}var e=t.prototype;return e.bindBuffer=function(t,e){this._globalDescriptorSet.bindBuffer(t,e);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindBuffer(t,e),i=n.next()},e.bindSampler=function(t,e){this._globalDescriptorSet.bindSampler(t,e);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindSampler(t,e),i=n.next()},e.bindTexture=function(t,e){this._globalDescriptorSet.bindTexture(t,e);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindTexture(t,e),i=n.next()},e.update=function(){this._globalDescriptorSet.update();for(var t=this._descriptorSetMap.values(),e=t.next();!e.done;)e.value.update(),e=t.next()},e.getOrCreateDescriptorSet=function(t){var e=this._device;if(!this._descriptorSetMap.has(t)){var n=this._globalDescriptorSet,i=e.createDescriptorSet(new Gr(this._descriptorSetLayout));this._descriptorSetMap.set(t,i);for(var r=Lp.UBO_GLOBAL;r<Lp.COUNT;r++)i.bindBuffer(r,n.getBuffer(r)),i.bindSampler(r,n.getSampler(r)),i.bindTexture(r,n.getTexture(r));var o=e.createBuffer(new lr(fi.UNIFORM|fi.TRANSFER_DST,mi.HOST|mi.DEVICE,Yp.SIZE,Yp.SIZE));i.bindBuffer(Yp.BINDING,o),i.update()}return this._descriptorSetMap.get(t)},e.destroy=function(){this._descriptorSetLayout.destroy()},K(t,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet}}]),t}();function iy(t,e){e<1e3?e=1e3:e>15e3&&(e=15e3);var n=e*e,i=(.860117757+.000154118254*e+1.28641212e-7*n)/(1+.000842420235*e+7.08145163e-7*n),r=(.317398726+422806245e-13*e+4.20481691e-8*n)/(1-289741816e-13*e+1.61456053e-7*n),o=2*i-8*r+4,a=3*i/o,s=2*r/o,c=1/s*a,l=1/s*(1-a-s);t.x=3.2404542*c-1.5371385+-.4985314*l,t.y=-.969266*c+1.8760108+.041556*l,t.z=.0556434*c-.2040259+1.0572252*l}!function(t){t[t.LOCAL=0]="LOCAL",t[t.WORLD=1]="WORLD"}(Qg||(Qg={})),function(t){t[t.NONE=0]="NONE",t[t.POSITION=1]="POSITION",t[t.ROTATION=2]="ROTATION",t[t.SCALE=4]="SCALE",t[t.RS=t.ROTATION|t.SCALE]="RS",t[t.TRS=t.POSITION|t.ROTATION|t.SCALE]="TRS",t[t.TRS_MASK=~t.TRS]="TRS_MASK"}(Zg||(Zg={})),c.internal.TransformBit=Zg,function(t){t[t.DIRECTIONAL=0]="DIRECTIONAL",t[t.SPHERE=1]="SPHERE",t[t.SPOT=2]="SPOT",t[t.UNKNOWN=3]="UNKNOWN"}($g||($g={}));var ry,oy,ay,sy,cy,ly,uy,hy,_y,fy,py=function(t){return 4*Math.PI*Math.PI*t*t},dy=function(){function t(){this._baked=!1,this._color=new En(1,1,1),this._colorTemp=6550,this._colorTempRGB=new En(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=$g.UNKNOWN}var e=t.prototype;return e._init=function(){},e._destroy=function(){},e.initialize=function(){this._init(),this.color=new En(1,1,1),this.colorTemperature=6550},e.attachToScene=function(t){this._scene=t},e.detachFromScene=function(){this._scene=null},e.destroy=function(){this._name=null,this._node=null,this._destroy()},e.update=function(){},K(t,[{key:"baked",get:function(){return this._baked},set:function(t){this._baked=t}},{key:"color",get:function(){return this._color},set:function(t){this._color.set(t)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(t){this._useColorTemperature=t}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(t){this._colorTemp=t,iy(this._colorTempRGB,this._colorTemp)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",get:function(){return this._node},set:function(t){this._node=t,this._node&&(this._node.hasChangedFlags|=Zg.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(t){this._name=t}},{key:"scene",get:function(){return this._scene}},{key:"native",get:function(){return this._nativeObj}}]),t}(),my=new Un,vy=new Un,gy=new Un,yy=new Kn,xy=new Kn(0,0,1,0),Sy=function(){function t(){this._globalUBO=new Float32Array(qp.COUNT),this._cameraUBO=new Float32Array(Xp.COUNT),this._shadowUBO=new Float32Array(Yp.COUNT)}t.updateGlobalUBOView=function(t,e){var n=c.director.root,i=e,r=Math.floor(t.width),o=Math.floor(t.height);i[qp.TIME_OFFSET]=n.cumulativeTime,i[qp.TIME_OFFSET+1]=n.frameTime,i[qp.TIME_OFFSET+2]=c.director.getTotalFrames(),i[qp.SCREEN_SIZE_OFFSET]=r,i[qp.SCREEN_SIZE_OFFSET+1]=o,i[qp.SCREEN_SIZE_OFFSET+2]=1/r,i[qp.SCREEN_SIZE_OFFSET+3]=1/o,i[qp.NATIVE_SIZE_OFFSET]=r,i[qp.NATIVE_SIZE_OFFSET+1]=o,i[qp.NATIVE_SIZE_OFFSET+2]=1/i[qp.NATIVE_SIZE_OFFSET],i[qp.NATIVE_SIZE_OFFSET+3]=1/i[qp.NATIVE_SIZE_OFFSET+1]},t.updateCameraUBOView=function(t,e,n){var i=(n.scene?n.scene:c.director.getScene().renderScene).mainLight,r=t.pipelineSceneData,o=r.ambient,a=r.fog,s=r.shadows,l=e,u=n.exposure,h=r.isHDR;if(l[Xp.SCREEN_SCALE_OFFSET]=r.shadingScale,l[Xp.SCREEN_SCALE_OFFSET+1]=r.shadingScale,l[Xp.SCREEN_SCALE_OFFSET+2]=1/l[Xp.SCREEN_SCALE_OFFSET],l[Xp.SCREEN_SCALE_OFFSET+3]=1/l[Xp.SCREEN_SCALE_OFFSET+1],l[Xp.EXPOSURE_OFFSET]=u,l[Xp.EXPOSURE_OFFSET+1]=1/u,l[Xp.EXPOSURE_OFFSET+2]=h?1:0,l[Xp.EXPOSURE_OFFSET+3]=0,i){var _=s.enabled&&s.type===pg.ShadowMap?1:0,f=i.direction;if(xy.set(f.x,f.y,f.z,_),Kn.toArray(l,xy,Xp.MAIN_LIT_DIR_OFFSET),En.toArray(l,i.color,Xp.MAIN_LIT_COLOR_OFFSET),i.useColorTemperature){var p=i.colorTemperatureRGB;l[Xp.MAIN_LIT_COLOR_OFFSET]*=p.x,l[Xp.MAIN_LIT_COLOR_OFFSET+1]*=p.y,l[Xp.MAIN_LIT_COLOR_OFFSET+2]*=p.z}l[Xp.MAIN_LIT_COLOR_OFFSET+3]=h?i.illuminance*u:i.illuminance}else xy.set(0,0,1,0),Kn.toArray(l,xy,Xp.MAIN_LIT_DIR_OFFSET),Kn.toArray(l,Kn.ZERO,Xp.MAIN_LIT_COLOR_OFFSET);var d=o.skyColor;d.w=h?o.skyIllum*u:o.skyIllum,l[Xp.AMBIENT_SKY_OFFSET+0]=d.x,l[Xp.AMBIENT_SKY_OFFSET+1]=d.y,l[Xp.AMBIENT_SKY_OFFSET+2]=d.z,l[Xp.AMBIENT_SKY_OFFSET+3]=d.w,l[Xp.AMBIENT_GROUND_OFFSET+0]=o.groundAlbedo.x,l[Xp.AMBIENT_GROUND_OFFSET+1]=o.groundAlbedo.y,l[Xp.AMBIENT_GROUND_OFFSET+2]=o.groundAlbedo.z,l[Xp.AMBIENT_GROUND_OFFSET+3]=o.mipmapCount,Un.toArray(l,n.matView,Xp.MAT_VIEW_OFFSET),Un.toArray(l,n.node.worldMatrix,Xp.MAT_VIEW_INV_OFFSET),En.toArray(l,n.position,Xp.CAMERA_POS_OFFSET),Un.toArray(l,n.matProj,Xp.MAT_PROJ_OFFSET),Un.toArray(l,n.matProjInv,Xp.MAT_PROJ_INV_OFFSET),Un.toArray(l,n.matViewProj,Xp.MAT_VIEW_PROJ_OFFSET),Un.toArray(l,n.matViewProjInv,Xp.MAT_VIEW_PROJ_INV_OFFSET),l[Xp.CAMERA_POS_OFFSET+3]=this.getCombineSignY();var m=a.colorArray;l[Xp.GLOBAL_FOG_COLOR_OFFSET]=m.x,l[Xp.GLOBAL_FOG_COLOR_OFFSET+1]=m.y,l[Xp.GLOBAL_FOG_COLOR_OFFSET+2]=m.z,l[Xp.GLOBAL_FOG_COLOR_OFFSET+3]=m.z,l[Xp.GLOBAL_FOG_BASE_OFFSET]=a.fogStart,l[Xp.GLOBAL_FOG_BASE_OFFSET+1]=a.fogEnd,l[Xp.GLOBAL_FOG_BASE_OFFSET+2]=a.fogDensity,l[Xp.GLOBAL_FOG_ADD_OFFSET]=a.fogTop,l[Xp.GLOBAL_FOG_ADD_OFFSET+1]=a.fogRange,l[Xp.GLOBAL_FOG_ADD_OFFSET+2]=a.fogAtten,l[Xp.NEAR_FAR_OFFSET]=n.nearClip,l[Xp.NEAR_FAR_OFFSET+1]=n.farClip,l[Xp.VIEW_PORT_OFFSET]=r.shadingScale*n.window.width*n.viewport.x,l[Xp.VIEW_PORT_OFFSET+1]=r.shadingScale*n.window.height*n.viewport.y,l[Xp.VIEW_PORT_OFFSET+2]=r.shadingScale*n.window.width*n.viewport.z,l[Xp.VIEW_PORT_OFFSET+3]=r.shadingScale*n.window.height*n.viewport.w},t.updateShadowUBOView=function(t,e,n){var i=t.device,r=n.scene.mainLight,o=t.pipelineSceneData.shadows,a=e;if(o.enabled){if(r&&o.type===pg.ShadowMap){var s=.1,c=0,l=o.matShadowView,u=o.matShadowProj,h=o.matShadowViewProj;o.fixedArea?(s=o.near,c=o.far):(s=.1,c=o.shadowCameraFar),Un.toArray(e,l,Yp.MAT_LIGHT_VIEW_OFFSET),a[Yp.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,a[Yp.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,a[Yp.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,a[Yp.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,a[Yp.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,a[Yp.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,a[Yp.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,a[Yp.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,Un.toArray(e,h,Yp.MAT_LIGHT_VIEW_PROJ_OFFSET);var _=Yd(i)?0:1;a[Yp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=s,a[Yp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=c,a[Yp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,a[Yp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-o.saturation,a[Yp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=o.size.x,a[Yp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=o.size.y,a[Yp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=o.pcf,a[Yp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=o.bias,a[Yp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=0,a[Yp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=_,a[Yp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=o.normalBias,a[Yp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0}else r&&o.type===pg.Planar&&(Xg(o,r,a),Yg(o,a));bn.toArray(a,o.shadowColor,Yp.SHADOW_COLOR_OFFSET)}},t.updateShadowUBOLightView=function(t,e,n){var i=t.device,r=t.pipelineSceneData.shadows,o=e,a=Yd(i)?0:1,s=.1,c=0,l=r.matShadowView,u=r.matShadowProj,h=r.matShadowViewProj;switch(n.type){case $g.DIRECTIONAL:r.fixedArea?(s=r.near,c=r.far):(s=.1,c=r.shadowCameraFar),Un.toArray(e,l,Yp.MAT_LIGHT_VIEW_OFFSET),o[Yp.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,o[Yp.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,o[Yp.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,o[Yp.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,o[Yp.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,o[Yp.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,o[Yp.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,o[Yp.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,Un.toArray(e,h,Yp.MAT_LIGHT_VIEW_PROJ_OFFSET),yy.set(s,c,0,1-r.saturation),Kn.toArray(o,yy,Yp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),yy.set(0,a,r.normalBias,0),Kn.toArray(o,yy,Yp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET);break;case $g.SPOT:Un.invert(my,n.node.getWorldMatrix()),Un.toArray(o,my,Yp.MAT_LIGHT_VIEW_OFFSET),Un.perspective(vy,n.angle,n.aspect,.001,n.range),Un.multiply(gy,vy,my),Un.toArray(o,gy,Yp.MAT_LIGHT_VIEW_PROJ_OFFSET),yy.set(.01,n.range,0,1-r.saturation),Kn.toArray(o,yy,Yp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),yy.set(1,a,r.normalBias,0),Kn.toArray(o,yy,Yp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}yy.set(r.size.x,r.size.y,r.pcf,r.bias),Kn.toArray(o,yy,Yp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET),bn.toArray(o,r.shadowColor,Yp.SHADOW_COLOR_OFFSET)},t.getCombineSignY=function(){return t._combineSignY};var e=t.prototype;return e._initCombineSignY=function(){var e=this._device;t._combineSignY=.5*e.capabilities.screenSpaceSignY+.5<<1|.5*e.capabilities.clipSpaceSignY+.5},e.activate=function(t,e){this._device=t,this._pipeline=e;var n=this._pipeline.descriptorSet;this._initCombineSignY();var i=t.createBuffer(new lr(fi.UNIFORM|fi.TRANSFER_DST,mi.HOST|mi.DEVICE,qp.SIZE,qp.SIZE));n.bindBuffer(qp.BINDING,i);var r=t.createBuffer(new lr(fi.UNIFORM|fi.TRANSFER_DST,mi.HOST|mi.DEVICE,Xp.SIZE,Xp.SIZE));n.bindBuffer(Xp.BINDING,r);var o=t.createBuffer(new lr(fi.UNIFORM|fi.TRANSFER_DST,mi.HOST|mi.DEVICE,Yp.SIZE,Yp.SIZE));n.bindBuffer(Yp.BINDING,o)},e.updateGlobalUBO=function(e){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;i.update(),t.updateGlobalUBOView(e,this._globalUBO),r[0].updateBuffer(i.getBuffer(qp.BINDING),this._globalUBO),n.bindBuffer(qp.BINDING,i.getBuffer(qp.BINDING)),n.update()},e.updateCameraUBO=function(e){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;t.updateCameraUBOView(this._pipeline,this._cameraUBO,e),r[0].updateBuffer(i.getBuffer(Xp.BINDING),this._cameraUBO),n.bindBuffer(Xp.BINDING,i.getBuffer(Xp.BINDING)),n.update()},e.updateShadowUBO=function(e){var n=this._pipeline.pipelineSceneData;if(n.shadows.enabled){var i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers,o=n.shadowFrameBufferMap,a=e.scene.mainLight;a&&o.has(a)&&i.bindTexture(Kp,o.get(a).colorTextures[0]),t.updateShadowUBOView(this._pipeline,this._shadowUBO,e),i.update(),r[0].updateBuffer(i.getBuffer(Yp.BINDING),this._shadowUBO)}},e.updateShadowUBOLight=function(e,n){t.updateShadowUBOLightView(this._pipeline,this._shadowUBO,n),e.bindTexture(Kp,wv.get("default-texture").getGFXTexture()),e.bindTexture(rd,wv.get("default-texture").getGFXTexture()),e.update(),e.getBuffer(Yp.BINDING).update(this._shadowUBO)},e.updateShadowUBORange=function(t,e){e instanceof Un?Un.toArray(this._shadowUBO,e,t):e instanceof bn&&bn.toArray(this._shadowUBO,e,t)},e.destroy=function(){},t}();Sy._combineSignY=0;var Cy,Ay,by,Ty,Ey,wy,Py,Iy,Ry,Dy,By,My,Oy,Ny=t("RenderStage",(ry=hc("RenderStage"),oy=zc(),ay=zc(),sy=zc(),ry((fy=function(){function t(){at(this,"_name",uy,this),at(this,"_priority",hy,this),this._enabled=!0,at(this,"_tag",_y,this)}var e=t.prototype;return e.initialize=function(t){return this._name=t.name,this._priority=t.priority,t.tag&&(this._tag=t.tag),!0},e.activate=function(t,e){this._pipeline=t,this._flow=e},K(t,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}}]),t}(),uy=st((ly=fy).prototype,"_name",[oy,vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),hy=st(ly.prototype,"_priority",[ay,vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_y=st(ly.prototype,"_tag",[sy,vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cy=ly))||cy));c.RenderStage=Ny;var Ly,Fy=t("RenderFlow",(Cy=hc("RenderFlow"),Ay=zc(),by=zc(),Ty=zc(),Ey=zc(),wy=Wc([Ny]),Cy((Oy=function(){function t(){at(this,"_name",Ry,this),at(this,"_priority",Dy,this),at(this,"_tag",By,this),at(this,"_stages",My,this)}var e=t.prototype;return e.initialize=function(t){return this._name=t.name,this._priority=t.priority,this._stages=t.stages,t.tag&&(this._tag=t.tag),!0},e.activate=function(t){this._pipeline=t,this._stages.sort((function(t,e){return t.priority-e.priority}));for(var e=0,n=this._stages.length;e<n;e++)this._stages[e].activate(t,this)},e.render=function(t){for(var e=0,n=this._stages.length;e<n;e++)this._stages[e].enabled&&this._stages[e].render(t)},e.destroy=function(){for(var t=0,e=this._stages.length;t<e;t++)this._stages[t].destroy();this._stages.length=0},K(t,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),t}(),Ry=st((Iy=Oy).prototype,"_name",[Ay,vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Dy=st(Iy.prototype,"_priority",[by,vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),By=st(Iy.prototype,"_tag",[Ty,vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),My=st(Iy.prototype,"_stages",[Ey,wy,vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Py=Iy))||Py));c.RenderFlow=Fy,function(t){t.RENDER_FRAME_BEGIN="render-frame-begin",t.RENDER_FRAME_END="render-frame-end",t.RENDER_CAMERA_BEGIN="render-camera-begin",t.RENDER_CAMERA_END="render-camera-end",t.ATTACHMENT_SCALE_CAHNGED="attachment-scale-changed"}(Ly||(Ly=t("PipelineEventType",{})));var zy,Gy,Vy,Uy,ky,Hy,jy,Wy,qy,Xy,Yy,Ky,Jy,Qy,Zy,$y=t("PipelineEventProcessor",function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).eventTargetOn=t.prototype.on,e.eventTargetOnce=t.prototype.once,e}Q(e,t);var n=e.prototype;return n.on=function(t,e,n,i){return this.eventTargetOn(t,e,n,i)},n.once=function(t,e,n){return this.eventTargetOnce(t,e,n)},e}(Ql)),tx=new Qi,ex=new rr,nx=function(){this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null},ix=function(){this.quadIB=null,this.quadVB=null,this.quadIA=null},rx=t("RenderPipeline",(zy=hc("cc.RenderPipeline"),Gy=zc(),Vy=zc(),Uy=Wc([Fy]),zy((qy=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_tag",jy,it(e)),at(e,"_flows",Wy,it(e)),e._quadIB=null,e._quadVBOnscreen=null,e._quadVBOffscreen=null,e._quadIAOnscreen=null,e._quadIAOffscreen=null,e._eventProcessor=new $y,e._commandBuffers=[],e._pipelineUBO=new Sy,e._macros={},e._constantMacros="",e._profiler=null,e._pipelineRenderData=null,e._renderPasses=new Map,e._width=0,e._height=0,e._lastUsedRenderArea=new Qi,e._clusterEnabled=!1,e._bloomEnabled=!1,e}Q(e,t);var n=e.prototype;return n.getPipelineRenderData=function(){return this._pipelineRenderData},n.initialize=function(t){return this._flows=t.flows,t.tag&&(this._tag=t.tag),!0},n.createRenderPass=function(t,e,n){var i=this._device,r=new Ir,o=new Rr;r.format=e,o.format=n,o.stencilStoreOp=Di.DISCARD,o.depthStoreOp=Di.DISCARD,t&Wi.COLOR||(t&ug?r.loadOp=Ri.DISCARD:(r.loadOp=Ri.LOAD,r.beginAccesses=[Bi.COLOR_ATTACHMENT_WRITE])),(t&Wi.DEPTH_STENCIL)!==Wi.DEPTH_STENCIL&&(t&Wi.DEPTH||(o.depthLoadOp=Ri.LOAD),t&Wi.STENCIL||(o.stencilLoadOp=Ri.LOAD)),o.beginAccesses=[Bi.DEPTH_STENCIL_ATTACHMENT_WRITE];var a=new Mr([r],o);return i.createRenderPass(a)},n.getRenderPass=function(t,e){var n=this._renderPasses.get(t);return n||(n=this.createRenderPass(t,e.colorTextures[0].format,e.depthStencilTexture.format),this._renderPasses.set(t,n),n)},n.applyFramebufferRatio=function(t){for(var e=this.pipelineSceneData,n=this._width*e.shadingScale,i=this._height*e.shadingScale,r=t.colorTextures,o=0;o<r.length;o++)r[o].resize(n,i);t.depthStencilTexture&&t.depthStencilTexture.resize(n,i),t.destroy(),t.initialize(new Lr(t.renderPass,r,t.depthStencilTexture))},n.generateRenderArea=function(t,e){var n=t.viewport,i=t.window.width,r=t.window.height;e.x=n.x*i,e.y=n.y*r,e.width=n.width*i,e.height=n.height*r},n.generateViewport=function(t,e){this.generateRenderArea(t,tx),e||(e=ex);var n=this.pipelineSceneData.shadingScale;return e.left=tx.x*n,e.top=tx.y*n,e.width=tx.width*n,e.height=tx.height*n,e},n.generateScissor=function(t,e){e||(e=tx),this.generateRenderArea(t,e);var n=this.pipelineSceneData.shadingScale;return e.x*=n,e.y*=n,e.width*=n,e.height*=n,e},n.activate=function(){var t=c.director.root;this._device=t.device,this._generateConstantMacros(),this._globalDSManager=new ny(this),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device,this);for(var e=0;e<this._flows.length;e++)this._flows[e].activate(this);return!0},n._ensureEnoughSize=function(){},n.render=function(t){if(0!==t.length){this._commandBuffers[0].begin(),this.emit(Ly.RENDER_FRAME_BEGIN,t),this._ensureEnoughSize(t),function(t){for(var e=t.length-1;e>=0;--e){var n=t[e];if(n.window.swapchain)return void(Kv=n)}Kv=null}(t);for(var e=0;e<t.length;e++){var n=t[e];if(n.scene){this.emit(Ly.RENDER_CAMERA_BEGIN,n),Kg(this,n),Jg(this,n),this._pipelineUBO.updateGlobalUBO(n.window),this._pipelineUBO.updateCameraUBO(n);for(var i=0;i<this._flows.length;i++)this._flows[i].render(n);this.emit(Ly.RENDER_CAMERA_END,n)}}this.emit(Ly.RENDER_FRAME_END,t),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},n._destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},n._destroyBloomData=function(){var t,e=this._pipelineRenderData.bloom;if(null!==e){e.prefiterTex&&e.prefiterTex.destroy(),e.prefilterFramebuffer&&e.prefilterFramebuffer.destroy();for(var n=0;n<e.downsampleTexs.length;++n)e.downsampleTexs[n].destroy(),e.downsampleFramebuffers[n].destroy();e.downsampleTexs.length=0,e.downsampleFramebuffers.length=0;for(var i=0;i<e.upsampleTexs.length;++i)e.upsampleTexs[i].destroy(),e.upsampleFramebuffers[i].destroy();e.upsampleTexs.length=0,e.upsampleFramebuffers.length=0,e.combineTex&&e.combineTex.destroy(),e.combineFramebuffer&&e.combineFramebuffer.destroy(),null===(t=e.renderPass)||void 0===t||t.destroy(),this._pipelineRenderData.bloom=null}},n._genQuadVertexData=function(t,e){var n=new Float32Array(16),i=e.x/this._width,r=(e.x+e.width)/this._width,o=e.y/this._height,a=(e.y+e.height)/this._height;if(this.device.capabilities.screenSpaceSignY>0){var s=a;a=o,o=s}var c=0;switch(t){case ci.IDENTITY:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=o;break;case ci.ROTATE_90:c=0,n[c++]=-1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=i,n[c++]=o;break;case ci.ROTATE_180:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a;break;case ci.ROTATE_270:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=r,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a}return n},n._createQuadInputAssembler=function(){var t=new ix,e=4*Float32Array.BYTES_PER_ELEMENT,n=4*e,i=this._device.createBuffer(new lr(fi.VERTEX|fi.TRANSFER_DST,mi.DEVICE|mi.HOST,n,e));if(!i)return t;var r=Uint8Array.BYTES_PER_ELEMENT,o=6*r,a=this._device.createBuffer(new lr(fi.INDEX|fi.TRANSFER_DST,mi.DEVICE,o,r));if(!a)return t;var s=new Uint8Array(6);s[0]=0,s[1]=1,s[2]=2,s[3]=1,s[4]=3,s[5]=2,a.update(s);var c=new Array(2);c[0]=new Er("a_position",ui.RG32F),c[1]=new Er("a_texCoord",ui.RG32F);var l=this._device.createInputAssembler(new Pr(c,[i],a));return t.quadIB=a,t.quadVB=i,t.quadIA=l,t},n.updateQuadVertexData=function(t,e){var n=this._lastUsedRenderArea;if(n.x!==t.x||n.y!==t.y||n.width!==t.width||n.height!==t.height){var i=this._genQuadVertexData(ci.IDENTITY,t);this._quadVBOffscreen.update(i);var r=this._genQuadVertexData(e.swapchain&&e.swapchain.surfaceTransform||ci.IDENTITY,t);this._quadVBOnscreen.update(r),n.copy(t)}},n.destroy=function(){for(var e,n,i=0;i<this._flows.length;i++)this._flows[i].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null===(e=this._globalDSManager)||void 0===e||e.destroy();for(var r=0;r<this._commandBuffers.length;r++)this._commandBuffers[r].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null===(n=this._pipelineSceneData)||void 0===n||n.destroy(),t.prototype.destroy.call(this)},n._generateConstantMacros=function(){var t="";t+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.hasFeature(li.TEXTURE_FLOAT)?1:0)+"\n",t+="#define CC_ENABLE_CLUSTERED_LIGHT_CULLING "+(this._clusterEnabled?1:0)+"\n",t+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",t+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",t+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this.device.hasFeature(li.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n",t+="#define CC_PLATFORM_ANDROID_AND_WEBGL "+(hu.os===nu.ANDROID&&hu.isBrowser?1:0)+"\n",t+="#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES "+(ce.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0)+"\n",this._constantMacros=t},n.generateBloomRenderData=function(){if(null==this._pipelineRenderData.bloom){var t=this._pipelineRenderData.bloom=new nx,e=this.device,n=new Ir;n.format=ui.RGBA8,n.loadOp=Ri.CLEAR,n.storeOp=Di.STORE,n.endAccesses=[Bi.COLOR_ATTACHMENT_WRITE],t.renderPass=e.createRenderPass(new Mr([n]));var i=this._width,r=this._height;t.prefiterTex=e.createTexture(new pr(vi.TEX2D,gi.COLOR_ATTACHMENT|gi.SAMPLED,ui.RGBA8,i>>1,r>>1)),t.prefilterFramebuffer=e.createFramebuffer(new Lr(t.renderPass,[t.prefiterTex])),i>>=1,r>>=1;for(var o=0;o<6;++o)t.downsampleTexs.push(e.createTexture(new pr(vi.TEX2D,gi.COLOR_ATTACHMENT|gi.SAMPLED,ui.RGBA8,i>>1,r>>1))),t.downsampleFramebuffers[o]=e.createFramebuffer(new Lr(t.renderPass,[t.downsampleTexs[o]])),t.upsampleTexs.push(e.createTexture(new pr(vi.TEX2D,gi.COLOR_ATTACHMENT|gi.SAMPLED,ui.RGBA8,i,r))),t.upsampleFramebuffers[o]=e.createFramebuffer(new Lr(t.renderPass,[t.upsampleTexs[o]])),i>>=1,r>>=1;t.combineTex=e.createTexture(new pr(vi.TEX2D,gi.COLOR_ATTACHMENT|gi.SAMPLED,ui.RGBA8,this._width,this._height)),t.combineFramebuffer=e.createFramebuffer(new Lr(t.renderPass,[t.combineTex])),t.sampler=this.globalDSManager.linearSampler}},n.on=function(t,e,n,i){return this._eventProcessor.on(t,e,n,i)},n.once=function(t,e,n){return this._eventProcessor.once(t,e,n)},n.off=function(t,e,n){this._eventProcessor.off(t,e,n)},n.emit=function(t,e,n,i,r,o){this._eventProcessor.emit(t,e,n,i,r,o)},n.targetOff=function(t){this._eventProcessor.targetOff(t)},n.removeAll=function(t){this._eventProcessor.removeAll(t)},n.hasEventListener=function(t,e,n){return this._eventProcessor.hasEventListener(t,e,n)},K(e,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"profiler",get:function(){return this._profiler},set:function(t){this._profiler=t}},{key:"clusterEnabled",get:function(){return this._clusterEnabled},set:function(t){this._clusterEnabled=t}},{key:"bloomEnabled",get:function(){return this._bloomEnabled},set:function(t){this._bloomEnabled=t}}]),e}(Pu),jy=st((Hy=qy).prototype,"_tag",[Gy,vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Wy=st(Hy.prototype,"_flows",[Vy,Uy,vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ky=Hy))||ky));c.RenderPipeline=rx,function(t){t[t.BLOOM=18]="BLOOM",t[t.POST_PROCESS=19]="POST_PROCESS",t[t.UI=20]="UI"}(Xy||(Xy={})),function(t){t[t.FORWARD=10]="FORWARD"}(Yy||(Yy={})),function(t){t[t.SHADOW=0]="SHADOW",t[t.FORWARD=1]="FORWARD",t[t.UI=10]="UI"}(Ky||(Ky={})),function(t){t[t.GBUFFER=10]="GBUFFER",t[t.LIGHTING=15]="LIGHTING",t[t.TRANSPARENT=18]="TRANSPARENT"}(Jy||(Jy={})),function(t){t[t.SHADOW=0]="SHADOW",t[t.MAIN=1]="MAIN",t[t.UI=10]="UI"}(Qy||(Qy={}));var ox=new Ir;ox.format=ui.RGBA8,ox.beginAccesses=[Bi.FRAGMENT_SHADER_READ_TEXTURE],ox.endAccesses=[Bi.FRAGMENT_SHADER_READ_TEXTURE];var ax=new Rr;ax.format=ui.DEPTH_STENCIL;var sx,cx,lx,ux,hx,_x,fx,px,dx,mx,vx,gx,yx,xx,Sx,Cx,Ax,bx,Tx,Ex,wx,Px,Ix,Rx,Dx,Bx,Mx,Ox,Nx,Lx,Fx,zx,Gx,Vx,Ux,kx,Hx,jx,Wx,qx,Xx,Yx,Kx,Jx,Qx,Zx,$x,tS,eS,nS,iS,rS,oS,aS,sS,cS,lS,uS,hS,_S,fS,pS,dS,mS,vS,gS,yS,xS,SS,CS,AS,bS,TS,ES,wS,PS,IS,RS,DS,BS=new Mr([ox],ax),MS={width:1,height:1,renderPassInfo:BS},OS=t("RenderTexture",hc("cc.RenderTexture")(Zy=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._window=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._name=t.name||"",this._width=t.width,this._height=t.height,this._initWindow(t)},n.reset=function(t){this.initialize(t)},n.destroy=function(){if(this._window){var e=c.director.root;null==e||e.destroyWindow(this._window),this._window=null}return t.prototype.destroy.call(this)},n.resize=function(t,e){this._width=Math.floor(on(t,1,2048)),this._height=Math.floor(on(e,1,2048)),this._window&&this._window.resize(this._width,this._height),this.emit("resize",this._window)},n._serialize=function(){return{}},n._deserialize=function(e,n){var i=e;this._width=i.w,this._height=i.h,this._name=i.n,t.prototype._deserialize.call(this,i.base,n)},n.getGFXTexture=function(){return this._window&&this._window.framebuffer.colorTextures[0]},n.onLoaded=function(){this._initWindow()},n._initWindow=function(t){var e=c.director.root;MS.title=this._name,MS.width=this._width,MS.height=this._height,MS.renderPassInfo=t&&t.passInfo?t.passInfo:BS,this._window?(this._window.destroy(),this._window.initialize(e.device,MS)):this._window=e.createWindow(MS)},n.initDefault=function(e){t.prototype.initDefault.call(this,e),this._width=this._height=1,this._initWindow()},n.validate=function(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048},n.readPixels=function(t,e,n,i,r){void 0===t&&(t=0),void 0===e&&(e=0),n=n||this.width,i=i||this.height;var o=this.getGFXTexture();if(!o)return D(7606),null;var a=4*n*i;if(void 0===r)r=new Uint8Array(a);else if(r.length<a)return D(7607,a),null;var s=this._getGFXDevice(),c=[],l=[],u=new ir;return u.texOffset.x=t,u.texOffset.y=e,u.texExtent.width=n,u.texExtent.height=i,l.push(u),c.push(r),null==s||s.copyTextureToBuffers(o,c,l),r},K(e,[{key:"window",get:function(){return this._window}}]),e}(Xm))||Zy);c.RenderTexture=OS,ae(vi),ae(gi),ae(Di),ae(Ri),ae(Bi),function(t){t[t.SCENE=0]="SCENE",t[t.POSTPROCESS=1]="POSTPROCESS",t[t.UI=2]="UI"}(DS||(DS={})),ae(DS),sx=hc("RenderTextureDesc"),cx=Wc(vi),lx=Wc(gi),ux=Wc(ui),sx((_x=st((hx=function(){at(this,"name",_x,this),at(this,"type",fx,this),at(this,"usage",px,this),at(this,"format",dx,this),at(this,"width",mx,this),at(this,"height",vx,this)}).prototype,"name",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),fx=st(hx.prototype,"type",[cx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vi.TEX2D}}),px=st(hx.prototype,"usage",[lx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gi.COLOR_ATTACHMENT}}),dx=st(hx.prototype,"format",[ux],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ui.UNKNOWN}}),mx=st(hx.prototype,"width",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),vx=st(hx.prototype,"height",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),hx));var NS,LS=(gx=hc("RenderTextureConfig"),yx=Wc(OS),gx((Cx=st((Sx=function(){at(this,"name",Cx,this),at(this,"texture",Ax,this)}).prototype,"name",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ax=st(Sx.prototype,"texture",[yx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xx=Sx))||xx),FS=(bx=hc("MaterialConfig"),Tx=Wc(ig),bx((wx=st((Ex=function(){at(this,"name",wx,this),at(this,"material",Px,this)}).prototype,"name",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Px=st(Ex.prototype,"material",[Tx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ex)),Ix=hc("FrameBufferDesc"),Rx=Wc([Me]),Dx=Wc(OS),Ix((Mx=st((Bx=function(){at(this,"name",Mx,this),at(this,"renderPass",Ox,this),at(this,"colorTextures",Nx,this),at(this,"depthStencilTexture",Lx,this),at(this,"texture",Fx,this)}).prototype,"name",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ox=st(Bx.prototype,"renderPass",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Nx=st(Bx.prototype,"colorTextures",[Rx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Lx=st(Bx.prototype,"depthStencilTexture",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Fx=st(Bx.prototype,"texture",[Dx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Bx)),zx=hc("ColorDesc"),Gx=Wc(ui),Vx=Wc(Ri),Ux=Wc(Di),kx=Wc([Bi]),Hx=Wc([Bi]),zx((qx=st((Wx=function(){at(this,"format",qx,this),at(this,"loadOp",Xx,this),at(this,"storeOp",Yx,this),at(this,"sampleCount",Kx,this),at(this,"beginAccesses",Jx,this),at(this,"endAccesses",Qx,this)}).prototype,"format",[Gx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ui.UNKNOWN}}),Xx=st(Wx.prototype,"loadOp",[Vx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ri.CLEAR}}),Yx=st(Wx.prototype,"storeOp",[Ux],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Di.STORE}}),Kx=st(Wx.prototype,"sampleCount",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Jx=st(Wx.prototype,"beginAccesses",[kx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Qx=st(Wx.prototype,"endAccesses",[Hx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Bi.COLOR_ATTACHMENT_WRITE]}}),jx=Wx))||jx),zS=(Zx=hc("DepthStencilDesc"),$x=Wc(ui),tS=Wc(Ri),eS=Wc(Di),nS=Wc(Ri),iS=Wc(Di),rS=Wc([Bi]),oS=Wc([Bi]),Zx((cS=st((sS=function(){at(this,"format",cS,this),at(this,"depthLoadOp",lS,this),at(this,"depthStoreOp",uS,this),at(this,"stencilLoadOp",hS,this),at(this,"stencilStoreOp",_S,this),at(this,"sampleCount",fS,this),at(this,"beginAccesses",pS,this),at(this,"endAccesses",dS,this)}).prototype,"format",[$x],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ui.UNKNOWN}}),lS=st(sS.prototype,"depthLoadOp",[tS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ri.CLEAR}}),uS=st(sS.prototype,"depthStoreOp",[eS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Di.STORE}}),hS=st(sS.prototype,"stencilLoadOp",[nS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ri.CLEAR}}),_S=st(sS.prototype,"stencilStoreOp",[iS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Di.STORE}}),fS=st(sS.prototype,"sampleCount",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),pS=st(sS.prototype,"beginAccesses",[rS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dS=st(sS.prototype,"endAccesses",[oS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Bi.DEPTH_STENCIL_ATTACHMENT_WRITE]}}),aS=sS))||aS);mS=hc("RenderPassDesc"),vS=Wc([FS]),gS=Wc(zS),mS((xS=st((yS=function(){at(this,"index",xS,this),at(this,"colorAttachments",SS,this),at(this,"depthStencilAttachment",CS,this)}).prototype,"index",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),SS=st(yS.prototype,"colorAttachments",[vS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),CS=st(yS.prototype,"depthStencilAttachment",[gS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zS}}),yS)),function(t){t[t.FRONT_TO_BACK=0]="FRONT_TO_BACK",t[t.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(NS||(NS={})),ae(NS);var GS=(AS=hc("RenderQueueDesc"),bS=Wc(NS),TS=Wc([Me]),AS((PS=st((wS=function(){at(this,"isTransparent",PS,this),at(this,"sortMode",IS,this),at(this,"stages",RS,this)}).prototype,"isTransparent",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),IS=st(wS.prototype,"sortMode",[bS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return NS.FRONT_TO_BACK}}),RS=st(wS.prototype,"stages",[TS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ES=wS))||ES);function VS(t,e){return t.hash-e.hash||t.depth-e.depth||t.shaderId-e.shaderId}function US(t,e){return t.hash-e.hash||e.depth-t.depth||t.shaderId-e.shaderId}var kS=function(){function t(t){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=t,this._passPool=new Ul((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new kl(64,this._passDesc.sortFunc)}var e=t.prototype;return e.clear=function(){this.queue.clear(),this._passPool.reset()},e.insertRenderPass=function(t,e,n){var i=t.model.subModels[e],r=i.passes[n],o=i.shaders[n];if(r.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var a=0|r.priority<<16|i.priority<<8|n,s=this._passPool.add();return s.hash=a,s.depth=t.depth||0,s.shaderId=o.typedID,s.subModel=i,s.passIdx=n,this.queue.push(s),!0},e.sort=function(){this.queue.sort()},e.recordCommandBuffer=function(t,e,n){for(var i=0;i<this.queue.length;++i){var r=this.queue.array[i],o=r.subModel,a=r.passIdx,s=o.inputAssembler,c=o.passes[a],l=o.shaders[a],u=Nv.getOrCreatePipelineState(t,c,l,e,s);n.bindPipelineState(u),n.bindDescriptorSet(kp.MATERIAL,c.descriptorSet),n.bindDescriptorSet(kp.LOCAL,o.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},t}();function HS(t){for(var e=0,n=0;n<t.stages.length;n++)e|=Pv(t.stages[n]);var i=VS;switch(t.sortMode){case NS.BACK_TO_FRONT:i=US;break;case NS.FRONT_TO_BACK:i=VS}return new kS({isTransparent:t.isTransparent,phases:e,sortFunc:i})}function jS(t){t.clear()}function WS(t){t.sort()}var qS=function(){function t(){this.queue=new Set}var e=t.prototype;return e.clear=function(){for(var t=this.queue.values(),e=t.next();!e.done;)e.value.clear(),e=t.next();this.queue.clear()},e.uploadBuffers=function(t){for(var e=this.queue.values(),n=e.next();!n.done;){for(var i=0;i<n.value.batches.length;++i){var r=n.value.batches[i];if(r.mergeCount){for(var o=0;o<r.vbs.length;++o)r.vbs[o].update(r.vbDatas[o]);t.updateBuffer(r.vbIdx,r.vbIdxData.buffer),t.updateBuffer(r.ubo,r.uboData)}}n=e.next()}},e.recordCommandBuffer=function(t,e,n){for(var i=this.queue.values(),r=i.next();!r.done;){for(var o=!1,a=0;a<r.value.batches.length;++a){var s=r.value.batches[a];if(s.mergeCount){if(!o){var c=s.shader,l=Nv.getOrCreatePipelineState(t,s.pass,c,e,s.ia);n.bindPipelineState(l),n.bindDescriptorSet(kp.MATERIAL,s.pass.descriptorSet),o=!0}n.bindDescriptorSet(kp.LOCAL,s.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(s.ia),n.draw(s.ia)}}r=i.next()}},t}(),XS=function(){function t(){this.queue=new Set}var e=t.prototype;return e.clear=function(){for(var t=this.queue.values(),e=t.next();!e.done;)e.value.clear(),e=t.next();this.queue.clear()},e.uploadBuffers=function(t){for(var e=this.queue.values(),n=e.next();!n.done;)n.value.hasPendingModels&&n.value.uploadBuffers(t),n=e.next()},e.recordCommandBuffer=function(t,e,n){for(var i=this.queue.values(),r=i.next();!r.done;){var o=r.value,a=o.instances,s=o.pass;if(o.hasPendingModels){n.bindDescriptorSet(kp.MATERIAL,s.descriptorSet);for(var c=null,l=0;l<a.length;++l){var u=a[l];if(u.count){var h=u.shader,_=Nv.getOrCreatePipelineState(t,s,h,e,u.ia);c!==_&&(n.bindPipelineState(_),c=_),n.bindDescriptorSet(kp.LOCAL,u.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(u.ia),n.draw(u.ia)}}}r=i.next()}},t}(),YS=function(){function t(){this._groundAlbedoHDR=new Kn(.2,.2,.2,1),this._skyColorHDR=new Kn(.2,.5,.8,1),this._skyIllumHDR=0,this._groundAlbedoLDR=new Kn(.2,.2,.2,1),this._skyColorLDR=new Kn(.2,.5,.8,1),this._skyIllumLDR=0,this._mipmapCount=1,this._enabled=!1}var e=t.prototype;return e.initialize=function(t){this._skyColorHDR=t.skyColorHDR,this._groundAlbedoHDR.set(t.groundAlbedoHDR),this._skyIllumHDR=t.skyIllumHDR,this._skyColorLDR=t.skyColorLDR,this._groundAlbedoLDR.set(t.groundAlbedoLDR),this._skyIllumLDR=t.skyIllumLDR},e._destroy=function(){},e.destroy=function(){this._destroy()},K(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"skyColor",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR:this._skyColorLDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(t):this._skyColorLDR.set(t)}},{key:"skyIllum",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=t:this._skyIllumLDR=t}},{key:"groundAlbedo",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR:this._groundAlbedoLDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(t):this._groundAlbedoLDR.set(t)}},{key:"mipmapCount",get:function(){return this._mipmapCount},set:function(t){this._mipmapCount=t}},{key:"native",get:function(){return this._nativeObj}}]),t}();YS.SUN_ILLUM=65e3,YS.SKY_ILLUM=2e4,c.Ambient=YS;var KS,JS=function(){function t(){this._enabled=!1,this._minPos=new En(0,0,0),this._maxPos=new En(0,0,0),this._depth=0}var e=t.prototype;return e.initialize=function(t){this._enabled=t.enabled,this._minPos=t.minPos,this._maxPos=t.maxPos,this._depth=t.depth},e._destroy=function(){},e.destroy=function(){this._destroy()},K(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"minPos",get:function(){return this._minPos},set:function(t){this._minPos=t}},{key:"maxPos",get:function(){return this._maxPos},set:function(t){this._maxPos=t}},{key:"depth",get:function(){return this._depth},set:function(t){this._depth=t}},{key:"native",get:function(){return this._nativeObj}}]),t}(),QS=new Gr(null),ZS=function(){function t(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=Bp.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._worldBoundDescriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null}var e=t.prototype;return e._destroyDescriptorSet=function(){this._descriptorSet.destroy(),this._descriptorSet=null},e._destroyWorldBoundDescriptorSet=function(){this._worldBoundDescriptorSet.destroy(),this._worldBoundDescriptorSet=null},e._destroyInputAssembler=function(){this._inputAssembler.destroy(),this._inputAssembler=null},e._createDescriptorSet=function(t){this._descriptorSet=this._device.createDescriptorSet(t)},e._createWorldBoundDescriptorSet=function(t){this._worldBoundDescriptorSet=this._device.createDescriptorSet(t)},e._setInputAssembler=function(t){this._inputAssembler=this._device.createInputAssembler(t)},e._setSubMesh=function(t){this._subMesh=t},e._init=function(){},e.initialize=function(t,e,n){void 0===n&&(n=null);var i=c.director.root;this._device=i.device,QS.layout=e[0].localSetLayout,this._init(),this._setInputAssembler(t.iaInfo),this._createDescriptorSet(QS);var r=c.director.root.pipeline.pipelineSceneData.getOcclusionQueryPass(),o=new Gr(null);if(o.layout=r.localSetLayout,this._createWorldBoundDescriptorSet(o),this._setSubMesh(t),this._patches=n,this._passes=e,this._flushPassInfo(),e[0].batchingScheme===Av.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this.priority=Bp.DEFAULT,e[0].phase===Pv("reflection")){var a=i.mainWindow.width,s=i.mainWindow.height,l=512;s<a?(a=l*a/s,s=l):s=l*s/(a=l),this._reflectionTex=this._device.createTexture(new pr(vi.TEX2D,gi.STORAGE|gi.TRANSFER_SRC|gi.SAMPLED,ui.RGBA8,a,s)),this.descriptorSet.bindTexture(Fd,this._reflectionTex),this._reflectionSampler=this._device.getSampler(new mr(Ci.LINEAR,Ci.LINEAR,Ci.NONE,Ai.CLAMP,Ai.CLAMP,Ai.CLAMP)),this.descriptorSet.bindSampler(Fd,this._reflectionSampler),this.descriptorSet.bindTexture(Vd,this._reflectionTex)}},e._initNativePlanarShadowShader=function(t){this._planarShader=t.getPlanarShader(this._patches)},e.initPlanarShadowShader=function(){var t=c.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowShader(t)},e._initNativePlanarShadowInstanceShader=function(t){this._planarInstanceShader=t.getPlanarInstanceShader(this._patches)},e.initPlanarShadowInstanceShader=function(){var t=c.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowInstanceShader(t)},e._destroy=function(){},e.destroy=function(){this._destroyDescriptorSet(),this._destroyWorldBoundDescriptorSet(),this._destroyInputAssembler(),this.priority=Bp.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler=null,this._destroy()},e.update=function(){for(var t=0;t<this._passes.length;++t)this._passes[t].update();this._descriptorSet.update(),this._worldBoundDescriptorSet.update()},e.onPipelineStateChanged=function(){var t=this._passes;if(t){for(var e=0;e<t.length;e++){var n=t[e];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}},e.onMacroPatchesStateChanged=function(t){this._patches=t;var e=this._passes;if(e){for(var n=0;n<e.length;n++){var i=e[n];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},e._flushPassInfo=function(){var t=this._passes;if(t){this._shaders||(this._shaders=[]),this._shaders.length=t.length;for(var e=0,n=t.length;e<n;e++)this._shaders[e]=t[e].getShaderVariant(this.patches)}},K(t,[{key:"passes",get:function(){return this._passes},set:function(t){t.length>8?D(12004,8):(this._passes=t,this._flushPassInfo(),this._passes[0].batchingScheme===Av.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this._descriptorSet&&(this._destroyDescriptorSet(),QS.layout=t[0].localSetLayout,this._createDescriptorSet(QS)))}},{key:"shaders",get:function(){return this._shaders}},{key:"subMesh",get:function(){return this._subMesh},set:function(t){this._inputAssembler.destroy(),this._inputAssembler.initialize(t.iaInfo),this._passes[0].batchingScheme===Av.VB_MERGING&&this.subMesh.genFlatBuffers(),this._setSubMesh(t)}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"worldBoundDescriptorSet",get:function(){return this._worldBoundDescriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarInstanceShader",get:function(){return this._planarInstanceShader}},{key:"planarShader",get:function(){return this._planarShader}},{key:"native",get:function(){return this._nativeObj}}]),t}(),$S=new Un,tC=[{name:"CC_RECEIVE_SHADOW",value:!0}];!function(t){t[t.DEFAULT=0]="DEFAULT",t[t.SKINNING=1]="SKINNING",t[t.BAKED_SKINNING=2]="BAKED_SKINNING",t[t.BATCH_2D=3]="BATCH_2D",t[t.PARTICLE_BATCH=4]="PARTICLE_BATCH",t[t.LINE=5]="LINE"}(KS||(KS={}));var eC=new mr(Ci.LINEAR,Ci.LINEAR,Ci.NONE,Ai.CLAMP,Ai.CLAMP,Ai.CLAMP),nC=new mr(Ci.LINEAR,Ci.LINEAR,Ci.LINEAR,Ai.CLAMP,Ai.CLAMP,Ai.CLAMP),iC=function(){function t(){this.type=KS.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._localDataUpdated=!0,this._localData=new Float32Array(sd.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new Kn,this._worldBoundBuffer=null,this._receiveShadow=!1,this._castShadow=!1,this._enabled=!0,this._visFlags=Rp.Enum.NONE,this._device=c.director.root.device}var e=t.prototype;return e._setReceiveShadow=function(t){this._receiveShadow=t},e._init=function(){},e.initialize=function(){this._inited||(this._init(),this._setReceiveShadow(!0),this.castShadow=!1,this.enabled=!0,this.visFlags=Rp.Enum.NONE,this._inited=!0)},e._destroySubmodel=function(t){t.destroy()},e._destroy=function(){},e.destroy=function(){for(var t=this._subModels,e=0;e<t.length;e++){var n=this._subModels[e];this._destroySubmodel(n)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBoundBuffer&&(this._worldBoundBuffer.destroy(),this._worldBoundBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._localDataUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._destroy()},e.attachToScene=function(t){this.scene=t,this._localDataUpdated=!0},e.detachFromScene=function(){this.scene=null},e.updateTransform=function(){var t=this.transform;if(t.hasChangedFlags||t._dirtyFlags){t.updateWorldTransform(),this._localDataUpdated=!0;var e=this._worldBounds;this._modelBounds&&e&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e)}},e.updateWorldBound=function(){var t=this.transform;if(null!==t){t.updateWorldTransform(),this._localDataUpdated=!0;var e=this._worldBounds;this._modelBounds&&e&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e)}},e._applyLocalData=function(){},e._applyLocalBuffer=function(){},e._applyWorldBoundBuffer=function(){},e.updateUBOs=function(t){for(var e=this._subModels,n=0;n<e.length;n++)e[n].update();if(this._updateStamp=t,this._localDataUpdated){this._localDataUpdated=!1;var i=this.transform._mat,r=this._instMatWorldIdx;if(r>=0){var o=this.instancedAttributes.views;!function(t,e,n,i){e[0]=t.m00,e[1]=t.m01,e[2]=t.m02,e[3]=t.m12,n[0]=t.m04,n[1]=t.m05,n[2]=t.m06,n[3]=t.m13,i[0]=t.m08,i[1]=t.m09,i[2]=t.m10,i[3]=t.m14}(i,o[r],o[r+1],o[r+2])}else if(this._localBuffer){Un.toArray(this._localData,i,sd.MAT_WORLD_OFFSET),Un.inverseTranspose($S,i);var a=Math.abs(Un.determinant($S)),s=1/Math.sqrt(a);Un.multiplyScalar($S,$S,s),Un.toArray(this._localData,$S,sd.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._applyLocalData(),this._applyLocalBuffer()}}},e._updateNativeBounds=function(){},e.createBoundingShape=function(t,e){t&&e&&(this._modelBounds=ks.fromPoints(ks.create(),t,e),this._worldBounds=ks.clone(this._modelBounds),this._updateNativeBounds())},e._createSubModel=function(){return new ZS},e.initSubModel=function(t,e,n){this.initialize(),null==this._subModels[t]?this._subModels[t]=this._createSubModel():this._subModels[t].destroy(),this._subModels[t].initialize(e,n.passes,this.getMacroPatches(t)),this._subModels[t].initPlanarShadowShader(),this._subModels[t].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(t)},e.setSubModelMesh=function(t,e){this._subModels[t]&&(this._subModels[t].subMesh=e)},e.setSubModelMaterial=function(t,e){this._subModels[t]&&(this._subModels[t].passes=e.passes,this._updateAttributesAndBinding(t))},e.onGlobalPipelineStateChanged=function(){for(var t=this._subModels,e=0;e<t.length;e++)t[e].onPipelineStateChanged()},e.onMacroPatchesStateChanged=function(){for(var t=this._subModels,e=0;e<t.length;e++)t[e].onMacroPatchesStateChanged(this.getMacroPatches(e))},e.updateLightingmap=function(t,e){Kn.toArray(this._localData,e,sd.LIGHTINGMAP_UVPARAM),this._localDataUpdated=!0,this._lightmap=t,this._lightmapUVParam=e,null===t&&(t=wv.get("empty-texture"));var n=t.getGFXTexture();if(n)for(var i=this._device.getSampler(t.mipmaps.length>1?nC:eC),r=this._subModels,o=0;o<r.length;o++){var a=r[o].descriptorSet;a.bindTexture(Dd,n),a.bindSampler(Dd,i),a.update()}},e.getMacroPatches=function(){return this.receiveShadow?tC:null},e._updateAttributesAndBinding=function(t){var e=this._subModels[t];if(e){this._initLocalDescriptors(t),this._updateLocalDescriptors(t,e.descriptorSet),this._initWorldBoundDescriptors(t),this._updateWorldBoundDescriptors(t,e.worldBoundDescriptorSet);var n=e.passes[0].getShaderVariant(e.patches);this._updateInstancedAttributes(n.attributes,e.passes[0])}},e._getInstancedAttributeIndex=function(t){for(var e=this.instancedAttributes.attributes,n=0;n<e.length;n++)if(e[n].name===t)return n;return-1},e._setInstMatWorldIdx=function(t){this._instMatWorldIdx=t},e._updateInstancedAttributes=function(t,e){if(e.device.hasFeature(li.INSTANCED_ARRAYS)){for(var n=0,i=0;i<t.length;i++){var r=t[i];r.isInstanced&&(n+=Jr[r.format].size)}var o=this.instancedAttributes;o.buffer=new Uint8Array(n),o.views.length=o.attributes.length=0;for(var a=0,s=0;s<t.length;s++){var c=t[s];if(c.isInstanced){var l=new Er;l.format=c.format,l.name=c.name,l.isNormalized=c.isNormalized,l.location=c.location,o.attributes.push(l);var u=Jr[c.format],h=new(oo(u))(o.buffer.buffer,a,u.count);o.views.push(h),a+=u.size}}e.batchingScheme===Av.INSTANCING&&e.getInstancedBuffer().destroy(),this._setInstMatWorldIdx(this._getInstancedAttributeIndex(ld)),this._localDataUpdated=!0}},e._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new lr(fi.UNIFORM|fi.TRANSFER_DST,mi.DEVICE,sd.SIZE,sd.SIZE)),this._applyLocalBuffer())},e._initWorldBoundDescriptors=function(){this._worldBoundBuffer||(this._worldBoundBuffer=this._device.createBuffer(new lr(fi.UNIFORM|fi.TRANSFER_DST,mi.DEVICE,cd.SIZE,cd.SIZE)),this._applyWorldBoundBuffer())},e._updateLocalDescriptors=function(t,e){this._localBuffer&&e.bindBuffer(sd.BINDING,this._localBuffer)},e._updateWorldBoundDescriptors=function(t,e){this._worldBoundBuffer&&e.bindBuffer(cd.BINDING,this._worldBoundBuffer)},K(t,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"worldBoundBuffer",get:function(){return this._worldBoundBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(t){this._setReceiveShadow(t),this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return this._castShadow},set:function(t){this._castShadow=t}},{key:"node",get:function(){return this._node},set:function(t){this._node=t}},{key:"transform",get:function(){return this._transform},set:function(t){this._transform=t}},{key:"visFlags",get:function(){return this._visFlags},set:function(t){this._visFlags=t}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled=t}},{key:"native",get:function(){return this._nativeObj}}]),t}(),rC=function(){function t(t){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=t,this._createNativeObject()}t.registerCreateFunc=function(e){e._createSceneFun=function(e){return new t(e)}};var e=t.prototype;return e.initialize=function(t){return this._name=t.name,!0},e.activate=function(){},e.update=function(t){var e=this._mainLight;e&&e.update();for(var n=this._sphereLights,i=0;i<n.length;i++)n[i].update();for(var r=this._spotLights,o=0;o<r.length;o++)r[o].update();for(var a=this._models,s=0;s<a.length;s++){var c=a[s];c.enabled&&(c.updateTransform(t),c.updateUBOs(t))}},e._destroy=function(){},e.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._destroy()},e.addCamera=function(t){t.attachToScene(this),this._cameras.push(t)},e.removeCamera=function(t){for(var e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return this._cameras.splice(e,1),void t.detachFromScene()},e.removeCameras=function(){for(var t,e=ot(this._cameras);!(t=e()).done;)t.value.detachFromScene();this._cameras.splice(0)},e.setMainLight=function(t){this._mainLight=t},e.unsetMainLight=function(t){if(this._mainLight===t){var e=this._directionalLights;if(e.length)return this.setMainLight(e[e.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=Zg.ROTATION));this.setMainLight(null)}},e.addDirectionalLight=function(t){t.attachToScene(this),this._directionalLights.push(t)},e.removeDirectionalLight=function(t){for(var e=0;e<this._directionalLights.length;++e)if(this._directionalLights[e]===t)return t.detachFromScene(),void this._directionalLights.splice(e,1)},e.addSphereLight=function(t){t.attachToScene(this),this._sphereLights.push(t)},e.removeSphereLight=function(t){for(var e=0;e<this._sphereLights.length;++e)if(this._sphereLights[e]===t)return t.detachFromScene(),void this._sphereLights.splice(e,1)},e.addSpotLight=function(t){t.attachToScene(this),this._spotLights.push(t)},e.removeSpotLight=function(t){for(var e=0;e<this._spotLights.length;++e)if(this._spotLights[e]===t)return t.detachFromScene(),void this._spotLights.splice(e,1)},e.removeSphereLights=function(){for(var t=0;t<this._sphereLights.length;++t)this._sphereLights[t].detachFromScene();this._sphereLights.length=0},e.removeSpotLights=function(){for(var t=0;t<this._spotLights.length;++t)this._spotLights[t].detachFromScene();this._spotLights=[]},e.addModel=function(t){t.attachToScene(this),this._models.push(t)},e.removeModel=function(t){for(var e=0;e<this._models.length;++e)if(this._models[e]===t)return t.detachFromScene(),void this._models.splice(e,1)},e.removeModels=function(){for(var t,e=ot(this._models);!(t=e()).done;){var n=t.value;n.detachFromScene(),n.destroy()}this._models.length=0},e.addBatch=function(t){this._batches.push(t)},e.removeBatch=function(t){for(var e=0;e<this._batches.length;++e)if(this._batches[e]===t)return void this._batches.splice(e,1)},e.removeBatches=function(){this._batches.length=0},e.onGlobalPipelineStateChanged=function(){for(var t,e=ot(this._models);!(t=e()).done;)t.value.onGlobalPipelineStateChanged()},e.generateModelId=function(){return this._modelId++},e._createNativeObject=function(){},K(t,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"native",get:function(){return this._nativeObj}},{key:"batches",get:function(){return this._batches}}]),t}();G(rC.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),G(rC.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);var oC={};G(oC,"CameraVisFlags",[{name:"GENERAL"}]),z(oC,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:Rp.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Rp.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Rp.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Rp.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Rp.BitMask,targetName:"UI_2D"}]),c.CameraVisFlags=oC;var aC={};G(aC,"VisibilityFlags",[{name:"GENERAL"}]),z(aC,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:Rp.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:Rp.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Rp.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Rp.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Rp.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Rp.Enum,targetName:"UI_2D"}]),c.VisibilityFlags=aC,z(Ov.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),G(_g.prototype,"Camera.prototype",[{name:"getSplitFrustum"},{name:"setMatView"},{name:"setMatViewInv"},{name:"setMatProjInv"},{name:"setMatViewProjInv"},{name:"setMatProj"},{name:"setMatViewProj"},{name:"getMatViewInv"}]),G(vg.prototype,"Shadows.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]);var sC=new En(0,0,-1),cC=new En,lC=function(t){function e(){var e;return(e=t.call(this)||this)._dir=new En(1,-1,-1),e._illuminanceHDR=YS.SUN_ILLUM,e._illuminanceLDR=1,e._type=$g.DIRECTIONAL,e}Q(e,t);var n=e.prototype;return n.initialize=function(){t.prototype.initialize.call(this),this.illuminance=YS.SUN_ILLUM,this.direction=new En(1,-1,-1)},n.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=En.transformQuat(cC,sC,this._node.worldRotation))},K(e,[{key:"direction",get:function(){return this._dir},set:function(t){En.normalize(this._dir,t)}},{key:"illuminance",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=t:this.illuminanceLDR=t}},{key:"illuminanceHDR",get:function(){return this._illuminanceHDR},set:function(t){this._illuminanceHDR=t}},{key:"illuminanceLDR",get:function(){return this._illuminanceLDR},set:function(t){this._illuminanceLDR=t}}]),e}(dy),uC=function(t){function e(e,n){var i;(i=t.call(this,e.root)||this)._parent=void 0,i._owner=void 0,i._dontNotify=!1,i._parent=e,i._owner=n,i._doInit(i._parent,!0);for(var r=0;r<i._shaderInfo.blocks.length;r++){var o=i._shaderInfo.blocks[r],a=i._blocks[o.binding],s=i._parent.blocks[o.binding];a.set(s)}i._setRootBufferDirty(!0);for(var c=i._parent,l=0;l<i._shaderInfo.samplerTextures.length;l++)for(var u=i._shaderInfo.samplerTextures[l],h=0;h<u.count;h++){var _=c._descriptorSet.getSampler(u.binding,h),f=c._descriptorSet.getTexture(u.binding,h);i._descriptorSet.bindSampler(u.binding,_,h),i._descriptorSet.bindTexture(u.binding,f,h)}return t.prototype.tryCompile.call(it(i)),i}Q(e,t);var n=e.prototype;return n.overridePipelineStates=function(t,e){this._bs.reset(),this._rs.reset(),this._dss.reset(),Ov.fillPipelineInfo(this,t),Ov.fillPipelineInfo(this,e),this._onStateChange()},n.tryCompile=function(e){if(e&&!cm(this._defines,e))return!1;var n=t.prototype.tryCompile.call(this);return this._onStateChange(),n},n.beginChangeStatesSilently=function(){this._dontNotify=!0},n.endChangeStatesSilently=function(){this._dontNotify=!1},n._syncBatchingScheme=function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this._setBatchingScheme(Av.NONE)},n._onStateChange=function(){this._setHash(Ov.getPassHash(this)),this._owner.onPassStateChange(this._dontNotify)},K(e,[{key:"parent",get:function(){return this._parent}}]),e}(Ov),hC=function(t){function e(e){var n;return(n=t.call(this)||this)._passes=[],n._parent=void 0,n._owner=void 0,n._subModelIdx=0,n._parent=e.parent,n._owner=e.owner||null,n._subModelIdx=e.subModelIdx||0,n.copy(n._parent),n}Q(e,t);var n=e.prototype;return n.recompileShaders=function(t,e){if(this._passes&&this.effectAsset)if(void 0===e)for(var n,i=ot(this._passes);!(n=i()).done;)n.value.tryCompile(t);else this._passes[e].tryCompile(t)},n.overridePipelineStates=function(t,e){if(this._passes&&this.effectAsset){var n=this.effectAsset.techniques[this.technique].passes;if(void 0===e)for(var i=0;i<this._passes.length;i++){var r=this._passes[i],o=this._states[i]||(this._states[i]={});for(var a in t)o[a]=t[a];r.overridePipelineStates(n[r.passIndex],o)}else{var s=this._states[e]||(this._states[e]={});for(var c in t)s[c]=t[c];this._passes[e].overridePipelineStates(n[e],s)}}},n.destroy=function(){return this._doDestroy(),!0},n.onPassStateChange=function(t){this._hash=ig.getHash(this),!t&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)},n._createPasses=function(){var t=[],e=this._parent.passes;if(!e)return t;for(var n=0;n<e.length;++n)t.push(new uC(e[n],this));return t},K(e,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),e}(ig),_C=null,fC=null,pC=function(){function t(){this._envmapLDR=null,this._envmapHDR=null,this._diffuseMapLDR=null,this._diffuseMapHDR=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._useHDR=!0,this._useDiffuseMap=!1}var e=t.prototype;return e._setEnabled=function(t){this._enabled=t},e._setUseIBL=function(t){this._useIBL=t},e._setUseHDR=function(t){this._useHDR=t},e._setUseDiffuseMap=function(t){this._useDiffuseMap=t},e.initialize=function(t){this._setEnabled(t.enabled),this._setUseIBL(t.useIBL),this._setUseDiffuseMap(t.applyDiffuseMap),this._setUseHDR(t.useHDR)},e.setEnvMaps=function(t,e){this._envmapHDR=t,this._envmapLDR=e;var n=c.director.root;n.pipeline.pipelineSceneData.isHDR?t&&(n.pipeline.pipelineSceneData.ambient.mipmapCount=t.mipmapLevel):e&&(n.pipeline.pipelineSceneData.ambient.mipmapCount=e.mipmapLevel),this._updateGlobalBinding(),this._updatePipeline()},e.setDiffuseMaps=function(t,e){this._diffuseMapHDR=t,this._diffuseMapLDR=e,this._updateGlobalBinding(),this._updatePipeline()},e.activate=function(){var t=c.director.root.pipeline;this._globalDSManager=t.globalDSManager,this._default=wv.get("default-cube-texture"),this._model||(this._model=c.director.root.createModel(c.renderer.scene.Model),this._model._initLocalDescriptors=function(){},this._model._initWorldBoundDescriptors=function(){});var e=this._default.isRGBE;if(this.envmap&&(e=this.envmap.isRGBE),!fC){var n=new ig;n.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:e}}),fC=new hC({parent:n})}this.enabled&&(_C||(_C=c.utils.createMesh(c.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,_C.renderingSubMeshes[0],fC)),this.envmap||(this.envmap=this._default),this.diffuseMap||(this.diffuseMap=this._default),this._updateGlobalBinding(),this._updatePipeline()},e._updatePipeline=function(){var t=c.director.root,e=t.pipeline,n=this.useIBL?this.isRGBE?2:1:0,i=this.useIBL&&this.useDiffuseMap&&this.diffuseMap?this.isRGBE?2:1:0,r=this.useHDR;e.macros.CC_USE_IBL===n&&e.macros.CC_USE_DIFFUSEMAP===i&&e.macros.CC_USE_HDR===r||(e.macros.CC_USE_IBL=n,e.macros.CC_USE_DIFFUSEMAP=i,e.macros.CC_USE_HDR=r,t.onGlobalPipelineStateChanged()),this.enabled&&fC&&fC.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE}),this._model&&this._model.setSubModelMaterial(0,fC)},e._updateGlobalBinding=function(){if(this._globalDSManager){var t=c.director.root.device,e=this.envmap?this.envmap:this._default;if(e){var n=e.getGFXTexture(),i=t.getSampler(e.getSamplerInfo());this._globalDSManager.bindSampler(Zp,i),this._globalDSManager.bindTexture(Zp,n)}var r=this.diffuseMap?this.diffuseMap:this._default;if(r){var o=r.getGFXTexture(),a=t.getSampler(r.getSamplerInfo());this._globalDSManager.bindSampler(ed,a),this._globalDSManager.bindTexture(ed,o)}this._globalDSManager.update()}},e._destroy=function(){},e.destroy=function(){this._destroy()},K(t,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._setEnabled(t),t?this.activate():this._updatePipeline()}},{key:"useHDR",get:function(){return this._useHDR},set:function(t){this._setUseHDR(t),this.setEnvMaps(this._envmapHDR,this._envmapLDR)}},{key:"useIBL",get:function(){return this._useIBL},set:function(t){this._setUseIBL(t),this._updatePipeline()}},{key:"useDiffuseMap",get:function(){return this._useDiffuseMap},set:function(t){this._useDiffuseMap=t,this.setDiffuseMaps(null,null)}},{key:"isRGBE",get:function(){return!!this.envmap&&this.envmap.isRGBE}},{key:"envmap",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this.setEnvMaps(t,this._envmapLDR):this.setEnvMaps(this._envmapHDR,t)}},{key:"diffuseMap",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this.setDiffuseMaps(t,this._diffuseMapLDR):this.setDiffuseMaps(this._diffuseMapHDR,t)}},{key:"native",get:function(){return this._nativeObj}}]),t}();c.Skybox=pC;var dC=function(t){Q(n,t);var e=n.prototype;function n(){var e;return(e=t.call(this)||this)._needUpdate=!1,e._size=.15,e._range=1,e._luminanceHDR=0,e._luminanceLDR=0,e._pos=void 0,e._aabb=void 0,e._aabb=ks.create(),e._pos=new En,e._type=$g.SPHERE,e}return e._init=function(){t.prototype._init.call(this)},e._destroy=function(){t.prototype._destroy.call(this)},e.initialize=function(){t.prototype.initialize.call(this),this.size=.15,this.range=1,this.luminance=1700/py(.15),this.luminanceLDR=1},e.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var t=this._range;ks.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,t,t,t),this._needUpdate=!1}},K(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(t){this._size=t}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._needUpdate=!0}},{key:"luminance",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=t:this.luminanceLDR=t}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(t){this._luminanceHDR=t}},{key:"luminanceLDR",set:function(t){this._luminanceLDR=t}},{key:"aabb",get:function(){return this._aabb}}]),n}(dy),mC=new En(0,0,-1),vC=new Mn,gC=new Un,yC=new Un,xC=new Un,SC=new Un,CC=function(t){Q(n,t);var e=n.prototype;function n(){var e;return(e=t.call(this)||this)._dir=new En(1,-1,-1),e._range=5,e._spotAngle=Math.cos(Math.PI/6),e._pos=void 0,e._aabb=void 0,e._frustum=void 0,e._angle=0,e._needUpdate=!1,e._size=.15,e._luminanceHDR=0,e._luminanceLDR=0,e._aspect=0,e._aabb=ks.create(),e._frustum=tc.create(),e._pos=new En,e._type=$g.SPOT,e}return e._init=function(){t.prototype._init.call(this)},e._destroy=function(){t.prototype._destroy.call(this)},e._setDirection=function(t){this._dir.set(t)},e.initialize=function(){t.prototype.initialize.call(this),this.size=.15,this.aspect=1,this.luminance=1700/py(.15),this.luminanceLDR=1,this.range=Math.cos(Math.PI/6),this._setDirection(new En(1,-1,-1))},e.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),En.transformQuat(this._dir,mC,this._node.getWorldRotation(vC)),En.normalize(this._dir,this._dir),ks.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(gC),Un.invert(gC,gC),Un.perspective(yC,this._angle,1,.001,this._range),Un.multiply(xC,yC,gC),this._frustum.update(xC,SC),this._needUpdate=!1)},K(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(t){this._size=t}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._needUpdate=!0}},{key:"luminance",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=t:this.luminanceLDR=t}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(t){this._luminanceHDR=t}},{key:"luminanceLDR",get:function(){return this._luminanceLDR},set:function(t){this._luminanceLDR=t}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(t){this._angle=t,this._spotAngle=Math.cos(.5*t),this._needUpdate=!0}},{key:"angle",get:function(){return this._angle}},{key:"aspect",get:function(){return this._aspect},set:function(t){this._aspect=t,this._needUpdate=!0}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),n}(dy),AC=Object.freeze({__proto__:null,Ambient:YS,Octree:JS,get CameraFOVAxis(){return Qv},get CameraProjection(){return Zv},get CameraAperture(){return $v},get CameraISO(){return tg},get CameraShutter(){return eg},SKYBOX_FLAG:ug,Camera:_g,CameraVisFlags:oC,VisibilityFlags:aC,DirectionalLight:lC,ColorTemperatureToRGB:iy,get LightType(){return $g},nt2lm:py,Light:dy,get ModelType(){return KS},Model:iC,ShadowSize:fg,ShadowType:pg,PCFType:dg,Shadows:vg,RenderScene:rC,Skybox:pC,SphereLight:dC,SpotLight:CC,SubModel:ZS,NativeNode:null,NativeScene:null,NativeAABB:null,NativeModel:null,NativeSkinningModel:null,NativeBakedAnimInfo:null,NativeBakedJointInfo:null,NativeBakedSkinningModel:null,NativeLight:null,NativeDirectionalLight:null,NativeSphereLight:null,NativeSpotLight:null,NaitveSkybox:null,NativeFog:null,NativeRenderWindow:null,NativeCamera:null,NativePass:null,NativeSubModel:null,NativeDrawBatch2D:null,NativeRenderScene:null,NativeOctree:null,NativeAmbient:null,NativeShadow:null,NativeRoot:null,NativeJointTransform:null,NativeJointInfo:null,NativePipelineSharedSceneData:null}),bC=new Vl((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),TC=new Float32Array(4),EC=[],wC=[],PC=new Un,IC=new Un;function RC(t,e){return!(!e.worldBounds||cs.aabbWithAABB(e.worldBounds,t.aabb))}function DC(t,e){return!(!e.worldBounds||cs.aabbWithAABB(e.worldBounds,t.aabb)&&cs.aabbFrustum(e.worldBounds,t.frustum))}var BC=Pv("forward-add"),MC=[];function OC(t,e){e.length=0;for(var n=!1,i=0;i<t.length;i++){for(var r=t[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===BC){o=a,n=!0;break}e.push(o)}return n}var NC,LC,FC,zC,GC,VC,UC,kC,HC,jC,WC,qC=function(){function t(t){this._pipeline=void 0,this._device=void 0,this._lightPasses=[],this._shadowUBO=new Float32Array(Yp.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._pipeline=t,this._device=t.device,this._instancedQueue=new XS,this._batchedQueue=new qS;var e=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(hd.SIZE/e)*e,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new lr(fi.UNIFORM|fi.TRANSFER_DST,mi.HOST|mi.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new ur(this._lightBuffer,0,hd.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}var e=t.prototype;return e.clear=function(){this._instancedQueue.clear(),this._batchedQueue.clear();for(var t=0;t<this._lightPasses.length;t++){var e=this._lightPasses[t];e.dynamicOffsets.length=0,e.lights.length=0}bC.freeArray(this._lightPasses),this._lightPasses.length=0},e.destroy=function(){for(var t=this._pipeline.globalDSManager.descriptorSetMap,e=t.keys,n=0;n<e.length;n++){var i=e[n],r=t.get(i);r&&(r.getBuffer(Yp.BINDING).destroy(),r.getTexture(Kp).destroy(),r.getTexture(rd).destroy(),r.destroy()),t.delete(i)}},e.gatherLightPasses=function(t,e){this.clear();var n=this._pipeline.pipelineSceneData.validPunctualLights;if(n.length){this._updateUBOs(t,e),this._updateLightDescriptorSet(t,e);for(var i=this._pipeline.pipelineSceneData.renderObjects,r=0;r<i.length;r++){var o=i[r].model,a=o.subModels;if(OC(a,MC)&&(wC.length=0,this._lightCulling(o,n),wC.length))for(var s=0;s<a.length;s++){var c=MC[s];if(!(c<0)){var l=a[s],u=l.passes[c];l.passes[0].blendState.targets[0].blend||(l.descriptorSet.bindBuffer(hd.BINDING,this._firstLightBufferView),l.descriptorSet.update(),this._addRenderQueue(u,l,o,c))}}}this._instancedQueue.uploadBuffers(e),this._batchedQueue.uploadBuffers(e)}},e.recordCommandBuffer=function(t,e,n){this._instancedQueue.recordCommandBuffer(t,e,n),this._batchedQueue.recordCommandBuffer(t,e,n);for(var i=this._pipeline.globalDSManager,r=0;r<this._lightPasses.length;r++){var o=this._lightPasses[r],a=o.subModel,s=o.passIdx,c=o.dynamicOffsets,l=o.lights,u=a.passes[s],h=a.shaders[s],_=a.inputAssembler,f=Nv.getOrCreatePipelineState(t,u,h,e,_),p=u.descriptorSet,d=a.descriptorSet;n.bindPipelineState(f),n.bindDescriptorSet(kp.MATERIAL,p),n.bindInputAssembler(_);for(var m=0;m<c.length;++m){var v=l[m],g=i.getOrCreateDescriptorSet(v);EC[0]=c[m],n.bindDescriptorSet(kp.GLOBAL,g),n.bindDescriptorSet(kp.LOCAL,d,EC),n.draw(_)}}},e._lightCulling=function(t,e){for(var n=0;n<e.length;n++){var i=e[n],r=!1;switch(i.type){case $g.SPHERE:r=RC(i,t);break;case $g.SPOT:r=DC(i,t)}r||wC.push(n)}},e._addRenderQueue=function(t,e,n,i){var r=t.batchingScheme;if(r===Av.INSTANCING)for(var o=0;o<wC.length;o++){var a=wC[o],s=t.getInstancedBuffer(a);s.merge(e,n.instancedAttributes,i),s.dynamicOffsets[0]=this._lightBufferStride*a,this._instancedQueue.queue.add(s)}else if(r===Av.VB_MERGING)for(var c=0;c<wC.length;c++){var l=wC[c],u=t.getBatchedBuffer(l);u.merge(e,i,n),u.dynamicOffsets[0]=this._lightBufferStride*l,this._batchedQueue.queue.add(u)}else{var h=bC.alloc();h.subModel=e,h.passIdx=i;for(var _=0;_<wC.length;_++){var f=wC[_];h.lights.push(f),h.dynamicOffsets.push(this._lightBufferStride*f)}this._lightPasses.push(h)}},e._updateLightDescriptorSet=function(t,e){for(var n=this._pipeline.device,i=this._pipeline.pipelineSceneData,r=i.shadows,o=i.shadowFrameBufferMap,a=t.scene.mainLight,s=Yd(n)?0:1,c=this._pipeline.globalDSManager,l=i.validPunctualLights,u=0;u<l.length;u++){var h=l[u],_=c.getOrCreateDescriptorSet(u);if(_){var f=void 0,p=void 0;switch(h.type){case $g.SPHERE:a&&(Xg(r,a,this._shadowUBO),Yg(r,this._shadowUBO)),this._shadowUBO[Yp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[Yp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[Yp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[Yp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[Yp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=2,this._shadowUBO[Yp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[Yp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[Yp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,bn.toArray(this._shadowUBO,r.shadowColor,Yp.SHADOW_COLOR_OFFSET);break;case $g.SPOT:if(a&&(Xg(r,a,this._shadowUBO),Yg(r,this._shadowUBO)),Un.invert(PC,h.node.getWorldMatrix()),Un.perspective(IC,h.angle,h.aspect,.001,h.range),f=IC.clone(),p=IC.clone().invert(),Un.multiply(IC,IC,PC),Un.toArray(this._shadowUBO,PC,Yp.MAT_LIGHT_VIEW_OFFSET),Un.toArray(this._shadowUBO,IC,Yp.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[Yp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[Yp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=h.range,this._shadowUBO[Yp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[Yp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-r.saturation,this._shadowUBO[Yp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[Yp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[Yp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[Yp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[Yp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=1,this._shadowUBO[Yp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[Yp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[Yp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[Yp.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=f.m10,this._shadowUBO[Yp.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=f.m14,this._shadowUBO[Yp.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=f.m11,this._shadowUBO[Yp.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=f.m15,this._shadowUBO[Yp.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=p.m10,this._shadowUBO[Yp.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=p.m14,this._shadowUBO[Yp.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=p.m11,this._shadowUBO[Yp.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=p.m15,this._shadowUBO[Yp.SHADOW_PROJ_INFO_OFFSET+0]=f.m00,this._shadowUBO[Yp.SHADOW_PROJ_INFO_OFFSET+1]=f.m05,this._shadowUBO[Yp.SHADOW_PROJ_INFO_OFFSET+2]=1/f.m00,this._shadowUBO[Yp.SHADOW_PROJ_INFO_OFFSET+3]=1/f.m05,bn.toArray(this._shadowUBO,r.shadowColor,Yp.SHADOW_COLOR_OFFSET),o.has(h)){var d,m=null===(d=o.get(h))||void 0===d?void 0:d.colorTextures[0];m&&_.bindTexture(rd,m)}}_.update(),e.updateBuffer(_.getBuffer(Yp.BINDING),this._shadowUBO)}}},e._updateUBOs=function(t,e){var n=t.exposure,i=this._pipeline.pipelineSceneData,r=i.isHDR,o=i.shadows,a=i.validPunctualLights;a.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=mn(a.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new ur(this._lightBuffer,0,hd.SIZE)));for(var s=0,c=0;s<a.length;s++,c+=this._lightBufferElementCount){var l=a[s];switch(l.type){case $g.SPHERE:if(En.toArray(TC,l.position),TC[3]=0,this._lightBufferData.set(TC,c+hd.LIGHT_POS_OFFSET),TC[0]=l.size,TC[1]=l.range,TC[2]=0,TC[3]=o.enabled&&o.type===pg.ShadowMap?1:0,this._lightBufferData.set(TC,c+hd.LIGHT_SIZE_RANGE_ANGLE_OFFSET),En.toArray(TC,l.color),l.useColorTemperature){var u=l.colorTemperatureRGB;TC[0]*=u.x,TC[1]*=u.y,TC[2]*=u.z}TC[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(TC,c+hd.LIGHT_COLOR_OFFSET);break;case $g.SPOT:if(En.toArray(TC,l.position),TC[3]=1,this._lightBufferData.set(TC,c+hd.LIGHT_POS_OFFSET),TC[0]=l.size,TC[1]=l.range,TC[2]=l.spotAngle,TC[3]=o.enabled&&o.type===pg.ShadowMap?1:0,this._lightBufferData.set(TC,c+hd.LIGHT_SIZE_RANGE_ANGLE_OFFSET),En.toArray(TC,l.direction),this._lightBufferData.set(TC,c+hd.LIGHT_DIR_OFFSET),En.toArray(TC,l.color),l.useColorTemperature){var h=l.colorTemperatureRGB;TC[0]*=h.x,TC[1]*=h.y,TC[2]*=h.z}TC[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(TC,c+hd.LIGHT_COLOR_OFFSET)}}e.updateBuffer(this._lightBuffer,this._lightBufferData)},t}(),XC=new ks,YC=function(){function t(t){this._pendingModels=[],this._castModels=[],this._instancedQueue=new XS,this._pipeline=void 0,this._pipeline=t}var e=t.prototype;return e.gatherShadowPasses=function(t,e){var n=this._pipeline.pipelineSceneData,i=(this._pipeline.pipelineUBO,n.shadows);if(this._instancedQueue.clear(),this._pendingModels.length=0,this._castModels.length=0,i.enabled&&i.type===pg.Planar&&!(i.normal.length()<1e-6)){var r=t.scene,o=t.frustum,a=0!=(t.visibility&Rp.BitMask.DEFAULT);if(r.mainLight&&a){for(var s=r.models,c=0;c<s.length;c++){var l=s[c];l.enabled&&l.node&&l.castShadow&&this._castModels.push(l)}var u=i.instancingMaterial.passes[0].getInstancedBuffer();this._instancedQueue.queue.add(u);for(var h=0;h<this._castModels.length;h++){var _=this._castModels[h];if(!_.worldBounds||(ks.transform(XC,_.worldBounds,i.matLight),cs.aabbFrustum(XC,o)))if(_.isInstancingEnabled)for(var f=_.subModels,p=0;p<f.length;p++){var d=f[p];u.merge(d,_.instancedAttributes,0,d.planarInstanceShader)}else this._pendingModels.push(_)}this._instancedQueue.uploadBuffers(e)}}},e.recordCommandBuffer=function(t,e,n){var i=this._pipeline.pipelineSceneData.shadows;if(i.enabled&&i.type===pg.Planar&&(this._instancedQueue.recordCommandBuffer(t,e,n),this._pendingModels.length)){var r=i.material.passes[0],o=r.descriptorSet;n.bindDescriptorSet(kp.MATERIAL,o);for(var a=this._pendingModels.length,s=0;s<a;s++)for(var c=this._pendingModels[s],l=0;l<c.subModels.length;l++){var u=c.subModels[l],h=u.planarShader,_=u.inputAssembler,f=Nv.getOrCreatePipelineState(t,r,h,e,_);n.bindPipelineState(f),n.bindDescriptorSet(kp.LOCAL,u.descriptorSet),n.bindInputAssembler(_),n.draw(_)}}},t}(),KC=function(){function t(){this._phaseID=Pv("default")}var e=t.prototype;return e.activate=function(t){this._pipeline=t},e.render=function(t,e){for(var n=this._pipeline,i=n.device,r=n.commandBuffers[0],o=t.scene.batches,a=0;a<o.length;a++){var s=o[a],c=!1;if(t.visibility&s.visFlags&&(c=!0),c)for(var l=s.shaders.length,u=0;u<l;u++){var h=s.passes[u];if(h.phase===this._phaseID){var _=s.shaders[u],f=s.inputAssembler,p=Nv.getOrCreatePipelineState(i,h,_,e,f);r.bindPipelineState(p),r.bindDescriptorSet(kp.MATERIAL,h.descriptorSet);var d=s.descriptorSet;r.bindDescriptorSet(kp.LOCAL,d),r.bindInputAssembler(f),r.draw(f)}}}},t}(),JC=[new or(0,0,0,1)],QC=t("ForwardStage",(NC=hc("ForwardStage"),LC=Wc([GS]),FC=zc(),NC((kC=UC=function(t){function e(){var e;return at(e=t.call(this)||this,"renderQueues",VC,it(e)),e._renderQueues=[],e._renderArea=new Qi,e._batchedQueue=void 0,e._instancedQueue=void 0,e._phaseID=Pv("default"),e._clearFlag=4294967295,e._batchedQueue=new qS,e._instancedQueue=new XS,e._uiPhase=new KC,e}Q(e,t);var n=e.prototype;return n.initialize=function(e){return t.prototype.initialize.call(this,e),e.renderQueues&&(this.renderQueues=e.renderQueues),!0},n.activate=function(e,n){t.prototype.activate.call(this,e,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=HS(this.renderQueues[i]);this._additiveLightQueue=new qC(this._pipeline),this._planarQueue=new YC(this._pipeline),this._uiPhase.activate(e)},n.destroy=function(){},n.render=function(t){this._instancedQueue.clear(),this._batchedQueue.clear();var e=this._pipeline,n=e.device;this._renderQueues.forEach(jS);for(var i=e.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var _=h[o];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===Av.INSTANCING){var p=_.getInstancedBuffer();p.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(p)}else if(f===Av.VB_MERGING){var d=_.getBatchedBuffer();d.merge(u,o,c.model),this._batchedQueue.queue.add(d)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(WS);var m=e.commandBuffers[0];e.pipelineUBO.updateShadowUBO(t),this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),this._additiveLightQueue.gatherLightPasses(t,m),this._planarQueue.gatherShadowPasses(t,m),t.clearFlag&Wi.COLOR&&(JC[0].x=t.clearColor.x,JC[0].y=t.clearColor.y,JC[0].z=t.clearColor.z,JC[0].w=t.clearColor.w),e.generateRenderArea(t,this._renderArea);var v=t.window.framebuffer,g=e.getRenderPass(t.clearFlag&this._clearFlag,v);m.beginRenderPass(g,v,this._renderArea,JC,t.clearDepth,t.clearStencil),m.bindDescriptorSet(kp.GLOBAL,e.descriptorSet),this._renderQueues[0].recordCommandBuffer(n,g,m),this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),this._additiveLightQueue.recordCommandBuffer(n,g,m),m.bindDescriptorSet(kp.GLOBAL,e.descriptorSet),this._planarQueue.recordCommandBuffer(n,g,m),this._renderQueues[1].recordCommandBuffer(n,g,m),this._uiPhase.render(t,g),Jv(n,g,m,e.profiler,t),m.endRenderPass()},e}(Ny),UC.initInfo={name:"ForwardStage",priority:Yy.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:NS.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:NS.BACK_TO_FRONT,stages:["default","planarShadow"]}]},VC=st((GC=kC).prototype,"renderQueues",[LC,vc,FC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zC=GC))||zC)),ZC=t("ForwardFlow",hc("ForwardFlow")((WC=jC=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._stages.length){var n=new QC;n.initialize(QC.initInfo),this._stages.push(n)}return!0},n.activate=function(e){t.prototype.activate.call(this,e)},n.render=function(e){t.prototype.render.call(this,e)},n.destroy=function(){t.prototype.destroy.call(this)},e}(Fy),jC.initInfo={name:Op,priority:Ky.FORWARD,stages:[]},HC=WC))||HC),$C=new Un,tA=new Un,eA=new Un,nA=new ks,iA=Pv("shadow-caster"),rA=[];function oA(t,e){e.length=0;for(var n=!1,i=0;i<t.length;i++){for(var r=t[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===iA){o=a,n=!0;break}e.push(o)}return n}var aA,sA,cA,lA,uA,hA,_A=function(){function t(t){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=t,this._instancedQueue=new XS,this._batchedQueue=new qS}var e=t.prototype;return e.gatherLightPasses=function(t,e,n,i){this.clear();var r=this._pipeline.pipelineSceneData,o=r.shadows;if(n&&o.enabled&&o.type===pg.ShadowMap){var a=r.dirShadowObjects,s=r.castShadowObjects;switch(n.type){case $g.DIRECTIONAL:for(var c=0;c<a.length;c++){var l=a[c].model;oA(l.subModels,rA)&&this.add(l,rA)}break;case $g.SPOT:Un.invert($C,n.node.getWorldMatrix()),Un.perspective(tA,n.angle,n.aspect,.001,n.range),Un.multiply(eA,tA,$C);for(var u=0;u<s.length;u++){var h=s[u].model;oA(h.subModels,rA)&&(h.worldBounds&&(ks.transform(nA,h.worldBounds,eA),!cs.aabbFrustum(nA,e.frustum))||this.add(h,rA))}}this._instancedQueue.uploadBuffers(i),this._batchedQueue.uploadBuffers(i)}},e.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()},e.add=function(t,e){for(var n=t.subModels,i=0;i<n.length;i++){var r=n[i],o=e[i],a=r.passes[o];if(a.batchingScheme===Av.INSTANCING){var s=a.getInstancedBuffer();s.merge(r,t.instancedAttributes,o),this._instancedQueue.queue.add(s)}else if(a.batchingScheme===Av.VB_MERGING){var c=a.getBatchedBuffer();c.merge(r,o,t),this._batchedQueue.queue.add(c)}else{var l=r.shaders[o];this._subModelsArray.push(r),l&&this._shaderArray.push(l),this._passArray.push(a)}}},e.recordCommandBuffer=function(t,e,n){this._instancedQueue.recordCommandBuffer(t,e,n),this._batchedQueue.recordCommandBuffer(t,e,n);for(var i=0;i<this._subModelsArray.length;++i){var r=this._subModelsArray[i],o=this._shaderArray[i],a=this._passArray[i],s=r.inputAssembler,c=Nv.getOrCreatePipelineState(t,a,o,e,s),l=a.descriptorSet;n.bindPipelineState(c),n.bindDescriptorSet(kp.MATERIAL,l),n.bindDescriptorSet(kp.LOCAL,r.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},t}(),fA=[new or(1,1,1,1)],pA=t("ShadowStage",hc("ShadowStage")((cA=sA=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._shadowFrameBuffer=null,e._renderArea=new Qi,e._light=null,e._globalDS=null,e}Q(e,t);var n=e.prototype;return n.setUsage=function(t,e,n){this._globalDS=t,this._light=e,this._shadowFrameBuffer=n},n.destroy=function(){var t;this._shadowFrameBuffer=null,this._globalDS=null,this._light=null,null===(t=this._additiveShadowQueue)||void 0===t||t.clear()},n.clearFramebuffer=function(t){if(this._light&&this._shadowFrameBuffer){fA[0].w=t.clearColor.w;var e=this._pipeline.commandBuffers[0],n=this._shadowFrameBuffer.renderPass;e.beginRenderPass(n,this._shadowFrameBuffer,this._renderArea,fA,t.clearDepth,t.clearStencil),e.endRenderPass()}},n.render=function(t){var e=this._pipeline,n=e.pipelineSceneData,i=n.shadows,r=n.shadingScale,o=this._globalDS,a=e.commandBuffers[0];if(this._light&&this._shadowFrameBuffer){this._pipeline.pipelineUBO.updateShadowUBOLight(o,this._light),this._additiveShadowQueue.gatherLightPasses(o,t,this._light,a);var s=t.viewport,c=i.size;this._renderArea.x=s.x*c.x,this._renderArea.y=s.y*c.y,this._renderArea.width=s.width*c.x*r,this._renderArea.height=s.height*c.y*r;var l=e.device,u=this._shadowFrameBuffer.renderPass;a.beginRenderPass(u,this._shadowFrameBuffer,this._renderArea,fA,t.clearDepth,t.clearStencil),a.bindDescriptorSet(kp.GLOBAL,o),this._additiveShadowQueue.recordCommandBuffer(l,u,a),a.endRenderPass()}},n.activate=function(e,n){t.prototype.activate.call(this,e,n),this._additiveShadowQueue=new _A(e)},e}(Ny),sA.initInfo={name:"ShadowStage",priority:Yy.FORWARD,tag:0},aA=cA))||aA),dA=[],mA=t("ShadowFlow",hc("ShadowFlow")((hA=uA=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._shadowRenderPass=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._stages.length){var n=new pA;n.initialize(pA.initInfo),this._stages.push(n)}return!0},n.render=function(t){var e=this._pipeline,n=e.pipelineSceneData.shadows,i=e.pipelineSceneData.shadowFrameBufferMap,r=e.pipelineSceneData.castShadowObjects,o=this._pipeline.pipelineSceneData.validPunctualLights;if(n.enabled&&n.type===pg.ShadowMap){for(var a=0,s=0;a<n.maxReceived&&s<o.length;){var c=o[s];c.type===$g.SPOT&&(dA.push(c),a++),s++}if(0!==r.length){n.shadowMapDirty&&this.resizeShadowMap();var l=t.scene.mainLight;if(l){var u=e.descriptorSet;i.has(l)||this._initShadowFrameBuffer(e,l,t.window.swapchain);for(var h=i.get(l),_=0;_<this._stages.length;_++){var f=this._stages[_];f.setUsage(u,l,h),f.render(t)}}for(var p=0;p<dA.length;p++){var d=dA[p],m=e.globalDSManager.getOrCreateDescriptorSet(p);i.has(d)||this._initShadowFrameBuffer(e,d,t.window.swapchain);for(var v=i.get(d),g=0;g<this._stages.length;g++){var y=this._stages[g];y.setUsage(m,d,v),y.render(t)}}dA.length=0}else this.clearShadowMap(dA,t)}},n.destroy=function(){if(t.prototype.destroy.call(this),this._pipeline){for(var e=this._pipeline.pipelineSceneData.shadowFrameBufferMap,n=Array.from(e.values()),i=0;i<n.length;i++){var r=n[i];if(r){for(var o=r.colorTextures,a=0;a<o.length;a++){var s=o[i];s&&s.destroy()}o.length=0;var c=r.depthStencilTexture;c&&c.destroy(),r.destroy()}}e.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()},n._initShadowFrameBuffer=function(t,e){var n=t.device,i=t.pipelineSceneData.shadows.size,r=t.pipelineSceneData.shadowFrameBufferMap,o=Yd(n)?ui.R32F:ui.RGBA8;if(!this._shadowRenderPass){var a=new Ir;a.format=o,a.loadOp=Ri.CLEAR,a.storeOp=Di.STORE,a.sampleCount=1;var s=new Rr;s.format=ui.DEPTH_STENCIL,s.depthLoadOp=Ri.CLEAR,s.depthStoreOp=Di.DISCARD,s.stencilLoadOp=Ri.CLEAR,s.stencilStoreOp=Di.DISCARD,s.sampleCount=1;var c=new Mr([a],s);this._shadowRenderPass=n.createRenderPass(c)}var l=[];l.push(n.createTexture(new pr(vi.TEX2D,gi.COLOR_ATTACHMENT|gi.SAMPLED,o,i.x,i.y)));var u=n.createTexture(new pr(vi.TEX2D,gi.DEPTH_STENCIL_ATTACHMENT,ui.DEPTH_STENCIL,i.x,i.y)),h=n.createFramebuffer(new Lr(this._shadowRenderPass,l,u));r.set(e,h)},n.clearShadowMap=function(t,e){var n=this._pipeline,i=n.pipelineSceneData,r=e.scene.mainLight;if(r){var o=this._pipeline.descriptorSet;i.shadowFrameBufferMap.has(r)||this._initShadowFrameBuffer(this._pipeline,r,e.window.swapchain);for(var a=i.shadowFrameBufferMap.get(r),s=0;s<this._stages.length;s++){var c=this._stages[s];c.setUsage(o,r,a),c.render(e)}}for(var l=0;l<t.length;l++){var u=t[l],h=i.shadowFrameBufferMap.get(u),_=n.globalDSManager.getOrCreateDescriptorSet(l);if(i.shadowFrameBufferMap.has(u))for(var f=0;f<this._stages.length;f++){var p=this._stages[f];p.setUsage(_,u,h),p.clearFramebuffer(e)}}},n.resizeShadowMap=function(){for(var t=this._pipeline.pipelineSceneData.shadows,e=t.size,n=this._pipeline,i=n.device,r=n.pipelineSceneData.shadowFrameBufferMap,o=Yd(i)?ui.R32F:ui.RGBA8,a=r.values(),s=a.next();!s.done;){var c=s.value;if(c){var l=[];l.push(n.device.createTexture(new pr(vi.TEX2D,gi.COLOR_ATTACHMENT|gi.SAMPLED,o,e.x,e.y)));var u=c.depthStencilTexture;u&&u.resize(e.x,e.y);var h=c.renderPass;c.destroy(),c.initialize(new Lr(h,l,u)),s=a.next()}else s=a.next()}t.shadowMapDirty=!1},e}(Fy),uA.initInfo={name:Np,priority:Ky.SHADOW,tag:DS.SCENE,stages:[]},lA=hA))||lA),vA=new Kn,gA=ie({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),yA=gA.LAYERED+1,xA=function(){function t(){this._fogColor=new bn("#C8C8C8"),this._colorArray=new Kn(.2,.2,.2,1),this._enabled=!1,this._accurate=!1,this._type=0,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2}var e=t.prototype;return e._setType=function(t){this._type=this.enabled?t:yA},e._setEnable=function(t){this._enabled=t},e._setAccurate=function(t){this._accurate=t},e.initialize=function(t){this.fogColor=t.fogColor,this._setEnable(t.enabled),this._setAccurate(t.accurate),this._setType(t.type),this.fogDensity=t.fogDensity,this.fogStart=t.fogStart,this.fogEnd=t.fogEnd,this.fogAtten=t.fogAtten,this.fogTop=t.fogTop,this.fogRange=t.fogRange},e.activate=function(){this._updatePipeline()},e._updatePipeline=function(){var t=c.director.root,e=this.enabled?this.type:yA,n=this.accurate?1:0,i=t.pipeline;i.macros.CC_USE_FOG===e&&i.macros.CC_USE_ACCURATE_FOG===n||(i.macros.CC_USE_FOG=e,i.macros.CC_USE_ACCURATE_FOG=n,t.onGlobalPipelineStateChanged())},e._destroy=function(){},e.destroy=function(){this._destroy()},K(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._setEnable(t),t?this.activate():(this._type=yA,this._updatePipeline())}},{key:"accurate",get:function(){return this._accurate},set:function(t){this._setAccurate(t),this._updatePipeline()}},{key:"fogColor",get:function(){return this._fogColor},set:function(t){this._fogColor.set(t),vA.set(t.x,t.y,t.z,t.w),zv(this._colorArray,vA)}},{key:"type",get:function(){return this._type},set:function(t){this._setType(t),this.enabled&&this._updatePipeline()}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(t){this._fogDensity=t}},{key:"fogStart",get:function(){return this._fogStart},set:function(t){this._fogStart=t}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(t){this._fogEnd=t}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(t){this._fogAtten=t}},{key:"fogTop",get:function(){return this._fogTop},set:function(t){this._fogTop=t}},{key:"fogRange",get:function(){return this._fogRange},set:function(t){this._fogRange=t}},{key:"colorArray",get:function(){return this._colorArray}},{key:"native",get:function(){return this._nativeObj}}]),t}();function SA(t,e){for(var n,i=ot(e);!(n=i()).done;){var r=n.value;Array.isArray(r)?SA(t,r):t.push(r)}}function CA(t){var e=[];return SA(e,t),e.join("")}c.Fog=xA;var AA=ul.Flags.Destroyed,bA=ul.Flags.PersistentMask,TA=Je.IDENTIFIER_RE,EA="var ",wA="o",PA={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},IA=Je.escapeForJS,RA=function(){function t(t,e){this.varName=void 0,this.expression=void 0,this.varName=t,this.expression=e}return t.prototype.toString=function(){return EA+this.varName+"="+this.expression+";"},t}();function DA(t,e){return e instanceof RA?new RA(e.varName,t+e.expression):t+e}function BA(t,e,n){Array.isArray(n)?(n[0]=DA(e,n[0]),t.push(n)):t.push(DA(e,n)+";")}var MA=function(){function t(t){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=t}var e=t.prototype;return e.append=function(t,e){this._exps.push([t,e])},e.writeCode=function(t){var e;if(this._exps.length>1)t.push("t="+this._targetExp+";"),e="t";else{if(1!==this._exps.length)return;e=this._targetExp}for(var n=0;n<this._exps.length;n++){var i=this._exps[n];BA(t,e+OA(i[0])+"=",i[1])}},t}();function OA(t){return TA.test(t)?"."+t:"["+IA(t)+"]"}MA.pool=void 0,MA.pool=new $t((function(t){t._exps.length=0,t._targetExp=null}),1),MA.pool.get=function(t){var e=this._get()||new MA;return e._targetExp=t,e};var NA=function(){function t(t,e){var n;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=e,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=Et(),Ft(this.funcModuleCache,PA),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(t.constructor,!0)+"();","}"),t._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(t),this.enumerateObject(this.codeArray,t),this.globalVariables.length>0&&(n=EA+this.globalVariables.join(",")+";");var i=CA(["return (function(R){",n||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",i)(this.objs,this.funcs);for(var r=0,o=this.objsToClear_iN$t.length;r<o;++r)this.objsToClear_iN$t[r]._iN$t=null;this.objsToClear_iN$t.length=0}var e=t.prototype;return e.getFuncModule=function(t,e){var n=wt(t);if(n){var i=this.funcModuleCache[n];if(i)return i;if(void 0===i){var r=-1!==n.indexOf(".");if(r)try{if(r=t===Function("return "+n)())return this.funcModuleCache[n]=n,n}catch(t){}}}var o=this.funcs.indexOf(t);o<0&&(o=this.funcs.length,this.funcs.push(t));var a="F["+o+"]";return e&&(a="("+a+")"),this.funcModuleCache[n]=a,a},e.getObjRef=function(t){var e=this.objs.indexOf(t);return e<0&&(e=this.objs.length,this.objs.push(t)),"O["+e+"]"},e.setValueType=function(t,e,n,i){var r=MA.pool.get(i),o=e.constructor.__props__;o||(o=Object.keys(e));for(var a=0;a<o.length;a++){var s=o[a],c=n[s];if(e[s]!==c){var l=this.enumerateField(n,s,c);r.append(s,l)}}r.writeCode(t),MA.pool.put(r)},e.enumerateCCClass=function(t,e,n){for(var i=n.__values__,r=we(n),o=0;o<i.length;o++){var a=i[o],s=e[a],l=r[a+"$_$default"];if(!LA(l,s))if("object"==typeof s&&s instanceof c.ValueType&&(l=Je.getDefault(l))&&l.constructor===s.constructor){var u=wA+OA(a);this.setValueType(t,l,s,u)}else this.setObjProp(t,e,a,s)}},e.instantiateArray=function(t){if(0===t.length)return"[]";var e="a"+ ++this.localVariableId,n=[new RA(e,"new Array("+t.length+")")];t._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(t);for(var i=0;i<t.length;++i)BA(n,e+"["+i+"]=",this.enumerateField(t,i,t[i]));return n},e.instantiateTypedArray=function(t){var e=t.constructor.name;if(0===t.length)return"new "+e;var n="a"+ ++this.localVariableId,i=[new RA(n,"new "+e+"("+t.length+")")];t._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(t);for(var r=0;r<t.length;++r)0!==t[r]&&BA(i,n+"["+r+"]=",t[r]);return i},e.enumerateField=function(t,e,n){if("object"==typeof n&&n){var i=n._iN$t;if(i){var r=i.globalVar;if(!r){r=i.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r);var o=i.source[0];i.source[0]=DA(r+"=",o)}return r}return ArrayBuffer.isView(n)?this.instantiateTypedArray(n):Array.isArray(n)?this.instantiateArray(n):this.instantiateObj(n)}return"function"==typeof n?this.getFuncModule(n):"string"==typeof n?IA(n):("_objFlags"===e&&t instanceof ul&&(n&=bA),n)},e.setObjProp=function(t,e,n,i){BA(t,wA+OA(n)+"=",this.enumerateField(e,n,i))},e.enumerateObject=function(t,e){var n=e.constructor;if(c.Class._isCCClass(n))this.enumerateCCClass(t,e,n);else for(var i in e)if(e.hasOwnProperty(i)&&(95!==i.charCodeAt(0)||95!==i.charCodeAt(1)||"__type__"===i)){var r=e[i];"object"==typeof r&&r&&r===e._iN$t||this.setObjProp(t,e,i,r)}},e.instantiateObj=function(t){if(t instanceof c.ValueType)return Je.getNewValueTypeCode(t);if(t instanceof c.Asset)return this.getObjRef(t);if(t._objFlags&AA)return null;var e,n=t.constructor;if(c.Class._isCCClass(n)){if(this.parent)if(this.parent instanceof c.Component){if(t instanceof c._BaseNode||t instanceof c.Component)return this.getObjRef(t)}else if(this.parent instanceof c._BaseNode)if(t instanceof c._BaseNode){if(!t.isChildOf(this.parent))return this.getObjRef(t)}else if(t instanceof c.Component){var i;if(!(null===(i=t.node)||void 0===i?void 0:i.isChildOf(this.parent)))return this.getObjRef(t)}e=new RA(wA,"new "+this.getFuncModule(n,!0)+"()")}else if(n===Object)e=new RA(wA,"{}");else{if(n)return this.getObjRef(t);e=new RA(wA,"Object.create(null)")}var r=[e];return t._iN$t={globalVar:"",source:r},this.objsToClear_iN$t.push(t),this.enumerateObject(r,t),["(function(){",r,"return o;})();"]},t}();function LA(t,e){if("function"==typeof t)try{t=t()}catch(t){return!1}if(t===e)return!0;if(t&&e&&"object"==typeof t&&"object"==typeof e&&t.constructor===e.constructor)if(t instanceof c.ValueType){if(t.equals(e))return!0}else{if(Array.isArray(t))return 0===t.length&&0===e.length;if(t.constructor===Object)return xt(t)&&xt(e)}return!1}var FA,zA,GA,VA,UA,kA,HA,jA,WA,qA,XA=function(){function t(t){this._uiComp=null,this._opacity=1,this._localOpacity=1,this.colorDirty=!0,this._uiTransformComp=null,this._node=void 0,this._node=t}return t.prototype.applyOpacity=function(t){this._opacity=this._localOpacity*t},t.markOpacityTree=function(){},K(t,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp},set:function(t){this._uiTransformComp=t}},{key:"uiComp",get:function(){return this._uiComp},set:function(t){this._uiComp&&t?I(12002):this._uiComp=t}},{key:"opacity",get:function(){return this._opacity}},{key:"localOpacity",get:function(){return this._localOpacity},set:function(t){this._localOpacity=t,this.colorDirty=!0}}]),t}();ul.Flags.Destroying,function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.MOUSE_ENTER="mouse-enter",t.MOUSE_LEAVE="mouse-leave",t.KEY_DOWN="keydown",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion",t.TRANSFORM_CHANGED="transform-changed",t.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",t.SIZE_CHANGED="size-changed",t.ANCHOR_CHANGED="anchor-changed",t.COLOR_CHANGED="color-changed",t.CHILD_ADDED="child-added",t.CHILD_REMOVED="child-removed",t.PARENT_CHANGED="parent-changed",t.NODE_DESTROYED="node-destroyed",t.LAYER_CHANGED="layer-changed",t.SIBLING_ORDER_CHANGED="sibling-order-changed",t.ACTIVE_IN_HIERARCHY_CHANGED="active-in-hierarchy-changed"}(FA||(FA={}));var YA=ul.Flags.Destroying,KA=ul.Flags.DontDestroy,JA=ul.Flags.Deactivating,QA=new pt("Node");function ZA(t){return t?"string"==typeof t?Qt(t):t:(D(3804),null)}var $A,tb,eb,nb,ib,rb,ob,ab,sb,cb,lb,ub=t("BaseNode",hc("cc.BaseNode")((qA=WA=function(t){Q(n,t),n._setScene=function(t){t._updateScene()},n._findComponent=function(t,e){var n=e,i=t._components;if(n._sealed)for(var r=0;r<i.length;++r){var o=i[r];if(o.constructor===e)return o}else for(var a=0;a<i.length;++a){var s=i[a];if(s instanceof e)return s}return null},n._findComponents=function(t,e,n){var i=e,r=t._components;if(i._sealed)for(var o=0;o<r.length;++o){var a=r[o];a.constructor===e&&n.push(a)}else for(var s=0;s<r.length;++s){var c=r[s];c instanceof e&&n.push(c)}},n._findChildComponent=function(t,e){for(var i=0;i<t.length;++i){var r=t[i],o=n._findComponent(r,e);if(o)return o;if(r._children.length>0&&(o=n._findChildComponent(r._children,e)))return o}return null},n._findChildComponents=function(t,e,i){for(var r=0;r<t.length;++r){var o=t[r];n._findComponents(o,e,i),o._children.length>0&&n._findChildComponents(o._children,e,i)}};var e=n.prototype;function n(e){var n;return at(n=t.call(this,e)||this,"_parent",VA,it(n)),at(n,"_children",UA,it(n)),at(n,"_active",kA,it(n)),at(n,"_components",HA,it(n)),at(n,"_prefab",jA,it(n)),n._scene=null,n._activeInHierarchy=!1,n._id=QA.getNewId(),n._name=void 0,n._eventProcessor=new c.NodeEventProcessor(it(n)),n._eventMask=0,n._siblingIndex=0,n._originalSceneId="",n._registerIfAttached=void 0,n._name=void 0!==e?e:"New Node",n}return e._updateScene=function(){null==this._parent?x("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene},e.attr=function(t){Ft(this,t)},e.getParent=function(){return this._parent},e.setParent=function(t,e){if(void 0===e&&(e=!1),this._parent!==t){var n=this._parent,i=t;if(this._parent=i,this._siblingIndex=0,this._onSetParent(n,e),this.emit&&this.emit(FA.PARENT_CHANGED,n),n&&!(n._objFlags&YA)){var r=n._children.indexOf(this);n._children.splice(r,1),n._updateSiblingIndex(),n.emit&&n.emit(FA.CHILD_REMOVED,this)}i&&(i._children.push(this),this._siblingIndex=i._children.length-1,i.emit&&i.emit(FA.CHILD_ADDED,this)),this._onHierarchyChanged(n)}},e.getChildByUuid=function(t){if(!t)return g("Invalid uuid"),null;for(var e=this._children,n=0,i=e.length;n<i;n++)if(e[n]._id===t)return e[n];return null},e.getChildByName=function(t){if(!t)return g("Invalid name"),null;for(var e=this._children,n=0,i=e.length;n<i;n++)if(e[n]._name===t)return e[n];return null},e.getChildByPath=function(t){for(var e=t.split("/"),n=this,i=function(t){var i=e[t];if(0===i.length)return"continue";var r=n.children.find((function(t){return t.name===i}));if(!r)return{v:null};n=r},r=0;r<e.length;++r){var o=i(r);if("continue"!==o&&"object"==typeof o)return o.v}return n},e.addChild=function(t){t.setParent(this)},e.insertChild=function(t,e){t.parent=this,t.setSiblingIndex(e)},e.getSiblingIndex=function(){return this._siblingIndex},e.setSiblingIndex=function(t){if(this._parent)if(this._parent._objFlags&JA)D(3821);else{var e=this._parent._children;t=-1!==t?t:e.length-1;var n=e.indexOf(this);t!==n&&(e.splice(n,1),t<e.length?e.splice(t,0,this):e.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(t))}},e.walk=function(t,e){var i=1,r=null,o=null,a=0,s=n._stacks[n._stackId];s||(s=[],n._stacks.push(s)),n._stackId++,s.length=0,s[0]=this;for(var c=null,l=!1;i;)if(o=s[--i])if(!l&&t?t(o):l&&e&&e(o),s[i]=null,l){if(c===this._parent)break;if(l=!1,r)if(r[++a])s[i]=r[a],i++;else if(c&&(s[i]=c,i++,l=!0,c._parent?(a=(r=c._parent._children).indexOf(c),c=c._parent):(c=null,r=null),a<0))break}else o._children.length>0?(c=o,r=o._children,a=0,s[i]=r[a],i++):(s[i]=o,i++,l=!0);s.length=0,n._stackId--},e.removeFromParent=function(){this._parent&&this._parent.removeChild(this)},e.removeChild=function(t){this._children.indexOf(t)>-1&&(t.parent=null)},e.removeAllChildren=function(){for(var t=this._children,e=t.length-1;e>=0;e--){var n=t[e];n&&(n.parent=null)}this._children.length=0},e.isChildOf=function(t){var e=this;do{if(e===t)return!0;e=e._parent}while(e);return!1},e.getComponent=function(t){var e=ZA(t);return e?n._findComponent(this,e):null},e.getComponents=function(t){var e=ZA(t),i=[];return e&&n._findComponents(this,e,i),i},e.getComponentInChildren=function(t){var e=ZA(t);return e?n._findChildComponent(this._children,e):null},e.getComponentsInChildren=function(t){var e=ZA(t),i=[];return e&&(n._findComponents(this,e,i),n._findChildComponents(this._children,e,i)),i},e.addComponent=function(t){var e;if("string"==typeof t){if(!(e=Qt(t)))throw c._RF.peek()&&D(3808,t),TypeError(N(3807,t))}else{if(!t)throw TypeError(N(3804));e=t}if("function"!=typeof e)throw TypeError(N(3809));if(!Vt(e,c.Component))throw TypeError(N(3810));var n=e._requireComponent;if(n)if(Array.isArray(n))for(var i=0;i<n.length;i++){var r=n[i];this.getComponent(r)||this.addComponent(r)}else{var o=n;this.getComponent(o)||this.addComponent(o)}var a=new e;return a.node=this,this._components.push(a),this._activeInHierarchy&&c.director._nodeActivator.activateComp(a),a},e.removeComponent=function(t){if(t){var e=null;(e=t instanceof Ku?t:this.getComponent(t))&&e.destroy()}else D(3813)},e.on=function(t,e,n,i){switch(void 0===i&&(i=!1),t){case FA.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(t,e,n,i)},e.off=function(t,e,n,i){if(void 0===i&&(i=!1),this._eventProcessor.off(t,e,n,i),!this._eventProcessor.hasEventListener(t))switch(t){case FA.TRANSFORM_CHANGED:this._eventMask&=-2}},e.once=function(t,e,n,i){this._eventProcessor.once(t,e,n,i)},e.emit=function(t,e,n,i,r,o){this._eventProcessor.emit(t,e,n,i,r,o)},e.dispatchEvent=function(t){this._eventProcessor.dispatchEvent(t)},e.hasEventListener=function(t,e,n){return this._eventProcessor.hasEventListener(t,e,n)},e.targetOff=function(t){this._eventProcessor.targetOff(t),1&this._eventMask&&!this._eventProcessor.hasEventListener(FA.TRANSFORM_CHANGED)&&(this._eventMask&=-2)},e.destroy=function(){return!!t.prototype.destroy.call(this)&&(this.active=!1,!0)},e.destroyAllChildren=function(){for(var t=this._children,e=0;e<t.length;++e)t[e].destroy()},e._removeComponent=function(t){if(t){if(!(this._objFlags&YA)){var e=this._components.indexOf(t);-1!==e?this._components.splice(e,1):t.node!==this&&D(3815)}}else D(3814)},e._updateSiblingIndex=function(){for(var t=0;t<this._children.length;++t)this._children[t]._siblingIndex=t;this.emit(FA.SIBLING_ORDER_CHANGED)},e._onSetParent=function(t){this._parent&&(null!=t&&t._scene===this._parent._scene||null==this._parent._scene||this.walk(n._setScene))},e._onPostActivated=function(){},e._onBatchCreated=function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))},e._onPreDestroy=function(){this._onPreDestroyBase()},e._onHierarchyChanged=function(t){return this._onHierarchyChangedBase(t)},e._instantiate=function(t,e){return t||(t=c.instantiate._clone(this,this)),t._prefab,t._parent=null,t._onBatchCreated(e),t},e._onHierarchyChangedBase=function(){var t=this._parent;!this._persistNode||t instanceof c.Scene||c.game.removePersistRootNode(this);var e=this._active&&!(!t||!t._activeInHierarchy);this._activeInHierarchy!==e&&c.director._nodeActivator.activateNode(this,e)},e._onPreDestroyBase=function(){this._objFlags|=YA;var t=this._parent,e=!!t&&0!=(t._objFlags&YA);if(this._persistNode&&c.game.removePersistRootNode(this),!e&&t){this.emit(FA.PARENT_CHANGED,this);var n=t._children.indexOf(this);t._children.splice(n,1),this._siblingIndex=0,t._updateSiblingIndex(),t.emit&&t.emit(FA.CHILD_REMOVED,this)}this.emit(FA.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var i=this._children,r=0;r<i.length;++r)i[r]._destroyImmediate();for(var o=this._components,a=0;a<o.length;++a)o[a]._destroyImmediate();return e},K(n,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&KA)>0},set:function(t){t?this._objFlags|=KA:this._objFlags&=~KA}},{key:"name",get:function(){return this._name},set:function(t){this._name=t}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(t){if(this._active!==t){this._active=t;var e=this._parent;e&&e._activeInHierarchy&&c.director._nodeActivator.activateNode(this,t)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(t){this.setParent(t)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}]),n}(ul),WA.idGenerator=QA,WA._stacks=[[]],WA._stackId=0,st((GA=qA).prototype,"_persistNode",[dc],Object.getOwnPropertyDescriptor(GA.prototype,"_persistNode"),GA.prototype),st(GA.prototype,"name",[Pc],Object.getOwnPropertyDescriptor(GA.prototype,"name"),GA.prototype),st(GA.prototype,"children",[Pc],Object.getOwnPropertyDescriptor(GA.prototype,"children"),GA.prototype),st(GA.prototype,"active",[Pc],Object.getOwnPropertyDescriptor(GA.prototype,"active"),GA.prototype),st(GA.prototype,"activeInHierarchy",[Pc],Object.getOwnPropertyDescriptor(GA.prototype,"activeInHierarchy"),GA.prototype),st(GA.prototype,"parent",[Pc],Object.getOwnPropertyDescriptor(GA.prototype,"parent"),GA.prototype),VA=st(GA.prototype,"_parent",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),UA=st(GA.prototype,"_children",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kA=st(GA.prototype,"_active",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),HA=st(GA.prototype,"_components",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jA=st(GA.prototype,"_prefab",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zA=GA))||zA);c._BaseNode=ub;var hb=new En,_b=new Mn,fb=new Mn,pb=new Mn,db=new Rn,mb=new Rn,vb=new Un,gb=[],yb=[],xb=[],Sb=function(){function t(){this._chunks=[],this._freelists=[],this._createChunk()}var e=t.prototype;return e.alloc=function(){for(var t=this._freelists.length,e=0;e<t;++e)if(this._freelists[e].length)return this._createView(e);return this._createChunk(),this._createView(t)},e.free=function(t,e){for(var n=this._freelists.length,i=0;i<n;++i)if(this._chunks[i]===t)return void this._freelists[i].push(e)},e.clear=function(){for(var t=this._chunks.length,e=0;e<t;++e)this._chunks[e].fill(0)},e._createChunk=function(){this._chunks.push(new Uint32Array(t.CAPACITY_PER_CHUNK));for(var e=[],n=t.CAPACITY_PER_CHUNK-1;n>=0;n--)e.push(n);this._freelists.push(e)},e._createView=function(t){return xb[0]=this._chunks[t],xb[1]=this._freelists[t].pop(),xb},t}();Sb.CAPACITY_PER_CHUNK=256;var Cb,Ab,bb,Tb,Eb,wb,Pb,Ib,Rb,Db,Bb,Mb,Ob,Nb,Lb,Fb,zb,Gb,Vb,Ub,kb,Hb,jb,Wb,qb,Xb,Yb,Kb,Jb,Qb,Zb,$b,tT,eT,nT,iT,rT,oT,aT,sT,cT,lT,uT,hT,_T,fT,pT,dT,mT,vT,gT,yT,xT,ST,CT,AT,bT,TT,ET,wT,PT,IT,RT,DT,BT,MT,OT,NT,LT,FT=new Sb,zT=Symbol("ReserveContentsForAllSyncablePrefab"),GT=t("Node",($A=hc("cc.Node"),tb=Wc(En),$A((lb=cb=function(t){Q(n,t);var e=n.prototype;function n(e){var n;return(n=t.call(this,e)||this)._uiProps=new XA(it(n)),n._static=!1,at(n,"_lpos",ib,it(n)),at(n,"_lrot",rb,it(n)),at(n,"_lscale",ob,it(n)),at(n,"_layer",ab,it(n)),at(n,"_euler",sb,it(n)),n._dirtyFlagsPri=Zg.NONE,n._eulerDirty=!1,n._nodeHandle=0,n._init(),n}return e._init=function(){var t=FT.alloc(),e=t[0],n=t[1];this._hasChangedFlagsChunk=e,this._hasChangedFlagsOffset=n;var i=new Uint32Array(e.buffer,e.byteOffset+4*n,1);this._hasChangedFlags=i,this._pos=new En,this._rot=new Mn,this._scale=new En(1,1,1),this._mat=new Un},n.isNode=function(t){return t instanceof n&&(t.constructor===n||!(t instanceof c.Scene))},e._onPreDestroy=function(){var t=this._onPreDestroyBase();return FT.free(this._hasChangedFlagsChunk,this._hasChangedFlagsOffset),t},e[ah]=function(t){t.writeThis()},e.setParent=function(e,n){void 0===n&&(n=!1),n&&this.updateWorldTransform(),t.prototype.setParent.call(this,e,n)},e._onSetParent=function(e,n){if(t.prototype._onSetParent.call(this,e,n),n){var i=this._parent;i?(i.updateWorldTransform(),Un.multiply(vb,Un.invert(vb,i._mat),this._mat),Un.toRTS(vb,this._lrot,this._lpos,this._lscale)):(En.copy(this._lpos,this._pos),Mn.copy(this._lrot,this._rot),En.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(Zg.TRS)},e._onHierarchyChanged=function(e){this.eventProcessor.reattach(),t.prototype._onHierarchyChangedBase.call(this,e)},e._onBatchCreated=function(t){this.hasChangedFlags=Zg.TRS,this._dirtyFlags|=Zg.TRS;for(var e=this._children.length,n=0;n<e;++n)this._children[n]._siblingIndex=n,this._children[n]._onBatchCreated(t)},e._onBeforeSerialize=function(){this.eulerAngles},e._onPostActivated=function(t){t?(this._eventProcessor.setEnabled(!0),this.invalidateChildren(Zg.TRS),this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.setTextureDirty(),this._uiProps.uiComp.markForUpdateRenderData())):this._eventProcessor.setEnabled(!1)},e.translate=function(t,e){var n=e||Qg.LOCAL;if(n===Qg.LOCAL)En.transformQuat(hb,t,this._lrot),this._lpos.x+=hb.x,this._lpos.y+=hb.y,this._lpos.z+=hb.z;else if(n===Qg.WORLD)if(this._parent){Mn.invert(_b,this._parent.worldRotation),En.transformQuat(hb,t,_b);var i=this.worldScale;this._lpos.x+=hb.x/i.x,this._lpos.y+=hb.y/i.y,this._lpos.z+=hb.z/i.z}else this._lpos.x+=t.x,this._lpos.y+=t.y,this._lpos.z+=t.z;this.invalidateChildren(Zg.POSITION),1&this._eventMask&&this.emit(FA.TRANSFORM_CHANGED,Zg.POSITION)},e.rotate=function(t,e){var n=e||Qg.LOCAL;if(Mn.normalize(_b,t),n===Qg.LOCAL)Mn.multiply(this._lrot,this._lrot,_b);else if(n===Qg.WORLD){var i=this.worldRotation;Mn.multiply(fb,_b,i),Mn.invert(_b,i),Mn.multiply(fb,_b,fb),Mn.multiply(this._lrot,this._lrot,fb)}this._eulerDirty=!0,this.invalidateChildren(Zg.ROTATION),1&this._eventMask&&this.emit(FA.TRANSFORM_CHANGED,Zg.ROTATION)},e.lookAt=function(t,e){this.getWorldPosition(hb),En.subtract(hb,hb,t),En.normalize(hb,hb),Mn.fromViewUp(_b,hb,e),this.setWorldRotation(_b)},e._setDirtyNode=function(t,e){gb[t]=e},e.invalidateChildren=function(t){var e,n,i,r=0,o=0,a=0,s=0,c=0,l=t|Zg.POSITION;for(gb[0]=this;r>=0;){if(c=(e=gb[r--])._hasChangedFlags[0],s=e._dirtyFlagsPri,e.isValid&&(s&c&t)!==t)for(s|=t,e._dirtyFlagsPri=s,e._hasChangedFlags[0]=c|t,a=(i=e._children).length,o=0;o<a;o++)n=i[o],gb[++r]=n;t=l}},e.updateWorldTransform=function(){if(this._dirtyFlags){for(var t,e=this,n=0;e&&e._dirtyFlags;)this._setDirtyNode(n++,e),e=e._parent;for(var i=0;n;)i|=(t=gb[--n])._dirtyFlags,e?(i&Zg.POSITION&&(En.transformMat4(t._pos,t._lpos,e._mat),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z),i&Zg.RS&&(Un.fromRTS(t._mat,t._lrot,t._lpos,t._lscale),Un.multiply(t._mat,e._mat,t._mat),i&Zg.ROTATION&&Mn.multiply(t._rot,e._rot,t._lrot),Rn.fromQuat(db,Mn.conjugate(pb,t._rot)),Rn.multiplyMat4(db,db,t._mat),t._scale.x=db.m00,t._scale.y=db.m04,t._scale.z=db.m08)):(i&Zg.POSITION&&(En.copy(t._pos,t._lpos),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z),i&Zg.RS&&(i&Zg.ROTATION&&Mn.copy(t._rot,t._lrot),i&Zg.SCALE&&(En.copy(t._scale,t._lscale),Un.fromRTS(t._mat,t._rot,t._pos,t._scale)))),t._dirtyFlags=Zg.NONE,e=t}},e.setPosition=function(t,e,n){void 0===e&&void 0===n?En.copy(this._lpos,t):void 0===n?En.set(this._lpos,t,e,this._lpos.z):En.set(this._lpos,t,e,n),this.invalidateChildren(Zg.POSITION),1&this._eventMask&&this.emit(FA.TRANSFORM_CHANGED,Zg.POSITION)},e.getPosition=function(t){return t?En.set(t,this._lpos.x,this._lpos.y,this._lpos.z):En.copy(new En,this._lpos)},e.setRotation=function(t,e,n,i){void 0===e||void 0===n||void 0===i?Mn.copy(this._lrot,t):Mn.set(this._lrot,t,e,n,i),this._eulerDirty=!0,this.invalidateChildren(Zg.ROTATION),1&this._eventMask&&this.emit(FA.TRANSFORM_CHANGED,Zg.ROTATION)},e.setRotationFromEuler=function(t,e,n){var i=void 0===n?this._euler.z:n;void 0===e?(En.copy(this._euler,t),Mn.fromEuler(this._lrot,t.x,t.y,t.z)):(En.set(this._euler,t,e,i),Mn.fromEuler(this._lrot,t,e,i)),this._eulerDirty=!1,this.invalidateChildren(Zg.ROTATION),1&this._eventMask&&this.emit(FA.TRANSFORM_CHANGED,Zg.ROTATION)},e.getRotation=function(t){return t?Mn.set(t,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):Mn.copy(new Mn,this._lrot)},e.setScale=function(t,e,n){void 0===e&&void 0===n?En.copy(this._lscale,t):void 0===n?En.set(this._lscale,t,e,this._lscale.z):En.set(this._lscale,t,e,n),this.invalidateChildren(Zg.SCALE),1&this._eventMask&&this.emit(FA.TRANSFORM_CHANGED,Zg.SCALE)},e.getScale=function(t){return t?En.set(t,this._lscale.x,this._lscale.y,this._lscale.z):En.copy(new En,this._lscale)},e.inverseTransformPoint=function(t,e){En.copy(t,e);for(var n=this,i=0;n._parent;)this._setDirtyNode(i++,n),n=n._parent;for(;i>=0;)En.transformInverseRTS(t,t,n._lrot,n._lpos,n._lscale),n=gb[--i];return t},e.setWorldPosition=function(t,e,n){void 0===e||void 0===n?En.copy(this._pos,t):En.set(this._pos,t,e,n);var i=this._parent,r=this._lpos;i?(i.updateWorldTransform(),En.transformMat4(r,this._pos,Un.invert(vb,i._mat))):En.copy(r,this._pos),this.invalidateChildren(Zg.POSITION),1&this._eventMask&&this.emit(FA.TRANSFORM_CHANGED,Zg.POSITION)},e.getWorldPosition=function(t){return this.updateWorldTransform(),t?En.copy(t,this._pos):En.copy(new En,this._pos)},e.setWorldRotation=function(t,e,n,i){void 0===e||void 0===n||void 0===i?Mn.copy(this._rot,t):Mn.set(this._rot,t,e,n,i),this._parent?(this._parent.updateWorldTransform(),Mn.multiply(this._lrot,Mn.conjugate(this._lrot,this._parent._rot),this._rot)):Mn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Zg.ROTATION),1&this._eventMask&&this.emit(FA.TRANSFORM_CHANGED,Zg.ROTATION)},e.setWorldRotationFromEuler=function(t,e,n){Mn.fromEuler(this._rot,t,e,n),this._parent?(this._parent.updateWorldTransform(),Mn.multiply(this._lrot,Mn.conjugate(this._lrot,this._parent._rot),this._rot)):Mn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Zg.ROTATION),1&this._eventMask&&this.emit(FA.TRANSFORM_CHANGED,Zg.ROTATION)},e.getWorldRotation=function(t){return this.updateWorldTransform(),t?Mn.copy(t,this._rot):Mn.copy(new Mn,this._rot)},e.setWorldScale=function(t,e,n){void 0===e||void 0===n?En.copy(this._scale,t):En.set(this._scale,t,e,n);var i=this._parent;i?(i.updateWorldTransform(),Rn.fromQuat(db,Mn.conjugate(pb,i._rot)),Rn.multiplyMat4(db,db,i._mat),mb.m00=this._scale.x,mb.m04=this._scale.y,mb.m08=this._scale.z,Rn.multiply(db,mb,Rn.invert(db,db)),this._lscale.x=En.set(hb,db.m00,db.m01,db.m02).length(),this._lscale.y=En.set(hb,db.m03,db.m04,db.m05).length(),this._lscale.z=En.set(hb,db.m06,db.m07,db.m08).length()):En.copy(this._lscale,this._scale),this.invalidateChildren(Zg.SCALE),1&this._eventMask&&this.emit(FA.TRANSFORM_CHANGED,Zg.SCALE)},e.getWorldScale=function(t){return this.updateWorldTransform(),t?En.copy(t,this._scale):En.copy(new En,this._scale)},e.getWorldMatrix=function(t){this.updateWorldTransform();var e=t||new Un;return Un.copy(e,this._mat)},e.getWorldRS=function(t){this.updateWorldTransform();var e=t||new Un;return Un.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e},e.getWorldRT=function(t){this.updateWorldTransform();var e=t||new Un;return Un.fromRT(e,this._rot,this._pos)},e.setRTS=function(t,e,n){var i=0;t&&(i|=Zg.ROTATION,void 0!==t.w?(Mn.copy(this._lrot,t),this._eulerDirty=!0):(En.copy(this._euler,t),Mn.fromEuler(this._lrot,t.x,t.y,t.z),this._eulerDirty=!1)),e&&(En.copy(this._lpos,e),i|=Zg.POSITION),n&&(En.copy(this._lscale,n),i|=Zg.SCALE),i&&(this.invalidateChildren(i),1&this._eventMask&&this.emit(FA.TRANSFORM_CHANGED,i))},e.pauseSystemEvents=function(t){this._eventProcessor.setEnabled(!1,t)},e.resumeSystemEvents=function(t){this._eventProcessor.setEnabled(!0,t)},n.resetHasChangedFlags=function(){FT.clear()},n.clearNodeArray=function(){n.ClearFrame<n.ClearRound?n.ClearFrame++:(n.ClearFrame=0,gb.length=0,yb.length=0)},K(n,[{key:"_dirtyFlags",get:function(){return this._dirtyFlagsPri},set:function(t){this._dirtyFlagsPri=t}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return this._lpos},set:function(t){this.setPosition(t)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(t){this.setWorldPosition(t)}},{key:"rotation",get:function(){return this._lrot},set:function(t){this.setRotation(t)}},{key:"eulerAngles",get:function(){return this._eulerDirty&&(Mn.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler},set:function(t){this.setRotationFromEuler(t.x,t.y,t.z)}},{key:"angle",get:function(){return this._euler.z},set:function(t){En.set(this._euler,0,0,t),Mn.fromAngleZ(this._lrot,t),this._eulerDirty=!1,this.invalidateChildren(Zg.ROTATION),1&this._eventMask&&this.emit(FA.TRANSFORM_CHANGED,Zg.ROTATION)}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(t){this.setWorldRotation(t)}},{key:"scale",get:function(){return this._lscale},set:function(t){this.setScale(t)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(t){this.setWorldScale(t)}},{key:"matrix",set:function(t){Un.toRTS(t,this._lrot,this._lpos,this._lscale),this.invalidateChildren(Zg.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(FA.TRANSFORM_CHANGED,Zg.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return En.transformQuat(new En,En.FORWARD,this.worldRotation)},set:function(t){var e=t.length();En.multiplyScalar(hb,t,-1/e),Mn.fromViewUp(_b,hb),this.setWorldRotation(_b)}},{key:"up",get:function(){return En.transformQuat(new En,En.UP,this.worldRotation)}},{key:"right",get:function(){return En.transformQuat(new En,En.RIGHT,this.worldRotation)}},{key:"layer",get:function(){return this._layer},set:function(t){this._layer=t,this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.markForUpdateRenderData()),this.emit(FA.LAYER_CHANGED,this._layer)}},{key:"hasChangedFlags",get:function(){return this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]},set:function(t){this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]=t}}]),n}(ub),cb.EventType=FA,cb.NodeSpace=Qg,cb.TransformDirtyBit=Zg,cb.TransformBit=Zg,cb.reserveContentsForAllSyncablePrefabTag=zT,cb.ClearFrame=0,cb.ClearRound=1e3,ib=st((nb=lb).prototype,"_lpos",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new En}}),rb=st(nb.prototype,"_lrot",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mn}}),ob=st(nb.prototype,"_lscale",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new En(1,1,1)}}),ab=st(nb.prototype,"_layer",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rp.Enum.DEFAULT}}),sb=st(nb.prototype,"_euler",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new En}}),st(nb.prototype,"eulerAngles",[tb],Object.getOwnPropertyDescriptor(nb.prototype,"eulerAngles"),nb.prototype),st(nb.prototype,"angle",[Pc],Object.getOwnPropertyDescriptor(nb.prototype,"angle"),nb.prototype),st(nb.prototype,"layer",[Pc],Object.getOwnPropertyDescriptor(nb.prototype,"layer"),nb.prototype),eb=nb))||eb));c.Node=GT;var VT=hc("cc.TargetInfo")((bb=st((Ab=function(){at(this,"localID",bb,this)}).prototype,"localID",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Cb=Ab))||Cb,UT=(Tb=hc("cc.TargetOverrideInfo"),Eb=Wc(ul),wb=Wc(VT),Pb=Wc(GT),Ib=Wc(VT),Tb((Bb=st((Db=function(){at(this,"source",Bb,this),at(this,"sourceInfo",Mb,this),at(this,"propertyPath",Ob,this),at(this,"target",Nb,this),at(this,"targetInfo",Lb,this)}).prototype,"source",[vc,Eb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Mb=st(Db.prototype,"sourceInfo",[vc,wb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ob=st(Db.prototype,"propertyPath",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Nb=st(Db.prototype,"target",[vc,Pb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Lb=st(Db.prototype,"targetInfo",[vc,Ib],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Rb=Db))||Rb),kT=hc("cc.CompPrefabInfo")((Gb=st((zb=function(){at(this,"fileId",Gb,this)}).prototype,"fileId",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Fb=zb))||Fb,HT=(Vb=hc("CCPropertyOverrideInfo"),Ub=Wc(VT),Vb((Xb=function(){function t(){at(this,"targetInfo",jb,this),at(this,"propertyPath",Wb,this),at(this,"value",qb,this)}return t.prototype.isTarget=function(){},t}(),jb=st((Hb=Xb).prototype,"targetInfo",[vc,Ub],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Wb=st(Hb.prototype,"propertyPath",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),qb=st(Hb.prototype,"value",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),kb=Hb))||kb),jT=(Yb=hc("cc.MountedChildrenInfo"),Kb=Wc(VT),Jb=Wc([GT]),Yb((eT=function(){function t(){at(this,"targetInfo",$b,this),at(this,"nodes",tT,this)}return t.prototype.isTarget=function(){},t}(),$b=st((Zb=eT).prototype,"targetInfo",[vc,Kb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tT=st(Zb.prototype,"nodes",[vc,Jb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Qb=Zb))||Qb),WT=(nT=hc("cc.MountedComponentsInfo"),iT=Wc(VT),rT=Wc([Ku]),nT((lT=function(){function t(){at(this,"targetInfo",sT,this),at(this,"components",cT,this)}return t.prototype.isTarget=function(){},t}(),sT=st((aT=lT).prototype,"targetInfo",[vc,iT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cT=st(aT.prototype,"components",[vc,rT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),oT=aT))||oT),qT=(uT=hc("cc.PrefabInstance"),hT=Wc(GT),_T=Wc([jT]),fT=Wc([WT]),pT=Wc([HT]),dT=Wc([VT]),uT((bT=function(){function t(){at(this,"fileId",gT,this),at(this,"prefabRootNode",yT,this),at(this,"mountedChildren",xT,this),at(this,"mountedComponents",ST,this),at(this,"propertyOverrides",CT,this),at(this,"removedComponents",AT,this),this.targetMap={}}var e=t.prototype;return e.findPropertyOverride=function(){},e.removePropertyOverride=function(){},t}(),gT=st((vT=bT).prototype,"fileId",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),yT=st(vT.prototype,"prefabRootNode",[vc,hT],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),xT=st(vT.prototype,"mountedChildren",[vc,_T],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ST=st(vT.prototype,"mountedComponents",[vc,fT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),CT=st(vT.prototype,"propertyOverrides",[vc,pT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),AT=st(vT.prototype,"removedComponents",[vc,dT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mT=vT))||mT),XT=(TT=hc("cc.PrefabInfo"),ET=Wc(GT),wT=Wc(qT),PT=Wc([UT]),TT((DT=st((RT=function(){at(this,"root",DT,this),at(this,"asset",BT,this),at(this,"fileId",MT,this),at(this,"instance",OT,this),at(this,"targetOverrides",NT,this),at(this,"nestedPrefabInstanceRoots",LT,this)}).prototype,"root",[vc,ET],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),BT=st(RT.prototype,"asset",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),MT=st(RT.prototype,"fileId",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),OT=st(RT.prototype,"instance",[vc,wT],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),NT=st(RT.prototype,"targetOverrides",[vc,PT],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),LT=st(RT.prototype,"nestedPrefabInstanceRoots",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),IT=RT))||IT);function YT(t){var e=t._prefab;if(e&&e.instance){if(!e.asset)return D(3701,t.name),void(e.instance=void 0);var n=t._objFlags,i=t._parent,r=t._id,o=t._prefab;t[ol],c.game._isCloning=!0,e.asset._doInstantiate(t),c.game._isCloning=!1,t._objFlags=n,t._parent=i,t._id=r,t._prefab&&(t._prefab.instance=null==o?void 0:o.instance)}}function KT(t,e,n){var i;if(e&&t){var r=e,o=null===(i=t._prefab)||void 0===i?void 0:i.instance;!n&&o&&(e[o.fileId]={},r=e[o.fileId]);var a=t._prefab;a&&(r[a.fileId]=t);for(var s=t.components,c=0;c<s.length;c++){var l=s[c];l.__prefab&&(r[l.__prefab.fileId]=l)}for(var u=0;u<t.children.length;u++)KT(t.children[u],r,!1)}}function JT(t,e){if(!t)return null;for(var n=e,i=0;i<t.length;i++){if(!n)return null;n=n[t[i]]}return n}function QT(t,e,n){if(e)for(var i=0;i<e.length;i++){var r=e[i];if(r&&r.targetInfo){var o=JT(r.targetInfo.localID,n);if(!o)continue;var a=n,s=r.targetInfo.localID;if(s.length>0)for(var c=0;c<s.length-1;c++)a=a[s[c]];if(r.nodes)for(var l=0;l<r.nodes.length;l++){var u=r.nodes[l];u&&(o._children.push(u),u._parent=o,KT(u,a,!1),u._siblingIndex=o._children.length-1,nE(u,!0))}}}}function ZT(t,e,n){if(e)for(var i=0;i<e.length;i++){var r=e[i];if(r&&r.targetInfo){var o=JT(r.targetInfo.localID,n);if(!o)continue;if(r.components)for(var a=0;a<r.components.length;a++){var s=r.components[a];s&&(s.node=o,o._components.push(s))}}}}function $T(t,e,n){if(e)for(var i=0;i<e.length;i++){var r=e[i];if(r){var o=JT(r.localID,n);if(!o||!o.node)continue;var a=o.node.components.indexOf(o);a>=0&&o.node._components.splice(a,1)}}}function tE(t,e,n){if(!(e.length<=0))for(var i=null,r=0;r<e.length;r++){var o=e[r];if(o&&o.targetInfo){if(!(i=JT(o.targetInfo.localID,n)))continue;var a=i,s=o.propertyPath.slice();if(s.length>0){var c=s.pop();if(!c)continue;for(var l=0;l<s.length&&(a=a[s[l]]);l++);if(!a)continue;if(Array.isArray(a))if("length"===c)a[c]=o.value;else{var u=Number.parseInt(c);Number.isInteger(u)&&u<a.length&&(a[c]=o.value)}else a[c]instanceof se?a[c].set(o.value):a[c]=o.value}}}}function eE(t){var e,n=null===(e=t._prefab)||void 0===e?void 0:e.targetOverrides;if(n)for(var i=0;i<n.length;i++){var r,o,a=n[i],s=a.source,c=a.sourceInfo;if(c){var l,u,h=null===(l=a.source)||void 0===l||null===(u=l._prefab)||void 0===u?void 0:u.instance;h&&h.targetMap&&(s=JT(c.localID,h.targetMap))}if(s){var _,f=a.targetInfo;if(f){var p=null===(r=a.target)||void 0===r||null===(o=r._prefab)||void 0===o?void 0:o.instance;if(p&&p.targetMap&&(_=JT(f.localID,p.targetMap))){var d=a.propertyPath.slice(),m=s;if(d.length>0){var v=d.pop();if(!v)return;for(var g=0;g<d.length&&(m=m[d[g]]);g++);if(!m)continue;m[v]=_}}}}}}function nE(t,e){void 0===e&&(e=!1);var n=t._prefab,i=null==n?void 0:n.instance;if(i){YT(t);var r={};i.targetMap=r,KT(t,r,!0),QT(0,i.mountedChildren,r),$T(0,i.removedComponents,r),ZT(0,i.mountedComponents,r),tE(0,i.propertyOverrides,r)}e&&t&&t.children&&t.children.forEach((function(t){nE(t,!0)}))}function iE(t){var e=t._prefab;e&&e.nestedPrefabInstanceRoots&&e.nestedPrefabInstanceRoots.forEach((function(t){nE(t)}))}c._PrefabInfo=XT;var rE,oE,aE,sE,cE,lE,uE,hE,_E,fE,pE,dE,mE,vE,gE=Object.freeze({__proto__:null,TargetInfo:VT,TargetOverrideInfo:UT,CompPrefabInfo:kT,PropertyOverrideInfo:HT,MountedChildrenInfo:jT,MountedComponentsInfo:WT,PrefabInstance:qT,PrefabInfo:XT,createNodeWithPrefab:YT,generateTargetMap:KT,getTarget:JT,applyMountedChildren:QT,applyMountedComponents:ZT,applyRemovedComponents:$T,applyPropertyOverrides:tE,applyTargetOverrides:eE,expandPrefabInstanceNode:nE,expandNestedPrefabInstanceNode:iE}),yE=ie({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),xE=t("Prefab",hc("cc.Prefab")((uE=lE=function(t){function e(){var e;return at(e=t.call(this)||this,"data",aE,it(e)),at(e,"optimizationPolicy",sE,it(e)),at(e,"persistent",cE,it(e)),e._createFunction=void 0,e._instantiatedTimes=void 0,e._createFunction=null,e._instantiatedTimes=0,e}Q(e,t);var n=e.prototype;return n.createNode=function(t){var e=c.instantiate(this);e.name=this.name,t(null,e)},n.compileCreateFunction=function(){var t,e;this._createFunction=(e=(t=this.data)instanceof c._BaseNode&&t,new NA(t,e).result)},n._doInstantiate=function(t){return this.data._prefab||I(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(t)},n._instantiate=function(){var t;return this.optimizationPolicy!==yE.SINGLE_INSTANCE&&(this.optimizationPolicy===yE.MULTI_INSTANCE||this._instantiatedTimes+1>=e.OptimizationPolicyThreshold)?(t=this._doInstantiate(),this.data._instantiate(t)):t=this.data._instantiate(),++this._instantiatedTimes,t},n.initDefault=function(e){t.prototype.initDefault.call(this,e),this.data=new GT,this.data.name="(Missing Node)";var n=new c._PrefabInfo;n.asset=this,n.root=this.data,this.data._prefab=n},n.validate=function(){return!!this.data},n.onLoaded=function(){var t=this.data;iE(t),eE(t)},e}(Pu),lE.OptimizationPolicy=yE,lE.OptimizationPolicyThreshold=3,aE=st((oE=uE).prototype,"data",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sE=st(oE.prototype,"optimizationPolicy",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yE.AUTO}}),cE=st(oE.prototype,"persistent",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),rE=oE))||rE);ee.value(xE,"_utils",gE),c.Prefab=xE,Pt(c,"cc._Prefab","Prefab"),t("PrefabLink",(hE=hc("cc.PrefabLink"),_E=Wc(xE),fE=Ic(),hE((vE=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"prefab",mE,it(e)),e}return Q(e,t),e}(Ku),mE=st((dE=vE).prototype,"prefab",[_E,vc,fE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pE=dE))||pE));var SE=new En;function CE(t,e,n,i){i||(i=new En),t.convertToUINode(e,n,i);var r=n.position;return i.add(r),i}function AE(t,e,n){return n||(n=new En),t.worldToScreen(e,n),n.x/=c.view.getScaleX(),n.y/=c.view.getScaleY(),n}var bE,TE,EE=t("convertUtils",{WorldNode3DToLocalNodeUI:CE,WorldNode3DToWorldNodeUI:AE});c.pipelineUtils=EE,z(c.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];var i=e[0],r=e[3]||SE;return i.convertToUINode(e[1],e[2],r),r.add(e[2].position),e[3]||r.clone()}}]),G(Xm.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),z(OS.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction:function(){return this._window}}]);var wE,PE=t("BufferAsset",hc("cc.BufferAsset")((st((TE=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._buffer=null,e}Q(e,t);var n=e.prototype;return n.buffer=function(){return this._buffer},n.validate=function(){return!!this.buffer},K(e,[{key:"_nativeAsset",get:function(){return this._buffer},set:function(t){t instanceof ArrayBuffer?this._buffer=t:this._buffer=t.buffer}}]),e}(Pu)).prototype,"_nativeAsset",[el],Object.getOwnPropertyDescriptor(TE.prototype,"_nativeAsset"),TE.prototype),bE=TE))||bE);c.BufferAsset=PE;var IE=((wE={})[hi.UNORM]="Uint",wE[hi.SNORM]="Int",wE[hi.UINT]="Uint",wE[hi.INT]="Int",wE[hi.UFLOAT]="Float",wE[hi.FLOAT]="Float",wE.default="Uint",wE);function RE(t){return""+(IE[t.type]||IE.default)+t.size/t.count*8}function DE(t,e,n,i,r){void 0===n&&(n=ui.R32F),void 0===i&&(i=0),void 0===r&&(r=0);var o=Jr[n];r||(r=o.size);for(var a="set"+RE(o),s=o.size/o.count,c=Math.floor(e.length/o.count),l=oh.isLittleEndian,u=0;u<c;++u)for(var h=i+r*u,_=0;_<o.count;++_){var f=h+s*_;t[a](f,e[o.count*u+_],l)}}function BE(t,e,n,i,r,o){void 0===e&&(e=ui.R32F),void 0===n&&(n=0),void 0===i&&(i=t.byteLength-n),void 0===r&&(r=0),void 0===o&&(o=[]);var a=Jr[e];r||(r=a.size);for(var s="get"+RE(a),c=a.size/a.count,l=Math.floor(i/r),u=oh.isLittleEndian,h=0;h<l;++h)for(var _=n+r*h,f=0;f<a.count;++f){var p=_+c*f;o[a.count*h+f]=t[s](p,u)}return o}function ME(t,e,n,i,r,o,a){void 0===n&&(n=ui.R32F),void 0===i&&(i=0),void 0===r&&(r=t.byteLength-i),void 0===o&&(o=0),a||(a=new DataView(t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)));var s=Jr[n];o||(o=s.size);for(var c="set"+RE(s),l="get"+RE(s),u=s.size/s.count,h=Math.floor(r/o),_=oh.isLittleEndian,f=0;f<h;++f)for(var p=i+o*f,d=0;d<s.count;++d){var m=p+u*d,v=t[l](m,_);a[c](m,e(v,d,t),_)}return a}var OE,NE,LE=t("RenderingSubMesh",function(){var t=e.prototype;function e(t,e,n,i,r){void 0===i&&(i=null),void 0===r&&(r=null),this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._attributes=e,this._vertexBuffers=t,this._indexBuffer=i,this._indirectBuffer=r,this._primitiveMode=n,this._iaInfo=new Pr(e,t,i,r),this._init()}return t._init=function(){},t.genFlatBuffers=function(){if(!this._flatBuffers.length&&this.mesh&&void 0!==this.subMeshIdx){var t=this.mesh,e=0,n=t.struct.primitives[this.subMeshIdx];n.indexView&&(e=n.indexView.count);for(var i=0;i<n.vertexBundelIndices.length;i++){var r=n.vertexBundelIndices[i],o=t.struct.vertexBundles[r],a=n.indexView?n.indexView.count:o.view.count,s=o.view.stride,c=s*a,l=new Uint8Array(t.data.buffer,o.view.offset,o.view.length),u=new Uint8Array(n.indexView?c:o.view.length);if(n.indexView){for(var h=t.readIndices(this.subMeshIdx),_=0;_<e;++_)for(var f=_*s,p=h[_]*s,d=0;d<s;++d)u[f+d]=l[p+d];this._flatBuffers.push({stride:s,count:a,buffer:u})}else u.set(t.data.subarray(o.view.offset,o.view.offset+o.view.length)),this._flatBuffers.push({stride:s,count:a,buffer:u})}}},t.destroy=function(){for(var t=0;t<this.vertexBuffers.length;t++)this.vertexBuffers[t].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var e=0;e<this._jointMappedBufferIndices.length;e++)this._jointMappedBuffers[this._jointMappedBufferIndices[e]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)},t.enableVertexIdChannel=function(t){if(!this._vertexIdChannel){var e=this.vertexBuffers.length,n=this.attributes.length,i=this._allocVertexIdBuffer(t);this._vertexBuffers.push(i),this._attributes.push(new Er("a_vertexId",ui.R32F,!1,e)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:e,index:n}}},t._allocVertexIdBuffer=function(t){for(var e=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,n=new Float32Array(e),i=0;i<e;++i)n[i]=i+.5;var r=t.createBuffer(new lr(fi.VERTEX|fi.TRANSFER_DST,mi.DEVICE,n.byteLength,n.BYTES_PER_ELEMENT));return r.update(n),r},K(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"primitiveMode",get:function(){return this._primitiveMode}},{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:En.ZERO,max:En.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:En.ZERO,max:En.ZERO}};var t=this.mesh,e=this.subMeshIdx,n=t.readAttribute(e,Xi.ATTR_POSITION),i=t.readIndices(e),r=new En,o=new En,a=this.attributes.find((function(t){return t.name===Xi.ATTR_POSITION}));if(a){var s=Jr[a.format].count;2===s?(r.set(n[0],n[1],0),o.set(n[0],n[1],0)):(r.set(n[0],n[1],n[2]),o.set(n[0],n[1],n[2]));for(var c=0;c<n.length;c+=s)2===s?(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y):(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,r.z=n[c+2]>r.z?n[c+2]:r.z,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y,o.z=n[c+2]<o.z?n[c+2]:o.z)}return this._geometricInfo={positions:n,indices:i,boundingBox:{max:r,min:o}},this._geometricInfo}},{key:"flatBuffers",get:function(){return this._flatBuffers}},{key:"jointMappedBuffers",get:function(){var t=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var e=this._jointMappedBuffers=[],n=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var i,r,o=this.mesh.struct,a=o.primitives[this.subMeshIdx];if(!o.jointMaps||void 0===a.jointMapIndex||!o.jointMaps[a.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var s=c.director.root.device,l=0;l<a.vertexBundelIndices.length;l++){var u=o.vertexBundles[a.vertexBundelIndices[l]];r=0,i=ui.UNKNOWN;for(var h=0;h<u.attributes.length;h++){var _=u.attributes[h];if(_.name===Xi.ATTR_JOINTS){i=_.format;break}r+=Jr[_.format].size}i?function(){var c=new Uint8Array(t.mesh.data.buffer,u.view.offset,u.view.length),h=new DataView(c.slice().buffer),_=o.jointMaps[a.jointMapIndex];ME(h,(function(t){return _.indexOf(t)}),i,r,u.view.length,u.view.stride,h);var f=s.createBuffer(new lr(fi.VERTEX|fi.TRANSFER_DST,mi.DEVICE,u.view.length,u.view.stride));f.update(h.buffer),e.push(f),n.push(l)}():e.push(this.vertexBuffers[a.vertexBundelIndices[l]])}return this._vertexIdChannel&&e.push(this._allocVertexIdBuffer(s)),e}},{key:"iaInfo",get:function(){return this._iaInfo}}]),e}());!function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.MOUSE_ENTER="mouse-enter",t.MOUSE_LEAVE="mouse-leave",t.KEY_DOWN="keydown",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion",t.TRANSFORM_CHANGED="transform-changed",t.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",t.SIZE_CHANGED="size-changed",t.ANCHOR_CHANGED="anchor-changed",t.COLOR_CHANGED="color-changed",t.CHILD_ADDED="child-added",t.CHILD_REMOVED="child-removed",t.PARENT_CHANGED="parent-changed",t.NODE_DESTROYED="node-destroyed",t.LAYER_CHANGED="layer-changed",t.SIBLING_ORDER_CHANGED="sibling-order-changed"}(OE||(OE=t("SystemEventType",{}))),function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.KEY_DOWN="keydown",t.KEY_PRESSING="key-pressing",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion"}(NE||(NE={})),c.SystemEventType=OE;var FE,zE=new Array(16),GE=null,VE=new Wn,UE=[FA.TOUCH_START,FA.TOUCH_MOVE,FA.TOUCH_END,FA.TOUCH_CANCEL],kE=[FA.MOUSE_DOWN,FA.MOUSE_ENTER,FA.MOUSE_MOVE,FA.MOUSE_LEAVE,FA.MOUSE_UP,FA.MOUSE_WHEEL];!function(t){t[t.ADD_POINTER_EVENT_PROCESSOR=0]="ADD_POINTER_EVENT_PROCESSOR",t[t.REMOVE_POINTER_EVENT_PROCESSOR=1]="REMOVE_POINTER_EVENT_PROCESSOR",t[t.MARK_LIST_DIRTY=2]="MARK_LIST_DIRTY"}(FE||(FE={}));var HE,jE,WE,qE,XE,YE,KE,JE,QE,ZE,$E,tw,ew,nw,iw,rw,ow,aw,sw,cw,lw,uw,hw,_w,fw,pw,dw,mw,vw,gw,yw,xw,Sw,Cw,Aw,bw,Tw,Ew,ww,Pw,Iw,Rw,Dw,Bw,Mw,Ow,Nw,Lw,Fw,zw,Gw,Vw,Uw,kw,Hw,jw,Ww,qw,Xw,Yw,Kw,Jw,Qw,Zw,$w,tP,eP,nP,iP,rP,oP,aP,sP,cP,lP,uP,hP,_P,fP,pP,dP,mP,vP,gP,yP,xP,SP,CP,AP,bP,TP,EP,wP,PP,IP,RP,DP,BP,MP,OP,NP,LP,FP,zP,GP,VP,UP,kP,HP,jP,WP,qP,XP,YP,KP,JP,QP,ZP,$P,tI,eI,nI,iI,rI,oI,aI,sI,cI,lI,uI,hI,_I,fI,pI,dI,mI,vI,gI,yI,xI,SI,CI,AI,bI,TI,EI,wI,PI,II,RI,DI,BI,MI,OI,NI,LI,FI,zI,GI,VI,UI,kI,HI,jI,WI,qI,XI,YI,KI,JI,QI,ZI,$I,tR,eR,nR,iR,rR,oR,aR,sR,cR,lR,uR,hR,_R,fR,pR,dR,mR,vR,gR,yR,xR,SR,CR=function(){var t=e.prototype;function e(t){this._isEnabled=!1,this.claimedTouchIdList=[],this.maskList=null,this.cachedCameraPriority=0,this.previousMouseIn=!1,this.bubblingTarget=null,this.capturingTarget=null,this.shouldHandleEventMouse=!1,this.shouldHandleEventTouch=!1,this._node=void 0,this._node=t}return t.setEnabled=function(t,n){if(void 0===n&&(n=!1),this._isEnabled!==t){this._isEnabled=t;var i=this.node.children;if(t&&this._attachMask(),e.callbacksInvoker.emit(FE.MARK_LIST_DIRTY),n&&i.length>0)for(var r=0;r<i.length;++r)i[r]._eventProcessor.setEnabled(t,!0)}},t._searchComponentsInParent=function(t){var e=this.node;if(t){for(var n=0,i=[],r=e;r&&GT.isNode(r);r=r.parent,++n){var o=r.getComponent(t);if(o){var a={index:n,comp:o};i?i.push(a):i=[a]}}return i.length>0?i:null}return null},t._attachMask=function(){this.maskList=this._searchComponentsInParent(e._maskComp)},t.reattach=function(){var t,n=this;this.node.walk((function(i){t||(t=n._searchComponentsInParent(e._maskComp)),i.eventProcessor.maskList=t}))},t.destroy=function(){GE===this._node&&(GE=null),this.capturingTarget&&this.capturingTarget.clear(),this.bubblingTarget&&this.bubblingTarget.clear(),e.callbacksInvoker.emit(FE.REMOVE_POINTER_EVENT_PROCESSOR,this)},t._isTouchEvent=function(t){return-1!==UE.indexOf(t)},t._isMouseEvent=function(t){return-1!==kE.indexOf(t)},t._hasTouchListeners=function(){for(var t=0;t<UE.length;++t){var e=UE[t];if(this.hasEventListener(e))return!0}return!1},t._hasMouseListeners=function(){for(var t=0;t<kE.length;++t){var e=kE[t];if(this.hasEventListener(e))return!0}return!1},t._hasPointerListeners=function(){return!!this._hasTouchListeners()||this._hasMouseListeners()},t._tryEmittingAddEvent=function(t){var n=this._isTouchEvent(t),i=this._isMouseEvent(t);n?this.shouldHandleEventTouch=!0:i&&(this.shouldHandleEventMouse=!0),!n&&!i||this._hasPointerListeners()||e.callbacksInvoker.emit(FE.ADD_POINTER_EVENT_PROCESSOR,this)},t._newCallbacksInvoker=function(){var t=this,n=new Kl;return n._registerOffCallback((function(){t.shouldHandleEventTouch&&!t._hasTouchListeners()&&(t.shouldHandleEventTouch=!1),t.shouldHandleEventMouse&&!t._hasMouseListeners()&&(t.shouldHandleEventMouse=!1),t._hasPointerListeners()||e.callbacksInvoker.emit(FE.REMOVE_POINTER_EVENT_PROCESSOR,t)})),n},t.on=function(t,e,n,i){var r,o;return this._tryEmittingAddEvent(t),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(t,e,n),e},t.once=function(t,e,n,i){var r,o;return this._tryEmittingAddEvent(t),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(t,e,n,!0),e},t.off=function(t,e,n,i){var r;null===(r=(i=!!i)?this.capturingTarget:this.bubblingTarget)||void 0===r||r.off(t,e,n)},t.targetOff=function(t){var n,i;null===(n=this.capturingTarget)||void 0===n||n.removeAll(t),null===(i=this.bubblingTarget)||void 0===i||i.removeAll(t),this.shouldHandleEventTouch&&!this._hasTouchListeners()&&(this.shouldHandleEventTouch=!1),this.shouldHandleEventMouse&&!this._hasMouseListeners()&&(this.shouldHandleEventMouse=!1),this._hasPointerListeners()||e.callbacksInvoker.emit(FE.REMOVE_POINTER_EVENT_PROCESSOR,this)},t.emit=function(t,e,n,i,r,o){var a;null===(a=this.bubblingTarget)||void 0===a||a.emit(t,e,n,i,r,o)},t.dispatchEvent=function(t){var e,n=this.node,i=0;for(t.target=n,zE.length=0,this.getCapturingTargets(t.type,zE),t.eventPhase=1,i=zE.length-1;i>=0;--i)if((e=zE[i]).eventProcessor.capturingTarget&&(t.currentTarget=e,e.eventProcessor.capturingTarget.emit(t.type,t,zE),t.propagationStopped))return void(zE.length=0);if(zE.length=0,t.eventPhase=2,t.currentTarget=n,this.capturingTarget&&this.capturingTarget.emit(t.type,t),!t.propagationImmediateStopped&&this.bubblingTarget&&this.bubblingTarget.emit(t.type,t),!t.propagationStopped&&t.bubbles)for(this.getBubblingTargets(t.type,zE),t.eventPhase=3,i=0;i<zE.length;++i)if((e=zE[i]).eventProcessor.bubblingTarget&&(t.currentTarget=e,e.eventProcessor.bubblingTarget.emit(t.type,t),t.propagationStopped))return void(zE.length=0);zE.length=0},t.hasEventListener=function(t,e,n){var i=!1;return this.bubblingTarget&&(i=this.bubblingTarget.hasEventListener(t,e,n)),!i&&this.capturingTarget&&(i=this.capturingTarget.hasEventListener(t,e,n)),i},t.getCapturingTargets=function(t,e){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.capturingTarget)||void 0===i?void 0:i.hasEventListener(t))&&e.push(n),n=n.parent}},t.getBubblingTargets=function(t,e){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.bubblingTarget)||void 0===i?void 0:i.hasEventListener(t))&&e.push(n),n=n.parent}},t._handleEventMouse=function(t){switch(t.type){case NE.MOUSE_DOWN:return this._handleMouseDown(t);case NE.MOUSE_MOVE:return this._handleMouseMove(t);case NE.MOUSE_UP:return this._handleMouseUp(t);case NE.MOUSE_WHEEL:return this._handleMouseWheel(t);default:return!1}},t._handleMouseDown=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(VE=t.getUILocation(),!e._uiProps.uiTransformComp.isHit(VE)||(t.type=FA.MOUSE_DOWN,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))},t._handleMouseMove=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(VE=t.getUILocation(),e._uiProps.uiTransformComp.isHit(VE)?(this.previousMouseIn||(GE&&GE!==e&&(t.type=FA.MOUSE_LEAVE,GE.dispatchEvent(t),GE.eventProcessor.previousMouseIn=!1),GE=e,t.type=FA.MOUSE_ENTER,e.dispatchEvent(t),this.previousMouseIn=!0),t.type=FA.MOUSE_MOVE,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0):(this.previousMouseIn&&(t.type=FA.MOUSE_LEAVE,e.dispatchEvent(t),this.previousMouseIn=!1,GE=null),1)))},t._handleMouseUp=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(VE=t.getUILocation(),!e._uiProps.uiTransformComp.isHit(VE)||(t.type=FA.MOUSE_UP,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))},t._handleMouseWheel=function(t){var e=this._node;return!(!e||!e._uiProps.uiTransformComp||(VE=t.getUILocation(),!e._uiProps.uiTransformComp.isHit(VE)||(t.type=FA.MOUSE_WHEEL,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0,0)))},t._handleEventTouch=function(t){switch(t.type){case NE.TOUCH_START:return this._handleTouchStart(t);case NE.TOUCH_MOVE:return this._handleTouchMove(t);case NE.TOUCH_END:return this._handleTouchEnd(t);case NE.TOUCH_CANCEL:return this._handleTouchCancel(t);default:return!1}},t._handleTouchStart=function(t){var e=this.node;return!(!e||!e._uiProps.uiTransformComp||(t.getUILocation(VE),!e._uiProps.uiTransformComp.isHit(VE)||(t.type=FA.TOUCH_START,t.bubbles=!0,e.dispatchEvent(t),0)))},t._handleTouchMove=function(t){var e=this.node;return!(!e||!e._uiProps.uiTransformComp||(t.type=FA.TOUCH_MOVE,t.bubbles=!0,e.dispatchEvent(t),0))},t._handleTouchEnd=function(t){var e=this.node;e&&e._uiProps.uiTransformComp&&(t.getUILocation(VE),e._uiProps.uiTransformComp.isHit(VE)?t.type=FA.TOUCH_END:t.type=FA.TOUCH_CANCEL,t.bubbles=!0,e.dispatchEvent(t))},t._handleTouchCancel=function(t){var e=this.node;e&&e._uiProps.uiTransformComp&&(t.type=FA.TOUCH_CANCEL,t.bubbles=!0,e.dispatchEvent(t))},K(e,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"node",get:function(){return this._node}}]),e}();CR._maskComp=null,CR.callbacksInvoker=new Kl,c.NodeEventProcessor=CR;var AR=new En(0,1,0),bR=new En,TR=new Kn,ER=new bn,wR=new Mn,PR=function(t){var e=1/Math.max(Math.max(Math.max(t.x,t.y),t.z),1e-4);e<1&&(t.x*=e,t.y*=e,t.z*=e)},IR=(HE=hc("cc.AmbientInfo"),jE=wc(),WE=gc("_skyColor"),qE=gc("_skyIllum"),XE=gc("_groundAlbedo"),YE=Ic(),KE=Bc(),JE=Wc(De),QE=Bc(),ZE=Ic(),$E=Bc(),HE(tw=jE((cw=function(){function t(){at(this,"_skyColorHDR",nw,this),at(this,"_skyIllumHDR",iw,this),at(this,"_groundAlbedoHDR",rw,this),at(this,"_skyColorLDR",ow,this),at(this,"_skyIllumLDR",aw,this),at(this,"_groundAlbedoLDR",sw,this),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this)},K(t,[{key:"skyColorHDR",get:function(){return this._skyColorHDR}},{key:"groundAlbedoHDR",get:function(){return this._groundAlbedoHDR}},{key:"skyIllumHDR",get:function(){return this._skyIllumHDR}},{key:"skyColorLDR",get:function(){return this._skyColorLDR}},{key:"groundAlbedoLDR",get:function(){return this._groundAlbedoLDR}},{key:"skyIllumLDR",get:function(){return this._skyIllumLDR}},{key:"skyLightingColor",get:function(){var t=c.director.root.pipeline.pipelineSceneData.isHDR;return TR.set(t?this._skyColorHDR:this._skyColorLDR),PR(TR),ER.set(255*TR.x,255*TR.y,255*TR.z,255)},set:function(t){TR.set(t.x,t.y,t.z,t.w),c.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(TR):this._skyColorLDR.set(TR),this._resource&&this._resource.skyColor.set(TR)}},{key:"skyColor",set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(t):this._skyColorLDR.set(t),this._resource&&this._resource.skyColor.set(t)}},{key:"skyIllum",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=t:this._skyIllumLDR=t,this._resource&&(this._resource.skyIllum=t)}},{key:"groundLightingColor",get:function(){var t=c.director.root.pipeline.pipelineSceneData.isHDR;return TR.set(t?this._groundAlbedoHDR:this._groundAlbedoLDR),PR(TR),ER.set(255*TR.x,255*TR.y,255*TR.z,255)},set:function(t){TR.set(t.x,t.y,t.z,t.w),c.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(TR):this._groundAlbedoLDR.set(TR),this._resource&&this._resource.groundAlbedo.set(TR)}},{key:"groundAlbedo",set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(t):this._groundAlbedoLDR.set(t),this._resource&&this._resource.groundAlbedo.set(t)}}]),t}(),nw=st((ew=cw).prototype,"_skyColorHDR",[vc,WE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn(.2,.5,.8,1)}}),iw=st(ew.prototype,"_skyIllumHDR",[vc,qE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return YS.SKY_ILLUM}}),rw=st(ew.prototype,"_groundAlbedoHDR",[vc,XE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn(.2,.2,.2,1)}}),ow=st(ew.prototype,"_skyColorLDR",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn(.2,.5,.8,1)}}),aw=st(ew.prototype,"_skyIllumLDR",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return YS.SKY_ILLUM}}),sw=st(ew.prototype,"_groundAlbedoLDR",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn(.2,.2,.2,1)}}),st(ew.prototype,"skyLightingColor",[YE,Pc,KE],Object.getOwnPropertyDescriptor(ew.prototype,"skyLightingColor"),ew.prototype),st(ew.prototype,"skyIllum",[Pc,JE,QE],Object.getOwnPropertyDescriptor(ew.prototype,"skyIllum"),ew.prototype),st(ew.prototype,"groundLightingColor",[ZE,Pc,$E],Object.getOwnPropertyDescriptor(ew.prototype,"groundLightingColor"),ew.prototype),tw=ew))||tw)||tw);c.AmbientInfo=IR;var RR=(lw=hc("cc.SkyboxInfo"),uw=wc(),hw=Wc(yv),_w=gc("_envmap"),fw=Wc(yv),pw=Wc(yv),dw=Wc(yv),mw=Ic(),vw=Bc(),gw=zc(),yw=Bc(),xw=Bc(),Sw=Bc(),Cw=Wc(yv),Aw=Bc(),bw=Ic(),Tw=Wc(yv),Ew=zc(),lw(ww=uw((Fw=function(){function t(){at(this,"_applyDiffuseMap",Iw,this),at(this,"_envmapHDR",Rw,this),at(this,"_envmapLDR",Dw,this),at(this,"_diffuseMapHDR",Bw,this),at(this,"_diffuseMapLDR",Mw,this),at(this,"_enabled",Ow,this),at(this,"_useIBL",Nw,this),at(this,"_useHDR",Lw,this),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this),this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.activate()},K(t,[{key:"applyDiffuseMap",get:function(){return this._applyDiffuseMap},set:function(t){this._applyDiffuseMap=t,this._resource&&(this._resource.useDiffuseMap=t)}},{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=this._enabled))}},{key:"useIBL",get:function(){return this._useIBL},set:function(t){this._useIBL=t,this._resource&&(this._resource.useIBL=this._useIBL)}},{key:"useHDR",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR=this._useHDR,this._useHDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR=t,this._useHDR=t,this._resource&&(this.envmap=this._resource.envmap,this.diffuseMap=this._resource.diffuseMap,null==this.diffuseMap&&(this.applyDiffuseMap=!1)),this._resource&&(this._resource.useHDR=this._useHDR)}},{key:"envmap",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR=t:this._envmapLDR=t,this._envmapHDR||(this._diffuseMapHDR=null,this._applyDiffuseMap=!1,this.useIBL=!1),this._resource&&(this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.useDiffuseMap=this._applyDiffuseMap,this._resource.envmap=t)}},{key:"diffuseMap",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR=t:this._diffuseMapLDR=t,this._resource&&this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR)}}]),t}(),Iw=st((Pw=Fw).prototype,"_applyDiffuseMap",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Rw=st(Pw.prototype,"_envmapHDR",[vc,hw,_w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Dw=st(Pw.prototype,"_envmapLDR",[vc,fw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Bw=st(Pw.prototype,"_diffuseMapHDR",[vc,pw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Mw=st(Pw.prototype,"_diffuseMapLDR",[vc,dw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ow=st(Pw.prototype,"_enabled",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Nw=st(Pw.prototype,"_useIBL",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Lw=st(Pw.prototype,"_useHDR",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),st(Pw.prototype,"applyDiffuseMap",[mw,Pc,vw,gw],Object.getOwnPropertyDescriptor(Pw.prototype,"applyDiffuseMap"),Pw.prototype),st(Pw.prototype,"enabled",[Pc,yw],Object.getOwnPropertyDescriptor(Pw.prototype,"enabled"),Pw.prototype),st(Pw.prototype,"useIBL",[Pc,xw],Object.getOwnPropertyDescriptor(Pw.prototype,"useIBL"),Pw.prototype),st(Pw.prototype,"useHDR",[Pc,Sw],Object.getOwnPropertyDescriptor(Pw.prototype,"useHDR"),Pw.prototype),st(Pw.prototype,"envmap",[Pc,Cw,Aw],Object.getOwnPropertyDescriptor(Pw.prototype,"envmap"),Pw.prototype),st(Pw.prototype,"diffuseMap",[bw,Pc,Rc,Tw,Ew],Object.getOwnPropertyDescriptor(Pw.prototype,"diffuseMap"),Pw.prototype),ww=Pw))||ww)||ww);c.SkyboxInfo=RR;var DR=(zw=hc("cc.FogInfo"),Gw=wc(),Vw=Bc(),Uw=zc(),kw=Bc(),Hw=zc(),jw=Bc(),Ww=Wc(gA),qw=zc(),Xw=Bc(),Yw=Ic(),Kw=Wc(De),Jw=Mc(),Qw=Lc(),Zw=Bc(),$w=Ic(),tP=Wc(De),eP=Lc(),nP=Bc(),iP=Ic(),rP=Wc(De),oP=Lc(),aP=Bc(),sP=Ic(),cP=Wc(De),lP=Oc(),uP=Lc(),hP=Bc(),_P=Ic(),fP=Wc(De),pP=Lc(),dP=Bc(),mP=Ic(),vP=Wc(De),gP=Lc(),yP=Bc(),zw(xP=Gw((MP=BP=function(){function t(){at(this,"_type",CP,this),at(this,"_fogColor",AP,this),at(this,"_enabled",bP,this),at(this,"_fogDensity",TP,this),at(this,"_fogStart",EP,this),at(this,"_fogEnd",wP,this),at(this,"_fogAtten",PP,this),at(this,"_fogTop",IP,this),at(this,"_fogRange",RP,this),at(this,"_accurate",DP,this),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this),this._resource.activate()},K(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}},{key:"accurate",get:function(){return this._accurate},set:function(t){this._accurate!==t&&(this._accurate=t,this._resource&&(this._resource.accurate=t,t&&(this._resource.type=this._type)))}},{key:"fogColor",get:function(){return this._fogColor},set:function(t){this._fogColor.set(t),this._resource&&(this._resource.fogColor=this._fogColor)}},{key:"type",get:function(){return this._type},set:function(t){this._type=t,this._resource&&(this._resource.type=t)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(t){this._fogDensity=t,this._resource&&(this._resource.fogDensity=t)}},{key:"fogStart",get:function(){return this._fogStart},set:function(t){this._fogStart=t,this._resource&&(this._resource.fogStart=t)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(t){this._fogEnd=t,this._resource&&(this._resource.fogEnd=t)}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(t){this._fogAtten=t,this._resource&&(this._resource.fogAtten=t)}},{key:"fogTop",get:function(){return this._fogTop},set:function(t){this._fogTop=t,this._resource&&(this._resource.fogTop=t)}},{key:"fogRange",get:function(){return this._fogRange},set:function(t){this._fogRange=t,this._resource&&(this._resource.fogRange=t)}}]),t}(),BP.FogType=gA,CP=st((SP=MP).prototype,"_type",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gA.LINEAR}}),AP=st(SP.prototype,"_fogColor",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new bn("#C8C8C8")}}),bP=st(SP.prototype,"_enabled",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),TP=st(SP.prototype,"_fogDensity",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),EP=st(SP.prototype,"_fogStart",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),wP=st(SP.prototype,"_fogEnd",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),PP=st(SP.prototype,"_fogAtten",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),IP=st(SP.prototype,"_fogTop",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),RP=st(SP.prototype,"_fogRange",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),DP=st(SP.prototype,"_accurate",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),st(SP.prototype,"enabled",[Pc,Vw,Uw],Object.getOwnPropertyDescriptor(SP.prototype,"enabled"),SP.prototype),st(SP.prototype,"accurate",[Pc,kw,Hw],Object.getOwnPropertyDescriptor(SP.prototype,"accurate"),SP.prototype),st(SP.prototype,"fogColor",[Pc,jw],Object.getOwnPropertyDescriptor(SP.prototype,"fogColor"),SP.prototype),st(SP.prototype,"type",[Pc,Ww,qw,Xw],Object.getOwnPropertyDescriptor(SP.prototype,"type"),SP.prototype),st(SP.prototype,"fogDensity",[Yw,Kw,Jw,Qw,Fc,Zw],Object.getOwnPropertyDescriptor(SP.prototype,"fogDensity"),SP.prototype),st(SP.prototype,"fogStart",[$w,tP,eP,nP],Object.getOwnPropertyDescriptor(SP.prototype,"fogStart"),SP.prototype),st(SP.prototype,"fogEnd",[iP,rP,oP,aP],Object.getOwnPropertyDescriptor(SP.prototype,"fogEnd"),SP.prototype),st(SP.prototype,"fogAtten",[sP,cP,lP,uP,hP],Object.getOwnPropertyDescriptor(SP.prototype,"fogAtten"),SP.prototype),st(SP.prototype,"fogTop",[_P,fP,pP,dP],Object.getOwnPropertyDescriptor(SP.prototype,"fogTop"),SP.prototype),st(SP.prototype,"fogRange",[mP,vP,gP,yP],Object.getOwnPropertyDescriptor(SP.prototype,"fogRange"),SP.prototype),xP=SP))||xP)||xP),BR=(OP=hc("cc.ShadowsInfo"),NP=wc(),LP=Bc(),FP=Wc(pg),zP=Ic(),GP=Ic(),VP=Bc(),UP=Wc(De),kP=Bc(),HP=Ic(),jP=Mc(),WP=Wc(De),qP=Bc(),XP=Ic(),YP=Wc(dg),KP=Bc(),JP=Ic(),QP=Wc(Re),ZP=Ic(),$P=Wc(De),tI=Bc(),eI=Ic(),nI=Wc(De),iI=Bc(),rI=Ic(),oI=Wc(fg),aI=Bc(),sI=Ic(),cI=Wc(Be),lI=Bc(),uI=Ic(),hI=Wc(De),_I=Bc(),fI=Ic(),pI=Wc(De),dI=Bc(),mI=Ic(),vI=Mc(),gI=Wc(De),yI=Bc(),xI=Ic(),SI=Mc(),CI=Wc(De),AI=Bc(),bI=Ic(),TI=Wc(De),EI=Bc(),wI=Ic(),OP(PI=NP((YI=function(){function t(){at(this,"_type",RI,this),at(this,"_enabled",DI,this),at(this,"_normal",BI,this),at(this,"_distance",MI,this),at(this,"_shadowColor",OI,this),at(this,"_firstSetCSM",NI,this),at(this,"_fixedArea",LI,this),at(this,"_pcf",FI,this),at(this,"_bias",zI,this),at(this,"_normalBias",GI,this),at(this,"_near",VI,this),at(this,"_far",UI,this),at(this,"_shadowDistance",kI,this),at(this,"_invisibleOcclusionRange",HI,this),at(this,"_orthoSize",jI,this),at(this,"_maxReceived",WI,this),at(this,"_size",qI,this),at(this,"_saturation",XI,this),this._resource=null}var e=t.prototype;return e.setPlaneFromNode=function(t){t.getWorldRotation(wR),this.normal=En.transformQuat(bR,AR,wR),t.getWorldPosition(bR),this.distance=En.dot(this._normal,bR)},e.activate=function(t){this.pcf=Math.min(this._pcf,dg.SOFT_2X),this._resource=t,this._resource.initialize(this),this._resource.activate()},K(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}},{key:"type",get:function(){return this._type},set:function(t){this._type=t,this._resource&&(this._resource.type=t)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(t){this._shadowColor.set(t),this._resource&&(this._resource.shadowColor=t)}},{key:"normal",get:function(){return this._normal},set:function(t){En.copy(this._normal,t),this._resource&&(this._resource.normal=t)}},{key:"distance",get:function(){return this._distance},set:function(t){this._distance=t,this._resource&&(this._resource.distance=t)}},{key:"saturation",get:function(){return this._saturation},set:function(t){t>1?(this._saturation=t/t,this._resource&&(this._resource.saturation=t/t)):(this._saturation=t,this._resource&&(this._resource.saturation=t))}},{key:"pcf",get:function(){return this._pcf},set:function(t){this._pcf=t,this._resource&&(this._resource.pcf=t)}},{key:"maxReceived",get:function(){return this._maxReceived},set:function(t){this._maxReceived=t,this._resource&&(this._resource.maxReceived=t)}},{key:"bias",get:function(){return this._bias},set:function(t){this._bias=t,this._resource&&(this._resource.bias=t)}},{key:"normalBias",get:function(){return this._normalBias},set:function(t){this._normalBias=t,this._resource&&(this._resource.normalBias=t)}},{key:"shadowMapSize",get:function(){return this._size.x},set:function(t){this._size.set(t,t),this._resource&&(this._resource.size.set(t,t),this._resource.shadowMapDirty=!0)}},{key:"size",get:function(){return this._size}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(t){this._fixedArea=t,this._resource&&(this._resource.fixedArea=t)}},{key:"near",get:function(){return this._near},set:function(t){this._near=t,this._resource&&(this._resource.near=t)}},{key:"far",get:function(){return this._far},set:function(t){this._far=Math.min(t,vg.MAX_FAR),this._resource&&(this._resource.far=this._far)}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(t){this._invisibleOcclusionRange=Math.min(t,vg.MAX_FAR),this._resource&&(this._resource.invisibleOcclusionRange=this._invisibleOcclusionRange)}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(t){this._shadowDistance=Math.min(t,vg.MAX_FAR),this._resource&&(this._resource.shadowDistance=this._shadowDistance)}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(t){this._orthoSize=t,this._resource&&(this._resource.orthoSize=t)}}]),t}(),RI=st((II=YI).prototype,"_type",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pg.Planar}}),DI=st(II.prototype,"_enabled",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),BI=st(II.prototype,"_normal",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new En(0,1,0)}}),MI=st(II.prototype,"_distance",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),OI=st(II.prototype,"_shadowColor",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new bn(0,0,0,76)}}),NI=st(II.prototype,"_firstSetCSM",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),LI=st(II.prototype,"_fixedArea",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),FI=st(II.prototype,"_pcf",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dg.HARD}}),zI=st(II.prototype,"_bias",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),GI=st(II.prototype,"_normalBias",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),VI=st(II.prototype,"_near",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),UI=st(II.prototype,"_far",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),kI=st(II.prototype,"_shadowDistance",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),HI=st(II.prototype,"_invisibleOcclusionRange",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 200}}),jI=st(II.prototype,"_orthoSize",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),WI=st(II.prototype,"_maxReceived",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),qI=st(II.prototype,"_size",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wn(512,512)}}),XI=st(II.prototype,"_saturation",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.75}}),st(II.prototype,"enabled",[Pc,LP],Object.getOwnPropertyDescriptor(II.prototype,"enabled"),II.prototype),st(II.prototype,"type",[Pc,FP],Object.getOwnPropertyDescriptor(II.prototype,"type"),II.prototype),st(II.prototype,"shadowColor",[zP],Object.getOwnPropertyDescriptor(II.prototype,"shadowColor"),II.prototype),st(II.prototype,"normal",[GP,VP],Object.getOwnPropertyDescriptor(II.prototype,"normal"),II.prototype),st(II.prototype,"distance",[UP,kP,HP],Object.getOwnPropertyDescriptor(II.prototype,"distance"),II.prototype),st(II.prototype,"saturation",[Pc,jP,Fc,WP,qP,XP],Object.getOwnPropertyDescriptor(II.prototype,"saturation"),II.prototype),st(II.prototype,"pcf",[YP,KP,JP],Object.getOwnPropertyDescriptor(II.prototype,"pcf"),II.prototype),st(II.prototype,"maxReceived",[QP,ZP],Object.getOwnPropertyDescriptor(II.prototype,"maxReceived"),II.prototype),st(II.prototype,"bias",[$P,tI,eI],Object.getOwnPropertyDescriptor(II.prototype,"bias"),II.prototype),st(II.prototype,"normalBias",[nI,iI,rI],Object.getOwnPropertyDescriptor(II.prototype,"normalBias"),II.prototype),st(II.prototype,"shadowMapSize",[oI,aI,sI],Object.getOwnPropertyDescriptor(II.prototype,"shadowMapSize"),II.prototype),st(II.prototype,"fixedArea",[cI,lI,uI],Object.getOwnPropertyDescriptor(II.prototype,"fixedArea"),II.prototype),st(II.prototype,"near",[hI,_I,fI],Object.getOwnPropertyDescriptor(II.prototype,"near"),II.prototype),st(II.prototype,"far",[pI,dI,mI],Object.getOwnPropertyDescriptor(II.prototype,"far"),II.prototype),st(II.prototype,"invisibleOcclusionRange",[Pc,vI,Fc,gI,yI,xI],Object.getOwnPropertyDescriptor(II.prototype,"invisibleOcclusionRange"),II.prototype),st(II.prototype,"shadowDistance",[Pc,SI,Fc,CI,AI,bI],Object.getOwnPropertyDescriptor(II.prototype,"shadowDistance"),II.prototype),st(II.prototype,"orthoSize",[TI,EI,wI],Object.getOwnPropertyDescriptor(II.prototype,"orthoSize"),II.prototype),PI=II))||PI)||PI);c.ShadowsInfo=BR;var MR=new En(-1024,-1024,-1024),OR=new En(1024,1024,1024),NR=(KI=hc("cc.OctreeInfo"),JI=wc(),QI=Bc(),ZI=Bc(),$I=Dc(),tR=Bc(),eR=Dc(),nR=Mc(),iR=Wc(Re),rR=Bc(),KI(oR=JI((hR=function(){function t(){at(this,"_enabled",sR,this),at(this,"_minPos",cR,this),at(this,"_maxPos",lR,this),at(this,"_depth",uR,this),this._resource=null}return t.prototype.activate=function(t){this._resource=t,this._resource.initialize(this)},K(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t))}},{key:"minPos",get:function(){return this._minPos},set:function(t){this._minPos=t,this._resource&&(this._resource.minPos=t)}},{key:"maxPos",get:function(){return this._maxPos},set:function(t){this._maxPos=t,this._resource&&(this._resource.maxPos=t)}},{key:"depth",get:function(){return this._depth},set:function(t){this._depth=t,this._resource&&(this._resource.depth=t)}}]),t}(),sR=st((aR=hR).prototype,"_enabled",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),cR=st(aR.prototype,"_minPos",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new En(MR)}}),lR=st(aR.prototype,"_maxPos",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new En(OR)}}),uR=st(aR.prototype,"_depth",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 8}}),st(aR.prototype,"enabled",[Pc,QI],Object.getOwnPropertyDescriptor(aR.prototype,"enabled"),aR.prototype),st(aR.prototype,"minPos",[Pc,ZI,$I],Object.getOwnPropertyDescriptor(aR.prototype,"minPos"),aR.prototype),st(aR.prototype,"maxPos",[Pc,tR,eR],Object.getOwnPropertyDescriptor(aR.prototype,"maxPos"),aR.prototype),st(aR.prototype,"depth",[Pc,nR,iR,rR],Object.getOwnPropertyDescriptor(aR.prototype,"depth"),aR.prototype),oR=aR))||oR)||oR),LR=(_R=hc("cc.SceneGlobals"),fR=Wc(RR),_R((SR=function(){function t(){at(this,"ambient",mR,this),at(this,"shadows",vR,this),at(this,"_skybox",gR,this),at(this,"fog",yR,this),at(this,"octree",xR,this)}return t.prototype.activate=function(){var t=c.director.root.pipeline.pipelineSceneData;this.skybox.activate(t.skybox),this.ambient.activate(t.ambient),this.shadows.activate(t.shadows),this.fog.activate(t.fog),this.octree.activate(t.octree)},K(t,[{key:"skybox",get:function(){return this._skybox},set:function(t){this._skybox=t}}]),t}(),mR=st((dR=SR).prototype,"ambient",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new IR}}),vR=st(dR.prototype,"shadows",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new BR}}),gR=st(dR.prototype,"_skybox",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new RR}}),yR=st(dR.prototype,"fog",[Pc,vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new DR}}),st(dR.prototype,"skybox",[Pc,fR],Object.getOwnPropertyDescriptor(dR.prototype,"skybox"),dR.prototype),xR=st(dR.prototype,"octree",[Pc,vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new NR}}),pR=dR))||pR);c.SceneGlobals=LR;var FR=t("Event",function(){function t(t,e){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=t,this.bubbles=!!e}var e=t.prototype;return e.unuse=function(){this.type=t.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=t.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1},e.reuse=function(t,e){this.type=t,this.bubbles=e||!1},e.isStopped=function(){return this.propagationStopped||this.propagationImmediateStopped},e.getCurrentTarget=function(){return this.currentTarget},e.getType=function(){return this.type},t}());FR.NO_TYPE="no_type",FR.TOUCH="touch",FR.MOUSE="mouse",FR.KEYBOARD="keyboard",FR.ACCELERATION="acceleration",FR.NONE=0,FR.CAPTURING_PHASE=1,FR.AT_TARGET=2,FR.BUBBLING_PHASE=3,c.Event=FR;var zR=t("EventAcceleration",function(t){function e(e,n){var i;return(i=t.call(this,OE.DEVICEMOTION,n)||this).acc=void 0,i.acc=e,i}return Q(e,t),e}(FR));FR.EventAcceleration=zR;var GR=t("EventKeyboard",function(t){function e(e,n,i){var r;return"boolean"==typeof n&&(n=n?OE.KEY_DOWN:OE.KEY_UP),(r=t.call(this,n,i)||this).keyCode=void 0,r.rawEvent=void 0,r._isPressed=void 0,r._isPressed=n!==OE.KEY_UP,"number"==typeof e?r.keyCode=e:(r.keyCode=e.keyCode,r.rawEvent=e),r}return Q(e,t),K(e,[{key:"isPressed",get:function(){return this._isPressed}}]),e}(FR));FR.EventKeyboard=GR;var VR=t("EventMouse",function(t){function e(n,i,r){var o;return(o=t.call(this,n,i)||this).movementX=0,o.movementY=0,o.preventSwallow=!1,o._eventType=void 0,o._button=e.BUTTON_MISSING,o._x=0,o._y=0,o._prevX=0,o._prevY=0,o._scrollX=0,o._scrollY=0,o._eventType=n,r&&(o._prevX=r.x,o._prevY=r.y),o}Q(e,t);var n=e.prototype;return n.setScrollData=function(t,e){this._scrollX=t,this._scrollY=e},n.getScrollX=function(){return this._scrollX},n.getScrollY=function(){return this._scrollY},n.setLocation=function(t,e){this._x=t,this._y=e},n.getLocation=function(t){return t||(t=new Wn),Wn.set(t,this._x,this._y),t},n.getLocationInView=function(t){return t||(t=new Wn),Wn.set(t,this._x,c.view._designResolutionSize.height-this._y),t},n.getUILocation=function(t){return t||(t=new Wn),Wn.set(t,this._x,this._y),c.view._convertToUISpace(t),t},n.getPreviousLocation=function(t){return t||(t=new Wn),Wn.set(t,this._prevX,this._prevY),t},n.getUIPreviousLocation=function(t){return t||(t=new Wn),Wn.set(t,this._prevX,this._prevY),c.view._convertToUISpace(t),t},n.getDelta=function(t){return t||(t=new Wn),Wn.set(t,this._x-this._prevX,this._y-this._prevY),t},n.getDeltaX=function(){return this._x-this._prevX},n.getDeltaY=function(){return this._y-this._prevY},n.getUIDelta=function(t){return t||(t=new Wn),Wn.set(t,(this._x-this._prevX)/c.view.getScaleX(),(this._y-this._prevY)/c.view.getScaleY()),t},n.getUIDeltaX=function(){return(this._x-this._prevX)/c.view.getScaleX()},n.getUIDeltaY=function(){return(this._y-this._prevY)/c.view.getScaleY()},n.setButton=function(t){this._button=t},n.getButton=function(){return this._button},n.getLocationX=function(){return this._x},n.getLocationY=function(){return this._y},n.getUILocationX=function(){var t=c.view.getViewportRect();return(this._x-t.x)/c.view.getScaleX()},n.getUILocationY=function(){var t=c.view.getViewportRect();return(this._y-t.y)/c.view.getScaleY()},K(e,[{key:"eventType",get:function(){return this._eventType}}]),e}(FR));VR.BUTTON_MISSING=-1,VR.BUTTON_LEFT=0,VR.BUTTON_RIGHT=2,VR.BUTTON_MIDDLE=1,VR.BUTTON_4=3,VR.BUTTON_5=4,VR.BUTTON_6=5,VR.BUTTON_7=6,VR.BUTTON_8=7,FR.EventMouse=VR;var UR=new Wn,kR=t("EventTouch",function(t){function e(e,n,i,r){var o;return void 0===r&&(r=[]),(o=t.call(this,i,n)||this).touch=null,o.simulate=!1,o.preventSwallow=!1,o._eventCode=void 0,o._touches=void 0,o._allTouches=void 0,o._eventCode=i,o._touches=e||[],o._allTouches=r,o}Q(e,t);var n=e.prototype;return n.getEventCode=function(){return this._eventCode},n.getTouches=function(){return this._touches},n.getAllTouches=function(){return this._allTouches},n.setLocation=function(t,e){this.touch&&this.touch.setTouchInfo(this.touch.getID(),t,e)},n.getLocation=function(t){return this.touch?this.touch.getLocation(t):new Wn},n.getUILocation=function(t){return this.touch?this.touch.getUILocation(t):new Wn},n.getLocationInView=function(t){return this.touch?this.touch.getLocationInView(t):new Wn},n.getPreviousLocation=function(t){return this.touch?this.touch.getPreviousLocation(t):new Wn},n.getStartLocation=function(t){return this.touch?this.touch.getStartLocation(t):new Wn},n.getUIStartLocation=function(t){return this.touch?this.touch.getUIStartLocation(t):new Wn},n.getID=function(){return this.touch?this.touch.getID():null},n.getDelta=function(t){return this.touch?this.touch.getDelta(t):new Wn},n.getUIDelta=function(t){return this.touch?this.touch.getUIDelta(t):new Wn},n.getDeltaX=function(){return this.touch?this.touch.getDelta(UR).x:0},n.getDeltaY=function(){return this.touch?this.touch.getDelta(UR).y:0},n.getLocationX=function(){return this.touch?this.touch.getLocationX():0},n.getLocationY=function(){return this.touch?this.touch.getLocationY():0},e}(FR));kR.MAX_TOUCHES=5,FR.EventTouch=kR;var HR,jR=t("Acceleration",(function(t,e,n,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=t,this.y=e,this.z=n,this.timestamp=i}));!function(t){t[t.NONE=0]="NONE",t[t.MOBILE_BACK=6]="MOBILE_BACK",t[t.BACKSPACE=8]="BACKSPACE",t[t.TAB=9]="TAB",t[t.ENTER=13]="ENTER",t[t.SHIFT_LEFT=16]="SHIFT_LEFT",t[t.CTRL_LEFT=17]="CTRL_LEFT",t[t.ALT_LEFT=18]="ALT_LEFT",t[t.PAUSE=19]="PAUSE",t[t.CAPS_LOCK=20]="CAPS_LOCK",t[t.ESCAPE=27]="ESCAPE",t[t.SPACE=32]="SPACE",t[t.PAGE_UP=33]="PAGE_UP",t[t.PAGE_DOWN=34]="PAGE_DOWN",t[t.END=35]="END",t[t.HOME=36]="HOME",t[t.ARROW_LEFT=37]="ARROW_LEFT",t[t.ARROW_UP=38]="ARROW_UP",t[t.ARROW_RIGHT=39]="ARROW_RIGHT",t[t.ARROW_DOWN=40]="ARROW_DOWN",t[t.INSERT=45]="INSERT",t[t.DELETE=46]="DELETE",t[t.DIGIT_0=48]="DIGIT_0",t[t.DIGIT_1=49]="DIGIT_1",t[t.DIGIT_2=50]="DIGIT_2",t[t.DIGIT_3=51]="DIGIT_3",t[t.DIGIT_4=52]="DIGIT_4",t[t.DIGIT_5=53]="DIGIT_5",t[t.DIGIT_6=54]="DIGIT_6",t[t.DIGIT_7=55]="DIGIT_7",t[t.DIGIT_8=56]="DIGIT_8",t[t.DIGIT_9=57]="DIGIT_9",t[t.KEY_A=65]="KEY_A",t[t.KEY_B=66]="KEY_B",t[t.KEY_C=67]="KEY_C",t[t.KEY_D=68]="KEY_D",t[t.KEY_E=69]="KEY_E",t[t.KEY_F=70]="KEY_F",t[t.KEY_G=71]="KEY_G",t[t.KEY_H=72]="KEY_H",t[t.KEY_I=73]="KEY_I",t[t.KEY_J=74]="KEY_J",t[t.KEY_K=75]="KEY_K",t[t.KEY_L=76]="KEY_L",t[t.KEY_M=77]="KEY_M",t[t.KEY_N=78]="KEY_N",t[t.KEY_O=79]="KEY_O",t[t.KEY_P=80]="KEY_P",t[t.KEY_Q=81]="KEY_Q",t[t.KEY_R=82]="KEY_R",t[t.KEY_S=83]="KEY_S",t[t.KEY_T=84]="KEY_T",t[t.KEY_U=85]="KEY_U",t[t.KEY_V=86]="KEY_V",t[t.KEY_W=87]="KEY_W",t[t.KEY_X=88]="KEY_X",t[t.KEY_Y=89]="KEY_Y",t[t.KEY_Z=90]="KEY_Z",t[t.NUM_0=96]="NUM_0",t[t.NUM_1=97]="NUM_1",t[t.NUM_2=98]="NUM_2",t[t.NUM_3=99]="NUM_3",t[t.NUM_4=100]="NUM_4",t[t.NUM_5=101]="NUM_5",t[t.NUM_6=102]="NUM_6",t[t.NUM_7=103]="NUM_7",t[t.NUM_8=104]="NUM_8",t[t.NUM_9=105]="NUM_9",t[t.NUM_MULTIPLY=106]="NUM_MULTIPLY",t[t.NUM_PLUS=107]="NUM_PLUS",t[t.NUM_SUBTRACT=109]="NUM_SUBTRACT",t[t.NUM_DECIMAL=110]="NUM_DECIMAL",t[t.NUM_DIVIDE=111]="NUM_DIVIDE",t[t.F1=112]="F1",t[t.F2=113]="F2",t[t.F3=114]="F3",t[t.F4=115]="F4",t[t.F5=116]="F5",t[t.F6=117]="F6",t[t.F7=118]="F7",t[t.F8=119]="F8",t[t.F9=120]="F9",t[t.F10=121]="F10",t[t.F11=122]="F11",t[t.F12=123]="F12",t[t.NUM_LOCK=144]="NUM_LOCK",t[t.SCROLL_LOCK=145]="SCROLL_LOCK",t[t.SEMICOLON=186]="SEMICOLON",t[t.EQUAL=187]="EQUAL",t[t.COMMA=188]="COMMA",t[t.DASH=189]="DASH",t[t.PERIOD=190]="PERIOD",t[t.SLASH=191]="SLASH",t[t.BACK_QUOTE=192]="BACK_QUOTE",t[t.BRACKET_LEFT=219]="BRACKET_LEFT",t[t.BACKSLASH=220]="BACKSLASH",t[t.BRACKET_RIGHT=221]="BRACKET_RIGHT",t[t.QUOTE=222]="QUOTE",t[t.SHIFT_RIGHT=2e3]="SHIFT_RIGHT",t[t.CTRL_RIGHT=2001]="CTRL_RIGHT",t[t.ALT_RIGHT=2002]="ALT_RIGHT",t[t.NUM_ENTER=2003]="NUM_ENTER"}(HR||(HR=t("KeyCode",{})));var WR=new Wn,qR=t("Touch",function(){function t(t,e,n){void 0===n&&(n=0),this._point=new Wn,this._prevPoint=new Wn,this._lastModified=0,this._id=0,this._startPoint=new Wn,this._startPointCaptured=!1,this.setTouchInfo(n,t,e)}var e=t.prototype;return e.getLocation=function(t){return t||(t=new Wn),t.set(this._point.x,this._point.y),t},e.getLocationX=function(){return this._point.x},e.getLocationY=function(){return this._point.y},e.getUILocation=function(t){return t||(t=new Wn),t.set(this._point.x,this._point.y),c.view._convertToUISpace(t),t},e.getUILocationX=function(){var t=c.view.getViewportRect();return(this._point.x-t.x)/c.view.getScaleX()},e.getUILocationY=function(){var t=c.view.getViewportRect();return(this._point.y-t.y)/c.view.getScaleY()},e.getPreviousLocation=function(t){return t||(t=new Wn),t.set(this._prevPoint.x,this._prevPoint.y),t},e.getUIPreviousLocation=function(t){return t||(t=new Wn),t.set(this._prevPoint.x,this._prevPoint.y),c.view._convertToUISpace(t),t},e.getStartLocation=function(t){return t||(t=new Wn),t.set(this._startPoint.x,this._startPoint.y),t},e.getUIStartLocation=function(t){return t||(t=new Wn),t.set(this._startPoint.x,this._startPoint.y),c.view._convertToUISpace(t),t},e.getDelta=function(t){return t||(t=new Wn),t.set(this._point),t.subtract(this._prevPoint),t},e.getUIDelta=function(t){return t||(t=new Wn),WR.set(this._point),WR.subtract(this._prevPoint),t.set(c.view.getScaleX(),c.view.getScaleY()),Wn.divide(t,WR,t),t},e.getLocationInView=function(t){return t||(t=new Wn),t.set(this._point.x,c.view._designResolutionSize.height-this._point.y),t},e.getPreviousLocationInView=function(t){return t||(t=new Wn),t.set(this._prevPoint.x,c.view._designResolutionSize.height-this._prevPoint.y),t},e.getStartLocationInView=function(t){return t||(t=new Wn),t.set(this._startPoint.x,c.view._designResolutionSize.height-this._startPoint.y),t},e.getID=function(){return this._id},e.setTouchInfo=function(t,e,n){void 0===t&&(t=0),this._prevPoint=this._point,this._point=new Wn(e||0,n||0),this._id=t,this._startPointCaptured||(this._startPoint=new Wn(this._point),this._startPointCaptured=!0)},e.setPoint=function(t,e){"object"==typeof t?(this._point.x=t.x,this._point.y=t.y):(this._point.x=t||0,this._point.y=e||0),this._lastModified=c.game.frameStartTime},e.setPrevPoint=function(t,e){this._prevPoint="object"==typeof t?new Wn(t.x,t.y):new Wn(t||0,e||0),this._lastModified=c.game.frameStartTime},K(t,[{key:"lastModified",get:function(){return this._lastModified}}]),t}());c.Touch=qR;var XR,YR,KR=function(){function t(){this._intervalInMileSeconds=200,this._accelTimer=0,this._eventTarget=new Ql,this._deviceEventName=void 0,this._globalEventClass=void 0,this._didAccelerateFunc=void 0,this._globalEventClass=window.DeviceMotionEvent||window.DeviceOrientationEvent,hu.browserType===$l.MOBILE_QQ&&(this._globalEventClass=window.DeviceOrientationEvent),this._deviceEventName=this._globalEventClass===window.DeviceMotionEvent?"devicemotion":"deviceorientation",this._didAccelerateFunc=this._didAccelerate.bind(this)}var e=t.prototype;return e._registerEvent=function(){this._accelTimer=performance.now(),window.addEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},e._unregisterEvent=function(){this._accelTimer=0,window.removeEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},e._didAccelerate=function(t){var e=performance.now();if(!(e-this._accelTimer<this._intervalInMileSeconds)){this._accelTimer=e;var n=0,i=0,r=0;if(this._globalEventClass===window.DeviceMotionEvent){var o=t.accelerationIncludingGravity;n=.1*((null==o?void 0:o.x)||0),i=.1*((null==o?void 0:o.y)||0),r=.1*((null==o?void 0:o.z)||0)}else{var a=t;n=(a.gamma||0)/90*.981,i=-(a.beta||0)/90*.981,r=(a.alpha||0)/90*.981}if(nh.isFrameRotated){var s=n;n=-i,i=s}var c=n;90===window.orientation?(n=-i,i=c):-90===window.orientation?(n=i,i=-c):180===window.orientation&&(n=-n,i=-i),hu.os===nu.ANDROID&&hu.browserType!==$l.MOBILE_QQ&&(n=-n,i=-i);var l=performance.now(),u=new jR(n,i,r,l),h=new zR(u);this._eventTarget.emit(NE.DEVICEMOTION,h)}},e.start=function(){var t=this;window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((function(e){"granted"===e&&t._registerEvent()})).catch((function(){})):this._registerEvent()},e.stop=function(){this._unregisterEvent()},e.setInterval=function(t){this._intervalInMileSeconds=t},e.on=function(t,e,n){this._eventTarget.on(t,e,n)},t}(),JR={Backspace:HR.BACKSPACE,Tab:HR.TAB,Enter:HR.ENTER,ShiftLeft:HR.SHIFT_LEFT,ControlLeft:HR.CTRL_LEFT,AltLeft:HR.ALT_LEFT,ShiftRight:HR.SHIFT_RIGHT,ControlRight:HR.CTRL_RIGHT,AltRight:HR.ALT_RIGHT,Pause:HR.PAUSE,CapsLock:HR.CAPS_LOCK,Escape:HR.ESCAPE,Space:HR.SPACE,PageUp:HR.PAGE_UP,PageDown:HR.PAGE_DOWN,End:HR.END,Home:HR.HOME,ArrowLeft:HR.ARROW_LEFT,ArrowUp:HR.ARROW_UP,ArrowRight:HR.ARROW_RIGHT,ArrowDown:HR.ARROW_DOWN,Insert:HR.INSERT,Delete:HR.DELETE,Digit0:HR.DIGIT_0,Digit1:HR.DIGIT_1,Digit2:HR.DIGIT_2,Digit3:HR.DIGIT_3,Digit4:HR.DIGIT_4,Digit5:HR.DIGIT_5,Digit6:HR.DIGIT_6,Digit7:HR.DIGIT_7,Digit8:HR.DIGIT_8,Digit9:HR.DIGIT_9,KeyA:HR.KEY_A,KeyB:HR.KEY_B,KeyC:HR.KEY_C,KeyD:HR.KEY_D,KeyE:HR.KEY_E,KeyF:HR.KEY_F,KeyG:HR.KEY_G,KeyH:HR.KEY_H,KeyI:HR.KEY_I,KeyJ:HR.KEY_J,KeyK:HR.KEY_K,KeyL:HR.KEY_L,KeyM:HR.KEY_M,KeyN:HR.KEY_N,KeyO:HR.KEY_O,KeyP:HR.KEY_P,KeyQ:HR.KEY_Q,KeyR:HR.KEY_R,KeyS:HR.KEY_S,KeyT:HR.KEY_T,KeyU:HR.KEY_U,KeyV:HR.KEY_V,KeyW:HR.KEY_W,KeyX:HR.KEY_X,KeyY:HR.KEY_Y,KeyZ:HR.KEY_Z,Numpad0:HR.NUM_0,Numpad1:HR.NUM_1,Numpad2:HR.NUM_2,Numpad3:HR.NUM_3,Numpad4:HR.NUM_4,Numpad5:HR.NUM_5,Numpad6:HR.NUM_6,Numpad7:HR.NUM_7,Numpad8:HR.NUM_8,Numpad9:HR.NUM_9,NumpadMultiply:HR.NUM_MULTIPLY,NumpadAdd:HR.NUM_PLUS,NumpadSubtract:HR.NUM_SUBTRACT,NumpadDecimal:HR.NUM_DECIMAL,NumpadDivide:HR.NUM_DIVIDE,NumpadEnter:HR.NUM_ENTER,F1:HR.F1,F2:HR.F2,F3:HR.F3,F4:HR.F4,F5:HR.F5,F6:HR.F6,F7:HR.F7,F8:HR.F8,F9:HR.F9,F10:HR.F10,F11:HR.F11,F12:HR.F12,NumLock:HR.NUM_LOCK,ScrollLock:HR.SCROLL_LOCK,Semicolon:HR.SEMICOLON,Equal:HR.EQUAL,Comma:HR.COMMA,Minus:HR.DASH,Period:HR.PERIOD,Slash:HR.SLASH,Backquote:HR.BACK_QUOTE,BracketLeft:HR.BRACKET_LEFT,Backslash:HR.BACKSLASH,BracketRight:HR.BRACKET_RIGHT,Quote:HR.QUOTE},QR=function(){function t(){this._eventTarget=new Ql,this._registerEvent()}var e=t.prototype;return e._registerEvent=function(){var t=this,e=document.getElementById("GameCanvas");null==e||e.addEventListener("keydown",(function(e){if(e.stopPropagation(),e.preventDefault(),e.repeat){var n=t._getInputEvent(e,NE.KEY_PRESSING);t._eventTarget.emit(NE.KEY_PRESSING,n)}else{var i=t._getInputEvent(e,NE.KEY_DOWN);t._eventTarget.emit(NE.KEY_DOWN,i)}})),null==e||e.addEventListener("keyup",(function(e){var n=t._getInputEvent(e,NE.KEY_UP);e.stopPropagation(),e.preventDefault(),t._eventTarget.emit(NE.KEY_UP,n)}))},e._getInputEvent=function(t,e){var n,i=(n=t.code,JR[n]||HR.NONE);return new GR(i,e)},e.on=function(t,e,n){this._eventTarget.on(t,e,n)},t}(),ZR=function(){function t(){this._canvas=void 0,this._eventTarget=new Ql,this._pointLocked=!1,this._isPressed=!1,this._preMousePos=new Wn,hu.hasFeature(ru.EVENT_MOUSE)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var e=t.prototype;return e._getCanvasRect=function(){var t=this._canvas,e=null==t?void 0:t.getBoundingClientRect();return e?new ti(e.x,e.y,e.width,e.height):new ti(0,0,0,0)},e._getLocation=function(t){var e=this._getCanvasRect(),n=nh.devicePixelRatio,i=this._pointLocked?this._preMousePos.x/n+t.movementX:t.clientX-e.x,r=this._pointLocked?this._preMousePos.y/n-t.movementY:e.y+e.height-t.clientY;return new Wn(i*=n,r*=n)},e._registerEvent=function(){var t,e,n,i,r=this;window.addEventListener("mousedown",(function(){r._isPressed=!0})),null===(t=this._canvas)||void 0===t||t.addEventListener("mousedown",this._createCallback(NE.MOUSE_DOWN)),null===(e=this._canvas)||void 0===e||e.addEventListener("mousemove",this._createCallback(NE.MOUSE_MOVE));var o=this._createCallback(NE.MOUSE_UP);window.addEventListener("mouseup",o),null===(n=this._canvas)||void 0===n||n.addEventListener("mouseup",o),null===(i=this._canvas)||void 0===i||i.addEventListener("wheel",this._handleMouseWheel.bind(this)),this._registerPointerLockEvent()},e._registerPointerLockEvent=function(){var t=this,e=function(){var e=t._canvas;document.pointerLockElement===e||document.mozPointerLockElement===e?t._pointLocked=!0:t._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",e,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",e,!1)},e._createCallback=function(t){var e=this;return function(n){var i,r=e._getLocation(n),o=n.button;switch(t){case NE.MOUSE_DOWN:null===(i=e._canvas)||void 0===i||i.focus(),e._isPressed=!0;break;case NE.MOUSE_UP:e._isPressed=!1;break;case NE.MOUSE_MOVE:e._isPressed||(o=VR.BUTTON_MISSING)}var a=new VR(t,!1,e._preMousePos);a.setLocation(r.x,r.y),a.setButton(o),a.movementX=n.movementX,a.movementY=n.movementY,e._preMousePos.set(r.x,r.y),n.stopPropagation(),n.target===e._canvas&&n.preventDefault(),e._eventTarget.emit(t,a)}},e._handleMouseWheel=function(t){var e=NE.MOUSE_WHEEL,n=this._getLocation(t),i=t.button,r=new VR(e,!1,this._preMousePos);r.setLocation(n.x,n.y),r.setButton(i),r.movementX=t.movementX,r.movementY=t.movementY,r.setScrollData(5*t.deltaX,5*-t.deltaY),this._preMousePos.set(n.x,n.y),t.stopPropagation(),t.target===this._canvas&&t.preventDefault(),this._eventTarget.emit(e,r)},e.on=function(t,e,n){this._eventTarget.on(t,e,n)},t}(),$R=new Wn,tD=new(function(){function t(){this._touchMap=void 0,this._maxTouches=8,this._touchMap=new Map}var e=t.prototype;return e._cloneTouch=function(t){var e=t.getID();t.getStartLocation($R);var n=new qR($R.x,$R.y,e);return t.getLocation($R),n.setPoint($R.x,$R.y),t.getPreviousLocation($R),n.setPrevPoint($R),n},e._createTouch=function(t,e,n){if(this._touchMap.has(t))console.log("Cannot create the same touch object.");else{if(!this._checkTouchMapSizeMoreThanMax(t)){var i=new qR(e,n,t);return this._touchMap.set(t,i),this._updateTouch(i,e,n),this._cloneTouch(i)}console.log("The touches is more than MAX_TOUCHES.")}},e.releaseTouch=function(t){this._touchMap.has(t)&&this._touchMap.delete(t)},e.getTouch=function(t,e,n){var i=this._touchMap.get(t);return i?this._updateTouch(i,e,n):i=this._createTouch(t,e,n),i?this._cloneTouch(i):void 0},e.getAllTouches=function(){var t=this,e=[];return this._touchMap.forEach((function(n){if(n){var i=t._cloneTouch(n);e.push(i)}})),e},e._updateTouch=function(t,e,n){t.getLocation($R),t.setPrevPoint($R),t.setPoint(e,n)},e._checkTouchMapSizeMoreThanMax=function(t){var e=this;if(this._touchMap.has(t))return!1;var n=ce.ENABLE_MULTI_TOUCH?this._maxTouches:1;if(this._touchMap.size<n)return!1;var i=performance.now();return this._touchMap.forEach((function(t){i-t.lastModified>ce.TOUCH_TIMEOUT&&(console.log("The touches is more than MAX_TOUCHES, release touch id "+t.getID()+"."),e.releaseTouch(t.getID()))})),n>=this._touchMap.size},t}()),eD=function(){function t(){this._canvas=void 0,this._eventTarget=new Ql,hu.hasFeature(ru.INPUT_TOUCH)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var e=t.prototype;return e._registerEvent=function(){var t,e,n,i;null===(t=this._canvas)||void 0===t||t.addEventListener("touchstart",this._createCallback(NE.TOUCH_START)),null===(e=this._canvas)||void 0===e||e.addEventListener("touchmove",this._createCallback(NE.TOUCH_MOVE)),null===(n=this._canvas)||void 0===n||n.addEventListener("touchend",this._createCallback(NE.TOUCH_END)),null===(i=this._canvas)||void 0===i||i.addEventListener("touchcancel",this._createCallback(NE.TOUCH_CANCEL))},e._createCallback=function(t){var e=this;return function(n){for(var i,r=e._getCanvasRect(),o=[],a=n.changedTouches.length,s=0;s<a;++s){var c=n.changedTouches[s],l=c.identifier;if(null!==l){var u=e._getLocation(c,r),h=tD.getTouch(l,u.x,u.y);h&&(t!==NE.TOUCH_END&&t!==NE.TOUCH_CANCEL||tD.releaseTouch(l),o.push(h))}}if(n.stopPropagation(),n.target===e._canvas&&n.preventDefault(),t===NE.TOUCH_START&&(null===(i=e._canvas)||void 0===i||i.focus()),o.length>0){var _=new kR(o,!1,t,ce.ENABLE_MULTI_TOUCH?tD.getAllTouches():o);e._eventTarget.emit(t,_)}}},e._getCanvasRect=function(){var t=this._canvas,e=null==t?void 0:t.getBoundingClientRect();return e?new ti(e.x,e.y,e.width,e.height):new ti(0,0,0,0)},e._getLocation=function(t,e){var n=t.clientX-e.x,i=e.y+e.height-t.clientY;if(nh.isFrameRotated){var r=n;n=e.height-i,i=r}var o=nh.devicePixelRatio;return new Wn(n*=o,i*=o)},e.on=function(t,e,n){this._eventTarget.on(t,e,n)},t}();!function(t){t[t.GLOBAL=0]="GLOBAL",t[t.UI=1]="UI"}(YR||(YR={}));var nD=function(){function t(t){this.priority=YR.GLOBAL,this._inputEventTarget=void 0,this._inputEventTarget=t}return t.prototype.dispatchEvent=function(t){return this._inputEventTarget.emit(t.type,t),!0},t}(),iD=((XR={})[NE.MOUSE_DOWN]=NE.TOUCH_START,XR[NE.MOUSE_MOVE]=NE.TOUCH_MOVE,XR[NE.MOUSE_UP]=NE.TOUCH_END,XR),rD=t("Input",function(){function t(){this._dispatchImmediately=!0,this._eventTarget=new Ql,this._touchInput=new eD,this._mouseInput=new ZR,this._keyboardInput=new QR,this._accelerometerInput=new KR,this._eventTouchList=[],this._eventMouseList=[],this._eventKeyboardList=[],this._eventAccelerationList=[],this._needSimulateTouchMoveEvent=!1,this._inputEventDispatcher=void 0,this._eventDispatcherList=[],this._registerEvent(),this._inputEventDispatcher=new nD(this._eventTarget),this._registerEventDispatcher(this._inputEventDispatcher)}var e=t.prototype;return e.on=function(t,e,n){return this._eventTarget.on(t,e,n),e},e.once=function(t,e,n){return this._eventTarget.once(t,e,n),e},e.off=function(t,e,n){this._eventTarget.off(t,e,n)},e.setAccelerometerEnabled=function(t){t?this._accelerometerInput.start():this._accelerometerInput.stop()},e.setAccelerometerInterval=function(t){this._accelerometerInput.setInterval(t)},e._simulateEventTouch=function(t){var e=iD[t.type],n=tD.getTouch(0,t.getLocationX(),t.getLocationY());if(n){var i=[n],r=new kR(i,!1,e,i);e===NE.TOUCH_END&&tD.releaseTouch(0),this._dispatchOrPushEventTouch(r,this._eventTouchList)}},e._registerEventDispatcher=function(t){this._eventDispatcherList.push(t),this._eventDispatcherList.sort((function(t,e){return e.priority-t.priority}))},e._emitEvent=function(t){for(var e=this._eventDispatcherList.length,n=0;n<e&&this._eventDispatcherList[n].dispatchEvent(t);++n);},e._registerEvent=function(){var t=this;if(oh.hasFeature(oh.Feature.INPUT_TOUCH)){var e=this._eventTouchList;this._touchInput.on(NE.TOUCH_START,(function(n){t._dispatchOrPushEventTouch(n,e)})),this._touchInput.on(NE.TOUCH_MOVE,(function(n){t._dispatchOrPushEventTouch(n,e)})),this._touchInput.on(NE.TOUCH_END,(function(n){t._dispatchOrPushEventTouch(n,e)})),this._touchInput.on(NE.TOUCH_CANCEL,(function(n){t._dispatchOrPushEventTouch(n,e)}))}if(oh.hasFeature(oh.Feature.EVENT_MOUSE)){var n=this._eventMouseList;this._mouseInput.on(NE.MOUSE_DOWN,(function(e){t._needSimulateTouchMoveEvent=!0,t._simulateEventTouch(e),t._dispatchOrPushEvent(e,n)})),this._mouseInput.on(NE.MOUSE_MOVE,(function(e){t._needSimulateTouchMoveEvent&&t._simulateEventTouch(e),t._dispatchOrPushEvent(e,n)})),this._mouseInput.on(NE.MOUSE_UP,(function(e){t._needSimulateTouchMoveEvent=!1,t._simulateEventTouch(e),t._dispatchOrPushEvent(e,n)})),this._mouseInput.on(NE.MOUSE_WHEEL,(function(e){t._dispatchOrPushEvent(e,n)}))}if(oh.hasFeature(oh.Feature.EVENT_KEYBOARD)){var i=this._eventKeyboardList;this._keyboardInput.on(NE.KEY_DOWN,(function(e){t._dispatchOrPushEvent(e,i)})),this._keyboardInput.on(NE.KEY_PRESSING,(function(e){t._dispatchOrPushEvent(e,i)})),this._keyboardInput.on(NE.KEY_UP,(function(e){t._dispatchOrPushEvent(e,i)}))}if(oh.hasFeature(oh.Feature.EVENT_ACCELEROMETER)){var r=this._eventAccelerationList;this._accelerometerInput.on(NE.DEVICEMOTION,(function(e){t._dispatchOrPushEvent(e,r)}))}},e._clearEvents=function(){this._eventMouseList.length=0,this._eventTouchList.length=0,this._eventKeyboardList.length=0,this._eventAccelerationList.length=0},e._dispatchOrPushEvent=function(t,e){this._dispatchImmediately?this._emitEvent(t):e.push(t)},e._dispatchOrPushEventTouch=function(t,e){if(this._dispatchImmediately)for(var n=t.getTouches(),i=n.length,r=0;r<i;++r)t.touch=n[r],t.propagationStopped=t.propagationImmediateStopped=!1,this._emitEvent(t);else e.push(t)},e._frameDispatchEvents=function(){for(var t=this._eventMouseList,e=0,n=t.length;e<n;++e){var i=t[e];this._emitEvent(i)}for(var r=this._eventTouchList,o=0,a=r.length;o<a;++o)for(var s=r[o],c=s.getTouches(),l=c.length,u=0;u<l;++u)s.touch=c[u],s.propagationStopped=s.propagationImmediateStopped=!1,this._emitEvent(s);for(var h=this._eventKeyboardList,_=0,f=h.length;_<f;++_){var p=h[_];this._emitEvent(p)}for(var d=this._eventAccelerationList,m=0,v=d.length;m<v;++m){var g=d[m];this._emitEvent(g)}this._clearEvents()},t}());rD.EventType=NE;var oD=t("input",new rD),aD=t("SystemEvent",function(t){function e(){var e;return e=t.call(this)||this,oD.on(NE.MOUSE_DOWN,(function(t){e.emit(OE.MOUSE_DOWN,t)})),oD.on(NE.MOUSE_MOVE,(function(t){e.emit(OE.MOUSE_MOVE,t)})),oD.on(NE.MOUSE_UP,(function(t){e.emit(OE.MOUSE_UP,t)})),oD.on(NE.MOUSE_WHEEL,(function(t){e.emit(OE.MOUSE_WHEEL,t)})),oD.on(NE.TOUCH_START,(function(t){e.emit(OE.TOUCH_START,t.touch,t)})),oD.on(NE.TOUCH_MOVE,(function(t){e.emit(OE.TOUCH_MOVE,t.touch,t)})),oD.on(NE.TOUCH_END,(function(t){e.emit(OE.TOUCH_END,t.touch,t)})),oD.on(NE.TOUCH_CANCEL,(function(t){e.emit(OE.TOUCH_CANCEL,t.touch,t)})),oD.on(NE.KEY_DOWN,(function(t){e.emit(OE.KEY_DOWN,t)})),oD.on(NE.KEY_PRESSING,(function(t){e.emit(OE.KEY_DOWN,t)})),oD.on(NE.KEY_UP,(function(t){e.emit(OE.KEY_UP,t)})),oD.on(NE.DEVICEMOTION,(function(t){e.emit(OE.DEVICEMOTION,t)})),e}Q(e,t);var n=e.prototype;return n.setAccelerometerEnabled=function(t){oD.setAccelerometerEnabled(t)},n.setAccelerometerInterval=function(t){oD.setAccelerometerInterval(t)},n.on=function(e,n,i,r){return t.prototype.on.call(this,e,n,i,r),n},n.off=function(e,n,i){t.prototype.off.call(this,e,n,i)},e}(Ql));aD.EventType=OE,c.SystemEvent=aD;var sD,cD=t("systemEvent",new aD);c.systemEvent=cD,z(OE,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]),z(FR,"Event",[{name:"ACCELERATION",newName:"DEVICEMOTION",target:aD.EventType,targetName:"SystemEvent.EventType"}]),V(FR,"Event",[{name:"TOUCH",suggest:"please use SystemEvent.EventType.TOUCH_START, SystemEvent.EventType.TOUCH_MOVE, SystemEvent.EventType.TOUCH_END and SystemEvent.EventType.TOUCH_CANCEL instead"},{name:"MOUSE",suggest:"please use SystemEvent.EventType.MOUSE_DOWN, SystemEvent.EventType.MOUSE_MOVE, SystemEvent.EventType.MOUSE_UP, SystemEvent.EventType.MOUSE_WHEEL, Node.EventType.MOUSE_ENTER and Node.EventType.MOUSE_LEAVE instead"},{name:"KEYBOARD",suggest:"please use SystemEvent.EventType.KEY_DOWN and SystemEvent.EventType.KEY_UP instead"}]),z(VR,"EventMouse",["DOWN","UP","MOVE"].map((function(t){return{name:t,newName:"MOUSE_"+t,target:aD.EventType,targetName:"SystemEvent.EventType"}}))),z(VR,"EventMouse",[{name:"SCROLL",newName:"MOUSE_WHEEL",target:aD.EventType,targetName:"SystemEvent.EventType"}]),V(VR.prototype,"EventMouse.prototype",[{name:"eventType",suggest:"please use EventMouse.prototype.type instead"}]),z(kR,"EventTouch",[{name:"BEGAN",newName:"TOUCH_START",target:aD.EventType,targetName:"SystemEvent.EventType"}]),z(kR,"EventTouch",[{name:"MOVED",newName:"TOUCH_MOVE",target:aD.EventType,targetName:"SystemEvent.EventType"}]),z(kR,"EventTouch",[{name:"ENDED",newName:"TOUCH_END",target:aD.EventType,targetName:"SystemEvent.EventType"}]),z(kR,"EventTouch",[{name:"CANCELLED",newName:"TOUCH_CANCEL",target:aD.EventType,targetName:"SystemEvent.EventType"}]),V(kR.prototype,"EventTouch.prototype",[{name:"getEventCode",suggest:"please use EventTouch.prototype.type instead"}]),z(kR.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:kR,targetName:"EventTouch"}]),V(ce.KEY,"macro.KEY",["back","menu","0","1","2","3","4","5","6","7","8","9","0","*","+","-","/",";","=",",",".","[","]","dpadLeft","dpadRight","dpadUp","dpadDown","dpadCenter"].map((function(t){return{name:t}}))),V(ce.KEY,"macro.KEY",[{name:"shift",suggest:"please use KeyCode.SHIFT_LEFT instead"}]),V(ce.KEY,"macro.KEY",[{name:"ctrl",suggest:"please use KeyCode.CTRL_LEFT instead"}]),V(ce.KEY,"macro.KEY",[{name:"alt",suggest:"please use KeyCode.ALT_LEFT instead"}]),V(ce,"macro",[{name:"KEY",suggest:"please use KeyCode instead"}]),z(ub.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),z(GT.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.width},customSetter:function(t){this._uiProps.uiTransformComp.width=t}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.height},customSetter:function(t){this._uiProps.uiTransformComp.height=t}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorX},customSetter:function(t){this._uiProps.uiTransformComp.anchorX=t}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorY},customSetter:function(t){this._uiProps.uiTransformComp.anchorY=t}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(t){return t||(t=new Wn),t.set(this._uiProps.uiTransformComp.anchorPoint),t}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(t,e){this._uiProps.uiTransformComp.setAnchorPoint(t,e)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(t){return t||(t=new Zn),t.set(this._uiProps.uiTransformComp.contentSize),t}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(t,e){"number"==typeof t?this._uiProps.uiTransformComp.setContentSize(t,e):this._uiProps.uiTransformComp.setContentSize(t)}}]),G(LR.prototype,"SceneGlobals.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]),G(GT.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),z(XA.prototype,"NodeUIProperties",[{name:"opacityDirty",newName:"colorDirty"}]),G(Rp,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),z(Rp,"Layers",[{name:"Default",newName:"DEFAULT",target:Rp.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:Rp.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:Rp.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:Rp.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:Rp.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:Rp.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:Rp.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:Rp.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:Rp,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:Rp,targetName:"Layers"}]),G(Rp.Enum,"Layers.Enum",[{name:"ALWAYS"}]),G(Rp.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);var lD,uD,hD,_D,fD=ul.Flags.HideInHierarchy,pD=ul.Flags.DontSave,dD=t("PrivateNode",hc("cc.PrivateNode")(sD=function(t){function e(e){var n;return I(12003,(n=t.call(this,e)||this).name),n.hideFlags|=pD|fD,n}return Q(e,t),e}(GT))||sD);z(OE,"SystemEventType",["MOUSE_ENTER","MOUSE_LEAVE","TRANSFORM_CHANGED","SCENE_CHANGED_FOR_PERSISTS","SIZE_CHANGED","ANCHOR_CHANGED","COLOR_CHANGED","CHILD_ADDED","CHILD_REMOVED","PARENT_CHANGED","NODE_DESTROYED","LAYER_CHANGED","SIBLING_ORDER_CHANGED"].map((function(t){return{name:t,target:GT.EventType,targetName:"Node.EventType"}}))),z(GT.EventType,"Node.EventType",[{name:"DEVICEMOTION",target:aD.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_DOWN",target:aD.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_UP",target:aD.EventType,targetName:"SystemEvent.EventType"}]),c.PrivateNode=dD;var mD=t("Scene",hc("cc.Scene")((st((uD=function(t){Q(n,t);var e=n.prototype;function n(e){var n;return at(n=t.call(this,e)||this,"autoReleaseAssets",hD,it(n)),at(n,"_globals",_D,it(n)),n.dependAssets=null,n._renderScene=null,n._inited=void 0,n._prefabSyncedInLiveReload=!1,n._pos=En.ZERO,n._rot=Mn.IDENTITY,n._scale=En.ONE,n._mat=Un.IDENTITY,n._dirtyFlags=0,n._lpos=En.ZERO,n._lrot=Mn.IDENTITY,n._lscale=En.ONE,n._activeInHierarchy=!1,c.director&&c.director.root&&(n._renderScene=c.director.root.createScene({})),n._inited=!c.game||!c.game._isCloning,n._init(),n}return e._updateScene=function(){this._scene=this},e._init=function(){},e.destroy=function(){var t=ul.prototype.destroy.call(this);if(t)for(var e=this._children,n=0;n<e.length;++n)e[n].active=!1;return this._renderScene&&c.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,t},e.addComponent=function(){throw new Error(N(3822))},e._onHierarchyChanged=function(){},e._onBatchCreated=function(e){t.prototype._onBatchCreated.call(this,e);for(var n=this._children.length,i=0;i<n;++i)this.children[i]._siblingIndex=i,this._children[i]._onBatchCreated(e)},e.getPosition=function(t){return En.copy(t||new En,En.ZERO)},e.getRotation=function(t){return Mn.copy(t||new Mn,Mn.IDENTITY)},e.getScale=function(t){return En.copy(t||new En,En.ONE)},e.getWorldPosition=function(t){return En.copy(t||new En,En.ZERO)},e.getWorldRotation=function(t){return Mn.copy(t||new Mn,Mn.IDENTITY)},e.getWorldScale=function(t){return En.copy(t||new En,En.ONE)},e.getWorldMatrix=function(t){return Un.copy(t||new Un,Un.IDENTITY)},e.getWorldRS=function(t){return Un.copy(t||new Un,Un.IDENTITY)},e.getWorldRT=function(t){return Un.copy(t||new Un,Un.IDENTITY)},e.updateWorldTransform=function(){},e._instantiate=function(){},e._load=function(){this._inited||(iE(this),eE(this),this._onBatchCreated(false),this._inited=!0),this.walk(ub._setScene)},e._activate=function(t){t=!1!==t,c.director._nodeActivator.activateNode(this,t),this._globals.activate(),this._renderScene&&this._renderScene.activate()},K(n,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return En.ZERO}},{key:"worldPosition",get:function(){return En.ZERO}},{key:"rotation",get:function(){return Mn.IDENTITY}},{key:"worldRotation",get:function(){return Mn.IDENTITY}},{key:"scale",get:function(){return En.ONE}},{key:"worldScale",get:function(){return En.ONE}},{key:"eulerAngles",get:function(){return En.ZERO}},{key:"worldMatrix",get:function(){return Un.IDENTITY}}]),n}(ub)).prototype,"globals",[Pc],Object.getOwnPropertyDescriptor(uD.prototype,"globals"),uD.prototype),hD=st(uD.prototype,"autoReleaseAssets",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_D=st(uD.prototype,"_globals",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new LR}}),lD=uD))||lD);function vD(t,e){if(!e){var n=c.director.getScene();if(!n)return null;e=n}return e.getChildByPath(t)}c.Scene=mD,c.find=vD;var gD=te.fastRemoveAt,yD=ul.Flags.IsStartCalled,xD=ul.Flags.IsOnEnableCalled;function SD(t,e){for(var n=e.constructor._executionOrder,i=e._id,r=0,o=t.length-1,a=o>>>1;r<=o;a=r+o>>>1){var s=t[a],c=s.constructor._executionOrder;if(c>n)o=a-1;else if(c<n)r=a+1;else{var l=s._id;if(l>i)o=a-1;else{if(!(l<i))return a;r=a+1}}}return~r}function CD(t,e){for(var n=t.array,i=t.i+1;i<n.length;){var r=n[i];r.node._activeInHierarchy?++i:(t.removeAt(i),e&&(r._objFlags&=~e))}}ul.Flags.IsEditorOnEnableCalled;var AD=function(t){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var e=ct;this._zero=new e([]),this._neg=new e([]),this._pos=new e([]),this._invoke=t};function bD(t,e){return t.constructor._executionOrder-e.constructor._executionOrder}AD.stableRemoveInactive=CD;var TD=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.add=function(t){var e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).array.push(t)},n.remove=function(t){var e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).fastRemove(t)},n.cancelInactive=function(t){CD(this._zero,t),CD(this._neg,t),CD(this._pos,t)},n.invoke=function(){var t=this._neg;t.array.length>0&&(t.array.sort(bD),this._invoke(t),t.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var e=this._pos;e.array.length>0&&(e.array.sort(bD),this._invoke(e),e.array.length=0)},e}(AD),ED=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.add=function(t){var e=t.constructor._executionOrder;if(0===e)this._zero.array.push(t);else{var n=e<0?this._neg.array:this._pos.array,i=SD(n,t);i<0&&n.splice(~i,0,t)}},n.remove=function(t){var e=t.constructor._executionOrder;if(0===e)this._zero.fastRemove(t);else{var n=e<0?this._neg:this._pos,i=SD(n.array,t);i>=0&&n.removeAt(i)}},n.invoke=function(t){this._neg.array.length>0&&this._invoke(this._neg,t),this._invoke(this._zero,t),this._pos.array.length>0&&this._invoke(this._pos,t)},e}(AD);function wD(t,e,n){var i="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+t+"}",r=e?Function("it","dt",i):Function("it",i);return function(t,e,n){return function(i,r){try{e(i,r)}catch(e){c._throw(e);var o=i.array;for(n&&(o[i.i]._objFlags|=n),++i.i;i.i<o.length;++i.i)try{t(o[i.i],r)}catch(t){c._throw(t),n&&(o[i.i]._objFlags|=n)}}}}(Function("c","dt",t),r,n)}var PD=wD("c.start();c._objFlags|="+yD,!1,yD),ID=wD("c.update(dt)",!0),RD=wD("c.lateUpdate(dt)",!0),DD=function(t){var e=c.director._compScheduler,n=t.array;for(t.i=0;t.i<n.length;++t.i){var i=n[t.i];i._enabled&&(i.onEnable(),!i.node._activeInHierarchy||e._onEnabled(i))}},BD=function(){function t(){this._deferredComps=[],this.unscheduleAll()}var e=t.prototype;return e.unscheduleAll=function(){this.startInvoker=new TD(PD),this.updateInvoker=new ED(ID),this.lateUpdateInvoker=new ED(RD),this._updating=!1},e._onEnabled=function(t){c.director.getScheduler().resumeTarget(t),t._objFlags|=xD,this._updating?this._deferredComps.push(t):this._scheduleImmediate(t)},e._onDisabled=function(t){c.director.getScheduler().pauseTarget(t),t._objFlags&=~xD;var e=this._deferredComps.indexOf(t);e>=0?gD(this._deferredComps,e):(!t.start||t._objFlags&yD||this.startInvoker.remove(t),t.update&&this.updateInvoker.remove(t),t.lateUpdate&&this.lateUpdateInvoker.remove(t))},e.enableComp=function(t,e){if(!(t._objFlags&xD)){if(t.onEnable){if(e)return void e.add(t);if(t.onEnable(),!t.node._activeInHierarchy)return}this._onEnabled(t)}},e.disableComp=function(t){t._objFlags&xD&&(t.onDisable&&t.onDisable(),this._onDisabled(t))},e.startPhase=function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()},e.updatePhase=function(t){this.updateInvoker.invoke(t)},e.lateUpdatePhase=function(t){this.lateUpdateInvoker.invoke(t),this._updating=!1,this._startForNewComps()},e._startForNewComps=function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())},e._scheduleImmediate=function(t){"function"!=typeof t.start||t._objFlags&yD||this.startInvoker.add(t),"function"==typeof t.update&&this.updateInvoker.add(t),"function"==typeof t.lateUpdate&&this.lateUpdateInvoker.add(t)},e._deferredSchedule=function(){for(var t=this._deferredComps,e=0,n=t.length;e<n;e++)this._scheduleImmediate(t[e]);t.length=0},t}(),MD=ul.Flags.IsPreloadStarted,OD=ul.Flags.IsOnLoadStarted,ND=ul.Flags.IsOnLoadCalled,LD=ul.Flags.Deactivating,FD=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.add=function(t){this._zero.array.push(t)},n.remove=function(t){this._zero.fastRemove(t)},n.cancelInactive=function(t){AD.stableRemoveInactive(this._zero,t)},n.invoke=function(){this._invoke(this._zero),this._zero.array.length=0},e}(AD),zD=wD("c.__preload();"),GD=wD("c.onLoad();c._objFlags|="+ND,!1,ND),VD=new $t(4);function UD(t,e,n){D(3817,t.name,n),console.log("Corrupted component value:",e),e?t._removeComponent(e):te.removeAt(t._components,n)}VD.get=function(){var t=this._get()||{preload:new FD(zD),onLoad:new TD(GD),onEnable:new TD(DD)};t.preload._zero.i=-1;var e=t.onLoad;return e._zero.i=-1,e._neg.i=-1,e._pos.i=-1,(e=t.onEnable)._zero.i=-1,e._neg.i=-1,e._pos.i=-1,t};var kD,HD,jD,WD,qD,XD,YD,KD,JD=t("NodeActivator",function(){function t(){this.resetComp=void 0,this.reset()}var e=t.prototype;return e.reset=function(){this._activatingStack=[]},e.activateNode=function(t,e){if(e){var n=VD.get();this._activatingStack.push(n),this._activateNodeRecursively(t,n.preload,n.onLoad,n.onEnable),n.preload.invoke(),n.onLoad.invoke(),n.onEnable.invoke(),this._activatingStack.pop(),VD.put(n)}else{this._deactivateNodeRecursively(t);for(var i,r=ot(this._activatingStack);!(i=r()).done;){var o=i.value;o.preload.cancelInactive(MD),o.onLoad.cancelInactive(OD),o.onEnable.cancelInactive()}}t.emit(FA.ACTIVE_IN_HIERARCHY_CHANGED,t)},e.activateComp=function(t,e,n,i){if(_l(t,!0)&&(t._objFlags&MD||(t._objFlags|=MD,t.__preload&&(e?e.add(t):t.__preload())),t._objFlags&OD||(t._objFlags|=OD,t.onLoad?n?n.add(t):(t.onLoad(),t._objFlags|=ND):t._objFlags|=ND),t._enabled)){if(!t.node._activeInHierarchy)return;c.director._compScheduler.enableComp(t,i)}},e.destroyComp=function(t){c.director._compScheduler.disableComp(t),t.onDestroy&&t._objFlags&ND&&t.onDestroy()},e._activateNodeRecursively=function(t,e,n,i){if(t._objFlags&LD)D(3816,t.name);else{t._activeInHierarchy=!0;for(var r=t._components.length,o=0;o<r;++o){var a=t._components[o];a instanceof c.Component?this.activateComp(a,e,n,i):(UD(t,a,o),--o,--r)}for(var s=0,l=t._children.length;s<l;++s){var u=t._children[s];u._active&&this._activateNodeRecursively(u,e,n,i)}t._onPostActivated(!0)}},e._deactivateNodeRecursively=function(t){t._objFlags|=LD,t._activeInHierarchy=!1;for(var e=t._components.length,n=0;n<e;++n){var i=t._components[n];if(i._enabled&&(c.director._compScheduler.disableComp(i),t._activeInHierarchy))return void(t._objFlags&=~LD)}for(var r=0,o=t._children.length;r<o;++r){var a=t._children[r];if(a._activeInHierarchy&&(this._deactivateNodeRecursively(a),t._activeInHierarchy))return void(t._objFlags&=~LD)}t._onPostActivated(!1),t._objFlags&=~LD},t}()),QD=t("SceneAsset",hc("cc.SceneAsset")((WD=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"scene",jD,it(e)),e}Q(e,t);var n=e.prototype;return n.initDefault=function(e){t.prototype.initDefault.call(this,e),this.scene=new mD("New Scene")},n.validate=function(){return!!this.scene},e}(Pu),jD=st((HD=WD).prototype,"scene",[Pc,vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kD=HD))||kD);c.SceneAsset=QD;var ZD,$D,tB,eB,nB=t("TextAsset",hc("cc.TextAsset")((KD=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"text",YD,it(e)),e}return Q(e,t),e.prototype.toString=function(){return this.text},e}(Pu),YD=st((XD=KD).prototype,"text",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),qD=XD))||qD);c.TextAsset=nB;var iB=t("JsonAsset",hc("cc.JsonAsset")((eB=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"json",tB,it(e)),e}return Q(e,t),e}(Pu),tB=st(($D=eB).prototype,"json",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ZD=$D))||ZD);c.JsonAsset=iB;var rB,oB,aB,sB,cB,lB,uB,hB,_B,fB,pB,dB,mB,vB,gB,yB,xB,SB,CB,AB,bB,TB,EB,wB,PB,IB,RB,DB,BB,MB,OB,NB,LB,FB,zB,GB,VB,UB,kB=function(){var t=e.prototype;function e(){this.fog=new xA,this.ambient=new YS,this.skybox=new pC,this.shadows=new vg,this.octree=new JS,this.validPunctualLights=[],this.renderObjects=[],this.castShadowObjects=[],this.dirShadowObjects=[],this.shadowFrameBufferMap=new Map,this._occlusionQueryVertexBuffer=null,this._occlusionQueryIndicesBuffer=null,this._occlusionQueryInputAssembler=null,this._occlusionQueryMaterial=null,this._occlusionQueryShader=null,this._isHDR=!0,this._shadingScale=1,this._init(),this.shadingScale=1}return t._init=function(){},t.activate=function(t,e){return this._device=t,this._pipeline=e,this.initOcclusionQuery(),!0},t.initOcclusionQuery=function(){if(this._occlusionQueryInputAssembler||(this._occlusionQueryInputAssembler=this._createOcclusionQueryIA()),!this._occlusionQueryMaterial){var t=new ig;t._uuid="default-occlusion-query-material",t.initialize({effectName:"occlusion-query"}),this._occlusionQueryMaterial=t,this._occlusionQueryShader=t.passes[0].getShaderVariant()}},t.getOcclusionQueryPass=function(){return this._occlusionQueryMaterial.passes[0]},t.onGlobalPipelineStateChanged=function(){},t.destroy=function(){var t,e,n;this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),this.octree.destroy(),this.validPunctualLights.length=0,null===(t=this._occlusionQueryInputAssembler)||void 0===t||t.destroy(),this._occlusionQueryInputAssembler=null,null===(e=this._occlusionQueryVertexBuffer)||void 0===e||e.destroy(),this._occlusionQueryVertexBuffer=null,null===(n=this._occlusionQueryIndicesBuffer)||void 0===n||n.destroy(),this._occlusionQueryIndicesBuffer=null},t._createOcclusionQueryIA=function(){var t=this._device,e=new Float32Array([-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1]),n=3*Float32Array.BYTES_PER_ELEMENT,i=8*n;this._occlusionQueryVertexBuffer=t.createBuffer(new lr(fi.VERTEX|fi.TRANSFER_DST,mi.DEVICE,i,n)),this._occlusionQueryVertexBuffer.update(e);var r=new Uint16Array([0,2,1,1,2,3,4,5,6,5,7,6,1,3,7,1,7,5,0,4,6,0,6,2,0,1,5,0,5,4,2,6,7,2,7,3]),o=Uint16Array.BYTES_PER_ELEMENT,a=36*o;this._occlusionQueryIndicesBuffer=t.createBuffer(new lr(fi.INDEX|fi.TRANSFER_DST,mi.DEVICE,a,o)),this._occlusionQueryIndicesBuffer.update(r);var s=[new Er("a_position",ui.RGB32F)],c=new Pr(s,[this._occlusionQueryVertexBuffer],this._occlusionQueryIndicesBuffer);return t.createInputAssembler(c)},K(e,[{key:"native",get:function(){return this._nativeObj}},{key:"isHDR",get:function(){return this._isHDR},set:function(t){this._isHDR=t}},{key:"shadingScale",get:function(){return this._shadingScale},set:function(t){this._shadingScale!==t&&(this._shadingScale=t,this._pipeline.emit(Ly.ATTACHMENT_SCALE_CAHNGED,t))}}]),e}(),HB=t("ForwardPipeline",(rB=hc("ForwardPipeline"),oB=Wc([LS]),aB=zc(),rB((uB=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"renderTextures",lB,it(e)),e._postRenderPass=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._flows.length){var n=new mA;n.initialize(mA.initInfo),this._flows.push(n);var i=new ZC;i.initialize(ZC.initInfo),this._flows.push(i)}return!0},n.activate=function(e){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new kB,!(!t.prototype.activate.call(this,e)||!this._activeRenderer(e)&&(D(2402),1))},n._ensureEnoughSize=function(t){for(var e=this._width,n=this._height,i=0;i<t.length;++i){var r=t[i].window;e=Math.max(r.width,e),n=Math.max(r.height,n)}e===this._width&&n===this._height||(this._width=e,this._height=n)},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler();for(var e=this._renderPasses.values(),n=e.next();!n.done;)n.value.destroy(),n=e.next();return this._commandBuffers.length=0,t.prototype.destroy.call(this)},n._activeRenderer=function(){var t=this.device;this._commandBuffers.push(t.commandBuffer);var e=this.globalDSManager.pointSampler;return this._descriptorSet.bindSampler(Kp,e),this._descriptorSet.bindTexture(Kp,wv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(rd,e),this._descriptorSet.bindTexture(rd,wv.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(qp.BINDING).destroy(),this._descriptorSet.getBuffer(Yp.BINDING).destroy(),this._descriptorSet.getBuffer(Xp.BINDING).destroy(),this._descriptorSet.getTexture(Kp).destroy(),this._descriptorSet.getTexture(rd).destroy())},K(e,[{key:"postRenderPass",get:function(){return this._postRenderPass}}]),e}(rx),lB=st((cB=uB).prototype,"renderTextures",[oB,vc,aB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sB=cB))||sB)),jB=[new or(0,0,0,0),new or(0,0,0,0),new or(0,0,0,0)],WB=t("GbufferStage",(hB=hc("GbufferStage"),_B=Wc([GS]),fB=zc(),hB((gB=vB=function(t){function e(){var e;return at(e=t.call(this)||this,"renderQueues",mB,it(e)),e._renderQueues=[],e._renderArea=new Qi,e._batchedQueue=void 0,e._instancedQueue=void 0,e._phaseID=Pv("default"),e._batchedQueue=new qS,e._instancedQueue=new XS,e}Q(e,t);var n=e.prototype;return n.initialize=function(e){return t.prototype.initialize.call(this,e),e.renderQueues&&(this.renderQueues=e.renderQueues),!0},n.activate=function(e,n){t.prototype.activate.call(this,e,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=HS(this.renderQueues[i])},n.destroy=function(){},n.render=function(t){this._instancedQueue.clear(),this._batchedQueue.clear();var e=this._pipeline,n=e.device;this._renderQueues.forEach(jS),e.generateRenderArea(t,this._renderArea),e.updateQuadVertexData(this._renderArea,t.window);for(var i=e.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var _=h[o];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===Av.INSTANCING){var p=_.getInstancedBuffer();p.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(p)}else if(f===Av.VB_MERGING){var d=_.getBatchedBuffer();d.merge(u,o,c.model),this._batchedQueue.queue.add(d)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(WS);var m=e.commandBuffers[0];this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),t.clearFlag&Wi.COLOR&&(e.pipelineSceneData.isHDR?zv(jB[0],t.clearColor):(jB[0].x=t.clearColor.x,jB[0].y=t.clearColor.y,jB[0].z=t.clearColor.z)),jB[0].w=t.clearColor.w;var v=e.getPipelineRenderData().gbufferFrameBuffer,g=v.renderPass;m.beginRenderPass(g,v,this._renderArea,jB,t.clearDepth,t.clearStencil),m.setScissor(e.generateScissor(t)),m.setViewport(e.generateViewport(t)),m.bindDescriptorSet(kp.GLOBAL,e.descriptorSet);for(var y=0;y<this.renderQueues.length;y++)this._renderQueues[y].recordCommandBuffer(n,g,m);this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),m.endRenderPass()},e}(Ny),vB.initInfo={name:"GbufferStage",priority:Jy.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:NS.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:NS.BACK_TO_FRONT,stages:["default"]}]},mB=st((dB=gB).prototype,"renderQueues",[_B,vc,fB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pB=dB))||pB)),qB=[new or(0,0,0,1)],XB=t("LightingStage",(yB=hc("LightingStage"),xB=Wc(ig),SB=zc(),CB=Wc([GS]),AB=zc(),yB((IB=PB=function(t){function e(){var e;return(e=t.call(this)||this)._deferredLitsBufs=null,e._maxDeferredLights=_d.LIGHTS_PER_PASS,e._lightMeterScale=1e4,e._descriptorSet=null,e._renderArea=new Qi,e._uiPhase=void 0,at(e,"_deferredMaterial",EB,it(e)),at(e,"renderQueues",wB,it(e)),e._phaseID=Pv("default"),e._renderQueues=[],e._uiPhase=new KC,e}Q(e,t);var n=e.prototype;return n.initialize=function(e){return t.prototype.initialize.call(this,e),!0},n.gatherLights=function(t){for(var e=this._pipeline,n=e.commandBuffers[0],i=t.scene.sphereLights,r=t.scene.spotLights,o=ra.create(0,0,0,1),a=new Float32Array(4),s=t.exposure,c=0,l=Kn.length,u=l*this._maxDeferredLights,h=0;h<i.length&&c<this._maxDeferredLights;h++,++c){var _=i[h];if(ra.set(o,_.position.x,_.position.y,_.position.z,_.range),cs.sphereFrustum(o,t.frustum)){if(En.toArray(a,_.position),a[3]=0,this._lightBufferData.set(a,c*l),En.toArray(a,_.color),_.useColorTemperature){var f=_.colorTemperatureRGB;a[0]*=f.x,a[1]*=f.y,a[2]*=f.z}e.pipelineSceneData.isHDR?a[3]=_.luminance*s*this._lightMeterScale:a[3]=_.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=_.size,a[1]=_.range,a[2]=0,this._lightBufferData.set(a,c*l+2*u)}}for(var p=0;p<r.length&&c<this._maxDeferredLights;p++,++c){var d=r[p];if(ra.set(o,d.position.x,d.position.y,d.position.z,d.range),cs.sphereFrustum(o,t.frustum)){if(En.toArray(a,d.position),a[3]=1,this._lightBufferData.set(a,c*l+0*u),En.toArray(a,d.color),d.useColorTemperature){var m=d.colorTemperatureRGB;a[0]*=m.x,a[1]*=m.y,a[2]*=m.z}e.pipelineSceneData.isHDR?a[3]=d.luminance*s*this._lightMeterScale:a[3]=d.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=d.size,a[1]=d.range,a[2]=d.spotAngle,this._lightBufferData.set(a,c*l+2*u),En.toArray(a,d.direction),this._lightBufferData.set(a,c*l+3*u)}}var v=3*u+3;this._lightBufferData.set([c],v),n.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},n.activate=function(e,n){t.prototype.activate.call(this,e,n),this._uiPhase.activate(e);for(var i=e.device,r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=HS(this.renderQueues[r]);var o=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;o=Math.ceil(o/i.capabilities.uboOffsetAlignment)*i.capabilities.uboOffsetAlignment,this._deferredLitsBufs=i.createBuffer(new lr(fi.UNIFORM|fi.TRANSFER_DST,mi.HOST|mi.DEVICE,o,i.capabilities.uboOffsetAlignment));var a=i.createBuffer(new ur(this._deferredLitsBufs,0,o));this._lightBufferData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT);var s=new zr(zp.bindings);this._descriptorSetLayout=i.createDescriptorSetLayout(s),this._descriptorSet=i.createDescriptorSet(new Gr(this._descriptorSetLayout)),this._descriptorSet.bindBuffer(hd.BINDING,a),this._planarQueue=new YC(this._pipeline),this._deferredMaterial&&(e.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)},n.destroy=function(){var t;null===(t=this._deferredLitsBufs)||void 0===t||t.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},n.render=function(t){var e=this._pipeline,n=e.device,i=e.commandBuffers[0],r=e.pipelineSceneData,o=r.renderObjects;this.gatherLights(t),this._descriptorSet.update(),this._planarQueue.gatherShadowPasses(t,i),i.bindDescriptorSet(kp.LOCAL,this._descriptorSet,[0]),e.generateRenderArea(t,this._renderArea),t.clearFlag&Wi.COLOR&&(qB[0].x=t.clearColor.x,qB[0].y=t.clearColor.y,qB[0].z=t.clearColor.z),qB[0].w=0;var a=e.getPipelineRenderData(),s=a.outputFrameBuffer,c=s.renderPass;e.pipelineUBO.updateShadowUBO(t),i.beginRenderPass(c,s,this._renderArea,qB,t.clearDepth,t.clearStencil),i.setScissor(e.generateScissor(t)),i.setViewport(e.generateViewport(t)),i.bindDescriptorSet(kp.GLOBAL,e.descriptorSet);for(var l=r.deferredLightingMaterial.passes[0],u=l.getShaderVariant(),h=0;h<3;++h)l.descriptorSet.bindTexture(h,a.gbufferRenderTargets[h]),l.descriptorSet.bindSampler(h,a.sampler);l.descriptorSet.bindTexture(3,a.outputDepth),l.descriptorSet.bindSampler(3,a.sampler),l.descriptorSet.update(),i.bindDescriptorSet(kp.MATERIAL,l.descriptorSet);var _=e.quadIAOffscreen,f=null;null!=l&&null!=u&&null!=_&&(f=Nv.getOrCreatePipelineState(n,l,u,c,_)),null!=f&&(i.bindPipelineState(f),i.bindInputAssembler(_),i.draw(_)),this._renderQueues.forEach(jS);for(var p=0,d=0,m=0,v=0;v<o.length;++v){var g=o[v],y=g.model.subModels;for(p=0;p<y.length;++p){var x=y[p].passes;for(d=0;d<x.length;++d)if(x[d].phase===this._phaseID)for(m=0;m<this._renderQueues.length;m++)this._renderQueues[m].insertRenderPass(g,p,d)}}if(o.length>0){this._renderQueues.forEach(WS);for(var S=0;S<this._renderQueues.length;S++)this._renderQueues[S].recordCommandBuffer(n,c,i);this._planarQueue.recordCommandBuffer(n,c,i)}this._uiPhase.render(t,c),i.endRenderPass()},e}(Ny),PB.initInfo={name:"LightingStage",priority:Jy.LIGHTING,tag:0},EB=st((TB=IB).prototype,"_deferredMaterial",[xB,vc,SB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wB=st(TB.prototype,"renderQueues",[CB,vc,AB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bB=TB))||bB)),YB=[new or(0,0,0,1)],KB=t("PostProcessStage",(RB=hc("PostProcessStage"),DB=Wc(ig),BB=zc(),MB=Wc([GS]),OB=zc(),RB((VB=GB=function(t){function e(){var e;return at(e=t.call(this)||this,"_postProcessMaterial",FB,it(e)),at(e,"renderQueues",zB,it(e)),e._renderArea=new Qi,e._uiPhase=new KC,e}Q(e,t);var n=e.prototype;return n.initialize=function(e){return t.prototype.initialize.call(this,e),!0},n.activate=function(e,n){t.prototype.activate.call(this,e,n),this._postProcessMaterial&&(e.pipelineSceneData.postprocessMaterial=this._postProcessMaterial),this._uiPhase.activate(e)},n.destroy=function(){},n.render=function(t){var e=this._pipeline,n=e.device,i=e.pipelineSceneData,r=e.commandBuffers[0];e.pipelineUBO.updateCameraUBO(t);var o=t.viewport;this._renderArea.x=o.x*t.window.width,this._renderArea.y=o.y*t.window.height,this._renderArea.width=o.width*t.window.width,this._renderArea.height=o.height*t.window.height;var a=e.getPipelineRenderData(),s=t.window.framebuffer,c=e.getRenderPass(t.clearFlag,s);t.clearFlag&Wi.COLOR&&(YB[0].x=t.clearColor.x,YB[0].y=t.clearColor.y,YB[0].z=t.clearColor.z),YB[0].w=t.clearColor.w,r.beginRenderPass(c,s,this._renderArea,YB,t.clearDepth,t.clearStencil),r.bindDescriptorSet(kp.GLOBAL,e.descriptorSet);var l=i.postprocessMaterial.passes[0],u=l.getShaderVariant();e.bloomEnabled?l.descriptorSet.bindTexture(0,a.bloom.combineTex):l.descriptorSet.bindTexture(0,a.outputRenderTargets[0]),l.descriptorSet.bindSampler(0,a.sampler),l.descriptorSet.update(),r.bindDescriptorSet(kp.MATERIAL,l.descriptorSet);var h=t.window.swapchain?e.quadIAOnscreen:e.quadIAOffscreen,_=null;null!=l&&null!=u&&null!=h&&(_=Nv.getOrCreatePipelineState(n,l,u,c,h));var f=e.pipelineSceneData.renderObjects;null!=_&&f.length>0&&(r.bindPipelineState(_),r.bindInputAssembler(h),r.draw(h)),this._uiPhase.render(t,c),Jv(n,c,r,e.profiler,t),r.endRenderPass()},e}(Ny),GB.initInfo={name:"PostProcessStage",priority:Xy.POST_PROCESS,tag:0},FB=st((LB=VB).prototype,"_postProcessMaterial",[DB,vc,BB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zB=st(LB.prototype,"renderQueues",[MB,vc,OB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),NB=LB))||NB));!function(t){t[t.NONE=0]="NONE",t[t.FXAA=1]="FXAA"}(UB||(UB={}));var JB,QB,ZB,$B,tM,eM,nM,iM,rM=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._antiAliasing=UB.NONE,e}Q(e,t);var n=e.prototype;return n.onGlobalPipelineStateChanged=function(){this.updatePipelinePassInfo()},n.updateBloomPass=function(){if(this._bloomMaterial){var t=this._bloomMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently();for(var e=[],n=[],i=0;i<6;++i){var r=this._bloomMaterial.passes[1+i];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently();var o=this._bloomMaterial.passes[7+i];o.beginChangeStatesSilently(),o.tryCompile(),o.endChangeStatesSilently(),e.push(r.native),n.push(o.native)}var a=this._bloomMaterial.passes[13];a.beginChangeStatesSilently(),a.tryCompile(),a.endChangeStatesSilently()}},n.updatePostProcessPass=function(){if(this.postprocessMaterial){var t=this.postprocessMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently()}},n.initPipelinePassInfo=function(){var t=new ig;t._uuid="builtin-deferred-material",t.initialize({effectName:"deferred-lighting"});for(var e=0;e<t.passes.length;++e)t.passes[e].tryCompile();this._deferredLightingMaterial=t;var n=new ig;n._uuid="builtin-bloom-material",n.initialize({effectName:"bloom"});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._bloomMaterial=n;var r=new ig;r._uuid="builtin-post-process-material",ce.ENABLE_ANTIALIAS_FXAA&&(this._antiAliasing=UB.FXAA),r.initialize({effectName:"post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var o=0;o<r.passes.length;++o)r.passes[o].tryCompile();this._postprocessMaterial=r,this.updatePipelinePassInfo()},n.updatePipelinePassInfo=function(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()},n.activate=function(e,n){return t.prototype.activate.call(this,e,n),this.initPipelinePassInfo(),!0},n.updateDeferredPassInfo=function(){this.updateDeferredLightPass()},n.updateDeferredLightPass=function(){if(this._deferredLightingMaterial){this.shadows.enabled&&(this._pipeline.macros.CC_RECEIVE_SHADOW=1);var t=this._deferredLightingMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently()}},K(e,[{key:"antiAliasing",get:function(){return this._antiAliasing},set:function(t){if(this._antiAliasing=t,this._postprocessMaterial){var e=this._postprocessMaterial.passes[0].defines;Object.assign(e,{ANTIALIAS_TYPE:t});var n=new ig;n.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:e});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._postprocessMaterial=n}}},{key:"bloomMaterial",get:function(){return this._bloomMaterial},set:function(t){this._bloomMaterial!==t&&t&&(this._bloomMaterial=t,this.updatePipelinePassInfo())}},{key:"postprocessMaterial",get:function(){return this._postprocessMaterial},set:function(t){this._postprocessMaterial!==t&&t&&(this._postprocessMaterial=t,this.updatePipelinePassInfo())}},{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(t){this._deferredLightingMaterial!==t&&t&&(this._deferredLightingMaterial=t,this.updatePipelinePassInfo())}}]),e}(kB),oM=[new or(0,0,0,1)],aM=function(){};aM.SIZE=4*(aM.COUNT=4+(aM.TEXTURE_SIZE_OFFSET=0));var sM,cM,lM,uM,hM,_M,fM,pM,dM,mM,vM=t("BloomStage",(JB=hc("BloomStage"),QB=Wc(ig),ZB=zc(),JB((iM=nM=function(t){function e(){var e;return(e=t.call(this)||this).threshold=1,e.intensity=.8,e.iterations=2,at(e,"_bloomMaterial",eM,it(e)),e._renderArea=new Qi,e._bloomUBO=[],e}Q(e,t);var n=e.prototype;return n.initialize=function(e){return t.prototype.initialize.call(this,e),!0},n.activate=function(e,n){t.prototype.activate.call(this,e,n),this._bloomMaterial&&(e.pipelineSceneData.bloomMaterial=this._bloomMaterial)},n.destroy=function(){},n.render=function(t){var e,n=this._pipeline;if(n.generateBloomRenderData(),((null===(e=t.window)||void 0===e?void 0:e.swapchain)||n.macros.CC_PIPELINE_TYPE)&&n.bloomEnabled&&0!==n.pipelineSceneData.renderObjects.length){if(0===this._bloomUBO.length)for(var i=0;i<14;++i)this._bloomUBO[i]=n.device.createBuffer(new lr(fi.UNIFORM|fi.TRANSFER_DST,mi.HOST|mi.DEVICE,aM.SIZE,aM.SIZE));t.clearFlag&Wi.COLOR&&(oM[0].x=t.clearColor.x,oM[0].y=t.clearColor.y,oM[0].z=t.clearColor.z),oM[0].w=t.clearColor.w,this._prefilterPass(t,n),this._downsamplePass(t,n),this._upsamplePass(t,n),this._combinePass(t,n)}},n._prefilterPass=function(t,e){e.generateRenderArea(t,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;var n=e.commandBuffers[0],i=e.pipelineSceneData.bloomMaterial.passes[0],r=e.getPipelineRenderData(),o=r.bloom,a=new Float32Array(aM.COUNT);a[aM.TEXTURE_SIZE_OFFSET+2]=this.threshold,n.updateBuffer(this._bloomUBO[0],a),n.beginRenderPass(o.renderPass,o.prefilterFramebuffer,this._renderArea,oM,0,0),n.bindDescriptorSet(kp.GLOBAL,e.descriptorSet),i.descriptorSet.bindBuffer(0,this._bloomUBO[0]),i.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),i.descriptorSet.bindSampler(1,o.sampler),i.descriptorSet.update(),n.bindDescriptorSet(kp.MATERIAL,i.descriptorSet);var s=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,c=null,l=i.getShaderVariant();null!=i&&null!=l&&null!=s&&(c=Nv.getOrCreatePipelineState(e.device,i,l,o.renderPass,s)),null!=c&&(n.bindPipelineState(c),n.bindInputAssembler(s),n.draw(s)),n.endRenderPass()},n._downsamplePass=function(t,e){e.generateRenderArea(t,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;for(var n=e.commandBuffers[0],i=e.pipelineSceneData.bloomMaterial,r=e.getPipelineRenderData().bloom,o=new Float32Array(aM.COUNT),a=0;a<this.iterations;++a){o[aM.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[aM.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,n.updateBuffer(this._bloomUBO[a+1],o),this._renderArea.width>>=1,this._renderArea.height>>=1,n.beginRenderPass(r.renderPass,r.downsampleFramebuffers[a],this._renderArea,oM,0,0);var s=i.passes[1+a],c=s.getShaderVariant();s.descriptorSet.bindBuffer(0,this._bloomUBO[a+1]),0===a?s.descriptorSet.bindTexture(1,r.prefiterTex):s.descriptorSet.bindTexture(1,r.downsampleTexs[a-1]),s.descriptorSet.bindSampler(1,r.sampler),s.descriptorSet.update(),n.bindDescriptorSet(kp.MATERIAL,s.descriptorSet);var l=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,u=null;null!=s&&null!=c&&null!=l&&(u=Nv.getOrCreatePipelineState(e.device,s,c,r.renderPass,l)),null!=u&&(n.bindPipelineState(u),n.bindInputAssembler(l),n.draw(l)),n.endRenderPass()}},n._upsamplePass=function(t,e){var n=e.getPipelineRenderData().bloom;e.generateRenderArea(t,this._renderArea),this._renderArea.width>>=this.iterations+1,this._renderArea.height>>=this.iterations+1;for(var i=e.commandBuffers[0],r=e.pipelineSceneData.bloomMaterial,o=new Float32Array(aM.COUNT),a=0;a<this.iterations;++a){var s=a+6+1;o[aM.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[aM.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,i.updateBuffer(this._bloomUBO[s],o),this._renderArea.width<<=1,this._renderArea.height<<=1,i.beginRenderPass(n.renderPass,n.upsampleFramebuffers[this.iterations-1-a],this._renderArea,oM,0,0);var c=r.passes[7+a],l=c.getShaderVariant();c.descriptorSet.bindBuffer(0,this._bloomUBO[s]),0===a?c.descriptorSet.bindTexture(1,n.downsampleTexs[this.iterations-1]):c.descriptorSet.bindTexture(1,n.upsampleTexs[this.iterations-a]),c.descriptorSet.bindSampler(1,n.sampler),c.descriptorSet.update(),i.bindDescriptorSet(kp.MATERIAL,c.descriptorSet);var u=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,h=null;null!=c&&null!=l&&null!=u&&(h=Nv.getOrCreatePipelineState(e.device,c,l,n.renderPass,u)),null!=h&&(i.bindPipelineState(h),i.bindInputAssembler(u),i.draw(u)),i.endRenderPass()}},n._combinePass=function(t,e){e.generateRenderArea(t,this._renderArea);var n=e.commandBuffers[0],i=e.pipelineSceneData.bloomMaterial,r=e.getPipelineRenderData(),o=r.bloom,a=new Float32Array(aM.COUNT);a[aM.TEXTURE_SIZE_OFFSET+3]=this.intensity,n.updateBuffer(this._bloomUBO[13],a),n.beginRenderPass(o.renderPass,o.combineFramebuffer,this._renderArea,oM,0,0),n.bindDescriptorSet(kp.GLOBAL,e.descriptorSet);var s=i.passes[13];s.descriptorSet.bindBuffer(0,this._bloomUBO[13]),s.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),s.descriptorSet.bindTexture(2,o.upsampleTexs[0]),s.descriptorSet.bindSampler(1,o.sampler),s.descriptorSet.bindSampler(2,o.sampler),s.descriptorSet.update(),n.bindDescriptorSet(kp.MATERIAL,s.descriptorSet);var c=t.window.swapchain?e.quadIAOffscreen:e.quadIAOnscreen,l=null,u=s.getShaderVariant();null!=s&&null!=u&&null!=c&&(l=Nv.getOrCreatePipelineState(e.device,s,u,o.renderPass,c)),null!=l&&(n.bindPipelineState(l),n.bindInputAssembler(c),n.draw(c)),n.endRenderPass()},e}(Ny),nM.initInfo={name:"BloomStage",priority:Xy.BLOOM,tag:0},eM=st((tM=iM).prototype,"_bloomMaterial",[QB,vc,ZB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$B=tM))||$B)),gM=t("MainFlow",hc("MainFlow")((lM=cM=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._stages.length){var n=new WB;n.initialize(WB.initInfo),this._stages.push(n);var i=new XB;i.initialize(XB.initInfo),this._stages.push(i);var r=new vM;r.initialize(vM.initInfo),this._stages.push(r);var o=new KB;o.initialize(KB.initInfo),this._stages.push(o)}return!0},n.activate=function(e){t.prototype.activate.call(this,e)},n.render=function(e){t.prototype.render.call(this,e)},n.destroy=function(){t.prototype.destroy.call(this)},e}(Fy),cM.initInfo={name:Mp,priority:Qy.MAIN,stages:[]},sM=lM))||sM),yM=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).gbufferFrameBuffer=null,e.gbufferRenderTargets=[],e}return Q(e,t),e}((function(){this.outputFrameBuffer=null,this.outputRenderTargets=[],this.outputDepth=null,this.sampler=null,this.bloom=null})),xM=t("DeferredPipeline",(uM=hc("DeferredPipeline"),hM=Wc([LS]),_M=zc(),uM((mM=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gbufferRenderPass=null,e._lightingRenderPass=null,at(e,"renderTextures",dM,it(e)),e}Q(e,t);var n=e.prototype;return n.initialize=function(e){if(t.prototype.initialize.call(this,e),0===this._flows.length){var n=new mA;n.initialize(mA.initInfo),this._flows.push(n);var i=new gM;i.initialize(gM.initInfo),this._flows.push(i)}return!0},n.activate=function(e){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new rM,!(!t.prototype.activate.call(this,e)||!this._activeRenderer(e)&&(D(2402),1))},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler(),this._destroyDeferredData();for(var e=this._renderPasses.values(),n=e.next();!n.done;)n.value.destroy(),n=e.next();return this._commandBuffers.length=0,t.prototype.destroy.call(this)},n.getPipelineRenderData=function(){return this._pipelineRenderData||this._generateDeferredRenderData(),this._pipelineRenderData},n._activeRenderer=function(t){var e=this.device;this._commandBuffers.push(e.commandBuffer);var n=this.globalDSManager.pointSampler;this._descriptorSet.bindSampler(Kp,n),this._descriptorSet.bindTexture(Kp,wv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(rd,n),this._descriptorSet.bindTexture(rd,wv.get("default-texture").getGFXTexture()),this._descriptorSet.update();var i=new ix;if(!(i=this._createQuadInputAssembler()).quadIB||!i.quadVB||!i.quadIA)return!1;this._quadIB=i.quadIB,this._quadVBOffscreen=i.quadVB,this._quadIAOffscreen=i.quadIA;var r=this._createQuadInputAssembler();if(!r.quadIB||!r.quadVB||!r.quadIA)return!1;if(this._quadVBOnscreen=r.quadVB,this._quadIAOnscreen=r.quadIA,!this._gbufferRenderPass){var o=new Ir;o.format=ui.RGBA16F,o.loadOp=Ri.CLEAR,o.storeOp=Di.STORE;var a=new Ir;a.format=ui.RGBA16F,a.loadOp=Ri.CLEAR,a.storeOp=Di.STORE;var s=new Ir;s.format=ui.RGBA16F,s.loadOp=Ri.CLEAR,s.storeOp=Di.STORE;var c=new Rr;c.format=ui.DEPTH_STENCIL,c.depthLoadOp=Ri.CLEAR,c.depthStoreOp=Di.STORE,c.stencilLoadOp=Ri.CLEAR,c.stencilStoreOp=Di.STORE;var l=new Mr([o,a,s],c);this._gbufferRenderPass=e.createRenderPass(l)}if(!this._lightingRenderPass){var u=new Ir;u.format=ui.RGBA8,u.loadOp=Ri.CLEAR,u.storeOp=Di.STORE,u.endAccesses=[Bi.COLOR_ATTACHMENT_WRITE];var h=new Rr;h.format=ui.DEPTH_STENCIL,h.depthLoadOp=Ri.LOAD,h.depthStoreOp=Di.DISCARD,h.stencilLoadOp=Ri.LOAD,h.stencilStoreOp=Di.DISCARD,h.beginAccesses=[Bi.DEPTH_STENCIL_ATTACHMENT_WRITE],h.endAccesses=[Bi.DEPTH_STENCIL_ATTACHMENT_WRITE];var _=new Mr([u],h);this._lightingRenderPass=e.createRenderPass(_)}return this._width=t.width,this._height=t.height,this._generateDeferredRenderData(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(qp.BINDING).destroy(),this._descriptorSet.getBuffer(Yp.BINDING).destroy(),this._descriptorSet.getBuffer(Xp.BINDING).destroy(),this._descriptorSet.getTexture(Kp).destroy(),this._descriptorSet.getTexture(rd).destroy())},n._destroyDeferredData=function(){var t=this._pipelineRenderData;if(t){t.gbufferFrameBuffer&&t.gbufferFrameBuffer.destroy(),t.outputFrameBuffer&&t.outputFrameBuffer.destroy(),t.outputDepth&&t.outputDepth.destroy();for(var e=0;e<t.gbufferRenderTargets.length;e++)t.gbufferRenderTargets[e].destroy();t.gbufferRenderTargets.length=0;for(var n=0;n<t.outputRenderTargets.length;n++)t.outputRenderTargets[n].destroy();t.outputRenderTargets.length=0,this._destroyBloomData()}this._pipelineRenderData=null},n._ensureEnoughSize=function(t){for(var e=this._width,n=this._height,i=0;i<t.length;++i){var r=t[i].window;e=Math.max(r.width,e),n=Math.max(r.height,n)}e===this._width&&n===this._height||(this._width=e,this._height=n,this._destroyDeferredData(),this._generateDeferredRenderData())},n._generateDeferredRenderData=function(){for(var t=this,e=this.device,n=this._pipelineRenderData=new yM,i=this.pipelineSceneData,r=0;r<3;++r)n.gbufferRenderTargets.push(e.createTexture(new pr(vi.TEX2D,gi.COLOR_ATTACHMENT|gi.SAMPLED,ui.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale)));n.outputDepth=e.createTexture(new pr(vi.TEX2D,gi.DEPTH_STENCIL_ATTACHMENT|gi.SAMPLED,ui.DEPTH_STENCIL,this._width*i.shadingScale,this._height*i.shadingScale)),n.gbufferFrameBuffer=e.createFramebuffer(new Lr(this._gbufferRenderPass,n.gbufferRenderTargets,n.outputDepth)),n.outputRenderTargets.push(e.createTexture(new pr(vi.TEX2D,gi.COLOR_ATTACHMENT|gi.SAMPLED,ui.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale))),n.outputFrameBuffer=e.createFramebuffer(new Lr(this._lightingRenderPass,n.outputRenderTargets,null)),this.on(Ly.ATTACHMENT_SCALE_CAHNGED,(function(e){n.sampler=e<1?t.globalDSManager.pointSampler:t.globalDSManager.linearSampler,t.applyFramebufferRatio(n.gbufferFrameBuffer),t.applyFramebufferRatio(n.outputFrameBuffer)})),n.sampler=this.globalDSManager.linearSampler},e}(rx),dM=st((pM=mM).prototype,"renderTextures",[hM,vc,_M],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fM=pM))||fM));function SM(){var t=new HB;return t.initialize({flows:[]}),t}var CM=new Wn,AM=function(){var t=e.prototype;function e(){this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.isPause=!1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}return t.pauseRendering=function(){this.isPause=!0},t.resumeRendering=function(){this.isPause=!1},t.main=function(t){if(null!=t){if(window._CCSettings&&window._CCSettings.splashScreen){var e=this.settings=window._CCSettings.splashScreen;e.totalTime=null!=this.settings.totalTime?this.settings.totalTime:3e3,e.base64src=this.settings.base64src||"",e.effect=this.settings.effect||"FADE-INOUT",e.clearColor=this.settings.clearColor||new or(.88,.88,.88,1),e.displayRatio=null!=this.settings.displayRatio?this.settings.displayRatio:.4,e.displayWatermark=null==this.settings.displayWatermark||this.settings.displayWatermark}else this.settings={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new or(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0};if(""===this.settings.base64src||this.settings.totalTime<=0)this.callBack&&this.callBack(),this.callBack=null,this.settings=null,this._directCall=!0;else{c.view.resizeWithBrowserSize(!0);var n=window._CCSettings.designResolution;n?c.view.setDesignResolutionSize(n.width,n.height,n.policy):c.view.setDesignResolutionSize(960,640,4),this.device=t.device,this.swapchain=t.mainWindow.swapchain,this.framebuffer=t.mainWindow.framebuffer,c.game.once(c.Game.EVENT_GAME_INITED,(function(){c.director._lateUpdate=performance.now()}),c.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.preInit(),this.logoImage=new Image,this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.settings.base64src}}else x("RENDER ROOT IS NULL.")},t.setOnFinish=function(t){if(this._directCall&&t)return e._ins=void 0,void t();this.callBack=t},t._tryToStart=function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide(),c.game.resume())},t.preInit=function(){var t=this.settings.clearColor;this.clearColors=[new or(t.x,t.y,t.z,t.w)];var e=this.device,n=this.swapchain;this.renderArea=new Qi(0,0,n.width,n.height),this.cmdBuff=e.commandBuffer;var i=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]),r=4*Float32Array.BYTES_PER_ELEMENT,o=4*r;this.vertexBuffers=e.createBuffer(new lr(fi.VERTEX|fi.TRANSFER_DST,mi.DEVICE,o,r)),this.vertexBuffers.update(i);var a=new Uint16Array([0,1,2,1,3,2]),s=Uint16Array.BYTES_PER_ELEMENT,c=6*s;this.indicesBuffers=e.createBuffer(new lr(fi.INDEX|fi.TRANSFER_DST,mi.DEVICE,c,s)),this.indicesBuffers.update(a);var l=[new Er("a_position",ui.RG32F),new Er("a_texCoord",ui.RG32F)],u=new Pr(l,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=e.createInputAssembler(u),this.projection=new Un,Un.ortho(this.projection,-1,1,-1,1,-1,1,e.capabilities.clipSpaceMinZ,e.capabilities.clipSpaceSignY,n.surfaceTransform)},t.init=function(){var t=this;this.initLogo(),this.settings.displayWatermark&&this.initWarterMark(),c.game.pause(),this.handle=requestAnimationFrame((function e(n){if(!t.cancelAnimate){var i=t.settings,r=t.device,o=t.swapchain;Un.ortho(t.projection,-1,1,-1,1,-1,1,r.capabilities.clipSpaceMinZ,r.capabilities.clipSpaceSignY,o.surfaceTransform);var a=o.width,s=o.height,c=a<s?a:s;t.startTime<0&&(t.startTime=n);var l=n-t.startTime,u=l_(an(l/i.totalTime));"NONE"===i.effect&&(u=1);var h=t.logoTexture.width,_=t.logoTexture.height,f=c*i.displayRatio,p=f*h/_,d=f;if(o.surfaceTransform!==ci.ROTATE_90&&o.surfaceTransform!==ci.ROTATE_270||(p=f*a/s,d=f*_/h*s/a),t.logoMat.setProperty("resolution",CM.set(a,s),0),t.logoMat.setProperty("scale",CM.set(p,d),0),t.logoMat.setProperty("translate",CM.set(.5*a,.5*s),0),t.logoMat.setProperty("percent",u),t.logoMat.setProperty("u_projection",t.projection),t.logoMat.passes[0].update(),i.displayWatermark&&t.watermarkMat){var m=.5*c,v=t.watermarkTexture.width,g=m,y=m*t.watermarkTexture.height/v;o.surfaceTransform!==ci.ROTATE_90&&o.surfaceTransform!==ci.ROTATE_270||(g=.5*m,y=m*a/s*.5),t.watermarkMat.setProperty("resolution",CM.set(a,s),0),t.watermarkMat.setProperty("scale",CM.set(g,y),0),t.watermarkMat.setProperty("translate",CM.set(.5*a,.1*s),0),t.watermarkMat.setProperty("percent",u),t.watermarkMat.setProperty("u_projection",t.projection),t.watermarkMat.passes[0].update()}t.isPause||(t.frame(),l>i.totalTime&&(t.splashFinish=!0)),requestAnimationFrame(e)}}))},t.hide=function(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))},t.initLogo=function(){var t=this.device;this.logoMat=new ig,this.logoMat.initialize({effectName:"splash-screen"});var e=new mr;e.addressU=Ai.CLAMP,e.addressV=Ai.CLAMP,e.addressW=Ai.CLAMP,this.sampler=t.getSampler(e),this.logoTexture=t.createTexture(new pr(vi.TEX2D,gi.SAMPLED|gi.TRANSFER_DST,ui.RGBA8,this.logoImage.width,this.logoImage.height));var n=this.logoMat.passes[0],i=n.getBinding("mainTexture");n.bindTexture(i,this.logoTexture),this.shader=n.getShaderVariant();var r=n.descriptorSet;r.bindSampler(i,this.sampler),r.update();var o=new ir;o.texExtent.width=this.logoImage.width,o.texExtent.height=this.logoImage.height,o.texExtent.depth=1,t.copyTexImagesToTexture([this.logoImage],this.logoTexture,[o])},t.initWarterMark=function(){var t=document.createElement("canvas");t.width=330,t.height=30,t.style.width=""+t.width,t.style.height=""+t.height;var e=t.getContext("2d");e.font="18px Arial",e.textBaseline="top",e.textAlign="left",e.fillStyle="`#424242`";var n="Powered by Cocos Creator",i=e.measureText(n);e.fillText(n,(330-i.width)/2,6);var r=new ir;r.texExtent.width=t.width,r.texExtent.height=t.height,r.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new pr(vi.TEX2D,gi.SAMPLED|gi.TRANSFER_DST,ui.RGBA8,t.width,t.height)),this.device.copyTexImagesToTexture([t],this.watermarkTexture,[r]),this.watermarkMat=new ig,this.watermarkMat.initialize({effectName:"splash-screen"});var o=this.watermarkMat.passes[0],a=o.getBinding("mainTexture");o.bindTexture(a,this.watermarkTexture),o.descriptorSet.update()},t.frame=function(){var t=this.device,e=this.swapchain;t.acquire([e]);var n=this.cmdBuff,i=this.framebuffer,r=this.renderArea;r.width=e.width,r.height=e.height,n.begin(),n.beginRenderPass(i.renderPass,i,r,this.clearColors,1,0);var o=this.logoMat.passes[0],a=Nv.getOrCreatePipelineState(t,o,this.shader,i.renderPass,this.quadAssmebler);if(n.bindPipelineState(a),n.bindDescriptorSet(kp.MATERIAL,o.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler),this.settings.displayWatermark&&this.watermarkMat){var s=this.watermarkMat.passes[0],c=Nv.getOrCreatePipelineState(t,s,this.shader,i.renderPass,this.quadAssmebler);n.bindPipelineState(c),n.bindDescriptorSet(kp.MATERIAL,s.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler)}n.endRenderPass(),n.end(),t.flushCommands([n]),t.queue.submit([n]),t.present()},t.destroy=function(){this.callBack=null,this.device=null,this.swapchain=null,this.clearColors=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.framebuffer=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null,e._ins=void 0},K(e,[{key:"splashFinish",set:function(t){this._splashFinish=t,this._tryToStart()}},{key:"loadFinish",set:function(t){this._loadFinish=t,this._tryToStart()}}],[{key:"instance",get:function(){return e._ins||(e._ins=new e),e._ins}}]),e}();AM._ins=void 0,c.internal.SplashScreen=AM;var bM=t("System",function(){function t(){this._id="",this._priority=0,this._executeInEditMode=!1}t.sortByPriority=function(t,e){return t._priority<e._priority?1:t._priority>e.priority?-1:0};var e=t.prototype;return e.init=function(){},e.update=function(){},e.postUpdate=function(){},K(t,[{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t}},{key:"id",get:function(){return this._id},set:function(t){this._id=t}}]),t}());bM.Priority=ie({LOW:0,MEDIUM:100,HIGH:200,SCHEDULER:1<<31>>>0});var TM=new pt("Scheduler"),EM=function(t,e,n,i){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=t,this.priority=e,this.paused=n,this.markedForDeletion=i};EM.get=function(t,e,n,i){var r=EM._listEntries.pop();return r?(r.target=t,r.priority=e,r.paused=n,r.markedForDeletion=i):r=new EM(t,e,n,i),r},EM.put=function(t){EM._listEntries.length<20&&(t.target=null,EM._listEntries.push(t))},EM._listEntries=[];var wM=function(t,e,n,i){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=t,this.entry=e,this.target=n,this.callback=i};wM.get=function(t,e,n,i){var r=wM._hashUpdateEntries.pop();return r?(r.list=t,r.entry=e,r.target=n,r.callback=i):r=new wM(t,e,n,i),r},wM.put=function(t){wM._hashUpdateEntries.length<20&&(t.list=t.entry=t.target=t.callback=null,wM._hashUpdateEntries.push(t))},wM._hashUpdateEntries=[];var PM=function(t,e,n,i,r,o){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=t,this.target=e,this.timerIndex=n,this.currentTimer=i,this.currentTimerSalvaged=r,this.paused=o};PM.get=function(t,e,n,i,r,o){var a=PM._hashTimerEntries.pop();return a?(a.timers=t,a.target=e,a.timerIndex=n,a.currentTimer=i,a.currentTimerSalvaged=r,a.paused=o):a=new PM(t,e,n,i,r,o),a},PM.put=function(t){PM._hashTimerEntries.length<20&&(t.timers=t.target=t.currentTimer=null,PM._hashTimerEntries.push(t))},PM._hashTimerEntries=[];var IM=function(){function t(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}var e=t.prototype;return e.initWithCallback=function(t,e,n,i,r,o){return this._lock=!1,this._scheduler=t,this._target=n,this._callback=e,this._elapsed=-1,this._interval=i,this._delay=o,this._useDelay=this._delay>0,this._repeat=r,this._runForever=this._repeat===c.macro.REPEAT_FOREVER,!0},e.getInterval=function(){return this._interval},e.setInterval=function(t){this._interval=t},e.update=function(t){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=t,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))},e.getCallback=function(){return this._callback},e.trigger=function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)},e.cancel=function(){this._scheduler.unschedule(this._callback,this._target)},t}();IM._timers=[],IM.get=function(){return IM._timers.pop()||new IM},IM.put=function(t){IM._timers.length<20&&!t._lock&&(t._scheduler=t._target=t._callback=null,IM._timers.push(t))};var RM,DM=t("Scheduler",function(t){function e(){var e;return(e=t.call(this)||this)._timeScale=void 0,e._updatesNegList=void 0,e._updates0List=void 0,e._updatesPosList=void 0,e._hashForUpdates=void 0,e._hashForTimers=void 0,e._currentTarget=void 0,e._currentTargetSalvaged=void 0,e._updateHashLocked=void 0,e._arrayForTimers=void 0,e._timeScale=1,e._updatesNegList=[],e._updates0List=[],e._updatesPosList=[],e._hashForUpdates=Et(!0),e._hashForTimers=Et(!0),e._currentTarget=null,e._currentTargetSalvaged=!1,e._updateHashLocked=!1,e._arrayForTimers=[],e}Q(e,t),e.enableForTarget=function(t){var e=!1;(t.uuid||t.id)&&(e=!0),e||(t.__instanceId?I(1513):t.id=TM.getNewId())};var n=e.prototype;return n.setTimeScale=function(t){this._timeScale=t},n.getTimeScale=function(){return this._timeScale},n.update=function(t){var e,n,i,r,o;for(this._updateHashLocked=!0,1!==this._timeScale&&(t*=this._timeScale),e=0,i=(n=this._updatesNegList).length;e<i;e++)(r=n[e]).paused||r.markedForDeletion||r.target.update(t);for(e=0,i=(n=this._updates0List).length;e<i;e++)(r=n[e]).paused||r.markedForDeletion||r.target.update(t);for(e=0,i=(n=this._updatesPosList).length;e<i;e++)(r=n[e]).paused||r.markedForDeletion||r.target.update(t);var a=this._arrayForTimers;for(e=0;e<a.length;e++){if(o=a[e],this._currentTarget=o,this._currentTargetSalvaged=!1,!o.paused)for(o.timerIndex=0;o.timerIndex<o.timers.length;++o.timerIndex)o.currentTimer=o.timers[o.timerIndex],o.currentTimerSalvaged=!1,o.currentTimer.update(t),o.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--e)}for(e=0,n=this._updatesNegList;e<n.length;)(r=n[e]).markedForDeletion?this._removeUpdateFromHash(r):e++;for(e=0,n=this._updates0List;e<n.length;)(r=n[e]).markedForDeletion?this._removeUpdateFromHash(r):e++;for(e=0,n=this._updatesPosList;e<n.length;)(r=n[e]).markedForDeletion?this._removeUpdateFromHash(r):e++;this._updateHashLocked=!1,this._currentTarget=null},n.schedule=function(t,e,n,i,r,o){if("function"!=typeof t){var a=t;t=e,e=a}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(o=!!i,i=c.macro.REPEAT_FOREVER,r=0),O(e,1502);var s=e.uuid||e.id;if(s){var l,u,h=this._hashForTimers[s];if(h?h.paused!==o&&I(1511):(h=PM.get(null,e,0,null,null,o),this._arrayForTimers.push(h),this._hashForTimers[s]=h),null==h.timers)h.timers=[];else for(u=0;u<h.timers.length;++u)if((l=h.timers[u])&&t===l._callback)return w(1507,l.getInterval(),n),void(l._interval=n);(l=IM.get()).initWithCallback(this,t,e,n,i,r),h.timers.push(l),this._currentTarget===h&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else D(1510)},n.scheduleUpdate=function(t,e,n){var i=t.uuid||t.id;if(i){var r=this._hashForUpdates[i];if(r&&r.entry){if(r.entry.priority===e)return r.entry.markedForDeletion=!1,void(r.entry.paused=n);if(this._updateHashLocked)return w(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=n);this.unscheduleUpdate(t)}var o,a=EM.get(t,e,n,!1);0===e?(o=this._updates0List,this._appendIn(o,a)):(o=e<0?this._updatesNegList:this._updatesPosList,this._priorityIn(o,a,e)),this._hashForUpdates[i]=wM.get(o,a,t,null)}else D(1510)},n.unschedule=function(t,e){if(e&&t){var n=e.uuid||e.id;if(n){var i=this._hashForTimers[n];if(i)for(var r=i.timers,o=0,a=r.length;o<a;o++){var s=r[o];if(t===s._callback)return s!==i.currentTimer||i.currentTimerSalvaged||(i.currentTimerSalvaged=!0),r.splice(o,1),IM.put(s),i.timerIndex>=o&&i.timerIndex--,void(0===r.length&&(this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)))}}else D(1510)}},n.unscheduleUpdate=function(t){if(t){var e=t.uuid||t.id;if(e){var n=this._hashForUpdates[e];n&&(this._updateHashLocked?n.entry.markedForDeletion=!0:this._removeUpdateFromHash(n.entry))}else D(1510)}},n.unscheduleAllForTarget=function(t){if(t){var e=t.uuid||t.id;if(e){var n=this._hashForTimers[e];if(n){var i=n.timers;i.indexOf(n.currentTimer)>-1&&!n.currentTimerSalvaged&&(n.currentTimerSalvaged=!0);for(var r=0,o=i.length;r<o;r++)IM.put(i[r]);i.length=0,this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)}this.unscheduleUpdate(t)}else D(1510)}},n.unscheduleAll=function(){this.unscheduleAllWithMinPriority(bM.Priority.SCHEDULER)},n.unscheduleAllWithMinPriority=function(t){var e,n,i,r=this._arrayForTimers;for(e=r.length-1;e>=0;e--)n=r[e],this.unscheduleAllForTarget(n.target);var o=0;if(t<0)for(e=0;e<this._updatesNegList.length;)o=this._updatesNegList.length,(i=this._updatesNegList[e])&&i.priority>=t&&this.unscheduleUpdate(i.target),o===this._updatesNegList.length&&e++;if(t<=0)for(e=0;e<this._updates0List.length;)o=this._updates0List.length,(i=this._updates0List[e])&&this.unscheduleUpdate(i.target),o===this._updates0List.length&&e++;for(e=0;e<this._updatesPosList.length;)o=this._updatesPosList.length,(i=this._updatesPosList[e])&&i.priority>=t&&this.unscheduleUpdate(i.target),o===this._updatesPosList.length&&e++},n.isScheduled=function(t,e){O(t,1508),O(e,1509);var n=e.uuid||e.id;if(!n)return D(1510),!1;var i=this._hashForTimers[n];if(!i)return!1;if(null==i.timers)return!1;for(var r=i.timers,o=0;o<r.length;++o)if(t===r[o]._callback)return!0;return!1},n.pauseAllTargets=function(){return this.pauseAllTargetsWithMinPriority(bM.Priority.SCHEDULER)},n.pauseAllTargetsWithMinPriority=function(t){var e,n,i,r,o=[],a=this._arrayForTimers;for(n=0,i=a.length;n<i;n++)(e=a[n])&&(e.paused=!0,o.push(e.target));if(t<0)for(n=0;n<this._updatesNegList.length;n++)(r=this._updatesNegList[n])&&r.priority>=t&&(r.paused=!0,o.push(r.target));if(t<=0)for(n=0;n<this._updates0List.length;n++)(r=this._updates0List[n])&&(r.paused=!0,o.push(r.target));for(n=0;n<this._updatesPosList.length;n++)(r=this._updatesPosList[n])&&r.priority>=t&&(r.paused=!0,o.push(r.target));return o},n.resumeTargets=function(t){if(t)for(var e=0;e<t.length;e++)this.resumeTarget(t[e])},n.pauseTarget=function(t){O(t,1503);var e=t.uuid||t.id;if(e){var n=this._hashForTimers[e];n&&(n.paused=!0);var i=this._hashForUpdates[e];i&&(i.entry.paused=!0)}else D(1510)},n.resumeTarget=function(t){O(t,1504);var e=t.uuid||t.id;if(e){var n=this._hashForTimers[e];n&&(n.paused=!1);var i=this._hashForUpdates[e];i&&(i.entry.paused=!1)}else D(1510)},n.isTargetPaused=function(t){O(t,1505);var e=t.uuid||t.id;if(!e)return D(1510),!1;var n=this._hashForTimers[e];if(n)return n.paused;var i=this._hashForUpdates[e];return!!i&&i.entry.paused},n._removeHashElement=function(t){var e=t.target.uuid||t.target.id;delete this._hashForTimers[e];for(var n=this._arrayForTimers,i=0,r=n.length;i<r;i++)if(n[i]===t){n.splice(i,1);break}PM.put(t)},n._removeUpdateFromHash=function(t){var e=t.target.uuid||t.target.id,n=this._hashForUpdates[e];if(n){for(var i=n.list,r=n.entry,o=0,a=i.length;o<a;o++)if(i[o]===r){i.splice(o,1);break}delete this._hashForUpdates[e],EM.put(r),wM.put(n)}},n._priorityIn=function(t,e,n){for(var i=0;i<t.length;i++)if(n<t[i].priority)return void t.splice(i,0,e);t.push(e)},n._appendIn=function(t,e){t.push(e)},e}(bM));DM.ID="scheduler",c.Scheduler=DM;var BM=((RM={})[Qu.PORTRAIT]=ci.IDENTITY,RM[Qu.LANDSCAPE_RIGHT]=ci.ROTATE_90,RM[Qu.PORTRAIT_UPSIDE_DOWN]=ci.ROTATE_180,RM[Qu.LANDSCAPE_LEFT]=ci.ROTATE_270,RM),MM=function(){function t(){this._title="",this._width=1,this._height=1,this._swapchain=null,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null}t.registerCreateFunc=function(e){e._createWindowFun=function(e){return new t(e)}};var e=t.prototype;return e.initialize=function(t,e){if(this._init(),void 0!==e.title&&(this._title=e.title),void 0!==e.swapchain&&(this._swapchain=e.swapchain),this._width=e.width,this._height=e.height,this._renderPass=t.createRenderPass(e.renderPassInfo),e.swapchain)this._setSwapchain(e.swapchain),this._colorTextures.push(e.swapchain.colorTexture),this._depthStencilTexture=e.swapchain.depthStencilTexture;else{for(var n=0;n<e.renderPassInfo.colorAttachments.length;n++)this._colorTextures.push(t.createTexture(new pr(vi.TEX2D,gi.COLOR_ATTACHMENT|gi.SAMPLED|gi.TRANSFER_SRC,e.renderPassInfo.colorAttachments[n].format,this._width,this._height)));e.renderPassInfo.depthStencilAttachment.format!==ui.UNKNOWN&&(this._depthStencilTexture=t.createTexture(new pr(vi.TEX2D,gi.DEPTH_STENCIL_ATTACHMENT|gi.SAMPLED,e.renderPassInfo.depthStencilAttachment.format,this._width,this._height)))}return this._setFrameBuffer(t.createFramebuffer(new Lr(this._renderPass,this._colorTextures,this._depthStencilTexture))),!0},e.destroy=function(){this.clearCameras(),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var t=0;t<this._colorTextures.length;t++){var e=this._colorTextures[t];e&&e.destroy()}this._colorTextures.length=0,this._destroy()},e.resize=function(t,e){if(this._swapchain)this._swapchain.resize(t,e,BM[nh.orientation]),this._width=this._swapchain.width,this._height=this._swapchain.height;else{for(var n=0;n<this._colorTextures.length;n++)this._colorTextures[n].resize(t,e);this._depthStencilTexture&&this._depthStencilTexture.resize(t,e),this._width=t,this._height=e}this.framebuffer&&(this.framebuffer.destroy(),this.framebuffer.initialize(new Lr(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(var i,r=ot(this._cameras);!(i=r()).done;)i.value.resize(t,e)},e.extractRenderCameras=function(t){for(var e=0;e<this._cameras.length;e++){var n=this._cameras[e];n.enabled&&(n.update(),t.push(n))}},e.attachCamera=function(t){for(var e=0;e<this._cameras.length;e++)if(this._cameras[e]===t)return;this._cameras.push(t),this.sortCameras()},e.detachCamera=function(t){for(var e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return void this._cameras.splice(e,1)},e.clearCameras=function(){this._cameras.length=0},e.sortCameras=function(){this._cameras.sort((function(t,e){return t.priority-e.priority}))},e._init=function(){},e._destroy=function(){},e._setSwapchain=function(t){this._swapchain=t},e._setFrameBuffer=function(t){this._framebuffer=t},K(t,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"swapchain",get:function(){return this._swapchain}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"cameras",get:function(){return this._cameras}},{key:"native",get:function(){return this._nativeObj}}]),t}(),OM=function(){var t=e.prototype;function e(t){var e=this;this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._device=t,this._dataPoolMgr=c.internal.DataPoolManager&&new c.internal.DataPoolManager(t),rC.registerCreateFunc(this),MM.registerCreateFunc(this),this._cameraPool=new Vl((function(){return new _g(e._device)}),4,(function(t){return t.destroy()}))}return t._init=function(){},t._destroy=function(){},t._setCumulativeTime=function(t){this._cumulativeTime+=t},t._setFrameTime=function(t){this._frameTime=t},t.initialize=function(){this._init();var t=c.game._swapchain,e=new Ir;e.format=t.colorTexture.format;var n=new Rr;n.format=t.depthStencilTexture.format,n.depthStoreOp=Di.DISCARD,n.stencilStoreOp=Di.DISCARD;var i=new Mr([e],n);return this._mainWindow=this.createWindow({title:"rootMainWindow",width:t.width,height:t.height,renderPassInfo:i,swapchain:t}),this._curWindow=this._mainWindow,Promise.resolve(wv.initBuiltinRes(this._device))},t.destroy=function(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._destroy()},t.resize=function(t,e){for(var n,i=ot(this._windows);!(n=i()).done;){var r=n.value;r.swapchain&&r.resize(t,e)}},t.setRenderPipeline=function(t){t instanceof xM&&(this._useDeferredPipeline=!0);var e=!1;if(t||(t=SM(),e=!0),this._pipeline=t,this._useDeferredPipeline&&this.device.hasFeature(li.COMPUTE_SHADER)||(this._pipeline.clusterEnabled=!1),this._pipeline.bloomEnabled=!1,!this._pipeline.activate(this._mainWindow.swapchain))return e&&this._pipeline.destroy(),this._pipeline=null,!1;var n=c.director.getScene();return n&&n.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&c.internal.Batcher2D&&(this._batcher=new c.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))},t.onGlobalPipelineStateChanged=function(){for(var t=0;t<this._scenes.length;t++)this._scenes[t].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.onGlobalPipelineStateChanged()},t.activeWindow=function(t){this._curWindow=t},t.resetCumulativeTime=function(){this._setCumulativeTime(0)},t.frameMove=function(t){this._setFrameTime(t),++this._frameCount,this._setCumulativeTime(t),this._fpsTime+=t,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(var e=0;e<this._scenes.length;++e)this._scenes[e].removeBatches();for(var n=this._windows,i=[],r=0;r<n.length;r++)n[r].extractRenderCameras(i);if(this._pipeline&&i.length>0){this._device.acquire([c.game._swapchain]);var o=this._scenes,a=c.director.getTotalFrames();this._batcher&&(this._batcher.update(),this._batcher.uploadBuffers());for(var s=0;s<o.length;s++)o[s].update(a);c.director.emit(c.Director.EVENT_BEFORE_COMMIT),i.sort((function(t,e){return t.priority-e.priority})),this._pipeline.render(i),this._device.present()}this._batcher&&this._batcher.reset()},t.createWindow=function(t){var e=this._createWindowFun(this);return e.initialize(this.device,t),this._windows.push(e),e},t.destroyWindow=function(t){for(var e=0;e<this._windows.length;++e)if(this._windows[e]===t)return t.destroy(),void this._windows.splice(e,1)},t.destroyWindows=function(){for(var t,e=ot(this._windows);!(t=e()).done;)t.value.destroy();this._windows.length=0},t.createScene=function(t){var e=this._createSceneFun(this);return e.initialize(t),this._scenes.push(e),e},t.destroyScene=function(t){for(var e=0;e<this._scenes.length;++e)if(this._scenes[e]===t)return t.destroy(),void this._scenes.splice(e,1)},t.destroyScenes=function(){for(var t,e=ot(this._scenes);!(t=e()).done;)t.value.destroy();this._scenes.length=0},t.createModel=function(t){var e=this._modelPools.get(t);e||(this._modelPools.set(t,new Vl((function(){return new t}),10,(function(t){return t.destroy()}))),e=this._modelPools.get(t));var n=e.alloc();return n.initialize(),n},t.destroyModel=function(t){var e=this._modelPools.get(t.constructor);e?(e.free(t),t.scene&&t.scene.removeModel(t)):I(1300,t.constructor.name),t.destroy()},t.createCamera=function(){return this._cameraPool.alloc()},t.createLight=function(t){var e=this._lightPools.get(t);e||(this._lightPools.set(t,new Vl((function(){return new t}),4,(function(t){return t.destroy()}))),e=this._lightPools.get(t));var n=e.alloc();return n.initialize(),n},t.destroyLight=function(t){var e=this._lightPools.get(t.constructor);if(e&&(e.free(t),t.scene))switch(t.type){case $g.SPHERE:t.scene.removeSphereLight(t);break;case $g.SPOT:t.scene.removeSpotLight(t)}t.destroy()},K(e,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow},set:function(t){this._curWindow=t}},{key:"tempWindow",get:function(){return this._tempWindow},set:function(t){this._tempWindow=t}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"batcher2D",get:function(){return this._batcher}},{key:"scenes",get:function(){return this._scenes}},{key:"cumulativeTime",get:function(){return this._cumulativeTime}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",get:function(){return this._fixedFPS},set:function(t){t>0?(this._fixedFPS=t,this._fixedFPSFrameTime=1e3/t):this._fixedFPSFrameTime=0}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"useDeferredPipeline",get:function(){return this._useDeferredPipeline}}]),e}();c.Root=OM;var NM=t("Game",function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).frame=null,e.container=null,e.canvas=null,e.renderType=-1,e.eventTargetOn=t.prototype.on,e.eventTargetOnce=t.prototype.once,e.config={},e.onStart=null,e.frameTime=1e3/60,e.collisionMatrix=[],e.groupList=[],e._persistRootNodes={},e._gfxDevice=null,e._swapchain=null,e._configLoaded=!1,e._isCloning=!1,e._inited=!1,e._engineInited=!1,e._rendererInitialized=!1,e._paused=!0,e._frameRate=60,e._intervalId=0,e._initTime=0,e._startTime=0,e._deltaTime=0,e._onEngineInitedCallback=[],e}Q(e,t);var i=e.prototype;return i.setFrameRate=function(t){this.frameRate=t},i.getFrameRate=function(){return this.frameRate},i.step=function(){c.director.tick(this.frameTime/1e3)},i.pause=function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))},i.resume=function(){this._paused&&(oD._clearEvents(),this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._paused=!1,this._updateCallback(),this._intervalId=window.rAF(this._frameCB))},i.isPaused=function(){return this._paused},i.restart=function(){var t=this;return new Promise((function(t){return c.director.once(c.Director.EVENT_END_FRAME,(function(){return t()}))})).then((function(){for(var n in t._persistRootNodes)t.removePersistRootNode(t._persistRootNodes[n]);return c.director.getScene().destroy(),c.Object._deferredDestroy(),c.director.reset(),c.profiler.reset(),t.pause(),t._setRenderPipelineNShowSplash().then((function(){t.resume(),t._safeEmit(e.EVENT_RESTART)}))}))},i.end=function(){hu.close()},i.on=function(t,n,i,r){return(this._engineInited&&t===e.EVENT_ENGINE_INITED||this._inited&&t===e.EVENT_GAME_INITED||this._rendererInitialized&&t===e.EVENT_RENDERER_INITED)&&n.call(i),this.eventTargetOn(t,n,i,r)},i.once=function(t,n,i){return this._engineInited&&t===e.EVENT_ENGINE_INITED?n.call(i):this.eventTargetOnce(t,n,i)},i.init=function(t){var e=this;if(this._initConfig(t),rh._init({configOrientation:t.orientation||"auto",exactFitScreen:t.exactFitScreen}),this.config.assetOptions&&c.assetManager.init(this.config.assetOptions),this.config.layers)for(var i=this.config.layers,r=0;r<i.length;r++){var o=i[r],a=n(o.value);Rp.addLayer(o.name,a)}return this._initEngine().then((function(){return e._initEvents(),c.director.root&&c.director.root.dataPoolManager&&c.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(t.customJointTextureLayouts),e._engineInited}))},i.run=function(t,e){var n,i=this;return"function"!=typeof t&&t?(n=this.init(t),this.onStart=null!=e?e:null):this.onStart=null!=t?t:null,ou.init(),Promise.resolve(n).then((function(){return i._setRenderPipelineNShowSplash()})).then((function(){}))},i.addPersistRootNode=function(t){if(c.Node.isNode(t)&&t.uuid){var e=t.uuid;if(!this._persistRootNodes[e]){var n=c.director._scene;if(c.isValid(n))if(t.parent){if(!(t.parent instanceof c.Scene))return void I(3801);if(t.parent!==n)return void I(3802);t._originalSceneId=n.uuid}else t.parent=n;this._persistRootNodes[e]=t,t._persistNode=!0,c.assetManager._releaseManager._addPersistNodeRef(t)}}else I(3800)},i.removePersistRootNode=function(t){var e=t.uuid||"";t===this._persistRootNodes[e]&&(delete this._persistRootNodes[e],t._persistNode=!1,t._originalSceneId="",c.assetManager._releaseManager._removePersistNodeRef(t))},i.isPersistRootNode=function(t){return!!t._persistNode},i.onEngineInitedAsync=function(t){this._onEngineInitedCallback.push(t)},i._initEngine=function(){var t=this;this._initDevice();var n=c.director;return Promise.resolve(n._init()).then((function(){c.view.init(),g("Cocos Creator v"+l),t.emit(e.EVENT_ENGINE_INITED),t._engineInited=!0,c.internal.dynamicAtlasManager&&(c.internal.dynamicAtlasManager.enabled=!ce.CLEANUP_IMAGE_CACHE)})).then((function(){var e=t._onEngineInitedCallback.map((function(t){return t()})).filter(Boolean);return t._onEngineInitedCallback.length=0,Promise.all(e)}))},i._setAnimFrame=function(){var t=this._frameRate,e=window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;60!==t&&30!==t?(window.rAF=this._stTime.bind(this),window.cAF=this._ctTime):(window.rAF=e||this._stTime.bind(this),window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime,this._updateCallback())},i._stTime=function(t){var e=performance.now(),n=Math.max(0,e-this._startTime),i=Math.max(0,this.frameTime-n);return window.setTimeout(t,i)},i._ctTime=function(t){window.clearTimeout(t)},i._calculateDT=function(t){return t||(t=performance.now()),this._deltaTime=t>this._startTime?(t-this._startTime)/1e3:0,this._deltaTime>e.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=t,this._deltaTime},i._updateCallback=function(){var t,e=this,n=c.director;if(30===this._frameRate){var i=!0;t=function(t){e._intervalId=window.rAF(e._frameCB),(i=!i)||n.tick(e._calculateDT(t))}}else t=function(t){n.tick(e._calculateDT(t)),e._intervalId=window.rAF(e._frameCB)};this._frameCB=t},i._runMainLoop=function(){if(this._inited){var t=this.config,e=c.director;F(!!t.showFPS),e.startAnimation(),this.resume()}},i._initConfig=function(t){"number"!=typeof t.debugMode&&(t.debugMode=B.NONE),t.exposeClassName=!!t.exposeClassName,"number"!=typeof t.frameRate&&(t.frameRate=60);var e=t.renderMode;("number"!=typeof e||e>3||e<0)&&(t.renderMode=0),t.showFPS=!!t.showFPS,A(t.debugMode),this.config=t,this._configLoaded=!0,this.frameRate=t.frameRate},i._determineRenderType=function(){var t=this.config,n=parseInt(t.renderMode,10);this.renderType=e.RENDER_TYPE_CANVAS;var i=!1;if(1===n?(this.renderType=e.RENDER_TYPE_CANVAS,i=!0):0===n||2===n?(this.renderType=e.RENDER_TYPE_WEBGL,i=!0):3===n&&(this.renderType=e.RENDER_TYPE_HEADLESS,i=!0),!i)throw new Error(N(3820,n))},i._initDevice=function(){if(!this._rendererInitialized){var t=this.config.adapter;if(t&&(this.canvas=t.canvas,this.frame=t.frame,this.container=t.container),this._determineRenderType(),this.renderType===e.RENDER_TYPE_WEBGL){var n=new cr(Wp),i=!!window.WebGL2RenderingContext,r=window.navigator.userAgent.toLowerCase();(-1!==r.indexOf("safari")&&-1===r.indexOf("chrome")||oh.browserType===$l.UC)&&(i=!1);var o=[];i&&c.WebGL2Device&&o.push(c.WebGL2Device),c.WebGLDevice&&o.push(c.WebGLDevice),c.EmptyDevice&&o.push(c.EmptyDevice),lo.canvas=this.canvas;for(var a=0;a<o.length&&(this._gfxDevice=new o[a],!this._gfxDevice.initialize(n));a++);}else this.renderType===e.RENDER_TYPE_HEADLESS&&c.EmptyDevice&&(this._gfxDevice=new c.EmptyDevice,this._gfxDevice.initialize(new cr(Wp)));if(!this._gfxDevice)return x("can not support canvas rendering in 3D"),void(this.renderType=e.RENDER_TYPE_CANVAS);var s=new sr(this.canvas),l=rh.windowSize;s.width=l.width,s.height=l.height,this._swapchain=this._gfxDevice.createSwapchain(s),this.canvas.oncontextmenu=function(){return!1}}},i._initEvents=function(){hu.on("show",this._onShow,this),hu.on("hide",this._onHide,this)},i._onHide=function(){this.emit(e.EVENT_HIDE),this.pause()},i._onShow=function(){this.emit(e.EVENT_SHOW),this.resume()},i._setRenderPipelineNShowSplash=function(){var t=this;return Promise.resolve(this._setupRenderPipeline()).then((function(){return Promise.resolve(t._showSplashScreen()).then((function(){t._inited=!0,t._initTime=performance.now(),t._runMainLoop(),t._safeEmit(e.EVENT_GAME_INITED),t.onStart&&t.onStart()}))}))},i._setupRenderPipeline=function(){var t=this,e=this.config.renderPipeline;return e?new Promise((function(t,n){c.assetManager.loadAny(e,(function(e,i){return!e&&i instanceof rx?t(i):n(e)}))})).then((function(e){t._setRenderPipeline(e)})).catch((function(n){y(n),y("Failed load render pipeline: "+e+", engine failed to initialize, will fallback to default pipeline"),t._setRenderPipeline()})):this._setRenderPipeline()},i._showSplashScreen=function(){if(c.internal.SplashScreen){var t=c.internal.SplashScreen.instance;return t.main(c.director.root),new Promise((function(e){t.setOnFinish((function(){return e()})),t.loadFinish=!0}))}return null},i._setRenderPipeline=function(t){c.director.root.setRenderPipeline(t)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(e.EVENT_RENDERER_INITED)},i._safeEmit=function(t){this.emit(t)},K(e,[{key:"inited",get:function(){return this._inited}},{key:"frameRate",get:function(){return this._frameRate},set:function(t){"number"!=typeof t&&(t=parseInt(t,10),Number.isNaN(t)&&(t=60)),this._frameRate=t,this.frameTime=1e3/t,this._setAnimFrame()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"totalTime",get:function(){return performance.now()-this._initTime}},{key:"frameStartTime",get:function(){return this._startTime}}]),e}(Ql));NM.EVENT_HIDE="game_on_hide",NM.EVENT_SHOW="game_on_show",NM.EVENT_LOW_MEMORY="game_on_low_memory",NM.EVENT_GAME_INITED="game_inited",NM.EVENT_ENGINE_INITED="engine_inited",NM.EVENT_RENDERER_INITED="renderer_inited",NM.EVENT_RESTART="game_on_restart",NM.RENDER_TYPE_CANVAS=0,NM.RENDER_TYPE_WEBGL=1,NM.RENDER_TYPE_OPENGL=2,NM.RENDER_TYPE_HEADLESS=3,NM.DEBUG_DT_THRESHOLD=1,c.Game=NM;var LM=t("game",c.game=new NM),FM=t("Director",function(t){function e(){var e;return(e=t.call(this)||this)._compScheduler=void 0,e._nodeActivator=void 0,e._invalid=void 0,e._paused=void 0,e._root=void 0,e._loadingScene=void 0,e._scene=void 0,e._totalFrames=void 0,e._scheduler=void 0,e._systems=void 0,e._invalid=!1,e._paused=!1,e._root=null,e._loadingScene="",e._scene=null,e._totalFrames=0,e._scheduler=new DM,e._compScheduler=new BD,e._nodeActivator=new JD,e._systems=[],LM.once(NM.EVENT_RENDERER_INITED,e._initOnRendererInitialized,it(e)),e}Q(e,t);var n=e.prototype;return n.calculateDeltaTime=function(){},n.end=function(){var t=this;this.once(e.EVENT_END_FRAME,(function(){t.purgeDirector()}))},n.pause=function(){this._paused||(this._paused=!0)},n.purgeDirector=function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),c.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),c.assetManager.releaseAll()},n.reset=function(){this.purgeDirector(),this.emit(e.EVENT_RESET),this.startAnimation()},n.runSceneImmediate=function(t,e,n){t instanceof QD&&(t=t.scene),O(t instanceof mD,1216),t._load();for(var i=Object.keys(LM._persistRootNodes).map((function(t){return LM._persistRootNodes[t]})),r=0;r<i.length;r++){var o=i[r];o.emit(c.Node.SCENE_CHANGED_FOR_PERSISTS,t.renderScene);var a=t.uuid===o._originalSceneId&&t.getChildByUuid(o.uuid);if(a){var s=a.getSiblingIndex();a._destroyImmediate(),t.insertChild(o,s)}else o.parent=t}var l=this._scene;c.isValid(l)&&l.destroy(),c.assetManager._releaseManager._autoRelease(l,t,LM._persistRootNodes),this._scene=null,ul._deferredDestroy(),e&&e(),this.emit(c.Director.EVENT_BEFORE_SCENE_LAUNCH,t),this._scene=t,t._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),n&&n(null,t),this.emit(c.Director.EVENT_AFTER_SCENE_LAUNCH,t)},n.runScene=function(t,e,n){var i=this;t instanceof QD&&(t=t.scene),O(t,1205),O(t instanceof mD,1216),t._load(),this.once(c.Director.EVENT_END_FRAME,(function(){i.runSceneImmediate(t,e,n)}))},n.loadScene=function(t,e,n){var i=this;if(this._loadingScene)return I(1208,t,this._loadingScene),!1;var r=c.assetManager.bundles.find((function(e){return!!e.getSceneInfo(t)}));return r?(this.emit(c.Director.EVENT_BEFORE_SCENE_LOADING,t),this._loadingScene=t,console.time("LoadScene "+t),r.loadScene(t,(function(r,o){console.timeEnd("LoadScene "+t),i._loadingScene="",r?(x(r),e&&e(r)):i.runSceneImmediate(o,n,e)})),!0):(D(1209,t),!1)},n.preloadScene=function(t,e,n){var i=c.assetManager.bundles.find((function(e){return!!e.getSceneInfo(t)}));if(i)i.preloadScene(t,null,e,n);else{var r='Can not preload the scene "'+t+'" because it is not in the build settings.';n&&n(new Error(r)),x("preloadScene: "+r)}},n.resume=function(){this._paused&&(this._paused=!1)},n.getScene=function(){return this._scene},n.getDeltaTime=function(){return LM.deltaTime},n.getTotalTime=function(){return LM.totalTime},n.getCurrentTime=function(){return LM.frameStartTime},n.getTotalFrames=function(){return this._totalFrames},n.isPaused=function(){return this._paused},n.getScheduler=function(){return this._scheduler},n.setScheduler=function(t){this._scheduler!==t&&(this.unregisterSystem(this._scheduler),this._scheduler=t,this.registerSystem(DM.ID,t,200))},n.registerSystem=function(t,e,n){e.id=t,e.priority=n,e.init(),this._systems.push(e),this._systems.sort(bM.sortByPriority)},n.unregisterSystem=function(t){te.fastRemove(this._systems,t),this._systems.sort(bM.sortByPriority)},n.getSystem=function(t){return this._systems.find((function(e){return e.id===t}))},n.getAnimationManager=function(){return this.getSystem(c.AnimationManager.ID)},n.startAnimation=function(){this._invalid=!1},n.stopAnimation=function(){this._invalid=!0},n.mainLoop=function(t){var e;e=LM._calculateDT(t),this.tick(e)},n.tick=function(t){if(!this._invalid){if(this.emit(e.EVENT_BEGIN_FRAME),oD._frameDispatchEvents(),!this._paused){this.emit(e.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(t);for(var n=0;n<this._systems.length;++n)this._systems[n].update(t);this._compScheduler.lateUpdatePhase(t),this.emit(e.EVENT_AFTER_UPDATE),ul._deferredDestroy();for(var i=0;i<this._systems.length;++i)this._systems[i].postUpdate(t)}this.emit(e.EVENT_BEFORE_DRAW),this._root.frameMove(t),this.emit(e.EVENT_AFTER_DRAW),GT.resetHasChangedFlags(),GT.clearNodeArray(),zl.update(t),this.emit(e.EVENT_END_FRAME),this._totalFrames++}},n._initOnRendererInitialized=function(){this._totalFrames=0,this._paused=!1,this.registerSystem(DM.ID,this._scheduler,200),this.emit(e.EVENT_INIT)},n._init=function(){return this._root=new OM(LM._gfxDevice),this._root.initialize({}).catch((function(t){return D(1217),Promise.reject(t)}))},K(e,[{key:"root",get:function(){return this._root}}]),e}(Ql));FM.EVENT_INIT="director_init",FM.EVENT_RESET="director_reset",FM.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",FM.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",FM.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",FM.EVENT_BEFORE_UPDATE="director_before_update",FM.EVENT_AFTER_UPDATE="director_after_update",FM.EVENT_BEFORE_DRAW="director_before_draw",FM.EVENT_AFTER_DRAW="director_after_draw",FM.EVENT_BEFORE_COMMIT="director_before_commit",FM.EVENT_BEFORE_PHYSICS="director_before_physics",FM.EVENT_AFTER_PHYSICS="director_after_physics",FM.EVENT_BEGIN_FRAME="director_begin_frame",FM.EVENT_END_FRAME="director_end_frame",FM.instance=void 0,c.Director=FM;var zM=t("director",FM.instance=c.director=new FM),GM={};z(GM,"vmath",[{name:"vec2",newName:"Vec2",target:ri,targetName:"math"},{name:"vec3",newName:"Vec3",target:ri,targetName:"math"},{name:"vec4",newName:"Vec4",target:ri,targetName:"math"},{name:"quat",newName:"Quat",target:ri,targetName:"math"},{name:"mat3",newName:"Mat3",target:ri,targetName:"math"},{name:"mat4",newName:"Mat4",target:ri,targetName:"math"},{name:"color4",newName:"Color",target:ri,targetName:"math"},{name:"rect",newName:"Rect",target:ri,targetName:"math"},{name:"approx",newName:"approx",target:ri,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:ri,targetName:"math"},{name:"equals",newName:"equals",target:ri,targetName:"math"},{name:"clamp",newName:"clamp",target:ri,targetName:"math"},{name:"clamp01",newName:"clamp01",target:ri,targetName:"math"},{name:"lerp",newName:"lerp",target:ri,targetName:"math"},{name:"toRadian",newName:"toRadian",target:ri,targetName:"math"},{name:"toDegree",newName:"toDegree",target:ri,targetName:"math"},{name:"random",newName:"random",target:ri,targetName:"math"},{name:"randomRange",newName:"randomRange",target:ri,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:ri,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:ri,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:ri,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:ri,targetName:"math"},{name:"repeat",newName:"repeat",target:ri,targetName:"math"},{name:"pingPong",newName:"pingPong",target:ri,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:ri,targetName:"math"}]),c.vmath=GM,z(DM.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:DM,targetName:"Scheduler"}]),z(DM,"Scheduler",[{name:"PRIORITY_SYSTEM",newName:"System.Priority.SCHEDULER",customGetter:function(){return bM.Priority.SCHEDULER}}]),G(DM,"Scheduler",[{name:"PRIORITY_NON_SYSTEM",suggest:"Use enum` System.Priority` instead"}]),z(ZS.prototype,"SubModel.prototype",[{name:"subMeshData",newName:"subMesh"}]),G(ZS.prototype,"SubModel.prototype",[{name:"getSubModel",suggest:"Use `subModels[i]` instead"},{name:"subModelNum",suggest:"Use `subModels.length` instead"}]),z(OM.prototype,"Root.prototype",[{name:"ui",newName:"batcher2D"}]),V(LM,"game",[{name:"collisionMatrix"},{name:"groupList"}]),V(FM.prototype,"director",[{name:"calculateDeltaTime"},{name:"getDeltaTime",suggest:"Use game.deltaTime instead"},{name:"getTotalTime",suggest:"Use game.totalTime instead"},{name:"getCurrentTime",suggest:"Use game.frameStartTime instead"}]),G(FM.prototype,"director",[{name:"setAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getRunningScene",suggest:"please use getScene instead"},{name:"setDepthTest",suggest:"please use camera API instead"},{name:"setClearColor",suggest:"please use camera API instead"},{name:"getWinSize",suggest:"please use view.getVisibleSize instead"},{name:"getWinSizeInPixels"},{name:"purgeCachedData",suggest:"please use assetManager.releaseAll instead"},{name:"convertToGL"},{name:"convertToUI"}]);var VM,UM={topLeft:c.v2(0,0),topRight:c.v2(0,0),top:c.v2(0,0),bottomLeft:c.v2(0,0),bottomRight:c.v2(0,0),bottom:c.v2(0,0),center:c.v2(0,0),left:c.v2(0,0),right:c.v2(0,0),width:0,height:0,init:function(t){var e=this.width=t.width,n=this.height=t.height,i=t.x,r=t.y,o=r+n,a=i+e;this.topLeft.x=i,this.topLeft.y=o,this.topRight.x=a,this.topRight.y=o,this.top.x=i+e/2,this.top.y=o,this.bottomLeft.x=i,this.bottomLeft.y=r,this.bottomRight.x=a,this.bottomRight.y=r,this.bottom.x=i+e/2,this.bottom.y=r,this.center.x=i+e/2,this.center.y=r+n/2,this.left.x=i,this.left.y=r+n/2,this.right.x=a,this.right.y=r+n/2}};c.visibleRect=UM;var kM=new Zn,HM=((VM={})[ce.ORIENTATION_AUTO]=Qu.AUTO,VM[ce.ORIENTATION_LANDSCAPE]=Qu.LANDSCAPE,VM[ce.ORIENTATION_PORTRAIT]=Qu.PORTRAIT,VM),jM=t("View",function(t){function e(){var e;(e=t.call(this)||this)._designResolutionSize=void 0,e._scaleX=void 0,e._scaleY=void 0,e._viewportRect=void 0,e._visibleRect=void 0,e._autoFullScreen=void 0,e._retinaEnabled=void 0,e._resizeCallback=void 0,e._resolutionPolicy=void 0,e._rpExactFit=void 0,e._rpShowAll=void 0,e._rpNoBorder=void 0,e._rpFixedHeight=void 0,e._rpFixedWidth=void 0;var n=WM,i=qM;return e._designResolutionSize=new Zn(0,0),e._scaleX=1,e._scaleY=1,e._viewportRect=new ti(0,0,0,0),e._visibleRect=new ti(0,0,0,0),e._autoFullScreen=!1,e._retinaEnabled=!1,e._resizeCallback=null,e._rpExactFit=new XM(n.EQUAL_TO_FRAME,i.EXACT_FIT),e._rpShowAll=new XM(n.EQUAL_TO_FRAME,i.SHOW_ALL),e._rpNoBorder=new XM(n.EQUAL_TO_FRAME,i.NO_BORDER),e._rpFixedHeight=new XM(n.EQUAL_TO_FRAME,i.FIXED_HEIGHT),e._rpFixedWidth=new XM(n.EQUAL_TO_FRAME,i.FIXED_WIDTH),e._resolutionPolicy=e._rpShowAll,e}Q(e,t);var n=e.prototype;return n.init=function(){var t=rh.windowSize,e=t.width,n=t.height;this._designResolutionSize.width=e,this._designResolutionSize.height=n,this._viewportRect.width=e,this._viewportRect.height=n,this._visibleRect.width=e,this._visibleRect.height=n,kM.width=this._visibleRect.width,kM.height=this._visibleRect.height,UM&&UM.init(this._visibleRect),nh.on("window-resize",this._updateAdaptResult,this),nh.on("orientation-change",this._updateAdaptResult,this),nh.on("fullscreen-change",this._updateAdaptResult,this)},n.resizeWithBrowserSize=function(t){nh.handleResizeEvent=t},n.setResizeCallback=function(t){"function"!=typeof t&&null!=t||(this._resizeCallback=t)},n.setOrientation=function(t){nh.orientation=HM[t]},n.adjustViewportMeta=function(){},n.enableRetina=function(t){this._retinaEnabled=!!t},n.isRetinaEnabled=function(){return this._retinaEnabled},n.enableAutoFullScreen=function(t){t!==this._autoFullScreen&&(this._autoFullScreen=t,t&&rh.requestFullScreen().catch((function(){})))},n.isAutoFullScreenEnabled=function(){return this._autoFullScreen},n.setCanvasSize=function(t,e){nh.resolutionScale=1;var n=nh.devicePixelRatio,i=new Zn(t*n,e*n);rh.windowSize=i},n.getCanvasSize=function(){return rh.windowSize},n.getFrameSize=function(){var t=nh.devicePixelRatio,e=rh.windowSize;return e.width/=t,e.height/=t,e},n.setFrameSize=function(t,e){var n=nh.devicePixelRatio;rh.windowSize=new Zn(t*n,e*n)},n.getVisibleSize=function(){return new Zn(this._visibleRect.width,this._visibleRect.height)},n.getVisibleSizeInPixel=function(){return new Zn(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)},n.getVisibleOrigin=function(){return new Wn(this._visibleRect.x,this._visibleRect.y)},n.getVisibleOriginInPixel=function(){return new Wn(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)},n.getResolutionPolicy=function(){return this._resolutionPolicy},n._updateResolutionPolicy=function(t){if(t instanceof XM)this._resolutionPolicy=t;else{var e=XM;t===e.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),t===e.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),t===e.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),t===e.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),t===e.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}},n.setResolutionPolicy=function(t){this._updateResolutionPolicy(t);var e=YM.getDesignResolutionSize();YM.setDesignResolutionSize(e.width,e.height,t)},n.setDesignResolutionSize=function(t,e,n){if(t>0&&e>0){this._updateResolutionPolicy(n);var i=this._resolutionPolicy;i&&i.preApply(this),this._designResolutionSize.width=t,this._designResolutionSize.height=e;var r=i.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var o=this._viewportRect,a=this._visibleRect,s=r.viewport;o.x=s.x,o.y=s.y,o.width=s.width,o.height=s.height,a.x=0,a.y=0,a.width=s.width/this._scaleX,a.height=s.height/this._scaleY}i.postApply(this),kM.width=this._visibleRect.width,kM.height=this._visibleRect.height,UM&&UM.init(this._visibleRect),this.emit("design-resolution-changed")}else D(2200)},n.getDesignResolutionSize=function(){return new Zn(this._designResolutionSize.width,this._designResolutionSize.height)},n.setRealPixelResolution=function(t,e,n){document.documentElement.style.width=t+"px",document.body.style.width=t+"px",document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(t,e,n)},n.getViewportRect=function(){return this._viewportRect},n.getScaleX=function(){return this._scaleX},n.getScaleY=function(){return this._scaleY},n.getDevicePixelRatio=function(){return nh.devicePixelRatio},n.convertToLocationInView=function(t,e,n,i){void 0===i&&(i=new Wn);var r=nh.devicePixelRatio*(t-n.left),o=nh.devicePixelRatio*(n.top+n.height-e);return nh.isFrameRotated?(i.x=rh.windowSize.width-o,i.y=r):(i.x=r,i.y=o),i},n._convertToUISpace=function(t){var e=this._viewportRect;t.x=(t.x-e.x)/this._scaleX,t.y=(t.y-e.y)/this._scaleY},n._updateAdaptResult=function(){var t;c.director.root.resize(rh.windowSize.width,rh.windowSize.height);var e=this._designResolutionSize.width,n=this._designResolutionSize.height;e>0&&this.setDesignResolutionSize(e,n,this._resolutionPolicy),this.emit("canvas-resize"),null===(t=this._resizeCallback)||void 0===t||t.call(this)},e}(Ql));jM.instance=void 0;var WM=function(){function t(){this.name="ContainerStrategy"}var e=t.prototype;return e.preApply=function(){},e.apply=function(){},e.postApply=function(){},e._setupCanvas=function(){var t=LM.canvas;if(t){var e=rh.windowSize;t.width=e.width,t.height=e.height}},t}();WM.EQUAL_TO_FRAME=void 0,WM.PROPORTION_TO_FRAME=void 0;var qM=function(){function t(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}var e=t.prototype;return e.preApply=function(){},e.apply=function(){return{scale:[1,1]}},e.postApply=function(){},e._buildResult=function(t,e,n,i,r,o){Math.abs(t-n)<2&&(n=t),Math.abs(e-i)<2&&(i=e);var a=new ti(Math.round((t-n)/2),Math.round((e-i)/2),n,i);return this._result.scale=[r,o],this._result.viewport=a,this._result},t}();qM.EXACT_FIT=void 0,qM.SHOW_ALL=void 0,qM.NO_BORDER=void 0,qM.FIXED_HEIGHT=void 0,qM.FIXED_WIDTH=void 0,function(){var t=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="EqualToFrame",e}return Q(e,t),e.prototype.apply=function(){nh.isProportionalToFrame=!1,this._setupCanvas()},e}(WM),e=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="ProportionalToFrame",e}return Q(e,t),e.prototype.apply=function(){nh.isProportionalToFrame=!0,this._setupCanvas()},e}(WM);WM.EQUAL_TO_FRAME=new t,WM.PROPORTION_TO_FRAME=new e;var n=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="ExactFit",e}return Q(e,t),e.prototype.apply=function(t,e){var n=rh.windowSize,i=n.width,r=n.height,o=i/e.width,a=r/e.height;return this._buildResult(i,r,i,r,o,a)},e}(qM),i=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="ShowAll",e}return Q(e,t),e.prototype.apply=function(t,e){var n,i,r=rh.windowSize,o=r.width,a=r.height,s=e.width,c=e.height,l=o/s,u=a/c,h=0;return l<u?(n=o,i=c*(h=l)):(n=s*(h=u),i=a),this._buildResult(o,a,n,i,h,h)},e}(qM),r=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="NoBorder",e}return Q(e,t),e.prototype.apply=function(t,e){var n,i,r,o=rh.windowSize,a=o.width,s=o.height,c=e.width,l=e.height,u=a/c,h=s/l;return u<h?(i=c*(n=h),r=s):(i=a,r=l*(n=u)),this._buildResult(a,s,i,r,n,n)},e}(qM),o=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="FixedHeight",e}return Q(e,t),e.prototype.apply=function(t,e){var n=rh.windowSize,i=n.width,r=n.height,o=r/e.height,a=i,s=r;return this._buildResult(i,r,a,s,o,o)},e}(qM),a=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).name="FixedWidth",e}return Q(e,t),e.prototype.apply=function(t,e){var n=rh.windowSize,i=n.width,r=n.height,o=i/e.width,a=i,s=r;return this._buildResult(i,r,a,s,o,o)},e}(qM);qM.EXACT_FIT=new n,qM.SHOW_ALL=new i,qM.NO_BORDER=new r,qM.FIXED_HEIGHT=new o,qM.FIXED_WIDTH=new a}();var XM=t("ResolutionPolicy",function(){function t(t,e){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(t),this.setContentStrategy(e)}var e=t.prototype;return e.preApply=function(t){this._contentStrategy.preApply(t)},e.apply=function(t,e){return this._containerStrategy.apply(t,e),this._contentStrategy.apply(t,e)},e.postApply=function(t){this._contentStrategy.postApply(t)},e.setContainerStrategy=function(t){t instanceof WM&&(this._containerStrategy=t)},e.setContentStrategy=function(t){t instanceof qM&&(this._contentStrategy=t)},K(t,[{key:"canvasSize",get:function(){return rh.windowSize}}]),t}());XM.EXACT_FIT=0,XM.NO_BORDER=1,XM.SHOW_ALL=2,XM.FIXED_HEIGHT=3,XM.FIXED_WIDTH=4,XM.UNKNOWN=5,XM.ContainerStrategy=WM,XM.ContentStrategy=qM,c.ResolutionPolicy=XM;var YM=t("view",jM.instance=c.view=new jM);c.winSize=kM,G(jM.prototype,"View.prototype",[{name:"isAntiAliasEnabled",suggest:"The API of Texture2d have been largely modified, no alternative"},{name:"enableAntiAlias",suggest:"The API of Texture2d have been largely modified, no alternative"}]),V(jM.prototype,"View.prototype",[{name:"adjustViewportMeta"},{name:"enableAutoFullScreen",suggest:"use screen.requestFullScreen() instead."},{name:"isAutoFullScreenEnabled"},{name:"setCanvasSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getCanvasSize",suggest:"please use screen.windowSize instead."},{name:"getFrameSize",suggest:"getting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"setFrameSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getDevicePixelRatio",suggest:"use screen.devicePixelRatio instead."},{name:"convertToLocationInView"},{name:"enableRetina"},{name:"isRetinaEnabled"}]),V(c,"cc",[{name:"winSize",suggest:"please use view.getVisibleSize() instead."}]),V(oh,"sys",[{name:"capabilities",suggest:"please use sys.hasFeature() method instead."}]),z(oh,"sys",["UNKNOWN","ENGLISH","CHINESE","FRENCH","ITALIAN","GERMAN","SPANISH","DUTCH","RUSSIAN","KOREAN","JAPANESE","HUNGARIAN","PORTUGUESE","ARABIC","NORWEGIAN","POLISH","TURKISH","UKRAINIAN","ROMANIAN","BULGARIAN"].map((function(t){return{name:"LANGUAGE_"+t,newName:t,target:oh.Language,targetName:"sys.Language"}}))),z(oh,"sys",["UNKNOWN","IOS","ANDROID","WINDOWS","LINUX","OSX"].map((function(t){return{name:"OS_"+t,newName:t,target:oh.OS,targetName:"sys.OS"}}))),z(oh,"sys",["UNKNOWN","WECHAT","ANDROID","IE","EDGE","QQ","MOBILE_QQ","UC","UCBS","BAIDU_APP","BAIDU","MAXTHON","OPERA","OUPENG","MIUI","FIREFOX","SAFARI","CHROME","LIEBAO","QZONE","SOUGOU","HUAWEI"].map((function(t){return{name:"BROWSER_TYPE_"+t,newName:t,target:oh.BrowserType,targetName:"sys.BrowserType"}}))),z(oh,"sys",[{name:"BROWSER_TYPE_360",newName:"BROWSER_360",target:oh.BrowserType,targetName:"sys.BrowserType"}]),z(oh,"sys",["UNKNOWN","EDITOR_PAGE","EDITOR_CORE","MOBILE_BROWSER","DESKTOP_BROWSER","WIN32","MACOS","IOS","ANDROID","OHOS","WECHAT_GAME","BAIDU_MINI_GAME","XIAOMI_QUICK_GAME","ALIPAY_MINI_GAME","BYTEDANCE_MINI_GAME","OPPO_MINI_GAME","VIVO_MINI_GAME","HUAWEI_QUICK_GAME","COCOSPLAY","LINKSURE_MINI_GAME","QTT_MINI_GAME"].map((function(t){return{name:t,target:oh.Platform,targetName:"sys.Platform"}}))),z(oh,"sys",[{name:"IPHONE",newName:"IOS",target:oh.Platform,targetName:"sys.Platform"},{name:"IPAD",newName:"IOS",target:oh.Platform,targetName:"sys.Platform"}]),G(oh,"sys",["LINUX","BLACKBERRY","NACL","EMSCRIPTEN","TIZEN","WINRT","WP8","QQ_PLAY","FB_PLAYABLE_ADS"].map((function(t){return{name:t}}))),z(oh,"sys",[{name:"windowPixelResolution",target:rh,targetName:"screen",newName:"windowSize"}]),V(rh,"screen",[{name:"autoFullScreen",suggest:"please use screen.requestFullScreen() instead."},{name:"disableAutoFullScreen"}]);var KM=function(){function t(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new fl,this.scenes=new fl,this.paths=new fl}var e=t.prototype;return e.init=function(t){var e=this;!function(t){var e=t.uuids,n=t.paths,i=t.types,r=t.deps,o=t.paths=Object.create(null);if(!1===t.debug){for(var a=0,s=e.length;a<s;a++)e[a]=Rl(e[a]);for(var c in n){var l=n[c],u=l[1];l[1]=i[u]}}else{for(var h=Object.create(null),_=0,f=e.length;_<f;_++){var p=e[_];e[_]=h[p]=Rl(p)}e=h}for(var d in n){var m=n[d];o[e[d]]=m}var v=t.scenes;for(var g in v){var y=v[g];v[g]=e[y]}var x=t.packs;for(var S in x)for(var C=x[S],A=0;A<C.length;++A)C[A]=e[C[A]];var b=t.versions;if(b)for(var T in b)for(var E=b[T],w=0;w<E.length;w+=2){var P=E[w];E[w]=e[P]||P}var I=t.redirect;if(I)for(var R=0;R<I.length;R+=2)I[R]=e[I[R]],I[R+1]=r[I[R+1]];if(t.extensionMap){var D=function(n){if(!Object.prototype.hasOwnProperty.call(t.extensionMap,n))return"continue";t.extensionMap[n].forEach((function(i,r){t.extensionMap[n][r]=e[i]||i}))};for(var B in t.extensionMap)D(B)}}(t),this.importBase=t.importBase||"",this.nativeBase=t.nativeBase||"",this.base=t.base||"",this.name=t.name||"",this.deps=t.deps||[],this._initUuid(t.uuids),this._initPath(t.paths),this._initScene(t.scenes),this._initPackage(t.packs),this._initVersion(t.versions),this._initRedirect(t.redirect);var n=function(n){if(!Object.prototype.hasOwnProperty.call(t.extensionMap,n))return"continue";t.extensionMap[n].forEach((function(t){var i=e.assetInfos.get(t);i&&(i.extension=n)}))};for(var i in t.extensionMap)n(i)},e.getInfoWithPath=function(t,e){if(!t)return null;t=Nl(t);var n=this.paths.get(t);if(n){if(!e)return n[0];for(var i=0,r=n.length;i<r;i++){var o=n[i];if(ee.isChildClassOf(o.ctor,e))return o}}return null},e.getDirWithPath=function(t,e,n){"/"===(t=Nl(t))[t.length-1]&&(t=t.slice(0,-1));var i=n||[];return this.paths.forEach((function(n,r){if(r.startsWith(t)&&function(t,e){return!(t.length>e.length)||47===t.charCodeAt(e.length)}(r,t)||!t)for(var o=0,a=n.length;o<a;o++){var s=n[o];e&&!ee.isChildClassOf(s.ctor,e)||i.push(s)}})),i},e.getAssetInfo=function(t){return this.assetInfos.get(t)||null},e.getSceneInfo=function(t){return t.endsWith(".scene")||(t+=".scene"),"/"===t[0]||t.startsWith("db://")||(t="/"+t),this.scenes.find((function(e,n){return n.endsWith(t)}))},e.destroy=function(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()},e._initUuid=function(t){if(t){this.assetInfos.clear();for(var e=0,n=t.length;e<n;e++){var i=t[e];this.assetInfos.add(i,{uuid:i})}}},e._initPath=function(t){if(t){var e=this.paths;for(var n in e.clear(),t){var i=t[n],r=i[0],o=i[1],a=3===i.length,s=this.assetInfos.get(n);s.path=r,s.ctor=ee._getClassById(o),e.has(r)?a?e.get(r).push(s):e.get(r).unshift(s):e.add(r,[s])}}},e._initScene=function(t){if(t){var e=this.scenes;e.clear();var n=this.assetInfos;for(var i in t){var r=t[i],o=n.get(r);o.url=i,e.add(i,o)}}},e._initPackage=function(t){if(t){var e=this.assetInfos;for(var n in t){var i=t[n],r={uuid:n,packedUuids:i,ext:".json"};e.add(n,r);for(var o=0,a=i.length;o<a;o++){var s=i[o],c=e.get(s),l=c.packs;l?1===a?l.unshift(r):l.push(r):c.packs=[r]}}}},e._initVersion=function(t){if(t){var e=this.assetInfos,n=t.import;if(n)for(var i=0,r=n.length;i<r;i+=2){var o=n[i];e.get(o).ver=n[i+1]}if(n=t.native)for(var a=0,s=n.length;a<s;a+=2){var c=n[a];e.get(c).nativeVer=n[a+1]}}},e._initRedirect=function(t){if(t)for(var e=this.assetInfos,n=0,i=t.length;n<i;n+=2){var r=t[n];e.get(r).redirect=t[n+1]}},t}();function JM(t,e){t._uuid&&e.push(t._uuid)}function QM(t,e){for(var n=Object.getOwnPropertyNames(t),i=0;i<n.length;i++){var r=n[i];if("node"!==r&&"__eventTargets"!==r){var o=t[r];if("object"==typeof o&&o)if(Array.isArray(o))for(var a=0;a<o.length;a++){var s=o[a];s instanceof Pu&&JM(s,e)}else if(o.constructor&&o.constructor!==Object)o instanceof Pu&&JM(o,e);else for(var c=Object.getOwnPropertyNames(o),l=0;l<c.length;l++){var u=o[c[l]];u instanceof Pu&&JM(u,e)}}}}function ZM(t,e){for(var n=0;n<t._components.length;n++)QM(t._components[n],e);for(var i=0;i<t._children.length;i++)ZM(t._children[i],e)}function $M(t,e,n,i){n.push(t._uuid);for(var r=ev.getDeps(t._uuid),o=0,a=r.length;o<a;o++){var s=ml.get(r[o]);if(s){var c=s._uuid;c in e?e[c]+=i:e[c]=s.refCount+i,n.includes(c)||$M(s,e,n,i)}}}var tO=[],eO=new(function(){function t(){this._persistNodeDeps=new fl,this._toDelete=new fl,this._eventListener=!1}var e=t.prototype;return e.init=function(){this._persistNodeDeps.clear(),this._toDelete.clear()},e._addPersistNodeRef=function(t){var e=[];ZM(t,e);for(var n=0,i=e.length;n<i;n++){var r=ml.get(e[n]);r&&r.addRef()}this._persistNodeDeps.add(t.uuid,e)},e._removePersistNodeRef=function(t){if(this._persistNodeDeps.has(t.uuid)){for(var e=this._persistNodeDeps.get(t.uuid),n=0,i=e.length;n<i;n++){var r=ml.get(e[n]);r&&r.decRef()}this._persistNodeDeps.remove(t.uuid)}},e._autoRelease=function(t,e,n){if(t){for(var i=ev.getDeps(t.uuid),r=0,o=i.length;r<o;r++){var a=ml.get(i[r]);a&&a.decRef(t.autoReleaseAssets)}var s=ev._depends.get(t.uuid);if(s&&s.persistDeps)for(var c=s.persistDeps,l=0,u=c.length;l<u;l++){var h=ml.get(c[l]);h&&h.decRef(t.autoReleaseAssets)}t.uuid!==e.uuid&&ev.remove(t.uuid)}var _=ev._depends.get(e.uuid);for(var f in _&&(_.persistDeps=[]),n){for(var p,d,m=n[f],v=this._persistNodeDeps.get(m.uuid),g=ot(v);!(d=g()).done;){var y=d.value,x=ml.get(y);x&&x.addRef()}_&&(p=_.persistDeps).push.apply(p,v)}},e.tryRelease=function(t,e){void 0===e&&(e=!1),t instanceof Pu&&(e?this._free(t,e):(this._toDelete.add(t._uuid,t),this._eventListener||(this._eventListener=!0,ge(this._freeAssets.bind(this)))))},e._freeAssets=function(){var t=this;this._eventListener=!1,this._toDelete.forEach((function(e){t._free(e)})),this._toDelete.clear()},e._free=function(t,e){void 0===e&&(e=!1);var n=t._uuid;if(this._toDelete.remove(n),_l(t,!0)&&!(!e&&t.refCount>0&&function(t){var e=Object.create(null);if(e[t._uuid]=t.refCount,$M(t,e,tO,-1),tO.length=0,0!==e[t._uuid])return e[t._uuid];for(var n in e)0!==e[n]&&$M(ml.get(n),e,tO,1);return tO.length=0,e[t._uuid]}(t)>0)){ml.remove(n);for(var i=ev.getDeps(n),r=0,o=i.length;r<o;r++){var a=ml.get(i[r]);a&&(a.decRef(!1),this._free(a,!1))}t.destroy(),ev.remove(n)}},t}()),nO=null;function iO(t,e){for(var n=0,i=t.input.length;n<i;n++){var r=t.input[n];e&&!r.isNative&&r.content instanceof Pu&&r.content.decRef(!1),r.recycle()}t.input=null}function rO(t,e){return e?/\?/.test(t)?t+"&_t="+Date.now():t+"?_t="+Date.now():t}function oO(t,e,n,i,r){void 0===r&&(r=0),t(r,(function(o,a){r++,!o||r>e?i&&i(o,a):setTimeout((function(){oO(t,e,n,i,r)}),n)}))}function aO(t,e,n,i,r){try{for(var o=ev.parse(t,e),a=0,s=o.deps.length;a<s;a++){var c=o.deps[a];c in n||(n[c]=!0,i.push({uuid:c,bundle:r&&r.name}))}o.nativeDep&&(r&&(o.nativeDep.bundle=r.name),i.push(J({},o.nativeDep)))}catch(t){x(t.message,t.stack)}}function sO(t,e,n){e&&(n=void 0!==n?n:c.assetManager.cacheAsset,Ol(e)||!n||e.isDefault||ml.add(t,e))}function cO(t,e,n){var i=0,r=[],o=t.length;0===o&&n&&n(r);for(var a=function(t){t&&r.push(t),++i===o&&n&&n(r)},s=0;s<o;s++)e(t[s],a)}function lO(t,e,n){var i=t,r=e,o=n;if(void 0===n){var a="function"==typeof t;e?(o=e,a||(r=null)):void 0===e&&a&&(o=t,i=null,r=null),void 0!==e&&a&&(r=t,i=null)}return{options:i||Object.create(null),onProgress:r,onComplete:o}}function uO(t,e,n){var i=t,r=e,o=n;if(void 0===n){var a=ee.isChildClassOf(t,Pu);e?(o=e,a&&(r=null)):void 0!==e||a||(o=t,r=null,i=null),void 0===e||a||(r=t,i=null)}return{type:i,onProgress:r||nO,onComplete:o}}function hO(t,e,n,i){if(void 0===i&&(i={}),!n[e]||i[e])return!1;i[e]=!0;var r=!1,o=ev.getDeps(e);if(o)for(var a=0,s=o.length;a<s;a++){var c=o[a];if(c===t||hO(t,c,n,i)){r=!0;break}}return r}function _O(t){return function(e,n){if(t){var i=[];Array.isArray(n)?n.forEach((function(t){return t instanceof Pu&&i.push(t.addRef())})):n instanceof Pu&&i.push(n.addRef()),ge((function(){i.forEach((function(t){return t.decRef(!1)})),t(e,n)}))}}}var fO=function(){function t(){this._config=new KM}var e=t.prototype;return e.getInfoWithPath=function(t,e){return this._config.getInfoWithPath(t,e)},e.getDirWithPath=function(t,e,n){return this._config.getDirWithPath(t,e,n)},e.getAssetInfo=function(t){return this._config.getAssetInfo(t)},e.getSceneInfo=function(t){return this._config.getSceneInfo(t)},e.init=function(t){this._config.init(t),yl.add(t.name,this)},e.load=function(t,e,n,i){var r=uO(e,n,i),o=r.type,a=r.onProgress,s=r.onComplete,l={__requestType__:dl.PATH,type:o,bundle:this.name,__outputAsArray__:Array.isArray(t)};c.assetManager.loadAny(t,l,a,s)},e.preload=function(t,e,n,i){var r=uO(e,n,i),o=r.type,a=r.onProgress,s=r.onComplete;c.assetManager.preloadAny(t,{__requestType__:dl.PATH,type:o,bundle:this.name},a,s)},e.loadDir=function(t,e,n,i){var r=uO(e,n,i),o=r.type,a=r.onProgress,s=r.onComplete;c.assetManager.loadAny(t,{__requestType__:dl.DIR,type:o,bundle:this.name,__outputAsArray__:!0},a,s)},e.preloadDir=function(t,e,n,i){var r=uO(e,n,i),o=r.type,a=r.onProgress,s=r.onComplete;c.assetManager.preloadAny(t,{__requestType__:dl.DIR,type:o,bundle:this.name},a,s)},e.loadScene=function(t,e,n,i){var r=lO(e,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"scene",o.bundle=this.name,c.assetManager.loadAny({scene:t},o,a,(function(t,e){if(t)x(t.message,t.stack);else if(e instanceof QD&&e.scene){var n=e.scene;n._id=e._uuid,n.name=e.name}else t=new Error("The asset "+e._uuid+" is not a scene");s&&s(t,e)}))},e.preloadScene=function(t,e,n,i){var r=lO(e,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.bundle=this.name,c.assetManager.preloadAny({scene:t},o,a,(function(e){e&&D(1210,t,e.message),s&&s(e)}))},e.get=function(t,e){var n=this.getInfoWithPath(t,e);return n&&ml.get(n.uuid)||null},e.release=function(t,e){var n=this.get(t,e);n&&eO.tryRelease(n,!0)},e.releaseUnusedAssets=function(){var t=this;ml.forEach((function(e){var n=t.getAssetInfo(e._uuid);n&&!n.redirect&&eO.tryRelease(e)}))},e.releaseAll=function(){var t=this;ml.forEach((function(e){var n=t.getAssetInfo(e._uuid);n&&!n.redirect&&eO.tryRelease(e,!0)}))},e._destroy=function(){this._config.destroy()},K(t,[{key:"config",get:function(){return this._config}},{key:"name",get:function(){return this._config.name}},{key:"deps",get:function(){return this._config.deps}},{key:"base",get:function(){return this._config.base}}]),t}(),pO=t("resources",new fO);function dO(t,e,n){var i=new Image;function r(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(null,i)}function o(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(new Error(N(4930,t)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.addEventListener("load",r),i.addEventListener("error",o),i.src=t,i}function mO(t,e,n,i){var r=new XMLHttpRequest,o="download failed: "+t+", status: ";if(r.open("GET",t,!0),void 0!==e.xhrResponseType&&(r.responseType=e.xhrResponseType),void 0!==e.xhrWithCredentials&&(r.withCredentials=e.xhrWithCredentials),void 0!==e.xhrMimeType&&r.overrideMimeType&&r.overrideMimeType(e.xhrMimeType),void 0!==e.xhrTimeout&&(r.timeout=e.xhrTimeout),e.xhrHeader)for(var a in e.xhrHeader)r.setRequestHeader(a,e.xhrHeader[a]);return r.onload=function(){200===r.status||0===r.status?i&&i(null,r.response):i&&i(new Error(""+o+r.status+"(no response)"))},n&&(r.onprogress=function(t){t.lengthComputable&&n(t.loaded,t.total)}),r.onerror=function(){i&&i(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){i&&i(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){i&&i(new Error(""+o+r.status+"(abort)"))},r.send(null),r}c.resources=pO;var vO={};function gO(t,e,n){if(vO[t])return n&&n(null),null;var i=document.createElement("script");function r(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),vO[t]=!0,n&&n(null)}function o(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),n&&n(new Error(N(4928,t)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.async=e.scriptAsyncLoading||!1,i.src=t,i.addEventListener("load",r,!1),i.addEventListener("error",o,!1),document.body.appendChild(i),i}var yO=/^(?:\w+:\/\/|\.+\/).+/,xO=function(t,e,n){(oh.hasFeature(oh.Feature.IMAGE_BITMAP)&&c.assetManager.allowImageBitmap?SO:dO)(t,e,n)},SO=function(t,e,n){e.xhrResponseType="blob",mO(t,e,e.onFileProgress,n)},CO=function(t,e,n){e.xhrResponseType="json",mO(t,e,e.onFileProgress,n)},AO=function(t,e,n){e.xhrResponseType="arraybuffer",mO(t,e,e.onFileProgress,n)},bO=function(t,e,n){CO(t,e,(function(e,i){if(e)n(e);else{var r=lh(i);Promise.all(r.chunks.map((function(n){return new Promise((function(i,r){AO(""+vu(t)+n,{},(function(t,n){e?r(e):i(new Uint8Array(n))}))}))}))).then((function(t){var e=new ch(r.document,t);n(null,e)})).catch((function(t){n(t)}))}}))},TO=function(t,e,n){AO(t,e,(function(t,e){if(t)n(t);else try{var i=uh(new Uint8Array(e));n(null,i)}catch(t){n(t)}}))},EO=function(t,e,n){e.xhrResponseType="text",mO(t,e,e.onFileProgress,n)},wO=function(t,e,n){var i=gu(t),r=t;yO.test(r)||(r=-1!==PO.remoteBundles.indexOf(i)?PO.remoteServerAddress+"remote/"+i:"assets/"+i);var o=e.version||PO.bundleVers[i],a=0,s=null,c=null;CO(r+"/config."+(o?o+".":"")+"json",e,(function(t,e){c=t,(s=e)&&(s.base=r+"/"),2==++a&&n(c,s)})),gO(r+"/index."+(o?o+".":"")+"js",e,(function(t){c=t,2==++a&&n(t,s)}))},PO=new(function(){function t(){this.maxConcurrency=6,this.maxRequestsPerFrame=6,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=dO,this.downloadDomAudio=null,this.downloadFile=mO,this.downloadScript=gO,this._downloaders={".png":xO,".jpg":xO,".bmp":xO,".jpeg":xO,".gif":xO,".ico":xO,".tiff":xO,".webp":xO,".image":xO,".pvr":AO,".pkm":AO,".astc":AO,".txt":EO,".xml":EO,".vsh":EO,".fsh":EO,".atlas":EO,".tmx":EO,".tsx":EO,".json":CO,".ExportJson":CO,".plist":EO,".ccon":bO,".cconb":TO,".fnt":EO,".binary":AO,".bin":AO,".dbbin":AO,".skel":AO,".js":gO,bundle:wO,default:EO},this._downloading=new fl,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}var e=t.prototype;return e.init=function(t,e,n){void 0===t&&(t=""),void 0===e&&(e={}),void 0===n&&(n=[]),this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=t,this.bundleVers=e,this.remoteBundles=n},e.register=function(t,e){"object"==typeof t?Ft(this._downloaders,t):this._downloaders[t]=e},e.download=function(t,e,n,i,r){var o=this,a=vl.get(t);if(a)r(null,a);else{var s=this._downloading.get(t);if(s){s.push(r);var c=this._queue.find((function(e){return e.id===t}));if(!c)return;var l=i.priority||0;c.priority<l&&(c.priority=l,this._queueDirty=!0)}else{var u=void 0!==i.maxRetryCount?i.maxRetryCount:this.maxRetryCount,h=void 0!==i.maxConcurrency?i.maxConcurrency:this.maxConcurrency,_=void 0!==i.maxRequestsPerFrame?i.maxRequestsPerFrame:this.maxRequestsPerFrame,f=this._downloaders[n]||this._downloaders.default;oO((function(n,a){if(0===n&&o._downloading.add(t,[r]),o.limited){o._updateTime();var s=function(t,e){o._totalNum--,o._handleQueueInNextFrame(h,_),a(t,e)};o._totalNum<h&&o._totalNumThisPeriod<_?(f(rO(e,o.appendTimeStamp),i,s),o._totalNum++,o._totalNumThisPeriod++):(o._queue.push({id:t,priority:i.priority||0,url:e,options:i,done:s,handler:f}),o._queueDirty=!0,o._totalNum<h&&o._handleQueueInNextFrame(h,_))}else f(rO(e,o.appendTimeStamp),i,a)}),u,this.retryInterval,(function(e,n){e||vl.add(t,n);for(var i=o._downloading.remove(t),r=0,a=i.length;r<a;r++)i[r](e,n)}))}}},e.loadSubpackage=function(t,e){c.assetManager.loadBundle(t,null,e)},e._updateTime=function(){var t=performance.now(),e=c.game.deltaTime,n=e>this._maxInterval?this._maxInterval:e;t-this._lastDate>1e3*n&&(this._totalNumThisPeriod=0,this._lastDate=t)},e._handleQueue=function(t,e){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<t&&this._totalNumThisPeriod<e;){this._queueDirty&&(this._queue.sort((function(t,e){return t.priority-e.priority})),this._queueDirty=!1);var n=this._queue.pop();if(!n)break;this._totalNum++,this._totalNumThisPeriod++,n.handler(rO(n.url,this.appendTimeStamp),n.options,n.done)}this._handleQueueInNextFrame(t,e)},e._handleQueueInNextFrame=function(t,e){!this._checkNextPeriod&&this._queue.length>0&&(ge(this._handleQueue.bind(this),t,e),this._checkNextPeriod=!0)},K(t,[{key:"remoteServerAddress",get:function(){return this._remoteServerAddress}}]),t}());function IO(t,e,n,i){var r=null,o=null;try{(r=new Km)._nativeUrl=t,r._nativeAsset=e}catch(t){o=t}i(o,r)}function RO(t,e,n,i){var r=new iB;r.json=e,i(null,r)}function DO(t,e,n,i){var r=new nB;r.text=e,i(null,r)}function BO(t,e,n,i){var r=new PE;r._nativeUrl=t,r._nativeAsset=e,i(null,r)}function MO(t,e,n,i){var r=new Pu;r._nativeUrl=t,r._nativeAsset=e,i(null,r)}function OO(t,n,i,r){var o=yl.get(n.name);o||(o=n.name===Al.RESOURCES?pO:new fO,n.base=n.base||t+"/",o.init(n)),e.import("virtual:///prerequisite-imports/"+o.name).then((function(){r(null,o)})).catch(r)}var NO=new(function(){function t(){this._creating=new fl,this._producers={".png":IO,".jpg":IO,".bmp":IO,".jpeg":IO,".gif":IO,".ico":IO,".tiff":IO,".webp":IO,".image":IO,".pvr":IO,".pkm":IO,".txt":DO,".xml":DO,".vsh":DO,".fsh":DO,".atlas":DO,".tmx":DO,".tsx":DO,".fnt":DO,".json":RO,".ExportJson":RO,".binary":BO,".bin":BO,".dbbin":BO,".skel":BO,bundle:OO,default:MO}}var e=t.prototype;return e.register=function(t,e){"object"==typeof t?ee.mixin(this._producers,t):this._producers[t]=e},e.create=function(t,e,n,i,r){var o=this,a=this._producers[n]||this._producers.default,s=ml.get(t);if(i.reloadAsset||!s){var c=this._creating.get(t);c?c.push(r):(this._creating.add(t,[r]),a(t,e,i,(function(e,n){!e&&n instanceof Pu&&(n._uuid=t,sO(t,n,i.cacheAsset));for(var r=o._creating.remove(t),a=0,s=r.length;a<s;a++)r[a](e,n)})))}else r(null,s)},t}()),LO=new(function(){function t(){this._loading=new fl,this._unpackers={".json":this.unpackJson}}var e=t.prototype;return e.unpackJson=function(t,e,n,i){var r=ee.createMap(!0),o=null;if(Array.isArray(e)){(e=function(t){if(t[0]<1)throw new Error(N(5304,t[0]));Rh(t,!0,void 0,Bh.reportMissingClass),Dh(t);for(var e=new Mh(t[0]),n=t[1],i=t[2],r=t[3],o=t[4],a=t[5],s=0;s<a.length;++s)a[s].unshift(e,n,i,r,o);return a}(e)).length!==t.length&&D(4915);for(var a=0;a<t.length;a++)r[t[a]+"@import"]=e[a]}else{var s=ee._getClassId(gv),c=ee._getClassId(Km);if(e.type===s&&e.data){var l=e.data;l.length!==t.length&&D(4915);for(var u=0;u<t.length;u++)r[t[u]+"@import"]=Oh(s,{base:l[u][0],mipmaps:l[u][1]})}else if(e.type===c&&e.data){var h=e.data;h.length!==t.length&&D(4915);for(var _=0;_<t.length;_++)r[t[_]+"@import"]=h[_]}else o=new Error("unmatched type pack!"),r=null}i(o,r)},e.init=function(){this._loading.clear()},e.register=function(t,e){"object"==typeof t?ee.mixin(this._unpackers,t):this._unpackers[t]=e},e.unpack=function(t,e,n,i,r){e?(0,this._unpackers[n])(t,e,i,r):r(new Error("package data is wrong!"))},e.load=function(t,e,n){var i=this;if(!t.isNative&&t.info&&t.info.packs)if(vl.has(t.id))n(null,vl.get(t.id));else{var r=t.info.packs,o=r.find((function(t){return i._loading.has(t.uuid)}));if(o)this._loading.get(o.uuid).push({onComplete:n,id:t.id});else{o=r[0],this._loading.add(o.uuid,[{onComplete:n,id:t.id}]);var a=Ll(o.uuid,{ext:o.ext,bundle:t.config.name});PO.download(o.uuid,a,o.ext,t.options,(function(e,n){vl.remove(o.uuid),e&&x(e.message,e.stack),i.unpack(o.packedUuids,n,o.ext,t.options,(function(t,n){if(!t)for(var r in n)vl.add(r,n[r]);for(var a=i._loading.remove(o.uuid),s=0,c=a.length;s<c;s++){var l=a[s];if(e||t)l.onComplete(e||t);else{var u=n[l.id];u?l.onComplete(null,u):l.onComplete(new Error("can not retrieve data from package"))}}}))}))}}else PO.download(t.id,t.url,t.ext,t.options,n)},t}());function FO(t,e){var n=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},n=!0);var i=t.options,r=t.progress,o=[],a=r.total,s=i.__exclude__=i.__exclude__||Object.create(null);t.output=[],cO(t.input,(function(i,l){if(!i.isNative&&ml.has(i.uuid)){var u=ml.get(i.uuid);return i.content=u.addRef(),t.output.push(i),r.canInvoke&&t.dispatch("progress",++r.finish,r.total,i),void l()}LO.load(i,t.options,(function(u,h){u?t.isFinish||(!c.assetManager.force||n?(x(u.message,u.stack),r.canInvoke=!1,e(u)):(t.output.push(i),r.canInvoke&&t.dispatch("progress",++r.finish,r.total,i))):t.isFinish||(i.file=h,t.output.push(i),i.isNative||(s[i.uuid]=!0,aO(i.uuid,h,s,o,i.config),r.total=a+o.length),r.canInvoke&&t.dispatch("progress",++r.finish,r.total,i)),l()}))}),(function(){if(t.isFinish)return iO(t,!0),void t.dispatch("error");if(o.length>0){var a=Tl.create({input:o,progress:r,options:i,onProgress:t.onProgress,onError:Tl.prototype.recycle,onComplete:function(i){var r;i||((r=t.output).push.apply(r,a.output),a.recycle()),n&&zO(t),e(i)}});Sl.async(a)}else n&&zO(t),e()}))}function zO(t){for(var e=t.output,n=0,i=e.length;n<i;n++)e[n].content&&e[n].content.decRef(!1)}var GO=new(function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.parse=function(t){var e=this._parseXML(t).documentElement;if("plist"!==e.tagName)return I(5100),{};for(var n=null,i=0,r=e.childNodes.length;i<r&&1!==(n=e.childNodes[i]).nodeType;i++);return this._parseNode(n)},n._parseNode=function(t){var e=null,n=t.tagName;if("dict"===n)e=this._parseDict(t);else if("array"===n)e=this._parseArray(t);else if("string"===n)if(1===t.childNodes.length)e=t.firstChild.nodeValue;else{e="";for(var i=0;i<t.childNodes.length;i++)e+=t.childNodes[i].nodeValue}else"false"===n?e=!1:"true"===n?e=!0:"real"===n?e=parseFloat(t.firstChild.nodeValue):"integer"===n&&(e=parseInt(t.firstChild.nodeValue,10));return e},n._parseArray=function(t){for(var e=[],n=0,i=t.childNodes.length;n<i;n++){var r=t.childNodes[n];1===r.nodeType&&e.push(this._parseNode(r))}return e},n._parseDict=function(t){for(var e={},n="",i=0,r=t.childNodes.length;i<r;i++){var o=t.childNodes[i];1===o.nodeType&&("key"===o.tagName?n=o.firstChild.nodeValue:e[n]=this._parseNode(o))}return e},e}(function(){function t(){this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}var e=t.prototype;return e.parse=function(t){return this._parseXML(t)},e._parseXML=function(t){if(this._parser)return this._parser.parseFromString(t,"text/xml");throw new Error("Dom parser is not supported in this platform!")},t}()));function VO(t,e){return t[e]<<8|t[e+1]}var UO=new(function(){function t(){this._parsing=new fl,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".plist":this.parsePlist,import:this.parseImport,".ccon":this.parseImport,".cconb":this.parseImport}}var e=t.prototype;return e.parseImage=function(t,e,n){t instanceof HTMLImageElement?n(null,t):createImageBitmap(t,{premultiplyAlpha:"none"}).then((function(t){n(null,t)}),(function(t){n(t,null)}))},e.parsePVRTex=function(t,e,n){var i=null,r=null;try{var o=t instanceof ArrayBuffer?t:t.buffer,a=new Int32Array(o,0,13);if(55727696===a[0]){var s=a[7],c=a[6],l=a[12]+52;r={_data:new Uint8Array(o,l),_compressed:!0,width:s,height:c,format:0}}else{if(559044176!==a[11])throw new Error("Invalid magic number in PVR header");var u=a[0],h=a[1],_=a[2];r={_data:new Uint8Array(o,u),_compressed:!0,width:_,height:h,format:0}}}catch(t){i=t}n(i,r)},e.parsePKMTex=function(t,e,n){var i=null,r=null;try{var o=t instanceof ArrayBuffer?t:t.buffer,a=new Uint8Array(o),s=VO(a,6);if(0!==s&&1!==s&&3!==s)throw new Error("Invalid magic number in ETC header");var c=VO(a,12),l=VO(a,14);VO(a,8),VO(a,10),r={_data:new Uint8Array(o,16),_compressed:!0,width:c,height:l,format:0}}catch(t){i=t}n(i,r)},e.parseASTCTex=function(t,e,n){var i=null,r=null;try{var o=t instanceof ArrayBuffer?t:t.buffer,a=new Uint8Array(o);if(1554098963!==a[0]+(a[1]<<8)+(a[2]<<16)+(a[3]<<24))throw new Error("Invalid magic number in ASTC header");var s=a[4],c=a[5],l=a[6];if((s<3||s>6||c<3||c>6||l<3||l>6)&&(s<4||7===s||9===s||11===s||s>12||c<4||7===c||9===c||11===c||c>12||1!==l))throw new Error("Invalid block number in ASTC header");var u=function(t,e){return 4===t?Em.RGBA_ASTC_4x4:5===t?4===e?Em.RGBA_ASTC_5x4:Em.RGBA_ASTC_5x5:6===t?5===e?Em.RGBA_ASTC_6x5:Em.RGBA_ASTC_6x6:8===t?5===e?Em.RGBA_ASTC_8x5:6===e?Em.RGBA_ASTC_8x6:Em.RGBA_ASTC_8x8:10===t?5===e?Em.RGBA_ASTC_10x5:6===e?Em.RGBA_ASTC_10x6:8===e?Em.RGBA_ASTC_10x8:Em.RGBA_ASTC_10x10:10===e?Em.RGBA_ASTC_12x10:Em.RGBA_ASTC_12x12}(s,c),h=a[7]+(a[8]<<8)+(a[9]<<16),_=a[10]+(a[11]<<8)+(a[12]<<16);a[13],a[14],a[15],r={_data:new Uint8Array(o,16),_compressed:!0,width:h,height:_,format:u}}catch(t){i=t}n(i,r)},e.parsePlist=function(t,e,n){var i=null,r=GO.parse(t);r||(i=new Error("parse failed")),n(i,r)},e.parseImport=function(t,e,n){if(t){var i=null,r=null;try{i=$m(t,e)}catch(t){r=t}n(r,i)}else n(new Error("The json file of asset "+e.__uuid__+" is empty or missing"))},e.init=function(){this._parsing.clear()},e.register=function(t,e){"object"==typeof t?Ft(this._parsers,t):this._parsers[t]=e},e.parse=function(t,e,n,i,r){var o=this,a=gl.get(t);if(a)r(null,a);else{var s=this._parsing.get(t);if(s)s.push(r);else{var c=this._parsers[n];c?(this._parsing.add(t,[r]),c(e,i,(function(e,n){e?vl.remove(t):Ol(n)||gl.add(t,n);for(var i=o._parsing.remove(t),r=0,a=i.length;r<a;r++)i[r](e,n)}))):r(null,e)}}},t}());function kO(t,e){var n=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},n=!0);var i=t.options,r=t.progress;i.__exclude__=i.__exclude__||Object.create(null),t.output=[],cO(t.input,(function(o,a){var s=Tl.create({input:o,onProgress:t.onProgress,options:i,progress:r,onComplete:function(i,l){i&&!t.isFinish&&(!c.assetManager.force||n?(x(i.message,i.stack),r.canInvoke=!1,e(i)):r.canInvoke&&t.dispatch("progress",++r.finish,r.total,o)),t.output.push(l),s.recycle(),a(null)}});HO.async(s)}),(function(){if(i.__exclude__=null,t.isFinish)return iO(t,!0),void t.dispatch("error");!function(t){var e=t.source;if(t.options.__outputAsArray__||1!==e.length)for(var n=t.output=[],i=0,r=e.length;i<r;i++)n.push(e[i].content);else t.output=e[0].content}(t),iO(t,!0),e()}))}var HO=new pl("loadOneAsset",[function(t,e){var n=t.output=t.input,i=n.options,r=n.isNative,o=n.uuid,a=n.file,s=i.reloadAsset;a||!s&&!r&&ml.has(o)?e():LO.load(n,t.options,(function(t,i){n.file=i,e(t)}))},function(t,e){var n=t.output=t.input,i=t.progress,r=t.options.__exclude__,o=n.id,a=n.file,s=n.options;if(n.isNative)UO.parse(o,a,n.ext,s,(function(r,a){r?e(r):(n.content=a,i.canInvoke&&t.dispatch("progress",++i.finish,i.total,n),vl.remove(o),gl.remove(o),e())}));else{var c=n.uuid;if(c in r){var l=r[c],u=l.finish,h=l.content,_=l.err,f=l.callbacks;i.canInvoke&&t.dispatch("progress",++i.finish,i.total,n),u||hO(c,c,r)?(h&&h.addRef(),n.content=h,e(_)):f.push({done:e,item:n})}else if(!s.reloadAsset&&ml.has(c)){var p=ml.get(c);n.content=p.addRef(),i.canInvoke&&t.dispatch("progress",++i.finish,i.total,n),e()}else s.__uuid__=c,UO.parse(o,a,"import",s,(function(n,i){n?e(n):function(t,e,n){var i=t.input,r=t.progress,o=i,a=o.uuid,s=o.id,c=o.options,l=o.config,u=c.cacheAsset,h=[];e.addRef&&e.addRef(),aO(a,e,Object.create(null),h,l),r.canInvoke&&t.dispatch("progress",++r.finish,r.total+=h.length,i);var _=t.options.__exclude__[a]={content:e,finish:!1,callbacks:[{done:n,item:i}]},f=Tl.create({input:h,options:t.options,onProgress:t.onProgress,onError:Tl.prototype.recycle,progress:r,onComplete:function(t){if(e.decRef&&e.decRef(!1),_.finish=!0,_.err=t,!t){for(var n,i=Array.isArray(f.output)?f.output:[f.output],r=Object.create(null),o=ot(i);!(n=o()).done;){var c=n.value;c&&(r[c instanceof Pu?c._uuid+"@import":a+"@native"]=c)}!function(t,e,n){var i=Jm.get(e);if(i){for(var r=0,o=i.length;r<o;r++){var a=i[r],s=n[a.uuid+"@import"];if(s)a.owner[a.prop]=s.addRef();else{if(x("The asset "+a.uuid+" is missing!"),a.type&&a.type!==Pu){var c=new a.type;c.initDefault(a.uuid),a.owner[a.prop]=c}!0}}Jm.delete(e)}Qm.has(e)&&(n[t+"@native"]?e._nativeAsset=n[t+"@native"]:(!0,console.error("the native asset of "+t+" is missing!")),Qm.delete(e))}(a,e,r);try{"function"!=typeof e.onLoaded||Zm.has(e)||Qm.has(e)||(e.onLoaded(),Zm.add(e))}catch(t){x("The asset "+a+" is invalid for some reason, detail message: "+t.message+", stack: "+t.stack)}vl.remove(s),gl.remove(s),sO(a,e,u),f.recycle()}for(var l=_.callbacks,h=0,p=l.length;h<p;h++){var d=l[h];e.addRef&&e.addRef(),d.item.content=e,d.done(t)}l.length=0}});xl.async(f)}(t,i,e)}))}}]);function jO(t,e){var n=t.options,i=Object.create(null),r=Object.create(null);for(var o in n)switch(o){case dl.PATH:case dl.UUID:case dl.DIR:case dl.SCENE:case dl.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":i[o]=n[o];break;case"__exclude__":case"__outputAsArray__":r[o]=n[o];break;default:i[o]=n[o],r[o]=n[o]}t.options=r;var a=Tl.create({input:t.input,options:i}),s=null;try{t.output=t.source=Cl.sync(a)}catch(t){s=t;for(var c=0,l=a.output.length;c<l;c++)a.output[c].recycle()}a.recycle(),e(s)}var WO=function(){function t(){this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}return t.create=function(){return 0!==t._deadPool.length?t._deadPool.pop():new t},t.prototype.recycle=function(){t._deadPool.length!==t.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),t._deadPool.push(this))},K(t,[{key:"id",get:function(){return this._id||(this._id=this.uuid+"@"+(this.isNative?"native":"import")),this._id}}]),t}();WO.MAX_DEAD_NUM=500,WO._deadPool=[];var qO=[];function XO(t){var e=t.options,n=Array.isArray(t.input)?t.input:[t.input];t.output=[];for(var i=function(i){var r,o=n[i],a=WO.create(),s=null,c=null;if("string"==typeof o&&((o=Object.create(null))[e.__requestType__||dl.UUID]=n[i]),"object"==typeof o)for(var l in Lt(o,e),o.preset&&Lt(o,bl[o.preset]),o){switch(l){case dl.UUID:if("break"===function(){var t,e=a.uuid=Rl(o.uuid);if(!o.bundle){var n=yl.find((function(t){return!!t.getAssetInfo(e)}));o.bundle=n&&n.name}if(yl.has(o.bundle)){if(s=yl.get(o.bundle).config,(c=s.getAssetInfo(e))&&c.redirect){if(!yl.has(c.redirect))throw new Error("Please load bundle "+c.redirect+" first");s=yl.get(c.redirect).config,c=s.getAssetInfo(e)}a.config=s,a.info=c}return a.ext=o.ext||(null===(t=c)||void 0===t?void 0:t.extension)||".json","break"}())break;case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case dl.DIR:if(yl.has(o.bundle)){yl.get(o.bundle).config.getDirWithPath(o.dir,o.type,qO);for(var u,h=ot(qO);!(u=h()).done;){var _=u.value;n.push({uuid:_.uuid,__isNative__:!1,ext:_.extension||".json",bundle:o.bundle})}qO.length=0}a.recycle(),a=null;break;case dl.PATH:if(yl.has(o.bundle)){if(s=yl.get(o.bundle).config,(c=s.getInfoWithPath(o.path,o.type))&&c.redirect){if(!yl.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=yl.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+o.bundle+" doesn't contain "+o.path);a.config=s,a.uuid=c.uuid,a.info=c}a.ext=o.ext||(null===(r=c)||void 0===r?void 0:r.extension)||".json";break;case dl.SCENE:if(!o.bundle){var f=yl.find((function(t){return!!t.getSceneInfo(o.scene)}));o.bundle=f&&f.name}if(yl.has(o.bundle)){if(s=yl.get(o.bundle).config,(c=s.getSceneInfo(o.scene))&&c.redirect){if(!yl.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=yl.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+s.name+" doesn't contain scene "+o.scene);a.config=s,a.uuid=c.uuid,a.info=c}break;case"__isNative__":a.isNative=o.__isNative__;break;case dl.URL:a.url=o.url,a.uuid=o.uuid||o.url,a.ext=o.ext||mu(o.url),a.isNative=void 0===o.__isNative__||o.__isNative__;break;default:a.options[l]=o[l]}if(!a)break}if(!a)return"continue";if(t.output.push(a),!a.uuid&&!a.url)throw new Error("Can not parse this input:"+JSON.stringify(o))},r=0;r<n.length;r++)i(r);return null}function YO(t){for(var e=t.output=t.input,n=0;n<e.length;n++){var i=e[n];if(!i.url){var r,o,a=i.config;o=i.isNative?a&&a.nativeBase?a.base+a.nativeBase:c.assetManager.generalNativeBase:a&&a.importBase?a.base+a.importBase:c.assetManager.generalImportBase;var s=i.uuid,l="";i.info&&(l=i.isNative?i.info.nativeVer?"."+i.info.nativeVer:"":i.info.ver?"."+i.info.ver:""),r=".ttf"===i.ext?o+"/"+s.slice(0,2)+"/"+s+l+"/"+i.options.__nativeName__:o+"/"+s.slice(0,2)+"/"+s+l+i.ext,i.url=r}}return null}var KO=t("AssetManager",function(){function t(){this.pipeline=xl.append(jO).append(kO),this.fetchPipeline=Sl.append(jO).append(FO),this.transformPipeline=Cl.append(XO).append(YO),this.bundles=yl,this.assets=ml,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=ev,this.force=!1,this.allowImageBitmap=!oh.isMobile,this.utils=Fl,this.downloader=PO,this.parser=UO,this.packManager=LO,this.cacheAsset=!0,this.cacheManager=null,this.presets=bl,this.factory=NO,this.preprocessPipe=jO,this.fetchPipe=FO,this.loadPipe=kO,this.references=null,this._releaseManager=eO,this._files=vl,this._parsed=gl,this._parsePipeline=null}var e=t.prototype;return e.init=function(t){void 0===t&&(t={}),this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(t.server,t.bundleVers,t.remoteBundles),this.parser.init(),this.dependUtil.init();var e=t.importBase||"";e&&e.endsWith("/")&&(e=e.substr(0,e.length-1));var n=t.nativeBase||"";n&&n.endsWith("/")&&(n=n.substr(0,n.length-1)),this.generalImportBase=e,this.generalNativeBase=n},e.getBundle=function(t){return yl.get(t)||null},e.removeBundle=function(t){t._destroy(),yl.remove(t.name)},e.loadAny=function(t,e,n,i){var r=lO(e,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"default",t=Array.isArray(t)?t.slice():t;var c=Tl.create({input:t,onProgress:a,onComplete:_O(s),options:o});xl.async(c)},e.preloadAny=function(t,e,n,i){var r=lO(e,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"preload",t=Array.isArray(t)?t.slice():t;var c=Tl.create({input:t,onProgress:a,onComplete:_O(s),options:o});Sl.async(c)},e.loadRemote=function(t,e,n){var i=lO(e,void 0,n),r=i.options,o=i.onComplete;r.reloadAsset||!this.assets.has(t)?(r.__isNative__=!0,r.preset=r.preset||"remote",this.loadAny({url:t},r,null,(function(e,n){e?(x(e.message,e.stack),o&&o(e,n)):NO.create(t,n,r.ext||mu(t),r,(function(t,e){o&&o(t,e)}))}))):_O(o)(null,this.assets.get(t))},e.loadBundle=function(t,e,n){var i=lO(e,void 0,n),r=i.options,o=i.onComplete,a=gu(t);this.bundles.has(a)?_O(o)(null,this.getBundle(a)):(r.preset=r.preset||"bundle",r.ext="bundle",r.__isNative__=!0,this.loadAny({url:t},r,null,(function(e,n){e?(x(e.message,e.stack),o&&o(e,n)):NO.create(t,n,"bundle",r,(function(t,e){o&&o(t,e)}))})))},e.releaseAsset=function(t){eO.tryRelease(t,!0)},e.releaseUnusedAssets=function(){ml.forEach((function(t){eO.tryRelease(t)}))},e.releaseAll=function(){ml.forEach((function(t){eO.tryRelease(t,!0)}))},e.loadWithJson=function(){throw new Error("Only valid in Editor")},K(t,[{key:"main",get:function(){return yl.get(Al.MAIN)||null}},{key:"resources",get:function(){return yl.get(Al.RESOURCES)||null}}]),t}());KO.Pipeline=pl,KO.Task=Tl,KO.Cache=fl,KO.RequestItem=WO,KO.Bundle=fO,KO.BuiltinBundleName=Al;var JO=t("assetManager",c.assetManager=new KO);c.AssetManager=KO;var QO=[".png",".jpg",".bmp",".jpeg",".gif",".ico",".tiff",".webp",".image",".pvr",".pkm",".astc"],ZO=[".mp3",".ogg",".wav",".m4a"];function $O(){return!0}var tN={transformURL:function(t){var e=Bl(t);if(!e)return t;var n=yl.find((function(t){return!!t.getAssetInfo(e)}));if(!n)return t;var i,r=n.getAssetInfo(e);if(!(i=t.startsWith(n.base+n.config.nativeBase)?r.nativeVer||"":r.ver||"")||-1!==t.indexOf(i))return t;var o=!1;if(".ttf"===mu(t)&&(o=!0),o){var a=yu(t),s=gu(t);t=a+"."+i+"/"+s}else t=t.replace(/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,})/,(function(t){return t+"."+i}));return t}},eN=t("CCLoader",function(){function t(){this._autoReleaseSetting=Object.create(null),this._parseLoadResArgs=uO}var e=t.prototype;return e.load=function(t,e,n){void 0===n&&void 0!==e&&(n=e,e=null);for(var i=Array.isArray(t)?t:[t],r=0;r<i.length;r++){var o=i[r];"string"==typeof o?i[r]={url:o,__isNative__:!0}:(o.type&&(o.ext="."+o.type,o.type=void 0),o.url&&(o.__isNative__=!0))}var a=[],s=[];JO.loadAny(i,null,(function(t,n,i){i.content&&(QO.includes(i.ext)?a.push(i.content):ZO.includes(i.ext)&&s.push(i.content)),e&&e(t,n,i)}),(function(t,e){var r=null;if(!t){e=Array.isArray(e)?e:[e];for(var o=function(t){var n=e[t];if(!(n instanceof Pu)){var r=n,o=i[t].url;a.includes(r)?NO.create(o,n,".png",{},(function(n,i){r=e[t]=i})):s.includes(r)&&NO.create(o,n,".mp3",{},(function(n,i){r=e[t]=i})),ml.add(o,r)}},c=0;c<e.length;c++)o(c);if(e.length>1){var l=Object.create(null);e.forEach((function(t){l[t._uuid]=t})),r={isCompleted:$O,_map:l}}else r=e[0]}n&&n(t,r)}))},e.getXMLHttpRequest=function(){return new XMLHttpRequest},e.getItem=function(t){return JO.assets.has(t)?{content:JO.assets.get(t)}:null},e.loadRes=function(t,e,n,i){var r=this._parseLoadResArgs(e,n,i),o=r.type,a=r.onProgress,s=r.onComplete,c=mu(t);c&&!pO.getInfoWithPath(t,o)&&(t=t.slice(0,-c.length)),pO.load(t,o,a,s)},e.loadResArray=function(t,e,n,i){var r=this._parseLoadResArgs(e,n,i),o=r.type,a=r.onProgress,s=r.onComplete;t.forEach((function(e,n){var i=mu(e);i&&!pO.getInfoWithPath(e,o)&&(t[n]=e.slice(0,-i.length))})),pO.load(t,o,a,s)},e.loadResDir=function(t,e,n,i){var r=this._parseLoadResArgs(e,n,i),o=r.type,a=r.onProgress,s=r.onComplete;pO.loadDir(t,o,a,(function(e,n){var i=[];e||(i=pO.getDirWithPath(t,o).map((function(t){return t.path}))),s&&s(e,n,i)}))},e.getRes=function(t,e){return ml.has(t)?ml.get(t):pO.get(t,e)},e.getResCount=function(){return ml.count},e.getDependsRecursively=function(t){if(!t)return[];var e="string"==typeof t?t:t._uuid;return ev.getDepsRecursively(e).concat([e])},e.addDownloadHandlers=function(t){var e=Object.create(null),n=function(n){var i=t[n];e["."+n]=function(t,e,n){i({url:t},n)}};for(var i in t)n(i);PO.register(e)},e.addLoadHandlers=function(t){var e=Object.create(null),n=function(n){var i=t[n];e["."+n]=function(t,e,n){i({content:t},n)}};for(var i in t)n(i);UO.register(e)},e.release=function(t){if(Array.isArray(t))for(var e=0;e<t.length;e++){var n=t[e];"string"==typeof n&&(n=ml.get(n)),JO.releaseAsset(n)}else t&&("string"==typeof t&&(t=ml.get(t)),JO.releaseAsset(t))},e.releaseAsset=function(t){JO.releaseAsset(t)},e.releaseRes=function(t,e){pO.release(t,e)},e.releaseAll=function(){JO.releaseAll(),ml.clear()},e.removeItem=function(t){return!!ml.remove(t)},e.setAutoRelease=function(t,e){"object"==typeof t&&(t=t._uuid),this._autoReleaseSetting[t]=!!e},e.setAutoReleaseRecursively=function(t,e){"object"==typeof t&&(t=t._uuid),e=!!e,this._autoReleaseSetting[t]=e;for(var n=ev.getDepsRecursively(t),i=0;i<n.length;i++)this._autoReleaseSetting[n[i]]=e},e.isAutoRelease=function(t){return"object"==typeof t&&(t=t._uuid),!!this._autoReleaseSetting[t]},K(t,[{key:"onProgress",set:function(t){nO=t}},{key:"_cache",get:function(){if(ml instanceof fl)return ml._map;var t={};return ml.forEach((function(e,n){t[n]=e})),t}},{key:"md5Pipe",get:function(){return tN}},{key:"downloader",get:function(){return PO}},{key:"loader",get:function(){return JO.parser}}]),t}()),nN=t("loader",new eN),iN=t("AssetLibrary",{init:function(t){t.importBase=t.libraryPath,t.nativeBase=t.rawAssetsBase,JO.init(t),t.rawAssets&&pO.init({base:"",deps:[],scenes:{},redirect:[],debug:!0,packs:{},types:[],versions:{import:[],native:[]},name:Al.RESOURCES,importBase:t.importBase,nativeBase:t.nativeBase,paths:t.rawAssets.assets,uuids:Object.keys(t.rawAssets.assets),extensionMap:{}})},loadAsset:function(t,e){JO.loadAny(t,e)}}),rN=t("url",{});z(rN,"url",[{name:"normalize",target:JO.utils,targetName:"assetManager.utils",newName:"normalize"},{name:"raw",targetName:"Asset.prototype",newName:"nativeUrl",customFunction:function(t){return t.startsWith("resources/")?Ll({path:xu(t.substr(10)),bundle:Al.RESOURCES,__isNative__:!0,ext:mu(t)}):""}}]),G(iN,"AssetLibrary",[{name:"getLibUrlNoExt",suggest:"AssetLibrary.getLibUrlNoExt was removed, if you want to transform url, please use cc.assetManager.utils.getUrlWithUuid instead"},{name:"queryAssetInfo",suggest:"AssetLibrary.queryAssetInfo was removed"}]),G(nN,"loader",[{name:"releaseResDir",suggest:"loader.releaseResDir was removed, please use assetManager.releaseAsset instead"},{name:"flowInDeps",suggest:"loader.flowInDeps was removed"},{name:"assetLoader",suggest:"cc.loader.assetLoader was removed, assetLoader and md5Pipe were merged into cc.assetManager.transformPipeline"}]),z(c,"cc",[{name:"loader",newName:"assetManager",logTimes:1,customGetter:function(){return nN}},{name:"AssetLibrary",newName:"assetManager",logTimes:1,customGetter:function(){return iN}},{name:"Pipeline",target:KO,targetName:"AssetManager",newName:"Pipeline",logTimes:1},{name:"url",targetName:"assetManager",newName:"utils",logTimes:1,customGetter:function(){return rN}}]),G(c,"cc",[{name:"LoadingItems",suggest:N(1400,"cc.LoadingItems","cc.AssetManager.Task")}]),z(ce,"macro",[{name:"DOWNLOAD_MAX_CONCURRENT",target:PO,targetName:"assetManager.downloader",newName:"maxConcurrency"}]),z(zM,"director",[{name:"_getSceneUuid",targetName:"assetManager.main",newName:"getSceneInfo",customFunction:function(t){var e;return JO.main?null===(e=JO.main.getSceneInfo(t))||void 0===e?void 0:e.uuid:""}}]),z(LM,"game",[{name:"_sceneInfos",targetName:"assetManager.main",newName:"getSceneInfo",customGetter:function(){var t=[];return JO.main&&JO.main.config.scenes.forEach((function(e){t.push(e)})),t}}]);var oN,aN,sN,cN,lN,uN,hN,_N,fN,pN,dN,mN,vN,gN,yN=eO._autoRelease;eO._autoRelease=function(t,e,n){yN.call(eO,t,e,n);for(var i=nN._autoReleaseSetting,r=Object.keys(i),o=0;o<r.length;o++){var a=r[o];if(!0===i[a]){var s=ml.get(a);s&&eO.tryRelease(s)}}};var xN,SN,CN,AN,bN,TN,EN,wN,PN,IN,RN,DN,BN,MN,ON,NN,LN,FN,zN,GN,VN,UN,kN,HN,jN,WN,qN,XN,YN,KN,JN,QN,ZN,$N,tL,eL,nL,iL,rL,oL,aL,sL,cL,lL,uL,hL,_L,fL,pL,dL,mL,vL,gL,yL,xL,SL,CL,AL,bL,TL,EL,wL,PL,IL,RL,DL,BL,ML=t("EventHandler",(oN=hc("cc.ClickEvent"),aN=Wc(c.Node),sN=Bc(),cN=Bc(),lN=Bc(),uN=Bc(),oN((gN=function(){function t(){at(this,"target",fN,this),at(this,"component",pN,this),at(this,"_componentId",dN,this),at(this,"handler",mN,this),at(this,"customEventData",vN,this)}t.emitEvents=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(var o=0,a=e.length;o<a;o++){var s=e[o];s instanceof t&&s.emit(i)}};var e=t.prototype;return e.emit=function(t){var e=this.target;if(c.isValid(e)){this._genCompIdIfNeeded();var n=c.js._getClassById(this._componentId),i=e.getComponent(n);if(c.isValid(i)){var r=i[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(t=t.slice()).push(this.customEventData),r.apply(i,t))}}},e._compName2Id=function(t){var e=c.js.getClassByName(t);return c.js._getClassId(e)},e._compId2Name=function(t){var e=c.js._getClassById(t);return c.js.getClassName(e)},e._genCompIdIfNeeded=function(){this._componentId||(this._componentName=this.component,this.component="")},K(t,[{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(t){this._componentId=this._compName2Id(t)}}]),t}(),fN=st((_N=gN).prototype,"target",[vc,aN,vc,sN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pN=st(_N.prototype,"component",[vc,Pc,cN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),dN=st(_N.prototype,"_componentId",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),mN=st(_N.prototype,"handler",[vc,Pc,lN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),vN=st(_N.prototype,"customEventData",[vc,Pc,uN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),hN=_N))||hN));c.Component.EventHandler=ML;var OL,NL,LL,FL,zL,GL,VL,UL,kL,HL,jL,WL=new En,qL=ie(Zv),XL=ie(Qv),YL=ie($v),KL=ie(eg),JL=ie(tg),QL=ie({SKYBOX:ug|Wi.DEPTH_STENCIL,SOLID_COLOR:Wi.ALL,DEPTH_ONLY:Wi.DEPTH_STENCIL,DONT_CLEAR:Wi.NONE}),ZL=(xN=hc("cc.Camera"),SN=wc(),CN=Ac(),AN=zc(),bN=Bc(),TN=Wc(Rp.BitMask),EN=zc(),wN=Bc(),PN=Wc(QL),IN=zc(),RN=Bc(),DN=zc(),BN=Bc(),MN=zc(),ON=Bc(),NN=zc(),LN=Bc(),FN=Wc(qL),zN=zc(),GN=Bc(),VN=Wc(XL),UN=zc(),kN=Bc(),HN=zc(),jN=Bc(),WN=zc(),qN=Bc(),XN=zc(),YN=Bc(),KN=zc(),JN=Bc(),QN=Wc(YL),ZN=zc(),$N=Bc(),tL=Wc(KL),eL=zc(),nL=Bc(),iL=Wc(JL),rL=zc(),oL=Bc(),aL=zc(),sL=Bc(),cL=Wc(OS),lL=zc(),uL=Bc(),OL=xN(hL=SN(hL=CN(hL=Cc((BL=DL=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_projection",fL,it(e)),at(e,"_priority",pL,it(e)),at(e,"_fov",dL,it(e)),at(e,"_fovAxis",mL,it(e)),at(e,"_orthoHeight",vL,it(e)),at(e,"_near",gL,it(e)),at(e,"_far",yL,it(e)),at(e,"_color",xL,it(e)),at(e,"_depth",SL,it(e)),at(e,"_stencil",CL,it(e)),at(e,"_clearFlags",AL,it(e)),at(e,"_rect",bL,it(e)),at(e,"_aperture",TL,it(e)),at(e,"_shutter",EL,it(e)),at(e,"_iso",wL,it(e)),at(e,"_screenScale",PL,it(e)),at(e,"_visibility",IL,it(e)),at(e,"_targetTexture",RL,it(e)),e._camera=null,e._inEditorMode=!1,e._flows=void 0,e}Q(e,t);var n=e.prototype;return n.onLoad=function(){this._createCamera()},n.onEnable=function(){this.node.hasChangedFlags|=Zg.POSITION,this._camera&&this._attachToScene()},n.onDisable=function(){this._camera&&this._detachFromScene()},n.onDestroy=function(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")},n.screenPointToRay=function(t,e,n){return n||(n=Qo.create()),this._camera&&this._camera.screenPointToRay(n,t,e),n},n.worldToScreen=function(t,e){return e||(e=new En),this._camera&&this._camera.worldToScreen(e,t),e},n.screenToWorld=function(t,e){return e||(e=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(e,t),e},n.convertToUINode=function(t,e,n){if(n||(n=new En),!this._camera)return n;this.worldToScreen(t,WL);var i=e.getComponent("cc.UITransform"),r=YM.getVisibleSize(),o=WL.x-.5*this._camera.width,a=WL.y-.5*this._camera.height;return WL.x=o/c.view.getScaleX()+.5*r.width,WL.y=a/c.view.getScaleY()+.5*r.height,i&&i.convertToNodeSpaceAR(WL,n),n},n._createCamera=function(){this._camera||(this._camera=c.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?c.director.root&&c.director.root.mainWindow:c.director.root&&c.director.root.tempWindow,priority:this._priority}),this._camera.setViewportInOrientedSpace(this._rect),this._camera.fovAxis=this._fovAxis,this._camera.fov=cn(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()},n._attachToScene=function(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))},n._detachFromScene=function(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)},n._checkTargetTextureEvent=function(t){var e=this;t&&t.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(t){e._camera&&e._camera.setFixedSize(t.width,t.height)}),this)},n._updateTargetTexture=function(){if(this._camera&&this._targetTexture){var t=this._targetTexture.window;this._camera.changeTargetWindow(t),this._camera.setFixedSize(t.width,t.height)}},K(e,[{key:"camera",get:function(){return this._camera}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority=t,this._camera&&(this._camera.priority=t)}},{key:"visibility",get:function(){return this._visibility},set:function(t){this._visibility=t,this._camera&&(this._camera.visibility=t)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(t){this._clearFlags=t,this._camera&&(this._camera.clearFlag=t)}},{key:"clearColor",get:function(){return this._color},set:function(t){this._color.set(t),this._camera&&(this._camera.clearColor=this._color)}},{key:"clearDepth",get:function(){return this._depth},set:function(t){this._depth=t,this._camera&&(this._camera.clearDepth=t)}},{key:"clearStencil",get:function(){return this._stencil},set:function(t){this._stencil=t,this._camera&&(this._camera.clearStencil=t)}},{key:"projection",get:function(){return this._projection},set:function(t){this._projection=t,this._camera&&(this._camera.projectionType=t)}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(t){t!==this._fovAxis&&(this._fovAxis=t,this._camera&&(this._camera.fovAxis=t,t===Qv.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}},{key:"fov",get:function(){return this._fov},set:function(t){this._fov=t,this._camera&&(this._camera.fov=cn(t))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(t){this._orthoHeight=t,this._camera&&(this._camera.orthoHeight=t)}},{key:"near",get:function(){return this._near},set:function(t){this._near=t,this._camera&&(this._camera.nearClip=t)}},{key:"far",get:function(){return this._far},set:function(t){this._far=t,this._camera&&(this._camera.farClip=t)}},{key:"aperture",get:function(){return this._aperture},set:function(t){this._aperture=t,this._camera&&(this._camera.aperture=t)}},{key:"shutter",get:function(){return this._shutter},set:function(t){this._shutter=t,this._camera&&(this._camera.shutter=t)}},{key:"iso",get:function(){return this._iso},set:function(t){this._iso=t,this._camera&&(this._camera.iso=t)}},{key:"rect",get:function(){return this._rect},set:function(t){this._rect=t,this._camera&&this._camera.setViewportInOrientedSpace(t)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(t){if(this._targetTexture!==t){var n=this._targetTexture;this._targetTexture=t,this._checkTargetTextureEvent(n),this._updateTargetTexture(),!t&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0),this.node.emit(e.TARGET_TEXTURE_CHANGE,this)}}},{key:"screenScale",get:function(){return this._screenScale},set:function(t){this._screenScale=t,this._camera&&(this._camera.screenScale=t)}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(t){this._inEditorMode=t,this._camera&&this._camera.changeTargetWindow(t?c.director.root&&c.director.root.mainWindow:c.director.root&&c.director.root.tempWindow)}}]),e}(Ku),DL.ProjectionType=qL,DL.FOVAxis=XL,DL.ClearFlag=QL,DL.Aperture=YL,DL.Shutter=KL,DL.ISO=JL,DL.TARGET_TEXTURE_CHANGE="tex-change",fL=st((_L=BL).prototype,"_projection",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qL.PERSPECTIVE}}),pL=st(_L.prototype,"_priority",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dL=st(_L.prototype,"_fov",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),mL=st(_L.prototype,"_fovAxis",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return XL.VERTICAL}}),vL=st(_L.prototype,"_orthoHeight",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),gL=st(_L.prototype,"_near",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),yL=st(_L.prototype,"_far",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),xL=st(_L.prototype,"_color",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new bn("#333333")}}),SL=st(_L.prototype,"_depth",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),CL=st(_L.prototype,"_stencil",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),AL=st(_L.prototype,"_clearFlags",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return QL.SOLID_COLOR}}),bL=st(_L.prototype,"_rect",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ti(0,0,1,1)}}),TL=st(_L.prototype,"_aperture",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return YL.F16_0}}),EL=st(_L.prototype,"_shutter",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return KL.D125}}),wL=st(_L.prototype,"_iso",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return JL.ISO100}}),PL=st(_L.prototype,"_screenScale",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),IL=st(_L.prototype,"_visibility",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Wd}}),RL=st(_L.prototype,"_targetTexture",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),st(_L.prototype,"priority",[AN,bN],Object.getOwnPropertyDescriptor(_L.prototype,"priority"),_L.prototype),st(_L.prototype,"visibility",[TN,EN,wN],Object.getOwnPropertyDescriptor(_L.prototype,"visibility"),_L.prototype),st(_L.prototype,"clearFlags",[PN,IN,RN],Object.getOwnPropertyDescriptor(_L.prototype,"clearFlags"),_L.prototype),st(_L.prototype,"clearColor",[DN,BN],Object.getOwnPropertyDescriptor(_L.prototype,"clearColor"),_L.prototype),st(_L.prototype,"clearDepth",[MN,ON],Object.getOwnPropertyDescriptor(_L.prototype,"clearDepth"),_L.prototype),st(_L.prototype,"clearStencil",[NN,LN],Object.getOwnPropertyDescriptor(_L.prototype,"clearStencil"),_L.prototype),st(_L.prototype,"projection",[FN,zN,GN],Object.getOwnPropertyDescriptor(_L.prototype,"projection"),_L.prototype),st(_L.prototype,"fovAxis",[VN,UN,kN],Object.getOwnPropertyDescriptor(_L.prototype,"fovAxis"),_L.prototype),st(_L.prototype,"fov",[HN,jN],Object.getOwnPropertyDescriptor(_L.prototype,"fov"),_L.prototype),st(_L.prototype,"orthoHeight",[WN,qN],Object.getOwnPropertyDescriptor(_L.prototype,"orthoHeight"),_L.prototype),st(_L.prototype,"near",[XN,YN],Object.getOwnPropertyDescriptor(_L.prototype,"near"),_L.prototype),st(_L.prototype,"far",[KN,JN],Object.getOwnPropertyDescriptor(_L.prototype,"far"),_L.prototype),st(_L.prototype,"aperture",[QN,ZN,$N],Object.getOwnPropertyDescriptor(_L.prototype,"aperture"),_L.prototype),st(_L.prototype,"shutter",[tL,eL,nL],Object.getOwnPropertyDescriptor(_L.prototype,"shutter"),_L.prototype),st(_L.prototype,"iso",[iL,rL,oL],Object.getOwnPropertyDescriptor(_L.prototype,"iso"),_L.prototype),st(_L.prototype,"rect",[aL,sL],Object.getOwnPropertyDescriptor(_L.prototype,"rect"),_L.prototype),st(_L.prototype,"targetTexture",[cL,lL,uL],Object.getOwnPropertyDescriptor(_L.prototype,"targetTexture"),_L.prototype),hL=_L))||hL)||hL)||hL)||hL,t({Camera:OL,CameraComponent:OL}),OL);c.Camera=ZL;var $L,tF,eF,nF,iF,rF,oF,aF,sF={parent:null,owner:null,subModelIdx:0},cF=t("RenderableComponent",(NL=hc("cc.RenderableComponent"),LL=Wc([ig]),FL=Wc(ig),zL=zc(),GL=Dc(),NL((jL=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_materials",kL,it(e)),at(e,"_visFlags",HL,it(e)),e._materialInstances=[],e._models=[],e}Q(e,t);var n=e.prototype;return n.getMaterial=function(t){return t<0||t>=this._materials.length?null:this._materials[t]},n.setMaterial=function(t,e){t&&t instanceof hC&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[e]=t;var n=this._materialInstances[e];n&&(n.destroy(),this._materialInstances[e]=null),this._onMaterialModified(e,this._materials[e])},n.getMaterialInstance=function(t){if(!this._materials[t])return null;if(!this._materialInstances[t]){sF.parent=this._materials[t],sF.owner=this,sF.subModelIdx=t;var e=new hC(sF);sF.parent=null,sF.owner=null,sF.subModelIdx=0,this.setMaterialInstance(e,t)}return this._materialInstances[t]},n.setMaterialInstance=function(t,e){if("number"==typeof t){I(12007);var n=t;t=e,e=n}var i=this._materialInstances[e];t&&t.parent?t!==i&&(this._materialInstances[e]=t,this._onMaterialModified(e,t)):(t!==this._materials[e]||i)&&this.setMaterial(t,e)},n.getRenderMaterial=function(t){return this._materialInstances[t]||this._materials[t]},n._collectModels=function(){return this._models},n._attachToScene=function(){},n._detachFromScene=function(){},n._onMaterialModified=function(){},n._onRebuildPSO=function(){},n._clearMaterials=function(){},n._onVisibilityChange=function(){},K(e,[{key:"visibility",get:function(){return this._visFlags},set:function(t){this._visFlags=t,this._onVisibilityChange(t)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(t){for(var e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(var n=t.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(t.length)}}},{key:"materials",get:function(){for(var t=0;t<this._materials.length;t++)this._materialInstances[t]=this.getMaterialInstance(t);return this._materialInstances},set:function(t){var e=t.length-this._materials.length;if(e>0)this._materials.length=t.length,this._materialInstances.length=t.length;else if(e<0)for(var n=this._materials.length-e;n<this._materials.length;++n)this.setMaterialInstance(null,n);for(var i=0;i<this._materialInstances.length;i++)this._materialInstances[i]!=t[i]&&this.setMaterialInstance(t[i],i)}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(t){(1!==this._materials.length||this._materialInstances[0]||this._materials[0]!==t)&&this.setMaterialInstance(t,0)}}]),e}(Ku),kL=st((UL=jL).prototype,"_materials",[LL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),HL=st(UL.prototype,"_visFlags",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rp.Enum.NONE}}),st(UL.prototype,"sharedMaterials",[FL,zL,GL],Object.getOwnPropertyDescriptor(UL.prototype,"sharedMaterials"),UL.prototype),VL=UL))||VL));function lF(t){return"string"==typeof t||"number"==typeof t}c.RenderableComponent=cF,z(ZL,"Camera",[{name:"CameraClearFlag",newName:"ClearFlag"}]),z(ZL.prototype,"Camera.prototype",[{name:"color",newName:"clearColor"},{name:"depth",newName:"clearDepth"},{name:"stencil",newName:"clearStencil"}]),c.CameraComponent=ZL,ee.setClassAlias(ZL,"cc.CameraComponent");var uF,hF,_F,fF,pF,dF,mF,vF,gF,yF,xF,SF,CF,AF,bF,TF,EF,wF,PF,IF,RF,DF,BF=hc("cc.animation.HierarchyPath")((nF=function(){function t(t){at(this,"path",eF,this),this.path=t||""}return t.prototype.get=function(t){return t instanceof GT?t.getChildByPath(this.path)||(I(3926,t.name,this.path),null):(I(3925),null)},t}(),eF=st((tF=nF).prototype,"path",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),$L=tF))||$L,MF=hc("cc.animation.ComponentPath")((aF=function(){function t(t){at(this,"component",oF,this),this.component=t||""}return t.prototype.get=function(t){return t instanceof GT?t.getComponent(this.component)||(I(3928,t.name,this.component),null):(I(3927),null)},t}(),oF=st((rF=aF).prototype,"component",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),iF=rF))||iF,OF=hc("cc.animation.UniformProxyFactory")((dF=function(){function t(t,e){at(this,"passIndex",_F,this),at(this,"uniformName",fF,this),at(this,"channelIndex",pF,this),this.passIndex=e||0,this.uniformName=t||""}return t.prototype.forTarget=function(t){var e=t.passes[this.passIndex],n=e.getHandle(this.uniformName);if(!n)throw new Error('Material "'+t.name+'" has no uniform "'+this.uniformName+'"');if(Ov.getTypeFromHandle(n)<_i.SAMPLER1D){var i=void 0===this.channelIndex?n:e.getHandle(this.uniformName,this.channelIndex,_i.FLOAT);if(!i)throw new Error('Uniform "'+this.uniformName+" (in material "+t.name+") has no channel "+this.channelIndex+'"');return function(t,e){for(var n,i=ot(t.shaderInfo.blocks);!(n=i()).done;)for(var r,o=ot(n.value.members);!(r=o()).done;){var a=r.value;if(a.name===e)return a.count>1}return!1}(e,this.uniformName)?{set:function(t){e.setUniformArray(i,t)}}:{set:function(t){e.setUniform(i,t)}}}var r=Ov.getBindingFromHandle(n),o=e.properties[this.uniformName],a=o&&o.value?o.value+"-texture":sm(o.type),s=wv.get(a);return s||(y("Illegal texture default value: "+a+"."),s=wv.get("default-texture")),{set:function(t){t||(t=s);var n=t.getGFXTexture();n&&n.width&&n.height&&(e.bindTexture(r,n),t instanceof Xm&&e.bindSampler(r,c.game._gfxDevice.getSampler(t.getSamplerInfo())))}}},t}(),_F=st((hF=dF).prototype,"passIndex",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fF=st(hF.prototype,"uniformName",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),pF=st(hF.prototype,"channelIndex",[kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),uF=hF))||uF,NF=hc("cc.animation.MorphWeightValueProxy")((xF=function(){function t(){at(this,"subMeshIndex",gF,this),at(this,"shapeIndex",yF,this)}return t.prototype.forTarget=function(t){var e=this;return{set:function(n){t.setWeight(n,e.subMeshIndex,e.shapeIndex)}}},t}(),gF=st((vF=xF).prototype,"subMeshIndex",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yF=st(vF.prototype,"shapeIndex",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mF=vF))||mF,LF=hc("cc.animation.MorphWeightsValueProxy")((bF=function(){function t(){at(this,"subMeshIndex",AF,this)}return t.prototype.forTarget=function(t){var e=this;return{set:function(n){t.setWeights(n,e.subMeshIndex)}}},t}(),AF=st((CF=bF).prototype,"subMeshIndex",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),SF=CF))||SF,FF=hc("cc.animation.MorphWeightsAllValueProxy")(TF=function(){function t(){}return t.prototype.forTarget=function(t){return{set:function(e){for(var n,i,r=null!==(n=null===(i=t.mesh)||void 0===i?void 0:i.struct.primitives.length)&&void 0!==n?n:0,o=0;o<r;++o)t.setWeights(e,o)}}},t}())||TF;function zF(t,e,n,i){var r,o,a,s,c,l,u=new e,h=new e,_=new e,f=hc(t)((l=function(){function t(t,n,i){at(this,"dataPoint",a,this),at(this,"inTangent",s,this),at(this,"outTangent",c,this),this.dataPoint=t||new e,this.inTangent=n||new e,this.outTangent=i||new e}var r=t.prototype;return r.lerp=function(t,e,r){var o=this.dataPoint,a=t.dataPoint;h=n(h,this.inTangent,r),_=n(_,t.outTangent,r);var s=e*e*e,c=e*e,l=s-2*c+e,f=-2*s+3*c,p=s-c;return u=n(u,o,2*s-3*c+1),u=i(u,u,h,l),u=i(u,u,a,f),u=i(u,u,_,p)},r.getNoLerp=function(){return this.dataPoint},t}(),a=st((o=l).prototype,"dataPoint",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),s=st(o.prototype,"inTangent",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),c=st(o.prototype,"outTangent",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),r=o))||r;if(e===Mn){var p=f.prototype.lerp;f.prototype.lerp=function(t,e,n){var i=p.call(this,t,e,n);return Mn.normalize(i,i),i}}return f}var GF=t("CubicSplineVec2Value",zF("cc.CubicSplineVec2Value",Wn,Wn.multiplyScalar,Wn.scaleAndAdd));c.CubicSplineVec2Value=GF;var VF=t("CubicSplineVec3Value",zF("cc.CubicSplineVec3Value",En,En.multiplyScalar,En.scaleAndAdd));c.CubicSplineVec3Value=VF;var UF=t("CubicSplineVec4Value",zF("cc.CubicSplineVec4Value",Kn,Kn.multiplyScalar,Kn.scaleAndAdd));c.CubicSplineVec4Value=UF;var kF=t("CubicSplineQuatValue",zF("cc.CubicSplineQuatValue",Mn,Mn.multiplyScalar,Mn.scaleAndAdd));c.CubicSplineQuatValue=kF;var HF=t("CubicSplineNumberValue",hc("cc.CubicSplineNumberValue")((DF=function(){function t(t,e,n){at(this,"dataPoint",PF,this),at(this,"inTangent",IF,this),at(this,"outTangent",RF,this),this.dataPoint=t,this.inTangent=e,this.outTangent=n}var e=t.prototype;return e.lerp=function(t,e,n){var i=this.dataPoint,r=t.dataPoint,o=e*e*e,a=e*e;return i*(2*o-3*a+1)+this.outTangent*n*(o-2*a+e)+r*(-2*o+3*a)+t.inTangent*n*(o-a)},e.getNoLerp=function(){return this.dataPoint},t}(),PF=st((wF=DF).prototype,"dataPoint",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),IF=st(wF.prototype,"inTangent",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),RF=st(wF.prototype,"outTangent",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),EF=wF))||EF);c.CubicSplineNumberValue=HF;var jF,WF,qF,XF,YF,KF,JF,QF,ZF,$F,tz,ez,nz,iz,rz,oz,az,sz,cz,lz,uz,hz,_z,fz,pz,dz,mz,vz=Symbol("CreateEval"),gz=Symbol("NormalizedFollow"),yz=Symbol("ConvertAsTrsPath"),xz=Symbol("TrackBinding"),Sz=hc("cc.animation.TrackPath")((XF=function(){function t(){at(this,"_paths",qF,this)}var e=t.prototype;return e.toProperty=function(t){return this._paths.push(t),this},e.toElement=function(t){return this._paths.push(t),this},e.toHierarchy=function(t){return this._paths.push(new BF(t)),this},e.toComponent=function(t){var e=new MF("string"==typeof t?t:ee.getClassName(t));return this._paths.push(e),this},e.toCustomized=function(t){return this._paths.push(t),this},e.append=function(){for(var t,e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];var r=(t=this._paths).concat.apply(t,n.map((function(t){return t._paths})));return this._paths=r,this},e.isPropertyAt=function(t){return"string"==typeof this._paths[t]},e.parsePropertyAt=function(t){return this._paths[t]},e.isElementAt=function(t){return"number"==typeof this._paths[t]},e.parseElementAt=function(t){return this._paths[t]},e.isHierarchyAt=function(t){return this._paths[t]instanceof BF},e.parseHierarchyAt=function(t){return this.isHierarchyAt(t),this._paths[t].path},e.isComponentAt=function(t){return this._paths[t]instanceof MF},e.parseComponentAt=function(t){return this.isComponentAt(t),this._paths[t].component},e.slice=function(e,n){var i=new t;return i._paths=this._paths.slice(e,n),i},e.trace=function(t,e,n){var i,r;return null!==(i=e)&&void 0!==i||(e=0),null!==(r=n)&&void 0!==r||(n=this._paths.length),this[gz](t,e,n)},e[yz]=function(){for(var t,e=this._paths,n=e.length,i=0,r="";i<n;++i){var o=e[i];if(!(o instanceof BF))break;o.path&&(r?r+="/"+o.path:r=o.path)}if(i===n)return null;if(i!==n-1)return null;switch(e[i]){case"position":case"scale":case"rotation":case"eulerAngles":t=e[i];break;default:return null}return{node:r,property:t}},e[gz]=function(t,e,n){for(var i=this._paths,r=t,o=e;o<n;++o){var a=i[o];if(lF(a)){if(!(a in r))return I(3929,a),null;r=r[a]}else r=a.get(r);if(null===r)break}return r},K(t,[{key:"length",get:function(){return this._paths.length}}]),t}(),qF=st((WF=XF).prototype,"_paths",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jF=WF))||jF,Cz=hc("cc.animation.TrackBinding")(YF=Sc((ZF=function(){function t(){at(this,"path",JF,this),at(this,"proxy",QF,this)}var e=t.prototype;return e.parseTrsPath=function(){return this.proxy?null:this.path[yz]()},e.createRuntimeBinding=function(t,e,n){var i=this.path,r=this.proxy,o=i.length,a=o-1;if(0===o||!i.isPropertyAt(a)&&!i.isElementAt(a)||r){if(r){var s=i[gz](t,0,o);if(null===s)return null;var c=r.forTarget(s),l={setValue:function(t){c.set(t)}},u=c.get;return u&&(l.getValue=function(){return u.call(c)}),l}return D(3921),null}var h,_=i.isPropertyAt(a)?i.parsePropertyAt(a):i.parseElementAt(a),f=i[gz](t,0,o-1);return null===f?null:e&&f instanceof GT&&("position"===(h=_)||"rotation"===h||"scale"===h||"eulerAngles"===h)?e.createPoseWriter(f,_,n):{setValue:function(t){f[_]=t},getValue:function(){return f[_]}}},t}(),JF=st((KF=ZF).prototype,"path",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Sz}}),QF=st(KF.prototype,"proxy",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),YF=KF))||YF)||YF,Az=hc("cc.animation.Track")((nz=function(){function t(){at(this,"_binding",ez,this)}var e=t.prototype;return e.channels=function(){return[]},e.range=function(){for(var t,e={min:1/0,max:-1/0},n=ot(this.channels());!(t=n()).done;){var i=t.value;e.min=Math.min(e.min,i.curve.rangeMin),e.max=Math.max(e.max,i.curve.rangeMax)}return e},K(t,[{key:"path",get:function(){return this._binding.path},set:function(t){this._binding.path=t}},{key:"proxy",get:function(){return this._binding.proxy},set:function(t){this._binding.proxy=t}},{key:xz,get:function(){return this._binding}}]),t}(),ez=st((tz=nz).prototype,"_binding",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Cz}}),$F=tz))||$F,bz=hc("cc.animation.Channel")((az=function(){function t(t){this.name="",at(this,"_curve",oz,this),this._curve=t}return K(t,[{key:"curve",get:function(){return this._curve}}]),t}(),oz=st((rz=az).prototype,"_curve",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),iz=rz))||iz,Tz=hc("cc.animation.SingleChannelTrack")((uz=function(t){function e(){var e;return at(e=t.call(this)||this,"_channel",lz,it(e)),e._channel=new bz(e.createCurve()),e}Q(e,t);var n=e.prototype;return n.channels=function(){return[this._channel]},n.createCurve=function(){throw new Error("Not impl")},n[vz]=function(){var t=this._channel.curve;return new Ez(t)},K(e,[{key:"channel",get:function(){return this._channel}}]),e}(Az),lz=st((cz=uz).prototype,"_channel",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),sz=cz))||sz,Ez=function(){function t(t){this._curve=t}return t.prototype.evaluate=function(t){return this._curve.evaluate(t)},t}(),wz=hc("cc.animation.RealTrack")(hz=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e.prototype.createCurve=function(){return new hf},e}(Tz))||hz;function Pz(t){return 0===t.keyFramesCount?void 0:t}var Iz,Rz,Dz,Bz,Mz,Oz,Nz,Lz,Fz,zz,Gz=["X","Y","Z","W"],Vz=hc("cc.animation.VectorTrack")((mz=function(t){function e(){var e;at(e=t.call(this)||this,"_channels",pz,it(e)),at(e,"_nComponents",dz,it(e)),e._channels=new Array(4);for(var n=0;n<e._channels.length;++n){var i=new bz(new hf);i.name=Gz[n],e._channels[n]=i}return e}Q(e,t);var n=e.prototype;return n.channels=function(){return this._channels},n[vz]=function(){switch(this._nComponents){default:case 2:return new Uz(Pz(this._channels[0].curve),Pz(this._channels[1].curve));case 3:return new kz(Pz(this._channels[0].curve),Pz(this._channels[1].curve),Pz(this._channels[2].curve));case 4:return new Hz(Pz(this._channels[0].curve),Pz(this._channels[1].curve),Pz(this._channels[2].curve),Pz(this._channels[3].curve))}},K(e,[{key:"componentsCount",get:function(){return this._nComponents},set:function(t){this._nComponents=t}}]),e}(Az),pz=st((fz=mz).prototype,"_channels",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),dz=st(fz.prototype,"_nComponents",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),_z=fz))||_z,Uz=function(){function t(t,e){this._result=new Wn,this._x=t,this._y=e}return t.prototype.evaluate=function(t,e){return this._x&&this._y||!e.getValue||Wn.copy(this._result,e.getValue()),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._result},t}(),kz=function(){function t(t,e,n){this._result=new En,this._x=t,this._y=e,this._z=n}return t.prototype.evaluate=function(t,e){return this._x&&this._y&&this._z||!e.getValue||En.copy(this._result,e.getValue()),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._z&&(this._result.z=this._z.evaluate(t)),this._result},t}(),Hz=function(){function t(t,e,n,i){this._result=new Kn,this._x=t,this._y=e,this._z=n,this._w=i}return t.prototype.evaluate=function(t,e){return this._x&&this._y&&this._z&&this._w||!e.getValue||Kn.copy(this._result,e.getValue()),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._z&&(this._result.z=this._z.evaluate(t)),this._w&&(this._result.w=this._w.evaluate(t)),this._result},t}(),jz=hc("cc.animation.QuatTrack")(Iz=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.createCurve=function(){return new Qf},n[vz]=function(){return new Wz(this.channels()[0].curve)},e}(Tz))||Iz,Wz=function(){function t(t){this._result=new Mn,this._curve=t}return t.prototype.evaluate=function(t){return this._curve.evaluate(t,this._result),this._result},t}(),qz=["Red","Green","Blue","Alpha"],Xz=hc("cc.animation.ColorTrack")((Mz=function(t){function e(){var e;at(e=t.call(this)||this,"_channels",Bz,it(e)),e._channels=new Array(4);for(var n=0;n<e._channels.length;++n){var i=new bz(new hf);i.name=qz[n],e._channels[n]=i}return e}Q(e,t);var n=e.prototype;return n.channels=function(){return this._channels},n[vz]=function(){return new Yz(Pz(this._channels[0].curve),Pz(this._channels[1].curve),Pz(this._channels[2].curve),Pz(this._channels[3].curve))},e}(Az),Bz=st((Dz=Mz).prototype,"_channels",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Rz=Dz))||Rz,Yz=function(){function t(t,e,n,i){this._result=new bn,this._x=t,this._y=e,this._z=n,this._w=i}return t.prototype.evaluate=function(t,e){return this._x&&this._y&&this._z&&this._w||!e.getValue||bn.copy(this._result,e.getValue()),this._x&&(this._result.r=this._x.evaluate(t)),this._y&&(this._result.g=this._y.evaluate(t)),this._z&&(this._result.b=this._z.evaluate(t)),this._w&&(this._result.a=this._w.evaluate(t)),this._result},t}(),Kz=["Width","Height"],Jz=hc("cc.animation.SizeTrack")((Fz=function(t){function e(){var e;at(e=t.call(this)||this,"_channels",Lz,it(e)),e._channels=new Array(2);for(var n=0;n<e._channels.length;++n){var i=new bz(new hf);i.name=Kz[n],e._channels[n]=i}return e}Q(e,t);var n=e.prototype;return n.channels=function(){return this._channels},n[vz]=function(){return new Qz(Pz(this._channels[0].curve),Pz(this._channels[1].curve))},e}(Az),Lz=st((Nz=Fz).prototype,"_channels",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Oz=Nz))||Oz,Qz=function(){function t(t,e){this._result=new Zn,this._width=t,this._height=e}return t.prototype.evaluate=function(t,e){if((!this._width||!this._height)&&e.getValue){var n=e.getValue();this._result.x=n.x,this._result.y=n.y}return this._width&&(this._result.width=this._width.evaluate(t)),this._height&&(this._result.height=this._height.evaluate(t)),this._result},t}(),Zz=hc("cc.animation.ObjectTrack")(zz=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e.prototype.createCurve=function(){return new _p},e}(Tz))||zz;t("animation",Object.freeze({__proto__:null,UniformProxyFactory:OF,MorphWeightValueProxy:NF,MorphWeightsValueProxy:LF,MorphWeightsAllValueProxy:FF,Track:Az,TrackPath:Sz,RealTrack:wz,VectorTrack:Vz,QuatTrack:jz,ColorTrack:Xz,SizeTrack:Jz,ObjectTrack:Zz,isPropertyPath:lF,isCustomPath:function(t,e){return t instanceof e},HierarchyPath:BF,ComponentPath:MF,CubicSplineVec2Value:GF,CubicSplineVec3Value:VF,CubicSplineVec4Value:UF,CubicSplineQuatValue:kF,CubicSplineNumberValue:HF}));var $z=Symbol("BakeNodeCurves"),tG=t("SkelAnimDataHub",function(){function t(){}return t.getOrExtract=function(e){var n=t.pool.get(e);if(!n||n.samples!==e.sample){n&&c.director.root.dataPoolManager.releaseAnimationClip(e);var i=Math.ceil(e.sample*e.duration)+1,r=e.sample;n=e[$z](0,r,i),t.pool.set(e,n)}return n},t.destroy=function(e){t.pool.delete(e)},t}());tG.pool=new Map;var eG=t("RatioSampler",function(){function t(t){var e,n;this.ratios=void 0,this._findRatio=void 0,this.ratios=t;for(var i=!0,r=1,o=t.length;r<o;r++)if(e=t[r]-t[r-1],1===r)n=e;else if(Math.abs(e-n)>1e-6){i=!1;break}this._findRatio=i?oG:nc}return t.prototype.sample=function(t){return this._findRatio(this.ratios,t)},t}());c.RatioSampler=eG;var nG=t("AnimCurve",function(){function t(e,n){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=n,this._values=e.values;var i=function(e){return"string"==typeof e?e:Array.isArray(e)?e[0]===e[1]&&e[2]===e[3]?t.Linear:t.Bezier(e):t.Linear};if(void 0!==e.easingMethod)this.type=i(e.easingMethod);else if(Array.isArray(e.easingMethods))this.types=e.easingMethods.map(i);else if(void 0!==e.easingMethods){this.types=new Array(this._values.length).fill(null);for(var r=0,o=Object.keys(e.easingMethods);r<o.length;r++){var a=o[r];this.types[a]=i(e.easingMethods[a])}}else this.type=null;var s=e.values[0];(void 0===e.interpolate||e.interpolate)&&(this._lerp=pG(s)),void 0!==e._arrayLength&&(this._array=new Array(e._arrayLength))}t.Bezier=function(t){return t};var e=t.prototype;return e.hasLerp=function(){return!!this._lerp},e.valueAt=function(t){if(void 0===this._array){var e=this._values[t];return e&&e.getNoLerp?e.getNoLerp():e}for(var n=0;n<this._array.length;++n)this._array[n]=this._values[this._array.length*t+n];return this._array},e.valueBetween=function(t,e,n,i,r){if(this._lerp){var o=this.types?this.types[e]:this.type,a=r-n,s=(t-n)/a;if(o&&(s=rG(s,o)),void 0===this._array){var c=this._values[e],l=this._values[i];return this._lerp(c,l,s,a*this._duration)}for(var u=0;u<this._array.length;++u){var h=this._values[this._array.length*e+u],_=this._values[this._array.length*i+u];this._array[u]=this._lerp(h,_,s,a*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(e);for(var f=0;f<this._array.length;++f)this._array[f]=this._values[this._array.length*e+f];return this._array},e.empty=function(){return 0===this._values.length},e.constant=function(){return 1===this._values.length},t}());function iG(t,e,n){var i=e.sample(n);if(i<0)if((i=~i)<=0)i=0;else{if(!(i>=e.ratios.length))return t.valueBetween(n,i-1,e.ratios[i-1],i,e.ratios[i]);i=e.ratios.length-1}return t.valueAt(i)}function rG(t,e){if("string"==typeof e){var n=J_[e];n?t=n(t):D(3906,e)}else Array.isArray(e)&&(t=Xf(e,t));return t}function oG(t,e){var n=t.length-1;if(0===n)return 0;var i=t[0];if(e<i)return 0;var r=t[n];if(e>r)return n;var o=(e=(e-i)/(r-i))/(1/n),a=0|o,s=1e-6;return o-a<s?a:a+1-o<s?a+1:~(a+1)}nG.Linear=null,c.AnimCurve=nG,t("EventInfo",function(){function t(){this.events=[]}return t.prototype.add=function(t,e){this.events.push({func:t||"",params:e||[]})},t}()),c.sampleAnimationCurve=iG;var aG,sG,cG,lG,uG,hG,_G,fG,pG=function(){function t(t,e,n,i){return t.lerp(e,n,i)}return function(e){if(null!==e){if("number"==typeof e)return sn;if("object"==typeof e&&e.constructor){if(e instanceof Mn)return n=new Mn,function(t,e,i){return Mn.slerp(n,t,e,i)};if(e instanceof se)return function(t){var e=new t;return function(n,i,r){return t.lerp(e,n,i,r),e}}(e.constructor);if(e.constructor===Number)return sn;if("function"==typeof e.lerp)return t}var n}}}(),dG=hc("cc.animation.UntypedTrackChannel")((lG=function(t){function e(){var e;return at(e=t.call(this,new hf)||this,"property",cG,it(e)),e}return Q(e,t),e}(bz),cG=st((sG=lG).prototype,"property",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),aG=sG))||aG,mG=hc("cc.animation.UntypedTrack")((fG=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_channels",_G,it(e)),e}Q(e,t);var n=e.prototype;return n.channels=function(){return this._channels},n[vz]=function(t){var e=this;if(!t.getValue)throw new Error(N(3930));var n=function(t){var n;return null===(n=e._channels.find((function(e){return e.property===t})))||void 0===n?void 0:n.curve},i=t.getValue();switch(!0){default:throw new Error(N(3931));case i instanceof Wn:return new Uz(n("x"),n("y"));case i instanceof En:return new kz(n("x"),n("y"),n("z"));case i instanceof Kn:return new Hz(n("x"),n("y"),n("z"),n("w"));case i instanceof bn:return new Yz(n("r"),n("g"),n("b"),n("a"));case i instanceof Zn:return new Qz(n("width"),n("height"))}},n.addChannel=function(t){var e=new dG;return e.property=t,this._channels.push(e),e},n.upgrade=function(t){var e=this,n=function(t,n){var i=e.channels().find((function(e){return e.property===t}));i&&(n.name=i.name,n.curve.assignSorted(Array.from(i.curve.times()),Array.from(i.curve.values())))},i=t(this.path,this.proxy);switch(i){default:break;case"vec2":case"vec3":case"vec4":var r=new Vz;r.path=this.path,r.proxy=this.proxy,r.componentsCount="vec2"===i?2:"vec3"===i?3:4;var o=r.channels(),a=o[0],s=o[1],c=o[2],l=o[3];switch(i){case"vec4":n("w",l);case"vec3":n("z",c);default:case"vec2":n("x",a),n("y",s)}return r;case"color":var u=new Xz,h=u.channels(),_=h[0],f=h[1],p=h[2],d=h[3];return n("r",_),n("g",f),n("b",p),n("a",d),n("x",_),n("y",f),n("z",p),n("w",d),u;case"size":}return null},e}(Az),_G=st((hG=fG).prototype,"_channels",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),uG=hG))||uG,vG=function(){function t(t){this._keys=[],this._curves=[],this._commonTargets=[],this._ratioSamplers=[],this._runtimeCurves=void 0,this._data=null,this._duration=void 0,this._duration=t}var e=t.prototype;return e.getPropertyCurves=function(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves},e.toTracks=function(){for(var t,e=[],n=this.keys,i=this.curves,r=this.commonTargets,o=function(t,e,n){for(var i,r=new Sz,o=ot(e);!(i=o()).done;){var a=i.value;"string"==typeof a?r.toProperty(a):"number"==typeof a?r.toElement(a):a instanceof BF?r.toHierarchy(a.path):a instanceof MF?r.toComponent(a.component):r.toCustomized(a)}t.path=r,t.proxy=n},a=r.map((function(t){var n=new mG;return o(n,t.modifiers,t.valueAdapter),e.push(n),n})),s=function(){var i,r=t.value,s=r.data,c=s.values;if(0===c.length)return"continue";var l=s.keys<0?[0]:n[s.keys],u=c[0],h=null===(i=s.interpolate)||void 0===i||i;s._arrayLength;var _=new yG(s,l.length),f=function(t){o(t,r.modifiers,r.valueAdapter)},p=void 0;if("number"==typeof r.commonTarget){if(!c.every((function(t){return"number"==typeof t})))return I(3932),"continue";if(r.valueAdapter||1!==r.modifiers.length||"string"!=typeof r.modifiers[0])return I(3933),"continue";var d=r.modifiers[0],m=a[r.commonTarget].addChannel(d).curve;p=m}!function(){if("number"==typeof u){if(!c.every((function(t){return"number"==typeof t})))return void I(3934);var t;if(p)t=p;else{var n=new wz;f(n),e.push(n),t=n.channel.curve}var i=h?Zc.LINEAR:Zc.CONSTANT;return t.assignSorted(l,c.map((function(t){return{value:t,interpolationMode:i}}))),void _.convert(t)}if("object"==typeof u)switch(!0){default:break;case gG(c,Wn):case gG(c,En):case gG(c,Kn):var r=u instanceof Wn?2:u instanceof En?3:4,o=new Vz;f(o),o.componentsCount=r;var a=o.channels(),s=a[0].curve,d=a[1].curve,m=a[2].curve,v=a[3].curve,g=h?Zc.LINEAR:Zc.CONSTANT,y=function(t){return{value:t,interpolationMode:g}};switch(r){case 4:v.assignSorted(l,c.map((function(t){return y(t.w)}))),_.convert(v);case 3:m.assignSorted(l,c.map((function(t){return y(t.z)}))),_.convert(m);default:s.assignSorted(l,c.map((function(t){return y(t.x)}))),_.convert(s),d.assignSorted(l,c.map((function(t){return y(t.y)}))),_.convert(d)}return void e.push(o);case gG(c,Mn):var x=new jz;f(x);var S=h?Vf.SLERP:Vf.CONSTANT;return x.channel.curve.assignSorted(l,c.map((function(t){return{value:Mn.clone(t),interpolationMode:S}}))),_.convertQuatCurve(x.channel.curve),void e.push(x);case gG(c,bn):var C=new Xz;f(C);var A=C.channels(),b=A[0].curve,T=A[1].curve,E=A[2].curve,w=A[3].curve,P=h?Zc.LINEAR:Zc.CONSTANT,R=function(t){return{value:t,interpolationMode:P}};return b.assignSorted(l,c.map((function(t){return R(t.r)}))),_.convert(b),T.assignSorted(l,c.map((function(t){return R(t.g)}))),_.convert(T),E.assignSorted(l,c.map((function(t){return R(t.b)}))),_.convert(E),w.assignSorted(l,c.map((function(t){return R(t.a)}))),_.convert(w),void e.push(C);case gG(c,Zn):var D=new Jz;f(D);var B=D.channels(),M=B[0].curve,O=B[1].curve,N=h?Zc.LINEAR:Zc.CONSTANT,L=function(t){return{value:t,interpolationMode:N}};return M.assignSorted(l,c.map((function(t){return L(t.width)}))),_.convert(M),O.assignSorted(l,c.map((function(t){return L(t.height)}))),_.convert(O),void e.push(D);case gG(c,HF):var F=new wz;f(F);var z=h?Zc.CUBIC:Zc.CONSTANT;return F.channel.curve.assignSorted(l,c.map((function(t){return{value:t.dataPoint,leftTangent:t.inTangent,rightTangent:t.outTangent,interpolationMode:z}}))),void e.push(F);case gG(c,GF):case gG(c,VF):case gG(c,UF):var G=u instanceof GF?2:u instanceof VF?3:4,V=new Vz;f(V),V.componentsCount=G;var U=V.channels(),k=U[0],H=U[1],j=U[2],W=U[3],q=h?Zc.LINEAR:Zc.CONSTANT,X=function(t,e,n){return{value:t,leftTangent:e,rightTangent:n,interpolationMode:q}};switch(G){case 4:W.curve.assignSorted(l,c.map((function(t){return X(t.dataPoint.w,t.inTangent.w,t.outTangent.w)})));case 3:j.curve.assignSorted(l,c.map((function(t){return X(t.dataPoint.z,t.inTangent.z,t.outTangent.z)})));default:k.curve.assignSorted(l,c.map((function(t){return X(t.dataPoint.y,t.inTangent.y,t.outTangent.y)}))),H.curve.assignSorted(l,c.map((function(t){return X(t.dataPoint.x,t.inTangent.x,t.outTangent.x)})))}return void e.push(V);case c.every((function(t){return t instanceof kF})):I(3935)}var Y=new Zz;f(Y),Y.channel.curve.assignSorted(l,c),e.push(Y)}()},c=ot(i);!(t=c()).done;)s();return e},e._createPropertyCurves=function(){var t=this;this._ratioSamplers=this._keys.map((function(e){return new eG(e.map((function(e){return e/t._duration})))})),this._runtimeCurves=this._curves.map((function(e){return{curve:new nG(e.data,t._duration),modifiers:e.modifiers,valueAdapter:e.valueAdapter,sampler:t._ratioSamplers[e.data.keys],commonTarget:e.commonTarget}}))},K(t,[{key:"keys",get:function(){return this._keys},set:function(t){this._keys=t}},{key:"curves",get:function(){return this._curves},set:function(t){this._curves=t,delete this._runtimeCurves}},{key:"commonTargets",get:function(){return this._commonTargets},set:function(t){this._commonTargets=t}},{key:"data",get:function(){return this._data}}]),t}();function gG(t,e){return t.every((function(t){return t instanceof e}))}var yG=function(){function t(t,e){this._easingMethods=void 0;var n=t.easingMethods;Array.isArray(n)?0===n.length&&0!==e?this._easingMethods=new Array(e).fill(null):this._easingMethods=n:this._easingMethods=void 0===n?new Array(e).fill(t.easingMethod):Array.from({length:e},(function(t,e){var i;return null!==(i=n[e])&&void 0!==i?i:null}))}var e=t.prototype;return e.convert=function(t){var e,n,i,r,o,a,s,c,l,u,h,_,f,p,d,m,v,g,y,x,S,C,A=this._easingMethods;if(A){var b=t.keyFramesCount;if(!(t.keyFramesCount<2)){Array.isArray(A)&&A.length;for(var T=b-1,E=0;E<T;++E){var w=A[E];w&&(Array.isArray(w)?(e=w,n=t.getKeyframeTime(E),i=t.getKeyframeValue(E),r=t.getKeyframeTime(E+1),o=t.getKeyframeValue(E+1),a=void 0,s=void 0,c=void 0,l=void 0,u=void 0,h=void 0,_=void 0,f=void 0,p=void 0,d=void 0,m=void 0,v=void 0,g=void 0,y=void 0,x=void 0,S=void 0,C=void 0,s=e[0],c=e[1],l=e[2],u=e[3],h=i.value,_=3*(r-n),f=3*(o.value-h),m=(1-l)*_,v=(1-u)*f,g=1/3,y=(d=c*f)/(p=s*_),x=Math.sqrt(p*p+d*d)*g,S=v/m,C=Math.sqrt(m*m+v*v)*g,i.interpolationMode=Zc.CUBIC,i.tangentWeightMode=(a=i.tangentWeightMode)===tl.NONE?tl.RIGHT:a===tl.LEFT?tl.BOTH:a,i.rightTangent=y,i.rightTangentWeight=x,o.tangentWeightMode=function(t){return t===tl.NONE?tl.LEFT:t===tl.RIGHT?tl.BOTH:t}(o.tangentWeightMode),o.leftTangent=S,o.leftTangentWeight=C):xG(w,t,E))}}}},e.convertQuatCurve=function(t){var e=this._easingMethods;if(e){var n=t.keyFramesCount;if(!(t.keyFramesCount<2)){Array.isArray(e)&&e.length;for(var i=n-1,r=0;r<i;++r){var o=e[r];o&&(Array.isArray(o)?t.getKeyframeValue(r).easingMethod=o.slice():SG(o,t,r))}}}},K(t,[{key:"nil",get:function(){return!this._easingMethods||this._easingMethods.every((function(t){return null==t}))}}]),t}();function xG(t,e,n){e.keyFramesCount;var i=e.getKeyframeValue(n),r=QG[t];r===K_.CONSTANT?i.interpolationMode=Zc.CONSTANT:(i.interpolationMode=Zc.LINEAR,i.easingMethod=r)}function SG(t,e,n){e.keyFramesCount;var i=e.getKeyframeValue(n),r=QG[t];i.easingMethod=r}var CG,AG,bG,TG,EG,wG,PG,IG,RG,DG,BG,MG,OG,NG,LG,FG,zG,GG,VG,UG,kG,HG,jG,WG,qG,XG,YG,KG,JG,QG={constant:K_.CONSTANT,linear:K_.LINEAR,quadIn:K_.QUAD_IN,quadOut:K_.QUAD_OUT,quadInOut:K_.QUAD_IN_OUT,quadOutIn:K_.QUAD_OUT_IN,cubicIn:K_.CUBIC_IN,cubicOut:K_.CUBIC_OUT,cubicInOut:K_.CUBIC_IN_OUT,cubicOutIn:K_.CUBIC_OUT_IN,quartIn:K_.QUART_IN,quartOut:K_.QUART_OUT,quartInOut:K_.QUART_IN_OUT,quartOutIn:K_.QUART_OUT_IN,quintIn:K_.QUINT_IN,quintOut:K_.QUINT_OUT,quintInOut:K_.QUINT_IN_OUT,quintOutIn:K_.QUINT_OUT_IN,sineIn:K_.SINE_IN,sineOut:K_.SINE_OUT,sineInOut:K_.SINE_IN_OUT,sineOutIn:K_.SINE_OUT_IN,expoIn:K_.EXPO_IN,expoOut:K_.EXPO_OUT,expoInOut:K_.EXPO_IN_OUT,expoOutIn:K_.EXPO_OUT_IN,circIn:K_.CIRC_IN,circOut:K_.CIRC_OUT,circInOut:K_.CIRC_IN_OUT,circOutIn:K_.CIRC_OUT_IN,elasticIn:K_.ELASTIC_IN,elasticOut:K_.ELASTIC_OUT,elasticInOut:K_.ELASTIC_IN_OUT,elasticOutIn:K_.ELASTIC_OUT_IN,backIn:K_.BACK_IN,backOut:K_.BACK_OUT,backInOut:K_.BACK_IN_OUT,backOutIn:K_.BACK_OUT_IN,bounceIn:K_.BOUNCE_IN,bounceOut:K_.BOUNCE_OUT,bounceInOut:K_.BOUNCE_IN_OUT,bounceOutIn:K_.BOUNCE_OUT_IN,smooth:K_.SMOOTH,fade:K_.FADE};function ZG(){throw new Error("split() only valid in Editor.")}hc("cc.animation.ExoticAnimation")((bG=function(){function t(){at(this,"_nodeAnimations",AG,this)}var e=t.prototype;return e.createEvaluator=function(t){return new cV(this._nodeAnimations,t)},e.addNodeAnimation=function(t){var e=new $G(t);return this._nodeAnimations.push(e),e},e.collectAnimatedJoints=function(){return Array.from(new Set(this._nodeAnimations.map((function(t){return t.path}))))},e.split=function(){return ZG()},e.toHashString=function(){return this._nodeAnimations.map((function(t){return t.toHashString()})).join("\n")},t}(),AG=st((CG=bG).prototype,"_nodeAnimations",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),CG));var $G=hc("cc.animation.ExoticNodeAnimation")((DG=function(){function t(t){at(this,"_path",wG,this),at(this,"_position",PG,this),at(this,"_rotation",IG,this),at(this,"_scale",RG,this),this._path=t}var e=t.prototype;return e.createPosition=function(t,e){this._position=new oV(t,new iV(e))},e.createRotation=function(t,e){this._rotation=new oV(t,new rV(e))},e.createScale=function(t,e){this._scale=new oV(t,new iV(e))},e.createEvaluator=function(t){return new lV(this._path,this._position,this._rotation,this._scale,t)},e.split=function(){return ZG()},e.toHashString=function(){var t,e,n,i,r,o;return this._path+"\n"+(null!==(t=null===(e=this._position)||void 0===e?void 0:e.toHashString())&&void 0!==t?t:"")+(null!==(n=null===(i=this._scale)||void 0===i?void 0:i.toHashString())&&void 0!==n?n:"")+(null!==(r=null===(o=this._rotation)||void 0===o?void 0:o.toHashString())&&void 0!==r?r:"")},K(t,[{key:"path",get:function(){return this._path}}]),t}(),wG=st((EG=DG).prototype,"_path",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),PG=st(EG.prototype,"_position",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),IG=st(EG.prototype,"_rotation",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),RG=st(EG.prototype,"_scale",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),TG=EG))||TG;function tV(t){return t.toPrecision(2)}function eV(t){return t.map(tV).join(" ")}var nV=hc("cc.animation.ExoticVectorLikeTrackValues")((LG=function(){function t(t){at(this,"_values",OG,this),at(this,"_isQuantized",NG,this),this._values=t,this._isQuantized=!1}var e=t.prototype;return e.quantize=function(t){this._isQuantized,this._values=function(t,e){var n=hV[e],i=1<<n.BYTES_PER_ELEMENT,r=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;t.forEach((function(t){r=Math.min(t,r),o=Math.max(t,o)}));var a=o-r,s=n.from(t,(function(t){return(t-r)/a*i}));return new EV(_V(t),s,a,r)}(this._values,t),this._isQuantized=!0},e.toHashString=function(){var t=this._isQuantized,e=this._values;return t+" "+(t?e.toHashString():eV(e))},K(t,[{key:"precision",get:function(){return this._isQuantized?this._values.originalPrecision:_V(this._values)}}]),t}(),OG=st((MG=LG).prototype,"_values",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),NG=st(MG.prototype,"_isQuantized",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),BG=MG))||BG,iV=hc("cc.animation.ExoticVec3TrackValues")(FG=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t),e.imitate=function(t,n){var i=new e(t);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=e.prototype;return n.get=function(t,e){var n=this._values;this._isQuantized?IV(n,t,e):En.fromArray(e,n,3*t)},n.lerp=function(t,e,n,i,r,o){var a=this._values;this._isQuantized?(IV(a,t,i),IV(a,e,r)):(En.fromArray(i,a,3*t),En.fromArray(r,a,3*e)),En.lerp(o,i,r,n)},e}(nV))||FG,rV=hc("cc.animation.ExoticQuatTrackValues")(zG=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t),e.imitate=function(t,n){var i=new e(t);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=e.prototype;return n.get=function(t,e){var n=this._values;this._isQuantized?RV(n,t,e):Mn.fromArray(e,n,4*t)},n.lerp=function(t,e,n,i,r,o){var a=this._values;this._isQuantized?(RV(a,t,i),RV(a,e,r)):(Mn.fromArray(i,a,4*t),Mn.fromArray(r,a,4*e)),Mn.slerp(o,i,r,n)},e}(nV))||zG,oV=hc("cc.animation.ExoticTrack")((HG=function(){function t(t,e){at(this,"times",UG,this),at(this,"values",kG,this),this.times=t,this.values=e}return t.prototype.toHashString=function(){var t=this.times,e=this.values;return"times: "+eV(t)+"; values: "+e.toHashString()},t}(),UG=st((VG=HG).prototype,"times",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),kG=st(VG.prototype,"values",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),GG=VG))||GG;function aV(t,e){t.length,t.length;var n=0,i=0,r=nc(t,e);if(r>=0)n=r;else{var o=~r,a=o-1;n=a;var s=t[o],c=t[a];i=(e-c)/(s-c)}return{index:n,ratio:i}}!function(){function t(){this._reset()}var e=t.prototype;e.transformTime=function(t){return t-this._timeOffset},e.calculate=function(t,e,n){this._reset();var i=t.length;if(i){var r=t[0],o=t[i-1],a=on(e,r,o),s=on(n,r,o);this._timeOffset=a;var c=function(t,e,n){var i=t.length;n>=e&&e>=t[0]&&t[i-1];var r=aV(t,e),o=r.index,a=r.ratio,s=aV(t,n);return{fromIndex:o,fromRatio:a,toIndex:s.index,toRatio:s.ratio}}(t,a,s),l=c.fromIndex,u=c.fromRatio,h=c.toIndex,_=c.toRatio,f=!u,p=!_;l!==h||u!==_?(f||(this.preLerpIndex=l,this.preLerpRatio=u),this.directKeyframesBegin=f?l:l+1,this.directKeyframesEnd=h+1,p||(this.postLerpIndex=h,this.postLerpRatio=_)):f?(this.directKeyframesBegin=l,this.directKeyframesEnd=l+1):(this.preLerpIndex=l,this.preLerpRatio=u)}},e._reset=function(){this.preLerpIndex=-1,this.preLerpRatio=0,this.directKeyframesBegin=0,this.directKeyframesEnd=0,this.postLerpIndex=-1,this.postLerpRatio=0,this._timeOffset=0},K(t,[{key:"keyframesCount",get:function(){var t=this.preLerpIndex,e=this.directKeyframesBegin;return 0+(t<0?0:1)+(this.directKeyframesEnd-e)+(this.postLerpIndex<0?0:1)}}])}();var sV,cV=function(){function t(t,e){this._nodeEvaluations=void 0,this._nodeEvaluations=t.map((function(t){return t.createEvaluator(e)}))}return t.prototype.evaluate=function(t){this._nodeEvaluations.forEach((function(e){e.evaluate(t)}))},t}(),lV=function(){function t(t,e,n,i,r){this._position=null,this._rotation=null,this._scale=null,e&&(this._position=PV(e.times,e.values,En,t,"position",r)),n&&(this._rotation=PV(n.times,n.values,Mn,t,"rotation",r)),i&&(this._scale=PV(i.times,i.values,En,t,"scale",r))}return t.prototype.evaluate=function(t){if(this._position){var e=this._position.evaluator.evaluate(t);this._position.runtimeBinding.setValue(e)}if(this._rotation){var n=this._rotation.evaluator.evaluate(t);this._rotation.runtimeBinding.setValue(n)}if(this._scale){var i=this._scale.evaluator.evaluate(t);this._scale.runtimeBinding.setValue(i)}},t}(),uV=function(){function t(t,e,n){this._times=void 0,this._inputSampleResultCache={just:!1,index:-1,nextIndex:-1,ratio:0},this._values=void 0,this._prevValue=void 0,this._nextValue=void 0,this._resultValue=void 0,this._times=t,this._values=e,this._prevValue=new n,this._nextValue=new n,this._resultValue=new n}return t.prototype.evaluate=function(t){var e=this._times,n=this._values,i=this._resultValue;if(0===e.length)return i;var r=function(t,e,n){var i=t.length,r=t[0],o=t[i-1];if(e<r)n.just=!0,n.index=0;else if(e>o)n.just=!0,n.index=i-1;else{var a=nc(t,e);if(a>=0)n.just=!0,n.index=a;else{var s=~a,c=s-1,l=t[c],u=t[s],h=(e-t[c])/(u-l);n.just=!1,n.index=c,n.nextIndex=s,n.ratio=h}}return n}(e,t,this._inputSampleResultCache);return r.just?n.get(r.index,i):n.lerp(r.index,r.nextIndex,r.ratio,this._prevValue,this._nextValue,i),i},t}(),hV={uint8:Uint8Array,uint16:Uint16Array};function _V(t){switch(t.BYTES_PER_ELEMENT){default:case 4:return sV.FLOAT_32;case 8:return sV.FLOAT_64}}!function(t){t[t.FLOAT_32=0]="FLOAT_32",t[t.FLOAT_64=1]="FLOAT_64"}(sV||(sV={}));var fV,pV,dV,mV,vV,gV,yV,xV,SV,CV,AV,bV,TV,EV=hc("cc.animation.QuantizedFloatArray")((JG=function(){function t(t,e,n,i){void 0===i&&(i=0),at(this,"originalPrecision",qG,this),at(this,"min",XG,this),at(this,"extent",YG,this),at(this,"values",KG,this),this.originalPrecision=t,this.values=e,this.extent=n,this.min=i}return t.prototype.toHashString=function(){var t=this.originalPrecision,e=this.min,n=this.extent,i=this.values;return t+" "+tV(e)+" "+tV(n)+" "+i.join(" ")},K(t,[{key:"quantizationType",get:function(){switch(this.values.BYTES_PER_ELEMENT){default:case 1:return"uint8";case 2:return"uint16"}}}]),t}(),qG=st((WG=JG).prototype,"originalPrecision",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),XG=st(WG.prototype,"min",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),YG=st(WG.prototype,"extent",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),KG=st(WG.prototype,"values",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),jG=WG))||jG;function wV(t,e){return t.values[e]/(1<<t.values.BYTES_PER_ELEMENT)*t.extent+t.min}function PV(t,e,n,i,r,o){var a=new Cz;a.path=(new Sz).toHierarchy(i).toProperty(r);var s=o(a);return s?{runtimeBinding:s,evaluator:new uV(t,e,n)}:null}function IV(t,e,n){En.set(n,wV(t,3*e+0),wV(t,3*e+1),wV(t,3*e+2))}function RV(t,e,n){Mn.set(n,wV(t,4*e+0),wV(t,4*e+1),wV(t,4*e+2),wV(t,4*e+3))}var DV=Symbol("SearchForRootBonePath"),BV=Symbol("ExoticAnimation"),MV=t("AnimationClip",hc("cc.AnimationClip")((TV=bV=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"sample",dV,it(e)),at(e,"speed",mV,it(e)),at(e,"wrapMode",vV,it(e)),at(e,"enableTrsBlending",gV,it(e)),at(e,"_duration",yV,it(e)),at(e,"_hash",xV,it(e)),e.frameRate=0,at(e,"_tracks",SV,it(e)),at(e,"_exoticAnimation",CV,it(e)),e._legacyData=void 0,e._legacyDataDirty=!1,at(e,"_events",AV,it(e)),e._runtimeEvents={ratios:[],eventGroups:[]},e}Q(e,t),e.createWithSpriteFrames=function(t,n){var i=new e;i.sample=n||i.sample,i.duration=t.length/i.sample;var r=1/i.sample,o=new Zz;return o.path=(new Sz).toComponent("cc.Sprite").toProperty("spriteFrame"),o.channels()[0].curve.assignSorted(t.map((function(t,e){return[r*e,t]}))),i.addTrack(o),i};var n=e.prototype;return n.onLoaded=function(){this.frameRate=this.sample,this.events=this._events},n.range=function(){for(var t={min:1/0,max:-1/0},e=this._tracks,n=e.length,i=0;i<n;++i){var r=e[i].range();t.min=Math.min(t.min,r.min),t.max=Math.max(t.max,r.max)}return t},n.getTrack=function(t){return this._tracks[t]},n.addTrack=function(t){var e=this._tracks.length;return this._tracks.push(t),e},n.removeTrack=function(t){this._tracks.splice(t,1)},n.clearTracks=function(){this._tracks.length=0},n.createEventEvaluator=function(t){return new UV(t,this._runtimeEvents.ratios,this._runtimeEvents.eventGroups,this.wrapMode)},n.createEvaluator=function(t){var e=this,n=t.target;return this._createEvalWithBinder(n,(function(i){var r=i.createRuntimeBinding(n,e.enableTrsBlending?t.pose:void 0,!1);return null!=r?r:void 0}),t.rootMotion)},n.destroy=function(){var e;return(null===(e=c.director.root)||void 0===e?void 0:e.dataPoolManager)&&c.director.root.dataPoolManager.releaseAnimationClip(this),tG.destroy(this),t.prototype.destroy.call(this)},n[$z]=function(t,e,n){for(var i=1/e,r=this._collectAnimatedJoints(),o=r.length,a={},s=0;s<o;++s)a[r[s]]={transforms:Array.from({length:n},(function(){return new Un}))};var c=r.reduce((function(t,e){return t[e]=new LV,t}),{});for(var l in c){var u=c[l],h=l.lastIndexOf("/");if(h>=0){var _=l.substring(0,h),f=c[_];f&&(u.parent=f)}}for(var p=this._createEvalWithBinder(void 0,(function(t){var e=t.parseTrsPath();if(e){var n=c[e.node];if(n)return VV(n,e.property)}}),void 0),d=0;d<n;++d){var m=t+i*d;p.evaluate(m);for(var v=0;v<o;++v){var g=r[v];Un.copy(a[g].transforms[d],c[g].globalTransform)}for(var y=0;y<o;++y){var x=r[y];c[x].invalidate()}}return{samples:e,frames:n,joints:a}},n.upgradeUntypedTracks=function(t){for(var e=[],n=[],i=this._tracks,r=i.length,o=0;o<r;++o){var a=i[o];if(a instanceof mG){var s=a.upgrade(t);s&&(e.push(s),n.push(a))}}for(var c=n.length,l=0;l<c;++l)te.remove(i,n[l]);i.push.apply(i,e)},n[DV]=function(){return this._searchForRootBonePath()},n.getPropertyCurves=function(){return this._getLegacyData().getPropertyCurves()},n.updateEventDatas=function(){this.events=this._events},n.hasEvents=function(){return 0!==this.events.length},n.syncLegacyData=function(){this._legacyData&&(this._fromLegacy(this._legacyData),this._legacyData=void 0)},n._createEvalWithBinder=function(t,e,n){this._legacyDataDirty&&(this._legacyDataDirty=!1,this.syncLegacyData());var i,r=[];n&&(i=this._createRootMotionEvaluation(t,n,r));for(var o,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l];if(!r.includes(u)&&!Array.from(u.channels()).every((function(t){return 0===t.curve.keyFramesCount}))){var h=e(u[xz]);if(h){var _=u[vz](h);a.push({binding:h,trackEval:_})}}}return this._exoticAnimation&&(o=this._exoticAnimation.createEvaluator(e)),new OV(a,o,i)},n._createRootMotionEvaluation=function(t,e,n){if(t instanceof GT){var i=this._searchForRootBonePath();if(i){var r=t.getChildByPath(i);if(r){for(var o=new NV,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l],h=u[xz].parseTrsPath();if(h&&h.node===i){n.push(u);var _=VV(o,h.property);if(_){var f=u[vz](_);a.push({binding:_,trackEval:f})}}}return new zV(r,this._duration,o,a)}I(3924)}else I(3923)}else D(3920)},n._searchForRootBonePath=function(){var t=this._tracks.map((function(t){var e=t[xz].parseTrsPath();if(e){var n=e.node;return{path:n,rank:n.split("/").length}}return{path:"",rank:0}}));t.sort((function(t,e){return t.rank-e.rank}));var e=t.findIndex((function(t){return 0!==t.rank}));if(e<0)return"";for(var n=t.length,i=t[e],r=!0,o=e+1;o<n;++o){var a=t[o];if(a.rank!==i.rank)break;if(a.path!==i.path){r=!1;break}}return r?i.path:""},n._getLegacyData=function(){return this._legacyData||(this._legacyData=this._toLegacy()),this._legacyData},n._toLegacy=function(){var t=new vG(this._duration);return t.keys=[],t.curves=[],t.commonTargets=[],t},n._fromLegacy=function(t){for(var e=t.toTracks(),n=e.length,i=0;i<n;++i)this.addTrack(e[i])},n._collectAnimatedJoints=function(){for(var t=new Set,e=this._tracks,n=e.length,i=0;i<n;++i){var r=e[i][xz].parseTrsPath();r&&t.add(r.node)}if(this._exoticAnimation)for(var o=this._exoticAnimation.collectAnimatedJoints(),a=o.length,s=0;s<a;++s)t.add(o[s]);return Array.from(t)},K(e,[{key:"duration",get:function(){return this._duration},set:function(t){this._duration=t}},{key:"tracksCount",get:function(){return this._tracks.length}},{key:"tracks",get:function(){return this._tracks}},{key:"hash",get:function(){var t,e;if(this._hash)return this._hash;var n="Exotic:"+(null!==(t=null===(e=this._exoticAnimation)||void 0===e?void 0:e.toHashString())&&void 0!==t?t:"");return this._hash=po(n,666)}},{key:"events",get:function(){return this._events},set:function(t){var e=this;this._events=t;for(var n=[],i=[],r=this.events.sort((function(t,e){return t.frame-e.frame})),o=r.length,a=function(t){var o=r[t],a=o.frame/e._duration,s=n.findIndex((function(t){return t===a}));s<0&&(s=n.length,n.push(a),i.push({events:[]})),i[s].events.push({functionName:o.func,parameters:o.params})},s=0;s<o;++s)a(s);this._runtimeEvents={ratios:n,eventGroups:i}}},{key:BV,get:function(){return this._exoticAnimation}},{key:BV,set:function(t){this._exoticAnimation=t}},{key:"keys",get:function(){return this._getLegacyData().keys}},{key:"keys",set:function(t){this._legacyDataDirty=!0,this._getLegacyData().keys=t}},{key:"curves",get:function(){return this._legacyDataDirty=!0,this._getLegacyData().curves}},{key:"curves",set:function(t){this._getLegacyData().curves=t}},{key:"commonTargets",get:function(){return this._getLegacyData().commonTargets}},{key:"commonTargets",set:function(t){this._legacyDataDirty=!0,this._getLegacyData().commonTargets=t}},{key:"data",get:function(){return this._getLegacyData().data}},{key:"eventGroups",get:function(){return this._runtimeEvents.eventGroups}}]),e}(Pu),bV.WrapMode=Js,dV=st((pV=TV).prototype,"sample",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),mV=st(pV.prototype,"speed",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),vV=st(pV.prototype,"wrapMode",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Js.Normal}}),gV=st(pV.prototype,"enableTrsBlending",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),yV=st(pV.prototype,"_duration",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xV=st(pV.prototype,"_hash",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),SV=st(pV.prototype,"_tracks",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),CV=st(pV.prototype,"_exoticAnimation",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),AV=st(pV.prototype,"_events",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fV=pV))||fV);c.AnimationClip=MV;var OV=function(){function t(t,e,n){this._exoticAnimationEvaluator=void 0,this._trackEvalStatues=[],this._rootMotionEvaluation=void 0,this._trackEvalStatues=t,this._exoticAnimationEvaluator=e,this._rootMotionEvaluation=n}var e=t.prototype;return e.evaluate=function(t){for(var e=this._trackEvalStatues,n=this._exoticAnimationEvaluator,i=e.length,r=0;r<i;++r){var o=e[r],a=o.trackEval,s=o.binding,c=a.evaluate(t,s);s.setValue(c)}n&&n.evaluate(t)},e.evaluateRootMotion=function(t,e){var n=this._rootMotionEvaluation;n&&n.evaluate(t,e)},t}(),NV=function(){function t(){this.position=new En,this.scale=new En(1,1,1),this.rotation=new Mn,this.eulerAngles=new En}return t.prototype.getTransform=function(t){Un.fromRTS(t,this.rotation,this.position,this.scale)},t}(),LV=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).parent=null,e._dirty=!0,e._transform=new Un,e}return Q(e,t),e.prototype.invalidate=function(){this._dirty=!0},K(e,[{key:"globalTransform",get:function(){var t=this._transform;return this._dirty&&(this._dirty=!1,Un.fromRTS(t,this.rotation,this.position,this.scale),this.parent&&Un.multiply(t,this.parent.globalTransform,t)),this._transform}}]),e}(NV),FV=new Un,zV=function(){function t(t,e,n,i){this._initialTransformCache=new Un,this._clipEndTransformCache=new Un,this._startTransformCache=new Un,this._endTransformCache=new Un,this._motionTransformCache=new Un,this._translationMotionCache=new En,this._rotationMotionCache=new Mn,this._scaleMotionCache=new En,this._rootBone=t,this._duration=e,this._boneTransform=n,this._trackEvalStatuses=i}var e=t.prototype;return e.evaluate=function(t,e){var n=this._calcMotionTransform(t,e,this._motionTransformCache),i=this._translationMotionCache,r=this._rotationMotionCache,o=this._scaleMotionCache,a=this._rootBone;Un.toRTS(n,r,i,o),En.add(i,i,a.position),a.setPosition(i),Mn.multiply(r,r,a.rotation),a.setRotation(r),En.multiply(o,o,a.scale),a.setScale(o)},e._calcMotionTransform=function(t,e,n){var i=this._duration,r=i-t,o=this._evaluateAt(t,this._startTransformCache);if(e<r){var a=this._evaluateAt(t+e,this._endTransformCache);GV(n,o,a)}else{Un.identity(n);var s=function(t,e){GV(FV,t,e),Un.multiply(n,n,FV)},c=e-r,l=Math.floor(c/i),u=c-l*i,h=this._evaluateAt(0,this._initialTransformCache),_=this._evaluateAt(i,this._clipEndTransformCache),f=this._evaluateAt(u,this._endTransformCache);s(o,_),GV(FV,h,_);for(var p=0;p<l;++p)Un.multiply(n,n,FV);s(h,f)}return n},e._evaluateAt=function(t,e){for(var n=this._trackEvalStatuses,i=n.length,r=0;r<i;++r){var o=n[r],a=o.trackEval,s=o.binding,c=a.evaluate(t,s);s.setValue(c)}return this._boneTransform.getTransform(e),e},t}();function GV(t,e,n){Un.invert(t,e),Un.multiply(t,n,t)}function VV(t,e){switch(e){default:return;case"position":return{setValue:function(e){En.copy(t.position,e)}};case"rotation":return{setValue:function(e){Mn.copy(t.rotation,e)}};case"scale":return{setValue:function(e){En.copy(t.scale,e)}};case"eulerAngles":return{setValue:function(e){En.copy(t.eulerAngles,e)}}}}var UV=function(){function t(t,e,n,i){this._lastFrameIndex=-1,this._lastIterations=0,this._lastDirection=0,this._ignoreIndex=-1,this._sampled=!1,this._targetNode=t,this._ratios=e,this._eventGroups=n,this._wrapMode=i}var e=t.prototype;return e.setWrapMode=function(t){this._wrapMode=t},e.ignore=function(t,e){this._ignoreIndex=-1,this._sampled=!1;var n=HV(t,this._ratios);n<0&&(n=~n-1,e<0&&(n+=1),this._ignoreIndex=n)},e.sample=function(t,e,n){var i=this._eventGroups.length,r=HV(t,this._ratios);if(r<0&&(r=~r-1,e<0&&(r+=1)),this._ignoreIndex!==r&&(this._ignoreIndex=-1),!this._sampled)return this._sampled=!0,this._doFire(r,!1),this._lastFrameIndex=r,this._lastIterations=n,void(this._lastDirection=e);var o=this._wrapMode,a=kV(n),s=kV(this._lastIterations),c=this._lastFrameIndex,l=this._lastDirection,u=-1!==s&&a!==s;if(c===r&&u&&1===i)this._doFire(0,!1);else if(c!==r||u){e=l;do{if(c!==r){if(-1===e&&0===c&&r>0?((o&Ks.PingPong)===Ks.PingPong?e*=-1:c=i,s++):1===e&&c===i-1&&r<i-1&&((o&Ks.PingPong)===Ks.PingPong?e*=-1:c=-1,s++),c===r)break;if(s>a)break}c+=e,this._doFire(c,!0)}while(c!==r&&c>-1&&c<i)}this._lastFrameIndex=r,this._lastIterations=n,this._lastDirection=e},e._doFire=function(t,e){e?c.director.getAnimationManager().pushDelayEvent(this._checkAndFire,this,[t]):this._checkAndFire(t)},e._checkAndFire=function(t){if(this._targetNode&&this._targetNode.isValid){var e=this._eventGroups;if(!(t<0||t>=e.length||this._ignoreIndex===t))for(var n=e[t],i=this._targetNode.components,r=n.events.length,o=0;o<r;++o)for(var a=n.events[o],s=a.functionName,c=i.length,l=0;l<c;++l){var u=i[l],h=u[s];"function"==typeof h&&h.apply(u,a.parameters)}}},t}();function kV(t){return t-(0|t)==0&&(t-=1),0|t}function HV(t,e){return nc(e,t)}var jV,WV=function(){function t(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}var e=t.prototype;return e.play=function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(N(3912)):(this._isPlaying=!0,this.onPlay())},e.stop=function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)},e.pause=function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())},e.resume=function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())},e.step=function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()},e.update=function(){},e.onPlay=function(){},e.onPause=function(){},e.onResume=function(){},e.onStop=function(){},e.onError=function(){},K(t,[{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isMotionless",get:function(){return!this.isPlaying||this.isPaused}}]),t}(),qV=function(){function t(t){this.weight=0,this._pose=void 0,this._blendStateWriters=[],this._pose=t}var e=t.prototype;return e.destroy=function(){for(var t=0;t<this._blendStateWriters.length;++t)this._pose.destroyWriter(this._blendStateWriters[t]);this._blendStateWriters.length=0},e.createPoseWriter=function(t,e,n){var i=this._pose.createWriter(t,e,this,n);return this._blendStateWriters.push(i),i},t}();!function(t){t.PLAY="play",t.STOP="stop",t.PAUSE="pause",t.RESUME="resume",t.LASTFRAME="lastframe",t.FINISHED="finished"}(jV||(jV={})),ae(jV);var XV=t("AnimationState",function(t){function e(e,n){var i;return void 0===n&&(n=""),(i=t.call(this)||this).duration=1,i.speed=1,i.time=0,i.frameRate=0,i._targetNode=null,i._curveLoaded=!1,i._clip=void 0,i._useSimpleProcess=!1,i._target=null,i._wrapMode=Js.Normal,i._repeatCount=1,i._delay=0,i._delayTime=0,i._currentFramePlayed=!1,i._name=void 0,i._lastIterations=NaN,i._lastWrapInfo=null,i._wrappedInfo=new ec,i._allowLastFrame=!1,i._blendStateWriterHost={weight:0},i._playbackDuration=0,i._invDuration=1,i._poseOutput=null,i._weight=1,i._clipEval=void 0,i._clipEventEval=void 0,i._doNotCreateEval=!1,i._clip=e,i._name=n||e&&e.name,i._playbackRange={min:0,max:e.duration},i._playbackDuration=e.duration,e.duration||C("Clip "+e.name+" has zero duration."),i}Q(e,t);var n=e.prototype;return n.initialize=function(t,e){if(!this._curveLoaded){this._curveLoaded=!0,this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval&&(this._clipEval=void 0),this._targetNode=t;var n=this._clip;if(this.duration=n.duration,this._invDuration=1/this.duration,this.speed=n.speed,this.wrapMode=n.wrapMode,this.frameRate=n.sample,this._playbackRange.min=0,this._playbackRange.max=n.duration,this._playbackDuration=n.duration,(this.wrapMode&Ks.Loop)===Ks.Loop?this.repeatCount=1/0:this.repeatCount=1,!this._doNotCreateEval){var i,r,o,a=null!==(i=null!=e?e:null===(r=c.director.getAnimationManager())||void 0===r?void 0:r.blendState)&&void 0!==i?i:null;a&&(this._poseOutput=new qV(a)),this._clipEval=n.createEvaluator({target:t,pose:null!==(o=this._poseOutput)&&void 0!==o?o:void 0})}this._clipEventEval=n.createEventEvaluator(this._targetNode)}},n.destroy=function(){this.isMotionless||c.director.getAnimationManager().removeAnimation(this),this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval=void 0},n.emit=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];c.director.getAnimationManager().pushDelayEvent(this._emit,this,e)},n.on=function(t,e,n){return this._target&&this._target.isValid?this._target.on(t,e,n):null},n.once=function(t,e,n){return this._target&&this._target.isValid?this._target.once(t,e,n):null},n.off=function(t,e,n){this._target&&this._target.isValid&&this._target.off(t,e,n)},n.allowLastFrameEvent=function(t){this._allowLastFrame=t},n._setEventTarget=function(t){this._target=t},n.setTime=function(t){this._currentFramePlayed=!1,this.time=t||0;var e,n=this.getWrappedInfo(t,this._wrappedInfo);null===(e=this._clipEventEval)||void 0===e||e.ignore(n.ratio,n.direction)},n.update=function(t){this._delayTime>0&&(this._delayTime-=t,this._delayTime>0)||(this._currentFramePlayed?this.time+=t*this.speed:this._currentFramePlayed=!0,this._process())},n.sample=function(){var t=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(t.time),this._sampleEvents(t),t},n.onPlay=function(){this.setTime(this._getPlaybackStart()),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(jV.PLAY,this)},n.onStop=function(){this.isPaused||this._onPauseOrStop(),this.emit(jV.STOP,this)},n.onResume=function(){this._onReplayOrResume(),this.emit(jV.RESUME,this)},n.onPause=function(){this._onPauseOrStop(),this.emit(jV.PAUSE,this)},n._sampleCurves=function(t){var e=this._poseOutput,n=this._clipEval;e&&(e.weight=this.weight),n&&n.evaluate(t)},n._process=function(){this._useSimpleProcess?this.simpleProcess():this.process()},n.process=function(){var t,e=this.sample();this._allowLastFrame&&(t=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new ec(e),this.repeatCount>1&&(0|e.iterations)>(0|t.iterations)&&this.emit(jV.LASTFRAME,this),t.set(e)),e.stopped&&(this.stop(),this.emit(jV.FINISHED,this))},n.simpleProcess=function(){var t=this._playbackRange.min,e=this._playbackDuration,n=this.time%e;n<0&&(n+=e);var i=(t+n)*this._invDuration;this._sampleCurves(t+n),this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(Number.isNaN(this._lastIterations)&&(this._lastIterations=i),(this.time>0&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit(jV.LASTFRAME,this),this._lastIterations=i)},n._needReverse=function(t){var e=this.wrapMode,n=!1;return(e&Ks.PingPong)===Ks.PingPong&&(t-(0|t)==0&&t>0&&(t-=1),1&t&&(n=!n)),(e&Ks.Reverse)===Ks.Reverse&&(n=!n),n},n.getWrappedInfo=function(t,e){e=e||new ec;var n=this._getPlaybackStart(),i=this._getPlaybackEnd()-n,r=!1,o=this.repeatCount,a=(t-=n)>0?t/i:-t/i;if(a>=o){a=o,r=!0;var s=o-(0|o);0===s&&(s=1),t=s*i*(t>0?1:-1)}if(t>i){var c=t%i;t=0===c?i:c}else t<0&&0!=(t%=i)&&(t+=i);var l=!1,u=this._wrapMode&Ks.ShouldWrap;u&&(l=this._needReverse(a));var h=l?-1:1;return this.speed<0&&(h*=-1),u&&l&&(t=i-t),e.time=n+t,e.ratio=e.time/this.duration,e.direction=h,e.stopped=r,e.iterations=a,e},n._getPlaybackStart=function(){return this._playbackRange.min},n._getPlaybackEnd=function(){return this._playbackRange.max},n._sampleEvents=function(t){var e;null===(e=this._clipEventEval)||void 0===e||e.sample(t.ratio,t.direction,t.iterations)},n._emit=function(t,e){this._target&&this._target.isValid&&this._target.emit(t,t,e)},n._onReplayOrResume=function(){c.director.getAnimationManager().addAnimation(this)},n._onPauseOrStop=function(){c.director.getAnimationManager().removeAnimation(this)},K(e,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(t){var e;this._wrapMode=t,this.time=0,t&Ks.Loop?this.repeatCount=1/0:this.repeatCount=1,null===(e=this._clipEventEval)||void 0===e||e.setWrapMode(t)}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(t){this._repeatCount=t;var e=this._wrapMode&Ks.ShouldWrap,n=(this.wrapMode&Ks.Reverse)===Ks.Reverse;this._useSimpleProcess=t===1/0&&!e&&!n}},{key:"delay",get:function(){return this._delay},set:function(t){this._delayTime=this._delay=t}},{key:"playbackRange",get:function(){return this._playbackRange},set:function(t){t.max,t.min,this._playbackRange.min=Math.max(t.min,0),this._playbackRange.max=Math.min(t.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}},{key:"current",get:function(){return this.getWrappedInfo(this.time).time}},{key:"ratio",get:function(){return this.current/this.duration}},{key:"weight",get:function(){return this._weight},set:function(t){this._weight=t,this._poseOutput&&(this._poseOutput.weight=t)}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),e}(WV));c.AnimationState=XV;var YV,KV,JV,QV,ZV,$V,tU,eU,nU,iU,rU,oU,aU,sU,cU,lU,uU,hU=function(t){function e(e){var n;return(n=t.call(this)||this)._managedStates=[],n._fadings=[],n._scheduled=!1,n._scheduler=null!=e?e:c.director.getAnimationManager(),n}Q(e,t);var n=e.prototype;return n.update=function(t){if(!this.isMotionless){var e=this._managedStates,n=this._fadings;if(1===e.length&&1===n.length){var i=e[0].state;i&&(i.weight=1)}else this._calculateWeights(t);1===e.length&&1===n.length&&this._unscheduleThis()}},n.crossFade=function(t,e){var n;0===this._managedStates.length&&(e=0),0===e&&this.clear();var i=this._managedStates.find((function(e){return e.state===t}));i?(null===(n=i.state)||void 0===n?void 0:n.isMotionless)&&i.state.play():(i={state:t,reference:0},t&&t.play(),this._managedStates.push(i)),++i.reference,this._fadings.unshift({easeDuration:e,easeTime:0,target:i}),this.isMotionless||this._scheduleThis()},n.clear=function(){for(var t=0;t<this._managedStates.length;++t){var e=this._managedStates[t].state;e&&e.stop()}this._managedStates.length=0,this._fadings.length=0},n.onPlay=function(){t.prototype.onPlay.call(this),this._scheduleThis()},n.onPause=function(){t.prototype.onPause.call(this);for(var e=0;e<this._managedStates.length;++e){var n=this._managedStates[e].state;n&&n.pause()}this._unscheduleThis()},n.onResume=function(){t.prototype.onResume.call(this);for(var e=0;e<this._managedStates.length;++e){var n=this._managedStates[e].state;n&&n.resume()}this._scheduleThis()},n.onStop=function(){t.prototype.onStop.call(this),this.clear()},n._calculateWeights=function(t){for(var e=this._managedStates,n=this._fadings,i=0;i<e.length;++i){var r=e[i].state;r&&(r.weight=0)}for(var o=1,a=n.length,s=0;s<n.length;++s){var c=n[s];c.easeTime+=t;var l=0===c.easeDuration?1:an(c.easeTime/c.easeDuration),u=l*o;if(o*=1-l,c.target.state&&(c.target.state.weight+=u),c.easeTime>=c.easeDuration){a=s+1,c.easeTime=c.easeDuration;break}}if(a!==n.length){for(var h=a;h<n.length;++h){var _=n[h];--_.target.reference,_.target.reference<=0&&(_.target.state&&_.target.state.stop(),ht(this._managedStates,_.target))}n.splice(a)}},n._scheduleThis=function(){this._scheduled||(this._scheduler.addCrossFade(this),this._scheduled=!0)},n._unscheduleThis=function(){this._scheduled&&(this._scheduler.removeCrossFade(this),this._scheduled=!1)},e}(WV),_U=function(e){return t({AnimationComponent:e,Animation:e}),e}((YV=hc("cc.Animation"),KV=wc(),JV=fc(99),QV=Ac(),ZV=Wc([MV]),$V=Bc(),tU=Wc(MV),eU=Bc(),nU=Bc(),iU=Wc([MV]),YV(rU=KV(rU=JV(rU=Cc(rU=QV((uU=lU=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"playOnLoad",aU,it(e)),e._crossFade=new hU,e._nameToState=Et(!0),at(e,"_clips",sU,it(e)),at(e,"_defaultClip",cU,it(e)),e._hasBeenPlayed=!1,e}Q(e,t);var n=e.prototype;return n.onLoad=function(){for(var t in this.clips=this._clips,this._nameToState)this._nameToState[t].initialize(this.node)},n.start=function(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)},n.onEnable=function(){this._crossFade.resume()},n.onDisable=function(){this._crossFade.pause()},n.onDestroy=function(){for(var t in this._crossFade.stop(),this._nameToState)this._nameToState[t].destroy();this._nameToState=Et(!0)},n.play=function(t){if(this._hasBeenPlayed=!0,!t){if(!this._defaultClip)return;t=this._defaultClip.name}this.crossFade(t,0)},n.crossFade=function(t,e){void 0===e&&(e=.3),this._hasBeenPlayed=!0;var n=this._nameToState[t];n&&this.doPlayOrCrossFade(n,e)},n.pause=function(){this._crossFade.pause()},n.resume=function(){this._crossFade.resume()},n.stop=function(){this._crossFade.stop()},n.getAnimationState=function(t){return this.getState(t)},n.getState=function(t){var e=this._nameToState[t];return e&&!e.curveLoaded&&e.initialize(this.node),e||null},n.createState=function(t,e){return e=e||t.name,this.removeState(e),this._doCreateState(t,e)},n.removeState=function(t){var e=this._nameToState[t];e&&(e.allowLastFrameEvent(!1),e.stop(),delete this._nameToState[t])},n.addClip=function(t,e){return _t(this._clips,t)||this._clips.push(t),this.createState(t,e)},n.removeClip=function(t,e){var n;for(var i in this._nameToState){var r=this._nameToState[i];if(r.clip===t){n=r;break}}if(t===this._defaultClip){if(!e)return void I(3902);this._defaultClip=null}if(n&&n.isPlaying){if(!e)return void I(3903);n.stop()}this._clips=this._clips.filter((function(e){return e!==t})),n&&delete this._nameToState[n.name]},n.on=function(e,n,i,r){var o=t.prototype.on.call(this,e,n,i,r);return e===jV.LASTFRAME&&this._syncAllowLastFrameEvent(),o},n.once=function(e,n,i){var r=t.prototype.once.call(this,e,n,i);return e===jV.LASTFRAME&&this._syncAllowLastFrameEvent(),r},n.off=function(e,n,i){t.prototype.off.call(this,e,n,i),e===jV.LASTFRAME&&this._syncDisallowLastFrameEvent()},n._createState=function(t,e){return new XV(t,e)},n._doCreateState=function(t,e){var n=this._createState(t,e);return n._setEventTarget(this),n.allowLastFrameEvent(this.hasEventListener(jV.LASTFRAME)),this.node&&n.initialize(this.node),this._nameToState[n.name]=n,n},n.doPlayOrCrossFade=function(t,e){this._crossFade.play(),this._crossFade.crossFade(t,e)},n._removeStateOfAutomaticClip=function(t){for(var e in this._nameToState){var n=this._nameToState[e];fU(t,n.clip)&&(n.stop(),delete this._nameToState[e])}},n._syncAllowLastFrameEvent=function(){if(this.hasEventListener(jV.LASTFRAME))for(var t in this._nameToState)this._nameToState[t].allowLastFrameEvent(!0)},n._syncDisallowLastFrameEvent=function(){if(!this.hasEventListener(jV.LASTFRAME))for(var t in this._nameToState)this._nameToState[t].allowLastFrameEvent(!1)},K(e,[{key:"clips",get:function(){return this._clips},set:function(t){var e=this;this._crossFade&&this._crossFade.clear();for(var n,i=ot(this._clips);!(n=i()).done;){var r=n.value;r&&this._removeStateOfAutomaticClip(r)}for(var o,a=ot(t);!(o=a()).done;){var s=o.value;s&&this.createState(s)}var c=t.find((function(t){return fU(t,e._defaultClip)}));this._defaultClip=c||null,this._clips=t}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(t){this._defaultClip=t,t&&(this._clips.findIndex((function(e){return fU(e,t)}))>=0||(this._clips.push(t),this.createState(t)))}}]),e}(Jl(Ku)),lU.EventType=jV,st((oU=uU).prototype,"clips",[ZV,$V],Object.getOwnPropertyDescriptor(oU.prototype,"clips"),oU.prototype),st(oU.prototype,"defaultClip",[tU,eU],Object.getOwnPropertyDescriptor(oU.prototype,"defaultClip"),oU.prototype),aU=st(oU.prototype,"playOnLoad",[vc,nU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),sU=st(oU.prototype,"_clips",[iU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cU=st(oU.prototype,"_defaultClip",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rU=oU))||rU)||rU)||rU)||rU)||rU));function fU(t,e){return t===e||!!t&&!!e&&t._uuid===e._uuid&&t._uuid}c.Animation=_U,z(_U.prototype,"Animation",[{name:"getAnimationState",newName:"getState"},{name:"addClip",newName:"createState"},{name:"removeClip",newName:"removeState",customFunction:function(){var t=arguments.length<=0?void 0:arguments[0];return _U.prototype.removeState.call(this,t.name)}}]),c.AnimationComponent=_U,ee.setClassAlias(_U,"cc.AnimationComponent");var pU,dU,mU,vU=function(){function t(){this._nodeBlendStates=new Map}var e=t.prototype;return e.createWriter=function(t,e,n,i){var r=this.ref(t,e);return new gU(t,e,r,n,i)},e.destroyWriter=function(t){var e=t;this.deRef(e.node,e.property)},e.ref=function(t,e){var n=this._nodeBlendStates.get(t);return n||(n=new CU,this._nodeBlendStates.set(t,n)),n.refProperty(e)},e.deRef=function(t,e){var n=this._nodeBlendStates.get(t);n&&(n.deRefProperty(e),n.empty&&this._nodeBlendStates.delete(t))},e.apply=function(){this._nodeBlendStates.forEach((function(t,e){t.apply(e)}))},t}(),gU=function(){function t(t,e,n,i,r){this._node=t,this._property=e,this._propertyBlendState=n,this._host=i,this._constants=r}var e=t.prototype;return e.getValue=function(){return this._node[this._property]},e.setValue=function(t){var e=this._propertyBlendState,n=this._host.weight;e.blend(t,n)},K(t,[{key:"node",get:function(){return this._node}},{key:"property",get:function(){return this._property}}]),t}(),yU=function(t){this.blendedWeight=0,this.blendedValue=void 0,this.refCount=0,this.blendedValue=t},xU=function(t){function e(){return t.call(this,new En)||this}Q(e,t);var n=e.prototype;return n.blend=function(t,e){var n=this.blendedValue;1===e?En.copy(n,t):En.scaleAndAdd(n,n,t,e),this.blendedWeight+=e},n.reset=function(){this.blendedWeight=0,En.zero(this.blendedValue)},e}(yU),SU=function(t){function e(){return t.call(this,new Mn)||this}Q(e,t);var n=e.prototype;return n.blend=function(t,e){if(0!==e){var n=this.blendedValue,i=this.blendedWeight;if(1===e)Mn.copy(n,t);else{var r=e/(i+e);Mn.slerp(n,n,t,r)}this.blendedWeight+=e}},n.reset=function(){this.blendedWeight=0,Mn.identity(this.blendedValue)},e}(yU),CU=function(){function t(){this._properties={}}var e=t.prototype;return e.refProperty=function(t){var e,n,i,r=this._properties;switch(t){default:case"position":case"scale":case"eulerAngles":i=null!==(e=r[t])&&void 0!==e?e:r[t]=new xU;break;case"rotation":i=null!==(n=r[t])&&void 0!==n?n:r[t]=new SU}return++i.refCount,i},e.deRefProperty=function(t){var e=this._properties,n=e[t];n&&(--n.refCount,n.refCount>0||delete e[t])},e.apply=function(t){var e,n,i,r=this._properties,o=r.position,a=r.scale,s=r.rotation,c=r.eulerAngles,l=!1,u=!1,h=!1,_=!1;o&&o.blendedWeight&&(l=!0,o.blendedWeight<1&&o.blend(t.position,1-o.blendedWeight),e=o.blendedValue),a&&a.blendedWeight&&(u=!0,a.blendedWeight<1&&a.blend(t.scale,1-a.blendedWeight),n=a.blendedValue),c&&c.blendedWeight&&(_=!0,c.blendedWeight<1&&c.blend(t.eulerAngles,1-c.blendedWeight),i=c.blendedValue),s&&s.blendedWeight&&(h=!0,s.blendedWeight<1&&s.blend(t.rotation,1-s.blendedWeight),i=s.blendedValue),(i||e||n)&&t.setRTS(i,e,n),l&&o.reset(),u&&a.reset(),h&&s.reset(),_&&c.reset()},K(t,[{key:"empty",get:function(){var t=this._properties;return!(t.position||t.rotation||t.eulerAngles||t.scale)}}]),t}(),AU=[],bU=new Map;function TU(t,e){for(var n=0,i=Un.IDENTITY;t;){if(t.stamp===e||t.stamp+1===e&&!t.node.hasChangedFlags){i=t.world,t.stamp=e;break}t.stamp=e,AU[n++]=t,t=t.parent}for(;n>0;){t=AU[--n],AU[n]=null;var r=t.node;Un.fromRTS(t.local,r.rotation,r.position,r.scale),i=Un.multiply(t.world,i,t.local)}return i}function EU(t,e){for(var n,i=null,r=0;t!==e;){var o=t.uuid;if(bU.has(o)){i=bU.get(o);break}i={node:t,local:new Un,world:new Un,stamp:-1,parent:null},bU.set(o,i),AU[r++]=i,t=t.parent,i=null}for(;r>0;)n=AU[--r],AU[r]=null,n.parent=i,i=n;return i}function wU(t){for(var e=bU.get(t.uuid)||null;e;)bU.delete(e.node.uuid),e=e.parent}var PU=t("AnimationManager",hc((mU=dU=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._anims=new ct([]),e._crossFades=new ct([]),e._delayEvents=[],e._blendStateBuffer=new vU,e._sockets=[],e}Q(e,t);var n=e.prototype;return n.addCrossFade=function(t){-1===this._crossFades.array.indexOf(t)&&this._crossFades.push(t)},n.removeCrossFade=function(t){var e=this._crossFades.array.indexOf(t);e>=0?this._crossFades.fastRemoveAt(e):D(3907)},n.update=function(t){var e=this._delayEvents,n=this._crossFades,i=this._sockets,r=n.array;for(n.i=0;n.i<r.length;++n.i)r[n.i].update(t);var o=this._anims,a=o.array;for(o.i=0;o.i<a.length;++o.i){var s=a[o.i];s.isMotionless||s.update(t)}this._blendStateBuffer.apply();for(var l=c.director.getTotalFrames(),u=0,h=i.length;u<h;u++){var _=i[u],f=_.target,p=_.transform;f.matrix=TU(p,l)}for(var d=0,m=e.length;d<m;d++){var v=e[d];v.fn.apply(v.thisArg,v.args)}e.length=0},n.destruct=function(){},n.addAnimation=function(t){-1===this._anims.array.indexOf(t)&&this._anims.push(t)},n.removeAnimation=function(t){var e=this._anims.array.indexOf(t);e>=0?this._anims.fastRemoveAt(e):D(3907)},n.pushDelayEvent=function(t,e,n){this._delayEvents.push({fn:t,thisArg:e,args:n})},n.addSockets=function(t,e){for(var n=this,i=function(i){var r=e[i];if(n._sockets.find((function(t){return t.target===r.target})))return"continue";var o=t.getChildByPath(r.path),a=r.target&&o&&EU(o,t);a&&n._sockets.push({target:r.target,transform:a})},r=0;r<e.length;++r)i(r)},n.removeSockets=function(t,e){for(var n=0;n<e.length;++n)for(var i=e[n],r=0;r<this._sockets.length;++r){var o=this._sockets[r];if(o.target===i.target){wU(o.transform.node),this._sockets[r]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}},K(e,[{key:"blendState",get:function(){return this._blendStateBuffer}}]),e}(bM),dU.ID="animation",pU=mU))||pU);zM.on(FM.EVENT_INIT,(function(){var t=new PU;zM.registerSystem(PU.ID,t,bM.Priority.HIGH)})),c.AnimationManager=PU;var IU,RU,DU,BU,MU=new Un;function OU(t,e,n){for(Un.identity(n);t!==e;)Un.fromRTS(MU,t.rotation,t.position,t.scale),Un.multiply(n,MU,n),t=t.parent;return n}c.easing=J_;var NU=t("HierachyModifier",hc("cc.HierachyModifier")(IU=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e}(BF))||IU);c.HierachyModifier=NU;var LU=t("ComponentModifier",hc("cc.ComponentModifier")(RU=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e}(MF))||RU);c.ComponentModifier=LU;var FU=t("CurveValueAdapter",hc("cc.CurveValueAdapter")(DU=function(){function t(){}return t.prototype.forTarget=function(){return{set:function(){}}},t}())||DU);c.CurveValueAdapter=FU;var zU=t("UniformCurveValueAdapter",hc("cc.UniformCurveValueAdapter")(BU=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e}(OF))||BU);function GU(t){return"string"==typeof t}function VU(t){return"number"==typeof t}function UU(t,e){return t instanceof e}c.UniformCurveValueAdapter=zU,c.isPropertyModifier=GU,c.isElementModifier=VU,c.isCustomTargetModifier=UU,c.math=ri,c.geometry=Pp;var kU=new En,HU=new Un;function jU(t,e,n,i){var r=n.chunk,o=n.data,a=r.vb,s=n.vertexCount;t.getWorldMatrix(HU);for(var c=0,l=0;l<s;l++){var u=o[l];En.set(kU,u.x,u.y,0),En.transformMat4(kU,kU,HU),a[c++]=kU.x,a[c++]=kU.y,a[c++]=kU.z,bn.toArray(a,i,c+2),c+=6}for(var h=r.bufferId,_=r.vertexOffset,f=r.vertexAccessor.getMeshBuffer(r.bufferId),p=r.vertexAccessor.getIndexBuffer(h),d=f.indexOffset,m=0,v=s/4;m<v;m++){var g=_+4*m;p[d++]=g,p[d++]=g+1,p[d++]=g+2,p[d++]=g+1,p[d++]=g+3,p[d++]=g+2}f.indexOffset+=n.indexCount,f.setDirty()}var WU=function(){function t(t,e){this._texture=void 0,this._width=void 0,this._height=void 0,this._x=void 0,this._y=void 0,this._nexty=void 0,this._innerTextureInfos={},this._innerSpriteFrames=void 0,this._count=void 0;var n=new qU;n.initWithSize(t,e),this._texture=n,this._width=t,this._height=e,this._x=2,this._y=2,this._nexty=2,this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0}var e=t.prototype;return e.insertSpriteFrame=function(t){var e=t.rect,n=t.texture,i=this._innerTextureInfos[n.getId()],r=e.x,o=e.y;if(i)r+=i.x,o+=i.y;else{var a=n.width,s=n.height;if(this._x+a+2>this._width&&(this._x=2,this._y=this._nexty),this._y+s+2>this._nexty&&(this._nexty=this._y+s+2),this._nexty>this._height)return null;c.internal.dynamicAtlasManager.textureBleeding&&((a<=8||s<=8)&&(this._texture.drawTextureAt(n.image,this._x-1,this._y-1),this._texture.drawTextureAt(n.image,this._x-1,this._y+1),this._texture.drawTextureAt(n.image,this._x+1,this._y-1),this._texture.drawTextureAt(n.image,this._x+1,this._y+1)),this._texture.drawTextureAt(n.image,this._x-1,this._y),this._texture.drawTextureAt(n.image,this._x+1,this._y),this._texture.drawTextureAt(n.image,this._x,this._y-1),this._texture.drawTextureAt(n.image,this._x,this._y+1)),this._texture.drawTextureAt(n.image,this._x,this._y),this._innerTextureInfos[n.getId()]={x:this._x,y:this._y,texture:n},this._count++,r+=this._x,o+=this._y,this._x+=a+2}var l={x:r,y:o,texture:this._texture};return this._innerSpriteFrames.push(t),l},e.deleteInnerTexture=function(t){t&&this._innerTextureInfos[t.getId()]&&(delete this._innerTextureInfos[t.getId()],this._count--)},e.isEmpty=function(){return this._count<=0},e.reset=function(){this._x=2,this._y=2,this._nexty=2;for(var t=this._innerSpriteFrames,e=0,n=t.length;e<n;e++){var i=t[e];i.isValid&&i._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}},e.destroy=function(){this.reset(),this._texture.destroy()},t}(),qU=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.initWithSize=function(t,e,n){void 0===n&&(n=Em.RGBA8888),this.reset({width:t,height:e,format:n})},n.drawTextureAt=function(t,e,n){var i=this.getGFXTexture();if(t&&i){var r=this._getGFXDevice();if(r){var o=new ir;o.texOffset.x=e,o.texOffset.y=n,o.texExtent.width=t.width,o.texExtent.height=t.height,r.copyTexImagesToTexture([t.data],i,[o])}else console.warn("Unable to get device")}},e}(gv),XU=function(){function t(){this._atlases=[],this._atlasIndex=-1,this._maxAtlasCount=5,this._textureSize=2048,this._maxFrameSize=512,this._textureBleeding=!0,this._enabled=!1}var e=t.prototype;return e.newAtlas=function(){var t=this._atlases[++this._atlasIndex];return t||(t=new WU(this._textureSize,this._textureSize),this._atlases.push(t)),t},e.beforeSceneLoad=function(){this.reset()},e.insertSpriteFrame=function(t){if(!this._enabled||this._atlasIndex===this._maxAtlasCount||!t||t._original)return null;if(!t.packable)return null;var e=t.texture.getSamplerInfo();if(e.minFilter!==Pm.LINEAR||e.magFilter!==Pm.LINEAR||e.mipFilter!==Pm.NONE)return null;var n=this._atlases[this._atlasIndex];n||(n=this.newAtlas());var i=n.insertSpriteFrame(t);return i||this._atlasIndex===this._maxAtlasCount?i:(n=this.newAtlas()).insertSpriteFrame(t)},e.reset=function(){for(var t=0,e=this._atlases.length;t<e;t++)this._atlases[t].destroy();this._atlases.length=0,this._atlasIndex=-1},e.deleteAtlasSpriteFrame=function(t){if(t._original){for(var e,n=this._atlases.length-1;n>=0;n--)e=this._atlases[n],ee.array.fastRemove(e._innerSpriteFrames,t);var i=t._original._texture;this.deleteAtlasTexture(i)}},e.deleteAtlasTexture=function(t){if(t)for(var e=this._atlases.length-1;e>=0;e--)this._atlases[e].deleteInnerTexture(t),this._atlases[e].isEmpty()&&(this._atlases[e].destroy(),this._atlases.splice(e,1),this._atlasIndex--)},e.packToDynamicAtlas=function(t,e){if(e&&!e._original&&e.packable&&e.texture&&e.texture.width>0&&e.texture.height>0){var n=this.insertSpriteFrame(e);n&&e._setDynamicAtlasFrame(n)}},K(t,[{key:"enabled",get:function(){return this._enabled},set:function(t){this._enabled!==t&&(t?(this.reset(),c.director.on(c.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)):(this.reset(),c.director.off(c.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)),this._enabled=t)}},{key:"maxAtlasCount",get:function(){return this._maxAtlasCount},set:function(t){this._maxAtlasCount=t}},{key:"atlasCount",get:function(){return this._atlases.length}},{key:"textureBleeding",get:function(){return this._textureBleeding},set:function(t){this._textureBleeding=t}},{key:"textureSize",get:function(){return this._textureSize},set:function(t){this._textureSize=t}},{key:"maxFrameSize",get:function(){return this._maxFrameSize},set:function(t){this._maxFrameSize=t}}]),t}();XU.instance=void 0;var YU,KU,JU,QU=t("dynamicAtlasManager",XU.instance=new XU);c.internal.dynamicAtlasManager=QU;var ZU,$U,tk,ek,nk=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],ik=t("SpriteFrame",hc("cc.SpriteFrame")((JU=KU=function(t){function e(){var e;return(e=t.call(this)||this).vertices=null,e.uv=[],e.unbiasUV=[],e.uvSliced=[],e._rect=new ti,e._offset=new Wn,e._originalSize=new Zn,e._rotated=!1,e._capInsets=[0,0,0,0],e._atlasUuid="",e._texture=void 0,e._isFlipUVY=!1,e._isFlipUVX=!1,e._original=null,e._packable=!0,e}Q(e,t),e.createWithImage=function(t){var n=t instanceof Km?t:new Km(t),i=new gv;i.image=n;var r=new e;return r.texture=i,r};var n=e.prototype;return n.textureLoaded=function(){return!!this.texture},n.isRotated=function(){return this._rotated},n.setRotated=function(t){this.rotated=t},n.getRect=function(t){return t?(t.set(this._rect),t):this._rect.clone()},n.setRect=function(t){this.rect=t},n.getOriginalSize=function(t){return t?(t.set(this._originalSize),t):this._originalSize.clone()},n.setOriginalSize=function(t){this.originalSize=t},n.getOffset=function(t){return t?(t.set(this._offset),t):this._offset.clone()},n.setOffset=function(t){this.offset=t},n.getGFXTexture=function(){return this._texture.getGFXTexture()},n.getGFXSampler=function(){return this._texture.getGFXSampler()},n.getHash=function(){return this._texture.getHash()},n.getSamplerInfo=function(){return this._texture.getSamplerInfo()},n.reset=function(t,e){void 0===e&&(e=!1);var n=!1;e&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,n=!0),t&&(t.texture&&(this._rect.x=this._rect.y=0,this._rect.width=t.texture.width,this._rect.height=t.texture.height,this._refreshTexture(t.texture),this.checkRect(this._texture)),t.originalSize&&this._originalSize.set(t.originalSize),t.rect&&this._rect.set(t.rect),t.offset&&this._offset.set(t.offset),void 0!==t.borderTop&&(this._capInsets[1]=t.borderTop),void 0!==t.borderBottom&&(this._capInsets[3]=t.borderBottom),void 0!==t.borderLeft&&(this._capInsets[0]=t.borderLeft),void 0!==t.borderRight&&(this._capInsets[2]=t.borderRight),void 0!==t.isRotate&&(this._rotated=!!t.isRotate),void 0!==t.isFlipUv&&(this._isFlipUVY=!!t.isFlipUv),n=!0),n&&this.texture&&this._calculateUV()},n.checkRect=function(t){var e=this._rect,n=e.x,i=e.y;return this._rotated?(n+=e.height,i+=e.width):(n+=e.width,i+=e.height),n>t.width?(D(3300,this.name+"/"+t.name,n,t.width),!1):!(i>t.height&&(D(3301,this.name+"/"+t.name,i,t.height),1))},n.destroy=function(){return this._packable&&QU&&QU.deleteAtlasSpriteFrame(this),t.prototype.destroy.call(this)},n._calculateSlicedUV=function(){var t=this._rect,n=this.texture,i=n.width,r=n.height,o=this._capInsets[0],a=this._capInsets[2],s=t.width-o-a,c=this._capInsets[1],l=this._capInsets[3],u=t.height-c-l,h=this.uvSliced;if(h.length=0,this._rotated){nk[0].u=t.x/i,nk[1].u=(t.x+l)/i,nk[2].u=(t.x+l+u)/i,nk[3].u=(t.x+t.height)/i,nk[3].v=t.y/r,nk[2].v=(t.y+o)/r,nk[1].v=(t.y+o+s)/r,nk[0].v=(t.y+t.width)/r;for(var _=0;_<4;++_)for(var f=nk[_],p=0;p<4;++p){var d=nk[3-p];h.push({u:f.u,v:d.v})}}else{nk[0].u=t.x/i,nk[1].u=(t.x+o)/i,nk[2].u=(t.x+o+s)/i,nk[3].u=(t.x+t.width)/i,nk[3].v=t.y/r,nk[2].v=(t.y+c)/r,nk[1].v=(t.y+c+u)/r,nk[0].v=(t.y+t.height)/r;for(var m=0;m<4;++m)for(var v=nk[m],g=0;g<4;++g){var y=nk[g];h.push({u:y.u,v:v.v})}}this.emit(e.EVENT_UV_UPDATED,this)},n._calculateUV=function(){var t=this._rect,e=this.uv,n=this.unbiasUV,i=this.texture,r=i.width,o=i.height;if(this._rotated){var a=0===r?0:t.x/r,s=0===r?1:(t.x+t.height)/r,c=0===o?0:t.y/o,l=0===o?1:(t.y+t.width)/o;this._isFlipUVX&&this._isFlipUVY?(e[0]=s,e[1]=l,e[2]=s,e[3]=c,e[4]=a,e[5]=l,e[6]=a,e[7]=c):this._isFlipUVX?(e[0]=s,e[1]=c,e[2]=s,e[3]=l,e[4]=a,e[5]=c,e[6]=a,e[7]=l):this._isFlipUVY?(e[0]=a,e[1]=l,e[2]=a,e[3]=c,e[4]=s,e[5]=l,e[6]=s,e[7]=c):(e[0]=a,e[1]=c,e[2]=a,e[3]=l,e[4]=s,e[5]=c,e[6]=s,e[7]=l);var u=0===r?0:t.x/r,h=0===r?1:(t.x+t.height)/r,_=0===o?0:t.y/o,f=0===o?1:(t.y+t.width)/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=h,n[1]=f,n[2]=h,n[3]=_,n[4]=u,n[5]=f,n[6]=u,n[7]=_):this._isFlipUVX?(n[0]=h,n[1]=_,n[2]=h,n[3]=f,n[4]=u,n[5]=_,n[6]=u,n[7]=f):this._isFlipUVY?(n[0]=u,n[1]=f,n[2]=u,n[3]=_,n[4]=h,n[5]=f,n[6]=h,n[7]=_):(n[0]=u,n[1]=_,n[2]=u,n[3]=f,n[4]=h,n[5]=_,n[6]=h,n[7]=f)}else{var p=0===r?0:t.x/r,d=0===r?1:(t.x+t.width)/r,m=0===o?1:(t.y+t.height)/o,v=0===o?0:t.y/o;this._isFlipUVX&&this._isFlipUVY?(e[0]=d,e[1]=v,e[2]=p,e[3]=v,e[4]=d,e[5]=m,e[6]=p,e[7]=m):this._isFlipUVX?(e[0]=d,e[1]=m,e[2]=p,e[3]=m,e[4]=d,e[5]=v,e[6]=p,e[7]=v):this._isFlipUVY?(e[0]=p,e[1]=v,e[2]=d,e[3]=v,e[4]=p,e[5]=m,e[6]=d,e[7]=m):(e[0]=p,e[1]=m,e[2]=d,e[3]=m,e[4]=p,e[5]=v,e[6]=d,e[7]=v);var g=0===r?0:t.x/r,y=0===r?1:(t.x+t.width)/r,x=0===o?1:(t.y+t.height)/o,S=0===o?0:t.y/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=y,n[1]=S,n[2]=g,n[3]=S,n[4]=y,n[5]=x,n[6]=g,n[7]=x):this._isFlipUVX?(n[0]=y,n[1]=x,n[2]=g,n[3]=x,n[4]=y,n[5]=S,n[6]=g,n[7]=S):this._isFlipUVY?(n[0]=g,n[1]=S,n[2]=y,n[3]=S,n[4]=g,n[5]=x,n[6]=y,n[7]=x):(n[0]=g,n[1]=x,n[2]=y,n[3]=x,n[4]=g,n[5]=S,n[6]=y,n[7]=S)}var C=this.vertices;if(C){C.nu.length=0,C.nv.length=0;for(var A=0;A<C.u.length;A++)C.nu[A]=C.u[A]/r,C.nv[A]=C.v[A]/o}this._calculateSlicedUV()},n._setDynamicAtlasFrame=function(t){t&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=t.texture,this._rect.x=t.x,this._rect.y=t.y,this._calculateUV())},n._resetDynamicAtlasFrame=function(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())},n._checkPackable=function(){var t=QU;if(t){var e=this._texture;if(e instanceof gv&&!e.isCompressed){var n=this.width,i=this.height;!e.image||n>t.maxFrameSize||i>t.maxFrameSize?this._packable=!1:e.image&&e.image instanceof HTMLCanvasElement&&(this._packable=!0)}else this._packable=!1}},n._serialize=function(){return null},n._deserialize=function(t){var e=t,n=e.rect;n&&(this._rect=new ti(n.x,n.y,n.width,n.height));var i=e.offset;e.offset&&(this._offset=new Wn(i.x,i.y));var r=e.originalSize;e.originalSize&&(this._originalSize=new Zn(r.width,r.height)),this._rotated=!!e.rotated,this._name=e.name,this._packable=!!e.packable;var o=e.capInsets;o&&(this._capInsets[0]=o[0],this._capInsets[1]=o[1],this._capInsets[2]=o[2],this._capInsets[3]=o[3]),this.vertices=e.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])},n.clone=function(){var t,n,i,r,o,a,s,c,l=new e,u=this.vertices;return l.vertices=u?{x:u.x,y:u.y,triangles:u.triangles,nu:null===(t=u.nu)||void 0===t?void 0:t.slice(0),u:null===(n=u.u)||void 0===n?void 0:n.slice(0),nv:null===(i=u.nv)||void 0===i?void 0:i.slice(0),v:null===(r=u.v)||void 0===r?void 0:r.slice(0)}:null,(o=l.uv).splice.apply(o,[0,l.uv.length].concat(this.uv)),(a=l.unbiasUV).splice.apply(a,[0,l.unbiasUV.length].concat(this.unbiasUV)),(s=l.uvSliced).splice.apply(s,[0,l.uvSliced.length].concat(this.uvSliced)),l._rect.set(this._rect),l._offset.set(this._offset),l._originalSize.set(this._originalSize),l._rotated=this._rotated,(c=l._capInsets).splice.apply(c,[0,l._capInsets.length].concat(this._capInsets)),l._atlasUuid=this._atlasUuid,l._texture=this._texture,l._isFlipUVX=this._isFlipUVX,l._isFlipUVY=this._isFlipUVY,l},n._refreshTexture=function(t){this._texture=t;var e=this._texture,n={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(e)||(n.rect=new ti(0,0,e.width,e.height),i=!0),(0===this._originalSize.width||0===this._originalSize.height||i)&&(n.originalSize=new Zn(e.width,e.height),i=!0),i&&(this.reset(n),this.onLoaded()),this._checkPackable()},n.initDefault=function(e){t.prototype.initDefault.call(this,e);var n=new gv;n.initDefault(),this._refreshTexture(n),this._calculateUV()},n.validate=function(){return this._texture&&this._rect&&0!==this._rect.width&&0!==this._rect.height},K(e,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(t){this._capInsets[1]!==t&&(this._capInsets[1]=t,this._texture&&this._calculateSlicedUV())}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(t){this._capInsets[3]!==t&&(this._capInsets[3]=t,this._texture&&this._calculateSlicedUV())}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(t){this._capInsets[0]!==t&&(this._capInsets[0]=t,this._texture&&this._calculateSlicedUV())}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(t){this._capInsets[2]!==t&&(this._capInsets[2]=t,this._texture&&this._calculateSlicedUV())}},{key:"rect",get:function(){return this._rect},set:function(t){this._rect.equals(t)||(this._rect.set(t),this._texture&&this._calculateUV())}},{key:"originalSize",get:function(){return this._originalSize},set:function(t){this._originalSize.equals(t)||(this._originalSize.set(t),this._texture&&this._calculateUV())}},{key:"offset",get:function(){return this._offset},set:function(t){this._offset.set(t)}},{key:"rotated",get:function(){return this._rotated},set:function(t){this._rotated!==t&&(this._rotated=t,this._texture&&this._calculateUV())}},{key:"texture",get:function(){return this._texture},set:function(t){t?this.reset({texture:t},!0):console.warn("Error Texture in "+this.name)}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(t){this._atlasUuid=t}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}},{key:"_textureSource",set:function(t){window.Build?this._texture=t:t&&(this._refreshTexture(t),this._calculateUV())}},{key:"flipUVX",get:function(){return this._isFlipUVX},set:function(t){this._isFlipUVX=t,this._calculateUV()}},{key:"flipUVY",get:function(){return this._isFlipUVY},set:function(t){this._isFlipUVY=t,this._calculateUV()}},{key:"packable",get:function(){return this._packable},set:function(t){this._packable=t}},{key:"original",get:function(){return this._original}}]),e}(Pu),KU.EVENT_UV_UPDATED="uv_updated",YU=JU))||YU);c.SpriteFrame=ik;var rk,ok=t("SpriteAtlas",hc("cc.SpriteAtlas")((ek=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"spriteFrames",tk,it(e)),e}Q(e,t);var n=e.prototype;return n.getTexture=function(){var t=Object.keys(this.spriteFrames);if(t.length>0){var e=this.spriteFrames[t[0]];return e&&e.texture}return null},n.getSpriteFrame=function(t){var e=this.spriteFrames[t];return e?(e.name||(e.name=t),e):null},n.getSpriteFrames=function(){for(var t=[],e=this.spriteFrames,n=0,i=Object.keys(e);n<i.length;n++){var r=i[n];t.push(e[r])}return t},n._serialize=function(){},n._deserialize=function(t,e){var n=t;this._name=n.name;var i=n.spriteFrames;this.spriteFrames=Et();for(var r=0;r<i.length;r+=2)e.result.push(this.spriteFrames,i[r],i[r+1],Zt(ik))},e}(Pu),tk=st(($U=ek).prototype,"spriteFrames",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Et()}}),ZU=$U))||ZU);c.SpriteAtlas=ok;var ak,sk,ck,lk,uk=t("Font",hc("cc.Font")(rk=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e}(Pu))||rk);c.Font=uk;var hk,_k,fk,pk,dk,mk,vk,gk,yk,xk=t("TTFFont",hc("cc.TTFFont")((lk=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_fontFamily",ck,it(e)),e}return Q(e,t),e.prototype.initDefault=function(e){this._fontFamily="Arial",t.prototype.initDefault.call(this,e)},K(e,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(t){this._fontFamily=t||"Arial"}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,__nativeName__:this._native,ext:mu(this._native),__isNative__:!0}}}]),e}(uk),ck=st((sk=lk).prototype,"_fontFamily",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),st(sk.prototype,"_nativeAsset",[el,jc],Object.getOwnPropertyDescriptor(sk.prototype,"_nativeAsset"),sk.prototype),st(sk.prototype,"_nativeDep",[el],Object.getOwnPropertyDescriptor(sk.prototype,"_nativeDep"),sk.prototype),ak=sk))||ak);c.TTFFont=xk;var Sk,Ck=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.valid=!1,this.xAdvance=0},Ak=function(){function t(t){this.letterDefinitions={},this.texture=t}var e=t.prototype;return e.addLetterDefinitions=function(t,e){this.letterDefinitions[t]=e},e.cloneLetterDefinition=function(){for(var t={},e=0,n=Object.keys(this.letterDefinitions);e<n.length;e++){var i=n[e],r=new Ck;Ft(r,this.letterDefinitions[i]),t[i]=r}return t},e.getTexture=function(){return this.texture},e.getLetter=function(t){return this.letterDefinitions[t]},e.getLetterDefinitionForChar=function(t){var e=t.charCodeAt(0);return this.letterDefinitions.hasOwnProperty(e)?this.letterDefinitions[e]:null},e.clear=function(){this.letterDefinitions={}},t}(),bk=t("BitmapFont",(hk=hc("cc.BitmapFont"),_k=Wc(ik),hk((yk=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"fntDataStr",dk,it(e)),at(e,"spriteFrame",mk,it(e)),at(e,"fontSize",vk,it(e)),at(e,"fntConfig",gk,it(e)),e}return Q(e,t),e.prototype.onLoaded=function(){var t=this.spriteFrame;!this.fontDefDictionary&&t&&(this.fontDefDictionary=new Ak(t.texture));var e=this.fntConfig;if(e){var n=e.fontDefDictionary;for(var i in n){var r=new Ck,o=n[i].rect;r.offsetX=n[i].xOffset,r.offsetY=n[i].yOffset,r.w=o.width,r.h=o.height,r.u=o.x,r.v=o.y,r.textureID=0,r.valid=!0,r.xAdvance=n[i].xAdvance,this.fontDefDictionary.addLetterDefinitions(i,r)}}else y("The fnt config is not exists!")},e}(uk),dk=st((pk=yk).prototype,"fntDataStr",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),mk=st(pk.prototype,"spriteFrame",[_k],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vk=st(pk.prototype,"fontSize",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),gk=st(pk.prototype,"fntConfig",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fk=pk))||fk));c.BitmapFont=bk;var Tk=t("LabelAtlas",hc("cc.LabelAtlas")(Sk=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e}(bk))||Sk);c.LabelAtlas=Tk;var Ek=t("BASELINE_RATIO",.26),wk=t("MIDDLE_RATIO",(Ek+1)/2-Ek);var Pk=new $t(2);Pk.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};var Ik,Rk=new(function(){function t(t){this.count=0,this.limit=0,this.datas={},this.limit=t}var e=t.prototype;return e.moveToHead=function(t){t.next=this.head,t.prev=null,this.head&&(this.head.prev=t),this.head=t,this.tail||(this.tail=t),this.count++,this.datas[t.key]=t},e.put=function(t,e){var n=Pk.get();if(n.key=t,n.value=e,this.count>=this.limit){var i=this.tail;delete this.datas[i.key],this.count--,this.tail=i.prev,this.tail.next=null,i.prev=null,i.next=null,Pk.put(i)}this.moveToHead(n)},e.remove=function(t){t.prev?t.prev.next=t.next:this.head=t.next,t.next?t.next.prev=t.prev:this.tail=t.prev,delete this.datas[t.key],this.count--},e.get=function(t){var e=this.datas[t];return e?(this.remove(e),this.moveToHead(e),e.value):null},e.clear=function(){this.count=0,this.datas={},this.head=null,this.tail=null},e.has=function(t){return!!this.datas[t]},e.delete=function(t){var e=this.datas[t];this.remove(e)},t}())(100),Dk=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûа-яА-ЯЁё]+|\S)/,Bk=/^[!,.:;'}\]%\?>、‘“》？。，！]/,Mk=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+|\S)$/,Ok=/[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+$/,Nk=/^[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]/;function Lk(t){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(t)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(t)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(t)}function Fk(t){var e=t.charCodeAt(0);return e>=9&&e<=13||32===e||133===e||160===e||5760===e||e>=8192&&e<=8202||8232===e||8233===e||8239===e||8287===e||12288===e}function zk(t,e,n){var i=(n||t.font)+"🎮"+e,r=Rk.get(i);if(null!==r)return r;var o=t.measureText(e),a=o&&o.width||0;return Rk.put(i,a),a}function Gk(t,e,n){var i=e,r=n,o=t[e];if(o>="\udc00"&&o<="\udfff"&&i--,void 0!==n)if(n-1!==e){var a=t[n-1];a>="\ud800"&&a<="\udbff"&&r--}else o>="\ud800"&&o<="\udbff"&&r++;return t.substring(i,r)}function Vk(t,e,n,i){var r=[];if(0===t.length||n<0)return r.push(""),r;for(var o=t;e>n&&o.length>1;){for(var a=o.length*(n/e)|0,s=Gk(o,a),c=e-i(s),l=s,u=0,h=0;c>n&&h++<10;)a*=n/c,c=e-i(s=Gk(o,a|=0));for(h=0;c<=n&&h++<10;){if(s){var _=Dk.exec(s);u=_?_[0].length:1,l=s}c=e-i(s=Gk(o,a+=u))}0==(a-=u)?(a=1,l=Gk(o,1)):1===a&&o[0]>="\ud800"&&o[0]<="\udbff"&&(a=2,l=Gk(o,2));var f=Gk(o,0,a),p=void 0;Bk.test(l||s)&&(0==(a-=(p=Mk.exec(f))?p[0].length:0)&&(a=1),l=Gk(o,a),f=Gk(o,0,a)),Nk.test(l)&&(p=Ok.exec(f))&&f!==p[0]&&(l=Gk(o,a-=p[0].length),f=Gk(o,0,a)),(0===r.length||(f=f.trim()).length>0)&&r.push(f),e=i(o=l||s)}return(0===r.length||(o=o.trim()).length>0)&&r.push(o),r}var Uk=t("CanvasPool",function(){function t(){this.pool=[]}t.getInstance=function(){return Ik||(Ik=new t),Ik};var e=t.prototype;return e.get=function(){var t=this.pool.pop();if(!t){var e=document.createElement("canvas"),n=e.getContext("2d");t={canvas:e,context:n}}return t},e.put=function(t){this.pool.length>=ce.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(t)},t}()),kk=bn.WHITE.clone(),Hk=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0},jk="rgba(255, 255, 255, "+(1/255).toFixed(3)+")",Wk=function(){function t(t,e){this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.hash=void 0,this.char=t,this.labelInfo=e,this.hash=t.charCodeAt(0)+e.hash}var e=t.prototype;return e.updateRenderData=function(){this._updateProperties(),this._updateTexture()},e.destroy=function(){this.image=null},e._updateProperties=function(){if(this.data=Uk.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var t=zk(this.context,this.char,this.labelInfo.fontDesc),e=2*this.labelInfo.margin+2;this.width=parseFloat(t.toFixed(2))+e,this.height=(1+Ek)*this.labelInfo.fontSize+e,this.offsetY=-this.labelInfo.fontSize*Ek/2}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new Km),this.image.reset(this.canvas)},e._updateTexture=function(){if(this.context&&this.canvas){var t=this.context,e=this.labelInfo,n=this.canvas.width,i=this.canvas.height;t.textAlign="center",t.textBaseline="alphabetic",t.clearRect(0,0,n,i),t.fillStyle=jk,t.fillRect(0,0,n,i),t.font=e.fontDesc;var r=e.fontSize,o=n/2,a=i/2+r*wk+0*r,s=e.color;if(t.lineJoin="round",t.fillStyle="rgba("+s.r+", "+s.g+", "+s.b+", 1)",e.isOutlined){var c=e.out||kk;t.strokeStyle="rgba("+c.r+", "+c.g+", "+c.b+", "+c.a/255+")",t.lineWidth=2*e.margin,t.strokeText(this.char,o,a)}t.fillText(this.char,o,a)}},t}(),qk=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.initWithSize=function(t,e,n){void 0===n&&(n=Em.RGBA8888),this.reset({width:t,height:e,format:n})},n.drawTextureAt=function(t,e,n){var i=this.getGFXTexture();if(t&&i){var r=this._getGFXDevice();if(r){var o=new ir;o.texOffset.x=e,o.texOffset.y=n,o.texExtent.width=t.width,o.texExtent.height=t.height,r.copyTexImagesToTexture([t.data],i,[o])}else console.warn("Unable to get device")}},e}(gv),Xk=function(){function t(t,e){this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;var n=new qk;n.initWithSize(t,e),this.fontDefDictionary=new Ak(n),this._halfBleed=1,this._width=t,this._height=e,zM.on(FM.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}var e=t.prototype;return e.insertLetterTexture=function(t){var e=t.image,n=zM.root.device;if(!e||!this.fontDefDictionary||!n)return null;var i=e.width,r=e.height;if(this._x+i+0>this._width&&(this._x=0,this._y=this._nextY),this._y+r>this._nextY&&(this._nextY=this._y+r+0),this._nextY>this._height)return I(12100),null;this.fontDefDictionary.texture.drawTextureAt(e,this._x,this._y),this._dirty=!0;var o=new Hk;return o.u=this._x+this._halfBleed,o.v=this._y+this._halfBleed,o.texture=this.fontDefDictionary.texture,o.valid=!0,o.w=t.width-2,o.h=t.height-2,o.xAdvance=o.w,o.offsetY=t.offsetY,this._x+=i+0,this.fontDefDictionary.addLetterDefinitions(t.hash,o),o},e.update=function(){this._dirty&&(this._dirty=!1)},e.reset=function(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()},e.destroy=function(){this.reset(),this.fontDefDictionary&&(this.fontDefDictionary.texture.destroy(),this.fontDefDictionary.texture=null)},e.getTexture=function(){return this.fontDefDictionary.getTexture()},e.beforeSceneLoad=function(){this.clearAllCache()},e.clearAllCache=function(){this.destroy();var t=new qk;t.initWithSize(this._width,this._height),this.fontDefDictionary.texture=t},e.getLetter=function(t){return this.fontDefDictionary.letterDefinitions[t]},e.getLetterDefinitionForChar=function(t,e){var n=t.charCodeAt(0)+e.hash,i=this.fontDefDictionary.letterDefinitions[n];if(!i){var r=new Wk(t,e);r.updateRenderData(),i=this.insertLetterTexture(r),r.destroy()}return i},K(t,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),t}(),Yk={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:bn.WHITE.clone(),isOutlined:!1,out:bn.WHITE.clone(),margin:0},Kk=[new Er(Xi.ATTR_POSITION,ui.RGB32F)],Jk=[new Er(Xi.ATTR_POSITION,ui.RGB32F),new Er(Xi.ATTR_COLOR,ui.RGBA32F)],Qk=[new Er(Xi.ATTR_POSITION,ui.RGB32F),new Er(Xi.ATTR_TEX_COORD,ui.RG32F),new Er(Xi.ATTR_COLOR,ui.RGBA32F)],Zk=[new Er(Xi.ATTR_POSITION,ui.RGB32F),new Er(Xi.ATTR_TEX_COORD,ui.RG32F),new Er(Xi.ATTR_COLOR,ui.RGBA32F),new Er(Xi.ATTR_COLOR2,ui.RGBA32F)];function $k(t){for(var e=0,n=0;n<t.length;n++){var i=t[n];e+=Jr[i.format].count}return e}function tH(t){for(var e=0,n=0;n<t.length;n++){var i=t[n];e+=Jr[i.format].size}return e}c.internal.vfmtPosUvColor=Qk,c.internal.vfmtPosUvTwoColor=Zk,t("UIVertexFormat",Object.freeze({__proto__:null,vfmt:Kk,vfmtPosColor:Jk,vfmtPosUvColor:Qk,vfmtPosUvTwoColor:Zk,getComponentPerVertex:$k,getAttributeStride:tH}));var eH,nH,iH,rH,oH,aH,sH,cH,lH,uH,hH,_H,fH,pH,dH,mH=tH(Qk)>>2,vH=new Vl((function(){return{x:0,y:0,z:0,u:0,v:0,color:bn.WHITE.clone()}}),128),gH=null,yH=t("BaseRenderData",function(){function t(t){void 0===t&&(t=Qk),this.material=null,this.chunk=null,this.dataHash=0,this.isMeshBuffer=!1,this._vc=0,this._ic=0,this._floatStride=0,this._vertexFormat=Qk,this._floatStride=t===Qk?mH:tH(t)>>2,this._vertexFormat=t}return t.prototype.isValid=function(){return this._ic>0&&this.chunk.vertexAccessor},K(t,[{key:"vertexCount",get:function(){return this._vc}},{key:"indexCount",get:function(){return this._ic}},{key:"stride",get:function(){return this._floatStride<<2}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vertexFormat",get:function(){return this._vertexFormat}}]),t}()),xH=t("RenderData",function(t){function e(e,n){var i;return void 0===e&&(e=Qk),(i=t.call(this,e)||this).indices=null,i.vertDirty=!0,i.frame=void 0,i.layer=0,i.blendHash=-1,i.textureHash=0,i.nodeDirty=!0,i.passDirty=!0,i.textureDirty=!0,i.hashDirty=!0,i._data=[],i._pivotX=0,i._pivotY=0,i._width=0,i._height=0,i._accessor=null,n||(n=zM.root.batcher2D.switchBufferAccessor(i._vertexFormat)),i._accessor=n,i}Q(e,t),e.add=function(t,n){void 0===t&&(t=Qk),gH||(gH=new Ul((function(){return new e}),32));var i=gH.add();return i._floatStride=t===Qk?mH:tH(t)>>2,i._vertexFormat=t,n||(n=zM.root.batcher2D.switchBufferAccessor(i._vertexFormat)),i._accessor=n,i},e.remove=function(t){var e=gH.data.indexOf(t);-1!==e&&(t.clear(),t._accessor=null,gH.removeAt(e))};var n=e.prototype;return n.resize=function(t,e){t===this._vc&&e===this._ic&&this.chunk||(this._vc=t,this._ic=e,this.chunk&&(this._accessor.recycleChunk(this.chunk),this.chunk=null),this.chunk=this._accessor.allocateChunk(t,e),this.updateHash())},n.resizeAndCopy=function(t,e){if(t!==this._vc||e!==this._ic||!this.chunk){this._vc=t,this._ic=e;var n=this.chunk;this.chunk=this._accessor.allocateChunk(t,e),n&&(this.chunk.vb.set(n.vb),this._accessor.recycleChunk(n)),this.updateHash()}},n.getMeshBuffer=function(){return this.chunk&&this._accessor?this._accessor.getMeshBuffer(this.chunk.bufferId):null},n.updateNode=function(t){this.layer=t.node.layer,this.nodeDirty=!1,this.hashDirty=!0},n.updatePass=function(t){this.material=t.getRenderMaterial(0),this.blendHash=t.blendHash,this.passDirty=!1,this.hashDirty=!0},n.updateTexture=function(t){this.frame=t,this.textureHash=t.getHash(),this.textureDirty=!1,this.hashDirty=!0},n.updateHash=function(){var t=""+(this.chunk?this.chunk.bufferId:-1)+this.layer+" "+this.blendHash+" "+this.textureHash;this.dataHash=po(t,666),this.hashDirty=!1},n.updateRenderData=function(t,e){if(this.passDirty&&(this.material=t.getRenderMaterial(0),this.blendHash=t.blendHash,this.passDirty=!1,this.hashDirty=!0),this.nodeDirty){var n=t.node.scene?t._getRenderScene():null;this.layer=t.node.layer,null!==n&&(this.nodeDirty=!1),this.hashDirty=!0}this.textureDirty&&(this.frame=e,this.textureHash=e.getHash(),this.textureDirty=!1,this.hashDirty=!0),this.hashDirty&&this.updateHash()},n.updateSizeNPivot=function(t,e,n,i){t===this._width&&e===this._height&&n===this._pivotX&&i===this._pivotY||(this._width=t,this._height=e,this._pivotX=n,this._pivotY=i,this.vertDirty=!0)},n.clear=function(){this.resize(0,0),this._data.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.indices=null,this.vertDirty=!0,this.material=null,this.nodeDirty=!0,this.passDirty=!0,this.textureDirty=!0,this.hashDirty=!0,this.layer=0,this.blendHash=-1,this.frame=null,this.textureHash=0,this.dataHash=0},K(e,[{key:"dataLength",get:function(){return this._data.length},set:function(t){var e=this._data;if(e.length!==t){var n=e.length,i=0;for(i=t;i<n;i++)vH.free(e[i]);for(i=n;i<t;i++)e[i]=vH.alloc();e.length=t}}},{key:"data",get:function(){return this._data}}]),e}(yH)),SH=t("MeshRenderData",function(t){function e(e){var n;return void 0===e&&(e=Qk),(n=t.call(this,e)||this).isMeshBuffer=!0,n.vData=void 0,n.iData=void 0,n.vertexStart=0,n.vertexRange=0,n.indexStart=0,n.indexRange=0,n.lastFilledIndex=0,n.lastFilledVertex=0,n._byteLength=0,n._vertexBuffers=[],n._indexBuffer=null,n._iaPool=null,n._iaInfo=null,n.vData=new Float32Array(256*n.stride),n.iData=new Uint16Array(1536),n}Q(e,t),e.add=function(t){void 0===t&&(t=Qk);var e=CH.add();return e._floatStride=t===Qk?mH:tH(t)>>2,e._vertexFormat=t,e},e.remove=function(t){var e=CH.data.indexOf(t);-1!==e&&(CH.data[e].clear(),CH.removeAt(e))};var n=e.prototype;return n.request=function(t,e){var n=this._byteLength+t*this.stride;return!!this.reserve(t,e)&&(this._vc+=t,this._ic+=e,this._byteLength=n,this.vertexRange=this._vc,this.indexRange=this._ic,!0)},n.reserve=function(t,e){var n=this._byteLength+t*this.stride,i=this.indexCount+e;if(t+this.vertexCount>65535)return!1;var r=this.vData.byteLength,o=this.iData.length,a=this.vData.length,s=this.iData.length;if(n>r||i>o){for(;r<n||o<i;)r=4*(a*=2),o=s*=2;this._reallocBuffer(a,s)}return!0},n.resize=function(t,e){var n=t*this.stride;t>=0&&e>=0&&n<=this.vData.byteLength&&this.iData.length,this._vc=t,this._ic=e,this._byteLength=n,this.updateRange(0,t,0,e)},n.updateRange=function(t,e,n,i){e>=0&&i>=0&&e<=this._vc&&this._ic,this.vertexStart=t,this.indexStart=n,this.vertexRange=e,this.indexRange=i},n.requestIA=function(t){this._initIAInfo(t);var e=this._iaPool.add();return e.firstIndex=this.indexStart,e.indexCount=this.indexRange,e},n.uploadBuffers=function(){if(0!==this._byteLength&&this._vertexBuffers[0]&&this._indexBuffer){var t=this._ic,e=new Float32Array(this.vData.buffer,0,this._byteLength>>2),n=new Uint16Array(this.iData.buffer,0,t),i=this._vertexBuffers[0];this._byteLength>i.size&&i.resize(this._byteLength),i.update(e);var r=t<<1;r>this._indexBuffer.size&&this._indexBuffer.resize(r),this._indexBuffer.update(n)}},n.freeIAPool=function(){this._iaPool&&this._iaPool.reset()},n.reset=function(){this._vc=0,this._ic=0,this._byteLength=0,this.vertexStart=0,this.vertexRange=0,this.indexStart=0,this.indexRange=0,this.lastFilledIndex=0,this.lastFilledVertex=0,this.material=null,this.freeIAPool()},n.clear=function(){this.reset(),this._iaPool&&this._iaPool.destroy(),this._vertexBuffers[0]&&(this._vertexBuffers[0].destroy(),this._vertexBuffers=[]),this._iaInfo=null,this.vData=new Float32Array(256*this.stride),this.iData=new Uint16Array(1536)},n._initIAInfo=function(t){var e=this;if(!this._iaInfo){var n=this.stride,i=this._vertexBuffers;i.length||i.push(t.createBuffer(new lr(fi.VERTEX|fi.TRANSFER_DST,mi.DEVICE,n,n)));var r=Uint16Array.BYTES_PER_ELEMENT;this._indexBuffer||(this._indexBuffer=t.createBuffer(new lr(fi.INDEX|fi.TRANSFER_DST,mi.DEVICE,r,r))),this._iaInfo=new Pr(this._vertexFormat,i,this._indexBuffer),this._iaPool=new Ul((function(){return t.createInputAssembler(e._iaInfo)}),1,(function(t){t.destroy()}))}},n._reallocBuffer=function(t,e){var n=this.vData;this.vData=new Float32Array(t),n&&this.vData.set(n,0);var i=this.iData;this.iData=new Uint16Array(e),i&&this.iData.set(i,0)},K(e,[{key:"formatByte",get:function(){return this.stride},set:function(){}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vDataOffset",get:function(){return this._byteLength>>>2}}]),e}(yH)),CH=new Ul((function(){return new SH}),32),AH=new Wn,bH=new Wn,TH=(new En,new Un),EH=new Un,wH=new Un,PH=new Un(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),IH=new ti,RH=function(e){return t({UITransform:e,UITransformComponent:e}),e}((eH=hc("cc.UITransform"),nH=wc(),iH=fc(110),rH=Ac(),oH=zc(),aH=Bc(),sH=zc(),cH=Bc(),eH(lH=nH(lH=iH(lH=rH(lH=pc(lH=Cc((pH=fH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._priority=0,at(e,"_contentSize",hH,it(e)),at(e,"_anchorPoint",_H,it(e)),e}Q(e,t);var n=e.prototype;return n.__preload=function(){this.node._uiProps.uiTransformComp=this},n.onLoad=function(){this.node.parent&&e.insertChangeMap(this.node.parent)},n.onEnable=function(){this.node.on(FA.PARENT_CHANGED,this._parentChanged,this),this._markRenderDataDirty()},n.onDisable=function(){this.node.off(FA.PARENT_CHANGED,this._parentChanged,this)},n.onDestroy=function(){this.node._uiProps.uiTransformComp=null},n.setContentSize=function(t,e){var n=this._contentSize;if(void 0===e){if((t=t).width===n.width&&t.height===n.height)return;n.width=t.width,n.height=t.height}else{if(t===n.width&&e===n.height)return;n.width=t,n.height=e}this.node.emit(FA.SIZE_CHANGED),this._markRenderDataDirty()},n.setAnchorPoint=function(t,e){var n=this._anchorPoint;if(void 0===e){if((t=t).x===n.x&&t.y===n.y)return;n.x=t.x,n.y=t.y}else{if(t===n.x&&e===n.y)return;n.x=t,n.y=e}this.node.emit(FA.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty()},n.isHit=function(t){for(var e,n=this._contentSize.width,i=this._contentSize.height,r=AH,o=bH,a=null===(e=this.node)||void 0===e?void 0:e.eventProcessor,s=this._getRenderScene().cameras,c=0;c<s.length;c++){var l=s[c];if(l.visibility&this.node.layer){l.node.getWorldRT(TH);var u=TH.m12,h=TH.m13,_=UM.center;if(TH.m12=_.x-(TH.m00*u+TH.m04*h),TH.m13=_.y-(TH.m01*u+TH.m05*h),Un.invert(TH,TH),Wn.transformMat4(r,t,TH),this.node.getWorldMatrix(wH),Un.invert(TH,wH),!Un.strictEquals(TH,PH)){Wn.transformMat4(o,r,TH),o.x+=this._anchorPoint.x*n,o.y+=this._anchorPoint.y*i;var f=!1;if(o.x>=0&&o.y>=0&&o.x<=n&&o.y<=i&&(f=!0,a&&a.maskList))for(var p=a.maskList,d=this.node,m=p?p.length:0,v=0,g=0;d&&g<m;++v,d=d.parent){var y=p[g];if(v===y.index){if(d!==y.comp.node){p.length=g;break}var x=y.comp;if(x&&x._enabled&&!x.isHit(r)){f=!1;break}g++}else if(v>y.index){p.length=g;break}}if(f)return!0}}}return!1},n.convertToNodeSpaceAR=function(t,e){return this.node.getWorldMatrix(wH),Un.invert(TH,wH),e||(e=new En),En.transformMat4(e,t,TH)},n.convertToWorldSpaceAR=function(t,e){return this.node.getWorldMatrix(wH),e||(e=new En),En.transformMat4(e,t,wH)},n.getBoundingBox=function(){Un.fromRTS(EH,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var t=this._contentSize.width,e=this._contentSize.height,n=new ti(-this._anchorPoint.x*t,-this._anchorPoint.y*e,t,e);return n.transformMat4(EH),n},n.getBoundingBoxToWorld=function(){return this.node.parent?(this.node.parent.getWorldMatrix(wH),this.getBoundingBoxTo(wH)):this.getBoundingBox()},n.getBoundingBoxTo=function(t){Un.fromRTS(EH,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var n=this._contentSize.width,i=this._contentSize.height,r=new ti(-this._anchorPoint.x*n,-this._anchorPoint.y*i,n,i);if(Un.multiply(wH,t,EH),r.transformMat4(wH),!this.node.children)return r;for(var o,a=ot(this.node.children);!(o=a()).done;){var s=o.value;if(s&&s.active){var c=s.getComponent(e);if(c){var l=c.getBoundingBoxTo(t);l&&ti.union(r,r,l)}}}return r},n.getComputeAABB=function(t){var e=this._contentSize.width,n=this._contentSize.height;IH.set(-this._anchorPoint.x*e,-this._anchorPoint.y*n,e,n),IH.transformMat4(this.node.worldMatrix);var i=IH.x+.5*IH.width,r=IH.y+.5*IH.height,o=this.node.worldPosition.z,a=IH.width/2,s=IH.height/2;return null!=t?(ks.set(t,i,r,o,a,s,.001),t):new ks(i,r,o,a,s,.001)},n._parentChanged=function(){this.node.getComponent("cc.RenderRoot2D")||this.node.parent&&e.insertChangeMap(this.node.parent)},n._markRenderDataDirty=function(){var t=this.node._uiProps.uiComp;t&&(t.markForUpdateRenderData(),t.renderData&&(t.renderData.vertDirty=!0))},e.insertChangeMap=function(t){var n=t.uuid;e.priorityChangeNodeMap.has(n)||e.priorityChangeNodeMap.set(n,t)},e._sortChildrenSibling=function(t){var e=t.children;e&&e.sort((function(t,e){var n=t._uiProps.uiTransformComp,i=e._uiProps.uiTransformComp,r=(n?n._priority:0)-(i?i._priority:0);return 0===r?t.getSiblingIndex()-e.getSiblingIndex():r}))},e._sortSiblings=function(){e.priorityChangeNodeMap.forEach((function(t){e._sortChildrenSibling(t),t._updateSiblingIndex(),t.emit("childrenSiblingOrderChanged")})),e.priorityChangeNodeMap.clear()},e._cleanChangeMap=function(){e.priorityChangeNodeMap.clear()},K(e,[{key:"contentSize",get:function(){return this._contentSize},set:function(t){this._contentSize.equals(t)||(this._contentSize.set(t),this.node.emit(FA.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"width",get:function(){return this._contentSize.width},set:function(t){this._contentSize.width!==t&&(this._contentSize.width=t,this.node.emit(FA.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"height",get:function(){return this._contentSize.height},set:function(t){this.contentSize.height!==t&&(this._contentSize.height=t,this.node.emit(FA.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(t){this._anchorPoint.equals(t)||(this._anchorPoint.set(t),this.node.emit(FA.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(t){this._anchorPoint.x!==t&&(this._anchorPoint.x=t,this.node.emit(FA.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(t){this._anchorPoint.y!==t&&(this._anchorPoint.y=t,this.node.emit(FA.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"priority",get:function(){return this._priority},set:function(t){this._priority!==t&&(this.node.getComponent("cc.RenderRoot2D")?I(6706):(this._priority=t,this.node.parent&&e.insertChangeMap(this.node.parent)))}},{key:"visibility",get:function(){var t=zM.root.batcher2D.getFirstRenderCamera(this.node);return t?t.visibility:0}},{key:"cameraPriority",get:function(){var t=zM.root.batcher2D.getFirstRenderCamera(this.node);return t?t.priority:0}}]),e}(Ku),fH.EventType=FA,fH.priorityChangeNodeMap=new Map,st((uH=pH).prototype,"contentSize",[oH,aH],Object.getOwnPropertyDescriptor(uH.prototype,"contentSize"),uH.prototype),st(uH.prototype,"anchorPoint",[sH,cH],Object.getOwnPropertyDescriptor(uH.prototype,"anchorPoint"),uH.prototype),hH=st(uH.prototype,"_contentSize",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zn(100,100)}}),_H=st(uH.prototype,"_anchorPoint",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wn(.5,.5)}}),lH=uH))||lH)||lH)||lH)||lH)||lH)||lH));zM.on(FM.EVENT_AFTER_UPDATE,RH._sortSiblings),zM.on(FM.EVENT_BEFORE_SCENE_LAUNCH,RH._cleanChangeMap),function(t){t[t.DISABLED=0]="DISABLED",t[t.CLEAR=1]="CLEAR",t[t.ENTER_LEVEL=2]="ENTER_LEVEL",t[t.ENABLED=3]="ENABLED",t[t.EXIT_LEVEL=4]="EXIT_LEVEL",t[t.CLEAR_INVERTED=5]="CLEAR_INVERTED",t[t.ENTER_LEVEL_INVERTED=6]="ENTER_LEVEL_INVERTED"}(dH||(dH={}));var DH,BH,MH,OH,NH,LH,FH,zH,GH,VH,UH,kH,HH,jH,WH,qH,XH,YH,KH,JH,QH=t("StencilManager",function(){function t(){this.stage=dH.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:bi.ALWAYS,stencilMask:65535,writeMask:65535,failOp:Ti.KEEP,zFailOp:Ti.KEEP,passOp:Ti.KEEP,ref:1},this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}var e=t.prototype;return e.pushMask=function(t){this._maskStack.push(t)},e.clear=function(t){t.stencilStage=t.inverted?dH.CLEAR_INVERTED:dH.CLEAR},e.enterLevel=function(t){t.graphics.stencilStage=t.inverted?dH.ENTER_LEVEL_INVERTED:dH.ENTER_LEVEL},e.enableMask=function(){this.stage=dH.ENABLED},e.exitMask=function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=dH.DISABLED:this.stage=dH.ENABLED)},e.getWriteMask=function(){return 1<<this._maskStack.length-1},e.getExitWriteMask=function(){return 1<<this._maskStack.length},e.getStencilRef=function(){for(var t=0,e=0;e<this._maskStack.length;++e)t+=1<<e;return t},e.reset=function(){this._maskStack.length=0,this.stage=dH.DISABLED},e.destroy=function(){this.stencilStateMap.forEach((function(t){t.destroy()})),this.stencilStateMap.clear()},e.getStencilStage=function(t,e){var n=0,i=!1,r=!1,o=bi.LESS,a=this.stencilStateMap;if(e&&e.passes[0]){var s=e.passes[0].depthStencilState,c=0,l=0;s.depthTest&&(c=1),s.depthWrite&&(l=1),n=c|l<<1|s.depthFunc<<2|t<<6|this._maskStack.length<<9,i=s.depthTest,r=s.depthWrite,o=s.depthFunc,a=this.stencilStateMapWithDepth}else n=t<<16|this._maskStack.length;if(a&&a.has(n))return a.get(n);this.setStateFromStage(t);var u=new So(i,r,o,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return a.set(n,u),u},e.getStencilHash=function(t){return t<<8|this._maskStack.length},e.setStateFromStage=function(t){var e=this._stencilPattern;t===dH.DISABLED?(e.stencilTest=!1,e.func=bi.ALWAYS,e.failOp=Ti.KEEP,e.stencilMask=e.writeMask=65535,e.ref=1):(e.stencilTest=!0,t===dH.ENABLED?(e.func=bi.EQUAL,e.failOp=Ti.KEEP,e.stencilMask=e.ref=this.getStencilRef(),e.writeMask=this.getWriteMask()):t===dH.CLEAR?(e.func=bi.NEVER,e.failOp=Ti.ZERO,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()):t===dH.CLEAR_INVERTED||t===dH.ENTER_LEVEL?(e.func=bi.NEVER,e.failOp=Ti.REPLACE,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()):t===dH.ENTER_LEVEL_INVERTED&&(e.func=bi.NEVER,e.failOp=Ti.ZERO,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()))},K(t,[{key:"pattern",get:function(){return this._stencilPattern}}]),t}());QH.sharedManager=null,QH.sharedManager=new QH,ae(Ei),function(t){t[t.ADD_COLOR=0]="ADD_COLOR",t[t.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",t[t.GRAYSCALE=2]="GRAYSCALE",t[t.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",t[t.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(JH||(JH=t("InstanceMaterialType",{})));var ZH,$H,tj,ej,nj,ij,rj,oj,aj,sj,cj,lj,uj,hj,_j,fj,pj,dj,mj,vj,gj,yj,xj,Sj,Cj,Aj,bj,Tj,Ej,wj,Pj,Ij,Rj,Dj,Bj,Mj,Oj,Nj,Lj,Fj,zj,Gj,Vj,Uj,kj,Hj,jj,Wj,qj,Xj,Yj,Kj,Jj,Qj,Zj,$j,tW,eW,nW,iW,rW,oW,aW,sW,cW,lW,uW,hW,_W,fW,pW=function(e){return t({Renderable2D:e,RenderComponent:e,UIRenderable:e}),e}((DH=hc("cc.Renderable2D"),BH=_c(RH),MH=Ic(),OH=Wc(ig),NH=Wc(ig),LH=zc(),FH=Bc(),zH=Dc(),GH=zc(),VH=Bc(),DH(UH=BH(UH=pc(UH=Cc((KH=YH=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_materials",HH,it(e)),at(e,"_customMaterial",jH,it(e)),e.stencilStage=dH.DISABLED,at(e,"_srcBlendFactor",WH,it(e)),at(e,"_dstBlendFactor",qH,it(e)),at(e,"_color",XH,it(e)),e._assembler=null,e._postAssembler=null,e._renderData=null,e._renderDataFlag=!0,e._renderFlag=!0,e._delegateSrc=null,e._instanceMaterialType=-1,e._blendState=new Ao,e._blendHash=0,e._lastParent=null,e}Q(e,t);var n=e.prototype;return n.updateBlendHash=function(){var t=this._blendState.targets[0].blendDst<<4;this._blendHash=t|this._blendState.targets[0].blendSrc},n.__preload=function(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler()},n.onEnable=function(){this.node.on(FA.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(FA.SIZE_CHANGED,this._nodeStateChange,this),this.updateMaterial(),this._renderFlag=this._canRender()},n.onRestore=function(){this.updateMaterial(),this.markForUpdateRenderData()},n.onDisable=function(){this.node.off(FA.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(FA.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1},n.onDestroy=function(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(var t=0;t<this._materialInstances.length;t++){var e=this._materialInstances[t];e&&e.destroy()}this._blendState&&this._blendState.destroy()},n.markForUpdateRenderData=function(t){if(void 0===t&&(t=!0),this._renderFlag=this._canRender(),t){var e=this._renderData;e&&(e.vertDirty=!0),this._renderDataFlag=t}else this._renderDataFlag=t},n.requestRenderData=function(){var t=xH.add();return this._renderData=t,t},n.destroyRenderData=function(){this._renderData&&(xH.remove(this._renderData),this._renderData=null)},n.updateAssembler=function(t){this._renderDataFlag&&(this._assembler.updateRenderData(this,t),this._renderDataFlag=!1),this._renderFlag&&this._render(t)},n.postUpdateAssembler=function(t){this._postAssembler&&this._renderFlag&&this._postRender(t)},n._render=function(){},n._postRender=function(){},n._canRender=function(){return this.isValid&&null!==this.getMaterial(0)&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)&&this._color.a>0},n._postCanRender=function(){},n.updateMaterial=function(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),this._renderData&&(this._renderData.material=this._customMaterial,this.markForUpdateRenderData(),this._renderData.passDirty=!0),void(this._blendHash=-1);var t=this._updateBuiltinMaterial();this.setMaterial(t,0),this._renderData&&(this._renderData.material=t,this.markForUpdateRenderData()),this._updateBlendFunc()},n._updateColor=function(){this.node._uiProps.colorDirty=!0,this._assembler&&(this._assembler.updateColor(this),this._renderFlag=this._canRender())},n._updateBlendFunc=function(){var t=this._blendState.targets[0];t||(t=new Co,this._blendState.setTarget(0,t)),t.blendDst===this._dstBlendFactor&&t.blendSrc===this._srcBlendFactor||(t.blend=!0,t.blendDstAlpha=Ei.ONE_MINUS_SRC_ALPHA,t.blendDst=this._dstBlendFactor,t.blendSrc=this._srcBlendFactor,this.renderData&&(this.renderData.passDirty=!0)),this.updateBlendHash()},n.getBlendState=function(){return this._blendState},n._nodeStateChange=function(){this._renderData&&this.markForUpdateRenderData();for(var t=0;t<this.node.children.length;++t){var n=this.node.children[t].getComponent(e);n&&n.markForUpdateRenderData()}},n._onMaterialModified=function(e,n){this._renderData&&(this.markForUpdateRenderData(),this._renderData.passDirty=!0),t.prototype._onMaterialModified.call(this,e,n)},n._updateBuiltinMaterial=function(){var t;switch(this._instanceMaterialType){case JH.ADD_COLOR:t=wv.get("ui-base-material");break;case JH.GRAYSCALE:t=wv.get("ui-sprite-gray-material");break;case JH.USE_ALPHA_SEPARATED:t=wv.get("ui-sprite-alpha-sep-material");break;case JH.USE_ALPHA_SEPARATED_AND_GRAY:t=wv.get("ui-sprite-gray-alpha-sep-material");break;default:t=wv.get("ui-sprite-material")}return t},n.setNodeDirty=function(){this.renderData&&(this.renderData.nodeDirty=!0)},n.setTextureDirty=function(){this.renderData&&(this.renderData.textureDirty=!0)},K(e,[{key:"sharedMaterials",get:function(){return this._materials},set:function(t){for(var e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(var n=t.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(t.length)}}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(t){this._customMaterial=t,this.updateMaterial()}},{key:"srcBlendFactor",get:function(){return this._customMaterial&&I(12001),this._srcBlendFactor},set:function(t){this._customMaterial?I(12001):this._srcBlendFactor!==t&&(this._srcBlendFactor=t,this._updateBlendFunc())}},{key:"dstBlendFactor",get:function(){return this._customMaterial&&I(12001),this._dstBlendFactor},set:function(t){this._customMaterial?I(12001):this._dstBlendFactor!==t&&(this._dstBlendFactor=t,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(t){this._color.equals(t)||(this._color.set(t),this._updateColor())}},{key:"renderData",get:function(){return this._renderData}},{key:"delegateSrc",set:function(t){this._delegateSrc=t}},{key:"blendHash",get:function(){return this._blendHash}}]),e}(cF),YH.BlendState=Ei,YH.Assembler=null,YH.PostAssembler=null,HH=st((kH=KH).prototype,"_materials",[el],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),st(kH.prototype,"sharedMaterials",[el,MH],Object.getOwnPropertyDescriptor(kH.prototype,"sharedMaterials"),kH.prototype),jH=st(kH.prototype,"_customMaterial",[OH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),st(kH.prototype,"customMaterial",[NH,LH,FH,zH],Object.getOwnPropertyDescriptor(kH.prototype,"customMaterial"),kH.prototype),st(kH.prototype,"color",[GH,VH],Object.getOwnPropertyDescriptor(kH.prototype,"color"),kH.prototype),WH=st(kH.prototype,"_srcBlendFactor",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ei.SRC_ALPHA}}),qH=st(kH.prototype,"_dstBlendFactor",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ei.ONE_MINUS_SRC_ALPHA}}),XH=st(kH.prototype,"_color",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bn.WHITE.clone()}}),UH=kH))||UH)||UH)||UH)||UH));c.internal.Renderable2D=pW,function(t){t[t.LEFT=0]="LEFT",t[t.CENTER=1]="CENTER",t[t.RIGHT=2]="RIGHT"}(uW||(uW=t("HorizontalTextAlignment",{}))),ae(uW),function(t){t[t.TOP=0]="TOP",t[t.CENTER=1]="CENTER",t[t.BOTTOM=2]="BOTTOM"}(hW||(hW=t("VerticalTextAlignment",{}))),ae(hW),function(t){t[t.NONE=0]="NONE",t[t.CLAMP=1]="CLAMP",t[t.SHRINK=2]="SHRINK",t[t.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(_W||(_W=t("Overflow",{}))),ae(_W),function(t){t[t.NONE=0]="NONE",t[t.BITMAP=1]="BITMAP",t[t.CHAR=2]="CHAR"}(fW||(fW=t("CacheMode",{}))),ae(fW);var dW=function(e){return t({Label:e,LabelComponent:e}),e}((ZH=hc("cc.Label"),$H=wc(),tj=fc(110),ej=Ac(),nj=zc(),ij=Bc(),rj=Wc(uW),oj=zc(),aj=Bc(),sj=Wc(hW),cj=zc(),lj=Bc(),uj=zc(),hj=Bc(),_j=zc(),fj=Ic(),pj=Bc(),dj=zc(),mj=Bc(),vj=Ic(),gj=zc(),yj=Bc(),xj=Wc(_W),Sj=zc(),Cj=Bc(),Aj=zc(),bj=Bc(),Tj=Wc(uk),Ej=zc(),wj=Ic(),Pj=Bc(),Ij=zc(),Rj=Bc(),Dj=Wc(fW),Bj=zc(),Mj=Bc(),Oj=zc(),Nj=Bc(),Lj=zc(),Fj=Bc(),zj=zc(),Gj=Bc(),Vj=Ic(),Uj=zc(),kj=Bc(),ZH(Hj=$H(Hj=tj(Hj=ej((lW=cW=function(t){function e(){var e;return at(e=t.call(this)||this,"_string",Wj,it(e)),at(e,"_horizontalAlign",qj,it(e)),at(e,"_verticalAlign",Xj,it(e)),at(e,"_actualFontSize",Yj,it(e)),at(e,"_fontSize",Kj,it(e)),at(e,"_fontFamily",Jj,it(e)),at(e,"_lineHeight",Qj,it(e)),at(e,"_overflow",Zj,it(e)),at(e,"_enableWrapText",$j,it(e)),at(e,"_font",tW,it(e)),at(e,"_isSystemFontUsed",eW,it(e)),at(e,"_spacingX",nW,it(e)),at(e,"_isItalic",iW,it(e)),at(e,"_isBold",rW,it(e)),at(e,"_isUnderline",oW,it(e)),at(e,"_underlineHeight",aW,it(e)),at(e,"_cacheMode",sW,it(e)),e._N$file=null,e._texture=null,e._ttfSpriteFrame=null,e._userDefinedFont=null,e._assemblerData=null,e._fontAtlas=null,e._letterTexture=null,e._ttfSpriteFrame=null,e}Q(e,t);var n=e.prototype;return n.onEnable=function(){t.prototype.onEnable.call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this._applyFontTexture()},n.onDestroy=function(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){this._ttfSpriteFrame._resetDynamicAtlasFrame();var e=this._ttfSpriteFrame.texture;if(this._ttfSpriteFrame.destroy(),e){var n=e;n.image&&n.image.destroy(),e.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,t.prototype.onDestroy.call(this)},n.updateRenderData=function(t){void 0===t&&(t=!1),this.markForUpdateRenderData(),t&&(this._flushAssembler(),this.renderData&&(this.renderData.vertDirty=!0),this._applyFontTexture(),this._assembler&&this._assembler.updateRenderData(this))},n._render=function(t){t.commitComp(this,this.renderData,this._texture,this._assembler,null)},n._updateColor=function(){t.prototype._updateColor.call(this),this.updateRenderData(!1)},n._canRender=function(){if(!t.prototype._canRender.call(this)||!this._string)return!1;var e=this._font;if(e&&e instanceof bk){var n=e.spriteFrame;if(!n||!n.texture)return!1}return!0},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)},n._applyFontTexture=function(){this.markForUpdateRenderData();var t=this._font;if(t instanceof bk){var e=t.spriteFrame;e&&e.texture&&(this._texture=e,this.renderData&&(this.renderData.textureDirty=!0),this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this))}else{if(this.cacheMode===fW.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new ik,this._assemblerData=this._assembler.getAssemblerData();var n=new Km(this._assemblerData.canvas),i=new gv;i.image=n,this._ttfSpriteFrame.texture=i}this.cacheMode!==fW.CHAR&&(this._texture=this._ttfSpriteFrame),this.changeMaterialForDefine()}},n.changeMaterialForDefine=function(){if(this._texture){var t=!1;if(this.cacheMode!==fW.CHAR){var e=this._texture.texture;if(e instanceof Xm){var n=e.getPixelFormat();t=n===Em.RGBA_ETC1||n===Em.RGB_A_PVRTC_4BPPV1||n===Em.RGB_A_PVRTC_2BPPV1}}this._instanceMaterialType=t?JH.USE_ALPHA_SEPARATED:JH.ADD_COLOR_AND_TEXTURE,this.updateMaterial()}},K(e,[{key:"string",get:function(){return this._string},set:function(t){t=null==t?"":t.toString(),this._string!==t&&(this._string=t,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(t){this._horizontalAlign!==t&&(this._horizontalAlign=t,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(t){this._verticalAlign!==t&&(this._verticalAlign=t,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(t){this._actualFontSize=t}},{key:"fontSize",get:function(){return this._fontSize},set:function(t){this._fontSize!==t&&(this._fontSize=t,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(t){this._fontFamily!==t&&(this._fontFamily=t,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(t){this._lineHeight!==t&&(this._lineHeight=t,this.updateRenderData())}},{key:"spacingX",get:function(){return this._spacingX},set:function(t){this._spacingX!==t&&(this._spacingX=t,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(t){this._overflow!==t&&(this._overflow=t,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(t){this._enableWrapText!==t&&(this._enableWrapText=t,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(t){this._font!==t&&(this._isSystemFontUsed=!t,this._font=t,this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(t){this._isSystemFontUsed!==t&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!t,t&&(this.font=null),this._flushAssembler(),this.updateRenderData())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(t){this._cacheMode!==t&&(this._cacheMode!==fW.BITMAP||this._font instanceof bk||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),this._cacheMode===fW.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=t,this.updateRenderData(!0))}},{key:"isBold",get:function(){return this._isBold},set:function(t){this._isBold!==t&&(this._isBold=t,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(t){this._isItalic!==t&&(this._isItalic=t,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(t){this._isUnderline!==t&&(this._isUnderline=t,this.updateRenderData())}},{key:"underlineHeight",get:function(){return this._underlineHeight},set:function(t){this._underlineHeight!==t&&(this._underlineHeight=t,this.updateRenderData())}},{key:"spriteFrame",get:function(){return this._texture}},{key:"ttfSpriteFrame",get:function(){return this._ttfSpriteFrame}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(t){this._fontAtlas=t}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof bk?this._font.fontSize:-1}}]),e}(pW),cW.HorizontalAlign=uW,cW.VerticalAlign=hW,cW.Overflow=_W,cW.CacheMode=fW,cW._canvasPool=Uk.getInstance(),st((jj=lW).prototype,"string",[nj,ij,Gc],Object.getOwnPropertyDescriptor(jj.prototype,"string"),jj.prototype),st(jj.prototype,"horizontalAlign",[rj,oj,aj],Object.getOwnPropertyDescriptor(jj.prototype,"horizontalAlign"),jj.prototype),st(jj.prototype,"verticalAlign",[sj,cj,lj],Object.getOwnPropertyDescriptor(jj.prototype,"verticalAlign"),jj.prototype),st(jj.prototype,"fontSize",[uj,hj],Object.getOwnPropertyDescriptor(jj.prototype,"fontSize"),jj.prototype),st(jj.prototype,"fontFamily",[_j,fj,pj],Object.getOwnPropertyDescriptor(jj.prototype,"fontFamily"),jj.prototype),st(jj.prototype,"lineHeight",[dj,mj],Object.getOwnPropertyDescriptor(jj.prototype,"lineHeight"),jj.prototype),st(jj.prototype,"spacingX",[vj,gj,yj],Object.getOwnPropertyDescriptor(jj.prototype,"spacingX"),jj.prototype),st(jj.prototype,"overflow",[xj,Sj,Cj],Object.getOwnPropertyDescriptor(jj.prototype,"overflow"),jj.prototype),st(jj.prototype,"enableWrapText",[Aj,bj],Object.getOwnPropertyDescriptor(jj.prototype,"enableWrapText"),jj.prototype),st(jj.prototype,"font",[Tj,Ej,wj,Pj],Object.getOwnPropertyDescriptor(jj.prototype,"font"),jj.prototype),st(jj.prototype,"useSystemFont",[Ij,Rj],Object.getOwnPropertyDescriptor(jj.prototype,"useSystemFont"),jj.prototype),st(jj.prototype,"cacheMode",[Dj,Bj,Mj],Object.getOwnPropertyDescriptor(jj.prototype,"cacheMode"),jj.prototype),st(jj.prototype,"isBold",[Oj,Nj],Object.getOwnPropertyDescriptor(jj.prototype,"isBold"),jj.prototype),st(jj.prototype,"isItalic",[Lj,Fj],Object.getOwnPropertyDescriptor(jj.prototype,"isItalic"),jj.prototype),st(jj.prototype,"isUnderline",[zj,Gj],Object.getOwnPropertyDescriptor(jj.prototype,"isUnderline"),jj.prototype),st(jj.prototype,"underlineHeight",[Vj,Pc,Uj,kj],Object.getOwnPropertyDescriptor(jj.prototype,"underlineHeight"),jj.prototype),Wj=st(jj.prototype,"_string",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),qj=st(jj.prototype,"_horizontalAlign",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uW.CENTER}}),Xj=st(jj.prototype,"_verticalAlign",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hW.CENTER}}),Yj=st(jj.prototype,"_actualFontSize",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Kj=st(jj.prototype,"_fontSize",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),Jj=st(jj.prototype,"_fontFamily",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),Qj=st(jj.prototype,"_lineHeight",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),Zj=st(jj.prototype,"_overflow",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _W.NONE}}),$j=st(jj.prototype,"_enableWrapText",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),tW=st(jj.prototype,"_font",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eW=st(jj.prototype,"_isSystemFontUsed",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),nW=st(jj.prototype,"_spacingX",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),iW=st(jj.prototype,"_isItalic",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),rW=st(jj.prototype,"_isBold",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),oW=st(jj.prototype,"_isUnderline",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),aW=st(jj.prototype,"_underlineHeight",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),sW=st(jj.prototype,"_cacheMode",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fW.NONE}}),Hj=jj))||Hj)||Hj)||Hj)||Hj));c.Label=dW;var mW,vW,gW=0,yW={};function xW(t){return--t,t|=t>>16,t|=t>>8,t|=t>>4,t|=t>>2,t|=t>>1,++t}function SW(t,e){return Math.ceil(t/e)*e}!function(t){t[t.OPAQUE=0]="OPAQUE",t[t.TRANSPARENT=1]="TRANSPARENT",t[t.OVERLAY=2]="OVERLAY"}(mW||(mW={})),function(t){t[t.DEFAULT=1]="DEFAULT",t[t.FORWARD=2]="FORWARD",t[t.SHADOWCAST=4]="SHADOWCAST"}(vW||(vW={}));var CW,AW,bW,TW=function(){function t(t){this._device=void 0,this._format=ui.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new ir,this._region1=new ir,this._region2=new ir,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=t}var e=t.prototype;return e.initialize=function(t){var e=Jr[t.format];this._format=t.format,this._formatSize=e.size,this._channels=e.count,this._bufferViewCtor=oo(e),this._roundUpFn=t.roundUpFn||null,this._alignment=t.alignment||1,t.inOrderFree&&(this.alloc=this._McDonaldAlloc)},e.destroy=function(){for(var t=0;t<this._chunkCount;++t)this._chunks[t].texture.destroy();this._chunks.length=0,this._handles.length=0},e.alloc=function(t,e){t=SW(t,this._alignment);var n=-1,i=-1;if(void 0!==e&&(n=e,i=this._findAvailableSpace(t,n)),i<0)for(var r=0;r<this._chunkCount&&(n=r,!((i=this._findAvailableSpace(t,n))>=0));++r);if(i>=0){var o=this._chunks[n];o.start+=t;var a={chunkIdx:n,start:i,end:i+t,texture:o.texture};return this._handles.push(a),a}var s=Math.sqrt(t/this._formatSize),c=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,xW(s)),l=this._chunks[this.createChunk(c)];l.start+=t;var u={chunkIdx:this._chunkCount-1,start:0,end:t,texture:l.texture};return this._handles.push(u),u},e.free=function(t){for(var e=0;e<this._handles.length;++e)if(this._handles[e]===t)return this._chunks[t.chunkIdx].end=t.end,void this._handles.splice(e,1)},e.createChunk=function(t){var e=t*t*this._formatSize;C("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+e+", format: "+this._format);var n={texture:this._device.createTexture(new pr(vi.TEX2D,gi.SAMPLED|gi.TRANSFER_DST,this._format,t,t)),size:e,start:0,end:e};return this._chunks[this._chunkCount]=n,this._chunkCount++},e.update=function(t,e){var n=[],i=[],r=t.start/this._formatSize,o=e.byteLength/this._formatSize,a=r%t.texture.width,s=Math.floor(r/t.texture.width),c=Math.min(t.texture.width-a,o),l=0;a>0&&(this._region0.texOffset.x=a,this._region0.texOffset.y=s,this._region0.texExtent.width=c,this._region0.texExtent.height=1,n.push(new this._bufferViewCtor(e,l*this._formatSize,c*this._channels)),i.push(this._region0),a=0,s+=1,o-=c,l+=c),o>0&&(this._region1.texOffset.x=a,this._region1.texOffset.y=s,o>t.texture.width?(this._region1.texExtent.width=t.texture.width,this._region1.texExtent.height=Math.floor(o/t.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=o,this._region1.texExtent.width=c,this._region1.texExtent.height=1),n.push(new this._bufferViewCtor(e,l*this._formatSize,c*this._channels)),i.push(this._region1),a=0,s+=this._region1.texExtent.height,o-=c,l+=c),o>0&&(this._region2.texOffset.x=a,this._region2.texOffset.y=s,this._region2.texExtent.width=o,this._region2.texExtent.height=1,n.push(new this._bufferViewCtor(e,l*this._formatSize,o*this._channels)),i.push(this._region2)),this._device.copyBuffersToTexture(n,t.texture,i)},e._findAvailableSpace=function(t,e){var n=this._chunks[e],i=!1,r=n.start;if(r+t<=n.size)i=!0;else{r=0;for(var o=this._handles.filter((function(t){return t.chunkIdx===e})).sort((function(t,e){return t.start-e.start})),a=0;a<o.length;a++){var s=o[a];if(r+t<=s.start){i=!0;break}r=s.end}!i&&r+t<=n.size&&(i=!0)}return i?r:-1},e._McDonaldAlloc=function(t){t=SW(t,this._alignment);for(var e=0;e<this._chunkCount;++e){var n=this._chunks[e],i=!1,r=n.start;if(r+t<=n.end?i=!0:r>n.end?r+t<=n.size?i=!0:t<=n.end&&(n.start=r=0,i=!0):r===n.end&&(n.start=r=0,n.end=n.size,t<=n.end&&(i=!0)),i){n.start+=t;var o={chunkIdx:e,start:r,end:r+t,texture:n.texture};return this._handles.push(o),o}}var a=Math.sqrt(t/this._formatSize),s=this._roundUpFn&&this._roundUpFn(a,this._formatSize)||Math.max(1024,xW(a)),c=this._chunks[this.createChunk(s)];c.start+=t;var l={chunkIdx:this._chunkCount,start:0,end:t,texture:c.texture};return this._handles.push(l),l},t}(),EW=function(t){if(void 0===yW[t]){var e=1<<gW;yW[t]=e,gW+=1}},wW=Object.freeze({__proto__:null,addStage:EW,scene:AC,createIA:function(t,e){if(!e.positions)return console.error("The data must have positions field"),null;for(var n=[],i=e.positions.length/3,r=0;r<i;++r)n.push(e.positions[3*r],e.positions[3*r+1],e.positions[3*r+2]),e.normals&&n.push(e.normals[3*r],e.normals[3*r+1],e.normals[3*r+2]),e.uvs&&n.push(e.uvs[2*r],e.uvs[2*r+1]),e.colors&&n.push(e.colors[3*r],e.colors[3*r+1],e.colors[3*r+2]);var o=[];o.push(new Er(Xi.ATTR_POSITION,ui.RGB32F)),e.normals&&o.push(new Er(Xi.ATTR_NORMAL,ui.RGB32F)),e.uvs&&o.push(new Er(Xi.ATTR_TEX_COORD,ui.RG32F)),e.colors&&o.push(new Er(Xi.ATTR_COLOR,ui.RGB32F));var a=t.createBuffer(new lr(fi.VERTEX|fi.TRANSFER_DST,mi.DEVICE,4*n.length,4*n.length/i));a.update(new Float32Array(n));var s=null;return e.indices&&(s=t.createBuffer(new lr(fi.INDEX|fi.TRANSFER_DST,mi.DEVICE,2*e.indices.length,2))).update(new Uint16Array(e.indices)),t.createInputAssembler(new Pr(o,[a],s))},get RenderQueue(){return mW},get PassStage(){return vW},genHandle:Zd,getTypeFromHandle:$d,getBindingFromHandle:tm,getCountFromHandle:em,getOffsetFromHandle:nm,customizeType:im,type2reader:rm,type2writer:om,getDefaultFromType:sm,overrideMacros:cm,get BatchingSchemes(){return Av},Pass:Ov,getDeviceShaderVersion:dm,programLib:bm,nearestPOT:xW,TextureBufferPool:TW,MaterialInstance:hC,PassInstance:uC,get PoolType(){return Cs},NULL_HANDLE:0,get NodeView(){return As},NodePool:Ps,get PassView(){return Ts},PassPool:Bs,get AABBView(){return Is},AABBPool:Ns});t("renderer",wW),function(t){t[t.BUTT=0]="BUTT",t[t.ROUND=1]="ROUND",t[t.SQUARE=2]="SQUARE"}(CW||(CW={})),ae(CW),function(t){t[t.BEVEL=0]="BEVEL",t[t.ROUND=1]="ROUND",t[t.MITER=2]="MITER"}(AW||(AW={})),ae(AW),function(t){t[t.PT_CORNER=1]="PT_CORNER",t[t.PT_LEFT=2]="PT_LEFT",t[t.PT_BEVEL=4]="PT_BEVEL",t[t.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(bW||(bW={})),ae(bW);var PW=Math.PI,IW=Math.min,RW=Math.max,DW=Math.cos,BW=Math.sin,MW=Math.abs,OW=Math.sign,NW=.5522847493;function LW(t,e,n,i,r){t.moveTo(e-i,n),t.bezierCurveTo(e-i,n+r*NW,e-i*NW,n+r,e,n+r),t.bezierCurveTo(e+i*NW,n+r,e+i,n+r*NW,e+i,n),t.bezierCurveTo(e+i,n-r*NW,e+i*NW,n-r,e,n-r),t.bezierCurveTo(e-i*NW,n-r,e-i,n-r*NW,e-i,n),t.close()}function FW(t,e,n,i,r,o,a,s,c,l,u){var h,_,f,p,d,m,v,g,y,x,S,C,A,b,T,E;l>10||(d=.5*(o+s),m=.5*(a+c),v=.5*((h=.5*(e+i))+(f=.5*(i+o))),g=.5*((_=.5*(n+r))+(p=.5*(r+a))),((T=MW((i-s)*(b=c-n)-(r-c)*(A=s-e)))+(E=MW((o-s)*b-(a-c)*A)))*(T+E)<t.tessTol*(A*A+b*b)?t.addPoint(s,c,0===u?u|bW.PT_BEVEL:u):(FW(t,e,n,h,_,v,g,S=.5*(v+(y=.5*(f+d))),C=.5*(g+(x=.5*(p+m))),l+1,0),FW(t,S,C,y,x,d,m,s,c,l+1,u)))}var zW,GW,VW,UW,kW,HW,jW,WW,qW,XW,YW,KW,JW,QW,ZW,$W,tq,eq,nq,iq,rq,oq,aq,sq,cq,lq,uq,hq,_q,fq,pq,dq,mq,vq,gq,yq,xq,Sq,Cq,Aq,bq,Tq,Eq,wq,Pq,Iq,Rq,Dq=function(t){function e(e,n){var i;return(i=t.call(this,e,n)||this).dx=0,i.dy=0,i.dmx=0,i.dmy=0,i.flags=0,i.len=0,i.reset(),i}return Q(e,t),e.prototype.reset=function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0},e}(Wn),Bq=function(){function t(){this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}return t.prototype.reset=function(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]},t}(),Mq=function(){function t(){this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=bn.WHITE.clone(),this.lineCap=CW.BUTT,this.strokeColor=bn.BLACK.clone(),this.lineJoin=AW.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null}var e=t.prototype;return e.moveTo=function(t,e){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(t,e,bW.PT_CORNER),this._commandX=t,this._commandY=e},e.lineTo=function(t,e){this.addPoint(t,e,bW.PT_CORNER),this._commandX=t,this._commandY=e},e.bezierCurveTo=function(t,e,n,i,r,o){var a=this._curPath,s=a.points[a.points.length-1];s&&(s.x!==t||s.y!==e||n!==r||i!==o?(FW(this,s.x,s.y,t,e,n,i,r,o,0,bW.PT_CORNER),this._commandX=r,this._commandY=o):this.lineTo(r,o))},e.quadraticCurveTo=function(t,e,n,i){var r=this._commandX,o=this._commandY;this.bezierCurveTo(r+2/3*(t-r),o+2/3*(e-o),n+2/3*(t-n),i+2/3*(e-i),n,i)},e.arc=function(t,e,n,i,r,o){!function(t,e,n,i,r,o,a){var s,c,l=0,u=0,h=0,_=0,f=0,p=0,d=0,m=0,v=0,g=0,y=0,x=0,S=0,C=0;if(u=o-r,a=a||!1)if(MW(u)>=2*PW)u=2*PW;else for(;u<0;)u+=2*PW;else if(MW(u)>=2*PW)u=2*-PW;else for(;u>0;)u-=2*PW;for(c=0|RW(1,IW(MW(u)/(.5*PW)+.5,5)),h=MW(4/3*(1-DW(s=u/c/2))/BW(s)),a||(h=-h),C=0;C<=c;C++)p=e+(_=DW(l=r+u*(C/c)))*i,d=n+(f=BW(l))*i,m=-f*i*h,v=_*i*h,0===C?t.moveTo(p,d):t.bezierCurveTo(g+x,y+S,p-m,d-v,p,d),g=p,y=d,x=m,S=v}(this,t,e,n,i,r,o)},e.ellipse=function(t,e,n,i){LW(this,t,e,n,i),this._curPath.complex=!1},e.circle=function(t,e,n){LW(this,t,e,n,n),this._curPath.complex=!1},e.rect=function(t,e,n,i){this.moveTo(t,e),this.lineTo(t+n,e),this.lineTo(t+n,e+i),this.lineTo(t,e+i),this.close(),this._curPath.complex=!1},e.roundRect=function(t,e,n,i,r){!function(t,e,n,i,r,o){if(o<.1)t.rect(e,n,i,r);else{var a=IW(o,.5*MW(i))*OW(i),s=IW(o,.5*MW(r))*OW(r);t.moveTo(e,n+s),t.lineTo(e,n+r-s),t.bezierCurveTo(e,n+r-s*(1-NW),e+a*(1-NW),n+r,e+a,n+r),t.lineTo(e+i-a,n+r),t.bezierCurveTo(e+i-a*(1-NW),n+r,e+i,n+r-s*(1-NW),e+i,n+r-s),t.lineTo(e+i,n+s),t.bezierCurveTo(e+i,n+s*(1-NW),e+i-a*(1-NW),n,e+i-a,n),t.lineTo(e+a,n),t.bezierCurveTo(e+a*(1-NW),n,e,n+s*(1-NW),e,n+s),t.close()}}(this,t,e,n,i,r),this._curPath.complex=!1},e.clear=function(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var t=this._renderDataList,e=0,n=t.length;e<n;e++){var i=t[e];i&&SH.remove(i)}this._renderDataList.length=0},e.close=function(){this._curPath.closed=!0},e.requestRenderData=function(){var t=SH.add();return this._renderDataList.push(t),t},e.getRenderDataList=function(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList},e.addPoint=function(t,e,n){var i=this._curPath;if(i){var r=this._points,o=i.points,a=r[this.pointsOffset++];a?(a.x=t,a.y=e):(a=new Dq(t,e),r.push(a)),a.flags=n,o.push(a)}},e._addPath=function(){var t=this.pathLength,e=this.paths[t];return e?e.reset():(e=new Bq,this.paths.push(e)),this.pathLength++,this._curPath=e,e},t}(),Oq=Jk.concat([new Er("a_dist",ui.R32F)]),Nq=$k(Oq),Lq=tH(Oq),Fq=function(e){return t({Graphics:e,GraphicsComponent:e}),e}((zW=hc("cc.Graphics"),GW=wc(),VW=fc(110),UW=Ac(),kW=Bc(),HW=Wc(AW),jW=Bc(),WW=Wc(CW),qW=Bc(),XW=Bc(),YW=Bc(),KW=Bc(),JW=Ic(),zW(QW=GW(QW=VW(QW=UW((aq=oq=function(t){function e(){var e;return(e=t.call(this)||this).impl=null,e.model=null,at(e,"_lineWidth",$W,it(e)),at(e,"_strokeColor",tq,it(e)),at(e,"_lineJoin",eq,it(e)),at(e,"_lineCap",nq,it(e)),at(e,"_fillColor",iq,it(e)),at(e,"_miterLimit",rq,it(e)),e._isDrawing=!1,e._isNeedUploadData=!0,e._graphicsUseSubMeshes=[],e._instanceMaterialType=JH.ADD_COLOR,e.impl=new Mq,e}Q(e,t);var n=e.prototype;return n.onRestore=function(){this.impl||this._flushAssembler()},n.onLoad=function(){this.model=zM.root.createModel(iC),this.model.node=this.model.transform=this.node,this._flushAssembler()},n.onEnable=function(){t.prototype.onEnable.call(this),this._updateMtlForGraphics()},n.onDisable=function(){t.prototype.onDisable.call(this)},n.onDestroy=function(){this._sceneGetter=null,this.model&&(zM.root.destroyModel(this.model),this.model=null);var e=this._graphicsUseSubMeshes.length;if(e>0){for(var n=0;n<e;++n)this._graphicsUseSubMeshes[n].destroy();this._graphicsUseSubMeshes.length=0}this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null),t.prototype.onDestroy.call(this)},n.moveTo=function(t,e){this.impl&&this.impl.moveTo(t,e)},n.lineTo=function(t,e){this.impl&&this.impl.lineTo(t,e)},n.bezierCurveTo=function(t,e,n,i,r,o){this.impl&&this.impl.bezierCurveTo(t,e,n,i,r,o)},n.quadraticCurveTo=function(t,e,n,i){this.impl&&this.impl.quadraticCurveTo(t,e,n,i)},n.arc=function(t,e,n,i,r,o){this.impl&&this.impl.arc(t,e,n,i,r,o)},n.ellipse=function(t,e,n,i){this.impl&&this.impl.ellipse(t,e,n,i)},n.circle=function(t,e,n){this.impl&&this.impl.circle(t,e,n)},n.rect=function(t,e,n,i){this.impl&&this.impl.rect(t,e,n,i)},n.roundRect=function(t,e,n,i,r){this.impl&&this.impl.roundRect(t,e,n,i,r)},n.fillRect=function(t,e,n,i){this.rect(t,e,n,i),this.fill()},n.clear=function(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(var t=0;t<this.model.subModels.length;t++)this.model.subModels[t].inputAssembler.indexCount=0;this.markForUpdateRenderData()}},n.close=function(){this.impl&&this.impl.close()},n.stroke=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)},n.fill=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)},n._updateMtlForGraphics=function(){var t;this._customMaterial?t=this.getMaterialInstance(0):(t=wv.get("ui-graphics-material"),this.setMaterial(t,0),(t=this.getMaterialInstance(0)).recompileShaders({USE_LOCAL:!0}))},n.activeSubModel=function(t){if(this.model){if(this.model.subModels.length<=t){var e=c.director.root.device,n=e.createBuffer(new lr(fi.VERTEX|fi.TRANSFER_DST,mi.DEVICE,65535*Lq,Lq)),i=e.createBuffer(new lr(fi.INDEX|fi.TRANSFER_DST,mi.DEVICE,131070*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),r=new LE([n],Oq,Ni.TRIANGLE_LIST,i);r.subMeshIdx=0,this.model.initSubModel(t,r,this.getMaterialInstance(0)),this._graphicsUseSubMeshes.push(r)}}else I(4500,this.node.name)},n._uploadData=function(){var t=this.impl;if(t){var e=t&&t.getRenderDataList();if(!(e.length<=0)&&this.model){for(var n=this.model.subModels,i=0;i<e.length;i++){var r=e[i],o=n[i].inputAssembler;if(r.lastFilledVertex!==r.vertexStart){var a=new Float32Array(r.vData.buffer,0,r.vertexStart*Nq);o.vertexBuffers[0].update(a),o.vertexCount=r.vertexStart;var s=new Uint16Array(r.iData.buffer,0,r.indexStart);o.indexBuffer.update(s),o.indexCount=r.indexStart,r.lastFilledVertex=r.vertexStart,r.lastFilledIndex=r.indexStart}}this._isNeedUploadData=!1}}},n._render=function(t){if(this._isNeedUploadData){if(this.impl){var e=this.impl.getRenderDataList(),n=this.model.subModels.length;if(e.length>n)for(var i=n;i<e.length;i++)this.activeSubModel(i)}this._uploadData()}t.commitModel(this,this.model,this.getMaterialInstance(0))},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this._assembler=t)},n._canRender=function(){return!!t.prototype._canRender.call(this)&&!!this.model&&this._isDrawing},K(e,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(t){this._lineWidth=t,this.impl&&(this.impl.lineWidth=t)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(t){this._lineJoin=t,this.impl&&(this.impl.lineJoin=t)}},{key:"lineCap",get:function(){return this._lineCap},set:function(t){this._lineCap=t,this.impl&&(this.impl.lineCap=t)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(t){this.impl&&(this._strokeColor.set(t),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(t){this.impl&&(this._fillColor.set(t),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(t){this._miterLimit=t}},{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&this._color.set(t)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(){}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(){}}]),e}(pW),oq.LineJoin=AW,oq.LineCap=CW,st((ZW=aq).prototype,"lineWidth",[Pc,kW],Object.getOwnPropertyDescriptor(ZW.prototype,"lineWidth"),ZW.prototype),st(ZW.prototype,"lineJoin",[HW,jW],Object.getOwnPropertyDescriptor(ZW.prototype,"lineJoin"),ZW.prototype),st(ZW.prototype,"lineCap",[WW,qW],Object.getOwnPropertyDescriptor(ZW.prototype,"lineCap"),ZW.prototype),st(ZW.prototype,"strokeColor",[XW],Object.getOwnPropertyDescriptor(ZW.prototype,"strokeColor"),ZW.prototype),st(ZW.prototype,"fillColor",[YW],Object.getOwnPropertyDescriptor(ZW.prototype,"fillColor"),ZW.prototype),st(ZW.prototype,"miterLimit",[KW],Object.getOwnPropertyDescriptor(ZW.prototype,"miterLimit"),ZW.prototype),st(ZW.prototype,"color",[el,JW],Object.getOwnPropertyDescriptor(ZW.prototype,"color"),ZW.prototype),$W=st(ZW.prototype,"_lineWidth",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),tq=st(ZW.prototype,"_strokeColor",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bn.BLACK.clone()}}),eq=st(ZW.prototype,"_lineJoin",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AW.MITER}}),nq=st(ZW.prototype,"_lineCap",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CW.BUTT}}),iq=st(ZW.prototype,"_fillColor",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bn.WHITE.clone()}}),rq=st(ZW.prototype,"_miterLimit",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),QW=ZW))||QW)||QW)||QW)||QW));c.Graphics=Fq;var zq,Gq=new Un,Vq=new Wn,Uq=new Un,kq=[];!function(t){t[t.RECT=0]="RECT",t[t.ELLIPSE=1]="ELLIPSE",t[t.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL",t[t.IMAGE_STENCIL=3]="IMAGE_STENCIL"}(zq||(zq={})),ae(zq);var Hq=function(e){return t({Mask:e,MaskComponent:e}),e}((sq=hc("cc.Mask"),cq=wc(),lq=fc(110),uq=Ac(),hq=Wc(zq),_q=Bc(),fq=zc(),pq=Bc(),dq=Ic(),mq=Wc(ik),vq=Ic(),gq=Ic(),yq=Mc(),xq=Ic(),Sq=Ic(),sq(Cq=cq(Cq=lq(Cq=uq((Rq=Iq=function(t){function e(){var e;return(e=t.call(this)||this)._clearStencilMtl=null,e._clearModel=null,at(e,"_type",bq,it(e)),at(e,"_inverted",Tq,it(e)),at(e,"_segments",Eq,it(e)),at(e,"_spriteFrame",wq,it(e)),at(e,"_alphaThreshold",Pq,it(e)),e._graphics=null,e._clearModelMesh=null,e._instanceMaterialType=JH.ADD_COLOR,e}Q(e,t);var n=e.prototype;return n.onLoad=function(){this._createClearModel(),this._createGraphics(),this._graphics&&this._graphics.onLoad()},n.onEnable=function(){t.prototype.onEnable.call(this),this._updateGraphics(),this._enableGraphics()},n.onRestore=function(){this._createGraphics(),t.prototype.updateMaterial.call(this),this._updateGraphics(),this._renderFlag=this._canRender()},n.onDisable=function(){t.prototype.onDisable.call(this),this._disableGraphics()},n.onDestroy=function(){this._clearModel&&this._clearModelMesh&&(zM.root.destroyModel(this._clearModel),this._clearModelMesh.destroy()),this._clearStencilMtl&&this._clearStencilMtl.destroy(),this._removeGraphics(),t.prototype.onDestroy.call(this)},n.isHit=function(t){var e=this.node._uiProps.uiTransformComp,n=e.contentSize,i=n.width,r=n.height,o=Vq;this.node.getWorldMatrix(Gq),Un.invert(Uq,Gq),Wn.transformMat4(o,t,Uq);var a=e.anchorPoint;o.x+=a.x*i,o.y+=a.y*r;var s=!1;if(this.type===zq.RECT||this.type===zq.GRAPHICS_STENCIL||this.type===zq.IMAGE_STENCIL)s=o.x>=0&&o.y>=0&&o.x<=i&&o.y<=r;else if(this.type===zq.ELLIPSE){var c=i/2,l=r/2,u=o.x-.5*i,h=o.y-.5*r;s=u*u/(c*c)+h*h/(l*l)<1}return this._inverted&&(s=!s),s},n._render=function(t){t.commitComp(this,this.renderData,null,this._assembler,null)},n._postRender=function(t){this._postAssembler&&t.commitComp(this,null,null,this._postAssembler,null)},n._nodeStateChange=function(e){t.prototype._nodeStateChange.call(this,e),this._updateGraphics()},n._canRender=function(){return!!t.prototype._canRender.call(this)&&null!==this._graphics&&(this._type!==zq.IMAGE_STENCIL||null!==this._spriteFrame)},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this),n=e.PostAssembler.getAssembler(this);this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._postAssembler!==n&&(this._postAssembler=n),this._useRenderData()},n._createGraphics=function(){if(!this._graphics){var t=this._graphics=new Fq;t._objFlags|=ul.Flags.IsOnLoadCalled,t.node=this.node,t.node.getWorldMatrix(),t.lineWidth=0;var e=bn.WHITE.clone();e.a=0,t.fillColor=e}this._updateMaterial()},n._updateGraphics=function(){if(this._graphics&&(this._type===zq.RECT||this._type===zq.ELLIPSE)){var t=this.node._uiProps.uiTransformComp,e=this._graphics;e.clear();var n=t.contentSize,i=n.width,r=n.height,o=t.anchorPoint,a=-i*o.x,s=-r*o.y;if(this._type===zq.RECT)e.rect(a,s,i,r);else if(this._type===zq.ELLIPSE){for(var c=function(t,e,n){kq.length=0;for(var i=2*Math.PI/n,r=0;r<n;++r)kq.push(new En(e.x*Math.cos(i*r)+t.x,e.y*Math.sin(i*r)+t.y,0));return kq}(new En(a+i/2,s+r/2,0),new En(i/2,r/2,0),this._segments),l=0;l<c.length;++l){var u=c[l];0===l?e.moveTo(u.x,u.y):e.lineTo(u.x,u.y)}e.close()}e.fill()}},n._createClearModel=function(){if(!this._clearModel){var t=wv.get("default-clear-stencil");this._clearStencilMtl=new hC({parent:t,owner:this,subModelIdx:0}),this._clearModel=zM.root.createModel(iC),this._clearModel.node=this._clearModel.transform=this.node;var e=tH(Kk),n=c.director.root.device,i=n.createBuffer(new lr(fi.VERTEX|fi.TRANSFER_DST,mi.DEVICE,4*e,e)),r=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);i.update(r);var o=n.createBuffer(new lr(fi.INDEX|fi.TRANSFER_DST,mi.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),a=new Uint16Array([0,1,2,2,1,3]);o.update(a),this._clearModelMesh=new LE([i],Kk,Ni.TRIANGLE_LIST,o),this._clearModelMesh.subMeshIdx=0,this._clearModel.initSubModel(0,this._clearModelMesh,this._clearStencilMtl)}},n._updateMaterial=function(){if(this._graphics){var t,e=this._graphics;e.stencilStage=dH.DISABLED,this._type===zq.IMAGE_STENCIL?(t=wv.get("ui-alpha-test-material"),e.setMaterial(t,0),(t=e.getMaterialInstance(0)).setProperty("alphaThreshold",this._alphaThreshold)):(t=wv.get("ui-graphics-material"),e.setMaterial(t,0),e.getMaterialInstance(0))}},n._enableGraphics=function(){this._graphics&&(this._graphics._renderFlag=this._graphics._canRender())},n._disableGraphics=function(){this._graphics&&this._graphics.onDisable()},n._removeGraphics=function(){this._graphics&&(this._graphics.destroy(),this._graphics._destroyImmediate(),this._graphics=null)},n._useRenderData=function(){this._type!==zq.IMAGE_STENCIL||this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())},K(e,[{key:"type",get:function(){return this._type},set:function(t){this._type!==t&&(this._type=t,this.markForUpdateRenderData(!1),this._updateMaterial(),this._type!==zq.IMAGE_STENCIL?(this._spriteFrame=null,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null)):(this._useRenderData(),this._graphics&&this._graphics.clear()))}},{key:"inverted",get:function(){return this._inverted},set:function(t){this._inverted=t,this.stencilStage=dH.DISABLED,this._graphics&&(this._graphics.stencilStage=dH.DISABLED)}},{key:"segments",get:function(){return this._segments},set:function(t){this._segments!==t&&(this._segments=on(t,3,1e4),this._updateGraphics())}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(t){if(this._spriteFrame!==t){var e=this._spriteFrame;this._spriteFrame=t,this._type===zq.IMAGE_STENCIL&&!e&&t&&this.markForUpdateRenderData()}}},{key:"alphaThreshold",get:function(){return this._alphaThreshold},set:function(t){this._alphaThreshold!==t&&(this._alphaThreshold=t,this.type===zq.IMAGE_STENCIL&&this._graphics&&this._graphics.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold))}},{key:"graphics",get:function(){return this._graphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(t){this._dstBlendFactor!==t&&(this._dstBlendFactor=t,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(t){this._srcBlendFactor!==t&&(this._srcBlendFactor=t,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&(this._color.set(t),this.markForUpdateRenderData())}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(){}}]),e}(pW),Iq.Type=zq,st((Aq=Rq).prototype,"type",[hq,_q],Object.getOwnPropertyDescriptor(Aq.prototype,"type"),Aq.prototype),st(Aq.prototype,"inverted",[fq,pq],Object.getOwnPropertyDescriptor(Aq.prototype,"inverted"),Aq.prototype),st(Aq.prototype,"segments",[dq],Object.getOwnPropertyDescriptor(Aq.prototype,"segments"),Aq.prototype),st(Aq.prototype,"spriteFrame",[mq,vq],Object.getOwnPropertyDescriptor(Aq.prototype,"spriteFrame"),Aq.prototype),st(Aq.prototype,"alphaThreshold",[gq,yq,Fc],Object.getOwnPropertyDescriptor(Aq.prototype,"alphaThreshold"),Aq.prototype),st(Aq.prototype,"color",[el,xq],Object.getOwnPropertyDescriptor(Aq.prototype,"color"),Aq.prototype),st(Aq.prototype,"customMaterial",[el,Sq],Object.getOwnPropertyDescriptor(Aq.prototype,"customMaterial"),Aq.prototype),bq=st(Aq.prototype,"_type",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zq.RECT}}),Tq=st(Aq.prototype,"_inverted",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Eq=st(Aq.prototype,"_segments",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),wq=st(Aq.prototype,"_spriteFrame",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Pq=st(Aq.prototype,"_alphaThreshold",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Cq=Aq))||Cq)||Cq)||Cq)||Cq));CR._maskComp=Hq,c.Mask=Hq;var jq,Wq,qq,Xq,Yq,Kq,Jq,Qq,Zq,$q,tX,eX,nX,iX,rX,oX,aX,sX,cX,lX,uX,hX,_X,fX,pX,dX,mX,vX,gX,yX,xX,SX,CX,AX,bX,TX,EX,wX,PX,IX,RX,DX,BX,MX,OX,NX,LX,FX,zX,GX,VX,UX,kX,HX,jX,WX,qX,XX,YX,KX,JX,QX,ZX=/^(click)(\s)*=|(param)(\s)*=/,$X=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,tY=t("HtmlTextParser",function(){function t(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}var e=t.prototype;return e.parse=function(t){this._resultObjectArray.length=0,this._stack.length=0;for(var e=0,n=t.length;e<n;){var i=t.indexOf(">",e),r=-1;if(i>=0&&(r=t.lastIndexOf("<",i))<e-1&&(r=t.indexOf("<",i+1),i=t.indexOf(">",r+1)),r<0)this._stack.pop(),this._processResult(t.substring(e)),e=n;else{var o=t.substring(e,r),a=t.substring(r+1,i);""===a&&(o=t.substring(e,i+1)),this._processResult(o),-1===i?i=r:"/"===t.charAt(r+1)?this._stack.pop():this._addToStack(a),e=i+1}}return this._resultObjectArray},e._attributeToObject=function(t){t=t.trim();var e={},n=/^(color|size)(\s)*=/.exec(t),i="",r=0,o="";if(n){if(i=n[0],""===(t=t.substring(i.length).trim()))return e;switch(r=t.indexOf(" "),i[0]){case"c":e.color=r>-1?t.substring(0,r).trim():t;break;case"s":e.size=parseInt(t)}return r>-1&&(o=t.substring(r+1).trim(),e.event=this._processEventHandler(o)),e}if((n=/^(br(\s)*\/)/.exec(t))&&n[0].length>0&&(i=n[0].trim()).startsWith("br")&&"/"===i[i.length-1])return e.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),e;var a="";if((n=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(t))&&n[0].length>0&&(i=n[0].trim()).startsWith("img")&&"/"===i[i.length-1]){var s;n=$X.exec(t);for(var c=!1;n;){if(i=(t=t.substring(t.indexOf(n[0]))).substr(0,n[0].length),s=(r=(a=t.substring(i.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),t=a.substring(r).trim(),s.endsWith("/")&&(s=s.slice(0,-1)),"src"===i){switch(s.charCodeAt(0)){case 34:case 39:c=!0,s=s.slice(1,-1)}e.isImage=!0,e.src=s}else if("height"===i)e.imageHeight=parseInt(s);else if("width"===i)e.imageWidth=parseInt(s);else if("align"===i){switch(s.charCodeAt(0)){case 34:case 39:s=s.slice(1,-1)}e.imageAlign=s.toLowerCase()}else"offset"===i?e.imageOffset=s:"click"===i&&(e.event=this._processEventHandler(i+"="+s));e.event&&"param"===i&&(e.event[i]=s.replace(/^"|"$/g,"")),n=$X.exec(t)}return c&&e.isImage&&this._resultObjectArray.push({text:"",style:e}),{}}if(n=/^(outline(\s)*[^>]*)/.exec(t)){var l={color:"#ffffff",width:1};if(t=n[0].substring("outline".length).trim()){var u,h=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(n=h.exec(t);n;)i=(t=t.substring(t.indexOf(n[0]))).substr(0,n[0].length),u=(r=(a=t.substring(i.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),t=a.substring(r).trim(),"click"===i?e.event=this._processEventHandler(i+"="+u):"color"===i?l.color=u:"width"===i&&(l.width=parseInt(u)),e.event&&"param"===i&&(e.event[i]=u.replace(/^"|"$/g,"")),n=h.exec(t)}e.outline=l}if((n=/^(on|u|b|i)(\s)*/.exec(t))&&n[0].length>0){switch(i=n[0],t=t.substring(i.length).trim(),i[0]){case"u":e.underline=!0;break;case"i":e.italic=!0;break;case"b":e.bold=!0}if(""===t)return e;e.event=this._processEventHandler(t)}return e},e._processEventHandler=function(t){for(var e={},n=0,i=!1,r=ZX.exec(t);r;){var o=r[0],a="";if(i=!1,'"'===(t=t.substring(o.length).trim()).charAt(0))(n=t.indexOf('"',1))>-1&&(a=t.substring(1,n).trim(),i=!0),n++;else if("'"===t.charAt(0))(n=t.indexOf("'",1))>-1&&(a=t.substring(1,n).trim(),i=!0),n++;else{var s=/(\S)+/.exec(t);n=(a=s?s[0]:"").length}i&&(e[o=o.substring(0,o.length-1).trim()]=a),t=t.substring(n).trim(),r=ZX.exec(t)}return e},e._addToStack=function(t){var e=this._attributeToObject(t);if(0===this._stack.length)this._stack.push(e);else{if(e.isNewLine||e.isImage)return;var n=this._stack[this._stack.length-1];for(var i in n)e[i]||(e[i]=n[i]);this._stack.push(e)}},e._processResult=function(t){0!==t.length&&(t=this._escapeSpecialSymbol(t),this._stack.length>0?this._resultObjectArray.push({text:t,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:t}))},e._escapeSpecialSymbol=function(t){for(var e,n=ot(this._specialSymbolArray);!(e=n()).done;){var i=e.value,r=i[0],o=i[1];t=t.replace(r,o)}return t},t}()),eY=function(e){return t({LabelOutline:e,LabelOutlineComponent:e}),e}((jq=hc("cc.LabelOutline"),Wq=wc(),qq=fc(110),Xq=Ac(),Yq=_c(dW),Kq=Bc(),Jq=Bc(),jq(Qq=Wq(Qq=qq(Qq=Xq(Qq=Yq(Qq=Cc((eX=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_color",$q,it(e)),at(e,"_width",tX,it(e)),e}Q(e,t);var n=e.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var t=this.node.getComponent(dW);t&&t.updateRenderData(!0)},K(e,[{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&(this._color.set(t),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(t){this._width!==t&&(this._width=t,this._updateRenderData())}}]),e}(Ku),$q=st((Zq=eX).prototype,"_color",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new bn(0,0,0,255)}}),tX=st(Zq.prototype,"_width",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),st(Zq.prototype,"color",[Kq],Object.getOwnPropertyDescriptor(Zq.prototype,"color"),Zq.prototype),st(Zq.prototype,"width",[Jq],Object.getOwnPropertyDescriptor(Zq.prototype,"width"),Zq.prototype),Qq=Zq))||Qq)||Qq)||Qq)||Qq)||Qq)||Qq));c.LabelOutline=eY,function(t){t[t.SIMPLE=0]="SIMPLE",t[t.SLICED=1]="SLICED",t[t.TILED=2]="TILED",t[t.FILLED=3]="FILLED"}(YX||(YX={})),ae(YX),function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL",t[t.RADIAL=2]="RADIAL"}(KX||(KX={})),ae(KX),function(t){t[t.CUSTOM=0]="CUSTOM",t[t.TRIMMED=1]="TRIMMED",t[t.RAW=2]="RAW"}(JX||(JX={})),ae(JX),function(t){t.SPRITE_FRAME_CHANGED="spriteframe-changed"}(QX||(QX={}));var nY,iY=function(e){return t({Sprite:e,SpriteComponent:e}),e}((nX=hc("cc.Sprite"),iX=wc(),rX=fc(110),oX=Ac(),aX=Wc(ok),sX=zc(),cX=Bc(),lX=Wc(ik),uX=zc(),hX=Bc(),_X=Wc(YX),fX=zc(),pX=Bc(),dX=Wc(KX),mX=zc(),vX=Bc(),gX=zc(),yX=Bc(),xX=Mc(),SX=zc(),CX=Bc(),AX=Mc(),bX=zc(),TX=Bc(),EX=Ic(),wX=zc(),PX=Bc(),IX=zc(),RX=Bc(),DX=Wc(JX),BX=zc(),MX=Bc(),nX(OX=iX(OX=rX(OX=oX((XX=qX=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_spriteFrame",LX,it(e)),at(e,"_type",FX,it(e)),at(e,"_fillType",zX,it(e)),at(e,"_sizeMode",GX,it(e)),at(e,"_fillCenter",VX,it(e)),at(e,"_fillStart",UX,it(e)),at(e,"_fillRange",kX,it(e)),at(e,"_isTrimmedMode",HX,it(e)),at(e,"_useGrayscale",jX,it(e)),at(e,"_atlas",WX,it(e)),e}Q(e,t);var n=e.prototype;return n.__preload=function(){this.changeMaterialForDefine(),t.prototype.__preload.call(this)},n.onEnable=function(){t.prototype.onEnable.call(this),this._activateMaterial();var e=this._spriteFrame;e&&(this._updateUVs(),this._type===YX.SLICED&&e.on(ik.EVENT_UV_UPDATED,this._updateUVs,this))},n.onDisable=function(){this._spriteFrame&&this._type===YX.SLICED&&this._spriteFrame.off(ik.EVENT_UV_UPDATED,this._updateUVs,this)},n.onDestroy=function(){t.prototype.onDestroy.call(this)},n.changeSpriteFrameFromAtlas=function(t){if(this._atlas){var e=this._atlas.getSpriteFrame(t);this.spriteFrame=e}else console.warn("SpriteAtlas is null.")},n.changeMaterialForDefine=function(){var t,e=this._instanceMaterialType;this._spriteFrame&&(t=this._spriteFrame.texture);var n=!1;if(t instanceof Xm){var i=t.getPixelFormat();n=i===Em.RGBA_ETC1||i===Em.RGB_A_PVRTC_4BPPV1||i===Em.RGB_A_PVRTC_2BPPV1}n&&this.grayscale?this._instanceMaterialType=JH.USE_ALPHA_SEPARATED_AND_GRAY:n?this._instanceMaterialType=JH.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=JH.GRAYSCALE:this._instanceMaterialType=JH.ADD_COLOR_AND_TEXTURE,e!==this._instanceMaterialType&&this.updateMaterial()},n._updateBuiltinMaterial=function(){var e=t.prototype._updateBuiltinMaterial.call(this);if(this.spriteFrame&&this.spriteFrame.texture instanceof OS){var n=J({SAMPLE_FROM_RT:!0},e.passes[0].defines),i=new ig;i.initialize({effectAsset:e.effectAsset,defines:n}),e=i}return e},n._render=function(t){t.commitComp(this,this.renderData,this._spriteFrame,this._assembler,null)},n._canRender=function(){if(!t.prototype._canRender.call(this))return!1;var e=this._spriteFrame;return!(!e||!e.texture)},n._flushAssembler=function(){var t=e.Assembler.getAssembler(this);this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this.spriteFrame&&this._assembler.updateUVs(this),this._updateColor()),this._spriteFrame&&(this._type===YX.SLICED?this._spriteFrame.on(ik.EVENT_UV_UPDATED,this._updateUVs,this):this._spriteFrame.off(ik.EVENT_UV_UPDATED,this._updateUVs,this))},n._applySpriteSize=function(){if(this._spriteFrame){if(!this._spriteFrame.isDefault)if(JX.RAW===this._sizeMode){var t=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(t)}else if(JX.TRIMMED===this._sizeMode){var e=this._spriteFrame.rect;this.node._uiProps.uiTransformComp.setContentSize(e.width,e.height)}this._activateMaterial()}},n._resized=function(){},n._activateMaterial=function(){var t=this._spriteFrame,e=this.getRenderMaterial(0);t&&e&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=e)},n._updateUVs=function(){this._assembler&&this._assembler.updateUVs(this)},n._applySpriteFrame=function(t){var e=this._spriteFrame;t&&this._type===YX.SLICED&&t.off(ik.EVENT_UV_UPDATED,this._updateUVs,this),this._updateUVs();var n=!1;e&&(t&&t.texture===e.texture||(n=!0),n&&(this._renderData&&(this._renderData.textureDirty=!0),this.changeMaterialForDefine()),this._applySpriteSize(),this._type===YX.SLICED&&e.on(ik.EVENT_UV_UPDATED,this._updateUVs,this))},K(e,[{key:"spriteAtlas",get:function(){return this._atlas},set:function(t){this._atlas!==t&&(this._atlas=t)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(t){if(this._spriteFrame!==t){var e=this._spriteFrame;this._spriteFrame=t,this.markForUpdateRenderData(!1),this._applySpriteFrame(e)}}},{key:"type",get:function(){return this._type},set:function(t){this._type!==t&&(this._type=t,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(t){this._fillType!==t&&(t===KX.RADIAL||this._fillType===KX.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=t,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(t){this._fillCenter.x=t.x,this._fillCenter.y=t.y,this._type===YX.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(t){this._fillStart=on(t,0,1),this._type===YX.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"fillRange",get:function(){return this._fillRange},set:function(t){this._fillRange=on(t,-1,1),this._type===YX.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(t){this._isTrimmedMode!==t&&(this._isTrimmedMode=t,this._type===YX.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"grayscale",get:function(){return this._useGrayscale},set:function(t){this._useGrayscale!==t&&(this._useGrayscale=t,this.changeMaterialForDefine(),this.updateMaterial())}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(t){this._sizeMode!==t&&(this._sizeMode=t,t!==JX.CUSTOM&&this._applySpriteSize())}}]),e}(pW),qX.FillType=KX,qX.Type=YX,qX.SizeMode=JX,qX.EventType=QX,st((NX=XX).prototype,"spriteAtlas",[aX,sX,cX],Object.getOwnPropertyDescriptor(NX.prototype,"spriteAtlas"),NX.prototype),st(NX.prototype,"spriteFrame",[lX,uX,hX],Object.getOwnPropertyDescriptor(NX.prototype,"spriteFrame"),NX.prototype),st(NX.prototype,"type",[_X,fX,pX],Object.getOwnPropertyDescriptor(NX.prototype,"type"),NX.prototype),st(NX.prototype,"fillType",[dX,mX,vX],Object.getOwnPropertyDescriptor(NX.prototype,"fillType"),NX.prototype),st(NX.prototype,"fillCenter",[gX,yX],Object.getOwnPropertyDescriptor(NX.prototype,"fillCenter"),NX.prototype),st(NX.prototype,"fillStart",[xX,SX,CX],Object.getOwnPropertyDescriptor(NX.prototype,"fillStart"),NX.prototype),st(NX.prototype,"fillRange",[AX,bX,TX],Object.getOwnPropertyDescriptor(NX.prototype,"fillRange"),NX.prototype),st(NX.prototype,"trim",[EX,wX,PX],Object.getOwnPropertyDescriptor(NX.prototype,"trim"),NX.prototype),st(NX.prototype,"grayscale",[Pc,IX,RX],Object.getOwnPropertyDescriptor(NX.prototype,"grayscale"),NX.prototype),st(NX.prototype,"sizeMode",[DX,BX,MX],Object.getOwnPropertyDescriptor(NX.prototype,"sizeMode"),NX.prototype),LX=st(NX.prototype,"_spriteFrame",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),FX=st(NX.prototype,"_type",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return YX.SIMPLE}}),zX=st(NX.prototype,"_fillType",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return KX.HORIZONTAL}}),GX=st(NX.prototype,"_sizeMode",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return JX.TRIMMED}}),VX=st(NX.prototype,"_fillCenter",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wn(0,0)}}),UX=st(NX.prototype,"_fillStart",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kX=st(NX.prototype,"_fillRange",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),HX=st(NX.prototype,"_isTrimmedMode",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),jX=st(NX.prototype,"_useGrayscale",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),WX=st(NX.prototype,"_atlas",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),OX=NX))||OX)||OX)||OX)||OX));c.Sprite=iY;var rY,oY,aY,sY,cY,lY,uY,hY,_Y,fY,pY,dY,mY,vY,gY,yY,xY,SY,CY,AY,bY,TY,EY,wY,PY,IY,RY,DY,BY,MY,OY,NY,LY,FY,zY,GY,VY,UY,kY,HY,jY,WY,qY,XY,YY,KY,JY,QY,ZY,$Y=t("RenderRoot2D",hc("cc.RenderRoot2D")(nY=fc(100)(nY=Ac()(nY=_c(RH)(nY=pc(nY=Cc(nY=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.onEnable=function(){c.director.root.batcher2D.addScreen(this)},n.onDisable=function(){c.director.root.batcher2D.removeScreen(this)},n.onDestroy=function(){c.director.root.batcher2D.removeScreen(this)},e}(Ku))||nY)||nY)||nY)||nY)||nY)||nY),tK=new En,eK=ie({OVERLAY:0,INTERSPERSE:1}),nK=function(e){return t({Canvas:e,CanvasComponent:e}),e}((rY=hc("cc.Canvas"),oY=wc(),aY=fc(100),sY=Ac(),cY=Wc(ZL),lY=Bc(),uY=Bc(),hY=Wc(ZL),rY(_Y=oY(_Y=aY(_Y=sY(_Y=Cc(_Y=pc((st((fY=function(t){function e(){var e;return at(e=t.call(this)||this,"_cameraComponent",pY,it(e)),at(e,"_alignCanvasWithScreen",dY,it(e)),e._thisOnCameraResized=void 0,e._fitDesignResolution=void 0,e._pos=new En,e._renderMode=eK.OVERLAY,e._thisOnCameraResized=e._onResizeCamera.bind(it(e)),e}Q(e,t);var n=e.prototype;return n.__preload=function(){var t=this.getComponent("cc.Widget");t&&t.updateAlignment(),this._cameraComponent&&(this._cameraComponent._createCamera(),this._cameraComponent.node.on(ZL.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)),this._onResizeCamera(),this.node.on(FA.TRANSFORM_CHANGED,this._thisOnCameraResized)},n.onEnable=function(){t.prototype.onEnable.call(this),this._cameraComponent&&this._cameraComponent.node.on(ZL.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDisable=function(){t.prototype.onDisable.call(this),this._cameraComponent&&this._cameraComponent.node.off(ZL.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDestroy=function(){t.prototype.onDestroy.call(this),this.node.off(FA.TRANSFORM_CHANGED,this._thisOnCameraResized)},n._onResizeCamera=function(){if(this._cameraComponent&&this._alignCanvasWithScreen){if(this._cameraComponent.targetTexture)this._cameraComponent.orthoHeight=UM.height/2;else{var t=rh.windowSize;this._cameraComponent.orthoHeight=t.height/YM.getScaleY()/2}this.node.getWorldPosition(tK),this._cameraComponent.node.setWorldPosition(tK.x,tK.y,1e3)}},n._getViewPriority=function(){if(this._cameraComponent){var t,e=null===(t=this.cameraComponent)||void 0===t?void 0:t.priority;return this._renderMode===eK.OVERLAY?e|1<<30:e&~(1<<30)}return 0},K(e,[{key:"renderMode",get:function(){return this._renderMode},set:function(t){this._renderMode=t,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}},{key:"cameraComponent",get:function(){return this._cameraComponent},set:function(t){this._cameraComponent!==t&&(this._cameraComponent=t,this._onResizeCamera())}},{key:"alignCanvasWithScreen",get:function(){return this._alignCanvasWithScreen},set:function(t){this._alignCanvasWithScreen=t,this._onResizeCamera()}}]),e}($Y)).prototype,"cameraComponent",[cY,lY],Object.getOwnPropertyDescriptor(fY.prototype,"cameraComponent"),fY.prototype),st(fY.prototype,"alignCanvasWithScreen",[uY],Object.getOwnPropertyDescriptor(fY.prototype,"alignCanvasWithScreen"),fY.prototype),pY=st(fY.prototype,"_cameraComponent",[hY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dY=st(fY.prototype,"_alignCanvasWithScreen",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_Y=fY))||_Y)||_Y)||_Y)||_Y)||_Y)||_Y));c.Canvas=nK,G(t("UIComponent",hc("cc.UIComponent")(mY=_c(RH)(mY=fc(110)(mY=pc(mY=Cc(mY=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._lastParent=null,e.stencilStage=dH.DISABLED,e}Q(e,t);var n=e.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onEnable=function(){},n.onDisable=function(){},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},e}(Ku))||mY)||mY)||mY)||mY)||mY).prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]),z(nK.prototype,"Canvas.prototype",[{name:"camera",newName:"cameraComponent.camera",customGetter:function(){return this._cameraComponent.camera}},{name:"clearFlag",newName:"cameraComponent.clearFlags",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearFlags:0},customSetter:function(t){this._cameraComponent&&(this._cameraComponent.clearFlags=t)}},{name:"color",newName:"cameraComponent.clearColor",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearColor:bn.BLACK},customSetter:function(t){this._cameraComponent&&(this._cameraComponent.clearColor=t)}},{name:"priority",newName:"cameraComponent.priority",customGetter:function(){return this._cameraComponent?this._cameraComponent.priority:0},customSetter:function(t){this._cameraComponent&&(this._cameraComponent.priority=t)}},{name:"targetTexture",newName:"cameraComponent.targetTexture",customGetter:function(){return this._cameraComponent?this._cameraComponent.targetTexture:null},customSetter:function(t){this._cameraComponent&&(this._cameraComponent.targetTexture=t)}},{name:"visibility",newName:"cameraComponent.visibility",customGetter:function(){return this._cameraComponent?this._cameraComponent.visibility:0}}]),V(pW.prototype,"Renderable2D.prototype",[{name:"srcBlendFactor",suggest:"Please use a custom material to specify blending options instead."},{name:"dstBlendFactor",suggest:"Please use a custom material to specify blending options instead."}]),V(RH.prototype,"UITransform.prototype",[{name:"priority",suggest:"Please use setSiblingIndex to change index of the current node in its parent's children array."}]),c.UITransformComponent=RH,ee.setClassAlias(RH,"cc.UITransformComponent"),ee.setClassAlias(pW,"cc.RenderComponent"),c.CanvasComponent=nK,ee.setClassAlias(nK,"cc.CanvasComponent");var iK=new tY,rK="RICHTEXT_CHILD",oK="RICHTEXT_Image_CHILD",aK=new $t((function(t){if(!c.isValid(t.node))return!1;var e=t.node.getComponent(eY);return e&&(e.width=0),!0}),20),sK=new $t((function(t){return c.isValid(t.node)}),10);function cK(t){return{node:new GT(t),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:t}}function lK(t,e){var n;t===rK?n=aK._get():t===oK&&(n=sK._get());var i=(n=n||cK(t)).node;return i||(i=new GT(t)),i.hideFlags|=ul.Flags.DontSave|ul.Flags.HideInHierarchy,t===oK?(n.comp=i.getComponent(iY)||i.addComponent(iY),n.comp.spriteFrame=e,n.comp.type=iY.Type.SLICED,n.comp.sizeMode=iY.SizeMode.CUSTOM):(n.comp=i.getComponent(dW)||i.addComponent(dW),n.comp.string=e,n.comp.horizontalAlign=uW.LEFT,n.comp.verticalAlign=hW.TOP),i.setPosition(0,0,0),i._uiProps.uiTransformComp.setAnchorPoint(.5,.5),n.node=i,n.lineCount=0,n.styleIndex=0,n.imageOffset="",n.clickParam="",n.clickHandler="",n}var uK,hK=function(e){return t({RichText:e,RichTextComponent:e}),e}((vY=hc("cc.RichText"),gY=wc(),yY=fc(110),xY=Ac(),SY=Bc(),CY=Wc(uW),AY=Bc(),bY=Bc(),TY=Bc(),EY=Wc(uk),wY=Bc(),PY=Bc(),IY=zc(),RY=Wc(fW),DY=Bc(),BY=Bc(),MY=Bc(),OY=Wc(ok),NY=Bc(),LY=Bc(),vY(FY=gY(FY=yY(FY=xY(FY=Cc((ZY=QY=function(t){function e(){var e;return at(e=t.call(this)||this,"_lineHeight",GY,it(e)),at(e,"_string",VY,it(e)),at(e,"_horizontalAlign",UY,it(e)),at(e,"_fontSize",kY,it(e)),at(e,"_maxWidth",HY,it(e)),at(e,"_fontFamily",jY,it(e)),at(e,"_font",WY,it(e)),at(e,"_isSystemFontUsed",qY,it(e)),at(e,"_userDefinedFont",XY,it(e)),at(e,"_cacheMode",YY,it(e)),at(e,"_imageAtlas",KY,it(e)),at(e,"_handleTouchEvent",JY,it(e)),e._textArray=[],e._segments=[],e._labelSegmentsCache=[],e._linesWidth=[],e._lineCount=1,e._labelWidth=0,e._labelHeight=0,e._layoutDirty=!0,e._lineOffsetX=0,e._updateRichTextStatus=void 0,e._updateRichTextStatus=e._updateRichText,e}Q(e,t);var n=e.prototype;return n.onLoad=function(){this.node.on(FA.LAYER_CHANGED,this._applyLayer,this)},n.onEnable=function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)},n.onDisable=function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)},n.start=function(){this._onTTFLoaded(),this.node.on(FA.ANCHOR_CHANGED,this._updateRichTextPosition,this)},n.onRestore=function(){},n.onDestroy=function(){for(var t,e=ot(this._segments);!(t=e()).done;){var n=t.value;n.node.removeFromParent(),n.type===rK?aK.put(n):n.type===oK&&sK.put(n)}this.node.off(FA.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off(FA.LAYER_CHANGED,this._applyLayer,this)},n._addEventListeners=function(){this.node.on(FA.TOUCH_END,this._onTouchEnded,this)},n._removeEventListeners=function(){this.node.off(FA.TOUCH_END,this._onTouchEnded,this)},n._updateLabelSegmentTextAttributes=function(){var t=this;this._segments.forEach((function(e){t._applyTextAttribute(e)}))},n._createFontLabel=function(t){return lK(rK,t)},n._createImage=function(t){return lK(oK,t)},n._onTTFLoaded=function(){this._font,this._layoutDirty=!0,this._updateRichText()},n._measureText=function(t,e){var n=this,i=function(e){var i;return 0===n._labelSegmentsCache.length?(i=n._createFontLabel(e),n._labelSegmentsCache.push(i)):(i=n._labelSegmentsCache[0]).node.getComponent(dW).string=e,i.styleIndex=t,n._applyTextAttribute(i),i.node._uiProps.uiTransformComp.contentSize.width};return e?i(e):i},n._onTouchEnded=function(t){for(var e,n=this,i=this.node.getComponents(Ku),r=function(){var r=e.value,o=r.clickHandler,a=r.clickParam;o&&n._containsTouchLocation(r,t.touch.getUILocation())&&(i.forEach((function(e){var n=e[o];e.enabledInHierarchy&&n&&n.call(e,t,a)})),t.propagationStopped=!0)},o=ot(this._segments);!(e=o()).done;)r()},n._containsTouchLocation=function(t,e){var n=t.node.getComponent(RH);return!!n&&n.getBoundingBoxToWorld().contains(e)},n._resetState=function(){for(var t=this.node.children,e=t.length-1;e>=0;e--){var n=t[e];if(n.name===rK||n.name===oK){n.parent===this.node?n.parent=null:t.splice(e,1);var i=cK(n.name);i.node=n,n.name===rK?(i.comp=n.getComponent(dW),aK.put(i)):(i.comp=n.getComponent(iY),sK.put(i))}}t.length=0,this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0},n._activateChildren=function(t){for(var e=this.node.children.length-1;e>=0;e--){var n=this.node.children[e];n.name!==rK&&n.name!==oK||(n.active=t)}},n._addLabelSegment=function(t,e){var n;if(0===this._labelSegmentsCache.length)n=this._createFontLabel(t);else{var i=(n=this._labelSegmentsCache.pop()).node.getComponent(dW);i&&(i.string=t)}return n.styleIndex=e,n.lineCount=this._lineCount,n.node._uiProps.uiTransformComp.setAnchorPoint(0,0),n.node.layer=this.node.layer,this.node.addChild(n.node),this._applyTextAttribute(n),this._segments.push(n),n},n._updateRichTextWithMaxWidth=function(t,e,n){var i=e;if(this._lineOffsetX>0&&i+this._lineOffsetX>this._maxWidth)for(var r=0;this._lineOffsetX<=this._maxWidth;){var o=this._getFirstWordLen(t,r,t.length),a=t.substr(r,o),s=this._measureText(n,a);if(!(this._lineOffsetX+s<=this._maxWidth)){if(r>0){var c=t.substr(0,r);this._addLabelSegment(c,n),t=t.substr(r,t.length),i=this._measureText(n,t)}this._updateLineInfo();break}this._lineOffsetX+=s,r+=o}if(i>this._maxWidth)for(var l=Vk(t,i,this._maxWidth,this._measureText(n)),u=0;u<l.length;++u){var h=l[u],_=this._addLabelSegment(h,n).node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=_.width,l.length>1&&u<l.length-1&&this._updateLineInfo()}else this._lineOffsetX+=i,this._addLabelSegment(t,n)},n._isLastComponentCR=function(t){return t.length-1===t.lastIndexOf("\n")},n._updateLineInfo=function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++},n._needsUpdateTextLayout=function(t){if(this._layoutDirty||!this._textArray||!t)return!0;if(this._textArray.length!==t.length)return!0;for(var e=0;e<this._textArray.length;e++){var n=this._textArray[e],i=t[e];if(n.text!==i.text)return!0;var r=n.style,o=i.style;if(r){if(o){if(!!o.outline!=!!r.outline)return!0;if(r.size!==o.size||r.italic!==o.italic||r.isImage!==o.isImage)return!0;if(r.src!==o.src||r.imageAlign!==o.imageAlign||r.imageHeight!==o.imageHeight||r.imageWidth!==o.imageWidth||r.imageOffset!==o.imageOffset)return!0}else if(r.size||r.italic||r.isImage||r.outline)return!0}else if(o&&(o.size||o.italic||o.isImage||o.outline))return!0}return!1},n._addRichTextImageElement=function(t){if(t.style){var e=t.style,n=e.src,i=this._imageAtlas&&n&&this._imageAtlas.getSpriteFrame(n);if(i){var r=this._createImage(i);switch(r.comp,e.imageAlign){case"top":r.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":r.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:r.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}e.imageOffset&&(r.imageOffset=e.imageOffset),r.node.layer=this.node.layer,this.node.addChild(r.node),this._segments.push(r);var o=i.rect.clone(),a=1,s=o.width,c=o.height,l=e.imageWidth||0,u=e.imageHeight||0;u>0?(s*=a=u/c,c*=a):(s*=a=this._lineHeight/c,c*=a),l>0&&(s=l),this._maxWidth>0?(this._lineOffsetX+s>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=s):(this._lineOffsetX+=s,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.node._uiProps.uiTransformComp.setContentSize(s,c),r.lineCount=this._lineCount,r.clickHandler="",r.clickParam="";var h=e.event;h&&(r.clickHandler=h.click,r.clickParam=h.param)}else I(4400)}},n._updateRichText=function(){if(this.enabledInHierarchy){var t=iK.parse(this._string);if(!this._needsUpdateTextLayout(t))return this._textArray=t.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=t.slice(),this._resetState();for(var e,n=!1,i=0;i<this._textArray.length;++i){var r=this._textArray[i],o=r.text;if(void 0!==o){if(""===o){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this._imageAtlas){this._addRichTextImageElement(r);continue}}for(var a=o.split("\n"),s=0;s<a.length;++s){var c=a[s];if(""!==c)if(n=!1,this._maxWidth>0){var l=this._measureText(i,c);this._updateRichTextWithMaxWidth(c,l,i),a.length>1&&s<a.length-1&&this._updateLineInfo()}else e=this._addLabelSegment(c,i),this._lineOffsetX+=e.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),a.length>1&&s<a.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(o)&&s===a.length-1)continue;this._updateLineInfo(),n=!0}}}}n||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+Ek)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}},n._getFirstWordLen=function(t,e,n){var i=t.charAt(e);if(Lk(i)||Fk(i))return 1;for(var r=1,o=e+1;o<n&&!Fk(i=t.charAt(o))&&!Lk(i);++o)r++;return r},n._updateRichTextPosition=function(){for(var t=0,e=1,n=this._lineCount,i=this.node._uiProps.uiTransformComp,r=i.anchorX,o=i.anchorY,a=0;a<this._segments.length;++a){var s=this._segments[a],c=s.lineCount;c>e&&(t=0,e=c);var l=this._labelWidth*(.5*this._horizontalAlign-r);switch(this._horizontalAlign){case uW.LEFT:break;case uW.CENTER:l-=this._linesWidth[c-1]/2;break;case uW.RIGHT:l-=this._linesWidth[c-1]}var u=s.node.position;if(s.node.setPosition(t+l,this._lineHeight*(n-c)-this._labelHeight*o,u.z),c===e&&(t+=s.node._uiProps.uiTransformComp.width),s.node.getComponent(iY)){var h=s.node.position.clone(),_=this._lineHeight,f=this._lineHeight*(1+Ek);switch(s.node._uiProps.uiTransformComp.anchorY){case 1:h.y+=_+(f-_)/2;break;case.5:h.y+=f/2;break;default:h.y+=(f-_)/2}if(s.imageOffset){var p=s.imageOffset.split(",");if(1===p.length&&p[0]){var d=parseFloat(p[0]);Number.isInteger(d)&&(h.y+=d)}else if(2===p.length){var m=parseFloat(p[0]),v=parseFloat(p[1]);Number.isInteger(m)&&(h.x+=m),Number.isInteger(v)&&(h.y+=v)}}s.node.position=h}var g=s.node.getComponent(eY);if(g){var y=s.node.position.clone();y.y-=g.width,s.node.position=y}}},n._convertLiteralColorValue=function(t){var e=t.toUpperCase();return bn[e]?bn[e]:(new bn).fromHEX(t)},n._applyTextAttribute=function(t){var e=t.node.getComponent(dW);if(e){this._resetLabelState(e);var n,i=t.styleIndex;if(this._textArray[i]&&(n=this._textArray[i].style),n){if(e.color=this._convertLiteralColorValue(n.color||"white"),e.isBold=!!n.bold,e.isItalic=!!n.italic,e.isUnderline=!!n.underline,n.outline){var r=t.node.getComponent(eY);r||(r=t.node.addComponent(eY)),r.color=this._convertLiteralColorValue(n.outline.color),r.width=n.outline.width}e.fontSize=n.size||this._fontSize,t.clickHandler="",t.clickParam="";var o=n.event;o&&(t.clickHandler=o.click||"",t.clickParam=o.param||"")}e.cacheMode=this._cacheMode,this._font instanceof uk&&!this._isSystemFontUsed?e.font=this._font:e.fontFamily=this._fontFamily,e.useSystemFont=this._isSystemFontUsed,e.lineHeight=this._lineHeight,e.updateRenderData(!0);var a=e._assembler;a&&a.updateRenderData(e)}},n._applyLayer=function(){for(var t,e=ot(this._segments);!(t=e()).done;)t.value.node.layer=this.node.layer},n._resetLabelState=function(t){t.fontSize=this._fontSize,t.color=bn.WHITE,t.isBold=!1,t.isItalic=!1,t.isUnderline=!1},K(e,[{key:"string",get:function(){return this._string},set:function(t){this._string!==t&&(this._string=t,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(t){this.horizontalAlign!==t&&(this._horizontalAlign=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(t){this._fontSize!==t&&(this._fontSize=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(t){this._fontFamily!==t&&(this._fontFamily=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(t){this._font!==t&&(this._font=t,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(t){this._isSystemFontUsed!==t&&(this._isSystemFontUsed=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(t){this._cacheMode!==t&&(this._cacheMode=t,this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(t){this._maxWidth!==t&&(this._maxWidth=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(t){this._lineHeight!==t&&(this._lineHeight=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(t){this._imageAtlas!==t&&(this._imageAtlas=t,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(t){this._handleTouchEvent!==t&&(this._handleTouchEvent=t,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),e}(Ku),QY.HorizontalAlign=uW,QY.VerticalAlign=hW,st((zY=ZY).prototype,"string",[Gc,SY],Object.getOwnPropertyDescriptor(zY.prototype,"string"),zY.prototype),st(zY.prototype,"horizontalAlign",[CY,AY],Object.getOwnPropertyDescriptor(zY.prototype,"horizontalAlign"),zY.prototype),st(zY.prototype,"fontSize",[bY],Object.getOwnPropertyDescriptor(zY.prototype,"fontSize"),zY.prototype),st(zY.prototype,"fontFamily",[TY],Object.getOwnPropertyDescriptor(zY.prototype,"fontFamily"),zY.prototype),st(zY.prototype,"font",[EY,wY],Object.getOwnPropertyDescriptor(zY.prototype,"font"),zY.prototype),st(zY.prototype,"useSystemFont",[PY,IY],Object.getOwnPropertyDescriptor(zY.prototype,"useSystemFont"),zY.prototype),st(zY.prototype,"cacheMode",[RY,DY],Object.getOwnPropertyDescriptor(zY.prototype,"cacheMode"),zY.prototype),st(zY.prototype,"maxWidth",[BY],Object.getOwnPropertyDescriptor(zY.prototype,"maxWidth"),zY.prototype),st(zY.prototype,"lineHeight",[MY],Object.getOwnPropertyDescriptor(zY.prototype,"lineHeight"),zY.prototype),st(zY.prototype,"imageAtlas",[OY,NY],Object.getOwnPropertyDescriptor(zY.prototype,"imageAtlas"),zY.prototype),st(zY.prototype,"handleTouchEvent",[LY],Object.getOwnPropertyDescriptor(zY.prototype,"handleTouchEvent"),zY.prototype),GY=st(zY.prototype,"_lineHeight",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),VY=st(zY.prototype,"_string",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),UY=st(zY.prototype,"_horizontalAlign",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uW.LEFT}}),kY=st(zY.prototype,"_fontSize",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),HY=st(zY.prototype,"_maxWidth",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jY=st(zY.prototype,"_fontFamily",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),WY=st(zY.prototype,"_font",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qY=st(zY.prototype,"_isSystemFontUsed",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),XY=st(zY.prototype,"_userDefinedFont",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),YY=st(zY.prototype,"_cacheMode",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fW.NONE}}),KY=st(zY.prototype,"_imageAtlas",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JY=st(zY.prototype,"_handleTouchEvent",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),FY=zY))||FY)||FY)||FY)||FY)||FY));c.RichText=hK;var _K=function(e){return t({UIMeshRenderer:e,UIModelComponent:e}),e}(hc("cc.UIMeshRenderer")(uK=wc()(uK=fc(110)(uK=Ac()(uK=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._models=null,e._modelComponent=null,e.stencilStage=dH.DISABLED,e}Q(e,t);var n=e.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onLoad=function(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?this._models=this._modelComponent._collectModels():console.warn("node '"+(this.node&&this.node.name)+"' doesn't have any renderable component")},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,this._models=null)},n.updateAssembler=function(t){if(this._models){this._modelComponent._detachFromScene();for(var e,n=ot(this._models);!(e=n()).done;){var i=e.value;t.commitModel.call(t,this,i,this._modelComponent.material)}return!0}return!1},n.postUpdateAssembler=function(){},n.update=function(){this._fitUIRenderQueue()},n._fitUIRenderQueue=function(){if(this._modelComponent)for(var t=this._modelComponent.sharedMaterials.length,e=0;e<t;e++){var n=this._modelComponent.getMaterialInstance(e);if(null!=n)for(var i=n.passes,r=i.length,o=0;o<r;o++)i[o]._priority=Bp.MAX-11,n.recompileShaders({CC_FORCE_FORWARD_SHADING:!0},o)}},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},K(e,[{key:"modelComponent",get:function(){return this._modelComponent}}]),e}(Ku))||uK)||uK)||uK)||uK);c.UIMeshRenderer=_K;var fK,pK,dK,mK,vK,gK,yK,xK,SK,CK,AK,bK,TK,EK,wK,PK,IK,RK,DK,BK,MK,OK,NK,LK,FK,zK,GK,VK,UK,kK=Rp.Enum.NONE|Rp.Enum.UI_3D,HK=t("UIDrawBatch",function(){function t(){this.bufferBatch=null,this.camera=null,this.renderScene=null,this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._passes=[],this._shaders=[],this._visFlags=kK,this._inputAssembler=null,this._descriptorSet=null}var e=t.prototype;return e.destroy=function(){this._passes=[]},e.clear=function(){this.bufferBatch=null,this.inputAssembler=null,this.descriptorSet=null,this.camera=null,this.texture=null,this.sampler=null,this.textureHash=0,this.samplerHash=0,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=kK,this.renderScene=null},e.fillPasses=function(t,e,n,i,r,o){if(t){var a=t.passes;if(!a)return;var s=0;this._shaders.length=a.length;for(var l=0;l<a.length;l++){this._passes[l]||(this._passes[l]=new Ov(c.director.root));var u=a[l],h=this._passes[l];u.update(),e||(e=u.depthStencilState,n=0),i||(i=u.blendState,r=0),-1===r&&(r=0),s=n<<16|r,h._initPassFromTarget(u,e,i,s),this._shaders[l]=h.getShaderVariant(o)}}},K(t,[{key:"native",get:function(){return this._nativeObj}},{key:"inputAssembler",get:function(){return this._inputAssembler},set:function(t){this._inputAssembler=t}},{key:"descriptorSet",get:function(){return this._descriptorSet},set:function(t){this._descriptorSet=t}},{key:"visFlags",get:function(){return this._visFlags},set:function(t){this._visFlags=t}},{key:"passes",get:function(){return this._passes}},{key:"shaders",get:function(){return this._shaders}}]),t}()),jK=function(e){return t({UIStaticBatch:e,UIStaticBatchComponent:e}),e}((fK=hc("cc.UIStaticBatch"),pK=wc(),dK=Ac(),mK=fc(110),vK=Ic(),fK(gK=pK(gK=dK(gK=mK((st((yK=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._init=!1,e._bufferAccessor=null,e._dirty=!0,e._uiDrawBatchList=[],e}Q(e,t);var n=e.prototype;return n.onLoad=function(){},n.onDestroy=function(){},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markAsDirty=function(){},n._requireDrawBatch=function(){var t=new HK;return t.isStatic=!0,this._uiDrawBatchList.push(t),t},n._clearData=function(){if(this._bufferAccessor){this._bufferAccessor.reset();for(var t=this._getBatcher(),e=0;e<this._uiDrawBatchList.length;e++)this._uiDrawBatchList[e].destroy(t)}this._uiDrawBatchList.length=0,this._init=!1},n._getBatcher=function(){return zM.root&&zM.root.batcher2D?zM.root.batcher2D:(I(9301),null)},K(e,[{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&this._color.set(t)}},{key:"drawBatchList",get:function(){return this._uiDrawBatchList}}]),e}(pW)).prototype,"color",[el,vK],Object.getOwnPropertyDescriptor(yK.prototype,"color"),yK.prototype),gK=yK))||gK)||gK)||gK)||gK)),WK=t("LabelShadow",(xK=hc("cc.LabelShadow"),SK=wc(),CK=fc(110),AK=Ac(),bK=_c(dW),TK=Bc(),EK=Bc(),wK=Bc(),xK(PK=SK(PK=CK(PK=AK(PK=bK(PK=Cc((MK=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_color",RK,it(e)),at(e,"_offset",DK,it(e)),at(e,"_blur",BK,it(e)),e}Q(e,t);var n=e.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var t=this.node.getComponent(dW);t&&t.updateRenderData(!0)},K(e,[{key:"color",get:function(){return this._color},set:function(t){this._color!==t&&(this._color.set(t),this._updateRenderData())}},{key:"offset",get:function(){return this._offset},set:function(t){this._offset=t,this._updateRenderData()}},{key:"blur",get:function(){return this._blur},set:function(t){this._blur=t,this._updateRenderData()}}]),e}(Ku),RK=st((IK=MK).prototype,"_color",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new bn(0,0,0,255)}}),DK=st(IK.prototype,"_offset",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wn(2,2)}}),BK=st(IK.prototype,"_blur",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),st(IK.prototype,"color",[TK],Object.getOwnPropertyDescriptor(IK.prototype,"color"),IK.prototype),st(IK.prototype,"offset",[EK],Object.getOwnPropertyDescriptor(IK.prototype,"offset"),IK.prototype),st(IK.prototype,"blur",[wK],Object.getOwnPropertyDescriptor(IK.prototype,"blur"),IK.prototype),PK=IK))||PK)||PK)||PK)||PK)||PK)||PK)),qK=function(e){return t({UIOpacity:e,UIOpacityComponent:e}),e}((OK=hc("cc.UIOpacity"),NK=wc(),LK=fc(110),FK=Ac(),zK=Bc(),OK(GK=NK(GK=LK(GK=FK(GK=Cc((st((VK=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_opacity",UK,it(e)),e}Q(e,t);var n=e.prototype;return n.onEnable=function(){this.node._uiProps.localOpacity=this._opacity/255},n.onDisable=function(){this.node._uiProps.localOpacity=1},K(e,[{key:"opacity",get:function(){return this._opacity},set:function(t){this._opacity!==t&&(t=xe(t,0,255),this._opacity=t,this.node._uiProps.localOpacity=t/255)}}]),e}(Ku)).prototype,"opacity",[Pc,zK],Object.getOwnPropertyDescriptor(VK.prototype,"opacity"),VK.prototype),UK=st(VK.prototype,"_opacity",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),GK=VK))||GK)||GK)||GK)||GK)||GK));c.MaskComponent=Hq,ee.setClassAlias(Hq,"cc.MaskComponent"),c.LabelComponent=dW,ee.setClassAlias(dW,"cc.LabelComponent"),c.LabelOutlineComponent=eY,ee.setClassAlias(eY,"cc.LabelOutlineComponent"),c.RichTextComponent=hK,ee.setClassAlias(hK,"cc.RichTextComponent"),c.SpriteComponent=iY,ee.setClassAlias(iY,"cc.SpriteComponent"),c.UIModelComponent=_K,ee.setClassAlias(_K,"cc.UIModelComponent"),c.GraphicsComponent=Fq,ee.setClassAlias(Fq,"cc.GraphicsComponent"),ee.setClassAlias(jK,"cc.UIStaticBatchComponent"),ee.setClassAlias(qK,"cc.UIOpacityComponent");var XK=function(t,e,n){this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=t,this.x=e,this.y=n};function YK(t,e,n,i,r){var o=0,a=null;if(r===function(t,e,n,i){for(var r=0,o=e,a=n-i;o<n;o+=i)r+=(t[a]-t[o])*(t[o+1]+t[a+1]),a=o;return r}(t,e,n,i)>0)for(o=e;o<n;o+=i)a=_J(o,t[o],t[o+1],a);else for(o=n-i;o>=e;o-=i)a=_J(o,t[o],t[o+1],a);return a&&cJ(a,a.next)&&(fJ(a),a=a.next),a}function KK(t,e){if(void 0===e&&(e=null),!t)return t;e||(e=t);var n=t,i=!1;do{if(i=!1,n.steiner||!cJ(n,n.next)&&0!==sJ(n.prev,n,n.next))n=n.next;else{if(fJ(n),(n=e=n.prev)===n.next)return null;i=!0}}while(i||n!==e);return e}function JK(t,e,n,i,r,o,a){if(void 0===a&&(a=0),t){!a&&o&&function(t,e,n,i){var r=t;do{null===r.z&&(r.z=iJ(r.x,r.y,e,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){var e=0,n=null,i=null,r=null,o=null,a=0,s=0,c=0,l=1;do{for(n=t,t=null,o=null,a=0;n;){for(a++,i=n,s=0,e=0;e<l&&(s++,i=i.nextZ);e++);for(c=l;s>0||c>0&&i;)0===s?(r=i,i=i.nextZ,c--):0!==c&&i?n.z<=i.z?(r=n,n=n.nextZ,s--):(r=i,i=i.nextZ,c--):(r=n,n=n.nextZ,s--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;n=i}o.nextZ=null,l*=2}while(a>1)}(r)}(t,i,r,o);for(var s=t,c=null,l=null;t.prev!==t.next;)if(c=t.prev,l=t.next,o?ZK(t,i,r,o):QK(t))e.push(c.i/n),e.push(t.i/n),e.push(l.i/n),fJ(t),t=l.next,s=l.next;else if((t=l)===s){a?1===a?JK(t=$K(t,e,n),e,n,i,r,o,2):2===a&&tJ(t,e,n,i,r,o):JK(KK(t),e,n,i,r,o,1);break}}}function QK(t){var e=t.prev,n=t,i=t.next;if(sJ(e,n,i)>=0)return!1;for(var r=t.next.next;r!==t.prev;){if(oJ(e.x,e.y,n.x,n.y,i.x,i.y,r.x,r.y)&&sJ(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function ZK(t,e,n,i){var r=t.prev,o=t,a=t.next;if(sJ(r,o,a)>=0)return!1;for(var s=r.x<o.x?r.x<a.x?r.x:a.x:o.x<a.x?o.x:a.x,c=r.y<o.y?r.y<a.y?r.y:a.y:o.y<a.y?o.y:a.y,l=r.x>o.x?r.x>a.x?r.x:a.x:o.x>a.x?o.x:a.x,u=r.y>o.y?r.y>a.y?r.y:a.y:o.y>a.y?o.y:a.y,h=iJ(s,c,e,n,i),_=iJ(l,u,e,n,i),f=t.nextZ;f&&f.z<=_;){if(f!==t.prev&&f!==t.next&&oJ(r.x,r.y,o.x,o.y,a.x,a.y,f.x,f.y)&&sJ(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(f=t.prevZ;f&&f.z>=h;){if(f!==t.prev&&f!==t.next&&oJ(r.x,r.y,o.x,o.y,a.x,a.y,f.x,f.y)&&sJ(f.prev,f,f.next)>=0)return!1;f=f.prevZ}return!0}function $K(t,e,n){var i=t;do{var r=i.prev,o=i.next.next;!cJ(r,o)&&lJ(r,i,i.next,o)&&uJ(r,o)&&uJ(o,r)&&(e.push(r.i/n),e.push(i.i/n),e.push(o.i/n),fJ(i),fJ(i.next),i=t=o),i=i.next}while(i!==t);return i}function tJ(t,e,n,i,r,o){var a=t;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&aJ(a,s)){var c=hJ(a,s);return a=KK(a,a.next),c=KK(c,c.next),JK(a,e,n,i,r,o),void JK(c,e,n,i,r,o)}s=s.next}a=a.next}while(a!==t)}function eJ(t,e){return t.x-e.x}function nJ(t,e){if(e=function(t,e){var n=e,i=t.x,r=t.y,o=-1/0,a=null;do{if(r<=n.y&&r>=n.next.y){var s=n.x+(r-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=i&&s>o){if(o=s,s===i){if(r===n.y)return n;if(r===n.next.y)return n.next}a=n.x<n.next.x?n:n.next}}n=n.next}while(n!==e);if(!a)return null;if(i===o)return a.prev;var c,l=a,u=a.x,h=a.y,_=1/0;for(n=a.next;n!==l;)i>=n.x&&n.x>=u&&oJ(r<h?i:o,r,u,h,r<h?o:i,r,n.x,n.y)&&((c=Math.abs(r-n.y)/(i-n.x))<_||c===_&&n.x>a.x)&&uJ(n,t)&&(a=n,_=c),n=n.next;return a}(t,e)){var n=hJ(e,t);KK(n,n.next)}}function iJ(t,e,n,i,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)/r)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)/r)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function rJ(t){var e=t,n=t;do{e.x<n.x&&(n=e),e=e.next}while(e!==t);return n}function oJ(t,e,n,i,r,o,a,s){return(r-a)*(e-s)-(t-a)*(o-s)>=0&&(t-a)*(i-s)-(n-a)*(e-s)>=0&&(n-a)*(o-s)-(r-a)*(i-s)>=0}function aJ(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&lJ(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&uJ(t,e)&&uJ(e,t)&&function(t,e){var n=t,i=!1,r=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&r<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==t);return i}(t,e)}function sJ(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function cJ(t,e){return t.x===e.x&&t.y===e.y}function lJ(t,e,n,i){return!!(cJ(t,e)&&cJ(n,i)||cJ(t,i)&&cJ(n,e))||sJ(t,e,n)>0!=sJ(t,e,i)>0&&sJ(n,i,t)>0!=sJ(n,i,e)>0}function uJ(t,e){return sJ(t.prev,t,t.next)<0?sJ(t,e,t.next)>=0&&sJ(t,t.prev,e)>=0:sJ(t,e,t.prev)<0||sJ(t,t.next,e)<0}function hJ(t,e){var n=new XK(t.i,t.x,t.y),i=new XK(e.i,e.x,e.y),r=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=r,r.prev=n,i.next=n,n.prev=i,o.next=i,i.prev=o,i}function _J(t,e,n,i){var r=new XK(t,e,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function fJ(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function pJ(t,e,n){n=n||3;var i=e?e.length:0,r=i?e[0]*n:t.length,o=YK(t,0,r,n,!0),a=[];if(!o)return a;var s=0,c=0,l=0,u=0,h=0,_=0,f=0;if(i&&(o=function(t,e,n,i){var r,o=[],a=0,s=null;for(a=0,r=e.length;a<r;a++)(s=YK(t,e[a]*i,a<r-1?e[a+1]*i:t.length,i,!1))&&(s===s.next&&(s.steiner=!0),o.push(rJ(s)));if(o.sort(eJ),!n)return n;for(a=0;a<o.length;a++)nJ(o[a],n),n=KK(n,n.next);return n}(t,e,o,n)),t.length>80*n){s=l=t[0],c=u=t[1];for(var p=n;p<r;p+=n)(h=t[p])<s&&(s=h),(_=t[p+1])<c&&(c=_),h>l&&(l=h),_>u&&(u=_);f=Math.max(l-s,u-c)}return JK(o,a,n,s,c,f),a}for(var dJ=Math.PI,mJ=Math.min,vJ=Math.max,gJ=Math.ceil,yJ=Math.acos,xJ=Math.cos,SJ=Math.sin,CJ=Math.atan2,AJ=null,bJ=null,TJ=new bn,EJ=[],wJ=0;wJ<4;wJ++)EJ.push(new En);function PJ(t,e,n){return t<e?e:t>n?n:t}var IJ={useModel:!0,updateRenderData:function(){},fillBuffers:function(){},renderIA:function(){},getRenderData:function(t,e){if(!bJ)return null;var n=bJ.getRenderDataList(),i=n[bJ.dataOffset];if(!i)return null;var r=i,o=r?r.vertexStart+e:0;return(o>65535||3*o>131070)&&(++bJ.dataOffset,bJ.dataOffset<n.length?i=n[bJ.dataOffset]:(i=bJ.requestRenderData(),n[bJ.dataOffset]=i),r=i),r&&r.vertexCount<o&&r.request(e,3*e),i},stroke:function(t){bn.copy(TJ,t.strokeColor),t.impl&&(this._flattenPaths(t.impl),this._expandStroke(t),t.impl.updatePathOffset=!0,this.end(t))},fill:function(t){bn.copy(TJ,t.fillColor),this._expandFill(t),t.impl&&(t.impl.updatePathOffset=!0),this.end(t)},end:function(t){t.markForUpdateRenderData()},_expandStroke:function(t){var e,n,i,r,o=.5*t.lineWidth,a=t.lineCap,s=t.lineJoin,c=t.miterLimit;if(bJ=t.impl){var l=(e=o,n=dJ,i=bJ.tessTol,r=2*yJ(e/(e+i)),vJ(2,gJ(n/r)));this._calculateJoins(bJ,o,s,c);for(var u=bJ.paths,h=0,_=bJ.pathOffset,f=bJ.pathLength;_<f;_++){var p=u[_],d=p.points.length;s===AW.ROUND?h+=2*(d+p.bevel*(l+2)+1):h+=2*(d+5*p.bevel+1),p.closed||(a===CW.ROUND?h+=2*(2*l+2):h+=12)}var m=AJ=this.getRenderData(t,h);if(m){for(var v=m.vData,g=m.iData,y=bJ.pathOffset,x=bJ.pathLength;y<x;y++){var S=u[y],C=S.points,A=C.length,b=m.vertexStart,T=void 0,E=void 0,w=0,P=0,I=S.closed;if(I?(T=C[A-1],E=C[0],w=0,P=A):(T=C[0],E=C[1],w=1,P=A-1),E=E||T,!I){var R=new Dq(E.x,E.y);R.subtract(T),R.normalize();var D=R.x,B=R.y;a===CW.BUTT?this._buttCapStart(T,D,B,o,0):a===CW.SQUARE?this._buttCapStart(T,D,B,o,o):a===CW.ROUND&&this._roundCapStart(T,D,B,o,l)}for(var M=w;M<P;++M)s===AW.ROUND?this._roundJoin(T,E,o,o,l):0!=(E.flags&(bW.PT_BEVEL|bW.PT_INNERBEVEL))?this._bevelJoin(T,E,o,o):(this._vSet(E.x+E.dmx*o,E.y+E.dmy*o,1),this._vSet(E.x-E.dmx*o,E.y-E.dmy*o,-1)),T=E,E=C[M+1];if(I){var O=8*b;this._vSet(v[O],v[O+1],1),this._vSet(v[O+8],v[O+8+1],-1)}else{var N=new Dq(E.x,E.y);N.subtract(T),N.normalize();var L=N.x,F=N.y;a===CW.BUTT?this._buttCapEnd(E,L,F,o,0):a===CW.SQUARE?this._buttCapEnd(E,L,F,o,o):a===CW.ROUND&&this._roundCapEnd(E,L,F,o,l)}for(var z=m.indexStart,G=b+2,V=m.vertexStart;G<V;G++)g[z++]=G-2,g[z++]=G-1,g[z++]=G;m.indexStart=z}AJ=null,bJ=null}}},_expandFill:function(t){if(bJ=t.impl){for(var e=bJ.paths,n=0,i=bJ.pathOffset,r=bJ.pathLength;i<r;i++)n+=e[i].points.length;var o=AJ=this.getRenderData(t,n);if(o){for(var a=o,s=a.vData,c=a.iData,l=bJ.pathOffset,u=bJ.pathLength;l<u;l++){var h=e[l],_=h.points,f=_.length;if(0!==f){for(var p=o.vertexStart,d=0;d<f;++d)this._vSet(_[d].x,_[d].y);var m=o.indexStart;if(h.complex){for(var v=[],g=p,y=o.vertexStart;g<y;g++){var x=8*g;v.push(s[x++]),v.push(s[x++]),v.push(s[x++])}var S=pJ(v,null,3);if(!S||0===S.length)continue;for(var C=0,A=S.length;C<A;C++)c[m++]=S[C]+p}else for(var b=p,T=p+2,E=a.vertexStart;T<E;T++)c[m++]=b,c[m++]=T-1,c[m++]=T;a.indexStart=m}}AJ=null,bJ=null}}},_calculateJoins:function(t,e,n,i){var r=0;e>0&&(r=1/e);for(var o=t.paths,a=t.pathOffset,s=t.pathLength;a<s;a++){var c=o[a],l=c.points,u=l.length,h=l[u-1],_=l[0];c.bevel=0;for(var f=0;f<u;f++){var p,d,m=h.dy,v=-h.dx,g=_.dy,y=-_.dx;if(_.dmx=.5*(m+g),_.dmy=.5*(v+y),(p=_.dmx*_.dmx+_.dmy*_.dmy)>1e-6){var x=1/p;x>600&&(x=600),_.dmx*=x,_.dmy*=x}_.dx*h.dy-h.dx*_.dy>0&&(_.flags|=bW.PT_LEFT),p*(d=vJ(11,mJ(h.len,_.len)*r))*d<1&&(_.flags|=bW.PT_INNERBEVEL),_.flags&bW.PT_CORNER&&(p*i*i<1||n===AW.BEVEL||n===AW.ROUND)&&(_.flags|=bW.PT_BEVEL),0!=(_.flags&(bW.PT_BEVEL|bW.PT_INNERBEVEL))&&c.bevel++,h=_,_=l[f+1]}}},_flattenPaths:function(t){for(var e=t.paths,n=t.pathOffset,i=t.pathLength;n<i;n++){var r=e[n],o=r.points,a=o[o.length-1],s=o[0];o.length>2&&a.equals(s)&&(r.closed=!0,o.pop(),a=o[o.length-1]);for(var c=0,l=o.length;c<l;c++){var u=new Dq(s.x,s.y);u.subtract(a),a.len=u.length(),(u.x||u.y)&&u.normalize(),a.dx=u.x,a.dy=u.y,a=s,s=o[c+1]}}},_chooseBevel:function(t,e,n,i){var r=n.x,o=n.y,a=0,s=0,c=0,l=0;return 0!==t?(a=r+e.dy*i,s=o-e.dx*i,c=r+n.dy*i,l=o-n.dx*i):(a=c=r+n.dmx*i,s=l=o+n.dmy*i),[a,s,c,l]},_buttCapStart:function(t,e,n,i,r){var o=t.x-e*r,a=t.y-n*r,s=n,c=-e;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_buttCapEnd:function(t,e,n,i,r){var o=t.x+e*r,a=t.y+n*r,s=n,c=-e;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapStart:function(t,e,n,i,r){for(var o=t.x,a=t.y,s=n,c=-e,l=0;l<r;l++){var u=l/(r-1)*dJ,h=xJ(u)*i,_=SJ(u)*i;this._vSet(o-s*h-e*_,a-c*h-n*_,1),this._vSet(o,a,0)}this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapEnd:function(t,e,n,i,r){var o=t.x,a=t.y,s=n,c=-e;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1);for(var l=0;l<r;l++){var u=l/(r-1)*dJ,h=xJ(u)*i,_=SJ(u)*i;this._vSet(o,a,0),this._vSet(o-s*h+e*_,a-c*h+n*_,1)}},_roundJoin:function(t,e,n,i,r){var o=t.dy,a=-t.dx,s=e.dy,c=-e.dx,l=e.x,u=e.y;if(0!=(e.flags&bW.PT_LEFT)){var h=this._chooseBevel(e.flags&bW.PT_INNERBEVEL,t,e,n),_=h[0],f=h[1],p=h[2],d=h[3],m=CJ(-a,-o),v=CJ(-c,-s);v>m&&(v-=2*dJ),this._vSet(_,f,1),this._vSet(l-o*i,e.y-a*i,-1);for(var g=PJ(gJ((m-v)/dJ)*r,2,r),y=0;y<g;y++){var x=m+y/(g-1)*(v-m),S=l+xJ(x)*i,C=u+SJ(x)*i;this._vSet(l,u,0),this._vSet(S,C,-1)}this._vSet(p,d,1),this._vSet(l-s*i,u-c*i,-1)}else{var A=this._chooseBevel(e.flags&bW.PT_INNERBEVEL,t,e,-i),b=A[0],T=A[1],E=A[2],w=A[3],P=CJ(a,o),I=CJ(c,s);I<P&&(I+=2*dJ),this._vSet(l+o*i,u+a*i,1),this._vSet(b,T,-1);for(var R=PJ(gJ((I-P)/dJ)*r,2,r),D=0;D<R;D++){var B=P+D/(R-1)*(I-P),M=l+xJ(B)*n,O=u+SJ(B)*n;this._vSet(M,O,1),this._vSet(l,u,0)}this._vSet(l+s*i,u+c*i,1),this._vSet(E,w,-1)}},_bevelJoin:function(t,e,n,i){var r=0,o=0,a=0,s=0,c=0,l=0,u=0,h=0,_=t.dy,f=-t.dx,p=e.dy,d=-e.dx;if(e.flags&bW.PT_LEFT){var m=this._chooseBevel(e.flags&bW.PT_INNERBEVEL,t,e,n);c=m[0],l=m[1],u=m[2],h=m[3],this._vSet(c,l,1),this._vSet(e.x-_*i,e.y-f*i,-1),this._vSet(u,h,1),this._vSet(e.x-p*i,e.y-d*i,-1)}else{var v=this._chooseBevel(e.flags&bW.PT_INNERBEVEL,t,e,-i);r=v[0],o=v[1],a=v[2],s=v[3],this._vSet(e.x+_*n,e.y+f*n,1),this._vSet(r,o,-1),this._vSet(e.x+p*n,e.y+d*n,1),this._vSet(a,s,-1)}},_vSet:function(t,e,n){if(void 0===n&&(n=0),AJ){var i=AJ,r=8*i.vertexStart,o=i.vData;o[r++]=t,o[r++]=e,o[r++]=0,bn.toArray(o,TJ,r),r+=4,o[r++]=n,i.vertexStart++}}},RJ=t("graphicsAssembler",{getAssembler:function(){return IJ}});Fq.Assembler=RJ;var DJ=function(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""},BJ=new ti,MJ=null,OJ=null,NJ=[],LJ=[],FJ=[],zJ=[],GJ=new Zn,VJ=new Zn,UJ=new Wn,kJ=null,HJ=0,jJ=0,WJ=0,qJ=0,XJ=0,YJ=1,KJ=null,JJ="",QJ=0,ZJ=0,$J=0,tQ=0,eQ=0,nQ=0,iQ=0,rQ=!1,oQ=0,aQ=0,sQ=0,cQ={updateRenderData:function(t){t.renderData&&MJ!==t&&(t.renderData.vertDirty&&(OJ=(MJ=t).node._uiProps.uiTransformComp,this._updateFontFamily(t),this._updateProperties(t),this._updateLabelInfo(t),this._updateContent(),MJ.actualFontSize=QJ,OJ.setContentSize(VJ),this.updateUVs(t),MJ.renderData.vertDirty=!1,MJ.markForUpdateRenderData(!1),MJ=null,this._resetProperties()),t.spriteFrame&&t.renderData.updateRenderData(t,t.spriteFrame))},updateUVs:function(t){for(var e=t.renderData,n=e.chunk.vb,i=e.vertexCount,r=e.data,o=3,a=0;a<i;a++){var s=r[a];n[o]=s.u,n[o+1]=s.v,o+=9}},_updateFontScale:function(){YJ=QJ/ZJ},_updateFontFamily:function(t){var e=t.font;KJ=e.spriteFrame,kJ=e.fntConfig,Yk.fontAtlas=e.fontDefDictionary,QU.packToDynamicAtlas(t,KJ)},_updateLabelInfo:function(){Yk.hash="",Yk.margin=0},_updateProperties:function(t){JJ=t.string.toString(),QJ=t.fontSize,ZJ=kJ?kJ.fontSize:t.fontSize,$J=t.horizontalAlign,tQ=t.verticalAlign,eQ=t.spacingX,iQ=t.overflow,nQ=t._lineHeight;var e=OJ.contentSize;VJ.width=e.width,VJ.height=e.height,iQ===_W.NONE?(rQ=!1,VJ.width+=2*Yk.margin,VJ.height+=2*Yk.margin):iQ===_W.RESIZE_HEIGHT?(rQ=!0,VJ.height+=2*Yk.margin):rQ=t.enableWrapText,Yk.lineHeight=nQ,Yk.fontSize=QJ,this._setupBMFontOverflowMetrics()},_resetProperties:function(){kJ=null,KJ=null,Yk.hash="",Yk.margin=0},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var t=JJ,e=t.length,n=kJ.kerningDict,i=NJ,r=-1,o=0;o<e;++o){var a=t.charCodeAt(o),s=n[r<<16|65535&a]||0;i[o]=o<e-1?s:0,r=a}},_multilineTextWrap:function(t){for(var e=JJ.length,n=0,i=0,r=0,o=0,a=0,s=0,c=0,l=null,u=0;u<e;){var h=JJ.charAt(u);if("\n"!==h){for(var _=t(JJ,u,e),f=s,p=c,d=a,m=i,v=!1,g=0;g<_;++g){var y=u+g;if("\r"!==(h=JJ.charAt(y)))if(l=Yk.fontAtlas.getLetterDefinitionForChar(h,Yk)){var x=m+l.offsetX*YJ-Yk.margin;if(rQ&&sQ>0&&i>0&&x+l.w*YJ>sQ&&!Fk(h)){FJ.push(a),a=0,n++,i=0,r-=nQ*this._getFontScale()+0,v=!0;break}UJ.x=x,UJ.y=r-l.offsetY*YJ,this._recordLetterInfo(UJ,h,y,n),y+1<NJ.length&&y<e-1&&(m+=NJ[y+1]),m+=l.xAdvance*YJ+eQ,d=UJ.x+l.w*YJ,f<UJ.y&&(f=UJ.y),p>UJ.y-l.h*YJ&&(p=UJ.y-l.h*YJ)}else this._recordPlaceholderInfo(y,h),console.log("Can't find letter definition in texture atlas "+kJ.atlasName+" for letter:"+h);else this._recordPlaceholderInfo(y,h)}v||(i=m,s<f&&(s=f),c>p&&(c=p),o<(a=d)&&(o=a),u+=_)}else FJ.push(a),a=0,n++,i=0,r-=nQ*this._getFontScale()+0,this._recordPlaceholderInfo(u,h),u++}return FJ.push(a),jJ=(HJ=n+1)*nQ*this._getFontScale(),HJ>1&&(jJ+=0*(HJ-1)),VJ.width=oQ,VJ.height=aQ,oQ<=0&&(VJ.width=parseFloat(o.toFixed(2))+2*Yk.margin),aQ<=0&&(VJ.height=parseFloat(jJ.toFixed(2))+2*Yk.margin),qJ=VJ.height,XJ=0,s>0&&(qJ=VJ.height+s),c<-jJ&&(XJ=jJ+c),!0},_getFirstCharLen:function(){return 1},_getFontScale:function(){return iQ===_W.SHRINK?YJ:1},_getFirstWordLen:function(t,e,n){var i=t.charAt(e);if(Lk(i)||"\n"===i||Fk(i))return 1;var r=1,o=Yk.fontAtlas.getLetterDefinitionForChar(i,Yk);if(!o)return r;for(var a=o.xAdvance*YJ+eQ,s=e+1;s<n&&(i=t.charAt(s),o=Yk.fontAtlas.getLetterDefinitionForChar(i,Yk));++s){if(a+o.offsetX*YJ+o.w*YJ>sQ&&!Fk(i)&&sQ>0)return r;if(a+=o.xAdvance*YJ+eQ,"\n"===i||Fk(i)||Lk(i))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(t,e){if(t>=LJ.length){var n=new DJ;LJ.push(n)}LJ[t].char=e,LJ[t].hash=""+e.charCodeAt(0)+Yk.hash,LJ[t].valid=!1},_recordLetterInfo:function(t,e,n,i){if(n>=LJ.length){var r=new DJ;LJ.push(r)}var o=""+e.charCodeAt(0)+Yk.hash;LJ[n].line=i,LJ[n].char=e,LJ[n].hash=o,LJ[n].valid=Yk.fontAtlas.getLetter(o).valid,LJ[n].x=t.x,LJ[n].y=t.y},_alignText:function(){jJ=0,FJ.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),iQ===_W.SHRINK&&QJ>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||iQ===_W.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(t){var e=!0;t||(t=.1,e=!1),QJ=t,e&&this._updateContent()},_shrinkLabelToContentSize:function(t){for(var e=0,n=0|QJ,i=0;e<n;){var r=i=e+n+1>>1;if(r<=0)break;YJ=r/ZJ,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),t()?n=i-1:e=i}e>=0&&this._scaleFontSizeDown(e)},_isVerticalClamp:function(){return jJ>VJ.height},_isHorizontalClamp:function(){for(var t=!1,e=0,n=JJ.length;e<n;++e){var i=LJ[e];if(i.valid){var r=Yk.fontAtlas.getLetterDefinitionForChar(i.char,Yk);if(!r)continue;var o=i.x+r.w*YJ,a=i.line;if(oQ>0)if(rQ){if(FJ[a]>VJ.width&&(o>VJ.width||o<0)){t=!0;break}}else if(o>VJ.width){t=!0;break}}}return t},_isHorizontalClamped:function(t,e){var n=FJ[e],i=t>VJ.width||t<0;return rQ?n>VJ.width&&i:i},_updateQuads:function(){if(!MJ)return!1;var t=KJ?KJ.texture:Yk.fontAtlas.getTexture(),e=MJ.renderData;e.dataLength=0,e.resize(0,0);for(var n=OJ.anchorPoint,i=VJ,r=n.x*i.width,o=n.y*i.height,a=!0,s=0,c=JJ.length;s<c;++s){var l=LJ[s];if(l.valid){var u=Yk.fontAtlas.getLetter(l.hash);if(u){BJ.height=u.h,BJ.width=u.w,BJ.x=u.u,BJ.y=u.v;var h=l.y+WJ;if(aQ>0){if(h>qJ){var _=h-qJ;BJ.y+=_,BJ.height-=_,h-=_}h-u.h*YJ<XJ&&iQ===_W.CLAMP&&(BJ.height=h<XJ?0:(h-XJ)/YJ)}var f=l.line,p=l.x+u.w/2*YJ+zJ[f];if(oQ>0&&this._isHorizontalClamped(p,f))if(iQ===_W.CLAMP)BJ.width=0;else if(iQ===_W.SHRINK){if(VJ.width>u.w){a=!1;break}BJ.width=0}if(BJ.height>0&&BJ.width>0){var d=this._determineRect(),m=l.x+zJ[l.line];this.appendQuad(MJ,t,BJ,d,m-r,h-o,YJ)}}else console.warn("Can't find letter in this bitmap-font")}}return a},appendQuad:function(){},_determineRect:function(){var t=KJ.isRotated(),e=KJ.getOriginalSize(),n=KJ.getRect(),i=KJ.getOffset(),r=i.x+(e.width-n.width)/2,o=i.y-(e.height-n.height)/2;if(t){var a=BJ.x;BJ.x=n.x+n.height-BJ.y-BJ.height-o,BJ.y=a+n.y-r,BJ.y<0&&(BJ.height+=o)}else BJ.x+=n.x-r,BJ.y+=n.y+o;return t},_computeAlignmentOffset:function(){switch(zJ.length=0,$J){case uW.LEFT:for(var t=0;t<HJ;++t)zJ.push(0);break;case uW.CENTER:for(var e=0,n=FJ.length;e<n;e++)zJ.push((VJ.width-FJ[e])/2);break;case uW.RIGHT:for(var i=0,r=FJ.length;i<r;i++)zJ.push(VJ.width-FJ[i])}if(WJ=VJ.height,tQ!==hW.TOP){var o=VJ.height-jJ+nQ*this._getFontScale()-ZJ*YJ;tQ===hW.BOTTOM?WJ-=o:WJ-=o/2}},_setupBMFontOverflowMetrics:function(){var t=VJ.width,e=VJ.height;iQ===_W.RESIZE_HEIGHT&&(e=0),iQ===_W.NONE&&(t=0,e=0),oQ=t,aQ=e,GJ.width=t,GJ.height=e,sQ=t}},lQ=new bn(255,255,255,255),uQ={createData:function(t){return t.requestRenderData()},fillBuffers:function(t){var e=t.node;lQ.set(t.color),lQ.a=255*e._uiProps.opacity,jU(e,0,t.renderData,lQ)},appendQuad:function(t,e,n,i,r,o,a){var s=t.renderData;if(s){var c=s.dataLength;s.dataLength+=4,s.resize(s.dataLength,s.dataLength/2*3);var l=s.data,u=e.width,h=e.height,_=n.width,f=n.height,p=0,d=0,m=0,v=0;i?(p=n.x/u,v=(n.x+f)/u,d=(n.y+_)/h,m=n.y/h,l[c].u=p,l[c].v=m,l[c+1].u=p,l[c+1].v=d,l[c+2].u=v,l[c+2].v=m,l[c+3].u=v,l[c+3].v=d):(p=n.x/u,v=(n.x+_)/u,d=(n.y+f)/h,m=n.y/h,l[c].u=p,l[c].v=d,l[c+1].u=v,l[c+1].v=d,l[c+2].u=p,l[c+2].v=m,l[c+3].u=v,l[c+3].v=m),l[c].x=r,l[c].y=o-f*a,l[c+1].x=r+_*a,l[c+1].y=o-f*a,l[c+2].x=r,l[c+2].y=o,l[c+3].x=r+_*a,l[c+3].y=o}},updateColor:function(){}};Lt(uQ,cQ);var hQ=null,_Q=Ft(cQ,{getAssemblerData:function(){return hQ||(hQ=new Xk(1024,1024)),hQ.getTexture()},_updateFontFamily:function(t){Yk.fontAtlas=hQ,Yk.fontFamily=this._getFontFamily(t);var e=t.getComponent(eY);e&&e.enabled?(Yk.isOutlined=!0,Yk.margin=e.width,Yk.out=e.color.clone(),Yk.out.a=e.color.a*t.color.a/255):(Yk.isOutlined=!1,Yk.margin=0)},_getFontFamily:function(t){var e="Arial";return t.useSystemFont?e=t.fontFamily||"Arial":t.font&&(e=t.font._nativeAsset||"Arial"),e},_updateLabelInfo:function(t){Yk.fontDesc=this._getFontDesc(),Yk.color=t.color,Yk.hash=function(t){var e=t.color.toHEX(),n="";return t.isOutlined&&t.margin>0&&(n=n+t.margin+t.out.toHEX()),""+t.fontSize+t.fontFamily+e+n}(Yk)},_getFontDesc:function(){return Yk.fontSize.toString()+"px "+Yk.fontFamily},_computeHorizontalKerningForText:function(){},_determineRect:function(){return!1}}),fQ=new bn(255,255,255,255),pQ={createData:function(t){return t.requestRenderData()},fillBuffers:function(t){if(t.renderData){var e=t.node;fQ.a=255*e._uiProps.opacity,jU(e,0,t.renderData,fQ)}},updateColor:function(){},appendQuad:uQ.appendQuad};Lt(pQ,_Q);var dQ=dW.Overflow,mQ=(1/255).toFixed(3),vQ=null,gQ=null,yQ=null,xQ="",SQ="",CQ=0,AQ=0,bQ=[],TQ=new Zn,EQ=0,wQ=0,PQ=0,IQ=new bn,RQ="",DQ=dQ.NONE,BQ=!1,MQ=null,OQ=bn.BLACK.clone(),NQ=null,LQ=bn.BLACK.clone(),FQ=new ti,zQ=Zn.ZERO.clone(),GQ=Zn.ZERO.clone(),VQ=Wn.ZERO.clone(),UQ=Wn.ZERO.clone(),kQ=0,HQ=0,jQ=!1,WQ=!1,qQ=!1,XQ=["left","center","right"],YQ={getAssemblerData:function(){return dW._canvasPool.get()},resetAssemblerData:function(t){t&&dW._canvasPool.put(t)},updateRenderData:function(t){if(t.renderData){if(t.renderData.vertDirty){var e=t.node._uiProps.uiTransformComp;this._updateFontFamily(t),this._updateProperties(t,e),this._calculateLabelFont(),this._updateLabelDimensions(),this._updateTexture(t),this._calDynamicAtlas(t),t.actualFontSize=CQ,e.setContentSize(TQ),this.updateVertexData(t),this.updateUVs(t),t.markForUpdateRenderData(!1),vQ=null,gQ=null,yQ=null}t.spriteFrame&&t.renderData.updateRenderData(t,t.spriteFrame)}},updateVertexData:function(){},updateUVs:function(){},_updateFontFamily:function(t){RQ=t.useSystemFont?t.fontFamily||"Arial":t.font&&t.font._nativeAsset||"Arial"},_updateProperties:function(t,e){var n=t.assemblerData;n&&(vQ=n.context,gQ=n.canvas,yQ=t.spriteFrame,SQ=t.string.toString(),CQ=t.fontSize,AQ=CQ,DQ=t.overflow,GQ.width=TQ.width=e.width,GQ.height=TQ.height=e.height,HQ=t.underlineHeight,EQ=t.lineHeight,wQ=t.horizontalAlign,PQ=t.verticalAlign,IQ=t.color,t.node._uiProps.opacity,jQ=t.isBold,WQ=t.isItalic,qQ=t.isUnderline,BQ=DQ!==dQ.NONE&&(DQ===dQ.RESIZE_HEIGHT||t.enableWrapText),(MQ=(MQ=eY&&t.getComponent(eY))&&MQ.enabled&&MQ.width>0?MQ:null)&&OQ.set(MQ.color),(NQ=(NQ=WK&&t.getComponent(WK))&&NQ.enabled?NQ:null)&&LQ.set(NQ.color),this._updatePaddingRect())},_updatePaddingRect:function(){var t=0,e=0,n=0,i=0,r=0;if(zQ.width=zQ.height=0,MQ&&(t=e=n=i=r=MQ.width,zQ.width=zQ.height=2*r),NQ){var o=NQ.blur+r,a=NQ.offset.x,s=NQ.offset.y;n=Math.max(n,-a+o),i=Math.max(i,a+o),t=Math.max(t,s+o),e=Math.max(e,-s+o)}if(WQ){var c=AQ*Math.tan(.20943951);i+=c,zQ.width+=c}FQ.x=n,FQ.y=t,FQ.width=n+i,FQ.height=t+e},_calculateFillTextStartPosition:function(){var t=0;wQ===uW.RIGHT?t=TQ.width-FQ.width:wQ===uW.CENTER&&(t=(TQ.width-FQ.width)/2);var e=this._getLineHeight()*(bQ.length-1),n=CQ*(1-Ek/2);if(PQ!==hW.TOP){var i=e+FQ.height+CQ-TQ.height;PQ===hW.BOTTOM?n-=i+=Ek/2*CQ:n-=i/2}n+=0*CQ,VQ.set(t+FQ.x,n+FQ.y)},_updateTexture:function(t){if(vQ&&gQ){vQ.clearRect(0,0,gQ.width,gQ.height),vQ.font=xQ,this._calculateFillTextStartPosition();var e=this._getLineHeight();vQ.lineJoin="round",MQ?(vQ.fillStyle="rgba("+OQ.r+", "+OQ.g+", "+OQ.b+", "+mQ+")",vQ.fillRect(0,0,gQ.width,gQ.height)):t._srcBlendFactor===Ei.SRC_ALPHA&&(vQ.fillStyle="rgba("+IQ.r+", "+IQ.g+", "+IQ.b+", "+mQ+")",vQ.fillRect(0,0,gQ.width,gQ.height)),vQ.fillStyle="rgb("+IQ.r+", "+IQ.g+", "+IQ.b+")";var n=VQ.x,i=0;this._drawTextEffect(VQ,e);for(var r=0;r<bQ.length;++r)i=VQ.y+r*e,MQ&&vQ.strokeText(bQ[r],n,i),vQ.fillText(bQ[r],n,i);NQ&&(vQ.shadowColor="transparent"),this._uploadTexture(t)}},_uploadTexture:function(t){if(t.cacheMode===dW.CacheMode.BITMAP){var e=t.ttfSpriteFrame;QU.deleteAtlasSpriteFrame(e),e._resetDynamicAtlasFrame()}var n;yQ&&gQ&&(n=yQ instanceof ik?yQ.texture:yQ,0!==gQ.width&&0!==gQ.height&&(n.reset({width:gQ.width,height:gQ.height,mipmapLevel:1}),n.uploadData(gQ),yQ instanceof ik&&(yQ.rect=new ti(0,0,gQ.width,gQ.height),yQ._calculateUV()),t.renderData&&(t.renderData.textureDirty=!0),c.director.root&&c.director.root.batcher2D&&c.director.root.batcher2D._releaseDescriptorSetCache(n.getHash())))},_calDynamicAtlas:function(t){if(!(t.cacheMode!==dW.CacheMode.BITMAP||!gQ||gQ.width<=0||gQ.height<=0)){var e=t.ttfSpriteFrame;QU.packToDynamicAtlas(t,e)}},_setupOutline:function(){vQ.strokeStyle="rgba("+OQ.r+", "+OQ.g+", "+OQ.b+", "+OQ.a/255+")",vQ.lineWidth=2*MQ.width},_setupShadow:function(){vQ.shadowColor="rgba("+LQ.r+", "+LQ.g+", "+LQ.b+", "+LQ.a/255+")",vQ.shadowBlur=NQ.blur,vQ.shadowOffsetX=NQ.offset.x,vQ.shadowOffsetY=-NQ.offset.y},_drawTextEffect:function(t,e){if(NQ||MQ||qQ){var n=bQ.length>1&&NQ,i=this._measureText(vQ,xQ),r=0,o=0;NQ&&this._setupShadow(),MQ&&this._setupOutline();for(var a=0;a<bQ.length;++a)r=t.x,o=t.y+a*e,n&&(MQ&&vQ.strokeText(bQ[a],r,o),vQ.fillText(bQ[a],r,o)),qQ&&(kQ=i(bQ[a]),wQ===uW.RIGHT?UQ.x=t.x-kQ:wQ===uW.CENTER?UQ.x=t.x-kQ/2:UQ.x=t.x,UQ.y=o+AQ/8,vQ.fillRect(UQ.x,UQ.y,kQ,HQ));n&&(vQ.shadowColor="transparent")}},_updateLabelDimensions:function(){TQ.width=Math.min(TQ.width,2048),TQ.height=Math.min(TQ.height,2048);var t=!1;gQ.width!==TQ.width&&(gQ.width=TQ.width,t=!0),gQ.height!==TQ.height&&(gQ.height=TQ.height,t=!0),t&&(vQ.font=xQ),vQ.textAlign=XQ[wQ],vQ.textBaseline="alphabetic"},_getFontDesc:function(){var t=CQ.toString()+"px ";return t+=RQ,jQ&&(t="bold "+t),WQ&&(t="italic "+t),t},_getLineHeight:function(){return 0|(0===EQ?CQ:EQ*CQ/AQ)},_calculateParagraphLength:function(t,e){for(var n,i=[],r=ot(t);!(n=r()).done;){var o=zk(e,n.value,xQ);i.push(o)}return i},_measureText:function(t,e){return function(n){return zk(t,n,e)}},_calculateShrinkFont:function(t){if(vQ){var e=this._calculateParagraphLength(t,vQ),n=0,i=0,r=0;if(BQ){var o=GQ.width,a=GQ.height;if(o<0||a<0)return;i=a+1;for(var s=0,c=0|CQ+1,l=0;s<c;){if((l=s+c+1>>1)<=0){w(4003);break}CQ=l,xQ=this._getFontDesc(),vQ.font=xQ;var u=this._getLineHeight();for(i=0,n=0;n<t.length;++n){var h=zk(vQ,t[n],xQ);i+=Vk(t[n],h,o,this._measureText(vQ,xQ)).length*u}i>a?c=l-1:s=l}0===s?w(4003):(CQ=s,xQ=this._getFontDesc(),vQ.font=xQ)}else{for(i=t.length*this._getLineHeight(),n=0;n<t.length;++n)r<e[n]&&(r=e[n]);var _=(TQ.width-FQ.width)/r,f=TQ.height/i;CQ=AQ*Math.min(1,_,f)|0,xQ=this._getFontDesc(),vQ.font=xQ}}},_calculateWrapText:function(t){if(BQ&&vQ){bQ=[];for(var e=GQ.width,n=0;n<t.length;++n){var i=zk(vQ,t[n],xQ),r=Vk(t[n],i,e,this._measureText(vQ,xQ));bQ=bQ.concat(r)}}},_calculateLabelFont:function(){if(vQ){var t=SQ.split("\n");switch(bQ=t,xQ=this._getFontDesc(),vQ.font=xQ,DQ){case dQ.NONE:for(var e=0,n=0,i=0;i<t.length;++i){var r=zk(vQ,t[i],xQ);e=e>r?e:r}n=(bQ.length+Ek)*this._getLineHeight();var o=parseFloat(e.toFixed(2)),a=parseFloat(n.toFixed(2));TQ.width=o+FQ.width,TQ.height=a+FQ.height,GQ.width=o+zQ.width,GQ.height=a+zQ.height;break;case dQ.SHRINK:this._calculateShrinkFont(t),this._calculateWrapText(t);break;case dQ.CLAMP:this._calculateWrapText(t);break;case dQ.RESIZE_HEIGHT:this._calculateWrapText(t);var s=(bQ.length+Ek)*this._getLineHeight();TQ.height=s+FQ.height,GQ.height=s+zQ.height}}}},KQ=bn.WHITE.clone(),JQ={createData:function(t){var e=t.requestRenderData();e.dataLength=2,e.resize(4,6);var n=e.chunk.vb;n[3]=n[21]=n[22]=n[31]=0,n[4]=n[12]=n[13]=n[30]=1;for(var i=5,r=0;r<4;r++)bn.toArray(n,KQ,i),i+=9;return e},fillBuffers:function(t){var e=t.renderData.chunk,n=t.renderData.data,i=t.node,r=e.vb,o=n[0],a=n[1];i.updateWorldTransform();var s=i._pos,c=i._rot,l=i._scale,u=o.x*l.x,h=a.x*l.x,_=o.y*l.y,f=a.y*l.y,p=c.x,d=c.y,m=c.z,v=c.w,g=p*d,y=m*v,x=p*p-d*d,S=v*v-m*m,C=S+x,A=2*(g-y),b=S-x,T=2*(g+y),E=s.x,w=s.y;r[0]=C*u+A*_+E,r[1]=b*_+T*u+w,r[9]=C*h+A*_+E,r[10]=b*_+T*h+w,r[18]=C*u+A*f+E,r[19]=b*f+T*u+w,r[27]=C*h+A*f+E,r[28]=b*f+T*h+w;var P=e.bufferId,I=e.vertexOffset,R=e.vertexAccessor.getMeshBuffer(e.bufferId),D=e.vertexAccessor.getIndexBuffer(P),B=R.indexOffset;D[B++]=I,D[B++]=I+1,D[B++]=I+2,D[B++]=I+2,D[B++]=I+1,D[B++]=I+3,R.indexOffset+=6},updateVertexData:function(t){var e=t.renderData;if(e){var n=t.node._uiProps.uiTransformComp,i=n.width,r=n.height,o=n.anchorX*i,a=n.anchorY*r,s=e.data;s[0].x=-o,s[0].y=-a,s[1].x=i-o,s[1].y=r-a}},updateUVs:function(t){var e=t.renderData;if(e&&t.ttfSpriteFrame){var n=e.chunk.vb,i=t.ttfSpriteFrame.uv;n[3]=i[0],n[4]=i[1],n[12]=i[2],n[13]=i[3],n[21]=i[4],n[22]=i[5],n[30]=i[6],n[31]=i[7]}},updateColor:function(){}};Lt(JQ,YQ);var QQ=t("labelAssembler",{getAssembler:function(t){var e=JQ;return t.font instanceof bk?e=uQ:t.cacheMode===dW.CacheMode.CHAR&&(e=pQ),e}});dW.Assembler=QQ;var ZQ=iY.FillType,$Q=new Un,tZ=new En,eZ={updateRenderData:function(t){var e=t.spriteFrame;QU.packToDynamicAtlas(t,e);var n=t.renderData;if(n&&e){if(n.updateRenderData(t,e),!n.vertDirty)return;var i=t.fillStart,r=t.fillRange;r<0&&(i+=r,r=-r),r=(r=(r=i+r)>1?1:r)<0?0:r;var o=(i=(i=i>1?1:i)<0?0:i)+(r=(r-=i)<0?0:r);o=o>1?1:o,this.updateUVs(t,i,o),this.updateVertexData(t,i,o)}},updateUVs:function(t,e,n){var i=t.spriteFrame,r=t.renderData.chunk.vb,o=i.width,a=i.height,s=i.rect,c=0,l=0,u=0,h=0,_=0,f=0,p=0,d=0,m=0,v=0;switch(i.isRotated()?(c=s.x/o,l=(s.y+s.width)/a,u=_=c,p=m=(s.x+s.height)/o,f=v=l,h=d=s.y/a):(c=s.x/o,l=(s.y+s.height)/a,u=p=c,_=m=(s.x+s.width)/o,h=f=l,d=v=s.y/a),t.fillType){case ZQ.HORIZONTAL:r[3]=u+(_-u)*e,r[4]=h+(f-h)*e,r[12]=u+(_-u)*n,r[13]=h+(f-h)*n,r[21]=p+(m-p)*e,r[22]=d+(v-d)*e,r[30]=p+(m-p)*n,r[31]=d+(v-d)*n;break;case ZQ.VERTICAL:r[3]=u+(p-u)*e,r[4]=h+(d-h)*e,r[12]=_+(m-_)*e,r[13]=f+(v-f)*e,r[21]=u+(p-u)*n,r[22]=h+(d-h)*n,r[30]=_+(m-_)*n,r[31]=f+(v-f)*n;break;default:D(2626)}},updateVertexData:function(t,e,n){var i=t.renderData.data,r=t.node._uiProps.uiTransformComp,o=r.width,a=r.height,s=r.anchorX*o,c=r.anchorY*a,l=-s,u=-c,h=o-s,_=a-c,f=0;switch(t.fillType){case ZQ.HORIZONTAL:f=l+(h-l)*n,l+=(h-l)*e,h=f;break;case ZQ.VERTICAL:f=u+(_-u)*n,u+=(_-u)*e,_=f;break;default:D(2626)}i[0].x=l,i[0].y=u,i[1].x=h,i[1].y=u,i[2].x=l,i[2].y=_,i[3].x=h,i[3].y=_},createData:function(t){var e=t.requestRenderData();e.dataLength=4,e.resize(4,6);for(var n,i=ot(e.data);!(n=i()).done;)n.value.z=0;return e},updateWorldVertexData:function(t,e){t.node.getWorldMatrix($Q);for(var n=t.renderData.floatStride,i=t.renderData.data,r=e.vb,o=0,a=0;a<4;a++){var s=i[a];En.transformMat4(tZ,s,$Q),r[o=a*n]=tZ.x,r[o+1]=tZ.y,r[o+2]=tZ.z}},fillBuffers:function(t){var e=t.renderData,n=e.chunk;(t.node.hasChangedFlags||e.vertDirty)&&(this.updateWorldVertexData(t,n),e.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(n.bufferId),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset;a[s++]=r,a[s++]=r+1,a[s++]=r+2,a[s++]=r+2,a[s++]=r+1,a[s++]=r+3,o.indexOffset+=6},updateColor:function(t){for(var e=t.renderData,n=e.chunk.vb,i=e.floatStride,r=5,o=t.color,a=o.r/255,s=o.g/255,c=o.b/255,l=t.node._uiProps.opacity,u=0;u<4;u++)n[r]=a,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},nZ=2*Math.PI,iZ=1e-6,rZ=new Un,oZ=new En,aZ=[new Wn,new Wn,new Wn,new Wn],sZ=new Array(4),cZ=new Array(8),lZ=[new Wn,new Wn,new Wn,new Wn],uZ=[new Wn,new Wn,new Wn,new Wn],hZ=new Wn,_Z=[new Wn,new Wn,new Wn,new Wn];function fZ(t,e,n,i,r,o,a){var s=Math.sin(o);s=Math.abs(s)>iZ?s:0;var c=Math.cos(o),l=0,u=0;if(0!==(c=Math.abs(c)>iZ?c:0)){if(l=s/c,(t-r.x)*c>0){var h=r.y+l*(t-r.x);a[0].x=t,a[0].y=h}if((e-r.x)*c>0){var _=r.y+l*(e-r.x);a[2].x=e,a[2].y=_}}if(0!==s){if(u=c/s,(i-r.y)*s>0){var f=r.x+u*(i-r.y);a[3].x=f,a[3].y=i}if((n-r.y)*s>0){var p=r.x+u*(n-r.y);a[1].x=p,a[1].y=n}}}function pZ(t,e){var n=e.x-t.x,i=e.y-t.y;if(0===n&&0===i)return 0;if(0===n)return i>0?.5*Math.PI:1.5*Math.PI;var r=Math.atan(i/n);return n<0&&(r+=Math.PI),r}function dZ(t,e,n,i,r){var o=sZ,a=o[0],s=o[1],c=o[2],l=o[3];t[e].x=n.x,t[e].y=n.y,t[e+1].x=i.x,t[e+1].y=i.y,t[e+2].x=r.x,t[e+2].y=r.y,mZ((n.x-a)/(c-a),(n.y-s)/(l-s),t,e),mZ((i.x-a)/(c-a),(i.y-s)/(l-s),t,e+1),mZ((r.x-a)/(c-a),(r.y-s)/(l-s),t,e+2)}function mZ(t,e,n,i){var r=cZ,o=r[0]+(r[2]-r[0])*t,a=r[4]+(r[6]-r[4])*t,s=r[1]+(r[3]-r[1])*t,c=r[5]+(r[7]-r[5])*t,l=n[i];l.u=o+(a-o)*e,l.v=s+(c-s)*e}for(var vZ={useModel:!1,createData:function(t){return t.requestRenderData()},updateRenderData:function(t){var e=t.spriteFrame;QU.packToDynamicAtlas(t,e),this.updateUVs(t);var n=t.renderData;if(n&&e){if(!n.vertDirty)return;var i=n.data,r=t.fillStart,o=t.fillRange;for(o<0&&(r+=o,o=-o);r>=1;)r-=1;for(;r<0;)r+=1;var a=(r*=nZ)+(o*=nZ);!function(t){var e=t.node._uiProps.uiTransformComp,n=e.width,i=e.height,r=e.anchorX*n,o=e.anchorY*i,a=-r,s=-o,c=n-r,l=i-o,u=sZ;u[0]=a,u[1]=s,u[2]=c,u[3]=l;var h=t.fillCenter,_=hZ.x=Math.min(Math.max(0,h.x),1)*(c-a)+a,f=hZ.y=Math.min(Math.max(0,h.y),1)*(l-s)+s;aZ[0].x=aZ[3].x=a,aZ[1].x=aZ[2].x=c,aZ[0].y=aZ[1].y=s,aZ[2].y=aZ[3].y=l;for(var p,d=ot(_Z);!(p=d()).done;){var m=p.value;Wn.set(m,0,0)}_!==u[0]&&Wn.set(_Z[0],3,0),_!==u[2]&&Wn.set(_Z[2],1,2),f!==u[1]&&Wn.set(_Z[1],0,1),f!==u[3]&&Wn.set(_Z[3],2,3)}(t),function(t){var e=t.width,n=t.height,i=t.getRect(),r=0,o=0,a=0,s=0,c=cZ;t.isRotated()?(r=i.x/e,o=(i.x+i.height)/e,a=i.y/n,s=(i.y+i.width)/n,c[0]=c[2]=r,c[4]=c[6]=o,c[3]=c[7]=s,c[1]=c[5]=a):(r=i.x/e,o=(i.x+i.width)/e,a=i.y/n,s=(i.y+i.height)/n,c[0]=c[4]=r,c[2]=c[6]=o,c[1]=c[3]=s,c[5]=c[7]=a)}(e),fZ(sZ[0],sZ[2],sZ[1],sZ[3],hZ,r,lZ),fZ(sZ[0],sZ[2],sZ[1],sZ[3],hZ,r+o,uZ);for(var s=0,c=0;c<4;++c){var l=_Z[c];if(l)if(o>=nZ)n.dataLength=s+3,dZ(i,s,hZ,aZ[l.x],aZ[l.y]),s+=3;else{var u=pZ(hZ,aZ[l.x]),h=pZ(hZ,aZ[l.y]);h<u&&(h+=nZ),u-=nZ,h-=nZ;for(var _=0;_<3;++_)u>=a||(u>=r?(n.dataLength=s+3,dZ(i,s,hZ,aZ[l.x],h>=a?uZ[c]:aZ[l.y]),s+=3):h>r&&(h<=a?(n.dataLength=s+3,dZ(i,s,hZ,lZ[c],aZ[l.y]),s+=3):(n.dataLength=s+3,dZ(i,s,hZ,lZ[c],uZ[c]),s+=3))),u+=nZ,h+=nZ}}n.resize(s,s),n.updateRenderData(t,e)}},fillBuffers:function(t){var e=t.node,n=t.renderData,i=n.chunk;(e.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(t,i),n.vertDirty=!1),this.updataColorLate(t);for(var r=i.bufferId,o=i.vertexOffset,a=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=a.indexOffset,l=0;l<n.indexCount;l++)s[c+l]=o+l;a.indexOffset+=n.indexCount,a.setDirty()},updateWorldVertexAndUVData:function(t,e){t.node.getWorldMatrix(rZ);for(var n=t.renderData,i=n.floatStride,r=t.renderData.data,o=e.vb,a=n.vertexCount,s=0,c=0;c<a;c++){var l=r[c];En.set(oZ,l.x,l.y,0),En.transformMat4(oZ,oZ,rZ),o[s+0]=oZ.x,o[s+1]=oZ.y,o[s+2]=oZ.z,o[s+3]=l.u,o[s+4]=l.v,s+=i}},updateUVs:function(t){t.renderData.vertDirty=!0,t.markForUpdateRenderData()},updataColorLate:function(t){for(var e=t.renderData,n=e.chunk.vb,i=e.floatStride,r=e.vertexCount,o=5,a=t.color,s=a.r/255,c=a.g/255,l=a.b/255,u=t.node._uiProps.opacity,h=0;h<r;h++)n[o]=s,n[o+1]=c,n[o+2]=l,n[o+3]=u,o+=i},updateColor:function(){}},gZ=[],yZ=0;yZ<4;yZ++)gZ.push(new En);for(var xZ={createData:function(t){var e=t.requestRenderData();return e.dataLength=2,e.resize(4,6),e},updateRenderData:function(t){var e=t.spriteFrame;QU.packToDynamicAtlas(t,e),this.updateUVs(t);var n=t.renderData;n&&e&&(n.vertDirty&&this.updateVertexData(t),n.updateRenderData(t,e))},updateWorldVerts:function(t,e){var n=t.renderData,i=e.vb,r=n.data,o=t.node,a=r[0],s=r[1],c=o.worldMatrix,l=c.m00,u=c.m01,h=c.m04,_=c.m05,f=1===l&&0===u&&0===h&&1===_,p=c.m12,d=c.m13,m=a.x,v=s.x,g=a.y,y=s.y;if(f){var x=m+p,S=v+p,C=g+d,A=y+d;i[0]=x,i[1]=C,i[9]=S,i[10]=C,i[18]=x,i[19]=A,i[27]=S,i[28]=A}else{var b=l*m,T=l*v,E=u*m,w=u*v,P=h*g+p,I=h*y+p,R=_*g+d,D=_*y+d;i[0]=b+P,i[1]=E+R,i[9]=T+P,i[10]=w+R,i[18]=b+I,i[19]=E+D,i[27]=T+I,i[28]=w+D}},fillBuffers:function(t){if(null!==t){var e=t.renderData,n=e.chunk;(t.node.hasChangedFlags||e.vertDirty)&&(this.updateWorldVerts(t,n),e.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(i),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset;a[s++]=r,a[s++]=r+1,a[s++]=r+2,a[s++]=r+2,a[s++]=r+1,a[s++]=r+3,o.indexOffset+=6}},updateVertexData:function(t){var e=t.renderData;if(e){var n=t.node._uiProps.uiTransformComp,i=e.data,r=n.width,o=n.height,a=n.anchorX*r,s=n.anchorY*o,c=0,l=0,u=0,h=0;if(t.trim)c=-a,l=-s,u=r-a,h=o-s;else{var _=t.spriteFrame,f=_.getOriginalSize(),p=_.getRect(),d=f.width,m=f.height,v=p.width,g=p.height,y=_.getOffset(),x=r/d,S=o/m,C=y.x+(d-v)/2,A=y.x-(d-v)/2;c=C*x-a,l=(y.y+(m-g)/2)*S-s,u=r+A*x-a,h=o+(y.y-(m-g)/2)*S-s}i[0].x=c,i[0].y=l,i[1].x=u,i[1].y=h,e.vertDirty=!0}},updateUVs:function(t){if(t.spriteFrame){var e=t.renderData.chunk.vb,n=t.spriteFrame.uv;e[3]=n[0],e[4]=n[1],e[12]=n[2],e[13]=n[3],e[21]=n[4],e[22]=n[5],e[30]=n[6],e[31]=n[7]}},updateColor:function(t){for(var e=t.renderData,n=e.chunk.vb,i=5,r=t.color,o=r.r/255,a=r.g/255,s=r.b/255,c=r.a/255,l=0;l<4;l++,i+=e.floatStride)n[i]=o,n[i+1]=a,n[i+2]=s,n[i+3]=c}},SZ=new En,CZ=new Un,AZ={createData:function(t){var e=t.requestRenderData();return e.dataLength=4,e.resize(16,54),e},updateRenderData:function(t){var e=t.spriteFrame;QU.packToDynamicAtlas(t,e),this.updateUVs(t);var n=t.renderData;n&&e&&(n.vertDirty&&this.updateVertexData(t),n.updateRenderData(t,e))},updateVertexData:function(t){var e=t.renderData.data,n=t.node._uiProps.uiTransformComp,i=n.width,r=n.height,o=n.anchorX*i,a=n.anchorY*r,s=t.spriteFrame,c=s.insetLeft,l=s.insetRight,u=s.insetTop,h=s.insetBottom,_=i-c-l,f=r-u-h,p=i/(c+l),d=r/(u+h);p=Number.isNaN(p)||p>1?1:p,d=Number.isNaN(d)||d>1?1:d,_=_<0?0:_,f=f<0?0:f,e[0].x=-o,e[0].y=-a,e[1].x=c*p-o,e[1].y=h*d-a,e[2].x=e[1].x+_,e[2].y=e[1].y+f,e[3].x=i-o,e[3].y=r-a},fillBuffers:function(t){var e=t.renderData,n=e.chunk;(t.node.hasChangedFlags||e.vertDirty)&&(this.updateWorldVertexData(t,n),e.vertDirty=!1);for(var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(n.bufferId),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset,c=0;c<3;++c)for(var l=0;l<3;++l){var u=r+4*c+l;a[s++]=u,a[s++]=u+1,a[s++]=u+4,a[s++]=u+1,a[s++]=u+5,a[s++]=u+4}o.indexOffset=s},updateWorldVertexData:function(t,e){t.node.getWorldMatrix(CZ);for(var n=t.renderData,i=n.floatStride,r=n.data,o=e.vb,a=0,s=0;s<4;++s)for(var c=r[s],l=0;l<4;++l){var u=r[l];En.set(SZ,u.x,c.y,0),En.transformMat4(SZ,SZ,CZ),a=(4*s+l)*i,o[a++]=SZ.x,o[a++]=SZ.y,o[a++]=SZ.z}},updateUVs:function(t){if(t.spriteFrame)for(var e=t.renderData,n=e.chunk.vb,i=e.floatStride,r=t.spriteFrame.uvSliced,o=3,a=0;a<16;a++)n[o]=r[a].u,n[o+1]=r[a].v,o+=i},updateColor:function(t){for(var e=t.renderData,n=e.chunk.vb,i=e.floatStride,r=5,o=t.color,a=o.r/255,s=o.g/255,c=o.b/255,l=t.node._uiProps.opacity,u=0;u<16;u++)n[r]=a,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},bZ=[],TZ=0;TZ<4;TZ++)bZ.push(new En);var EZ=new Un,wZ={createData:function(t){return t.requestRenderData()},updateRenderData:function(t){var e=t.renderData,n=t.spriteFrame;if(n&&e&&(e.updateRenderData(t,n),e.vertDirty)){var i=t.node._uiProps.uiTransformComp,r=Math.abs(i.width),o=Math.abs(i.height),a=n.getRect(),s=n.insetLeft,c=n.insetRight,l=a.width-s-c,u=n.insetTop,h=n.insetBottom,_=a.height-u-h,f=r-s-c,p=o-u-h;f=f>0?f:0,p=p>0?p:0;var d=0===l?f:f/l,m=0===_?p:p/_,v=Math.ceil(m+2),g=Math.ceil(d+2);e.dataLength=Math.max(8,v+1,g+1),this.updateVerts(t,f,p,v,g),e.resize(v*g*4,v*g*6)}},updateUVs:function(t){t.renderData.vertDirty=!0,t.markForUpdateRenderData()},fillBuffers:function(t){var e=t.node,n=t.renderData,i=n.chunk;(e.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(t,i),n.vertDirty=!1),this.updataColorLate(t);for(var r=i.bufferId,o=i.vertexOffset,a=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=a.indexOffset,l=0;l<n.indexCount;l+=6)s[c++]=o,s[c++]=o+1,s[c++]=o+2,s[c++]=o+1,s[c++]=o+3,s[c++]=o+2,o+=4,a.indexOffset+=6;a.setDirty()},updateWorldVertexAndUVData:function(t,e){var n=t.node;n.getWorldMatrix(EZ);var i=t.renderData,r=i.floatStride,o=i.data,a=e.vb,s=n._uiProps.uiTransformComp,c=Math.abs(s.width),l=Math.abs(s.height),u=t.spriteFrame,h=u.rotated,_=u.uv,f=u.uvSliced,p=u.rect,d=u.insetLeft,m=u.insetRight,v=p.width-d-m,g=u.insetTop,y=u.insetBottom,x=p.height-g-y,S=c-d-m,C=l-g-y;S=S>0?S:0,C=C>0?C:0;for(var A=0===v?S:S/v,b=0===x?C:C/x,T=Math.ceil(b+2),E=Math.ceil(A+2),w=0,P=0,I=0,R=0,D=0,B=0,M=T;B<M;++B){R=o[B].y,D=o[B+1].y;for(var O=0,N=E;O<N;++O){P=o[O].x,I=o[O+1].x,En.set(bZ[0],P,R,0),En.set(bZ[1],I,R,0),En.set(bZ[2],P,D,0),En.set(bZ[3],I,D,0);for(var L=0;L<4;L++){var F=bZ[L];En.transformMat4(F,F,EZ);var z=L*r;a[w+z]=F.x,a[w+z+1]=F.y,a[w+z+2]=F.z}w+=4*r}}w=0;for(var G=r,V=2*r,U=3*r,k=4*r,H=0,j=0,W=[],q=[],X=0,Y=T;X<Y;++X){j=C>x?C>=X*x?1:b%1:b;for(var K=0,J=E;K<J;++K){H=S>v?S>=K*v?1:A%1:A;var Q=w+3,Z=Q+1;h?(0===X?(W[0]=f[0].u,W[1]=f[0].u,W[2]=f[4].u+(f[8].u-f[4].u)*j):X<T-1?(W[0]=f[4].u,W[1]=f[4].u,W[2]=f[4].u+(f[8].u-f[4].u)*j):X===T-1&&(W[0]=f[8].u,W[1]=f[8].u,W[2]=f[12].u),0===K?(q[0]=f[0].v,q[1]=f[1].v+(f[2].v-f[1].v)*H,q[2]=f[0].v):K<E-1?(q[0]=f[1].v,q[1]=f[1].v+(f[2].v-f[1].v)*H,q[2]=f[1].v):K===E-1&&(q[0]=f[2].v,q[1]=f[3].v,q[2]=f[2].v),W[3]=W[2],q[3]=q[1]):(0===K?(W[0]=f[0].u,W[1]=f[1].u+(f[2].u-f[1].u)*H,W[2]=_[0]):K<E-1?(W[0]=f[1].u,W[1]=f[1].u+(f[2].u-f[1].u)*H,W[2]=f[1].u):K===E-1&&(W[0]=f[2].u,W[1]=f[3].u,W[2]=f[2].u),0===X?(q[0]=f[0].v,q[1]=f[0].v,q[2]=f[4].v+(f[8].v-f[4].v)*j):X<T-1?(q[0]=f[4].v,q[1]=f[4].v,q[2]=f[4].v+(f[8].v-f[4].v)*j):X===T-1&&(q[0]=f[8].v,q[1]=f[8].v,q[2]=f[12].v),W[3]=W[1],q[3]=q[2]),a[Q]=W[0],a[Z]=q[0],a[Q+G]=W[1],a[Z+G]=q[1],a[Q+V]=W[2],a[Z+V]=q[2],a[Q+U]=W[3],a[Z+U]=q[3],w+=k}}},updateVerts:function(t,e,n,i,r){var o,a,s=t.node._uiProps.uiTransformComp,c=t.renderData.data,l=t.spriteFrame,u=l.rect,h=Math.abs(s.width),_=Math.abs(s.height),f=s.anchorX*h,p=s.anchorY*_,d=l.insetLeft,m=l.insetRight,v=u.width-d-m,g=l.insetTop,y=l.insetBottom,x=u.height-g-y,S=s.width/(d+m)>1?1:s.width/(d+m),C=s.height/(g+y)>1?1:s.height/(g+y);o=v>0?Math.floor(1e3*e)/1e3%v==0?v:e%v:e,a=x>0?Math.floor(1e3*n)/1e3%x==0?x:n%x:n;for(var A=0;A<=r;A++)0===A?c[A].x=-f:A>0&&A<r?c[A].x=1===A?d*S+Math.min(v,e)-f:v>0?A===r-1?d+o+v*(A-2)-f:d+Math.min(v,e)+v*(A-2)-f:d+e-f:A===r&&(c[A].x=Math.min(d+e+m,h)-f);for(var b=0;b<=i;b++)0===b?c[b].y=-p:b>0&&b<i?c[b].y=1===b?y*C+Math.min(x,n)-p:x>0?b===i-1?y+a+(b-2)*x-p:y+Math.min(x,n)+(b-2)*x-p:y+n-p:b===i&&(c[b].y=Math.min(y+n+g,_)-p)},updataColorLate:function(t){for(var e=t.renderData,n=e.chunk.vb,i=e.floatStride,r=e.vertexCount,o=5,a=t.color,s=a.r/255,c=a.g/255,l=a.b/255,u=t.node._uiProps.opacity,h=0;h<r;h++)n[o]=s,n[o+1]=c,n[o+2]=l,n[o+3]=u,o+=i},updateColor:function(){}},PZ=iY.Type,IZ=iY.FillType,RZ=t("spriteAssembler",{getAssembler:function(t){var e=xZ,n=t;switch(n.type){case PZ.SLICED:e=AZ;break;case PZ.TILED:e=wZ;break;case PZ.FILLED:e=n.fillType===IZ.RADIAL?vZ:eZ}return e}});iY.Assembler=RZ;var DZ=QH.sharedManager,BZ={createData:function(t){var e=t.requestRenderData();return e.dataLength=2,e.resize(4,6),e},updateRenderData:function(t){t.type===zq.IMAGE_STENCIL&&(xZ.updateRenderData(t),xZ.updateColor(t))},fillBuffers:function(t,e){(t.type!==zq.IMAGE_STENCIL||t.spriteFrame)&&(DZ.pushMask(t),e.finishMergeBatches(),function(t,e){DZ.clear(t),e.commitModel(t,t._clearModel,t._clearStencilMtl)}(t,e),function(t,e){if(DZ.enterLevel(t),t.type===zq.IMAGE_STENCIL){xZ.fillBuffers(t,e);var n=t.graphics.getMaterialInstance(0);e.forceMergeBatches(n,t.spriteFrame,t.graphics)}else t.graphics.updateAssembler(e)}(t,e),DZ.enableMask())}},MZ={fillBuffers:function(){DZ.exitMask()}},OZ={getAssembler:function(){return BZ}},NZ={getAssembler:function(){return MZ}};Hq.Assembler=OZ,Hq.PostAssembler=NZ;var LZ=t("MeshBuffer",function(){function t(){this.byteOffset=0,this.vertexOffset=0,this.indexOffset=0,this.vData=null,this.iData=null,this._dirty=!1,this._vertexFormatBytes=0,this._floatsPerVertex=0,this._initVDataCount=0,this._initIDataCount=0,this._attributes=null,this._iaPool=[],this._iaInfo=null,this._nextFreeIAHandle=0}var e=t.prototype;return e.initialize=function(t,e,n,i){this._initVDataCount=n,this._initIDataCount=i,this._attributes=e,this._floatsPerVertex=$k(e),this._initVDataCount,this._floatsPerVertex,N(9005),this.vData&&this.iData||(this.vData=new Float32Array(this._initVDataCount),this.iData=new Uint16Array(this._initIDataCount)),this._iaPool.push(this.createNewIA(t))},e.reset=function(){this._nextFreeIAHandle=0,this._dirty=!1},e.destroy=function(){this.reset(),this._attributes=null,this._iaInfo=null,this.vData=null,this.iData=null;for(var t=0;t<this._iaPool.length;++t){var e=this._iaPool[t];e.vertexBuffers[0]&&e.vertexBuffers[0].destroy(),e.indexBuffer&&e.indexBuffer.destroy(),e.ia.destroy()}this._iaPool.length=0},e.setDirty=function(){this._dirty=!0},e.request=function(){return I(9002),!1},e.requireFreeIA=function(t){return this._iaPool.length<=this._nextFreeIAHandle&&this._iaPool.push(this.createNewIA(t)),this._iaPool[this._nextFreeIAHandle++].ia},e.recycleIA=function(t){for(var e=this._iaPool,n=0;n<this._nextFreeIAHandle;++n)if(t===e[n].ia){var i=e[n];return e[n]=e[--this._nextFreeIAHandle],void(e[this._nextFreeIAHandle]=i)}},e.checkCapacity=function(t,e){var n=this.vertexOffset+t,i=this.indexOffset+e;return!(n>this._initVDataCount||i>this._initIDataCount)},e.uploadBuffers=function(){if(0!==this.byteOffset&&this._dirty){for(var t=oh.__isWebIOS14OrIPadOS14Env?this._nextFreeIAHandle:1,e=this.byteOffset,n=this.indexOffset,i=0;i<t;++i){var r=this._iaPool[i],o=new Float32Array(this.vData.buffer,0,e>>2),a=new Uint16Array(this.iData.buffer,0,n),s=r.vertexBuffers[0];e>s.size&&s.resize(e),s.update(o),2*n>r.indexBuffer.size&&r.indexBuffer.resize(2*n),r.indexBuffer.update(a)}this._dirty=!1}},e.createNewIA=function(t){var e,n,i;if(oh.__isWebIOS14OrIPadOS14Env||!this._iaPool[0]){var r=this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT,o=Uint16Array.BYTES_PER_ELEMENT,a=t.createBuffer(new lr(fi.VERTEX|fi.TRANSFER_DST,mi.HOST|mi.DEVICE,r,r));i=t.createBuffer(new lr(fi.INDEX|fi.TRANSFER_DST,mi.HOST|mi.DEVICE,o,o)),n=[a],this._iaInfo=new Pr(this._attributes,n,i),e=t.createInputAssembler(this._iaInfo)}else e=t.createInputAssembler(this._iaInfo),n=this._iaInfo.vertexBuffers,i=this._iaInfo.indexBuffer;return{ia:e,vertexBuffers:n,indexBuffer:i}},K(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}}]),t}()),FZ=[rD.EventType.MOUSE_DOWN,rD.EventType.MOUSE_MOVE,rD.EventType.MOUSE_UP,rD.EventType.MOUSE_WHEEL],zZ=[rD.EventType.TOUCH_START,rD.EventType.TOUCH_MOVE,rD.EventType.TOUCH_END,rD.EventType.TOUCH_CANCEL],GZ=(new(function(){function t(){this.priority=YR.UI,this._isListDirty=!1,this._inDispatchCount=0,this._pointerEventProcessorList=[],this._processorListToAdd=[],this._processorListToRemove=[],oD._registerEventDispatcher(this),CR.callbacksInvoker.on(FE.ADD_POINTER_EVENT_PROCESSOR,this.addPointerEventProcessor,this),CR.callbacksInvoker.on(FE.REMOVE_POINTER_EVENT_PROCESSOR,this.removePointerEventProcessor,this),CR.callbacksInvoker.on(FE.MARK_LIST_DIRTY,this._markListDirty,this)}var e=t.prototype;return e.dispatchEvent=function(t){var e=t.type;return zZ.includes(e)?this.dispatchEventTouch(t):!FZ.includes(e)||this.dispatchEventMouse(t)},e.addPointerEventProcessor=function(t){0===this._inDispatchCount?this._pointerEventProcessorList.includes(t)||(this._pointerEventProcessorList.push(t),this._isListDirty=!0):this._processorListToAdd.includes(t)||this._processorListToAdd.push(t),ee.array.remove(this._processorListToRemove,t)},e.removePointerEventProcessor=function(t){0===this._inDispatchCount?(ee.array.remove(this._pointerEventProcessorList,t),this._isListDirty=!0):this._processorListToRemove.includes(t)||this._processorListToRemove.push(t),ee.array.remove(this._processorListToAdd,t)},e.dispatchEventMouse=function(t){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var e=this._pointerEventProcessorList,n=e.length,i=!0,r=0;r<n;++r){var o=e[r];if(o.isEnabled&&o.shouldHandleEventMouse&&o._handleEventMouse(t)){if(i=!1,!t.preventSwallow)break;t.preventSwallow=!1}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),i},e.dispatchEventTouch=function(t){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var e=this._pointerEventProcessorList,n=e.length,i=t.touch,r=!0,o=0;o<n;++o){var a=e[o];if(a.isEnabled&&a.shouldHandleEventTouch)if(t.type===NE.TOUCH_START){if(a._handleEventTouch(t)){if(a.claimedTouchIdList.push(i.getID()),r=!1,!t.preventSwallow)break;t.preventSwallow=!1}}else if(a.claimedTouchIdList.length>0){var s=a.claimedTouchIdList.indexOf(i.getID());if(-1!==s){if(a._handleEventTouch(t),t.type!==NE.TOUCH_END&&t.type!==NE.TOUCH_CANCEL||ee.array.removeAt(a.claimedTouchIdList,s),r=!1,!t.preventSwallow)break;t.preventSwallow=!1}}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),r},e._updatePointerEventProcessorList=function(){for(var t=this._processorListToAdd,e=t.length,n=0;n<e;++n)this.addPointerEventProcessor(t[n]);t.length=0;for(var i=this._processorListToRemove,r=i.length,o=0;o<r;++o)this.removePointerEventProcessor(i[o]);i.length=0},e._sortPointerEventProcessorList=function(){if(this._isListDirty){for(var t=this._pointerEventProcessorList,e=t.length,n=0;n<e;++n){var i=t[n],r=i.node;if(r._uiProps){var o=r._uiProps.uiTransformComp;i.cachedCameraPriority=o.cameraPriority}}t.sort(this._sortByPriority),this._isListDirty=!1}},e._sortByPriority=function(t,e){var n=t.node,i=e.node;if(!(e&&i&&i.activeInHierarchy&&i._uiProps.uiTransformComp))return-1;if(!(t&&n&&n.activeInHierarchy&&n._uiProps.uiTransformComp))return 1;if(t.cachedCameraPriority!==e.cachedCameraPriority)return e.cachedCameraPriority-t.cachedCameraPriority;for(var r=n,o=i,a=!1;(null===(s=r.parent)||void 0===s?void 0:s._id)!==(null===(c=o.parent)||void 0===c?void 0:c._id);){var s,c,l,u,h,_;r=null===(null===(l=r)||void 0===l||null===(u=l.parent)||void 0===u?void 0:u.parent)?(a=!0)&&i:r&&r.parent,o=null===(null===(h=o)||void 0===h||null===(_=h.parent)||void 0===_?void 0:_.parent)?(a=!0)&&n:o&&o.parent}if(r._id===o._id){if(r._id===i._id)return-1;if(r._id===n._id)return 1}var f=r?r.getSiblingIndex():0,p=o?o.getSiblingIndex():0;return a?f-p:p-f},e._markListDirty=function(){this._isListDirty=!0},t}()),function(){function t(t,e){this._device=null,this._attributes=null,this._vertexFormatBytes=void 0,this._floatsPerVertex=void 0,this._buffers=[],this._device=t,this._attributes=e,this._floatsPerVertex=$k(e),this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT}var e=t.prototype;return e.initialize=function(){},e.reset=function(){},e.request=function(){},e.appendBuffers=function(){},e.uploadBuffers=function(){},e.destroy=function(){this._attributes.length=0},K(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}},{key:"floatsPerVertex",get:function(){return this._floatsPerVertex}}]),t}()),VZ=new Vl((function(){return{offset:0,length:0}}),32),UZ=function(t,e,n,i){this.vertexAccessor=t,this.bufferId=e,this.vertexOffset=n,this.vb=i},kZ=function(t){function e(n,i,r,o){var a;return(a=t.call(this,n,i)||this)._freeLists=[],a._vCount=0,a._iCount=0,a._vCount=r||Math.floor(1024*ce.BATCHER2D_MEM_INCREMENT/a._vertexFormatBytes),a._iCount=o||a._vCount*e.IB_SCALE,a._allocateBuffer(),a}Q(e,t);var n=e.prototype;return n.destroy=function(){for(var e=0;e<this._buffers.length;++e){this._buffers[e].destroy();for(var n=this._freeLists[e],i=0;i<n.length;++i)VZ.free(n[i])}this._buffers.length=0,this._freeLists.length=0,t.prototype.destroy.call(this)},n.reset=function(){for(var t=0;t<this._buffers.length;++t){var e=this._buffers[t];e.indexOffset=0,e.reset()}},n.getVertexBuffer=function(t){return this._buffers[t].vData},n.getIndexBuffer=function(t){return this._buffers[t].iData},n.getMeshBuffer=function(t){return this._buffers[t]},n.uploadBuffers=function(){for(var t=0;t<this._buffers.length;++t){var e=this._freeLists[t][0],n=this._buffers[t];(!e||e.length<n.vData.byteLength)&&n.uploadBuffers()}},n.appendIndices=function(t,e){var n=this._buffers[t];e.length&&(n.iData.set(e,n.indexOffset),n.indexOffset+=e.length)},n.allocateChunk=function(t,e){for(var n,i=t*this.vertexFormatBytes,r=null,o=0,a=-1,s=null,c=0;c<this._buffers.length;++c){r=this._buffers[c],n=this._freeLists[c];for(var l=0;l<n.length;++l)if(n[l].length>=i){s=n[l],o=c,a=l;break}if(s)break}if(s||(o=this._allocateBuffer(),(r=this._buffers[o])&&r.checkCapacity(t,e)&&(a=0,s=this._freeLists[o][a])),s){var u=s.offset/this.vertexFormatBytes,h=new Float32Array(r.vData.buffer,s.offset,i>>2).fill(0);return this._allocateChunkFromEntry(o,a,s,i),new UZ(this,o,u,h,e)}return I(9004,i),null},n.recycleChunk=function(t){var e=this._freeLists[t.bufferId],n=this._buffers[t.bufferId],i=t.vertexOffset*this.vertexFormatBytes,r=t.vb.byteLength;if(0!==r){for(var o=!1,a=0,s=null,c=e[a];c&&c.offset<i;)s=c,c=e[++a];if(s&&0==i-(s.offset+s.length)&&(s.length+=r,i=s.offset,r=s.length,c&&c.offset-(i+r)==0&&(s.length+=c.length,e.splice(a,1),VZ.free(c),c=null),o=!0),!o&&c){if(0==c.offset-(i+r))c.offset=i,c.length+=r;else{var l=VZ.alloc();l.offset=i,l.length=r,e.splice(a,0,l)}o=!0}if(o)i+r===n.byteOffset&&(n.byteOffset=i);else{var u=VZ.alloc();u.offset=i,u.length=r,e.push(u)}}},n._allocateChunkFromEntry=function(t,e,n,i){var r=n.length-i,o=n.offset+i,a=this._buffers[t];a.byteOffset<o&&(a.byteOffset=o),O(r>=0,9004,t,n.offset,n.length),0===r?(this._freeLists[t].splice(e,1),VZ.free(n)):(n.offset+=i,n.length=r)},n._allocateBuffer=function(){O(this._buffers.length===this._freeLists.length,9003);var t=new LZ,e=this._vCount*this._floatsPerVertex;t.initialize(this._device,this._attributes,e,this._iCount),this._buffers.push(t);var n=VZ.alloc();n.offset=0,n.length=t.vData.byteLength;var i=[n];return this._freeLists.push(i),this._buffers.length-1},e}(GZ);kZ.IB_SCALE=4;var HZ=new Gr(null),jZ=new Un,WZ=t("UI",function(){function t(t){var e=this;this.device=void 0,this._screens=[],this._staticVBBuffer=null,this._bufferAccessors=new Map,this._drawBatchPool=void 0,this._batches=void 0,this._currBID=-1,this._indexStart=0,this._emptyMaterial=new ig,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._currHash=0,this._pOpacity=1,this._opacityDirty=0,this._descriptorSetCache=new XZ,this._meshDataArray=[],this._root=t,this.device=t.device,this._batches=new kl(64),this._drawBatchPool=new Vl((function(){return new HK}),128,(function(t){return t.destroy(e)}))}var e=t.prototype;return e.initialize=function(){return!0},e.destroy=function(){for(var t=0;t<this._batches.length;t++)this._batches.array[t]&&this._batches.array[t].destroy(this);this._batches.destroy(),this._bufferAccessors.forEach((function(t){t.destroy()})),this._bufferAccessors.clear(),this._drawBatchPool&&this._drawBatchPool.destroy(),this._descriptorSetCache.destroy(),QH.sharedManager.destroy()},e.addScreen=function(t){this._screens.push(t),this._screens.sort(this._screenSort)},e.removeScreen=function(t){var e=this._screens.indexOf(t);-1!==e&&this._screens.splice(e,1)},e.sortScreens=function(){this._screens.sort(this._screenSort)},e.getFirstRenderCamera=function(t){if(t.scene&&t.scene.renderScene)for(var e=t.scene.renderScene.cameras,n=0;n<e.length;n++){var i=e[n];if(i.visibility&t.layer)return i}return null},e.update=function(){for(var t=this._screens,e=0,n=0;n<t.length;++n){var i=t[n],r=i._getRenderScene();if(i.enabledInHierarchy&&r){this._opacityDirty=0,this._pOpacity=1,this.walk(i.node),this.autoMergeBatches(this._currComponent),this.resetRenderStates();var o=0;if(this._batches.length>e)for(;e<this._batches.length;++e){var a=this._batches.array[e];if(a.model)for(var s=a.model.subModels,c=0;c<s.length;c++)s[c].priority=o++;else a.descriptorSet=this._descriptorSetCache.getDescriptorSet(a);r.addBatch(a)}}}},e.uploadBuffers=function(){this._batches.length>0&&(this._meshDataArray.forEach((function(t){t.uploadBuffers()})),this._bufferAccessors.forEach((function(t){t.uploadBuffers(),t.reset()})),this._descriptorSetCache.update())},e.reset=function(){for(var t=0;t<this._batches.length;++t){var e=this._batches.array[t];e.isStatic||(e.clear(),this._drawBatchPool.free(e))}this._bufferAccessors.forEach((function(t){t.reset()})),this._meshDataArray.forEach((function(t){t.freeIAPool()})),this._meshDataArray.length=0,this._staticVBBuffer=null,this._currBID=-1,this._indexStart=0,this._currHash=0,this._currLayer=0,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._batches.clear(),QH.sharedManager.reset()},e.switchBufferAccessor=function(t){void 0===t&&(t=Qk);var e=t===Qk?36:tH(t);if(!this._staticVBBuffer||this._staticVBBuffer.vertexFormatBytes!==e){var n=this._bufferAccessors.get(e);n||(n=new kZ(this.device,t),this._bufferAccessors.set(e,n)),this._staticVBBuffer=n,this._currBID=-1}return this._staticVBBuffer},e.registerBufferAccessor=function(t,e){this._bufferAccessors.set(t,e)},e.updateBuffer=function(t,e){var n=this.switchBufferAccessor(t);this._currBID!==e&&(this._currBID=e,this._indexStart=n.getMeshBuffer(e).indexOffset)},e.commitComp=function(t,e,n,i,r){var o,a=0,s=-1;if(e&&e.chunk){if(!e.isValid())return;a=e.dataHash,o=e.material,s=e.chunk.bufferId}t.stencilStage=QH.sharedManager.stage;var c=t.stencilStage;this._currHash===a&&0!==a&&this._currMaterial===o&&this._currDepthStencilStateStage===c||(this.autoMergeBatches(this._currComponent),e&&!e.isMeshBuffer&&this.updateBuffer(e.vertexFormat,s),this._currRenderData=e,this._currHash=e?e.dataHash:0,this._currComponent=t,this._currTransform=r,this._currMaterial=t.getRenderMaterial(0),this._currDepthStencilStateStage=c,this._currLayer=t.node.layer,n?(this._currTexture=n.getGFXTexture(),this._currSampler=n.getGFXSampler(),this._currTextureHash=n.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0)),i.fillBuffers(t,this)},e.commitIA=function(t,e,n,i,r){var o,a;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var s=0,c=0;t&&(o=-1===t.blendHash?null:t.getBlendState(),c=t.blendHash,t.stencilStage=QH.sharedManager.stage,a=null!==t.customMaterial?QH.sharedManager.getStencilStage(t.stencilStage,i):QH.sharedManager.getStencilStage(t.stencilStage),s=QH.sharedManager.getStencilHash(t.stencilStage));var l=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();l.visFlags=t.node.layer,l.inputAssembler=e,l.useLocalData=r||null,n&&(l.texture=n.getGFXTexture(),l.sampler=n.getGFXSampler(),l.textureHash=n.getHash(),l.samplerHash=l.sampler.hash),l.fillPasses(i||null,a,s,o,c,null,this),this._batches.push(l)},e.commitModel=function(t,e,n){var i;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var r=0;n&&(t.stencilStage!==dH.ENABLED&&t.stencilStage!==dH.DISABLED||(t.stencilStage=QH.sharedManager.stage),i=QH.sharedManager.getStencilStage(t.stencilStage,n),r=QH.sharedManager.getStencilHash(t.stencilStage));var o=c.director.getTotalFrames();e&&(e.updateTransform(o),e.updateUBOs(o));for(var a=0;a<e.subModels.length;a++){var s=this._drawBatchPool.alloc(),l=e.subModels[a];s.visFlags=t.node.layer,s.model=e,s.texture=null,s.sampler=null,s.useLocalData=null,i||(i=null),s.fillPasses(n,i,r,null,0,l.patches,this),s.inputAssembler=l.inputAssembler,s.model.visFlags=s.visFlags,s.descriptorSet=l.descriptorSet,this._batches.push(s)}},e.setupStaticBatch=function(t,e){this.finishMergeBatches(),this._staticVBBuffer=e,this.currStaticRoot=t},e.endStaticBatch=function(){this.finishMergeBatches(),this.currStaticRoot=null,this._staticVBBuffer=null,this.switchBufferAccessor()},e.commitStaticBatch=function(t){this._batches.concat(t.drawBatchList),this.finishMergeBatches()},e.autoMergeBatches=function(t){var e=this._currMaterial;if(e){var n,i=this._currRenderData,r=this._staticVBBuffer;if(i&&i.isMeshBuffer)n=i.requestIA(this.device),-1===this._meshDataArray.indexOf(i)&&this._meshDataArray.push(i);else if(r){var o=this._currBID,a=r.getMeshBuffer(o);if(!a)return;var s=a.indexOffset-this._indexStart;if(s<=0)return;this._indexStart,a.indexOffset,a.setDirty(),(n=a.requireFreeIA(this.device)).firstIndex=this._indexStart,n.indexCount=s,this._indexStart=a.indexOffset}if(this._currBID=-1,n){var c,l,u=0,h=0;t&&(c=-1===t.blendHash?null:t.getBlendState(),h=t.blendHash,l=null!==t.customMaterial?QH.sharedManager.getStencilStage(t.stencilStage,e):QH.sharedManager.getStencilStage(t.stencilStage),u=QH.sharedManager.getStencilHash(t.stencilStage));var _=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();_.visFlags=this._currLayer,_.texture=this._currTexture,_.sampler=this._currSampler,_.inputAssembler=n,_.useLocalData=this._currTransform,_.textureHash=this._currTextureHash,_.samplerHash=this._currSamplerHash,_.fillPasses(e,l,u,c,h,null,this),this._batches.push(_)}}},e.forceMergeBatches=function(t,e,n){this._currMaterial=t,e?(this._currTexture=e.getGFXTexture(),this._currSampler=e.getGFXSampler(),this._currTextureHash=e.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=n.node.layer,this.autoMergeBatches(n)},e.resetRenderStates=function(){this._currMaterial=this._emptyMaterial,this._currRenderData=null,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0},e.finishMergeBatches=function(){this.autoMergeBatches(),this.resetRenderStates()},e.flushMaterial=function(t){this._currMaterial=t},e.walk=function(t,e){if(void 0===e&&(e=0),t.activeInHierarchy){var n=t.children,i=t._uiProps,r=i.uiComp,o=this._pOpacity,a=o,s=r&&r.color?r.color.a/255:1;if(this._pOpacity=a*=s*i.localOpacity,i._opacity=a,i.colorDirty&&this._opacityDirty++,r&&r.enabledInHierarchy&&r.updateAssembler(this),this._opacityDirty&&r&&r.renderData&&r.renderData.vertexCount>0){!function(t,e){for(var n,i,r,o=t.vertexFormat,a=t.chunk.vb,s=0,c=0;c<o.length;++c){if(n=o[c],(i=Jr[n.format]).hasAlpha)if(r=t.floatStride,i.size/i.count==1)for(var l=~~on(Math.round(255*e),0,255),u=s;u<a.length;u+=r)a[u]=(4294967040&a[u]|l)>>>0;else if(i.size/i.count==4)for(var h=s+3;h<a.length;h+=r)a[h]=e;s+=i.size>>2}}(r.renderData,a);var c=r.renderData.getMeshBuffer();c&&c.setDirty()}if(n.length>0&&!t._static)for(var l=0;l<n.length;++l){var u=n[l];this.walk(u,e)}i.colorDirty&&(this._opacityDirty--,i.colorDirty=!1),this._pOpacity=o,r&&r.enabledInHierarchy&&r.postUpdateAssembler(this),e+=1}},e._screenSort=function(t,e){return t.node.getSiblingIndex()-e.node.getSiblingIndex()},e._releaseDescriptorSetCache=function(t){this._descriptorSetCache.releaseDescriptorSetCache(t)},K(t,[{key:"currBufferAccessor",get:function(){return this._staticVBBuffer||(this._staticVBBuffer=this.switchBufferAccessor()),this._staticVBBuffer}},{key:"batches",get:function(){return this._batches}},{key:"currStaticRoot",set:function(t){this._currStaticRoot=t}},{key:"currIsStatic",set:function(t){this._currIsStatic=t}}]),t}()),qZ=function(){function t(){this._descriptorSet=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;var t=c.director.root.device;this._localData=new Float32Array(sd.COUNT),this._localBuffer=t.createBuffer(new lr(fi.UNIFORM|fi.TRANSFER_DST,mi.HOST|mi.DEVICE,sd.SIZE,sd.SIZE))}var e=t.prototype;return e.initialize=function(t){var e=c.director.root.device;this._transform=t.useLocalData,this._textureHash=t.textureHash,this._samplerHash=t.samplerHash,HZ.layout=t.passes[0].localSetLayout,this._descriptorSet=e.createDescriptorSet(HZ),this._descriptorSet.bindBuffer(sd.BINDING,this._localBuffer);var n=Gp.SAMPLER_SPRITE;this._descriptorSet.bindTexture(n,t.texture),this._descriptorSet.bindSampler(n,t.sampler),this._descriptorSet.update(),this._transformUpdate=!0},e.updateTransform=function(t){t!==this._transform&&(this._transform=t,this._transformUpdate=!0,this.uploadLocalData())},e.equals=function(t,e,n){return this._transform===t&&this._textureHash===e&&this._samplerHash===n},e.reset=function(){this._transform=null,this._textureHash=0,this._samplerHash=0},e.destroy=function(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null),this._localData=null},e.isValid=function(){return this._transform&&this._transform.isValid},e.uploadLocalData=function(){var t=this._transform;if((t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._transformUpdate=!0),this._transformUpdate){var e=t.worldMatrix;Un.toArray(this._localData,e,sd.MAT_WORLD_OFFSET),Un.inverseTranspose(jZ,e);var n=Un.determinant(jZ),i=1/Math.sqrt(n);Un.multiplyScalar(jZ,jZ,i),Un.toArray(this._localData,jZ,sd.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}},K(t,[{key:"descriptorSet",get:function(){return this._descriptorSet}}]),t}(),XZ=function(){function t(){this._descriptorSetCache=new Map,this._dsCacheHashByTexture=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new Vl((function(){return new qZ}),16,(function(t){return t.destroy()}))}var e=t.prototype;return e.getDescriptorSet=function(t){var e,n=c.director.root;if(t.useLocalData){for(var i=this._localDescriptorSetCache,r=0,o=i.length;r<o;r++){var a=i[r];if(a.equals(t.useLocalData,t.textureHash,t.samplerHash))return a.descriptorSet}var s=this._localCachePool.alloc();return s.initialize(t),this._localDescriptorSetCache.push(s),s.descriptorSet}if(e=t.textureHash^t.samplerHash,this._descriptorSetCache.has(e))return this._descriptorSetCache.get(e);HZ.layout=t.passes[0].localSetLayout;var l=n.device.createDescriptorSet(HZ),u=Gp.SAMPLER_SPRITE;return l.bindTexture(u,t.texture),l.bindSampler(u,t.sampler),l.update(),this._descriptorSetCache.set(e,l),this._dsCacheHashByTexture.set(t.textureHash,e),l},e.update=function(){var t=this._localDescriptorSetCache,e=[];t.forEach((function(n){if(n.isValid())n.uploadLocalData();else{n.reset();var i=t.indexOf(n);e.push(i)}}));for(var n=e.length-1;n>=0;n--)t.splice(e[n],1)},e.reset=function(){var t=this;this._localDescriptorSetCache.forEach((function(e){t._localCachePool.free(e)})),this._localDescriptorSetCache.length=0},e.releaseDescriptorSetCache=function(t){var e=this._dsCacheHashByTexture.get(t);e&&this._descriptorSetCache.has(e)&&(this._descriptorSetCache.get(e).destroy(),this._descriptorSetCache.delete(e),this._dsCacheHashByTexture.delete(t))},e.destroy=function(){this._descriptorSetCache.forEach((function(t){t.destroy()})),this._descriptorSetCache.clear(),this._dsCacheHashByTexture.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy()},t}();c.internal.Batcher2D=WZ,V(LZ.prototype,"MeshBuffer",["byteStart","vertexStart","indicesStart","request"].map((function(t){return{name:t,suggest:"please use meshBuffer.accessor."+t+" instead"}}))),z(LZ.prototype,"MeshBuffer",[{name:"indicesOffset",newName:"indexOffset"}]),G(LZ.prototype,"MeshBuffer",[{name:"vertexBuffers"},{name:"indexBuffer"}]),z(WZ.prototype,"Batcher2D",[{name:"currBufferBatch",newName:"currBufferAccessor"},{name:"acquireBufferBatch",newName:"switchBufferAccessor"}]),G(SH.prototype,"MeshRenderData",[{name:"formatByte"},{name:"byteStart"},{name:"byteCount"}]),z(SH.prototype,"MeshRenderData",[{name:"indicesStart",newName:"indexStart"}]),t("QuadRenderData",function(t){function e(e){var n;return n=t.call(this,e)||this,I(9006),n}return Q(e,t),e}(SH));var YZ,KZ,JZ=null,QZ=-1,ZZ="BES bswy:->@123丁ぁᄁ",$Z=Object.create(null),t$=[],e$=3e3;function n$(){for(var t=!0,e=Date.now(),n=t$.length-1;n>=0;n--){var i=t$[n],r=i.fontFamilyName;if(e-i.startTime>e$)I(4933,r),i.onComplete(null,r),t$.splice(n,1);else{var o=i.refWidth,a="40px "+r;JZ.font=a,o!==zk(JZ,ZZ,a)?(t$.splice(n,1),i.onComplete(null,r)):t=!1}}t&&(clearInterval(QZ),QZ=-1)}function i$(t,e,n){var i=function(t){var e=t.lastIndexOf(".ttf");if(-1===e)return t;var n,i=t.lastIndexOf("/");return-1!==(n=-1===i?t.substring(0,e)+"_LABEL":t.substring(i+1,e)+"_LABEL").indexOf(" ")&&(n='"'+n+'"'),n}(t);if($Z[i])n(null,i);else{if(!JZ){var r=document.createElement("canvas");r.width=100,r.height=100,JZ=r.getContext("2d")}var o=zk(JZ,ZZ,"40px "+i),a=document.createElement("style");a.type="text/css";var s="";Number.isNaN(i)?s+="@font-face { font-family:"+i+"; src:":s+='@font-face { font-family:"'+i+'"; src:',s+='url("'+t+'");',a.textContent=s+"}",document.body.appendChild(a);var c=document.createElement("div"),l=c.style;if(l.fontFamily=i,c.innerHTML=".",l.position="absolute",l.left="-100px",l.top="-100px",document.body.appendChild(c),function(){if(void 0===YZ)if("FontFace"in window){var t=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),e=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);YZ=t?parseInt(t[1],10)>42:!e}else YZ=!1;return YZ}())!function(t,e,n){var i=new Promise((function(n,i){!function r(){Date.now()-t>=e$?i():document.fonts.load("40px "+e).then((function(t){t.length>=1?n():setTimeout(r,100)}),(function(){i()}))}()})),r=null,o=new Promise((function(t,e){r=setTimeout(e,e$)}));Promise.race([o,i]).then((function(){r&&(clearTimeout(r),r=null),n(null,e)}),(function(){I(4933,e),n(null,e)}))}(Date.now(),i,n);else{var u={fontFamilyName:i,refWidth:o,onComplete:n,startTime:Date.now()};t$.push(u),-1===QZ&&(QZ=setInterval(n$,100))}$Z[i]=a}}function r$(t,e,n,i){var r=new xk;r._nativeUrl=t,r._nativeAsset=e,i(null,r)}PO.register({".font":i$,".eot":i$,".ttf":i$,".woff":i$,".svg":i$,".ttc":i$}),NO.register({".font":r$,".eot":r$,".ttf":r$,".woff":r$,".svg":r$,".ttc":r$}),c.UI={MeshBuffer:LZ,spriteAssembler:RZ,graphicsAssembler:RJ,labelAssembler:QQ,RenderData:xH,MeshRenderData:SH},function(t){t[t.positions=Xi.ATTR_POSITION]="positions",t[t.normals=Xi.ATTR_NORMAL]="normals",t[t.uvs=Xi.ATTR_TEX_COORD]="uvs",t[t.colors=Xi.ATTR_COLOR]="colors"}(KZ||(KZ={}));var o$,a$,s$,c$,l$,u$=function(){function t(){this._arrayBufferOrPaddings=[],this._length=0}var e=t.prototype;return e.setNextAlignment=function(t){if(0!==t){var e=this._length%t;if(0!==e){var n=t-e;this._arrayBufferOrPaddings.push(n),this._length+=n}}},e.addBuffer=function(t){var e=this._length;return this._arrayBufferOrPaddings.push(t),this._length+=t.byteLength,e},e.getLength=function(){return this._length},e.getCombined=function(){var t=new Uint8Array(this._length),e=0;return this._arrayBufferOrPaddings.forEach((function(n){"number"==typeof n?e+=n:(t.set(new Uint8Array(n),e),e+=n.byteLength)})),t.buffer},t}(),h$=function(){function t(t,e){if(this._mesh=void 0,this._subMeshRenderings=[],this._mesh=t,this._mesh.struct.morph){var n=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(n).fill(null);for(var i=0;i<n;++i){var r=this._mesh.struct.morph.subMeshMorphs[i];r&&(r.targets.length>vd.MAX_MORPH_TARGET_COUNT?this._subMeshRenderings[i]=new f$(this._mesh,i,this._mesh.struct.morph,e):this._subMeshRenderings[i]=new _$(this._mesh,i,this._mesh.struct.morph,e))}}}return t.prototype.createInstance=function(){for(var t=this,e=this._mesh.struct.primitives.length,n=new Array(e),i=0;i<e;++i){var r,o;n[i]=null!==(r=null===(o=this._subMeshRenderings[i])||void 0===o?void 0:o.createInstance())&&void 0!==r?r:null}return{setWeights:function(t,e){var i;null===(i=n[t])||void 0===i||i.setWeights(e)},requiredPatches:function(e){t._mesh.struct.morph;var i=t._mesh.struct.morph.subMeshMorphs[e],r=n[e];if(null===r)return null;var o=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:i.targets.length}];return i.attributes.includes(Xi.ATTR_POSITION)&&o.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),i.attributes.includes(Xi.ATTR_NORMAL)&&o.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),i.attributes.includes(Xi.ATTR_TANGENT)&&o.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),o.push.apply(o,r.requiredPatches()),o},adaptPipelineState:function(t,e){var i;null===(i=n[t])||void 0===i||i.adaptPipelineState(e)},destroy:function(){for(var t,e=ot(n);!(t=e()).done;){var i=t.value;null==i||i.destroy()}}}},t}(),_$=function(){function t(t,e,n,i){this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=i;var r=n.subMeshMorphs[e];this._subMeshMorph=r,v$(t,e,i);var o=t.struct.vertexBundles[t.struct.primitives[e].vertexBundelIndices[0]].view.count;this._verticesCount=o;var a=r.targets.length,s=m$(i,o*a);this._textureInfo={width:s.width,height:s.height},this._attributes=r.attributes.map((function(e,n){var i=s.create(),a=i.valueView;return r.targets.forEach((function(e,i){for(var r=e.displacements[n],s=new Float32Array(t.data.buffer,t.data.byteOffset+r.offset,r.count),c=o*i*4,l=0;l<o;++l)a[c+4*l+0]=s[3*l+0],a[c+4*l+1]=s[3*l+1],a[c+4*l+2]=s[3*l+2]})),i.updatePixels(),{name:e,morphTexture:i}}))}var e=t.prototype;return e.destroy=function(){for(var t,e=ot(this._attributes);!(t=e()).done;)t.value.morphTexture.destroy()},e.createInstance=function(){var t=this,e=new d$(this._gfxDevice,this._subMeshMorph.targets.length);return e.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),e.setVerticesCount(this._verticesCount),e.commit(),{setWeights:function(t){e.setWeights(t),e.commit()},requiredPatches:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}]},adaptPipelineState:function(n){for(var i,r=ot(t._attributes);!(i=r()).done;){var o=i.value,a=void 0;switch(o.name){case Xi.ATTR_POSITION:a=Cd;break;case Xi.ATTR_NORMAL:a=Td;break;case Xi.ATTR_TANGENT:a=Pd;break;default:y("Unexpected attribute!")}void 0!==a&&(n.bindSampler(a,o.morphTexture.sampler),n.bindTexture(a,o.morphTexture.texture))}n.bindBuffer(vd.BINDING,e.buffer),n.update()},destroy:function(){}}},t}(),f$=function(){function t(t,e,n,i){this._gfxDevice=void 0,this._attributes=[],this._gfxDevice=i;var r=n.subMeshMorphs[e];v$(t,e,i),this._attributes=r.attributes.map((function(e,n){return{name:e,targets:r.targets.map((function(e){return{displacements:new Float32Array(t.data.buffer,t.data.byteOffset+e.displacements[n].offset,e.displacements[n].count)}}))}}))}return t.prototype.createInstance=function(){return new p$(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)},K(t,[{key:"data",get:function(){return this._attributes}}]),t}(),p$=function(){function t(t,e,n){this._attributes=void 0,this._owner=void 0,this._morphUniforms=void 0,this._owner=t,this._morphUniforms=new d$(n,0);var i=m$(n,e);this._morphUniforms.setMorphTextureInfo(i.width,i.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map((function(t){var e=i.create();return{attributeName:t.name,morphTexture:e}}))}var e=t.prototype;return e.setWeights=function(t){for(var e=0;e<this._attributes.length;++e){var n=this._attributes[e],i=n.morphTexture.valueView,r=this._owner.data[e];t.length,r.targets.length;for(var o=0;o<r.targets.length;++o){var a=r.targets[o].displacements,s=t[o],c=a.length/3;if(0===o)for(var l=0;l<c;++l)i[4*l+0]=a[3*l+0]*s,i[4*l+1]=a[3*l+1]*s,i[4*l+2]=a[3*l+2]*s;else if(0!==s)for(var u=0;u<c;++u)i[4*u+0]+=a[3*u+0]*s,i[4*u+1]+=a[3*u+1]*s,i[4*u+2]+=a[3*u+2]*s}n.morphTexture.updatePixels()}},e.requiredPatches=function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]},e.adaptPipelineState=function(t){for(var e,n=ot(this._attributes);!(e=n()).done;){var i=e.value,r=void 0;switch(i.attributeName){case Xi.ATTR_POSITION:r=Cd;break;case Xi.ATTR_NORMAL:r=Td;break;case Xi.ATTR_TANGENT:r=Pd;break;default:y("Unexpected attribute!")}void 0!==r&&(t.bindSampler(r,i.morphTexture.sampler),t.bindTexture(r,i.morphTexture.texture))}t.bindBuffer(vd.BINDING,this._morphUniforms.buffer),t.update()},e.destroy=function(){this._morphUniforms.destroy();for(var t=0;t<this._attributes.length;++t)this._attributes[t].morphTexture.destroy()},t}(),d$=function(){function t(t,e){this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=e,this._localBuffer=new DataView(new ArrayBuffer(vd.SIZE)),this._remoteBuffer=t.createBuffer(new lr(fi.UNIFORM|fi.TRANSFER_DST,mi.HOST|mi.DEVICE,vd.SIZE,vd.SIZE))}var e=t.prototype;return e.destroy=function(){this._remoteBuffer.destroy()},e.setWeights=function(t){t.length,this._targetCount;for(var e=0;e<t.length;++e)this._localBuffer.setFloat32(vd.OFFSET_OF_WEIGHTS+4*e,t[e],c.sys.isLittleEndian)},e.setMorphTextureInfo=function(t,e){this._localBuffer.setFloat32(vd.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,t,c.sys.isLittleEndian),this._localBuffer.setFloat32(vd.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,e,c.sys.isLittleEndian)},e.setVerticesCount=function(t){this._localBuffer.setFloat32(vd.OFFSET_OF_VERTICES_COUNT,t,c.sys.isLittleEndian)},e.commit=function(){this._remoteBuffer.update(this._localBuffer.buffer)},K(t,[{key:"buffer",get:function(){return this._remoteBuffer}}]),t}();function m$(t,e){var i,o,a,s;t.hasFeature(li.TEXTURE_FLOAT)?(i=e,a=16,o=gv.PixelFormat.RGBA32F,s=Float32Array):(i=4*e,a=4,o=gv.PixelFormat.RGBA8888,s=Uint8Array);var c=function(t){t<5&&(t=5);var e=n(r(t)),i=e>>1;return{width:1<<(1&e?i+1:i),height:1<<i}}(i),l=c.width,u=c.height;return{width:l,height:u,create:function(){var e=new ArrayBuffer(l*u*a),n=new Float32Array(e),i=s===Float32Array?n:new s(e),r=new Km({width:l,height:u,_data:i,_compressed:!1,format:o}),c=new gv;c.setFilters(gv.Filter.NEAREST,gv.Filter.NEAREST),c.setMipFilter(gv.Filter.NONE),c.setWrapMode(gv.WrapMode.CLAMP_TO_EDGE,gv.WrapMode.CLAMP_TO_EDGE,gv.WrapMode.CLAMP_TO_EDGE),c.image=r,c.getGFXTexture()||y("Unexpected: failed to create morph texture?");var h=t.getSampler(c.getSamplerInfo());return{get texture(){return c.getGFXTexture()},get sampler(){return h},get valueView(){return n},destroy:function(){c.destroy()},updatePixels:function(){c.uploadData(i)}}}}}function v$(t,e,n){t.renderingSubMeshes[e].enableVertexIdChannel(n)}function g$(t){switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}}var y$=new En,x$=new En,S$=new Uint8Array,C$=t("Mesh",hc("cc.Mesh")((l$=function(t){function e(){var e;return(e=t.call(this)||this).morphRendering=null,at(e,"_struct",s$,it(e)),at(e,"_hash",c$,it(e)),e._data=S$,e._initialized=!1,e._renderingSubMeshes=null,e._boneSpaceBounds=new Map,e._jointBufferIndices=null,e}Q(e,t);var n=e.prototype;return n.onLoaded=function(){this.initialize()},n.initialize=function(){if(!this._initialized){this._initialized=!0;for(var t=this._data.buffer,e=c.director.root.device,n=this._createVertexBuffers(e,t),i=[],r=0;r<this._struct.primitives.length;r++){var o=this._struct.primitives[r];if(0!==o.vertexBundelIndices.length){var a=null,s=null;if(o.indexView){var l=o.indexView,u=l.stride,h=l.length;if(4===u&&!e.hasFeature(li.ELEMENT_INDEX_UINT)){var _=this._struct.vertexBundles[o.vertexBundelIndices[0]].view.count;if(_>=65536){I(10001,_,65536);continue}u>>=1,h>>=1}a=e.createBuffer(new lr(fi.INDEX,mi.DEVICE,h,u)),s=new(g$(l.stride))(t,l.offset,l.count),l.stride!==u&&(s=g$(u).from(s)),a.update(s)}var f=o.vertexBundelIndices.map((function(t){return n[t]})),p=[];if(o.vertexBundelIndices.length>0)for(var d=o.vertexBundelIndices[0],m=this._struct.vertexBundles[d].attributes,v=0;v<m.length;++v){var g=m[v];p[v]=new Er(g.name,g.format,g.isNormalized,g.stream,g.isInstanced,g.location)}var y=new LE(f,p,o.primitiveMode,a);y.mesh=this,y.subMeshIdx=r,i.push(y)}}this._renderingSubMeshes=i,this._struct.morph&&(this.morphRendering=function(t,e){return new h$(t,e)}(this,e))}},n.destroy=function(){return this.destroyRenderingMesh(),t.prototype.destroy.call(this)},n.destroyRenderingMesh=function(){if(this._renderingSubMeshes){for(var t=0;t<this._renderingSubMeshes.length;t++)this._renderingSubMeshes[t].destroy();this._renderingSubMeshes=null,this._initialized=!1}},n.assign=function(t,e){this.reset({struct:t,data:e})},n.reset=function(t){this.destroyRenderingMesh(),this._struct=t.struct,this._data=t.data,this._hash=0},n.getBoneSpaceBounds=function(t){if(this._boneSpaceBounds.has(t.hash))return this._boneSpaceBounds.get(t.hash);var e=[];this._boneSpaceBounds.set(t.hash,e);for(var n=[],i=t.bindposes,r=0;r<i.length;r++)e.push(new ks(1/0,1/0,1/0,-1/0,-1/0,-1/0)),n.push(!1);for(var o=this._struct.primitives,a=0;a<o.length;a++){var s=this.readAttribute(a,Xi.ATTR_JOINTS),c=this.readAttribute(a,Xi.ATTR_WEIGHTS),l=this.readAttribute(a,Xi.ATTR_POSITION);if(s&&c&&l)for(var u=Math.min(s.length/4,c.length/4,l.length/3),h=0;h<u;h++){En.set(y$,l[3*h+0],l[3*h+1],l[3*h+2]);for(var _=0;_<4;++_){var f=4*h+_,p=s[f];if(!(0===c[f]||p>=i.length)){En.transformMat4(x$,y$,i[p]),n[p]=!0;var d=e[p];En.min(d.center,d.center,x$),En.max(d.halfExtents,d.halfExtents,x$)}}}}for(var m=0;m<i.length;m++){var v=e[m];n[m]?ks.fromPoints(v,v.center,v.halfExtents):e[m]=null}return e},n.merge=function(t,e,n){if(n&&!this.validateMergingMesh(t))return!1;var i=new En,r=e&&new Mn,o=e&&new ks;if(r&&e.getRotation(r),!this._initialized){var a=JSON.parse(JSON.stringify(t._struct)),s=t._data.slice();if(e){a.maxPosition&&a.minPosition&&(En.add(o.center,a.maxPosition,a.minPosition),En.multiplyScalar(o.center,o.center,.5),En.subtract(o.halfExtents,a.maxPosition,a.minPosition),En.multiplyScalar(o.halfExtents,o.halfExtents,.5),ks.transform(o,o,e),En.add(a.maxPosition,o.center,o.halfExtents),En.subtract(a.minPosition,o.center,o.halfExtents));for(var c=0;c<a.vertexBundles.length;c++)for(var l=a.vertexBundles[c],u=0;u<l.attributes.length;u++)if(l.attributes[u].name===Xi.ATTR_POSITION||l.attributes[u].name===Xi.ATTR_NORMAL){var h=l.attributes[u].format,_=new DataView(s.buffer,l.view.offset+A$(l.attributes,u)),f=E$(_,h),p=w$(_,h);if(!f||!p)continue;for(var d=l.view.count,m=l.view.stride,v=T$(h),g=0;g<d;g++){var y=g*m,x=y+v,S=x+v;switch(i.set(f(y),f(x),f(S)),l.attributes[u].name){case Xi.ATTR_POSITION:i.transformMat4(e);break;case Xi.ATTR_NORMAL:En.transformQuat(i,i,r)}p(y,i.x),p(x,i.y),p(S,i.z)}}}return this.reset({struct:a,data:s}),this.initialize(),!0}for(var C,A,b,T,E,w=new u$,P=0,I=0,R=0,D=0,B=0,M=0,O=0,N=0,L=!1,F=new Array(this._struct.vertexBundles.length),z=0;z<this._struct.vertexBundles.length;++z){var G=this._struct.vertexBundles[z],V=t._struct.vertexBundles[z];R=G.view.offset,D=V.view.offset,I=G.view.stride,P=G.view.count+V.view.count,C=new ArrayBuffer(P*I),A=new Uint8Array(C),R+=(b=this._data.subarray(R,R+G.view.length)).length,D+=(T=t._data.subarray(D,D+V.view.length)).length,A.set(b),B=0;for(var U,k=ot(G.attributes);!(U=k()).done;){var H=U.value;O=0,L=!1;for(var j,W=ot(V.attributes);!(j=W()).done;){var q=j.value;if(H.name===q.name&&H.format===q.format){L=!0;break}O+=Jr[q.format].size}if(L){N=Jr[H.format].size,M=G.view.length+B;for(var X=0;X<V.view.count;++X){if(E=T.subarray(O,O+N),A.set(E,M),(H.name===Xi.ATTR_POSITION||H.name===Xi.ATTR_NORMAL)&&e){var Y=new Float32Array(A.buffer,M,3);switch(i.set(Y[0],Y[1],Y[2]),H.name){case Xi.ATTR_POSITION:i.transformMat4(e);break;case Xi.ATTR_NORMAL:En.transformQuat(i,i,r)}Y[0]=i.x,Y[1]=i.y,Y[2]=i.z}M+=G.view.stride,O+=V.view.stride}}B+=Jr[H.format].size}F[z]={attributes:G.attributes,view:{offset:w.getLength(),length:C.byteLength,count:P,stride:I}},w.addBuffer(C)}for(var K,J,Q,Z=0,$=2,tt=0,et=new Array(this._struct.primitives.length),nt=0;nt<this._struct.primitives.length;++nt){var it=this._struct.primitives[nt],rt=t._struct.primitives[nt];et[nt]={primitiveMode:it.primitiveMode,vertexBundelIndices:it.vertexBundelIndices};for(var at,st=ot(it.vertexBundelIndices);!(at=st()).done;){var ct=at.value;tt=Math.max(tt,this._struct.vertexBundles[ct].view.count)}if(it.indexView&&rt.indexView){Z=it.indexView.count,Z+=rt.indexView.count,R=it.indexView.offset,D=rt.indexView.offset,$=Z<256?1:Z<65536?2:4;var lt=new ArrayBuffer(Z*$);if(K=2===$?new Uint16Array(lt):1===$?new Uint8Array(lt):new Uint32Array(lt),J=2===it.indexView.stride?new Uint16Array(this._data.buffer,R,it.indexView.count):1===it.indexView.stride?new Uint8Array(this._data.buffer,R,it.indexView.count):new Uint32Array(this._data.buffer,R,it.indexView.count),$===it.indexView.stride)K.set(J);else for(var ut=0;ut<it.indexView.count;++ut)K[ut]=J[ut];R+=it.indexView.length,Q=2===rt.indexView.stride?new Uint16Array(t._data.buffer,D,rt.indexView.count):1===rt.indexView.stride?new Uint8Array(t._data.buffer,D,rt.indexView.count):new Uint32Array(t._data.buffer,D,rt.indexView.count);for(var ht=0;ht<rt.indexView.count;++ht)K[it.indexView.count+ht]=tt+Q[ht];D+=rt.indexView.length,et[nt].indexView={offset:w.getLength(),length:lt.byteLength,count:Z,stride:$},w.setNextAlignment($),w.addBuffer(lt)}}var _t={vertexBundles:F,primitives:et,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return _t.minPosition&&t._struct.minPosition&&_t.maxPosition&&t._struct.maxPosition&&(e?(En.add(o.center,t._struct.maxPosition,t._struct.minPosition),En.multiplyScalar(o.center,o.center,.5),En.subtract(o.halfExtents,t._struct.maxPosition,t._struct.minPosition),En.multiplyScalar(o.halfExtents,o.halfExtents,.5),ks.transform(o,o,e),En.add(i,o.center,o.halfExtents),En.max(_t.maxPosition,_t.maxPosition,i),En.subtract(i,o.center,o.halfExtents),En.min(_t.minPosition,_t.minPosition,i)):(En.min(_t.minPosition,_t.minPosition,t._struct.minPosition),En.max(_t.maxPosition,_t.maxPosition,t._struct.maxPosition))),this.reset({struct:_t,data:new Uint8Array(w.getCombined())}),this.initialize(),!0},n.validateMergingMesh=function(t){if(this._struct.vertexBundles.length!==t._struct.vertexBundles.length)return!1;for(var e=0;e<this._struct.vertexBundles.length;++e){var n=this._struct.vertexBundles[e],i=t._struct.vertexBundles[e];if(n.attributes.length!==i.attributes.length)return!1;for(var r=0;r<n.attributes.length;++r)if(n.attributes[r].format!==i.attributes[r].format)return!1}if(this._struct.primitives.length!==t._struct.primitives.length)return!1;for(var o=0;o<this._struct.primitives.length;++o){var a=this._struct.primitives[o],s=t._struct.primitives[o];if(a.vertexBundelIndices.length!==s.vertexBundelIndices.length)return!1;for(var c=0;c<a.vertexBundelIndices.length;++c)if(a.vertexBundelIndices[c]!==s.vertexBundelIndices[c])return!1;if(a.primitiveMode!==s.primitiveMode)return!1;if(a.indexView){if(void 0===s.indexView)return!1}else if(s.indexView)return!1}return!0},n.readAttribute=function(t,e){var n=this,i=null;return this._accessAttribute(t,e,(function(t,e){var r=t.view.count,o=t.attributes[e].format,a=oo(Jr[o]);if(0!==r){var s=new DataView(n._data.buffer,t.view.offset+A$(t.attributes,e)),c=Jr[o],l=E$(s,o);if(a&&l){for(var u=c.count,h=new a(r*u),_=t.view.stride,f=0;f<r;++f)for(var p=0;p<u;++p)h[u*f+p]=l(_*f+h.BYTES_PER_ELEMENT*p);i=h}}})),i},n.copyAttribute=function(t,e,n,i,r){var o=this,a=!1;return this._accessAttribute(t,e,(function(t,e){var s=t.view.count;if(0!==s){var c=t.attributes[e].format,l=new DataView(o._data.buffer,t.view.offset+A$(t.attributes,e)),u=new DataView(n,r),h=Jr[c],_=E$(l,c),f=w$(u,c);if(_&&f){for(var p=h.count,d=t.view.stride,m=T$(c),v=i,g=m,y=0;y<s;++y)for(var x=0;x<p;++x)f(v*y+g*x,_(d*y+m*x));a=!0}}else a=!0})),a},n.readIndices=function(t){if(t>=this._struct.primitives.length)return null;var e=this._struct.primitives[t];if(!e.indexView)return null;var n=e.indexView.stride;return new(1===n?Uint8Array:2===n?Uint16Array:Uint32Array)(this._data.buffer,e.indexView.offset,e.indexView.count)},n.copyIndices=function(t,e){if(t>=this._struct.primitives.length)return!1;var n=this._struct.primitives[t];if(!n.indexView)return!1;for(var i=n.indexView.count,r=1===n.indexView.stride?ui.R8UI:2===n.indexView.stride?ui.R16UI:ui.R32UI,o=E$(new DataView(this._data.buffer),r),a=0;a<i;++a)e[a]=o(n.indexView.offset+Jr[r].size*a);return!0},n._accessAttribute=function(t,e,n){if(!(t>=this._struct.primitives.length))for(var i,r=ot(this._struct.primitives[t].vertexBundelIndices);!(i=r()).done;){var o=i.value,a=this._struct.vertexBundles[o],s=a.attributes.findIndex((function(t){return t.name===e}));if(!(s<0)){n(a,s);break}}},n._createVertexBuffers=function(t,e){return this._struct.vertexBundles.map((function(n){var i=t.createBuffer(new lr(fi.VERTEX,mi.DEVICE,n.view.length,n.view.stride)),r=new Uint8Array(e,n.view.offset,n.view.length);return i.update(r),i}))},n.initDefault=function(e){t.prototype.initDefault.call(this,e),this.reset({struct:{vertexBundles:[],primitives:[]},data:S$})},K(e,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(t){this._data=new Uint8Array(t)}},{key:"subMeshCount",get:function(){var t=this.renderingSubMeshes;return t?t.length:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return this._hash||(this._hash=po(this._data,666)),this._hash}},{key:"jointBufferIndices",get:function(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((function(t){return t.jointMapIndex||0}))}},{key:"renderingSubMeshes",get:function(){return this.initialize(),this._renderingSubMeshes}}]),e}(Pu),s$=st((a$=l$).prototype,"_struct",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),c$=st(a$.prototype,"_hash",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),o$=a$))||o$);function A$(t,e){for(var n=0,i=0;i<e;++i){var r=t[i];n+=Jr[r.format].size}return n}c.Mesh=C$;var b$=oh.isLittleEndian;function T$(t){var e=Jr[t];return e.size/e.count}function E$(t,e){var n=Jr[e],i=n.size/n.count;switch(n.type){case hi.UNORM:switch(i){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,b$)};case 4:return function(e){return t.getUint32(e,b$)}}break;case hi.SNORM:case hi.INT:switch(i){case 1:return function(e){return t.getInt8(e)};case 2:return function(e){return t.getInt16(e,b$)};case 4:return function(e){return t.getInt32(e,b$)}}break;case hi.UINT:switch(i){case 1:return function(e){return t.getUint8(e)};case 2:return function(e){return t.getUint16(e,b$)};case 4:return function(e){return t.getUint32(e,b$)}}break;case hi.FLOAT:return function(e){return t.getFloat32(e,b$)}}return null}function w$(t,e){var n=Jr[e],i=n.size/n.count;switch(n.type){case hi.UNORM:switch(i){case 1:return function(e,n){return t.setUint8(e,n)};case 2:return function(e,n){return t.setUint16(e,n,b$)};case 4:return function(e,n){return t.setUint32(e,n,b$)}}break;case hi.SNORM:case hi.INT:switch(i){case 1:return function(e,n){return t.setInt8(e,n)};case 2:return function(e,n){return t.setInt16(e,n,b$)};case 4:return function(e,n){return t.setInt32(e,n,b$)}}break;case hi.UINT:switch(i){case 1:return function(e,n){return t.setUint8(e,n)};case 2:return function(e,n){return t.setUint16(e,n,b$)};case 4:return function(e,n){return t.setUint32(e,n,b$)}}break;case hi.FLOAT:return function(e,n){return t.setFloat32(e,n,b$)}}return null}var P$=[new Er(Xi.ATTR_POSITION,ui.RGB32F),new Er(Xi.ATTR_NORMAL,ui.RGB32F),new Er(Xi.ATTR_TEX_COORD,ui.RG32F),new Er(Xi.ATTR_TANGENT,ui.RGBA32F),new Er(Xi.ATTR_COLOR,ui.RGBA32F)],I$=new En;function R$(t,e,n){n=n||{};var i,r=[],o=0,a=[],s=0,c=t.positions.slice();if(c.length>0){if(i=null,t.attributes)for(var l,u=ot(t.attributes);!(l=u()).done;){var h=l.value;if(h.name===Xi.ATTR_POSITION){i=h;break}}i||(i=P$[0]),r.push(i);var _=Jr[i.format];s=Math.max(s,Math.floor(c.length/_.count)),a.push({offset:o,data:c,attribute:i}),o+=_.size}if(t.normals&&t.normals.length>0){if(i=null,t.attributes)for(var f,p=ot(t.attributes);!(f=p()).done;){var d=f.value;if(d.name===Xi.ATTR_NORMAL){i=d;break}}i||(i=P$[1]);var m=Jr[i.format];r.push(i),s=Math.max(s,Math.floor(t.normals.length/m.count)),a.push({offset:o,data:t.normals,attribute:i}),o+=m.size}if(t.uvs&&t.uvs.length>0){if(i=null,t.attributes)for(var v,g=ot(t.attributes);!(v=g()).done;){var y=v.value;if(y.name===Xi.ATTR_TEX_COORD){i=y;break}}i||(i=P$[2]);var x=Jr[i.format];r.push(i),s=Math.max(s,Math.floor(t.uvs.length/x.count)),a.push({offset:o,data:t.uvs,attribute:i}),o+=x.size}if(t.tangents&&t.tangents.length>0){if(i=null,t.attributes)for(var S,C=ot(t.attributes);!(S=C()).done;){var A=S.value;if(A.name===Xi.ATTR_TANGENT){i=A;break}}i||(i=P$[3]);var b=Jr[i.format];r.push(i),s=Math.max(s,Math.floor(t.tangents.length/b.count)),a.push({offset:o,data:t.tangents,attribute:i}),o+=b.size}if(t.colors&&t.colors.length>0){if(i=null,t.attributes)for(var T,E=ot(t.attributes);!(T=E()).done;){var w=T.value;if(w.name===Xi.ATTR_COLOR){i=w;break}}i||(i=P$[4]);var P=Jr[i.format];r.push(i),s=Math.max(s,Math.floor(t.colors.length/P.count)),a.push({offset:o,data:t.colors,attribute:i}),o+=P.size}if(t.customAttributes)for(var I,R=ot(t.customAttributes);!(I=R()).done;){var D=I.value,B=Jr[D.attr.format];r.push(D.attr),s=Math.max(s,Math.floor(D.values.length/B.count)),a.push({offset:o,data:D.values,attribute:D.attr}),o+=B.size}for(var M=new u$,O=new ArrayBuffer(s*o),N=new DataView(O),L=0,F=a;L<F.length;L++){var z=F[L];DE(N,z.data,z.attribute.format,z.offset,o)}M.setNextAlignment(0);var G={attributes:r,view:{offset:M.getLength(),length:O.byteLength,count:s,stride:o}};M.addBuffer(O);var V=null,U=0;if(t.indices){var k=t.indices;U=k.length,V=new ArrayBuffer(2*U),DE(new DataView(V),k,ui.R16UI)}var H={primitiveMode:t.primitiveMode||Ni.TRIANGLE_LIST,vertexBundelIndices:[0]};V&&(M.setNextAlignment(2),H.indexView={offset:M.getLength(),length:V.byteLength,count:U,stride:2},M.addBuffer(V));var j=t.minPos;if(!j&&n.calculateBounds){j=En.set(new En,1/0,1/0,1/0);for(var W=0;W<s;++W)En.set(I$,c[3*W+0],c[3*W+1],c[3*W+2]),En.min(j,j,I$)}var q=t.maxPos;if(!q&&n.calculateBounds){q=En.set(new En,-1/0,-1/0,-1/0);for(var X=0;X<s;++X)En.set(I$,c[3*X+0],c[3*X+1],c[3*X+2]),En.max(q,q,I$)}var Y={vertexBundles:[G],primitives:[H]};return j&&(Y.minPosition=new En(j.x,j.y,j.z)),q&&(Y.maxPosition=new En(q.x,q.y,q.z)),e||(e=new C$),e.reset({struct:Y,data:new Uint8Array(M.getCombined())}),e}var D$=Object.freeze({__proto__:null,find:vD,toPPM:function(t,e,n){return"P3 "+e+" "+n+" 255\n"+t.filter((function(t,e){return e%4<3})).toString()+"\n"},readMesh:function(t,e){void 0===e&&(e=0);for(var n,i={positions:[]},r=new DataView(t.data.buffer,t.data.byteOffset,t.data.byteLength),o=t.struct,a=o.primitives[e],s=ot(a.vertexBundelIndices);!(n=s()).done;)for(var c,l=n.value,u=o.vertexBundles[l],h=u.view.offset,_=u.view,f=_.length,p=_.stride,d=ot(u.attributes);!(c=d()).done;){var m=c.value,v=KZ[m.name];v&&(i[v]=(i[v]||[]).concat(BE(r,m.format,h,f,p))),h+=Jr[m.format].size}var g=a.indexView;return i.indices=BE(r,ui["R"+8*g.stride+"UI"],g.offset,g.length),i},createMesh:R$,readBuffer:BE,writeBuffer:DE,mapBuffer:ME});t("utils",D$);var B$,M$,O$,N$,L$,F$,z$,G$,V$,U$,k$,H$,j$,W$,q$,X$,Y$,K$,J$,Q$,Z$,$$,t0,e0,n0,i0,r0,o0,a0,s0,c0,l0,u0,h0,_0,f0,p0,d0,m0,v0,g0=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._morphRenderingInstance=null,e._usedMaterials=new Set,e}Q(e,t);var n=e.prototype;return n.getMacroPatches=function(e){return this._morphRenderingInstance?this._morphRenderingInstance.requiredPatches(e):t.prototype.getMacroPatches.call(this,e)},n.initSubModel=function(e,n,i){return t.prototype.initSubModel.call(this,e,n,this._launderMaterial(i))},n.destroy=function(){t.prototype.destroy.call(this),this._morphRenderingInstance=null},n.setSubModelMaterial=function(e,n){return t.prototype.setSubModelMaterial.call(this,e,this._launderMaterial(n))},n._updateLocalDescriptors=function(e,n){t.prototype._updateLocalDescriptors.call(this,e,n),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(e,n)},n._launderMaterial=function(t){return t},n.setMorphRendering=function(t){this._morphRenderingInstance=t},e}(iC),y0=ie({OFF:0,ON:1}),x0=ie({OFF:0,ON:1}),S0=(B$=hc("cc.ModelLightmapSettings"),M$=gc("_recieveShadow"),B$((k$=function(){function t(){at(this,"texture",L$,this),at(this,"uvParam",F$,this),at(this,"_bakeable",z$,this),at(this,"_castShadow",G$,this),at(this,"_receiveShadow",V$,this),at(this,"_lightmapSize",U$,this)}return K(t,[{key:"bakeable",get:function(){return this._bakeable},set:function(t){this._bakeable=t}},{key:"castShadow",get:function(){return this._castShadow},set:function(t){this._castShadow=t}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(t){this._receiveShadow=t}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(t){this._lightmapSize=t}}]),t}(),L$=st((N$=k$).prototype,"texture",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),F$=st(N$.prototype,"uvParam",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn}}),z$=st(N$.prototype,"_bakeable",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),G$=st(N$.prototype,"_castShadow",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),V$=st(N$.prototype,"_receiveShadow",[M$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),U$=st(N$.prototype,"_lightmapSize",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),st(N$.prototype,"bakeable",[Pc],Object.getOwnPropertyDescriptor(N$.prototype,"bakeable"),N$.prototype),st(N$.prototype,"castShadow",[Pc],Object.getOwnPropertyDescriptor(N$.prototype,"castShadow"),N$.prototype),st(N$.prototype,"receiveShadow",[Pc],Object.getOwnPropertyDescriptor(N$.prototype,"receiveShadow"),N$.prototype),st(N$.prototype,"lightmapSize",[Pc],Object.getOwnPropertyDescriptor(N$.prototype,"lightmapSize"),N$.prototype),O$=N$))||O$),C0=function(e){return t({MeshRenderer:e,ModelComponent:e}),e}((H$=hc("cc.MeshRenderer"),j$=wc(),W$=fc(100),q$=Ac(),X$=Wc(y0),Y$=Bc(),K$=Wc(x0),J$=Bc(),Q$=Wc(C$),Z$=Bc(),$$=Ic(),H$(t0=j$(t0=W$(t0=q$(t0=Cc((c0=s0=function(t){function e(){var e;return at(e=t.call(this)||this,"lightmapSettings",n0,it(e)),at(e,"_mesh",i0,it(e)),at(e,"_shadowCastingMode",r0,it(e)),at(e,"_shadowReceivingMode",o0,it(e)),e._subMeshShapesWeights=[],e._modelType=void 0,e._model=null,e._morphInstance=null,at(e,"_enableMorph",a0,it(e)),e._modelType=iC,e}Q(e,t);var n=e.prototype;return n.onLoad=function(){this._mesh&&this._mesh.initialize(),this._validateShapeWeights()||this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},n.onRestore=function(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},n.onEnable=function(){this._model||this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._attachToScene()},n.onDisable=function(){this._model&&this._detachFromScene()},n.onDestroy=function(){this._model&&(c.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()},n.getWeight=function(t,e){this._subMeshShapesWeights.length;var n=this._subMeshShapesWeights[t];return n.length,n[e]},n.setWeights=function(t,e){var n=this._subMeshShapesWeights;e>=n.length||n[e].length===t.length&&(n[e]=t.slice(0),this._uploadSubMeshShapesWeights(e))},n.setWeight=function(t,e,n){var i=this._subMeshShapesWeights;if(!(e>=i.length)){var r=i[e];n>=r.length||(r[n]=t,this._uploadSubMeshShapesWeights(e))}},n.setInstancedAttribute=function(t,e){if(this.model)for(var n=this.model.instancedAttributes,i=n.attributes,r=n.views,o=0;o<i.length;o++)if(i[o].name===t){r[o].set(e);break}},n._updateLightmap=function(t,e,n,i,r){this.lightmapSettings.texture=t,this.lightmapSettings.uvParam.x=e,this.lightmapSettings.uvParam.y=n,this.lightmapSettings.uvParam.z=i,this.lightmapSettings.uvParam.w=r,this._onUpdateLightingmap()},n._updateModels=function(){if(this.enabledInHierarchy&&this._mesh){var t=this._model;t?(t.destroy(),t.initialize(),t.node=t.transform=this.node):this._createModel(),this._model&&(this._model.createBoundingShape(this._mesh.struct.minPosition,this._mesh.struct.maxPosition),this._updateModelParams(),this._onUpdateLightingmap())}},n._createModel=function(){var t=this._morphInstance&&this._modelType===iC?g0:this._modelType,e=this._model=c.director.root.createModel(t);e.visFlags=this.visibility,e.node=e.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&e instanceof g0&&e.setMorphRendering(this._morphInstance)},n._attachToScene=function(){if(this.node.scene&&this._model){var t=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),t.addModel(this._model)}},n._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},n._updateModelParams=function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=Zg.POSITION,this._model.transform.hasChangedFlags|=Zg.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var t=this._mesh?this._mesh.renderingSubMeshes.length:0,e=this._mesh.renderingSubMeshes;if(e)for(var n=0;n<t;++n){var i=this.getRenderMaterial(n);i&&!i.isValid&&(i=null);var r=e[n];r&&this._model.initSubModel(n,r,i||this._getBuiltinMaterial())}this._model.enabled=!0}},n._onUpdateLightingmap=function(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])},n._onMaterialModified=function(t,e){this._model&&this._model.inited&&this._onRebuildPSO(t,e||this._getBuiltinMaterial())},n._onRebuildPSO=function(t,e){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(t,e),this._onUpdateLightingmap())},n._onMeshChanged=function(){},n._clearMaterials=function(){if(this._model)for(var t=this._model.subModels,e=0;e<t.length;++e)this._onMaterialModified(e,null)},n._getBuiltinMaterial=function(){return wv.get("missing-material")},n._onVisibilityChange=function(t){this._model&&(this._model.visFlags=t)},n._updateCastShadow=function(){this._model&&(this._shadowCastingMode===y0.OFF?this._model.castShadow=!1:(this._shadowCastingMode,y0.ON,this._shadowCastingMode,this._model.castShadow=!0))},n._updateReceiveShadow=function(){this._model&&(this._shadowReceivingMode===x0.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)},n._isBatchingEnabled=function(){for(var t=0;t<this._materials.length;++t){var e=this._materials[t];if(e)for(var n=0;n<e.passes.length;++n)if(e.passes[n].batchingScheme)return!0}return!1},n._watchMorphInMesh=function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){this._morphInstance=this._mesh.morphRendering.createInstance();for(var t=this._mesh.struct.primitives.length,e=0;e<t;++e)this._uploadSubMeshShapesWeights(e);this._model&&this._model instanceof g0&&this._model.setMorphRendering(this._morphInstance)}},n._initSubMeshShapesWeights=function(){var t=this._mesh;if(this._subMeshShapesWeights.length=0,t){var e=t.struct.morph;if(e){var n=e.weights;this._subMeshShapesWeights=e.subMeshMorphs.map((function(t){return t?t.weights?t.weights.slice(0):n?(n.length,t.targets.length,n.slice(0)):new Array(t.targets.length).fill(0):[]}))}}},n._validateShapeWeights=function(){var t=this._mesh,e=this._subMeshShapesWeights;if(!t||!t.struct.morph)return 0===e.length;var n=t.struct.morph;return n.subMeshMorphs.length===e.length&&e.every((function(t,e){var i,r,o=t.length;return(null!==(i=null===(r=n.subMeshMorphs[e])||void 0===r?void 0:r.targets.length)&&void 0!==i?i:0)===o}))},n._uploadSubMeshShapesWeights=function(t){var e;null===(e=this._morphInstance)||void 0===e||e.setWeights(t,this._subMeshShapesWeights[t])},K(e,[{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(t){this._shadowCastingMode=t,this._updateCastShadow()}},{key:"receiveShadow",get:function(){return this._shadowReceivingMode},set:function(t){this._shadowReceivingMode=t,this._updateReceiveShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(t){var e=this._mesh,n=this._mesh=t;null==n||n.initialize(),this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._onMeshChanged(e),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(t){this._enableMorph=t}}]),e}(cF),s0.ShadowCastingMode=y0,s0.ShadowReceivingMode=x0,n0=st((e0=c0).prototype,"lightmapSettings",[vc,Pc,Vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new S0}}),i0=st(e0.prototype,"_mesh",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),r0=st(e0.prototype,"_shadowCastingMode",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return y0.OFF}}),o0=st(e0.prototype,"_shadowReceivingMode",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return x0.ON}}),st(e0.prototype,"shadowCastingMode",[X$,Y$,Vc],Object.getOwnPropertyDescriptor(e0.prototype,"shadowCastingMode"),e0.prototype),st(e0.prototype,"receiveShadow",[K$,J$,Vc],Object.getOwnPropertyDescriptor(e0.prototype,"receiveShadow"),e0.prototype),st(e0.prototype,"mesh",[Q$,Z$],Object.getOwnPropertyDescriptor(e0.prototype,"mesh"),e0.prototype),st(e0.prototype,"enableMorph",[$$,Vc],Object.getOwnPropertyDescriptor(e0.prototype,"enableMorph"),e0.prototype),a0=st(e0.prototype,"_enableMorph",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),t0=e0))||t0)||t0)||t0)||t0)||t0));function A0(t,e){var n=t.sharedMaterials.length;if(n!==e.sharedMaterials.length)return!1;for(var i=0;i<n;i++)if(t.getRenderMaterial(i)!==e.getRenderMaterial(i))return!1;return!0}t("BatchingUtility",function(){function t(){}return t.batchStaticModel=function(t,e){var n=t.getComponentsInChildren(C0);if(n.length<2)return console.error("the number of static models to batch is less than 2,it needn't batch."),!1;for(var i=1;i<n.length;i++){if(!n[0].mesh.validateMergingMesh(n[i].mesh))return console.error("the meshes of "+n[0].node.name+" and "+n[i].node.name+" can't be merged"),!1;if(!A0(n[0],n[i]))return console.error("the materials of "+n[0].node.name+" and "+n[i].node.name+" can't be merged"),!1}var r=new C$,o=new Un,a=new Un;t.getWorldMatrix(a),Un.invert(a,a);for(var s=0;s<n.length;s++){var c=n[s];c.node.getWorldMatrix(o),Un.multiply(o,a,o),r.merge(n[s].mesh,o),c.enabled=!1}var l=e.addComponent(C0);return l.mesh=r,l.sharedMaterials=n[0].sharedMaterials,!0},t.unbatchStaticModel=function(t,e){for(var n=t.getComponentsInChildren(C0),i=0;i<n.length;i++)n[i].enabled=!0;var r=e.getComponent(C0);return r&&(r.mesh&&r.mesh.destroyRenderingMesh(),r.destroy()),!0},t}()),z(C$.prototype,"Mesh.prototype",[{name:"renderingMesh",newName:"renderingSubMeshes"}]),G(C$.prototype,"Mesh.prototype",[{name:"hasFlatBuffers"},{name:"destroyFlatBuffers"}]);var b0,T0,E0,w0,P0,I0,R0,D0,B0,M0,O0,N0,L0,F0,z0,G0,V0,U0,k0,H0,j0,W0,q0=t("Skeleton",(l0=hc("cc.Skeleton"),u0=Wc([Me]),h0=Wc([Un]),l0((v0=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_joints",p0,it(e)),at(e,"_bindposes",d0,it(e)),at(e,"_hash",m0,it(e)),e._invBindposes=null,e}Q(e,t);var n=e.prototype;return n.destroy=function(){var e,n;return null===(e=null===(n=c.director.root)||void 0===n?void 0:n.dataPoolManager)||void 0===e||e.releaseSkeleton(this),t.prototype.destroy.call(this)},n.validate=function(){return this.joints.length>0&&this.bindposes.length>0},K(e,[{key:"joints",get:function(){return this._joints},set:function(t){this._joints=t}},{key:"bindposes",get:function(){return this._bindposes},set:function(t){this._bindposes=t}},{key:"inverseBindposes",get:function(){if(!this._invBindposes){this._invBindposes=[];for(var t=0;t<this._bindposes.length;t++){var e=new Un;Un.invert(e,this._bindposes[t]),this._invBindposes.push(e)}}return this._invBindposes}},{key:"hash",get:function(){if(!this._hash){for(var t="",e=0;e<this._bindposes.length;e++){var n=this._bindposes[e];t+=n.m00.toPrecision(2)+" "+n.m01.toPrecision(2)+" "+n.m02.toPrecision(2)+" "+n.m03.toPrecision(2)+" "+n.m04.toPrecision(2)+" "+n.m05.toPrecision(2)+" "+n.m06.toPrecision(2)+" "+n.m07.toPrecision(2)+" "+n.m08.toPrecision(2)+" "+n.m09.toPrecision(2)+" "+n.m10.toPrecision(2)+" "+n.m11.toPrecision(2)+" "+n.m12.toPrecision(2)+" "+n.m13.toPrecision(2)+" "+n.m14.toPrecision(2)+" "+n.m15.toPrecision(2)+"\n"}this._hash=po(t,666)}return this._hash}}]),e}(Pu),p0=st((f0=v0).prototype,"_joints",[u0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),d0=st(f0.prototype,"_bindposes",[h0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),m0=st(f0.prototype,"_hash",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_0=f0))||_0));c.Skeleton=q0,G(C0.prototype,"MeshRenderer.prototype",[{name:"enableDynamicBatching"},{name:"recieveShadows"}]),c.ModelComponent=C0,ee.setClassAlias(C0,"cc.ModelComponent");var X0,Y0,K0,J0,Q0,Z0,$0,t1,e1,n1,i1,r1,o1,a1,s1,c1,l1,u1,h1,_1,f1,p1,d1,m1,v1,g1,y1,x1,S1,C1,A1,b1,T1,E1,w1,P1,I1,R1,D1,B1,M1,O1,N1,L1,F1,z1,G1,V1,U1,k1,H1,j1,W1,q1,X1,Y1=ie({LUMINOUS_FLUX:0,LUMINANCE:1}),K1=new En,J1=hc("cc.StaticLightSettings")((R0=function(){function t(){at(this,"_baked",E0,this),at(this,"_editorOnly",w0,this),at(this,"_bakeable",P0,this),at(this,"_castShadow",I0,this)}return K(t,[{key:"editorOnly",get:function(){return this._editorOnly},set:function(t){this._editorOnly=t}},{key:"baked",get:function(){return this._baked},set:function(t){this._baked=t}},{key:"bakeable",get:function(){return this._bakeable},set:function(t){this._bakeable=t}},{key:"castShadow",get:function(){return this._castShadow},set:function(t){this._castShadow=t}}]),t}(),E0=st((T0=R0).prototype,"_baked",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),w0=st(T0.prototype,"_editorOnly",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),P0=st(T0.prototype,"_bakeable",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),I0=st(T0.prototype,"_castShadow",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),st(T0.prototype,"editorOnly",[Pc],Object.getOwnPropertyDescriptor(T0.prototype,"editorOnly"),T0.prototype),st(T0.prototype,"bakeable",[Pc],Object.getOwnPropertyDescriptor(T0.prototype,"bakeable"),T0.prototype),st(T0.prototype,"castShadow",[Pc],Object.getOwnPropertyDescriptor(T0.prototype,"castShadow"),T0.prototype),b0=T0))||b0,Q1=function(e){return t({Light:e,LightComponent:e}),e}((D0=hc("cc.Light"),B0=Bc(),M0=Bc(),O0=Mc(),N0=Bc(),L0=Wc(J1),F0=zc(),D0((W0=j0=function(t){function e(){var e;return at(e=t.call(this)||this,"_color",V0,it(e)),at(e,"_useColorTemperature",U0,it(e)),at(e,"_colorTemperature",k0,it(e)),at(e,"_staticSettings",H0,it(e)),e._type=$g.UNKNOWN,e._lightType=void 0,e._light=null,e._lightType=dy,e}Q(e,t);var n=e.prototype;return n.onLoad=function(){this._createLight()},n.onEnable=function(){this._attachToScene()},n.onDisable=function(){this._detachFromScene()},n.onDestroy=function(){this._destroyLight()},n._createLight=function(){this._light||(this._light=c.director.root.createLight(this._lightType)),this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.baked=this.baked},n._destroyLight=function(){this._light&&(c.director.root.destroyLight(this),this._light=null)},n._attachToScene=function(){if(this._detachFromScene(),this._light&&!this._light.scene&&this.node.scene){var t=this._getRenderScene();switch(this._type){case $g.DIRECTIONAL:t.addDirectionalLight(this._light),t.setMainLight(this._light);break;case $g.SPHERE:t.addSphereLight(this._light);break;case $g.SPOT:t.addSpotLight(this._light)}}},n._detachFromScene=function(){if(this._light&&this._light.scene){var t=this._light.scene;switch(this._type){case $g.DIRECTIONAL:t.removeDirectionalLight(this._light),t.unsetMainLight(this._light);break;case $g.SPHERE:t.removeSphereLight(this._light);break;case $g.SPOT:t.removeSpotLight(this._light)}}},K(e,[{key:"color",get:function(){return this._color},set:function(t){this._color=t,this._light&&(K1.x=t.r/255,K1.y=t.g/255,K1.z=t.b/255,this._light.color=K1)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(t){this._useColorTemperature=t,this._light&&(this._light.useColorTemperature=t)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(t){this._colorTemperature=t,this._light&&(this._light.colorTemperature=t)}},{key:"staticSettings",get:function(){return this._staticSettings},set:function(t){this._staticSettings=t}},{key:"type",get:function(){return this._type}},{key:"baked",get:function(){return this.staticSettings.baked},set:function(t){this.staticSettings.baked=t,null!==this._light&&(this._light.baked=t)}}]),e}(Ku),j0.Type=$g,j0.PhotometricTerm=Y1,V0=st((G0=W0).prototype,"_color",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bn.WHITE.clone()}}),U0=st(G0.prototype,"_useColorTemperature",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),k0=st(G0.prototype,"_colorTemperature",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),H0=st(G0.prototype,"_staticSettings",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new J1}}),st(G0.prototype,"color",[B0],Object.getOwnPropertyDescriptor(G0.prototype,"color"),G0.prototype),st(G0.prototype,"useColorTemperature",[M0],Object.getOwnPropertyDescriptor(G0.prototype,"useColorTemperature"),G0.prototype),st(G0.prototype,"colorTemperature",[Fc,O0,N0],Object.getOwnPropertyDescriptor(G0.prototype,"colorTemperature"),G0.prototype),st(G0.prototype,"staticSettings",[L0,F0],Object.getOwnPropertyDescriptor(G0.prototype,"staticSettings"),G0.prototype),z0=G0))||z0)),Z1=function(e){return t({DirectionalLight:e,DirectionalLightComponent:e}),e}((X0=hc("cc.DirectionalLight"),Y0=wc(),K0=Ac(),J0=gc("_illuminance"),Q0=Bc(),X0(Z0=Y0(Z0=K0(Z0=Cc((n1=function(t){function e(){var e;return at(e=t.call(this)||this,"_illuminanceHDR",t1,it(e)),at(e,"_illuminanceLDR",e1,it(e)),e._type=$g.DIRECTIONAL,e._light=null,e._lightType=lC,e}return Q(e,t),e.prototype._createLight=function(){t.prototype._createLight.call(this),this._illuminanceLDR=this._illuminanceHDR*_g.standardExposureValue,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR,this._light.illuminanceLDR=this._illuminanceLDR)},K(e,[{key:"illuminance",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?(this._illuminanceHDR=t,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR)):(this._illuminanceLDR=t,this._light&&(this._light.illuminanceLDR=this._illuminanceLDR))}}]),e}(Q1),t1=st(($0=n1).prototype,"_illuminanceHDR",[dc,J0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),e1=st($0.prototype,"_illuminanceLDR",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),st($0.prototype,"illuminance",[Q0],Object.getOwnPropertyDescriptor($0.prototype,"illuminance"),$0.prototype),Z0=$0))||Z0)||Z0)||Z0)||Z0)),$1=function(e){return t({SphereLight:e,SphereLightComponent:e}),e}((i1=hc("cc.SphereLight"),r1=wc(),o1=Ac(),a1=gc("_luminance"),s1=zc(),c1=Bc(),l1=zc(),u1=Bc(),h1=Wc(Y1),_1=zc(),f1=Bc(),p1=Bc(),d1=Bc(),i1(m1=r1(m1=o1(m1=Cc((A1=function(t){function e(){var e;return at(e=t.call(this)||this,"_size",g1,it(e)),at(e,"_luminanceHDR",y1,it(e)),at(e,"_luminanceLDR",x1,it(e)),at(e,"_term",S1,it(e)),at(e,"_range",C1,it(e)),e._type=$g.SPHERE,e._light=null,e._lightType=dC,e}return Q(e,t),e.prototype._createLight=function(){t.prototype._createLight.call(this),this.size=this._size,this.range=this._range,c.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceLDR=this._luminanceHDR*_g.standardExposureValue*_g.standardLightMeterScale:this._luminanceHDR=this._luminanceLDR/_g.standardExposureValue/_g.standardLightMeterScale,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},K(e,[{key:"luminousFlux",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*py(this._size):this._luminanceLDR},set:function(t){var e=0;c.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t/py(this._size),e=this._luminanceHDR):(this._luminanceLDR=t,e=this._luminanceLDR),this._light&&(this._light.luminance=e)}},{key:"luminance",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=t,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(t){this._term=t}},{key:"size",get:function(){return this._size},set:function(t){this._size=t,this._light&&(this._light.size=t)}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._light&&(this._light.range=t)}}]),e}(Q1),g1=st((v1=A1).prototype,"_size",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),y1=st(v1.prototype,"_luminanceHDR",[vc,a1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/py(.15)}}),x1=st(v1.prototype,"_luminanceLDR",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),S1=st(v1.prototype,"_term",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Y1.LUMINOUS_FLUX}}),C1=st(v1.prototype,"_range",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),st(v1.prototype,"luminousFlux",[s1,c1],Object.getOwnPropertyDescriptor(v1.prototype,"luminousFlux"),v1.prototype),st(v1.prototype,"luminance",[l1,u1],Object.getOwnPropertyDescriptor(v1.prototype,"luminance"),v1.prototype),st(v1.prototype,"term",[h1,_1,f1],Object.getOwnPropertyDescriptor(v1.prototype,"term"),v1.prototype),st(v1.prototype,"size",[p1],Object.getOwnPropertyDescriptor(v1.prototype,"size"),v1.prototype),st(v1.prototype,"range",[d1],Object.getOwnPropertyDescriptor(v1.prototype,"range"),v1.prototype),m1=v1))||m1)||m1)||m1)||m1)),t2=function(e){return t({SpotLight:e,SpotLightComponent:e}),e}((b1=hc("cc.SpotLight"),T1=wc(),E1=Ac(),w1=gc("_luminance"),P1=Bc(),I1=zc(),R1=Bc(),D1=zc(),B1=Wc(Y1),M1=zc(),O1=Bc(),N1=Bc(),L1=Bc(),F1=Mc(),z1=Bc(),b1(G1=T1(G1=E1(G1=Cc((X1=function(t){function e(){var e;return at(e=t.call(this)||this,"_size",U1,it(e)),at(e,"_luminanceHDR",k1,it(e)),at(e,"_luminanceLDR",H1,it(e)),at(e,"_term",j1,it(e)),at(e,"_range",W1,it(e)),at(e,"_spotAngle",q1,it(e)),e._type=$g.SPOT,e._light=null,e._lightType=CC,e}return Q(e,t),e.prototype._createLight=function(){t.prototype._createLight.call(this),this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle,c.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceLDR=this._luminanceHDR*_g.standardExposureValue*_g.standardLightMeterScale:this._luminanceHDR=this._luminanceLDR/_g.standardExposureValue/_g.standardLightMeterScale,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},K(e,[{key:"luminousFlux",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*py(this._size):this._luminanceLDR},set:function(t){var e=0;c.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t/py(this._size),e=this._luminanceHDR):(this._luminanceLDR=t,e=this._luminanceLDR),this._light&&(this._light.luminance=e)}},{key:"luminance",get:function(){return c.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(t){c.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=t,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=t,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(t){this._term=t}},{key:"size",get:function(){return this._size},set:function(t){this._size=t,this._light&&(this._light.size=t)}},{key:"range",get:function(){return this._range},set:function(t){this._range=t,this._light&&(this._light.range=t)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(t){this._spotAngle=t,this._light&&(this._light.spotAngle=cn(t))}}]),e}(Q1),U1=st((V1=X1).prototype,"_size",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),k1=st(V1.prototype,"_luminanceHDR",[vc,w1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/py(.15)}}),H1=st(V1.prototype,"_luminanceLDR",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),j1=st(V1.prototype,"_term",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Y1.LUMINOUS_FLUX}}),W1=st(V1.prototype,"_range",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),q1=st(V1.prototype,"_spotAngle",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),st(V1.prototype,"luminousFlux",[P1,I1],Object.getOwnPropertyDescriptor(V1.prototype,"luminousFlux"),V1.prototype),st(V1.prototype,"luminance",[R1,D1],Object.getOwnPropertyDescriptor(V1.prototype,"luminance"),V1.prototype),st(V1.prototype,"term",[B1,M1,O1],Object.getOwnPropertyDescriptor(V1.prototype,"term"),V1.prototype),st(V1.prototype,"size",[N1],Object.getOwnPropertyDescriptor(V1.prototype,"size"),V1.prototype),st(V1.prototype,"range",[L1],Object.getOwnPropertyDescriptor(V1.prototype,"range"),V1.prototype),st(V1.prototype,"spotAngle",[Fc,F1,z1],Object.getOwnPropertyDescriptor(V1.prototype,"spotAngle"),V1.prototype),G1=V1))||G1)||G1)||G1)||G1));c.LightComponent=Q1,ee.setClassAlias(Q1,"cc.LightComponent"),c.DirectionalLightComponent=Z1,ee.setClassAlias(Z1,"cc.DirectionalLightComponent"),c.SphereLightComponent=$1,ee.setClassAlias($1,"cc.SphereLightComponent"),c.SpotLightComponent=t2,ee.setClassAlias(t2,"cc.SpotLightComponent"),z(t2.prototype,"SpotLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(t){this.luminousFlux=t}}]),z($1.prototype,"SphereLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(t){this.luminousFlux=t}}]),z(Q1.PhotometricTerm,"Light.PhotometricTerm",[{name:"LUMINOUS_POWER",newName:"LUMINOUS_FLUX"}]);var e2=function(t,e,n){t[e+0]=n.m00,t[e+1]=n.m01,t[e+2]=n.m02,t[e+3]=n.m12,t[e+4]=n.m04,t[e+5]=n.m05,t[e+6]=n.m06,t[e+7]=n.m13,t[e+8]=n.m08,t[e+9]=n.m09,t[e+10]=n.m10,t[e+11]=n.m14};function n2(t,e){var n=4/Math.sqrt(e);return 12*Math.ceil(Math.max(480*n,t)/12)}new Mn,new Mn,new En,new Mn,new En;var i2=new mr(Ci.POINT,Ci.POINT,Ci.NONE,Ai.CLAMP,Ai.CLAMP,Ai.CLAMP),r2=new En,o2=new En,a2=new En,s2=new En,c2=new Un,l2=new Un,u2=new ks,h2=Number.MAX_SAFE_INTEGER,_2=function(){function t(t){this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=t;var e=function(t){return t.hasFeature(li.TEXTURE_FLOAT)?ui.RGBA32F:ui.RGBA8}(this._device);this._formatSize=Jr[e].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new TW(t),this._pool.initialize({format:e,roundUpFn:n2}),this._customPool=new TW(t),this._customPool.initialize({format:e,roundUpFn:n2})}var e=t.prototype;return e.clear=function(){this._pool.destroy(),this._textureBuffers.clear()},e.registerCustomTextureLayouts=function(t){for(var e=0;e<t.length;e++)for(var n=t[e],i=this._customPool.createChunk(n.textureLength),r=0;r<n.contents.length;r++){var o=n.contents[r],a=o.skeleton;this._chunkIdxMap.set(a,i);for(var s=0;s<o.clips.length;s++){var c=o.clips[s];this._chunkIdxMap.set(a^c,i)}}},e.getDefaultPoseTexture=function(t,e,n){var i=0^t.hash,r=this._textureBuffers.get(i)||null;if(r&&r.bounds.has(e.hash))return r.refCount++,r;var o=t.joints,a=t.bindposes,s=null,c=!1,l=o.length;if(r)r.refCount++;else{var u=12*l,h=this._chunkIdxMap.get(i),_=void 0!==h?this._customPool.alloc(u*Float32Array.BYTES_PER_ELEMENT,h):this._pool.alloc(u*Float32Array.BYTES_PER_ELEMENT);if(!_)return r;r={pixelOffset:_.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:t.hash,clipHash:0,readyToBeDeleted:!1,handle:_},s=new Float32Array(u),c=!0}En.set(a2,h2,h2,h2),En.set(s2,-h2,-h2,-h2);for(var f=e.getBoneSpaceBounds(t),p=0,d=0;p<l;p++,d+=12){var m=n.getChildByPath(o[p]),v=m?OU(m,n,c2):t.inverseBindposes[p],g=f[p];g&&(ks.transform(u2,g,v),u2.getBoundary(r2,o2),En.min(a2,a2,r2),En.max(s2,s2,o2)),c&&(m&&Un.multiply(v,v,a[p]),e2(s,d,m?v:Un.IDENTITY))}var y=[new ks];return r.bounds.set(e.hash,y),ks.fromPoints(y[0],a2,s2),c&&(this._pool.update(r.handle,s.buffer),this._textureBuffers.set(i,r)),r},e.getSequencePoseTexture=function(t,e,n,i){var r=t.hash^e.hash,o=this._textureBuffers.get(r)||null;if(o&&o.bounds.has(n.hash))return o.refCount++,o;var a=t.joints,s=t.bindposes,c=tG.getOrExtract(e).frames,l=null,u=!1,h=a.length;if(o)o.refCount++;else{var _=12*h*c,f=this._chunkIdxMap.get(r),p=void 0!==f?this._customPool.alloc(_*Float32Array.BYTES_PER_ELEMENT,f):this._pool.alloc(_*Float32Array.BYTES_PER_ELEMENT);if(!p)return null;var d=this._createAnimInfos(t,e,i);o={pixelOffset:p.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:t.hash,clipHash:e.hash,readyToBeDeleted:!1,handle:p,animInfos:d},l=new Float32Array(_),u=!0}var m=n.getBoneSpaceBounds(t),v=[];o.bounds.set(n.hash,v);for(var g=0;g<c;g++)v.push(new ks(h2,h2,h2,-h2,-h2,-h2));for(var y=0,x=0;y<c;y++){for(var S=v[y],C=0;C<h;C++,x+=12){var A=o.animInfos[C],b=A.curveData,T=A.downstream,E=A.bindposeIdx,w=A.bindposeCorrection,P=void 0,I=!0;b&&T?P=Un.multiply(c2,b[y],T):b?P=b[y]:T?P=T:(P=t.inverseBindposes[E],I=!1);var R=m[C];if(R){var D=w?Un.multiply(l2,P,w):P;ks.transform(u2,R,D),u2.getBoundary(r2,o2),En.min(S.center,S.center,r2),En.max(S.halfExtents,S.halfExtents,o2)}u&&(I&&Un.multiply(c2,P,s[E]),e2(l,x,I?c2:Un.IDENTITY))}ks.fromPoints(S,S.center,S.halfExtents)}return u&&(this._pool.update(o.handle,l.buffer),this._textureBuffers.set(r,o)),o},e.releaseHandle=function(t){if(t.refCount>0&&t.refCount--,!t.refCount&&t.readyToBeDeleted){var e=t.skeletonHash^t.clipHash;(void 0!==this._chunkIdxMap.get(e)?this._customPool:this._pool).free(t.handle),this._textureBuffers.get(e)===t&&this._textureBuffers.delete(e)}},e.releaseSkeleton=function(t){for(var e=this._textureBuffers.values(),n=e.next();!n.done;){var i=n.value;i.skeletonHash===t.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=e.next()}},e.releaseAnimationClip=function(t){for(var e=this._textureBuffers.values(),n=e.next();!n.done;){var i=n.value;i.clipHash===t.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=e.next()}},e._createAnimInfos=function(t,e,n){for(var i=[],r=t.joints,o=t.bindposes,a=r.length,s=tG.getOrExtract(e),c=0;c<a;c++){for(var l=r[c],u=s.joints[l],h=n.getChildByPath(l),_=void 0,f=void 0;!u;){var p=l.lastIndexOf("/");if(l=l.substring(0,p),u=s.joints[l],h?(_||(_=new Un),Un.fromRTS(c2,h.rotation,h.position,h.scale),Un.multiply(_,c2,_),h=h.parent):f=l,p<0)break}var d=c,m=void 0;if(void 0!==f&&u){d=c-1;for(var v=0;v<a;v++)if(r[v]===f){d=v,m=new Un,Un.multiply(m,o[v],t.inverseBindposes[c]);break}}i.push({curveData:u&&u.transforms,downstream:_,bindposeIdx:d,bindposeCorrection:m})}return i},K(t,[{key:"pixelsPerJoint",get:function(){return this._pixelsPerJoint}}]),t}(),f2=function(){function t(t){this._pool=new Map,this._device=void 0,this._device=t}var e=t.prototype;return e.getData=function(t){void 0===t&&(t="-1");var e=this._pool.get(t);if(e)return e;var n=this._device.createBuffer(new lr(fi.UNIFORM|fi.TRANSFER_DST,mi.HOST|mi.DEVICE,pd.SIZE,pd.SIZE)),i=new Float32Array([0,0,0,0]);n.update(i);var r={buffer:n,data:i,dirty:!1,currentClip:null};return this._setAnimInfoDirty(r,!1),this._pool.set(t,r),r},e.destroy=function(t){var e=this._pool.get(t);e&&(e.buffer.destroy(),this._pool.delete(t))},e._setAnimInfoDirty=function(t,e){t.dirty=e},e.switchClip=function(t,e){return t.currentClip=e,t.data[0]=-1,t.buffer.update(t.data),this._setAnimInfoDirty(t,!1),t},e.clear=function(){for(var t,e=ot(this._pool.values());!(t=e()).done;)t.value.buffer.destroy();this._pool.clear()},t}(),p2=function(){function t(t){this.jointTexturePool=void 0,this.jointAnimationInfo=void 0,this.jointTexturePool=new _2(t),this.jointAnimationInfo=new f2(t)}var e=t.prototype;return e.releaseSkeleton=function(t){this.jointTexturePool.releaseSkeleton(t)},e.releaseAnimationClip=function(t){this.jointTexturePool.releaseAnimationClip(t)},e.clear=function(){this.jointTexturePool.clear(),this.jointAnimationInfo.clear()},t}();c.internal.DataPoolManager=p2;var d2=[{name:"CC_USE_SKINNING",value:!0}];function m2(t,e,n,i){for(var r=0;r<n.length;r++){for(var o=n[r],a=-1,s=0;s<o.length;s++)if(o[s]===i){a=s;break}a>=0&&(e.push(r),t.push(a))}}var v2,g2,y2,x2,S2,C2,A2,b2,T2,E2,w2,P2,I2,R2,D2,B2,M2,O2,N2,L2,F2,z2,G2,V2,U2,k2,H2,j2,W2,q2,X2,Y2,K2,J2,Q2,Z2,$2,t4,e4,n4,i4,r4,o4,a4,s4,c4=new En,l4=new En,u4=new En,h4=new En,_4=new Un,f4=new ks,p4=function(t){function e(){var e;return(e=t.call(this)||this).uploadAnimation=null,e._buffers=[],e._dataArray=[],e._joints=[],e._bufferIndices=null,e.type=KS.SKINNING,e}Q(e,t);var n=e.prototype;return n._init=function(){},n.destroy=function(){if(this.bindSkeleton(),this._buffers.length){for(var e=0;e<this._buffers.length;e++)this._buffers[e].destroy();this._buffers.length=0}t.prototype.destroy.call(this)},n.bindSkeleton=function(t,e,n){void 0===t&&(t=null),void 0===e&&(e=null),void 0===n&&(n=null);for(var i=0;i<this._joints.length;i++)wU(this._joints[i].target);if(this._bufferIndices=null,this._joints.length=0,t&&e&&n){this.transform=e;var r=n.getBoneSpaceBounds(t),o=n.struct.jointMaps;this._ensureEnoughBuffers(o&&o.length||1),this._bufferIndices=n.jointBufferIndices;for(var a=0;a<t.joints.length;a++){var s=r[a],c=e.getChildByPath(t.joints[a]);if(s&&c){var l=EU(c,e),u=t.bindposes[a],h=[],_=[];o?m2(h,_,o,a):(h.push(a),_.push(0)),this._joints.push({indices:h,buffers:_,bound:s,target:c,bindpose:u,transform:l})}}}},n.updateTransform=function(t){var e=this.transform;(e.hasChangedFlags||e._dirtyFlags)&&(e.updateWorldTransform(),this._localDataUpdated=!0),En.set(c4,1/0,1/0,1/0),En.set(l4,-1/0,-1/0,-1/0);for(var n=0;n<this._joints.length;n++){var i=this._joints[n],r=i.bound,o=TU(i.transform,t);ks.transform(f4,r,o),f4.getBoundary(u4,h4),En.min(c4,c4,u4),En.max(l4,l4,h4)}var a=this._worldBounds;this._modelBounds&&a&&(ks.fromPoints(this._modelBounds,c4,l4),this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,this._worldBounds),this._updateNativeBounds())},n.updateUBOs=function(e){t.prototype.updateUBOs.call(this,e);for(var n=0;n<this._joints.length;n++){var i=this._joints[n],r=i.indices,o=i.buffers,a=i.transform,s=i.bindpose;Un.multiply(_4,a.world,s);for(var c=0;c<o.length;c++)e2(this._dataArray[o[c]],12*r[c],_4)}for(var l=0;l<this._buffers.length;l++)this._buffers[l].update(this._dataArray[l]);return!0},n.initSubModel=function(e,n,i){var r=n.vertexBuffers,o=n.iaInfo;o.vertexBuffers=n.jointMappedBuffers,t.prototype.initSubModel.call(this,e,n,i),o.vertexBuffers=r},n.getMacroPatches=function(e){var n=t.prototype.getMacroPatches.call(this,e);return n?d2.concat(n):d2},n._updateLocalDescriptors=function(e,n){t.prototype._updateLocalDescriptors.call(this,e,n);var i=this._buffers[this._bufferIndices[e]];i&&n.bindBuffer(md.BINDING,i)},n._updateInstancedAttributes=function(e,n){n.batchingScheme!==Av.NONE&&I(3936,this.node.name),t.prototype._updateInstancedAttributes.call(this,e,n)},n._ensureEnoughBuffers=function(t){for(var e=0;e<t;e++)this._buffers[e]||(this._buffers[e]=this._device.createBuffer(new lr(fi.UNIFORM|fi.TRANSFER_DST,mi.HOST|mi.DEVICE,md.SIZE,md.SIZE))),this._dataArray[e]||(this._dataArray[e]=new Float32Array(md.COUNT))},e}(g0),d4=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_BAKED_ANIMATION",value:!0}],m4=function(t){function e(){var e;(e=t.call(this)||this).uploadedAnim=void 0,e._jointsMedium=void 0,e._skeleton=null,e._mesh=null,e._dataPoolManager=void 0,e._instAnimInfoIdx=-1,e.type=KS.BAKED_SKINNING,e._dataPoolManager=c.director.root.dataPoolManager;var n=new Float32Array(4),i=e._dataPoolManager.jointAnimationInfo.getData();return e._jointsMedium={buffer:null,jointTextureInfo:n,animInfo:i,texture:null,boundsInfo:null},e}Q(e,t);var n=e.prototype;return n._init=function(){},n.destroy=function(){this.uploadedAnim=void 0,this._jointsMedium.boundsInfo=null,this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null),this._applyJointTexture(),this._applyNativeJointMedium(),t.prototype.destroy.call(this)},n.bindSkeleton=function(t,e,n){if(void 0===t&&(t=null),void 0===e&&(e=null),void 0===n&&(n=null),this._skeleton=t,this._mesh=n,t&&e&&n){this.transform=e;var i=this._dataPoolManager;this._jointsMedium.animInfo=i.jointAnimationInfo.getData(e.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer(new lr(fi.UNIFORM|fi.TRANSFER_DST,mi.DEVICE,fd.SIZE,fd.SIZE)))}},n.updateTransform=function(e){if(t.prototype.updateTransform.call(this,e),this.uploadedAnim){var n=this._jointsMedium,i=n.animInfo,r=n.boundsInfo[i.data[0]],o=this._worldBounds;if(o&&r){var a=this.transform;r.transform(a._mat,a._pos,a._rot,a._scale,o)}}},n.updateUBOs=function(e){t.prototype.updateUBOs.call(this,e);var n=this._jointsMedium.animInfo,i=this._instAnimInfoIdx;return i>=0?this.instancedAttributes.views[i][0]=n.data[0]:n.dirty&&(n.buffer.update(n.data),n.dirty=!1),!0},n._applyNativeJointMedium=function(){},n._updateModelBounds=function(t){this._modelBounds=t},n.uploadAnimation=function(t){if(this._skeleton&&this._mesh&&this.uploadedAnim!==t){this.uploadedAnim=t;var e=this._dataPoolManager,n=null;t?(n=e.jointTexturePool.getSequencePoseTexture(this._skeleton,t,this._mesh,this.transform),this._jointsMedium.boundsInfo=n&&n.bounds.get(this._mesh.hash),this._updateModelBounds(null)):(n=e.jointTexturePool.getDefaultPoseTexture(this._skeleton,this._mesh,this.transform),this._jointsMedium.boundsInfo=null,this._updateModelBounds(n&&n.bounds.get(this._mesh.hash)[0])),this._applyJointTexture(n),this._applyNativeJointMedium()}},n._applyJointTexture=function(t){void 0===t&&(t=null);var e=this._jointsMedium.texture;if(e&&e!==t&&this._dataPoolManager.jointTexturePool.releaseHandle(e),this._jointsMedium.texture=t,t){var n=this._jointsMedium,i=n.buffer,r=n.jointTextureInfo;r[0]=t.handle.texture.width,r[1]=this._skeleton.joints.length,r[2]=t.pixelOffset+.1,r[3]=1/r[0],this.updateInstancedJointTextureInfo(),i&&i.update(r);for(var o=t.handle.texture,a=0;a<this._subModels.length;++a)this._subModels[a].descriptorSet.bindTexture(yd,o)}},n.getMacroPatches=function(e){var n=t.prototype.getMacroPatches.call(this,e);return n?n.concat(d4):d4},n._updateLocalDescriptors=function(e,n){t.prototype._updateLocalDescriptors.call(this,e,n);var i=this._jointsMedium,r=i.buffer,o=i.texture,a=i.animInfo;if(n.bindBuffer(fd.BINDING,r),n.bindBuffer(pd.BINDING,a.buffer),o){var s=this._device.getSampler(i2);n.bindTexture(yd,o.handle.texture),n.bindSampler(yd,s)}},n._setInstAnimInfoIdx=function(t){this._instAnimInfoIdx=t},n._updateInstancedAttributes=function(e,n){t.prototype._updateInstancedAttributes.call(this,e,n),this._setInstAnimInfoIdx(this._getInstancedAttributeIndex(dd)),this.updateInstancedJointTextureInfo()},n.updateInstancedJointTextureInfo=function(){var t=this._jointsMedium,e=t.jointTextureInfo,n=t.animInfo,i=this._instAnimInfoIdx;if(i>=0){var r=this.instancedAttributes.views[i];r[0]=n.data[0],r[1]=e[1],r[2]=e[2]}},e}(g0),v4=function(e){return t({SkinnedMeshRenderer:e,SkinningModelComponent:e}),e}((v2=hc("cc.SkinnedMeshRenderer"),g2=wc(),y2=fc(100),x2=Ac(),S2=Wc(q0),C2=Wc(GT),A2=Wc(q0),b2=Wc(GT),T2=Bc(),v2(E2=g2(E2=y2(E2=Cc(E2=x2((R2=function(t){function e(){var e;return at(e=t.call(this)||this,"_skeleton",P2,it(e)),at(e,"_skinningRoot",I2,it(e)),e._clip=null,e.associatedAnimation=null,e._modelType=m4,e}Q(e,t);var n=e.prototype;return n.onLoad=function(){this._tryBindAnimation()},n.onDestroy=function(){this.associatedAnimation&&(this.associatedAnimation.notifySkinnedMeshRemoved(this),this.associatedAnimation),t.prototype.onDestroy.call(this)},n.uploadAnimation=function(t){this._clip=t,this.model&&this.model.uploadAnimation&&this.model.uploadAnimation(t)},n.setUseBakedAnimation=function(t,e){void 0===t&&(t=!0),void 0===e&&(e=!1);var n=t?m4:p4;(e||this._modelType!==n)&&(this._modelType=n,this._model&&(c.director.root.destroyModel(this._model),this._model=null,this._models.length=0,this._updateModels(),this._updateCastShadow(),this.enabledInHierarchy&&this._attachToScene()))},n.setMaterial=function(e,n){t.prototype.setMaterial.call(this,e,n),this._modelType===p4&&this.getMaterialInstance(n)},n._updateModelParams=function(){this._update(),t.prototype._updateModelParams.call(this)},n._tryBindAnimation=function(){var t=this._skinningRoot;if(t){for(var e=!1,n=this.node;n;n=n.parent)if(n===t){e=!0;break}if(e){var i=t.getComponent("cc.SkeletalAnimation");i?i.notifySkinnedMeshAdded(this):this.setUseBakedAnimation(!1)}}},n._update=function(){this.model&&(this.model.bindSkeleton(this._skeleton,this._skinningRoot,this._mesh),this.model.uploadAnimation&&this.model.uploadAnimation(this._clip))},K(e,[{key:"skeleton",get:function(){return this._skeleton},set:function(t){t!==this._skeleton&&(this._skeleton=t,this._update())}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(t){this._skinningRoot=t,this._tryBindAnimation(),t!==this._skinningRoot&&this._update()}},{key:"model",get:function(){return this._model}}]),e}(C0),P2=st((w2=R2).prototype,"_skeleton",[S2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),I2=st(w2.prototype,"_skinningRoot",[C2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),st(w2.prototype,"skeleton",[A2],Object.getOwnPropertyDescriptor(w2.prototype,"skeleton"),w2.prototype),st(w2.prototype,"skinningRoot",[b2,T2],Object.getOwnPropertyDescriptor(w2.prototype,"skinningRoot"),w2.prototype),E2=w2))||E2)||E2)||E2)||E2)||E2)),g4=new Er(Xi.ATTR_BATCH_ID,ui.R32F),y4=new Er(Xi.ATTR_BATCH_UV,ui.RG32F),x4=Jr[g4.format].size+Jr[y4.format].size,S4=function(e){return t({SkinnedMeshUnit:e,SkinningModelUnit:e}),e}((D2=hc("cc.SkinnedMeshUnit"),B2=Wc(C$),M2=Wc(q0),O2=Wc(ig),N2=Wc(v4),D2((j2=function(){function t(){at(this,"mesh",z2,this),at(this,"skeleton",G2,this),at(this,"material",V2,this),at(this,"_localTransform",U2,this),at(this,"_offset",k2,this),at(this,"_size",H2,this)}return K(t,[{key:"offset",get:function(){return this._offset},set:function(t){Wn.copy(this._offset,t)}},{key:"size",get:function(){return this._size},set:function(t){Wn.copy(this._size,t)}},{key:"copyFrom",get:function(){return null},set:function(t){t&&(this.mesh=t.mesh,this.skeleton=t.skeleton,this.material=t.getMaterial(0),t.skinningRoot&&OU(t.node,t.skinningRoot,this._localTransform))}}]),t}(),z2=st((F2=j2).prototype,"mesh",[B2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),G2=st(F2.prototype,"skeleton",[M2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),V2=st(F2.prototype,"material",[O2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),U2=st(F2.prototype,"_localTransform",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Un}}),k2=st(F2.prototype,"_offset",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wn(0,0)}}),H2=st(F2.prototype,"_size",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wn(1,1)}}),st(F2.prototype,"offset",[Pc],Object.getOwnPropertyDescriptor(F2.prototype,"offset"),F2.prototype),st(F2.prototype,"size",[Pc],Object.getOwnPropertyDescriptor(F2.prototype,"size"),F2.prototype),st(F2.prototype,"copyFrom",[N2],Object.getOwnPropertyDescriptor(F2.prototype,"copyFrom"),F2.prototype),L2=F2))||L2)),C4=new Un,A4=(new Un,new En),b4=function(e){return t({SkinnedMeshBatchRenderer:e,BatchedSkinningModelComponent:e}),e}((W2=hc("cc.SkinnedMeshBatchRenderer"),q2=wc(),X2=fc(100),Y2=Ac(),K2=Bc(),J2=Wc([Me]),Q2=Bc(),Z2=Wc([S4]),$2=Bc(),t4=Ic(),e4=Ic(),W2(n4=q2(n4=X2(n4=Cc(n4=Y2((s4=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"atlasSize",r4,it(e)),at(e,"batchableTextureNames",o4,it(e)),at(e,"units",a4,it(e)),e._textures={},e._batchMaterial=null,e}Q(e,t);var n=e.prototype;return n.onLoad=function(){t.prototype.onLoad.call(this),this.cook()},n.onDestroy=function(){for(var e in this._textures)this._textures[e].destroy();this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),t.prototype.onDestroy.call(this)},n._onMaterialModified=function(e){this.cookMaterials(),t.prototype._onMaterialModified.call(this,e,this.getMaterialInstance(e))},n.cook=function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()},n.cookMaterials=function(){var t=this;this._batchMaterial||(this._batchMaterial=this.getMaterial(0));var e=this.getMaterialInstance(0);if(e&&this._batchMaterial&&this._batchMaterial.effectAsset){e.copy(this._batchMaterial),this.resizeAtlases();for(var n=e.effectAsset.techniques[e.technique],i=function(i){var r=n.passes[i];if(!r.properties)return"continue";var o=function(n){if(r.properties[n].type>=_i.SAMPLER1D){var o=null;t.batchableTextureNames.find((function(t){return t===n}))?((o=t._textures[n])||(o=t.createTexture(n)),t.cookTextures(o,n,i)):t.units.some((function(t){return o=t.material&&t.material.getProperty(n,i)})),o&&e.setProperty(n,o,i)}else{for(var a=[],s=0;s<t.units.length;s++){var c=t.units[s];c.material&&a.push(c.material.getProperty(n.slice(0,-3),i))}e.setProperty(n,a,i)}};for(var a in r.properties)o(a)},r=0;r<n.passes.length;r++)i(r)}else console.warn("incomplete batch material!")},n.cookSkeletons=function(){if(this._skinningRoot){for(var t=[],e=[],n=0;n<this.units.length;n++){var i=this.units[n];if(i&&i.skeleton){var r=i.skeleton;Un.invert(C4,i._localTransform);for(var o=function(n){var i=r.joints[n];if(t.findIndex((function(t){return t===i}))>=0)return"continue";t.push(i),e.push(Un.multiply(new Un,r.bindposes[n]||Un.IDENTITY,C4))},a=0;a<r.joints.length;a++)o(a)}}var s=Array.from(Array(t.length).keys()).sort((function(e,n){return t[e]>t[n]?1:t[e]<t[n]?-1:0})),c=new q0;c.joints=t.map((function(t,e,n){return n[s[e]]})),c.bindposes=e.map((function(t,e,n){return n[s[e]]})),this._skeleton&&this._skeleton.destroy(),this.skeleton=c}else console.warn("no skinning root specified!")},n.cookMeshes=function(){for(var t=this,e=!1,n=0;n<this.units.length;n++)if(this.units[n].mesh){e=!0;break}if(e&&this._skinningRoot){this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new C$;for(var i=0,r=ui.UNKNOWN,o=0,a=ui.UNKNOWN,s=0,c=ui.UNKNOWN,l=0,u=ui.UNKNOWN,h=0,_=ui.UNKNOWN,f=new Array(this.units.length),p=this.units.length,d=0;d<p;d++){var m=this.units[d];m&&m.skeleton&&(f[d]=m.skeleton.joints.map((function(e){return t._skeleton.joints.findIndex((function(t){return e===t}))})))}for(var v=function(e){var n=t.units[e];if(!n||!n.mesh||!n.mesh.data)return"continue";var p=t._createUnitMesh(e,n.mesh),d=new DataView(p.data.buffer);Un.inverseTranspose(C4,n._localTransform);for(var m=n.offset,v=n.size,g=function(t){var g=p.struct.vertexBundles[t];i=g.view.offset,r=ui.UNKNOWN;for(var y=0;y<g.attributes.length;y++){var x=g.attributes[y];if(x.name===Xi.ATTR_POSITION){r=x.format;break}i+=Jr[x.format].size}if(r){for(var S=BE(d,r,i,g.view.length,g.view.stride),C=0;C<S.length;C+=3)En.fromArray(A4,S,C),En.transformMat4(A4,A4,n._localTransform),En.toArray(S,A4,C);DE(d,S,r,i,g.view.stride)}o=g.view.offset,a=ui.UNKNOWN;for(var A=0;A<g.attributes.length;A++){var b=g.attributes[A];if(b.name===Xi.ATTR_NORMAL){a=b.format;break}o+=Jr[b.format].size}if(a){for(var T=BE(d,a,o,g.view.length,g.view.stride),E=0;E<T.length;E+=3)En.fromArray(A4,T,E),En.transformMat4Normal(A4,A4,C4),En.toArray(T,A4,E);DE(d,T,a,o,g.view.stride)}s=g.view.offset,c=ui.UNKNOWN;for(var w=0;w<g.attributes.length;w++){var P=g.attributes[w];if(P.name===Xi.ATTR_TANGENT){c=P.format;break}s+=Jr[P.format].size}if(c){for(var I=BE(d,c,s,g.view.length,g.view.stride),R=0;R<I.length;R+=3)En.fromArray(A4,I,R),En.transformMat4Normal(A4,A4,C4),En.toArray(I,A4,R);DE(d,I,c,s,g.view.stride)}l=g.view.offset,u=ui.UNKNOWN;for(var D=0;D<g.attributes.length;D++){var B=g.attributes[D];if(B.name===Xi.ATTR_BATCH_UV){u=B.format;break}l+=Jr[B.format].size}u&&ME(d,(function(t,e){var n,i=0===e?"x":"y";return(t=(n=t)-Math.floor(n))*v[i]+m[i]}),u,l,g.view.length,g.view.stride,d);var M=f[e];if(!M)return"continue";h=g.view.offset,_=ui.UNKNOWN;for(var O=0;O<g.attributes.length;O++){var N=g.attributes[O];if(N.name===Xi.ATTR_JOINTS){_=N.format;break}h+=Jr[N.format].size}_&&ME(d,(function(t){return M[t]}),_,h,g.view.length,g.view.stride,d)},y=0;y<p.struct.vertexBundles.length;y++)g(y);t._mesh.merge(p)},g=0;g<p;g++)v(g);this._onMeshChanged(this._mesh),this._updateModels()}},n.cookTextures=function(t,e,n){for(var i=[],r=[],o=[],a=[],s=0;s<this.units.length;s++){var l=this.units[s];if(l.material){var u=l.material.getProperty(e,n);if(u&&u.image&&u.image.data){var h=new ir;h.texOffset.x=l.offset.x*this.atlasSize,h.texOffset.y=l.offset.y*this.atlasSize,h.texExtent.width=l.size.x*this.atlasSize,h.texExtent.height=l.size.y*this.atlasSize;var _=u.image.data;ArrayBuffer.isView(_)?(o.push(_),a.push(h)):(i.push(_),r.push(h))}}}var f=t.getGFXTexture(),p=c.director.root.device;o.length>0&&p.copyBuffersToTexture(o,f,a),i.length>0&&p.copyTexImagesToTexture(i,f,r)},n.createTexture=function(t){var e=new gv;return e.setFilters(Pm.LINEAR,Pm.LINEAR),e.setMipFilter(Pm.NEAREST),e.reset({width:this.atlasSize,height:this.atlasSize,format:Em.RGBA8888}),this._textures[t]=e,e},n.resizeAtlases=function(){for(var t in this._textures)this._textures[t].reset({width:this.atlasSize,height:this.atlasSize,format:Em.RGBA8888})},n._createUnitMesh=function(t,e){for(var n=JSON.parse(JSON.stringify(e.struct)),i={},r=0;r<e.struct.primitives.length;r++){for(var o=e.struct.primitives[r],a=0,s=ui.UNKNOWN,l=0;l<o.vertexBundelIndices.length;l++){var u=e.struct.vertexBundles[o.vertexBundelIndices[l]];a=u.view.offset,s=ui.UNKNOWN;for(var h=0;h<u.attributes.length;h++){var _=u.attributes[h];if(_.name===Xi.ATTR_TEX_COORD){s=_.format;break}a+=Jr[_.format].size}if(s)break}if(void 0===i[l]){i[l]=[s,a];var f=n.vertexBundles[l];f.attributes.push(g4),f.attributes.push(y4),f.view.offset=0,f.view.length+=f.view.count*x4,f.view.stride+=x4}}for(var p=0,d=0;d<n.vertexBundles.length;d++)p+=n.vertexBundles[d].view.length;for(var m=0;m<n.primitives.length;m++){var v=n.primitives[m];v.indexView&&(v.indexView.offset=p,p+=v.indexView.length)}var g=new Uint8Array(p),y=e.data,x=new DataView(g.buffer),S=new DataView(y.buffer),C=c.sys.isLittleEndian;for(var A in i)for(var b=n.vertexBundles[A],T=e.struct.vertexBundles[A],E=i[A],w=BE(S,E[0],E[1],T.view.length,T.view.stride),P=T.view,I=b.view,R=P.stride,D=I.stride,B=P.offset,M=I.offset,O=0;O<I.count;O++){var N=y.subarray(B,B+R);g.set(N,M),x.setFloat32(M+R,t),x.setFloat32(M+R+4,w[2*O],C),x.setFloat32(M+R+8,w[2*O+1],C),M+=D,B+=R}for(var L=0;L<n.primitives.length;L++){var F=e.struct.primitives[L],z=n.primitives[L];if(F.indexView&&z.indexView)for(var G=F.indexView.stride,V=z.indexView.stride,U=F.indexView.offset,k=z.indexView.offset,H=0;H<z.indexView.count;H++){var j=y.subarray(U,U+G);g.set(j,k),k+=V,U+=G}}var W=new C$;return W.reset({struct:n,data:g}),W},K(e,[{key:"mesh",get:function(){return t.prototype.mesh},set:function(t){this.mesh=t}},{key:"skeleton",get:function(){return t.prototype.skeleton},set:function(t){this.skeleton=t}}]),e}(v4),r4=st((i4=s4).prototype,"atlasSize",[vc,K2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),o4=st(i4.prototype,"batchableTextureNames",[J2,vc,Q2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),a4=st(i4.prototype,"units",[Z2,vc,$2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),st(i4.prototype,"mesh",[el,t4],Object.getOwnPropertyDescriptor(i4.prototype,"mesh"),i4.prototype),st(i4.prototype,"skeleton",[el,e4],Object.getOwnPropertyDescriptor(i4.prototype,"skeleton"),i4.prototype),n4=i4))||n4)||n4)||n4)||n4)||n4));c.SkinningModelComponent=v4,ee.setClassAlias(v4,"cc.SkinningModelComponent"),c.SkinningModelUnit=S4,ee.setClassAlias(S4,"cc.SkinningModelUnit"),c.BatchedSkinningModelComponent=b4,ee.setClassAlias(b4,"cc.BatchedSkinningModelComponent");var T4,E4,w4,P4,I4,R4,D4,B4,M4,O4,N4,L4,F4,z4,G4,V4,U4,k4,H4,j4,W4=new Un,q4=new Un,X4=t("SkeletalAnimationState",function(t){function e(e,n){var i;return void 0===n&&(n=""),(i=t.call(this,e,n)||this)._frames=1,i._bakedDuration=0,i._animInfo=null,i._sockets=[],i._animInfoMgr=void 0,i._parent=null,i._curvesInited=!1,i._animInfoMgr=c.director.root.dataPoolManager.jointAnimationInfo,i}Q(e,t);var n=e.prototype;return n.initialize=function(e){if(!this._curveLoaded){this._parent=e.getComponent("cc.SkeletalAnimation");var n=this._parent.useBakedAnimation;this._doNotCreateEval=n,t.prototype.initialize.call(this,e),this._curvesInited=!n;var i=tG.getOrExtract(this.clip),r=i.frames,o=i.samples;this._frames=r-1,this._animInfo=this._animInfoMgr.getData(e.uuid),this._bakedDuration=this._frames/o,this.setUseBaked(n)}},n.setUseBaked=function(e){e?(this._sampleCurves=this._sampleCurvesBaked,this.duration=this._bakedDuration):(this._sampleCurves=t.prototype._sampleCurves,this.duration=this.clip.duration,this._curvesInited||(this._curveLoaded=!1,t.prototype.initialize.call(this,this._targetNode),this._curvesInited=!0))},n.rebuildSocketCurves=function(t){if(this._sockets.length=0,this._targetNode)for(var e=this._targetNode,n=0;n<t.length;++n){var i=t[n],r=e.getChildByPath(i.path);if(i.target){for(var o=tG.getOrExtract(this.clip),a=i.path,s=o.joints[a],c=r,l=void 0;!s;){var u=a.lastIndexOf("/");if(a=a.substring(0,u),s=o.joints[a],c&&(l||(l=Un.identity(q4)),Un.fromRTS(W4,c.rotation,c.position,c.scale),Un.multiply(l,W4,l),c=c.parent),u<0)break}for(var h=s&&s.transforms,_=o.frames,f=[],p=0;p<_;p++){var d;d=h&&l?Un.multiply(W4,h[p],l):h?h[p]:l||new Un;var m={pos:new En,rot:new Mn,scale:new En};Un.toRTS(d,m.rot,m.pos,m.scale),f.push(m)}this._sockets.push({target:i.target,frames:f})}}},n._setAnimInfoDirty=function(t,e){t.dirty=e},n._sampleCurvesBaked=function(t){var e=t/this.duration,n=this._animInfo,i=this.clip;n.currentClip!==i&&(this._animInfoMgr.switchClip(this._animInfo,i),this._parent.getUsers().forEach((function(t){t.uploadAnimation(i)})));var r=e*this._frames+.5|0;if(r!==n.data[0]){n.data[0]=r,this._setAnimInfoDirty(n,!0);for(var o=0;o<this._sockets.length;++o){var a=this._sockets[o],s=a.target,c=a.frames[r],l=c.pos,u=c.rot,h=c.scale;s.setRTS(u,l,h)}}},e}(XV)),Y4=t("Socket",(T4=hc("cc.SkeletalAnimation.Socket"),E4=Wc(GT),T4((I4=st((P4=function(t,e){void 0===t&&(t=""),void 0===e&&(e=null),at(this,"path",I4,this),at(this,"target",R4,this),this.path=t,this.target=e}).prototype,"path",[vc,Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),R4=st(P4.prototype,"target",[E4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),w4=P4))||w4));ee.setClassAlias(Y4,"cc.SkeletalAnimationComponent.Socket");var K4=new Un,J4=new Un;function Q4(t,e,n){void 0===e&&(e=""),void 0===n&&(n=[]);for(var i=0;i<t.children.length;i++){var r=t.children[i];if(r){var o=e?e+"/"+r.name:r.name;n.push(o),Q4(r,o,n)}}return n}var Z4,$4,t3,e3=function(e){return t({SkeletalAnimation:e,SkeletalAnimationComponent:e}),e}((D4=hc("cc.SkeletalAnimation"),B4=wc(),M4=fc(99),O4=Ac(),N4=Wc([Y4]),L4=Bc(),F4=Bc(),z4=Wc([Y4]),D4(G4=B4(G4=M4(G4=Cc(G4=O4((j4=H4=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_useBakedAnimation",U4,it(e)),at(e,"_sockets",k4,it(e)),e._users=new Set,e._currentBakedState=null,e}Q(e,t);var n=e.prototype;return n.onLoad=function(){t.prototype.onLoad.call(this);for(var e=this.node.getComponentsInChildren(v4),n=0;n<e.length;++n){var i=e[n];i.skinningRoot===this.node&&this.notifySkinnedMeshAdded(i)}},n.onDestroy=function(){t.prototype.onDestroy.call(this),c.director.root.dataPoolManager.jointAnimationInfo.destroy(this.node.uuid),c.director.getAnimationManager().removeSockets(this.node,this._sockets),this._removeAllUsers()},n.start=function(){this.sockets=this._sockets,this.useBakedAnimation=this._useBakedAnimation,t.prototype.start.call(this)},n.pause=function(){var e;this._useBakedAnimation?null===(e=this._currentBakedState)||void 0===e||e.pause():t.prototype.pause.call(this)},n.resume=function(){var e;this._useBakedAnimation?null===(e=this._currentBakedState)||void 0===e||e.resume():t.prototype.resume.call(this)},n.stop=function(){this._useBakedAnimation?this._currentBakedState&&(this._currentBakedState.stop(),this._currentBakedState=null):t.prototype.stop.call(this)},n.querySockets=function(){var t=this._defaultClip&&Object.keys(tG.getOrExtract(this._defaultClip).joints).sort().reduce((function(t,e){return e.startsWith(t[t.length-1])||t.push(e),t}),[])||[];if(!t.length)return["please specify a valid default animation clip first"];for(var e=[],n=0;n<t.length;n++){var i=t[n],r=this.node.getChildByPath(i);r&&(e.push(i),Q4(r,i,e))}return e},n.rebuildSocketAnimations=function(){for(var t,e=ot(this._sockets);!(t=e()).done;){var n=t.value,i=this.node.getChildByPath(n.path),r=n.target;i&&r&&(r.name=n.path.substring(n.path.lastIndexOf("/")+1)+" Socket",r.parent=this.node,OU(i,this.node,K4),Un.fromRTS(J4,r.rotation,r.position,r.scale),Un.equals(J4,K4)||(r.matrix=K4))}for(var o=0,a=Object.keys(this._nameToState);o<a.length;o++){var s=a[o];this._nameToState[s].rebuildSocketCurves(this._sockets)}},n.createSocket=function(t){var e=this._sockets.find((function(e){return e.path===t}));if(e)return e.target;if(!this.node.getChildByPath(t))return console.warn("illegal socket path"),null;var n=new GT;return n.parent=this.node,this._sockets.push(new Y4(t,n)),this.rebuildSocketAnimations(),n},n.notifySkinnedMeshAdded=function(t){var e=this._useBakedAnimation,n=t.associatedAnimation;if(n&&n._users.delete(t),t.associatedAnimation=this,t.setUseBakedAnimation(e,!0),e){var i=this._currentBakedState;i&&t.uploadAnimation(i.clip)}this._users.add(t)},n.notifySkinnedMeshRemoved=function(t){t.associatedAnimation,t.setUseBakedAnimation(!1),t.associatedAnimation=null,this._users.delete(t)},n.getUsers=function(){return this._users},n._createState=function(t,e){return new X4(t,e)},n._doCreateState=function(e,n){var i=t.prototype._doCreateState.call(this,e,n);return i.rebuildSocketCurves(this._sockets),i},n.doPlayOrCrossFade=function(e,n){if(this._useBakedAnimation){this._currentBakedState&&this._currentBakedState.stop();var i=e;this._currentBakedState=i,i.play()}else t.prototype.doPlayOrCrossFade.call(this,e,n)},n._removeAllUsers=function(){var t=this;Array.from(this._users).forEach((function(e){t.notifySkinnedMeshRemoved(e)}))},K(e,[{key:"sockets",get:function(){return this._sockets},set:function(t){if(!this._useBakedAnimation){var e=c.director.getAnimationManager();e.removeSockets(this.node,this._sockets),e.addSockets(this.node,t)}this._sockets=t,this.rebuildSocketAnimations()}},{key:"useBakedAnimation",get:function(){return this._useBakedAnimation},set:function(t){for(var e in this._useBakedAnimation=t,this._nameToState)this._nameToState[e].setUseBaked(t);this._users.forEach((function(e){e.setUseBakedAnimation(t)})),this._useBakedAnimation?c.director.getAnimationManager().removeSockets(this.node,this._sockets):(c.director.getAnimationManager().addSockets(this.node,this._sockets),this._currentBakedState=null)}}]),e}(_U),H4.Socket=Y4,st((V4=j4).prototype,"sockets",[N4,L4],Object.getOwnPropertyDescriptor(V4.prototype,"sockets"),V4.prototype),st(V4.prototype,"useBakedAnimation",[F4],Object.getOwnPropertyDescriptor(V4.prototype,"useBakedAnimation"),V4.prototype),U4=st(V4.prototype,"_useBakedAnimation",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),k4=st(V4.prototype,"_sockets",[z4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),G4=V4))||G4)||G4)||G4)||G4)||G4));c.SkeletalAnimationComponent=e3,ee.setClassAlias(e3,"cc.SkeletalAnimationComponent"),c.utils=D$,function(t){t.PLAYED="play",t.PAUSED="pause",t.STOPPED="stop",t.SEEKED="seeked",t.ENDED="ended",t.INTERRUPTION_BEGIN="interruptionBegin",t.INTERRUPTION_END="interruptionEnd",t.USER_GESTURE="on_gesture"}(Z4||(Z4={})),function(t){t[t.DOM_AUDIO=0]="DOM_AUDIO",t[t.WEB_AUDIO=1]="WEB_AUDIO",t[t.MINIGAME_AUDIO=2]="MINIGAME_AUDIO",t[t.NATIVE_AUDIO=3]="NATIVE_AUDIO",t[t.UNKNOWN_AUDIO=4]="UNKNOWN_AUDIO"}($4||($4={})),function(t){t[t.INIT=0]="INIT",t[t.PLAYING=1]="PLAYING",t[t.PAUSED=2]="PAUSED",t[t.STOPPED=3]="STOPPED",t[t.INTERRUPTED=4]="INTERRUPTED"}(t3||(t3={}));var n3,i3=0;function r3(t,e){var n;e.invoking||(e.invoking=!0,(n=e.func).call.apply(n,[t].concat(e.args)).then((function(){e.invoking=!1,t._operationQueue.shift(),t._eventTarget.emit(e.id.toString());var n=t._operationQueue[0];n&&r3(t,n)})).catch((function(){})))}function o3(t,e,n){var i=n.value;n.value=function(){for(var t=this,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return new Promise((function(e){var r=i3++,o=t;o._operationQueue.push({id:r,func:i,args:n,invoking:!1}),o._eventTarget.once(r.toString(),e),r3(o,o._operationQueue[0])}))}}function a3(t){return new Promise((function(e){var n=t.play();return void 0===n?e():(n.then(e).catch((function(){var n=function(){t.play().catch((function(){})),e()},i=document.getElementById("GameCanvas");null==i||i.addEventListener("touchend",n,{once:!0}),null==i||i.addEventListener("mousedown",n,{once:!0})})),null)}))}var s3,c3,l3=function(){function t(t,e){this._domAudio=void 0,this._onPlayCb=void 0,this._onEndCb=void 0,this._domAudio=t,t.volume=e}var e=t.prototype;return e.play=function(){var t=this;a3(this._domAudio).then((function(){var e;null===(e=t.onPlay)||void 0===e||e.call(t)})).catch((function(){}))},e.stop=function(){this._domAudio.pause()},K(t,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(t){this._onPlayCb=t}},{key:"onEnd",get:function(){return this._onEndCb},set:function(t){this._onEndCb&&this._domAudio.removeEventListener("ended",this._onEndCb),this._onEndCb=t,t&&this._domAudio.addEventListener("ended",t)}}]),t}(),u3=(st((n3=function(){function t(t){var e=this;this._domAudio=void 0,this._state=t3.INIT,this._onEnded=void 0,this._eventTarget=new Ql,this._operationQueue=[],this._domAudio=t,hu.on("hide",this._onHide,this),hu.on("show",this._onShow,this),this._onEnded=function(){e.seek(0).catch((function(){})),e._state=t3.INIT,e._eventTarget.emit(Z4.ENDED)},this._domAudio.addEventListener("ended",this._onEnded)}var e=t.prototype;return e.destroy=function(){hu.off("hide",this._onHide,this),hu.off("show",this._onShow,this),this._domAudio.removeEventListener("ended",this._onEnded),this._domAudio=null},t.load=function(e){return new Promise((function(n){t.loadNative(e).then((function(e){n(new t(e))})).catch((function(){}))}))},t.loadNative=function(t){return new Promise((function(e,n){var i=document.createElement("audio"),r="canplaythrough";hu.os===nu.IOS?r="loadedmetadata":hu.browserType===$l.FIREFOX&&(r="canplay");var o=setTimeout((function(){0===i.readyState?c():s()}),8e3),a=function(){clearTimeout(o),i.removeEventListener(r,s,!1),i.removeEventListener("error",c,!1)},s=function(){a(),e(i)},c=function(){a(),n("load audio failure - "+t)};i.addEventListener(r,s,!1),i.addEventListener("error",c,!1),i.src=t}))},t.loadOneShotAudio=function(e,n){return new Promise((function(i,r){t.loadNative(e).then((function(t){var e=new l3(t,n);i(e)})).catch(r)}))},e._onHide=function(){var t=this;this._state===t3.PLAYING&&this.pause().then((function(){t._state=t3.INTERRUPTED,t._eventTarget.emit(Z4.INTERRUPTION_BEGIN)})).catch((function(){}))},e._onShow=function(){var t=this;this._state===t3.INTERRUPTED&&this.play().then((function(){t._eventTarget.emit(Z4.INTERRUPTION_END)})).catch((function(){}))},e.seek=function(t){return t=on(t,0,this.duration),this._domAudio.currentTime=t,Promise.resolve()},e.play=function(){var t=this;return new Promise((function(e){a3(t._domAudio).then((function(){t._state=t3.PLAYING,e()})).catch((function(){}))}))},e.pause=function(){return this._domAudio.pause(),this._state=t3.PAUSED,Promise.resolve()},e.stop=function(){var t=this;return new Promise((function(e){t._domAudio.pause(),t._domAudio.currentTime=0,t._state=t3.STOPPED,e()}))},e.onInterruptionBegin=function(t){this._eventTarget.on(Z4.INTERRUPTION_BEGIN,t)},e.offInterruptionBegin=function(t){this._eventTarget.off(Z4.INTERRUPTION_BEGIN,t)},e.onInterruptionEnd=function(t){this._eventTarget.on(Z4.INTERRUPTION_END,t)},e.offInterruptionEnd=function(t){this._eventTarget.off(Z4.INTERRUPTION_END,t)},e.onEnded=function(t){this._eventTarget.on(Z4.ENDED,t)},e.offEnded=function(t){this._eventTarget.off(Z4.ENDED,t)},K(t,[{key:"src",get:function(){return this._domAudio?this._domAudio.src:""}},{key:"type",get:function(){return $4.DOM_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._domAudio.loop},set:function(t){this._domAudio.loop=t}},{key:"volume",get:function(){return this._domAudio.volume},set:function(t){t=an(t),this._domAudio.volume=t}},{key:"duration",get:function(){return this._domAudio.duration}},{key:"currentTime",get:function(){return this._domAudio.currentTime}}]),t}()).prototype,"seek",[o3],Object.getOwnPropertyDescriptor(n3.prototype,"seek"),n3.prototype),st(n3.prototype,"play",[o3],Object.getOwnPropertyDescriptor(n3.prototype,"play"),n3.prototype),st(n3.prototype,"pause",[o3],Object.getOwnPropertyDescriptor(n3.prototype,"pause"),n3.prototype),st(n3.prototype,"stop",[o3],Object.getOwnPropertyDescriptor(n3.prototype,"stop"),n3.prototype),n3),h3=function(){function t(t){this._nativeAudio=void 0,this._startTime=0,this._startOffset=0,this._isPaused=!0,this._nativeAudio=t}var e=t.prototype;return e.destroy=function(){this._nativeAudio=void 0},e._now=function(){return performance.now()/1e3},e._calculateCurrentTime=function(){var t=this._now()-this._startTime,e=this._startOffset+t;return e>=this.duration&&(this._startTime=this._now(),this._startOffset=0),e%this.duration},e.start=function(){this._isPaused=!1,this._startTime=this._now()},e.pause=function(){this._isPaused||(this._isPaused=!0,this._startOffset=this._calculateCurrentTime())},e.stop=function(){this._isPaused=!0,this._startOffset=0},e.seek=function(t){this._startTime=this._now(),this._startOffset=on(t,0,this.duration)},K(t,[{key:"duration",get:function(){return this._nativeAudio.duration}},{key:"currentTime",get:function(){return this._isPaused?this._startOffset:this._calculateCurrentTime()}}]),t}(),_3=new(function(){function t(){this._audioBufferDataMap={}}var e=t.prototype;return e.addCache=function(t,e){this._audioBufferDataMap[t]?console.warn("Audio buffer "+t+" has been cached"):this._audioBufferDataMap[t]={usedCount:1,audioBuffer:e}},e.retainCache=function(t){var e=this._audioBufferDataMap[t];e?e.usedCount++:console.warn("Audio buffer cache "+t+" has not been added.")},e.getCache=function(t){var e=this._audioBufferDataMap[t];return null==e?void 0:e.audioBuffer},e.tryReleasingCache=function(t){var e=this._audioBufferDataMap[t];e?--e.usedCount<=0&&delete this._audioBufferDataMap[t]:console.warn("Audio buffer cache "+t+" has not been added.")},t}()),f3=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,p3=function(){function t(){this._context=void 0,this._context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext)}var e=t.prototype;return e.decodeAudioData=function(t){var e=this;return new Promise((function(n){var i=e._context.decodeAudioData(t,(function(t){n(t)}),(function(t){console.error("failed to load Web Audio",t)}));null==i||i.catch((function(){}))}))},e.runContext=function(){var t=this;return new Promise((function(e){var n=t._context;if(n.resume)if("running"!==n.state){var i=document.getElementById("GameCanvas"),r=function(){n.resume().then(e).catch((function(){}))};null==i||i.addEventListener("touchend",r,{once:!0,capture:!0}),null==i||i.addEventListener("mouseup",r,{once:!0,capture:!0})}else e();else e()}))},e.createBufferSource=function(t,e){var n=this._context.createBufferSource();return void 0!==t&&(n.buffer=t),void 0!==e&&(n.loop=e),n},e.createGain=function(t){void 0===t&&(t=1);var e=this._context.createGain();return this.setGainValue(e,t),e},e.setGainValue=function(t,e){if(t.gain.setTargetAtTime)try{t.gain.setTargetAtTime(e,this._context.currentTime,0)}catch(n){t.gain.setTargetAtTime(e,this._context.currentTime,.01)}else t.gain.value=e},e.connectContext=function(t){this._context&&t.connect(this._context.destination)},K(t,[{key:"currentTime",get:function(){return this._context.currentTime}}]),t}();p3.support=!!f3,p3.support&&(c3=new p3);var d3,m3,v3,g3,y3,x3=function(){function t(t,e,n){this._duration=void 0,this._bufferSourceNode=void 0,this._onPlayCb=void 0,this._currentTimer=0,this._url=void 0,this._onEndCb=void 0,this._duration=t.duration,this._url=n,this._bufferSourceNode=c3.createBufferSource(t,!1);var i=c3.createGain(e);this._bufferSourceNode.connect(i),c3.connectContext(i)}var e=t.prototype;return e.play=function(){var t=this;this._bufferSourceNode.start(),c3.runContext().then((function(){var e;null===(e=t.onPlay)||void 0===e||e.call(t),t._currentTimer=window.setTimeout((function(){var e;_3.tryReleasingCache(t._url),null===(e=t.onEnd)||void 0===e||e.call(t)}),1e3*t._duration)})).catch((function(){}))},e.stop=function(){clearTimeout(this._currentTimer),_3.tryReleasingCache(this._url),this._bufferSourceNode.stop(),this._bufferSourceNode.buffer=null},K(t,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(t){this._onPlayCb=t}},{key:"onEnd",get:function(){return this._onEndCb},set:function(t){this._onEndCb=t}}]),t}(),S3=(st((s3=function(){function t(t,e){this._src=void 0,this._audioBuffer=void 0,this._sourceNode=void 0,this._gainNode=void 0,this._currentTimer=0,this._volume=1,this._loop=!1,this._state=t3.INIT,this._audioTimer=void 0,this._eventTarget=new Ql,this._operationQueue=[],this._audioBuffer=t,this._audioTimer=new h3(t),this._gainNode=c3.createGain(),c3.connectContext(this._gainNode),this._src=e,hu.on("hide",this._onHide,this),hu.on("show",this._onShow,this)}var e=t.prototype;return e.destroy=function(){this._audioTimer.destroy(),this._audioBuffer&&(this._audioBuffer=null),_3.tryReleasingCache(this._src),hu.off("hide",this._onHide,this),hu.off("show",this._onShow,this)},t.load=function(e){return new Promise((function(n){t.loadNative(e).then((function(i){n(new t(i,e))})).catch((function(){}))}))},t.loadNative=function(t){return new Promise((function(e,n){var i=_3.getCache(t);if(i)return _3.retainCache(t),void e(i);var r=new XMLHttpRequest,o="load audio failed: "+t+", status: ";r.open("GET",t,!0),r.responseType="arraybuffer",r.onload=function(){200===r.status||0===r.status?c3.decodeAudioData(r.response).then((function(n){_3.addCache(t,n),e(n)})).catch((function(){})):n(new Error(""+o+r.status+"(no response)"))},r.onerror=function(){n(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){n(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){n(new Error(""+o+r.status+"(abort)"))},r.send(null)}))},t.loadOneShotAudio=function(e,n){return new Promise((function(i,r){t.loadNative(e).then((function(t){var r=new x3(t,n,e);i(r)})).catch(r)}))},e._onHide=function(){var t=this;this._state===t3.PLAYING&&this.pause().then((function(){t._state=t3.INTERRUPTED,t._eventTarget.emit(Z4.INTERRUPTION_BEGIN)})).catch((function(){}))},e._onShow=function(){var t=this;this._state===t3.INTERRUPTED&&this.play().then((function(){t._eventTarget.emit(Z4.INTERRUPTION_END)})).catch((function(){}))},e.seek=function(t){var e=this;return new Promise((function(n){e._audioTimer.seek(t),e._state===t3.PLAYING?e._doPlay().then(n).catch((function(){})):n()}))},e.play=function(){return this._doPlay()},e._doPlay=function(){var t=this;return new Promise((function(e){t._stopSourceNode(),t._sourceNode=c3.createBufferSource(t._audioBuffer,t.loop),t._sourceNode.connect(t._gainNode),t._sourceNode.start(0,t._audioTimer.currentTime),c3.runContext().then((function(){t._state=t3.PLAYING,t._audioTimer.start(),window.clearTimeout(t._currentTimer),t._currentTimer=window.setTimeout((function e(){t.loop?t._currentTimer=window.setTimeout(e,1e3*t._audioBuffer.duration):(t._audioTimer.stop(),t._eventTarget.emit(Z4.ENDED),t._state=t3.INIT)}),1e3*(t._audioBuffer.duration-t._audioTimer.currentTime)),e()})).catch((function(){}))}))},e._stopSourceNode=function(){try{this._sourceNode&&(this._sourceNode.stop(),this._sourceNode.buffer=null)}catch(t){}},e.pause=function(){return this._state===t3.PLAYING&&this._sourceNode?(this._audioTimer.pause(),this._state=t3.PAUSED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},e.stop=function(){return this._sourceNode?(this._audioTimer.stop(),this._state=t3.STOPPED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},e.onInterruptionBegin=function(t){this._eventTarget.on(Z4.INTERRUPTION_BEGIN,t)},e.offInterruptionBegin=function(t){this._eventTarget.off(Z4.INTERRUPTION_BEGIN,t)},e.onInterruptionEnd=function(t){this._eventTarget.on(Z4.INTERRUPTION_END,t)},e.offInterruptionEnd=function(t){this._eventTarget.off(Z4.INTERRUPTION_END,t)},e.onEnded=function(t){this._eventTarget.on(Z4.ENDED,t)},e.offEnded=function(t){this._eventTarget.off(Z4.ENDED,t)},K(t,[{key:"src",get:function(){return this._src}},{key:"type",get:function(){return $4.WEB_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._loop},set:function(t){this._loop=t,this._sourceNode&&(this._sourceNode.loop=t)}},{key:"volume",get:function(){return this._volume},set:function(t){t=an(t),this._volume=t,c3.setGainValue(this._gainNode,t)}},{key:"duration",get:function(){return this._audioBuffer.duration}},{key:"currentTime",get:function(){return this._audioTimer.currentTime}}]),t}()).prototype,"seek",[o3],Object.getOwnPropertyDescriptor(s3.prototype,"seek"),s3.prototype),st(s3.prototype,"play",[o3],Object.getOwnPropertyDescriptor(s3.prototype,"play"),s3.prototype),st(s3.prototype,"pause",[o3],Object.getOwnPropertyDescriptor(s3.prototype,"pause"),s3.prototype),st(s3.prototype,"stop",[o3],Object.getOwnPropertyDescriptor(s3.prototype,"stop"),s3.prototype),s3),C3=function(){function t(t){this._audio=void 0,this._audio=t}var e=t.prototype;return e.play=function(){this._audio.play()},e.stop=function(){this._audio.stop()},K(t,[{key:"onPlay",get:function(){return this._audio.onPlay},set:function(t){this._audio.onPlay=t}},{key:"onEnd",get:function(){return this._audio.onEnd},set:function(t){this._audio.onEnd=t}}]),t}(),A3=function(){function t(t){this._player=void 0,this._player=t}t.load=function(e,n){return new Promise((function(i){(null==n?void 0:n.audioLoadMode)!==$4.DOM_AUDIO&&p3.support?S3.load(e).then((function(e){i(new t(e))})).catch((function(){})):(p3.support||I(5201),u3.load(e).then((function(e){i(new t(e))})).catch((function(){})))}))};var e=t.prototype;return e.destroy=function(){this._player.destroy()},t.loadNative=function(t,e){return(null==e?void 0:e.audioLoadMode)!==$4.DOM_AUDIO&&p3.support?S3.loadNative(t):(p3.support||I(5201),u3.loadNative(t))},t.loadOneShotAudio=function(t,e,n){return new Promise((function(i,r){(null==n?void 0:n.audioLoadMode)!==$4.DOM_AUDIO&&p3.support?S3.loadOneShotAudio(t,e).then((function(t){i(new C3(t))})).catch(r):(p3.support||I(5201),u3.loadOneShotAudio(t,e).then((function(t){i(new C3(t))})).catch(r))}))},e.seek=function(t){return this._player.seek(t)},e.play=function(){return this._player.play()},e.pause=function(){return this._player.pause()},e.stop=function(){return this._player.stop()},e.onInterruptionBegin=function(t){this._player.onInterruptionBegin(t)},e.offInterruptionBegin=function(t){this._player.offInterruptionBegin(t)},e.onInterruptionEnd=function(t){this._player.onInterruptionEnd(t)},e.offInterruptionEnd=function(t){this._player.offInterruptionEnd(t)},e.onEnded=function(t){this._player.onEnded(t)},e.offEnded=function(t){this._player.offEnded(t)},K(t,[{key:"src",get:function(){return this._player.src}},{key:"type",get:function(){return this._player.type}},{key:"state",get:function(){return this._player.state}},{key:"loop",get:function(){return this._player.loop},set:function(t){this._player.loop=t}},{key:"volume",get:function(){return this._player.volume},set:function(t){this._player.volume=t}},{key:"duration",get:function(){return this._player.duration}},{key:"currentTime",get:function(){return this._player.currentTime}}]),t}();A3.maxAudioChannel=24;var b3=t("AudioClip",hc("cc.AudioClip")((y3=g3=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_duration",v3,it(e)),e._loadMode=$4.UNKNOWN_AUDIO,e._meta=null,e._player=null,e}Q(e,t);var n=e.prototype;return n.destroy=function(){var e,n=t.prototype.destroy.call(this);return null===(e=this._player)||void 0===e||e.destroy(),this._player=null,this._meta&&(this._meta.player=null),n},n.validate=function(){return!!this._meta},n.getDuration=function(){return this._duration?this._duration:this._meta?this._meta.duration:0},n.getCurrentTime=function(){return this._player?this._player.currentTime:0},n.getVolume=function(){return this._player?this._player.volume:0},n.getLoop=function(){return!!this._player&&this._player.loop},n.setCurrentTime=function(t){var e;null===(e=this._player)||void 0===e||e.seek(t).catch((function(){}))},n.setVolume=function(t){this._player&&(this._player.volume=t)},n.setLoop=function(t){this._player&&(this._player.loop=t)},n.play=function(){var t;null===(t=this._player)||void 0===t||t.play().catch((function(){}))},n.pause=function(){var t;null===(t=this._player)||void 0===t||t.pause().catch((function(){}))},n.stop=function(){var t;null===(t=this._player)||void 0===t||t.stop().catch((function(){}))},n.playOneShot=function(t){void 0===t&&(t=1),this._nativeAsset&&A3.loadOneShotAudio(this._nativeAsset.url,t).then((function(t){t.play()})).catch((function(){}))},K(e,[{key:"_nativeAsset",get:function(){return this._meta},set:function(t){this._meta=t,t?(this._loadMode=t.type,this._player=t.player):(this._meta=null,this._loadMode=$4.UNKNOWN_AUDIO,this._duration=0)}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,audioLoadMode:this.loadMode,ext:this._native,__isNative__:!0}}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.state:t3.INIT}}]),e}(Pu),g3.AudioType=$4,v3=st((m3=y3).prototype,"_duration",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),st(m3.prototype,"_nativeDep",[el],Object.getOwnPropertyDescriptor(m3.prototype,"_nativeDep"),m3.prototype),d3=m3))||d3);function T3(t,e,n){A3.load(t,{audioLoadMode:e.audioLoadMode}).then((function(e){var i={player:e,url:t,duration:e.duration,type:e.type};n(null,i)})).catch((function(t){n(t)}))}function E3(t,e,n,i){var r=new b3;r._nativeUrl=t,r._nativeAsset=e,r._duration=e.duration,i(null,r)}c.AudioClip=b3,PO.register({".mp3":T3,".ogg":T3,".wav":T3,".m4a":T3}),NO.register({".mp3":E3,".ogg":E3,".wav":E3,".m4a":E3});var w3,P3,I3,R3,D3,B3,M3,O3,N3,L3,F3,z3,G3,V3,U3,k3,H3,j3,W3,q3=new(function(){function t(){this._oneShotAudioInfoList=[],this._audioPlayerInfoList=[]}var e=t.prototype;return e._findIndex=function(t,e){return t.findIndex((function(t){return t.audio===e}))},e._tryAddPlaying=function(t,e){var n=this._findIndex(t,e);return n>-1?(t[n].playTime=performance.now(),!1):(t.push({audio:e,playTime:performance.now()}),!0)},e.addPlaying=function(t){if(t instanceof A3){if(this._tryAddPlaying(this._audioPlayerInfoList,t))return}else this._tryAddPlaying(this._oneShotAudioInfoList,t)},e._tryRemovePlaying=function(t,e){var n=this._findIndex(t,e);return-1!==n&&(ut(t,n),!0)},e.removePlaying=function(t){if(t instanceof A3){if(this._tryRemovePlaying(this._audioPlayerInfoList,t))return}else this._tryRemovePlaying(this._oneShotAudioInfoList,t)},e.discardOnePlayingIfNeeded=function(){var t;this._audioPlayerInfoList.length+this._oneShotAudioInfoList.length<A3.maxAudioChannel||(this._oneShotAudioInfoList.length>0?this._oneShotAudioInfoList.forEach((function(e){(!t||e.playTime<t.playTime)&&(t=e)})):this._audioPlayerInfoList.forEach((function(e){(!t||e.playTime<t.playTime)&&(t=e)})),t&&(t.audio.stop(),this.removePlaying(t.audio)))},t}());!function(t){t.STARTED="started",t.ENDED="ended"}(W3||(W3={}));var X3=function(e){return t({AudioSource:e,AudioSourceComponent:e}),e}((w3=hc("cc.AudioSource"),P3=wc(),I3=Ac(),R3=Wc(b3),D3=Wc(b3),B3=Bc(),M3=Bc(),O3=Bc(),N3=Mc(),L3=Bc(),w3(F3=P3(F3=I3((j3=H3=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_clip",G3,it(e)),e._player=null,at(e,"_loop",V3,it(e)),at(e,"_playOnAwake",U3,it(e)),at(e,"_volume",k3,it(e)),e._cachedCurrentTime=0,e._operationsBeforeLoading=[],e._isLoaded=!1,e._lastSetClip=null,e}Q(e,t);var n=e.prototype;return n._syncPlayer=function(){var t=this,e=this._clip;this._isLoaded=!1,this._lastSetClip!==e&&(e?e._nativeAsset?(this._lastSetClip=e,A3.load(e._nativeAsset.url,{audioLoadMode:e.loadMode}).then((function(n){t._lastSetClip===e?(t._isLoaded=!0,t._player&&(t._player.offEnded(),t._player.offInterruptionBegin(),t._player.offInterruptionEnd(),t._player.destroy()),t._player=n,n.onEnded((function(){q3.removePlaying(n),t.node.emit(W3.ENDED,t)})),n.onInterruptionBegin((function(){q3.removePlaying(n)})),n.onInterruptionEnd((function(){q3.addPlaying(n)})),t._syncStates()):n.destroy()})).catch((function(){}))):console.error("Invalid audio clip"):this._lastSetClip=null)},n.onLoad=function(){this._syncPlayer()},n.onEnable=function(){this._playOnAwake&&!this.playing&&this.play()},n.onDisable=function(){var t=this._getRootNode();(null==t?void 0:t._persistNode)||this.pause()},n.onDestroy=function(){var t;this.stop(),null===(t=this._player)||void 0===t||t.destroy(),this._player=null},n._getRootNode=function(){for(var t,e,n=this.node,i=null===(t=n)||void 0===t||null===(e=t.parent)||void 0===e?void 0:e.parent;i;){var r,o,a;i=null===(o=n=null===(r=n)||void 0===r?void 0:r.parent)||void 0===o||null===(a=o.parent)||void 0===a?void 0:a.parent}return n},n.play=function(){var t,e,n=this;this._isLoaded?(q3.discardOnePlayingIfNeeded(),this.state===t3.PLAYING&&(null===(e=this._player)||void 0===e||e.stop().catch((function(){}))),null===(t=this._player)||void 0===t||t.play().then((function(){q3.addPlaying(n._player),n.node.emit(W3.STARTED,n)})).catch((function(){}))):this._operationsBeforeLoading.push("play")},n.pause=function(){var t,e=this;this._isLoaded?null===(t=this._player)||void 0===t||t.pause().then((function(){q3.removePlaying(e._player)})).catch((function(){})):this._operationsBeforeLoading.push("pause")},n.stop=function(){var t,e=this;this._isLoaded?null===(t=this._player)||void 0===t||t.stop().then((function(){q3.removePlaying(e._player)})).catch((function(){})):this._operationsBeforeLoading.push("stop")},n.playOneShot=function(t,e){void 0===e&&(e=1),t._nativeAsset?A3.loadOneShotAudio(t._nativeAsset.url,this._volume*e,{audioLoadMode:t.loadMode}).then((function(t){q3.discardOnePlayingIfNeeded(),t.onPlay=function(){q3.addPlaying(t)},t.onEnd=function(){q3.removePlaying(t)},t.play()})).catch((function(){})):console.error("Invalid audio clip")},n._syncStates=function(){var t=this;this._player&&this._player.seek(this._cachedCurrentTime).then((function(){t._player&&(t._player.loop=t._loop,t._player.volume=t._volume,t._operationsBeforeLoading.forEach((function(e){var n;null===(n=t[e])||void 0===n||n.call(t)})),t._operationsBeforeLoading.length=0)})).catch((function(){}))},K(e,[{key:"clip",get:function(){return this._clip},set:function(t){t!==this._clip&&(this._clip=t,this._syncPlayer())}},{key:"loop",get:function(){return this._loop},set:function(t){this._loop=t,this._player&&(this._player.loop=t)}},{key:"playOnAwake",get:function(){return this._playOnAwake},set:function(t){this._playOnAwake=t}},{key:"volume",get:function(){return this._volume},set:function(t){Number.isNaN(t)?console.warn("illegal audio volume!"):(t=on(t,0,1),this._player?(this._player.volume=t,this._volume=this._player.volume):this._volume=t)}},{key:"currentTime",get:function(){return this._player?this._player.currentTime:this._cachedCurrentTime},set:function(t){var e;Number.isNaN(t)?console.warn("illegal audio time!"):(t=on(t,0,this.duration),this._cachedCurrentTime=t,null===(e=this._player)||void 0===e||e.seek(this._cachedCurrentTime).catch((function(){})))}},{key:"duration",get:function(){var t,e;return null!==(t=null===(e=this._clip)||void 0===e?void 0:e.getDuration())&&void 0!==t?t:this._player?this._player.currentTime:0}},{key:"state",get:function(){return this._player?this._player.state:t3.INIT}},{key:"playing",get:function(){return this.state===e.AudioState.PLAYING}}],[{key:"maxAudioChannel",get:function(){return A3.maxAudioChannel}}]),e}(Ku),H3.AudioState=t3,H3.EventType=W3,G3=st((z3=j3).prototype,"_clip",[R3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),V3=st(z3.prototype,"_loop",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),U3=st(z3.prototype,"_playOnAwake",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),k3=st(z3.prototype,"_volume",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),st(z3.prototype,"clip",[D3,B3],Object.getOwnPropertyDescriptor(z3.prototype,"clip"),z3.prototype),st(z3.prototype,"loop",[M3],Object.getOwnPropertyDescriptor(z3.prototype,"loop"),z3.prototype),st(z3.prototype,"playOnAwake",[O3],Object.getOwnPropertyDescriptor(z3.prototype,"playOnAwake"),z3.prototype),st(z3.prototype,"volume",[N3,L3],Object.getOwnPropertyDescriptor(z3.prototype,"volume"),z3.prototype),F3=z3))||F3)||F3)||F3));z(b3,"AudioClip",[{name:"PlayingState",newName:"AudioState",target:X3,targetName:"AudioSource"}]),V(b3.prototype,"AudioClip.prototype",["state","play","pause","stop","playOneShot","setCurrentTime","setVolume","setLoop","getCurrentTime","getVolume","getLoop"].map((function(t){return{name:t,suggest:"please use AudioSource.prototype."+t+" instead"}}))),c.AudioSourceComponent=X3,ee.setClassAlias(X3,"cc.AudioSourceComponent"),c.log=g,c.warn=y,c.error=x,c.assert=S,c._throw=b,c.logID=w,c.warnID=I,c.errorID=D,c.assertID=O,c.debug=j,c.path={join:du,extname:mu,mainFileName:vu,basename:gu,dirname:yu,changeExtname:xu,changeBasename:Su,_normalize:Cu,stripSep:Au,get sep(){return bu()}};var Y3=t("NodePool",function(){function t(t){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=t,this._pool=[]}var e=t.prototype;return e.size=function(){return this._pool.length},e.clear=function(){for(var t=this._pool.length,e=0;e<t;++e)this._pool[e].destroy();this._pool.length=0},e.put=function(t){if(t&&-1===this._pool.indexOf(t)){t.removeFromParent();var e=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;e&&e.unuse&&e.unuse(),this._pool.push(t)}},e.get=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];var i=this._pool.length-1;if(i<0)return null;var r=this._pool[i];this._pool.length=i;var o=this.poolHandlerComp?r.getComponent(this.poolHandlerComp):null;return o&&o.reuse&&o.reuse(arguments),r},t}());c.NodePool=Y3,c.renderer=wW;var K3,J3=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuDescriptorSet=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._layout=t.layout;var e=t.layout.gpuDescriptorSetLayout,n=e.bindings,i=e.descriptorIndices,r=e.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var o=[];this._gpuDescriptorSet={gpuDescriptors:o,descriptorIndices:i};for(var a=0;a<n.length;++a)for(var s=n[a],c=0;c<s.count;c++)o.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var t=this._gpuDescriptorSet.gpuDescriptors,e=0;e<t.length;++e)if(t[e].type&Qr){var n=this._buffers[e];n&&(t[e].gpuBuffer=n.gpuBuffer||n.gpuBufferView)}else t[e].type&Zr&&(this._textures[e]&&(t[e].gpuTexture=this._textures[e].gpuTexture),this._samplers[e]&&(t[e].gpuSampler=this._samplers[e].gpuSampler));this._isDirty=!1}},K(e,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),e}(vo);!function(t){t[t.RGBA16F_EXT=34842]="RGBA16F_EXT",t[t.RGB16F_EXT=34843]="RGB16F_EXT",t[t.RGBA32F_EXT=34836]="RGBA32F_EXT",t[t.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",t[t.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",t[t.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",t[t.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",t[t.SRGB_EXT=35904]="SRGB_EXT",t[t.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",t[t.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",t[t.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",t[t.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",t[t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",t[t.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",t[t.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",t[t.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",t[t.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",t[t.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",t[t.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",t[t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",t[t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",t[t.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",t[t.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",t[t.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",t[t.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(K3||(K3={}));var Q3=function(){function t(){}return t.setInstance=function(e){t._instance=e},K(t,null,[{key:"instance",get:function(){return t._instance}}]),t}();function Z3(t,e){switch(t){case ui.R8:return e.UNSIGNED_BYTE;case ui.R8SN:return e.BYTE;case ui.R8UI:return e.UNSIGNED_BYTE;case ui.R8I:return e.BYTE;case ui.R16F:return K3.HALF_FLOAT_OES;case ui.R16UI:return e.UNSIGNED_SHORT;case ui.R16I:return e.SHORT;case ui.R32F:return e.FLOAT;case ui.R32UI:return e.UNSIGNED_INT;case ui.R32I:return e.INT;case ui.RG8:return e.UNSIGNED_BYTE;case ui.RG8SN:return e.BYTE;case ui.RG8UI:return e.UNSIGNED_BYTE;case ui.RG8I:return e.BYTE;case ui.RG16F:return K3.HALF_FLOAT_OES;case ui.RG16UI:return e.UNSIGNED_SHORT;case ui.RG16I:return e.SHORT;case ui.RG32F:return e.FLOAT;case ui.RG32UI:return e.UNSIGNED_INT;case ui.RG32I:return e.INT;case ui.RGB8:case ui.SRGB8:return e.UNSIGNED_BYTE;case ui.RGB8SN:return e.BYTE;case ui.RGB8UI:return e.UNSIGNED_BYTE;case ui.RGB8I:return e.BYTE;case ui.RGB16F:return K3.HALF_FLOAT_OES;case ui.RGB16UI:return e.UNSIGNED_SHORT;case ui.RGB16I:return e.SHORT;case ui.RGB32F:return e.FLOAT;case ui.RGB32UI:return e.UNSIGNED_INT;case ui.RGB32I:return e.INT;case ui.BGRA8:case ui.RGBA8:case ui.SRGB8_A8:return e.UNSIGNED_BYTE;case ui.RGBA8SN:return e.BYTE;case ui.RGBA8UI:return e.UNSIGNED_BYTE;case ui.RGBA8I:return e.BYTE;case ui.RGBA16F:return K3.HALF_FLOAT_OES;case ui.RGBA16UI:return e.UNSIGNED_SHORT;case ui.RGBA16I:return e.SHORT;case ui.RGBA32F:return e.FLOAT;case ui.RGBA32UI:return e.UNSIGNED_INT;case ui.RGBA32I:return e.INT;case ui.R5G6B5:return e.UNSIGNED_SHORT_5_6_5;case ui.R11G11B10F:return e.FLOAT;case ui.RGB5A1:return e.UNSIGNED_SHORT_5_5_5_1;case ui.RGBA4:return e.UNSIGNED_SHORT_4_4_4_4;case ui.RGB10A2:return e.UNSIGNED_BYTE;case ui.RGB10A2UI:return e.UNSIGNED_INT;case ui.RGB9E5:return e.UNSIGNED_BYTE;case ui.DEPTH:return e.UNSIGNED_INT;case ui.DEPTH_STENCIL:return K3.UNSIGNED_INT_24_8_WEBGL;case ui.BC1:case ui.BC1_SRGB:case ui.BC2:case ui.BC2_SRGB:case ui.BC3:case ui.BC3_SRGB:case ui.BC4:return e.UNSIGNED_BYTE;case ui.BC4_SNORM:return e.BYTE;case ui.BC5:return e.UNSIGNED_BYTE;case ui.BC5_SNORM:return e.BYTE;case ui.BC6H_SF16:case ui.BC6H_UF16:return e.FLOAT;case ui.BC7:case ui.BC7_SRGB:case ui.ETC_RGB8:case ui.ETC2_RGB8:case ui.ETC2_SRGB8:case ui.ETC2_RGB8_A1:case ui.ETC2_SRGB8_A1:case ui.EAC_R11:return e.UNSIGNED_BYTE;case ui.EAC_R11SN:return e.BYTE;case ui.EAC_RG11:return e.UNSIGNED_BYTE;case ui.EAC_RG11SN:return e.BYTE;case ui.PVRTC_RGB2:case ui.PVRTC_RGBA2:case ui.PVRTC_RGB4:case ui.PVRTC_RGBA4:case ui.PVRTC2_2BPP:case ui.PVRTC2_4BPP:return e.UNSIGNED_BYTE;case ui.ASTC_RGBA_4X4:case ui.ASTC_RGBA_5X4:case ui.ASTC_RGBA_5X5:case ui.ASTC_RGBA_6X5:case ui.ASTC_RGBA_6X6:case ui.ASTC_RGBA_8X5:case ui.ASTC_RGBA_8X6:case ui.ASTC_RGBA_8X8:case ui.ASTC_RGBA_10X5:case ui.ASTC_RGBA_10X6:case ui.ASTC_RGBA_10X8:case ui.ASTC_RGBA_10X10:case ui.ASTC_RGBA_12X10:case ui.ASTC_RGBA_12X12:case ui.ASTC_SRGBA_4X4:case ui.ASTC_SRGBA_5X4:case ui.ASTC_SRGBA_5X5:case ui.ASTC_SRGBA_6X5:case ui.ASTC_SRGBA_6X6:case ui.ASTC_SRGBA_8X5:case ui.ASTC_SRGBA_8X6:case ui.ASTC_SRGBA_8X8:case ui.ASTC_SRGBA_10X5:case ui.ASTC_SRGBA_10X6:case ui.ASTC_SRGBA_10X8:case ui.ASTC_SRGBA_10X10:case ui.ASTC_SRGBA_12X10:case ui.ASTC_SRGBA_12X12:default:return e.UNSIGNED_BYTE}}function $3(t,e){switch(t){case _i.BOOL:return e.BOOL;case _i.BOOL2:return e.BOOL_VEC2;case _i.BOOL3:return e.BOOL_VEC3;case _i.BOOL4:return e.BOOL_VEC4;case _i.INT:return e.INT;case _i.INT2:return e.INT_VEC2;case _i.INT3:return e.INT_VEC3;case _i.INT4:return e.INT_VEC4;case _i.UINT:return e.UNSIGNED_INT;case _i.FLOAT:return e.FLOAT;case _i.FLOAT2:return e.FLOAT_VEC2;case _i.FLOAT3:return e.FLOAT_VEC3;case _i.FLOAT4:return e.FLOAT_VEC4;case _i.MAT2:return e.FLOAT_MAT2;case _i.MAT3:return e.FLOAT_MAT3;case _i.MAT4:return e.FLOAT_MAT4;case _i.SAMPLER2D:return e.SAMPLER_2D;case _i.SAMPLER_CUBE:return e.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),_i.UNKNOWN}}function t5(t){switch(t){case _i.BOOL:case _i.BOOL2:case _i.BOOL3:case _i.BOOL4:case _i.INT:case _i.INT2:case _i.INT3:case _i.INT4:case _i.UINT:return Int32Array;case _i.FLOAT:case _i.FLOAT2:case _i.FLOAT3:case _i.FLOAT4:case _i.MAT2:case _i.MAT3:case _i.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function e5(t,e){switch(t){case e.BOOL:return _i.BOOL;case e.BOOL_VEC2:return _i.BOOL2;case e.BOOL_VEC3:return _i.BOOL3;case e.BOOL_VEC4:return _i.BOOL4;case e.INT:return _i.INT;case e.INT_VEC2:return _i.INT2;case e.INT_VEC3:return _i.INT3;case e.INT_VEC4:return _i.INT4;case e.UNSIGNED_INT:return _i.UINT;case e.FLOAT:return _i.FLOAT;case e.FLOAT_VEC2:return _i.FLOAT2;case e.FLOAT_VEC3:return _i.FLOAT3;case e.FLOAT_VEC4:return _i.FLOAT4;case e.FLOAT_MAT2:return _i.MAT2;case e.FLOAT_MAT3:return _i.MAT3;case e.FLOAT_MAT4:return _i.MAT4;case e.SAMPLER_2D:return _i.SAMPLER2D;case e.SAMPLER_CUBE:return _i.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),_i.UNKNOWN}}function n5(t,e){switch(t){case e.BOOL:return 4;case e.BOOL_VEC2:return 8;case e.BOOL_VEC3:return 12;case e.BOOL_VEC4:return 16;case e.INT:return 4;case e.INT_VEC2:return 8;case e.INT_VEC3:return 12;case e.INT_VEC4:return 16;case e.UNSIGNED_INT:case e.FLOAT:return 4;case e.FLOAT_VEC2:return 8;case e.FLOAT_VEC3:return 12;case e.FLOAT_VEC4:case e.FLOAT_MAT2:return 16;case e.FLOAT_MAT3:return 36;case e.FLOAT_MAT4:return 64;case e.SAMPLER_2D:case e.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function i5(t,e){switch(t){case e.FLOAT_MAT2:return 2;case e.FLOAT_MAT3:return 3;case e.FLOAT_MAT4:return 4;default:return 1}}Q3._instance=null;var r5,o5=[512,513,514,515,516,517,518,519],a5=[0,7680,7681,7682,7683,5386,34055,34056],s5=[32774,32778,32779,32775,32776],c5=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(t){t[t.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",t[t.END_RENDER_PASS=1]="END_RENDER_PASS",t[t.BIND_STATES=2]="BIND_STATES",t[t.DRAW=3]="DRAW",t[t.UPDATE_BUFFER=4]="UPDATE_BUFFER",t[t.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",t[t.COUNT=6]="COUNT"}(r5||(r5={}));var l5=function(t){this.cmdType=void 0,this.refCount=0,this.cmdType=t},u5=function(t){function e(){var e;return(e=t.call(this,r5.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,e.gpuFramebuffer=null,e.renderArea=new Qi,e.clearFlag=Wi.NONE,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return Q(e,t),e.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},e}(l5),h5=function(t){function e(){var e;return(e=t.call(this,r5.BIND_STATES)||this).gpuPipelineState=null,e.gpuInputAssembler=null,e.gpuDescriptorSets=[],e.dynamicOffsets=[],e.dynamicStates=new Yr,e}return Q(e,t),e.prototype.clear=function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0},e}(l5),_5=function(t){function e(){var e;return(e=t.call(this,r5.DRAW)||this).drawInfo=new hr,e}return Q(e,t),e.prototype.clear=function(){},e}(l5),f5=function(t){function e(){var e;return(e=t.call(this,r5.UPDATE_BUFFER)||this).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return Q(e,t),e.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},e}(l5),p5=function(t){function e(){var e;return(e=t.call(this,r5.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,e.buffers=[],e.regions=[],e}return Q(e,t),e.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},e}(l5),d5=function(){function t(){this.cmds=new kl(1),this.beginRenderPassCmds=new kl(1),this.bindStatesCmds=new kl(1),this.drawCmds=new kl(1),this.updateBufferCmds=new kl(1),this.copyBufferToTextureCmds=new kl(1)}return t.prototype.clearCmds=function(t){this.beginRenderPassCmds.length&&(t.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(t.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(t.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(t.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(t.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},t}();function m5(t,e,n,i,r){if(e.usage&fi.UNIFORM)ArrayBuffer.isView(n)?e.vf32.set(n,i/Float32Array.BYTES_PER_ELEMENT):e.vf32.set(new Float32Array(n),i/Float32Array.BYTES_PER_ELEMENT);else if(e.usage&fi.INDIRECT){e.indirects.clearDraws();for(var o=n.drawInfos,a=0;a<o.length;++a)e.indirects.setDrawInfo(i+a,o[a])}else{var s=n,c=t.gl,l=t.stateCache;switch(e.glTarget){case c.ARRAY_BUFFER:t.extensions.useVAO&&l.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),v5.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer);break;case c.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&l.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),v5.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}r===s.byteLength?c.bufferSubData(e.glTarget,i,s):c.bufferSubData(e.glTarget,i,s.slice(0,r))}}var v5={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0};function g5(t,e,n,i,r,o,a){var s=t.gl,c=t.stateCache,l=0;if(n&&e){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height);var u=r.length;t.extensions.WEBGL_draw_buffers||(u=1);for(var h=0;h<u;++h){var _=e.colorAttachments[h];if(_.format!==ui.UNKNOWN)switch(_.loadOp){case Ri.LOAD:break;case Ri.CLEAR:c.bs.targets[0].blendColorMask!==Pi.ALL&&s.colorMask(!0,!0,!0,!0);var f=r[0];s.clearColor(f.x,f.y,f.z,f.w),l|=s.COLOR_BUFFER_BIT;break;case Ri.DISCARD:}}if(e.depthStencilAttachment&&e.depthStencilAttachment.format!==ui.UNKNOWN){switch(e.depthStencilAttachment.depthLoadOp){case Ri.LOAD:break;case Ri.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(o),l|=s.DEPTH_BUFFER_BIT;break;case Ri.DISCARD:}if(Jr[e.depthStencilAttachment.format].hasStencil)switch(e.depthStencilAttachment.stencilLoadOp){case Ri.LOAD:break;case Ri.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(a),l|=s.STENCIL_BUFFER_BIT;break;case Ri.DISCARD:}}if(l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var p=c.bs.targets[0].blendColorMask;if(p!==Pi.ALL){var d=(p&Pi.R)!==Pi.NONE,m=(p&Pi.G)!==Pi.NONE,v=(p&Pi.B)!==Pi.NONE,g=(p&Pi.A)!==Pi.NONE;s.colorMask(d,m,v,g)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function y5(t,e,n,i,r,o){var a,s,c,l=t.gl,u=t.stateCache,h=e&&e.gpuShader,_=!1;if(e&&v5.gpuPipelineState!==e){if(v5.gpuPipelineState=e,v5.glPrimitive=e.glPrimitive,e.gpuShader){var f=e.gpuShader.glProgram;u.glProgram!==f&&(l.useProgram(f),u.glProgram=f,_=!0)}var p=e.rs;if(p){if(u.rs.cullMode!==p.cullMode){switch(p.cullMode){case zi.NONE:l.disable(l.CULL_FACE);break;case zi.FRONT:l.enable(l.CULL_FACE),l.cullFace(l.FRONT);break;case zi.BACK:l.enable(l.CULL_FACE),l.cullFace(l.BACK)}u.rs.cullMode=p.cullMode}var d=p.isFrontFaceCCW;u.rs.isFrontFaceCCW!==d&&(l.frontFace(d?l.CCW:l.CW),u.rs.isFrontFaceCCW=d),u.rs.depthBias===p.depthBias&&u.rs.depthBiasSlop===p.depthBiasSlop||(l.polygonOffset(p.depthBias,p.depthBiasSlop),u.rs.depthBias=p.depthBias,u.rs.depthBiasSlop=p.depthBiasSlop),u.rs.lineWidth!==p.lineWidth&&(l.lineWidth(p.lineWidth),u.rs.lineWidth=p.lineWidth)}var m=e.dss;m&&(u.dss.depthTest!==m.depthTest&&(m.depthTest?l.enable(l.DEPTH_TEST):l.disable(l.DEPTH_TEST),u.dss.depthTest=m.depthTest),u.dss.depthWrite!==m.depthWrite&&(l.depthMask(m.depthWrite),u.dss.depthWrite=m.depthWrite),u.dss.depthFunc!==m.depthFunc&&(l.depthFunc(o5[m.depthFunc]),u.dss.depthFunc=m.depthFunc),u.dss.stencilTestFront===m.stencilTestFront&&u.dss.stencilTestBack===m.stencilTestBack||(m.stencilTestFront||m.stencilTestBack?l.enable(l.STENCIL_TEST):l.disable(l.STENCIL_TEST),u.dss.stencilTestFront=m.stencilTestFront,u.dss.stencilTestBack=m.stencilTestBack),u.dss.stencilFuncFront===m.stencilFuncFront&&u.dss.stencilRefFront===m.stencilRefFront&&u.dss.stencilReadMaskFront===m.stencilReadMaskFront||(l.stencilFuncSeparate(l.FRONT,o5[m.stencilFuncFront],m.stencilRefFront,m.stencilReadMaskFront),u.dss.stencilFuncFront=m.stencilFuncFront,u.dss.stencilRefFront=m.stencilRefFront,u.dss.stencilReadMaskFront=m.stencilReadMaskFront),u.dss.stencilFailOpFront===m.stencilFailOpFront&&u.dss.stencilZFailOpFront===m.stencilZFailOpFront&&u.dss.stencilPassOpFront===m.stencilPassOpFront||(l.stencilOpSeparate(l.FRONT,a5[m.stencilFailOpFront],a5[m.stencilZFailOpFront],a5[m.stencilPassOpFront]),u.dss.stencilFailOpFront=m.stencilFailOpFront,u.dss.stencilZFailOpFront=m.stencilZFailOpFront,u.dss.stencilPassOpFront=m.stencilPassOpFront),u.dss.stencilWriteMaskFront!==m.stencilWriteMaskFront&&(l.stencilMaskSeparate(l.FRONT,m.stencilWriteMaskFront),u.dss.stencilWriteMaskFront=m.stencilWriteMaskFront),u.dss.stencilFuncBack===m.stencilFuncBack&&u.dss.stencilRefBack===m.stencilRefBack&&u.dss.stencilReadMaskBack===m.stencilReadMaskBack||(l.stencilFuncSeparate(l.BACK,o5[m.stencilFuncBack],m.stencilRefBack,m.stencilReadMaskBack),u.dss.stencilFuncBack=m.stencilFuncBack,u.dss.stencilRefBack=m.stencilRefBack,u.dss.stencilReadMaskBack=m.stencilReadMaskBack),u.dss.stencilFailOpBack===m.stencilFailOpBack&&u.dss.stencilZFailOpBack===m.stencilZFailOpBack&&u.dss.stencilPassOpBack===m.stencilPassOpBack||(l.stencilOpSeparate(l.BACK,a5[m.stencilFailOpBack],a5[m.stencilZFailOpBack],a5[m.stencilPassOpBack]),u.dss.stencilFailOpBack=m.stencilFailOpBack,u.dss.stencilZFailOpBack=m.stencilZFailOpBack,u.dss.stencilPassOpBack=m.stencilPassOpBack),u.dss.stencilWriteMaskBack!==m.stencilWriteMaskBack&&(l.stencilMaskSeparate(l.BACK,m.stencilWriteMaskBack),u.dss.stencilWriteMaskBack=m.stencilWriteMaskBack));var v=e.bs;if(v){u.bs.isA2C!==v.isA2C&&(v.isA2C?l.enable(l.SAMPLE_ALPHA_TO_COVERAGE):l.disable(l.SAMPLE_ALPHA_TO_COVERAGE),u.bs.isA2C=v.isA2C),u.bs.blendColor.x===v.blendColor.x&&u.bs.blendColor.y===v.blendColor.y&&u.bs.blendColor.z===v.blendColor.z&&u.bs.blendColor.w===v.blendColor.w||(l.blendColor(v.blendColor.x,v.blendColor.y,v.blendColor.z,v.blendColor.w),u.bs.blendColor.x=v.blendColor.x,u.bs.blendColor.y=v.blendColor.y,u.bs.blendColor.z=v.blendColor.z,u.bs.blendColor.w=v.blendColor.w);var g=v.targets[0],y=u.bs.targets[0];y.blend!==g.blend&&(g.blend?l.enable(l.BLEND):l.disable(l.BLEND),y.blend=g.blend),y.blendEq===g.blendEq&&y.blendAlphaEq===g.blendAlphaEq||(l.blendEquationSeparate(s5[g.blendEq],s5[g.blendAlphaEq]),y.blendEq=g.blendEq,y.blendAlphaEq=g.blendAlphaEq),y.blendSrc===g.blendSrc&&y.blendDst===g.blendDst&&y.blendSrcAlpha===g.blendSrcAlpha&&y.blendDstAlpha===g.blendDstAlpha||(l.blendFuncSeparate(c5[g.blendSrc],c5[g.blendDst],c5[g.blendSrcAlpha],c5[g.blendDstAlpha]),y.blendSrc=g.blendSrc,y.blendDst=g.blendDst,y.blendSrcAlpha=g.blendSrcAlpha,y.blendDstAlpha=g.blendDstAlpha),y.blendColorMask!==g.blendColorMask&&(l.colorMask((g.blendColorMask&Pi.R)!==Pi.NONE,(g.blendColorMask&Pi.G)!==Pi.NONE,(g.blendColorMask&Pi.B)!==Pi.NONE,(g.blendColorMask&Pi.A)!==Pi.NONE),y.blendColorMask=g.blendColorMask)}}if(e&&e.gpuPipelineLayout&&h){for(var S=h.glBlocks.length,C=e.gpuPipelineLayout.dynamicOffsetIndices,A=0;A<S;A++){var b=h.glBlocks[A],T=i[b.set],E=T&&T.descriptorIndices[b.binding],w=E>=0&&T.gpuDescriptors[E],P=null,I=0;if(w&&w.gpuBuffer){var R=w.gpuBuffer,D=C[b.set],B=D&&D[b.binding];B>=0&&(I=r[B]),"vf32"in R?P=R.vf32:(I+=R.offset,P=R.gpuBuffer.vf32),I>>=2}if(P)for(var M=b.glActiveUniforms.length,O=0;O<M;O++){var N=b.glActiveUniforms[O];switch(N.glType){case l.BOOL:case l.INT:for(var L=0;L<N.array.length;++L){var F=N.offset+I+L;if(P[F]!==N.array[L]){for(var z=L,G=F;z<N.array.length;++z,++G)N.array[z]=P[G];l.uniform1iv(N.glLoc,N.array);break}}break;case l.BOOL_VEC2:case l.INT_VEC2:for(var V=0;V<N.array.length;++V){var U=N.offset+I+V;if(P[U]!==N.array[V]){for(var k=V,H=U;k<N.array.length;++k,++H)N.array[k]=P[H];l.uniform2iv(N.glLoc,N.array);break}}break;case l.BOOL_VEC3:case l.INT_VEC3:for(var j=0;j<N.array.length;++j){var W=N.offset+I+j;if(P[W]!==N.array[j]){for(var q=j,X=W;q<N.array.length;++q,++X)N.array[q]=P[X];l.uniform3iv(N.glLoc,N.array);break}}break;case l.BOOL_VEC4:case l.INT_VEC4:for(var Y=0;Y<N.array.length;++Y){var K=N.offset+I+Y;if(P[K]!==N.array[Y]){for(var J=Y,Q=K;J<N.array.length;++J,++Q)N.array[J]=P[Q];l.uniform4iv(N.glLoc,N.array);break}}break;case l.FLOAT:for(var Z=0;Z<N.array.length;++Z){var $=N.offset+I+Z;if(P[$]!==N.array[Z]){for(var tt=Z,et=$;tt<N.array.length;++tt,++et)N.array[tt]=P[et];l.uniform1fv(N.glLoc,N.array);break}}break;case l.FLOAT_VEC2:for(var nt=0;nt<N.array.length;++nt){var it=N.offset+I+nt;if(P[it]!==N.array[nt]){for(var rt=nt,ot=it;rt<N.array.length;++rt,++ot)N.array[rt]=P[ot];l.uniform2fv(N.glLoc,N.array);break}}break;case l.FLOAT_VEC3:for(var at=0;at<N.array.length;++at){var st=N.offset+I+at;if(P[st]!==N.array[at]){for(var ct=at,lt=st;ct<N.array.length;++ct,++lt)N.array[ct]=P[lt];l.uniform3fv(N.glLoc,N.array);break}}break;case l.FLOAT_VEC4:for(var ut=0;ut<N.array.length;++ut){var ht=N.offset+I+ut;if(P[ht]!==N.array[ut]){for(var _t=ut,ft=ht;_t<N.array.length;++_t,++ft)N.array[_t]=P[ft];l.uniform4fv(N.glLoc,N.array);break}}break;case l.FLOAT_MAT2:for(var pt=0;pt<N.array.length;++pt){var dt=N.offset+I+pt;if(P[dt]!==N.array[pt]){for(var mt=pt,vt=dt;mt<N.array.length;++mt,++vt)N.array[mt]=P[vt];l.uniformMatrix2fv(N.glLoc,!1,N.array);break}}break;case l.FLOAT_MAT3:for(var gt=0;gt<N.array.length;++gt){var yt=N.offset+I+gt;if(P[yt]!==N.array[gt]){for(var xt=gt,St=yt;xt<N.array.length;++xt,++St)N.array[xt]=P[St];l.uniformMatrix3fv(N.glLoc,!1,N.array);break}}break;case l.FLOAT_MAT4:for(var Ct=0;Ct<N.array.length;++Ct){var At=N.offset+I+Ct;if(P[At]!==N.array[Ct]){for(var bt=Ct,Tt=At;bt<N.array.length;++bt,++Tt)N.array[bt]=P[Tt];l.uniformMatrix4fv(N.glLoc,!1,N.array);break}}}}else x("Buffer binding '"+b.name+"' at set "+b.set+" binding "+b.binding+" is not bounded")}for(var Et=h.glSamplerTextures.length,wt=0;wt<Et;wt++)for(var Pt=h.glSamplerTextures[wt],It=i[Pt.set],Rt=It&&It.descriptorIndices[Pt.binding],Dt=Rt>=0&&It.gpuDescriptors[Rt],Bt=Pt.units.length,Mt=0;Mt<Bt;Mt++){var Ot=Pt.units[Mt];if(Dt&&Dt.gpuSampler){if(Dt.gpuTexture&&Dt.gpuTexture.size>0){var Nt=Dt.gpuTexture,Lt=u.glTexUnits[Ot];Lt.glTexture!==Nt.glTexture&&(u.texUnit!==Ot&&(l.activeTexture(l.TEXTURE0+Ot),u.texUnit=Ot),Nt.glTexture?l.bindTexture(Nt.glTarget,Nt.glTexture):l.bindTexture(Nt.glTarget,t.nullTex2D.gpuTexture.glTexture),Lt.glTexture=Nt.glTexture);var Ft=Dt.gpuSampler;Nt.isPowerOf2?(a=Ft.glWrapS,s=Ft.glWrapT):(a=l.CLAMP_TO_EDGE,s=l.CLAMP_TO_EDGE),c=Nt.isPowerOf2?Nt.mipLevel<=1&&(Ft.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Ft.glMinFilter===l.LINEAR_MIPMAP_LINEAR)?l.LINEAR:Ft.glMinFilter:Ft.glMinFilter===l.LINEAR||Ft.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Ft.glMinFilter===l.LINEAR_MIPMAP_LINEAR?l.LINEAR:l.NEAREST,Nt.glWrapS!==a&&(u.texUnit!==Ot&&(l.activeTexture(l.TEXTURE0+Ot),u.texUnit=Ot),l.texParameteri(Nt.glTarget,l.TEXTURE_WRAP_S,a),Nt.glWrapS=a),Nt.glWrapT!==s&&(u.texUnit!==Ot&&(l.activeTexture(l.TEXTURE0+Ot),u.texUnit=Ot),l.texParameteri(Nt.glTarget,l.TEXTURE_WRAP_T,s),Nt.glWrapT=s),Nt.glMinFilter!==c&&(u.texUnit!==Ot&&(l.activeTexture(l.TEXTURE0+Ot),u.texUnit=Ot),l.texParameteri(Nt.glTarget,l.TEXTURE_MIN_FILTER,c),Nt.glMinFilter=c),Nt.glMagFilter!==Ft.glMagFilter&&(u.texUnit!==Ot&&(l.activeTexture(l.TEXTURE0+Ot),u.texUnit=Ot),l.texParameteri(Nt.glTarget,l.TEXTURE_MAG_FILTER,Ft.glMagFilter),Nt.glMagFilter=Ft.glMagFilter)}Dt=It.gpuDescriptors[++Rt]}else x("Sampler binding '"+Pt.name+"' at set "+Pt.set+" binding "+Pt.binding+" index "+Mt+" is not bounded")}}if(n&&h&&(_||v5.gpuInputAssembler!==n)){v5.gpuInputAssembler=n;var zt=t.extensions.ANGLE_instanced_arrays;if(t.extensions.useVAO){var Gt=t.extensions.OES_vertex_array_object,Vt=n.glVAOs.get(h.glProgram);if(!Vt){var Ut;Vt=Gt.createVertexArrayOES(),n.glVAOs.set(h.glProgram,Vt),Gt.bindVertexArrayOES(Vt),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null;for(var kt=h.glInputs.length,Ht=0;Ht<kt;Ht++){var jt=h.glInputs[Ht];Ut=null;for(var Wt=n.glAttribs.length,qt=0;qt<Wt;qt++){var Xt=n.glAttribs[qt];if(Xt.name===jt.name){Ut=Xt;break}}if(Ut){u.glArrayBuffer!==Ut.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,Ut.glBuffer),u.glArrayBuffer=Ut.glBuffer);for(var Yt=0;Yt<Ut.componentCount;++Yt){var Kt=jt.glLoc+Yt,Jt=Ut.offset+Ut.size*Yt;l.enableVertexAttribArray(Kt),u.glCurrentAttribLocs[Kt]=!0,l.vertexAttribPointer(Kt,Ut.count,Ut.glType,Ut.isNormalized,Ut.stride,Jt),zt&&zt.vertexAttribDivisorANGLE(Kt,Ut.isInstanced?1:0)}}}var Qt=n.gpuIndexBuffer;Qt&&l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,Qt.glBuffer),Gt.bindVertexArrayOES(null),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null}u.glVAO!==Vt&&(Gt.bindVertexArrayOES(Vt),u.glVAO=Vt)}else{for(var Zt=0;Zt<t.capabilities.maxVertexAttributes;++Zt)u.glCurrentAttribLocs[Zt]=!1;for(var $t=h.glInputs.length,te=0;te<$t;te++){for(var ee=h.glInputs[te],ne=null,ie=n.glAttribs.length,re=0;re<ie;re++){var oe=n.glAttribs[re];if(oe.name===ee.name){ne=oe;break}}if(ne){u.glArrayBuffer!==ne.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,ne.glBuffer),u.glArrayBuffer=ne.glBuffer);for(var ae=0;ae<ne.componentCount;++ae){var se=ee.glLoc+ae,ce=ne.offset+ne.size*ae;!u.glEnabledAttribLocs[se]&&se>=0&&(l.enableVertexAttribArray(se),u.glEnabledAttribLocs[se]=!0),u.glCurrentAttribLocs[se]=!0,l.vertexAttribPointer(se,ne.count,ne.glType,ne.isNormalized,ne.stride,ce),zt&&zt.vertexAttribDivisorANGLE(se,ne.isInstanced?1:0)}}}var le=n.gpuIndexBuffer;le&&u.glElementArrayBuffer!==le.glBuffer&&(l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,le.glBuffer),u.glElementArrayBuffer=le.glBuffer);for(var ue=0;ue<t.capabilities.maxVertexAttributes;++ue)u.glEnabledAttribLocs[ue]!==u.glCurrentAttribLocs[ue]&&(l.disableVertexAttribArray(ue),u.glEnabledAttribLocs[ue]=!1)}}if(e&&e.dynamicStates.length)for(var he=e.dynamicStates.length,_e=0;_e<he;_e++)switch(e.dynamicStates[_e]){case Gi.LINE_WIDTH:u.rs.lineWidth!==o.lineWidth&&(l.lineWidth(o.lineWidth),u.rs.lineWidth=o.lineWidth);break;case Gi.DEPTH_BIAS:u.rs.depthBias===o.depthBiasConstant&&u.rs.depthBiasSlop===o.depthBiasSlope||(l.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),u.rs.depthBias=o.depthBiasConstant,u.rs.depthBiasSlop=o.depthBiasSlope);break;case Gi.BLEND_CONSTANTS:var fe=o.blendConstant;u.bs.blendColor.x===fe.x&&u.bs.blendColor.y===fe.y&&u.bs.blendColor.z===fe.z&&u.bs.blendColor.w===fe.w||(l.blendColor(fe.x,fe.y,fe.z,fe.w),u.bs.blendColor.copy(fe));break;case Gi.STENCIL_WRITE_MASK:var pe=o.stencilStatesFront,de=o.stencilStatesBack;u.dss.stencilWriteMaskFront!==pe.writeMask&&(l.stencilMaskSeparate(l.FRONT,pe.writeMask),u.dss.stencilWriteMaskFront=pe.writeMask),u.dss.stencilWriteMaskBack!==de.writeMask&&(l.stencilMaskSeparate(l.BACK,de.writeMask),u.dss.stencilWriteMaskBack=de.writeMask);break;case Gi.STENCIL_COMPARE_MASK:var me=o.stencilStatesFront,ve=o.stencilStatesBack;u.dss.stencilRefFront===me.reference&&u.dss.stencilReadMaskFront===me.compareMask||(l.stencilFuncSeparate(l.FRONT,o5[u.dss.stencilFuncFront],me.reference,me.compareMask),u.dss.stencilRefFront=me.reference,u.dss.stencilReadMaskFront=me.compareMask),u.dss.stencilRefBack===ve.reference&&u.dss.stencilReadMaskBack===ve.compareMask||(l.stencilFuncSeparate(l.BACK,o5[u.dss.stencilFuncBack],ve.reference,ve.compareMask),u.dss.stencilRefBack=ve.reference,u.dss.stencilReadMaskBack=ve.compareMask)}}function x5(t,e){var n=t.gl,i=t.extensions,r=i.ANGLE_instanced_arrays,o=i.WEBGL_multi_draw,a=v5.gpuInputAssembler,s=v5.glPrimitive;if(a){var c=a.gpuIndexBuffer;if(a.gpuIndirectBuffer){var l=a.gpuIndirectBuffer.indirects;if(l.drawByIndex){for(var u=0;u<l.drawCount;u++)l.byteOffsets[u]=l.offsets[u]*c.stride;if(o)l.instancedDraw?o.multiDrawElementsInstancedWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.instances,0,l.drawCount):o.multiDrawElementsWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.drawCount);else for(var h=0;h<l.drawCount;h++)l.instances[h]&&r?r.drawElementsInstancedANGLE(s,l.counts[h],a.glIndexType,l.byteOffsets[h],l.instances[h]):n.drawElements(s,l.counts[h],a.glIndexType,l.byteOffsets[h])}else if(o)l.instancedDraw?o.multiDrawArraysInstancedWEBGL(s,l.offsets,0,l.counts,0,l.instances,0,l.drawCount):o.multiDrawArraysWEBGL(s,l.offsets,0,l.counts,0,l.drawCount);else for(var _=0;_<l.drawCount;_++)l.instances[_]&&r?r.drawArraysInstancedANGLE(s,l.offsets[_],l.counts[_],l.instances[_]):n.drawArrays(s,l.offsets[_],l.counts[_])}else if(e.instanceCount&&r)if(c){if(e.indexCount>0){var f=e.firstIndex*c.stride;r.drawElementsInstancedANGLE(s,e.indexCount,a.glIndexType,f,e.instanceCount)}}else e.vertexCount>0&&r.drawArraysInstancedANGLE(s,e.firstVertex,e.vertexCount,e.instanceCount);else if(c){if(e.indexCount>0){var p=e.firstIndex*c.stride;n.drawElements(s,e.indexCount,a.glIndexType,p)}}else e.vertexCount>0&&n.drawArrays(s,e.firstVertex,e.vertexCount)}}var S5=new Array(r5.COUNT);function C5(t,e){S5.fill(0);for(var n=0;n<e.cmds.length;++n){var i=e.cmds.array[n],r=S5[i]++;switch(i){case r5.BEGIN_RENDER_PASS:var o=e.beginRenderPassCmds.array[r];g5(t,o.gpuRenderPass,o.gpuFramebuffer,o.renderArea,o.clearColors,o.clearDepth,o.clearStencil);break;case r5.BIND_STATES:var a=e.bindStatesCmds.array[r];y5(t,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case r5.DRAW:x5(t,e.drawCmds.array[r].drawInfo);break;case r5.UPDATE_BUFFER:var s=e.updateBufferCmds.array[r];m5(t,s.gpuBuffer,s.buffer,s.offset,s.size);break;case r5.COPY_BUFFER_TO_TEXTURE:var c=e.copyBufferToTextureCmds.array[r];A5(t,c.buffers,c.gpuTexture,c.regions)}}}function A5(t,e,n,i){var r=t.gl,o=t.stateCache.glTexUnits[t.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=1,c=1,l=0,u=Jr[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];s=_.texExtent.width,c=_.texExtent.height;var f=e[a++];u?n.glInternalFmt===K3.COMPRESSED_RGB_ETC1_WEBGL||t.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,n.glInternalFmt,s,c,0,f):r.compressedTexSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,f):r.texSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,n.glType,f)}break;case r.TEXTURE_CUBE_MAP:for(var p=0;p<i.length;p++){var d=i[p],m=d.texSubres.baseArrayLayer+d.texSubres.layerCount;for(l=d.texSubres.baseArrayLayer;l<m;++l){s=d.texExtent.width,c=d.texExtent.height;var v=e[a++];u?n.glInternalFmt===K3.COMPRESSED_RGB_ETC1_WEBGL||t.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&yi.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var b5=function(){function t(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var e=t.prototype;return e.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},e.setDrawInfo=function(t,e){this._ensureCapacity(t),this.drawByIndex=e.indexCount>0,this.instancedDraw=!!e.instanceCount,this.drawCount=Math.max(t+1,this.drawCount),this.drawByIndex?(this.counts[t]=e.indexCount,this.offsets[t]=e.firstIndex):(this.counts[t]=e.vertexCount,this.offsets[t]=e.firstVertex),this.instances[t]=Math.max(1,e.instanceCount)},e._ensureCapacity=function(t){if(!(this._capacity>t)){this._capacity=r(t);var e=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),e.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=e,this.offsets=n,this.instances=i}},t}(),T5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuBuffer=null,e._gpuBufferView=null,e._uniformBuffer=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){if("buffer"in t){this._isBufferView=!0;var e=t.buffer;this._usage=e.usage,this._memUsage=e.memUsage,this._size=this._stride=t.range,this._count=1,this._flags=e.flags,this._gpuBufferView={gpuBuffer:e.gpuBuffer,offset:t.offset,range:t.range}}else this._usage=t.usage,this._memUsage=t.memUsage,this._size=t.size,this._stride=Math.max(t.stride||this._size,1),this._count=this._size/this._stride,this._flags=t.flags,this._usage&fi.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:new b5,glTarget:0,glBuffer:null},this._usage&fi.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(t,e){var n=t.gl,i=t.stateCache,r=e.memUsage&mi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(e.usage&fi.VERTEX){e.glTarget=n.ARRAY_BUFFER;var o=n.createBuffer();o&&(e.glBuffer=o,e.size>0&&(t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),v5.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer),n.bufferData(n.ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null))}else if(e.usage&fi.INDEX){e.glTarget=n.ELEMENT_ARRAY_BUFFER;var a=n.createBuffer();a&&(e.glBuffer=a,e.size>0&&(t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),v5.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null))}else e.usage&fi.UNIFORM?(e.glTarget=n.NONE,e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer))):(e.usage&fi.INDIRECT||e.usage&fi.TRANSFER_DST||e.usage&fi.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=n.NONE)}(Q3.instance,this._gpuBuffer),Q3.instance.memoryStatus.bufferSize+=this._size},n.destroy=function(){this._gpuBuffer&&(function(t,e){var n=t.gl,i=t.stateCache;if(e.glBuffer){switch(e.glTarget){case n.ARRAY_BUFFER:t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),t.stateCache.glVAO=null),v5.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),t.stateCache.glVAO=null),v5.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null}n.deleteBuffer(e.glBuffer),e.glBuffer=null}}(Q3.instance,this._gpuBuffer),Q3.instance.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)},n.resize=function(t){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var e=this._size;e!==t&&(this._size=t,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(t)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=t,t>0&&(function(t,e){var n=t.gl,i=t.stateCache,r=e.memUsage&mi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;e.usage&fi.VERTEX?(t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),v5.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,e.glBuffer),e.buffer?n.bufferData(n.ARRAY_BUFFER,e.buffer,r):n.bufferData(n.ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null):e.usage&fi.INDEX?(t.extensions.useVAO&&i.glVAO&&(t.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),v5.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.glBuffer),e.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):e.usage&fi.UNIFORM?e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer)):(e.usage&fi.INDIRECT||e.usage&fi.TRANSFER_DST||e.usage&fi.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=n.NONE)}(Q3.instance,this._gpuBuffer),Q3.instance.memoryStatus.bufferSize-=e,Q3.instance.memoryStatus.bufferSize+=t)))}},n.update=function(t,e){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==e?e:this._usage&fi.INDIRECT?0:t.byteLength,m5(Q3.instance,this._gpuBuffer,t,0,n))},K(e,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}}]),e}(so),E5=function(){function t(t,e){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(e),this._freeCmds=new kl(e);for(var n=0;n<e;++n)this._frees[n]=new t;this._freeIdx=e-1}var e=t.prototype;return e.alloc=function(t){if(this._freeIdx<0){var e=2*this._frees.length,n=this._frees;this._frees=new Array(e);for(var i=e-n.length,r=0;r<i;++r)this._frees[r]=new t;for(var o=i,a=0;o<e;++o,++a)this._frees[o]=n[a];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},e.free=function(t){0==--t.refCount&&this._freeCmds.push(t)},e.freeCmds=function(t){for(var e=0;e<t.length;++e)0==--t.array[e].refCount&&this._freeCmds.push(t.array[e])},e.release=function(){for(var t=0;t<this._freeCmds.length;++t){var e=this._freeCmds.array[t];e.clear(),this._frees[++this._freeIdx]=e}this._freeCmds.clear()},t}(),w5=function(){function t(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new E5(u5,1),this.bindStatesCmdPool=new E5(h5,1),this.drawCmdPool=new E5(_5,1),this.updateBufferCmdPool=new E5(f5,1),this.copyBufferToTextureCmdPool=new E5(p5,1)}var e=t.prototype;return e.clearCmds=function(t){t.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(t.beginRenderPassCmds),t.beginRenderPassCmds.clear()),t.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(t.bindStatesCmds),t.bindStatesCmds.clear()),t.drawCmds.length&&(this.drawCmdPool.freeCmds(t.drawCmds),t.drawCmds.clear()),t.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(t.updateBufferCmds),t.updateBufferCmds.clear()),t.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(t.copyBufferToTextureCmds),t.copyBufferToTextureCmds.clear()),t.cmds.clear()},e.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},t}(),P5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).cmdPackage=new d5,e._cmdAllocator=new w5,e._isInRenderPass=!1,e._curGPUPipelineState=null,e._curGPUInputAssembler=null,e._curGPUDescriptorSets=[],e._curDynamicOffsets=Array(8).fill(0),e._curDynamicStates=new Yr,e._isStateInvalied=!1,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._type=t.type,this._queue=t.queue;for(var e=Q3.instance.bindingMappingInfo.bufferOffsets.length,n=0;n<e;n++)this._curGPUDescriptorSets.push(null)},n.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},n.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(t,e,n,i,r,o){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(u5);a.gpuRenderPass=t.gpuRenderPass,a.gpuFramebuffer=e.gpuFramebuffer,a.renderArea=n,a.clearColors.length=i.length;for(var s=0;s<i.length;++s)a.clearColors[s]=i[s];a.clearDepth=r,a.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(r5.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(t){var e=t.gpuPipelineState;e!==this._curGPUPipelineState&&(this._curGPUPipelineState=e,this._isStateInvalied=!0)},n.bindDescriptorSet=function(t,e,n){var i=e.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[t]&&(this._curGPUDescriptorSets[t]=i,this._isStateInvalied=!0),n){var r,o=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(o){for(var a=this._curDynamicOffsets,s=o.dynamicOffsetOffsets[t],c=0;c<n.length;c++)a[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(t){var e=t.gpuInputAssembler;this._curGPUInputAssembler=e,this._isStateInvalied=!0},n.setViewport=function(t){var e=this._curDynamicStates.viewport;e.left===t.left&&e.top===t.top&&e.width===t.width&&e.height===t.height&&e.minDepth===t.minDepth&&e.maxDepth===t.maxDepth||(e.left=t.left,e.top=t.top,e.width=t.width,e.height=t.height,e.minDepth=t.minDepth,e.maxDepth=t.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(t){var e=this._curDynamicStates.scissor;e.x===t.x&&e.y===t.y&&e.width===t.width&&e.height===t.height||(e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,this._isStateInvalied=!0)},n.setLineWidth=function(t){this._curDynamicStates.lineWidth!==t&&(this._curDynamicStates.lineWidth=t,this._isStateInvalied=!0)},n.setDepthBias=function(t,e,n){var i=this._curDynamicStates;i.depthBiasConstant===t&&i.depthBiasClamp===e&&i.depthBiasSlope===n||(i.depthBiasConstant=t,i.depthBiasClamp=e,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(t){var e=this._curDynamicStates.blendConstant;e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w||(e.copy(t),this._isStateInvalied=!0)},n.setDepthBound=function(t,e){var n=this._curDynamicStates;n.depthMinBounds===t&&n.depthMaxBounds===e||(n.depthMinBounds=t,n.depthMaxBounds=e,this._isStateInvalied=!0)},n.setStencilWriteMask=function(t,e){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;t&Vi.FRONT&&n.writeMask!==e&&(n.writeMask=e,this._isStateInvalied=!0),t&Vi.BACK&&i.writeMask!==e&&(i.writeMask=e,this._isStateInvalied=!0)},n.setStencilCompareMask=function(t,e,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;t&Vi.FRONT&&(i.compareMask===n&&i.reference===e||(i.reference=e,i.compareMask=n,this._isStateInvalied=!0)),t&Vi.BACK&&(r.compareMask===n&&r.reference===e||(r.reference=e,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(t){if(this._type===ji.PRIMARY&&this._isInRenderPass||this._type===ji.SECONDARY){this._isStateInvalied&&this.bindStates();var e="drawInfo"in t?t.drawInfo:t,n=this._cmdAllocator.drawCmdPool.alloc(_5);n.drawInfo.copy(e),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push(r5.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;var i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(t,e,n){if(this._type===ji.PRIMARY&&!this._isInRenderPass||this._type===ji.SECONDARY){var i=t.gpuBuffer;if(i){var r,o=this._cmdAllocator.updateBufferCmdPool.alloc(f5),a=0;t.usage&fi.INDIRECT||(a=void 0!==n?n:e.byteLength),r=e,o.gpuBuffer=i,o.buffer=r,o.offset=0,o.size=a,this.cmdPackage.updateBufferCmds.push(o),this.cmdPackage.cmds.push(r5.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(t,e,n){if(this._type===ji.PRIMARY&&!this._isInRenderPass||this._type===ji.SECONDARY){var i=e.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(p5);r&&(r.gpuTexture=i,r.regions=n,r.buffers=t,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(r5.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(t,e){for(var n=0;n<e;++n){for(var i=t[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var o=i.cmdPackage.beginRenderPassCmds.array[r];++o.refCount,this.cmdPackage.beginRenderPassCmds.push(o)}for(var a=0;a<i.cmdPackage.bindStatesCmds.length;++a){var s=i.cmdPackage.bindStatesCmds.array[a];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var _=0;_<i.cmdPackage.copyBufferToTextureCmds.length;++_){var f=i.cmdPackage.copyBufferToTextureCmds.array[_];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var t=this._cmdAllocator.bindStatesCmdPool.alloc(h5);t&&(t.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(t.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(t.dynamicOffsets,this._curDynamicOffsets),t.gpuInputAssembler=this._curGPUInputAssembler,t.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(t),this.cmdPackage.cmds.push(r5.BIND_STATES),this._isStateInvalied=!1)},e}(co),I5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuFramebuffer=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._renderPass=t.renderPass,this._colorTextures=t.colorTextures||[],this._depthStencilTexture=t.depthStencilTexture||null;for(var e=[],n=0;n<t.colorTextures.length;++n){var i=t.colorTextures[n];i&&e.push(i.gpuTexture)}var r=null;t.depthStencilTexture&&(r=t.depthStencilTexture.gpuTexture);var o=Number.MAX_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:t.renderPass.gpuRenderPass,gpuColorTextures:e,gpuDepthStencilTexture:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?o:this.gpuColorTextures[0].width},set width(t){o=t},get height(){return this.isOffscreen?a:this.gpuColorTextures[0].height},set height(t){a=t}},function(t,e){for(var n=0;n<e.gpuColorTextures.length;++n)if(e.gpuColorTextures[n].isSwapchainTexture)return void(e.isOffscreen=!1);var i=t.gl,r=[],o=i.createFramebuffer();if(o){e.glFramebuffer=o,t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.glFramebuffer);for(var a=0;a<e.gpuColorTextures.length;++a){var s=e.gpuColorTextures[a];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+a),e.width=Math.min(e.width,s.width),e.height=Math.min(e.height,s.height))}var c=e.gpuDepthStencilTexture;if(c){var l=Jr[c.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,c.glRenderbuffer),e.width=Math.min(e.width,c.width),e.height=Math.min(e.height,c.height)}t.extensions.WEBGL_draw_buffers&&t.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(r);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.stateCache.glFramebuffer)}}(Q3.instance,this._gpuFramebuffer)},n.destroy=function(){var t,e;this._gpuFramebuffer&&(t=Q3.instance,(e=this._gpuFramebuffer).glFramebuffer&&(t.gl.deleteFramebuffer(e.glFramebuffer),t.stateCache.glFramebuffer===e.glFramebuffer&&(t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,null),t.stateCache.glFramebuffer=null),e.glFramebuffer=null),this._gpuFramebuffer=null)},K(e,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),e}(ho),R5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuInputAssembler=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){if(0!==t.vertexBuffers.length){if(this._attributes=t.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=t.vertexBuffers,t.indexBuffer)this._indexBuffer=t.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var e=this._vertexBuffers[0];this._drawInfo.vertexCount=e.size/e.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=t.indirectBuffer||null;for(var n=new Array(t.vertexBuffers.length),i=0;i<t.vertexBuffers.length;++i){var r=t.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var o=null,a=0;if(t.indexBuffer&&(o=t.indexBuffer.gpuBuffer))switch(o.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Error index buffer stride.")}var s=null;t.indirectBuffer&&(s=t.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:t.attributes,gpuVertexBuffers:n,gpuIndexBuffer:o,gpuIndirectBuffer:s,glAttribs:[],glIndexType:a,glVAOs:new Map},function(t,e){var n=t.gl;e.glAttribs=new Array(e.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<e.attributes.length;++r){var o=e.attributes[r],a=void 0!==o.stream?o.stream:0,s=e.gpuVertexBuffers[a],c=Z3(o.format,n),l=Jr[o.format].size;e.glAttribs[r]={name:o.name,glBuffer:s.glBuffer,glType:c,size:l,count:Jr[o.format].count,stride:s.stride,componentCount:i5(c,n),isNormalized:void 0!==o.isNormalized&&o.isNormalized,isInstanced:void 0!==o.isInstanced&&o.isInstanced,offset:i[a]},i[a]+=l}}(Q3.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},n.destroy=function(){var t=Q3.instance;this._gpuInputAssembler&&t.extensions.useVAO&&function(t,e){for(var n=e.glVAOs.values(),i=n.next(),r=t.extensions.OES_vertex_array_object,o=t.stateCache.glVAO;!i.done;)r.deleteVertexArrayOES(i.value),o===i.value&&(r.bindVertexArrayOES(null),o=null),i=n.next();t.stateCache.glVAO=o,e.glVAOs.clear()}(t,this._gpuInputAssembler),this._gpuInputAssembler=null},K(e,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),e}(mo),D5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuDescriptorSetLayout=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){Array.prototype.push.apply(this._bindings,t.bindings);for(var e=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var o=this._bindings[r];i.push(e),e+=o.count,o.binding>n&&(n=o.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var a=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,a[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&$r)for(var _=0;_<h.count;_++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:a,descriptorCount:e}},n.destroy=function(){this._bindings.length=0},K(e,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),e}(go),B5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuPipelineLayout=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){Array.prototype.push.apply(this._setLayouts,t.setLayouts);for(var e=[],n=[],i=0,r=[],o=0;o<this._setLayouts.length;o++){for(var a=this._setLayouts[o],s=a.gpuDescriptorSetLayout.dynamicBindings,c=Array(a.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(a.gpuDescriptorSetLayout),e.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:e,dynamicOffsetCount:i,dynamicOffsetOffsets:r}},n.destroy=function(){this._setLayouts.length=0},K(e,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),e}(yo),M5=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],O5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuPipelineState=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._primitive=t.primitive,this._shader=t.shader,this._pipelineLayout=t.pipelineLayout;var e=this._bs;if(t.blendState){var n=t.blendState,i=n.targets;i&&i.forEach((function(t,n){e.setTarget(n,t)})),void 0!==n.isA2C&&(e.isA2C=n.isA2C),void 0!==n.isIndepend&&(e.isIndepend=n.isIndepend),void 0!==n.blendColor&&(e.blendColor=n.blendColor)}Object.assign(this._rs,t.rasterizerState),Object.assign(this._dss,t.depthStencilState),this._is=t.inputState,this._renderPass=t.renderPass,this._dynamicStates=t.dynamicStates;for(var r=[],o=0;o<31;o++)this._dynamicStates&1<<o&&r.push(1<<o);this._gpuPipelineState={glPrimitive:M5[t.primitive],gpuShader:t.shader.gpuShader,gpuPipelineLayout:t.pipelineLayout.gpuPipelineLayout,rs:t.rasterizerState,dss:t.depthStencilState,bs:t.blendState,gpuRenderPass:t.renderPass.gpuRenderPass,dynamicStates:r}},n.destroy=function(){this._gpuPipelineState=null},K(e,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),e}(To),N5=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.beginRenderPass=function(t,e,n,i,r,o){g5(Q3.instance,t.gpuRenderPass,e.gpuFramebuffer,n,i,r,o),this._isInRenderPass=!0},n.draw=function(t){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var e="drawInfo"in t?t.drawInfo:t;x5(Q3.instance,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;var n=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.setViewport=function(t){var e=Q3.instance,n=e.stateCache,i=e.gl;n.viewport.left===t.left&&n.viewport.top===t.top&&n.viewport.width===t.width&&n.viewport.height===t.height||(i.viewport(t.left,t.top,t.width,t.height),n.viewport.left=t.left,n.viewport.top=t.top,n.viewport.width=t.width,n.viewport.height=t.height)},n.setScissor=function(t){var e=Q3.instance,n=e.stateCache,i=e.gl;n.scissorRect.x===t.x&&n.scissorRect.y===t.y&&n.scissorRect.width===t.width&&n.scissorRect.height===t.height||(i.scissor(t.x,t.y,t.width,t.height),n.scissorRect.x=t.x,n.scissorRect.y=t.y,n.scissorRect.width=t.width,n.scissorRect.height=t.height)},n.updateBuffer=function(t,e,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=t.gpuBuffer;r&&(i=void 0!==n?n:t.usage&fi.INDIRECT?0:e.byteLength,m5(Q3.instance,r,e,0,i))}},n.copyBuffersToTexture=function(t,e,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=e.gpuTexture;i&&A5(Q3.instance,t,i,n)}},n.execute=function(t,e){for(var n=0;n<e;++n){var i=t[n];C5(Q3.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){y5(Q3.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},e}(P5),L5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).numDrawCalls=0,e.numInstances=0,e.numTris=0,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._type=t.type},n.destroy=function(){},n.submit=function(t){for(var e=t.length,n=0;n<e;n++){var i=t[n];this.numDrawCalls+=i.numDrawCalls,this.numInstances+=i.numInstances,this.numTris+=i.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},e}(Eo),F5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuRenderPass=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._colorInfos=t.colorAttachments,this._depthStencilInfo=t.depthStencilAttachment,this._subpasses=t.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},K(e,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),e}(wo),z5=[10497,33648,33071,33071],G5=function(t){function e(e,n){var i;(i=t.call(this,e,n)||this)._gpuSampler=null;var r,o,a=i._info.minFilter,s=i._info.magFilter,c=i._info.mipFilter;r=a===Ci.LINEAR||a===Ci.ANISOTROPIC?c===Ci.LINEAR||c===Ci.ANISOTROPIC?9987:c===Ci.POINT?9985:9729:c===Ci.LINEAR||c===Ci.ANISOTROPIC?9986:c===Ci.POINT?9984:9728,o=s===Ci.LINEAR||s===Ci.ANISOTROPIC?9729:9728;var l=z5[i._info.addressU],u=z5[i._info.addressV],h=z5[i._info.addressW];return i._gpuSampler={glMinFilter:r,glMagFilter:o,glWrapS:l,glWrapT:u,glWrapR:h},i}return Q(e,t),K(e,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),e}(Po),V5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuShader=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._name=t.name,this._stages=t.stages,this._attributes=t.attributes,this._blocks=t.blocks,this._samplers=t.samplers,this._gpuShader={name:t.name,blocks:t.blocks.slice(),samplerTextures:t.samplerTextures.slice(),subpassInputs:t.subpassInputs.slice(),gpuStages:new Array(t.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var e=0;e<t.stages.length;++e){var n=t.stages[e];this._gpuShader.gpuStages[e]={type:n.stage,source:n.source,glShader:null}}!function(t,e){for(var n=t.gl,i=function(t){var i=e.gpuStages[t],r=0,o="",a=1;switch(i.type){case Ii.VERTEX:o="VertexShader",r=n.VERTEX_SHADER;break;case Ii.FRAGMENT:o="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(o+" in '"+e.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+a+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<e.gpuStages.length;c++){var l=e.gpuStages[t];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<e.gpuStages.length;r++){var o=i(r);if("object"==typeof o)return o.v}var a=n.createProgram();if(a){e.glProgram=a;for(var s=0;s<e.gpuStages.length;s++){var c=e.gpuStages[s];n.attachShader(e.glProgram,c.glShader)}if(n.linkProgram(e.glProgram),t.extensions.destroyShadersImmediately)for(var l=0;l<e.gpuStages.length;l++){var u=e.gpuStages[l];u.glShader&&(n.detachShader(e.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(e.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+e.name+"'."),void console.error(n.getProgramInfoLog(e.glProgram));C("Shader '"+e.name+"' compilation succeeded.");var h=n.getProgramParameter(e.glProgram,n.ACTIVE_ATTRIBUTES);e.glInputs=new Array(h);for(var _=0;_<h;++_){var f=n.getActiveAttrib(e.glProgram,_);if(f){var p,d=f.name.indexOf("[");p=-1!==d?f.name.substr(0,d):f.name;var m=n.getAttribLocation(e.glProgram,p),v=e5(f.type,n),g=n5(f.type,n);e.glInputs[_]={binding:m,name:p,type:v,stride:g,count:f.size,size:g*f.size,glType:f.type,glLoc:m}}}if(e.blocks.length>0){e.glBlocks=new Array(e.blocks.length);for(var y=0;y<e.blocks.length;++y){var x=e.blocks[y],S={set:x.set,binding:x.binding,name:x.name,size:0,glUniforms:new Array(x.members.length),glActiveUniforms:[]};e.glBlocks[y]=S;for(var A=0;A<x.members.length;++A){var b=x.members[A],T=$3(b.type,n),E=n5(T,n),w=E*b.count;S.glUniforms[A]={binding:-1,name:b.name,type:b.type,stride:E,count:b.count,size:w,offset:0,glType:T,glLoc:null,array:null}}}}for(var P=0;P<e.subpassInputs.length;++P){var I=e.subpassInputs[P];e.samplerTextures.push(new yr(I.set,I.binding,I.name,_i.SAMPLER2D,I.count))}if(e.samplerTextures.length>0){e.glSamplerTextures=new Array(e.samplerTextures.length);for(var R=0;R<e.samplerTextures.length;++R){var D=e.samplerTextures[R];e.glSamplerTextures[R]={set:D.set,binding:D.binding,name:D.name,type:D.type,count:D.count,units:[],glUnits:null,glType:$3(D.type,n),glLoc:null}}}for(var B=n.getProgramParameter(e.glProgram,n.ACTIVE_UNIFORMS),M=0;M<B;++M){var O=n.getActiveUniform(e.glProgram,M);if(O&&O.type!==n.SAMPLER_2D&&O.type!==n.SAMPLER_CUBE){var N=n.getUniformLocation(e.glProgram,O.name);if(t.extensions.isLocationActive(N)){var L,F=O.name.indexOf("[");L=-1!==F?O.name.substr(0,F):O.name;for(var z=0;z<e.glBlocks.length;z++)for(var G=e.glBlocks[z],V=0;V<G.glUniforms.length;V++){var U=G.glUniforms[V];if(U.name===L){U.glLoc=N,U.count=O.size,U.size=U.stride*U.count,U.array=new(t5(U.type))(U.size/4),G.glActiveUniforms.push(U);break}}}}}for(var k=0;k<e.glBlocks.length;k++)for(var H=e.glBlocks[k],j=0;j<H.glUniforms.length;j++){var W=H.glUniforms[j];W.offset=H.size/4,H.size+=W.size}for(var q=[],X=[],Y=t.bindingMappingInfo,K=t.stateCache.texUnitCacheMap,J=0,Q=0;Q<e.blocks.length;++Q)e.blocks[Q].set===Y.flexibleSet&&J++;for(var Z=0,$=0;$<e.samplerTextures.length;++$){var tt=e.samplerTextures[$],et=n.getUniformLocation(e.glProgram,tt.name);if(t.extensions.isLocationActive(et)&&(q.push(e.glSamplerTextures[$]),X.push(et)),void 0===K[tt.name]){var nt=tt.binding+Y.samplerOffsets[tt.set]+Z;tt.set===Y.flexibleSet&&(nt-=J),K[tt.name]=nt%t.capabilities.maxTextureUnits,Z+=tt.count-1}}if(q.length){for(var it=[],rt=0;rt<q.length;++rt){var ot=q[rt],at=K[ot.name];if(void 0!==at){ot.glLoc=X[rt];for(var st=0;st<ot.count;++st){for(;it[at];)at=(at+1)%t.capabilities.maxTextureUnits;ot.units.push(at),it[at]=!0}}}for(var ct=0,lt=0;lt<q.length;++lt){var ut=q[lt];if(!t.extensions.isLocationActive(ut.glLoc)){ut.glLoc=X[lt];for(var ht=0;ht<ut.count;++ht){for(;it[ct];)ct=(ct+1)%t.capabilities.maxTextureUnits;void 0===K[ut.name]&&(K[ut.name]=ct),ut.units.push(ct),it[ct]=!0}}}t.stateCache.glProgram!==e.glProgram&&n.useProgram(e.glProgram);for(var _t=0;_t<q.length;_t++){var ft=q[_t];ft.glUnits=new Int32Array(ft.units),n.uniform1iv(ft.glLoc,ft.glUnits)}t.stateCache.glProgram!==e.glProgram&&n.useProgram(t.stateCache.glProgram)}for(var pt=0;pt<e.glBlocks.length;)e.glBlocks[pt].glActiveUniforms.length?pt++:(e.glBlocks[pt]=e.glBlocks[e.glBlocks.length-1],e.glBlocks.length--);e.glSamplerTextures=q}}(Q3.instance,this._gpuShader)},n.destroy=function(){this._gpuShader&&(function(t,e){if(e.glProgram){var n=t.gl;if(!t.extensions.destroyShadersImmediately)for(var i=0;i<e.gpuStages.length;i++){var r=e.gpuStages[i];r.glShader&&(n.detachShader(e.glProgram,r.glShader),n.deleteShader(r.glShader),r.glShader=null)}n.deleteProgram(e.glProgram),t.stateCache.glProgram===e.glProgram&&(t.gl.useProgram(null),t.stateCache.glProgram=null),e.glProgram=null}}(Q3.instance,this._gpuShader),this._gpuShader=null)},K(e,[{key:"gpuShader",get:function(){return this._gpuShader}}]),e}(Io),U5=function(){function t(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new rr,this.scissorRect=new Qi(0,0,0,0),this.rs=new xo,this.dss=new So,this.bs=new Ao,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return t.prototype.initialize=function(t,e){for(var n=0;n<t;++n)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=e,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=e,this.glCurrentAttribLocs.fill(!1)},t}(),k5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuTexture=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t,e){"texture"in t?console.log("WebGL does not support texture view."):(this._type=t.type,this._usage=t.usage,this._format=t.format,this._width=t.width,this._height=t.height,this._depth=t.depth,this._layerCount=t.layerCount,this._levelCount=t.levelCount,this._samples=t.samples,this._flags=t.flags,this._isPowerOf2=to(this._width)&&to(this._height),this._size=no(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:e||!1},function(t,e){var n=t.gl;e.glFormat=e.glInternalFmt=function(t,e){switch(t){case ui.A8:return e.ALPHA;case ui.L8:return e.LUMINANCE;case ui.LA8:return e.LUMINANCE_ALPHA;case ui.RGB8:case ui.RGB16F:case ui.RGB32F:return e.RGB;case ui.BGRA8:case ui.RGBA8:case ui.SRGB8_A8:case ui.RGBA16F:case ui.RGBA32F:return e.RGBA;case ui.R5G6B5:return e.RGB;case ui.RGB5A1:case ui.RGBA4:return e.RGBA;case ui.DEPTH:return e.DEPTH_COMPONENT;case ui.DEPTH_STENCIL:return e.DEPTH_STENCIL;case ui.BC1:return K3.COMPRESSED_RGB_S3TC_DXT1_EXT;case ui.BC1_ALPHA:return K3.COMPRESSED_RGBA_S3TC_DXT1_EXT;case ui.BC1_SRGB:return K3.COMPRESSED_SRGB_S3TC_DXT1_EXT;case ui.BC1_SRGB_ALPHA:return K3.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case ui.BC2:return K3.COMPRESSED_RGBA_S3TC_DXT3_EXT;case ui.BC2_SRGB:return K3.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case ui.BC3:return K3.COMPRESSED_RGBA_S3TC_DXT5_EXT;case ui.BC3_SRGB:return K3.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case ui.ETC_RGB8:return K3.COMPRESSED_RGB_ETC1_WEBGL;case ui.ETC2_RGB8:return K3.COMPRESSED_RGB8_ETC2;case ui.ETC2_SRGB8:return K3.COMPRESSED_SRGB8_ETC2;case ui.ETC2_RGB8_A1:return K3.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case ui.ETC2_SRGB8_A1:return K3.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case ui.ETC2_RGBA8:return K3.COMPRESSED_RGBA8_ETC2_EAC;case ui.ETC2_SRGB8_A8:return K3.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case ui.EAC_R11:return K3.COMPRESSED_R11_EAC;case ui.EAC_R11SN:return K3.COMPRESSED_SIGNED_R11_EAC;case ui.EAC_RG11:return K3.COMPRESSED_RG11_EAC;case ui.EAC_RG11SN:return K3.COMPRESSED_SIGNED_RG11_EAC;case ui.PVRTC_RGB2:return K3.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case ui.PVRTC_RGBA2:return K3.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case ui.PVRTC_RGB4:return K3.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case ui.PVRTC_RGBA4:return K3.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case ui.ASTC_RGBA_4X4:return K3.COMPRESSED_RGBA_ASTC_4x4_KHR;case ui.ASTC_RGBA_5X4:return K3.COMPRESSED_RGBA_ASTC_5x4_KHR;case ui.ASTC_RGBA_5X5:return K3.COMPRESSED_RGBA_ASTC_5x5_KHR;case ui.ASTC_RGBA_6X5:return K3.COMPRESSED_RGBA_ASTC_6x5_KHR;case ui.ASTC_RGBA_6X6:return K3.COMPRESSED_RGBA_ASTC_6x6_KHR;case ui.ASTC_RGBA_8X5:return K3.COMPRESSED_RGBA_ASTC_8x5_KHR;case ui.ASTC_RGBA_8X6:return K3.COMPRESSED_RGBA_ASTC_8x6_KHR;case ui.ASTC_RGBA_8X8:return K3.COMPRESSED_RGBA_ASTC_8x8_KHR;case ui.ASTC_RGBA_10X5:return K3.COMPRESSED_RGBA_ASTC_10x5_KHR;case ui.ASTC_RGBA_10X6:return K3.COMPRESSED_RGBA_ASTC_10x6_KHR;case ui.ASTC_RGBA_10X8:return K3.COMPRESSED_RGBA_ASTC_10x8_KHR;case ui.ASTC_RGBA_10X10:return K3.COMPRESSED_RGBA_ASTC_10x10_KHR;case ui.ASTC_RGBA_12X10:return K3.COMPRESSED_RGBA_ASTC_12x10_KHR;case ui.ASTC_RGBA_12X12:return K3.COMPRESSED_RGBA_ASTC_12x12_KHR;case ui.ASTC_SRGBA_4X4:return K3.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case ui.ASTC_SRGBA_5X4:return K3.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case ui.ASTC_SRGBA_5X5:return K3.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case ui.ASTC_SRGBA_6X5:return K3.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case ui.ASTC_SRGBA_6X6:return K3.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case ui.ASTC_SRGBA_8X5:return K3.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case ui.ASTC_SRGBA_8X6:return K3.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case ui.ASTC_SRGBA_8X8:return K3.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case ui.ASTC_SRGBA_10X5:return K3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case ui.ASTC_SRGBA_10X6:return K3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case ui.ASTC_SRGBA_10X8:return K3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case ui.ASTC_SRGBA_10X10:return K3.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case ui.ASTC_SRGBA_12X10:return K3.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case ui.ASTC_SRGBA_12X12:return K3.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),e.RGBA}}(e.format,n),e.glType=Z3(e.format,n);var i=e.width,r=e.height;switch(e.type){case vi.TEX2D:if(e.glTarget=n.TEXTURE_2D,e.isSwapchainTexture)break;var o=Math.max(i,r);if(o>t.capabilities.maxTextureSize&&D(9100,o,t.capabilities.maxTextureSize),!t.extensions.WEBGL_depth_texture&&Jr[e.format].hasDepth)e.glInternalFmt=function(t,e){switch(t){case ui.R5G6B5:return e.RGB565;case ui.RGB5A1:return e.RGB5_A1;case ui.RGBA4:return e.RGBA4;case ui.RGBA16F:return K3.RGBA16F_EXT;case ui.RGBA32F:return K3.RGBA32F_EXT;case ui.SRGB8_A8:return K3.SRGB8_ALPHA8_EXT;case ui.DEPTH:return e.DEPTH_COMPONENT16;case ui.DEPTH_STENCIL:return e.DEPTH_STENCIL;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),e.RGBA}}(e.format,n),e.glRenderbuffer=n.createRenderbuffer(),e.size>0&&(t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,e.glInternalFmt,i,r));else if(e.glTexture=n.createTexture(),e.size>0){var a=t.stateCache.glTexUnits[t.stateCache.texUnit];if(a.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_2D,e.glTexture),a.glTexture=e.glTexture),Jr[e.format].isCompressed)for(var s=0;s<e.mipLevel;++s){var c=eo(e.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,e.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<e.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,e.glInternalFmt,i,r,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1);e.isPowerOf2?(e.glWrapS=n.REPEAT,e.glWrapT=n.REPEAT):(e.glWrapS=n.CLAMP_TO_EDGE,e.glWrapT=n.CLAMP_TO_EDGE),e.glMinFilter=n.LINEAR,e.glMagFilter=n.LINEAR,n.texParameteri(e.glTarget,n.TEXTURE_WRAP_S,e.glWrapS),n.texParameteri(e.glTarget,n.TEXTURE_WRAP_T,e.glWrapT),n.texParameteri(e.glTarget,n.TEXTURE_MIN_FILTER,e.glMinFilter),n.texParameteri(e.glTarget,n.TEXTURE_MAG_FILTER,e.glMagFilter)}break;case vi.CUBE:e.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);if(h>t.capabilities.maxCubeMapTextureSize&&D(9100,h,t.capabilities.maxTextureSize),e.glTexture=n.createTexture(),e.size>0){var _=t.stateCache.glTexUnits[t.stateCache.texUnit];if(_.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,e.glTexture),_.glTexture=e.glTexture),Jr[e.format].isCompressed)for(var f=0;f<6;++f){i=e.width,r=e.height;for(var p=0;p<e.mipLevel;++p){var d=eo(e.format,i,r,1),m=new Uint8Array(d);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,p,e.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=e.width,r=e.height;for(var g=0;g<e.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,e.glInternalFmt,i,r,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}e.isPowerOf2?(e.glWrapS=n.REPEAT,e.glWrapT=n.REPEAT):(e.glWrapS=n.CLAMP_TO_EDGE,e.glWrapT=n.CLAMP_TO_EDGE),e.glMinFilter=n.LINEAR,e.glMagFilter=n.LINEAR,n.texParameteri(e.glTarget,n.TEXTURE_WRAP_S,e.glWrapS),n.texParameteri(e.glTarget,n.TEXTURE_WRAP_T,e.glWrapT),n.texParameteri(e.glTarget,n.TEXTURE_MIN_FILTER,e.glMinFilter),n.texParameteri(e.glTarget,n.TEXTURE_MAG_FILTER,e.glMagFilter)}break;default:console.error("Unsupported TextureType, create texture failed."),e.type=vi.TEX2D,e.glTarget=n.TEXTURE_2D}}(Q3.instance,this._gpuTexture),Q3.instance.memoryStatus.textureSize+=this._size)},n.destroy=function(){this._gpuTexture&&(function(t,e){var n=t.gl;if(e.glTexture){var i=t.stateCache.glTexUnits,r=t.stateCache.texUnit;n.deleteTexture(e.glTexture);for(var o=0;o<i.length;o++)i[o].glTexture===e.glTexture&&(n.activeTexture(n.TEXTURE0+o),r=o,n.bindTexture(e.glTarget,null),i[o].glTexture=null);t.stateCache.texUnit=r,e.glTexture=null}if(e.glRenderbuffer){var a=t.stateCache.glRenderbuffer;n.deleteRenderbuffer(e.glRenderbuffer),a===e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,null),a=null),e.glRenderbuffer=null}}(Q3.instance,this._gpuTexture),Q3.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(t,e){var n=this._size;this._width=t,this._height=e,this._size=no(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=t,this._gpuTexture.height=e,this._gpuTexture.size=this._size,function(t,e){if(e.size){var n=t.gl,i=e.width,r=e.height;switch(e.type){case vi.TEX2D:e.glTarget=n.TEXTURE_2D;var o=Math.max(i,r);if(o>t.capabilities.maxTextureSize&&D(9100,o,t.capabilities.maxTextureSize),e.glRenderbuffer)t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,e.glInternalFmt,i,r);else if(e.glTexture){var a=t.stateCache.glTexUnits[t.stateCache.texUnit];if(a.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_2D,e.glTexture),a.glTexture=e.glTexture),Jr[e.format].isCompressed)for(var s=0;s<e.mipLevel;++s){var c=eo(e.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,e.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<e.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,e.glInternalFmt,i,r,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;case vi.CUBE:e.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);h>t.capabilities.maxCubeMapTextureSize&&D(9100,h,t.capabilities.maxTextureSize);var _=t.stateCache.glTexUnits[t.stateCache.texUnit];if(_.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,e.glTexture),_.glTexture=e.glTexture),Jr[e.format].isCompressed)for(var f=0;f<6;++f){i=e.width,r=e.height;for(var p=0;p<e.mipLevel;++p){var d=eo(e.format,i,r,1),m=new Uint8Array(d);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,p,e.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=e.width,r=e.height;for(var g=0;g<e.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,e.glInternalFmt,i,r,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),e.type=vi.TEX2D,e.glTarget=n.TEXTURE_2D}}}(Q3.instance,this._gpuTexture),Q3.instance.memoryStatus.textureSize-=n,Q3.instance.memoryStatus.textureSize+=this._size)},n.initAsSwapchainTexture=function(t){var e=new pr;e.format=t.format,e.usage=Jr[t.format].hasDepth?gi.DEPTH_STENCIL_ATTACHMENT:gi.COLOR_ATTACHMENT,e.width=t.width,e.height=t.height,this.initialize(e,!0)},K(e,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),e}(Ro),H5="webglcontextlost";function j5(t,e){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=t.getExtension(n[i]+e);if(r)return r}return null}function W5(t){var e={EXT_texture_filter_anisotropic:j5(t,"EXT_texture_filter_anisotropic"),EXT_blend_minmax:j5(t,"EXT_blend_minmax"),EXT_frag_depth:j5(t,"EXT_frag_depth"),EXT_shader_texture_lod:j5(t,"EXT_shader_texture_lod"),EXT_sRGB:j5(t,"EXT_sRGB"),OES_vertex_array_object:j5(t,"OES_vertex_array_object"),EXT_color_buffer_half_float:j5(t,"EXT_color_buffer_half_float"),WEBGL_color_buffer_float:j5(t,"WEBGL_color_buffer_float"),WEBGL_compressed_texture_etc1:j5(t,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:j5(t,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:j5(t,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_s3tc:j5(t,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:j5(t,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:j5(t,"WEBGL_debug_shaders"),WEBGL_draw_buffers:j5(t,"WEBGL_draw_buffers"),WEBGL_lose_context:j5(t,"WEBGL_lose_context"),WEBGL_depth_texture:j5(t,"WEBGL_depth_texture"),OES_texture_half_float:j5(t,"OES_texture_half_float"),OES_texture_half_float_linear:j5(t,"OES_texture_half_float_linear"),OES_texture_float:j5(t,"OES_texture_float"),OES_texture_float_linear:j5(t,"OES_texture_float_linear"),OES_standard_derivatives:j5(t,"OES_standard_derivatives"),OES_element_index_uint:j5(t,"OES_element_index_uint"),ANGLE_instanced_arrays:j5(t,"ANGLE_instanced_arrays"),WEBGL_debug_renderer_info:j5(t,"WEBGL_debug_renderer_info"),WEBGL_multi_draw:null,WEBGL_compressed_texture_astc:null,destroyShadersImmediately:!0,noCompressedTexSubImage2D:!1,isLocationActive:function(t){return!!t},useVAO:!1};return hu.os===nu.IOS&&14===hu.osMainVersion&&hu.isBrowser||(e.WEBGL_compressed_texture_astc=j5(t,"WEBGL_compressed_texture_astc")),hu.os!==nu.ANDROID&&hu.os!==nu.IOS&&(e.WEBGL_multi_draw=j5(t,"WEBGL_multi_draw")),hu.browserType===$l.UC&&(e.ANGLE_instanced_arrays=null),hu.os===nu.IOS&&hu.osMainVersion<=10&&(e.destroyShadersImmediately=!1),e.OES_vertex_array_object&&(e.useVAO=!0),e}var q5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).stateCache=new U5,e.cmdAllocator=new w5,e.nullTex2D=null,e.nullTexCube=null,e._canvas=null,e._webGLContextLostHandler=null,e._extensions=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._canvas=t.windowHandle,this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(H5,this._onWebGLContextLost);var e=Q3.instance.gl;this.stateCache.initialize(Q3.instance.capabilities.maxTextureUnits,Q3.instance.capabilities.maxVertexAttributes),this._extensions=W5(e),function(t){t.activeTexture(t.TEXTURE0),t.pixelStorei(t.PACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.bindFramebuffer(t.FRAMEBUFFER,null),t.enable(t.SCISSOR_TEST),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.frontFace(t.CCW),t.disable(t.POLYGON_OFFSET_FILL),t.polygonOffset(0,0),t.enable(t.DEPTH_TEST),t.depthMask(!0),t.depthFunc(t.LESS),t.depthRange(0,1),t.stencilFuncSeparate(t.FRONT,t.ALWAYS,1,65535),t.stencilOpSeparate(t.FRONT,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.FRONT,65535),t.stencilFuncSeparate(t.BACK,t.ALWAYS,1,65535),t.stencilOpSeparate(t.BACK,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.BACK,65535),t.disable(t.STENCIL_TEST),t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.BLEND),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ZERO,t.ONE,t.ZERO),t.colorMask(!0,!0,!0,!0),t.blendColor(0,0,0,0)}(e);var n=ui.RGBA8,i=ui.DEPTH_STENCIL,r=e.getParameter(e.DEPTH_BITS),o=e.getParameter(e.STENCIL_BITS);r&&o?i=ui.DEPTH_STENCIL:r&&(i=ui.DEPTH),this._colorTexture=new k5,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:t.width,height:t.height}),this._depthStencilTexture=new k5,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:t.width,height:t.height}),this.nullTex2D=Q3.instance.createTexture(new pr(vi.TEX2D,gi.SAMPLED,ui.RGBA8,2,2,yi.GEN_MIPMAP)),this.nullTexCube=Q3.instance.createTexture(new pr(vi.CUBE,gi.SAMPLED,ui.RGBA8,2,2,yi.GEN_MIPMAP,6));var a=new ir;a.texExtent.width=2,a.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),Q3.instance.copyBuffersToTexture([s],this.nullTex2D,[a]),a.texSubres.layerCount=6,Q3.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[a])},n.destroy=function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(H5,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},n.resize=function(t,e){this._colorTexture.width===t&&this._colorTexture.height===e||(C("Resizing swapchain: "+t+"x"+e),this._canvas.width=t,this._canvas.height=e,this._colorTexture.resize(t,e),this._depthStencilTexture.resize(t,e))},n._onWebGLContextLost=function(t){I(11e3),y(t)},K(e,[{key:"extensions",get:function(){return this._extensions}}]),e}(uo),X5=t("WebGLDevice",function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._swapchain=null,e._context=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){Q3.setInstance(this),this._gfxAPI=si.WEBGL,this._bindingMappingInfo=t.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);var e=this._context=function(t){var e=null;try{var n={alpha:ce.ENABLE_TRANSPARENT_CANVAS,antialias:ce.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};e=t.getContext("webgl",n)}catch(t){return null}return e}(lo.canvas);if(!e)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new Hr(ki.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new kr(this._queue)),this._caps.maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxUniformBufferBindings=16;var n=e.getSupportedExtensions(),i="";if(n)for(var r,o=ot(n);!(r=o()).done;)i+=r.value+" ";var a=W5(e);a.WEBGL_debug_renderer_info?(this._renderer=e.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=e.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=e.getParameter(e.RENDERER),this._vendor=e.getParameter(e.VENDOR));var s=e.getParameter(e.VERSION);this._features.fill(!1),a.EXT_sRGB&&(this._features[li.FORMAT_SRGB]=!0),a.EXT_blend_minmax&&(this._features[li.BLEND_MINMAX]=!0),a.WEBGL_color_buffer_float&&(this._features[li.COLOR_FLOAT]=!0),a.EXT_color_buffer_half_float&&(this._features[li.COLOR_HALF_FLOAT]=!0),a.OES_texture_float&&(this._features[li.TEXTURE_FLOAT]=!0),a.OES_texture_half_float&&(this._features[li.TEXTURE_HALF_FLOAT]=!0),a.OES_texture_float_linear&&(this._features[li.TEXTURE_FLOAT_LINEAR]=!0),a.OES_texture_half_float_linear&&(this._features[li.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._features[li.FORMAT_RGB8]=!0,a.OES_element_index_uint&&(this._features[li.ELEMENT_INDEX_UINT]=!0),a.ANGLE_instanced_arrays&&(this._features[li.INSTANCED_ARRAYS]=!0),a.WEBGL_draw_buffers&&(this._features[li.MULTIPLE_RENDER_TARGETS]=!0);var c="";return a.WEBGL_compressed_texture_etc1&&(this._features[li.FORMAT_ETC1]=!0,c+="etc1 "),a.WEBGL_compressed_texture_etc&&(this._features[li.FORMAT_ETC2]=!0,c+="etc2 "),a.WEBGL_compressed_texture_s3tc&&(this._features[li.FORMAT_DXT]=!0,c+="dxt "),a.WEBGL_compressed_texture_pvrtc&&(this._features[li.FORMAT_PVRTC]=!0,c+="pvrtc "),a.WEBGL_compressed_texture_astc&&(this._features[li.FORMAT_ASTC]=!0,c+="astc "),C("WebGL device initialized."),C("RENDERER: "+this._renderer),C("VENDOR: "+this._vendor),C("VERSION: "+s),C("COMPRESSED_FORMAT: "+c),C("EXTENSIONS: "+i),!0},n.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)},n.flushCommands=function(){},n.acquire=function(){},n.present=function(){var t=this._queue;this._numDrawCalls=t.numDrawCalls,this._numInstances=t.numInstances,this._numTris=t.numTris,t.clear()},n.createCommandBuffer=function(t){var e=new(t.type===ji.PRIMARY?N5:P5);return e.initialize(t),e},n.createSwapchain=function(t){var e=new q5;return this._swapchain=e,e.initialize(t),e},n.createBuffer=function(t){var e=new T5;return e.initialize(t),e},n.createTexture=function(t){var e=new k5;return e.initialize(t),e},n.createDescriptorSet=function(t){var e=new J3;return e.initialize(t),e},n.createShader=function(t){var e=new V5;return e.initialize(t),e},n.createInputAssembler=function(t){var e=new R5;return e.initialize(t),e},n.createRenderPass=function(t){var e=new F5;return e.initialize(t),e},n.createFramebuffer=function(t){var e=new I5;return e.initialize(t),e},n.createDescriptorSetLayout=function(t){var e=new D5;return e.initialize(t),e},n.createPipelineLayout=function(t){var e=new B5;return e.initialize(t),e},n.createPipelineState=function(t){var e=new O5;return e.initialize(t),e},n.createQueue=function(t){var e=new L5;return e.initialize(t),e},n.getSampler=function(t){var e=Po.computeHash(t);return this._samplers.has(e)||this._samplers.set(e,new G5(t,e)),this._samplers.get(e)},n.getGlobalBarrier=function(t){var e=Do.computeHash(t);return this._globalBarriers.has(e)||this._globalBarriers.set(e,new Do(t,e)),this._globalBarriers.get(e)},n.getTextureBarrier=function(t){var e=Bo.computeHash(t);return this._textureBarriers.has(e)||this._textureBarriers.set(e,new Bo(t,e)),this._textureBarriers.get(e)},n.copyBuffersToTexture=function(t,e,n){A5(this,t,e.gpuTexture,n)},n.copyTextureToBuffers=function(t,e,n){!function(t,e,n,i){var r=t.gl,o=t.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var s=0,c=0,l=1,u=1;switch(e.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,e.glTarget,e.glTexture,_.texSubres.mipLevel),s=_.texOffset.x,c=_.texOffset.y,l=_.texExtent.width,u=_.texExtent.height,r.readPixels(s,c,l,u,e.glFormat,e.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),o.glFramebuffer=null,r.deleteFramebuffer(a)}(this,t.gpuTexture,e,n)},n.copyTexImagesToTexture=function(t,e,n){!function(t,e,n,i){var r=t.gl,o=t.stateCache.glTexUnits[t.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,e[a++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],_=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<_;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,e[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&yi.GEN_MIPMAP&&n.isPowerOf2&&r.generateMipmap(n.glTarget)}(this,t,e.gpuTexture,n)},K(e,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}}]),e}(lo));c.WebGLDevice=X5;var Y5,K5=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuDescriptorSet=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._layout=t.layout;var e=t.layout.gpuDescriptorSetLayout,n=e.bindings,i=e.descriptorIndices,r=e.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var o=[];this._gpuDescriptorSet={gpuDescriptors:o,descriptorIndices:i};for(var a=0;a<n.length;++a)for(var s=n[a],c=0;c<s.count;c++)o.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var t=this._gpuDescriptorSet.gpuDescriptors,e=0;e<t.length;++e)t[e].type&Qr?this._buffers[e]&&(t[e].gpuBuffer=this._buffers[e].gpuBuffer):t[e].type&Zr&&(this._textures[e]&&(t[e].gpuTexture=this._textures[e].gpuTexture),this._samplers[e]&&(t[e].gpuSampler=this._samplers[e].gpuSampler));this._isDirty=!1}},K(e,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),e}(vo);!function(t){t[t.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",t[t.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",t[t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",t[t.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",t[t.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",t[t.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",t[t.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",t[t.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",t[t.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",t[t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",t[t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",t[t.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",t[t.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",t[t.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",t[t.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(Y5||(Y5={}));var J5=function(){function t(){}return t.setInstance=function(e){t._instance=e},K(t,null,[{key:"instance",get:function(){return t._instance}}]),t}();J5._instance=null;var Q5=[10497,33648,33071,33071],Z5=new Float32Array(4);function $5(t,e){switch(t){case ui.R8:return e.UNSIGNED_BYTE;case ui.R8SN:return e.BYTE;case ui.R8UI:return e.UNSIGNED_BYTE;case ui.R8I:return e.BYTE;case ui.R16F:return e.HALF_FLOAT;case ui.R16UI:return e.UNSIGNED_SHORT;case ui.R16I:return e.SHORT;case ui.R32F:return e.FLOAT;case ui.R32UI:return e.UNSIGNED_INT;case ui.R32I:return e.INT;case ui.RG8:return e.UNSIGNED_BYTE;case ui.RG8SN:return e.BYTE;case ui.RG8UI:return e.UNSIGNED_BYTE;case ui.RG8I:return e.BYTE;case ui.RG16F:return e.HALF_FLOAT;case ui.RG16UI:return e.UNSIGNED_SHORT;case ui.RG16I:return e.SHORT;case ui.RG32F:return e.FLOAT;case ui.RG32UI:return e.UNSIGNED_INT;case ui.RG32I:return e.INT;case ui.RGB8:case ui.SRGB8:return e.UNSIGNED_BYTE;case ui.RGB8SN:return e.BYTE;case ui.RGB8UI:return e.UNSIGNED_BYTE;case ui.RGB8I:return e.BYTE;case ui.RGB16F:return e.HALF_FLOAT;case ui.RGB16UI:return e.UNSIGNED_SHORT;case ui.RGB16I:return e.SHORT;case ui.RGB32F:return e.FLOAT;case ui.RGB32UI:return e.UNSIGNED_INT;case ui.RGB32I:return e.INT;case ui.BGRA8:case ui.RGBA8:case ui.SRGB8_A8:return e.UNSIGNED_BYTE;case ui.RGBA8SN:return e.BYTE;case ui.RGBA8UI:return e.UNSIGNED_BYTE;case ui.RGBA8I:return e.BYTE;case ui.RGBA16F:return e.HALF_FLOAT;case ui.RGBA16UI:return e.UNSIGNED_SHORT;case ui.RGBA16I:return e.SHORT;case ui.RGBA32F:return e.FLOAT;case ui.RGBA32UI:return e.UNSIGNED_INT;case ui.RGBA32I:return e.INT;case ui.R5G6B5:return e.UNSIGNED_SHORT_5_6_5;case ui.R11G11B10F:return e.UNSIGNED_INT_10F_11F_11F_REV;case ui.RGB5A1:return e.UNSIGNED_SHORT_5_5_5_1;case ui.RGBA4:return e.UNSIGNED_SHORT_4_4_4_4;case ui.RGB10A2:case ui.RGB10A2UI:return e.UNSIGNED_INT_2_10_10_10_REV;case ui.RGB9E5:case ui.DEPTH:return e.FLOAT;case ui.DEPTH_STENCIL:return e.UNSIGNED_INT_24_8;case ui.BC1:case ui.BC1_SRGB:case ui.BC2:case ui.BC2_SRGB:case ui.BC3:case ui.BC3_SRGB:case ui.BC4:return e.UNSIGNED_BYTE;case ui.BC4_SNORM:return e.BYTE;case ui.BC5:return e.UNSIGNED_BYTE;case ui.BC5_SNORM:return e.BYTE;case ui.BC6H_SF16:case ui.BC6H_UF16:return e.FLOAT;case ui.BC7:case ui.BC7_SRGB:case ui.ETC_RGB8:case ui.ETC2_RGB8:case ui.ETC2_SRGB8:case ui.ETC2_RGB8_A1:case ui.ETC2_SRGB8_A1:case ui.EAC_R11:return e.UNSIGNED_BYTE;case ui.EAC_R11SN:return e.BYTE;case ui.EAC_RG11:return e.UNSIGNED_BYTE;case ui.EAC_RG11SN:return e.BYTE;case ui.PVRTC_RGB2:case ui.PVRTC_RGBA2:case ui.PVRTC_RGB4:case ui.PVRTC_RGBA4:case ui.PVRTC2_2BPP:case ui.PVRTC2_4BPP:return e.UNSIGNED_BYTE;case ui.ASTC_RGBA_4X4:case ui.ASTC_RGBA_5X4:case ui.ASTC_RGBA_5X5:case ui.ASTC_RGBA_6X5:case ui.ASTC_RGBA_6X6:case ui.ASTC_RGBA_8X5:case ui.ASTC_RGBA_8X6:case ui.ASTC_RGBA_8X8:case ui.ASTC_RGBA_10X5:case ui.ASTC_RGBA_10X6:case ui.ASTC_RGBA_10X8:case ui.ASTC_RGBA_10X10:case ui.ASTC_RGBA_12X10:case ui.ASTC_RGBA_12X12:case ui.ASTC_SRGBA_4X4:case ui.ASTC_SRGBA_5X4:case ui.ASTC_SRGBA_5X5:case ui.ASTC_SRGBA_6X5:case ui.ASTC_SRGBA_6X6:case ui.ASTC_SRGBA_8X5:case ui.ASTC_SRGBA_8X6:case ui.ASTC_SRGBA_8X8:case ui.ASTC_SRGBA_10X5:case ui.ASTC_SRGBA_10X6:case ui.ASTC_SRGBA_10X8:case ui.ASTC_SRGBA_10X10:case ui.ASTC_SRGBA_12X10:case ui.ASTC_SRGBA_12X12:default:return e.UNSIGNED_BYTE}}function t8(t,e){switch(t){case _i.BOOL:return e.BOOL;case _i.BOOL2:return e.BOOL_VEC2;case _i.BOOL3:return e.BOOL_VEC3;case _i.BOOL4:return e.BOOL_VEC4;case _i.INT:return e.INT;case _i.INT2:return e.INT_VEC2;case _i.INT3:return e.INT_VEC3;case _i.INT4:return e.INT_VEC4;case _i.UINT:return e.UNSIGNED_INT;case _i.FLOAT:return e.FLOAT;case _i.FLOAT2:return e.FLOAT_VEC2;case _i.FLOAT3:return e.FLOAT_VEC3;case _i.FLOAT4:return e.FLOAT_VEC4;case _i.MAT2:return e.FLOAT_MAT2;case _i.MAT2X3:return e.FLOAT_MAT2x3;case _i.MAT2X4:return e.FLOAT_MAT2x4;case _i.MAT3X2:return e.FLOAT_MAT3x2;case _i.MAT3:return e.FLOAT_MAT3;case _i.MAT3X4:return e.FLOAT_MAT3x4;case _i.MAT4X2:return e.FLOAT_MAT4x2;case _i.MAT4X3:return e.FLOAT_MAT4x3;case _i.MAT4:return e.FLOAT_MAT4;case _i.SAMPLER2D:return e.SAMPLER_2D;case _i.SAMPLER2D_ARRAY:return e.SAMPLER_2D_ARRAY;case _i.SAMPLER3D:return e.SAMPLER_3D;case _i.SAMPLER_CUBE:return e.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),_i.UNKNOWN}}function e8(t,e){switch(t){case e.BOOL:return _i.BOOL;case e.BOOL_VEC2:return _i.BOOL2;case e.BOOL_VEC3:return _i.BOOL3;case e.BOOL_VEC4:return _i.BOOL4;case e.INT:return _i.INT;case e.INT_VEC2:return _i.INT2;case e.INT_VEC3:return _i.INT3;case e.INT_VEC4:return _i.INT4;case e.UNSIGNED_INT:return _i.UINT;case e.UNSIGNED_INT_VEC2:return _i.UINT2;case e.UNSIGNED_INT_VEC3:return _i.UINT3;case e.UNSIGNED_INT_VEC4:return _i.UINT4;case e.FLOAT:return _i.FLOAT;case e.FLOAT_VEC2:return _i.FLOAT2;case e.FLOAT_VEC3:return _i.FLOAT3;case e.FLOAT_VEC4:return _i.FLOAT4;case e.FLOAT_MAT2:return _i.MAT2;case e.FLOAT_MAT2x3:return _i.MAT2X3;case e.FLOAT_MAT2x4:return _i.MAT2X4;case e.FLOAT_MAT3x2:return _i.MAT3X2;case e.FLOAT_MAT3:return _i.MAT3;case e.FLOAT_MAT3x4:return _i.MAT3X4;case e.FLOAT_MAT4x2:return _i.MAT4X2;case e.FLOAT_MAT4x3:return _i.MAT4X3;case e.FLOAT_MAT4:return _i.MAT4;case e.SAMPLER_2D:return _i.SAMPLER2D;case e.SAMPLER_2D_ARRAY:return _i.SAMPLER2D_ARRAY;case e.SAMPLER_3D:return _i.SAMPLER3D;case e.SAMPLER_CUBE:return _i.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),_i.UNKNOWN}}function n8(t,e){switch(t){case e.BOOL:return 4;case e.BOOL_VEC2:return 8;case e.BOOL_VEC3:return 12;case e.BOOL_VEC4:return 16;case e.INT:return 4;case e.INT_VEC2:return 8;case e.INT_VEC3:return 12;case e.INT_VEC4:return 16;case e.UNSIGNED_INT:return 4;case e.UNSIGNED_INT_VEC2:return 8;case e.UNSIGNED_INT_VEC3:return 12;case e.UNSIGNED_INT_VEC4:return 16;case e.FLOAT:return 4;case e.FLOAT_VEC2:return 8;case e.FLOAT_VEC3:return 12;case e.FLOAT_VEC4:case e.FLOAT_MAT2:return 16;case e.FLOAT_MAT2x3:return 24;case e.FLOAT_MAT2x4:return 32;case e.FLOAT_MAT3x2:return 24;case e.FLOAT_MAT3:return 36;case e.FLOAT_MAT3x4:return 48;case e.FLOAT_MAT4x2:return 32;case e.FLOAT_MAT4x3:return 48;case e.FLOAT_MAT4:return 64;case e.SAMPLER_2D:case e.SAMPLER_2D_ARRAY:case e.SAMPLER_2D_ARRAY_SHADOW:case e.SAMPLER_3D:case e.SAMPLER_CUBE:case e.INT_SAMPLER_2D:case e.INT_SAMPLER_2D_ARRAY:case e.INT_SAMPLER_3D:case e.INT_SAMPLER_CUBE:case e.UNSIGNED_INT_SAMPLER_2D:case e.UNSIGNED_INT_SAMPLER_2D_ARRAY:case e.UNSIGNED_INT_SAMPLER_3D:case e.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function i8(t,e){switch(t){case e.FLOAT_MAT2:case e.FLOAT_MAT2x3:case e.FLOAT_MAT2x4:return 2;case e.FLOAT_MAT3x2:case e.FLOAT_MAT3:case e.FLOAT_MAT3x4:return 3;case e.FLOAT_MAT4x2:case e.FLOAT_MAT4x3:case e.FLOAT_MAT4:return 4;default:return 1}}var r8,o8=[512,513,514,515,516,517,518,519],a8=[0,7680,7681,7682,7683,5386,34055,34056],s8=[32774,32778,32779,32775,32776],c8=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(t){t[t.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",t[t.END_RENDER_PASS=1]="END_RENDER_PASS",t[t.BIND_STATES=2]="BIND_STATES",t[t.DRAW=3]="DRAW",t[t.UPDATE_BUFFER=4]="UPDATE_BUFFER",t[t.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",t[t.COUNT=6]="COUNT"}(r8||(r8={}));var l8=function(t){this.cmdType=void 0,this.refCount=0,this.cmdType=t},u8=function(t){function e(){var e;return(e=t.call(this,r8.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,e.gpuFramebuffer=null,e.renderArea=new Qi,e.clearColors=[],e.clearDepth=1,e.clearStencil=0,e}return Q(e,t),e.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},e}(l8),h8=function(t){function e(){var e;return(e=t.call(this,r8.BIND_STATES)||this).gpuPipelineState=null,e.gpuInputAssembler=null,e.gpuDescriptorSets=[],e.dynamicOffsets=[],e.dynamicStates=new Yr,e}return Q(e,t),e.prototype.clear=function(){this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets.length=0,this.dynamicOffsets.length=0},e}(l8),_8=function(t){function e(){var e;return(e=t.call(this,r8.DRAW)||this).drawInfo=new hr,e}return Q(e,t),e.prototype.clear=function(){},e}(l8),f8=function(t){function e(){var e;return(e=t.call(this,r8.UPDATE_BUFFER)||this).gpuBuffer=null,e.buffer=null,e.offset=0,e.size=0,e}return Q(e,t),e.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},e}(l8),p8=function(t){function e(){var e;return(e=t.call(this,r8.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,e.buffers=[],e.regions=[],e}return Q(e,t),e.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},e}(l8),d8=function(){function t(){this.cmds=new kl(1),this.beginRenderPassCmds=new kl(1),this.bindStatesCmds=new kl(1),this.drawCmds=new kl(1),this.updateBufferCmds=new kl(1),this.copyBufferToTextureCmds=new kl(1)}return t.prototype.clearCmds=function(t){this.beginRenderPassCmds.length&&(t.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(t.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(t.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(t.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(t.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},t}();function m8(t,e,n,i,r){if(e.usage&fi.INDIRECT){e.indirects.clearDraws();for(var o=n.drawInfos,a=0;a<o.length;++a)e.indirects.setDrawInfo(i+a,o[a])}else{var s=n,c=t.gl,l=t.stateCache;switch(e.glTarget){case c.ARRAY_BUFFER:t.extensions.useVAO&&l.glVAO&&(c.bindVertexArray(null),l.glVAO=null),y8.gpuInputAssembler=null,l.glArrayBuffer!==e.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,e.glBuffer),l.glArrayBuffer=e.glBuffer),r===s.byteLength?c.bufferSubData(e.glTarget,i,s):c.bufferSubData(e.glTarget,i,s.slice(0,r));break;case c.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&l.glVAO&&(c.bindVertexArray(null),l.glVAO=null),y8.gpuInputAssembler=null,l.glElementArrayBuffer!==e.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,e.glBuffer),l.glElementArrayBuffer=e.glBuffer),r===s.byteLength?c.bufferSubData(e.glTarget,i,s):c.bufferSubData(e.glTarget,i,s.slice(0,r));break;case c.UNIFORM_BUFFER:l.glUniformBuffer!==e.glBuffer&&(c.bindBuffer(c.UNIFORM_BUFFER,e.glBuffer),l.glUniformBuffer=e.glBuffer),r===s.byteLength?c.bufferSubData(e.glTarget,i,s):c.bufferSubData(e.glTarget,i,new Float32Array(s,0,r/4));break;default:console.error("Unsupported BufferType, update buffer failed.")}}}function v8(t,e){var n=t.gl;e.glInternalFmt=function(t,e){switch(t){case ui.A8:return e.ALPHA;case ui.L8:return e.LUMINANCE;case ui.LA8:return e.LUMINANCE_ALPHA;case ui.R8:return e.R8;case ui.R8SN:return e.R8_SNORM;case ui.R8UI:return e.R8UI;case ui.R8I:return e.R8I;case ui.RG8:return e.RG8;case ui.RG8SN:return e.RG8_SNORM;case ui.RG8UI:return e.RG8UI;case ui.RG8I:return e.RG8I;case ui.RGB8:return e.RGB8;case ui.RGB8SN:return e.RGB8_SNORM;case ui.RGB8UI:return e.RGB8UI;case ui.RGB8I:return e.RGB8I;case ui.BGRA8:case ui.RGBA8:return e.RGBA8;case ui.RGBA8SN:return e.RGBA8_SNORM;case ui.RGBA8UI:return e.RGBA8UI;case ui.RGBA8I:return e.RGBA8I;case ui.R16I:return e.R16I;case ui.R16UI:return e.R16UI;case ui.R16F:return e.R16F;case ui.RG16I:return e.RG16I;case ui.RG16UI:return e.RG16UI;case ui.RG16F:return e.RG16F;case ui.RGB16I:return e.RGB16I;case ui.RGB16UI:return e.RGB16UI;case ui.RGB16F:return e.RGB16F;case ui.RGBA16I:return e.RGBA16I;case ui.RGBA16UI:return e.RGBA16UI;case ui.RGBA16F:return e.RGBA16F;case ui.R32I:return e.R32I;case ui.R32UI:return e.R32UI;case ui.R32F:return e.R32F;case ui.RG32I:return e.RG32I;case ui.RG32UI:return e.RG32UI;case ui.RG32F:return e.RG32F;case ui.RGB32I:return e.RGB32I;case ui.RGB32UI:return e.RGB32UI;case ui.RGB32F:return e.RGB32F;case ui.RGBA32I:return e.RGBA32I;case ui.RGBA32UI:return e.RGBA32UI;case ui.RGBA32F:return e.RGBA32F;case ui.R5G6B5:return e.RGB565;case ui.RGB5A1:return e.RGB5_A1;case ui.RGBA4:return e.RGBA4;case ui.SRGB8:return e.SRGB8;case ui.SRGB8_A8:return e.SRGB8_ALPHA8;case ui.RGB10A2:return e.RGB10_A2;case ui.RGB10A2UI:return e.RGB10_A2UI;case ui.R11G11B10F:return e.R11F_G11F_B10F;case ui.DEPTH:return e.DEPTH_COMPONENT32F;case ui.DEPTH_STENCIL:return e.DEPTH24_STENCIL8;case ui.BC1:return Y5.COMPRESSED_RGB_S3TC_DXT1_EXT;case ui.BC1_ALPHA:return Y5.COMPRESSED_RGBA_S3TC_DXT1_EXT;case ui.BC1_SRGB:return Y5.COMPRESSED_SRGB_S3TC_DXT1_EXT;case ui.BC1_SRGB_ALPHA:return Y5.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case ui.BC2:return Y5.COMPRESSED_RGBA_S3TC_DXT3_EXT;case ui.BC2_SRGB:return Y5.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case ui.BC3:return Y5.COMPRESSED_RGBA_S3TC_DXT5_EXT;case ui.BC3_SRGB:return Y5.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case ui.ETC_RGB8:return Y5.COMPRESSED_RGB_ETC1_WEBGL;case ui.ETC2_RGB8:return Y5.COMPRESSED_RGB8_ETC2;case ui.ETC2_SRGB8:return Y5.COMPRESSED_SRGB8_ETC2;case ui.ETC2_RGB8_A1:return Y5.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case ui.ETC2_SRGB8_A1:return Y5.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case ui.ETC2_RGBA8:return Y5.COMPRESSED_RGBA8_ETC2_EAC;case ui.ETC2_SRGB8_A8:return Y5.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case ui.EAC_R11:return Y5.COMPRESSED_R11_EAC;case ui.EAC_R11SN:return Y5.COMPRESSED_SIGNED_R11_EAC;case ui.EAC_RG11:return Y5.COMPRESSED_RG11_EAC;case ui.EAC_RG11SN:return Y5.COMPRESSED_SIGNED_RG11_EAC;case ui.PVRTC_RGB2:return Y5.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case ui.PVRTC_RGBA2:return Y5.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case ui.PVRTC_RGB4:return Y5.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case ui.PVRTC_RGBA4:return Y5.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case ui.ASTC_RGBA_4X4:return Y5.COMPRESSED_RGBA_ASTC_4x4_KHR;case ui.ASTC_RGBA_5X4:return Y5.COMPRESSED_RGBA_ASTC_5x4_KHR;case ui.ASTC_RGBA_5X5:return Y5.COMPRESSED_RGBA_ASTC_5x5_KHR;case ui.ASTC_RGBA_6X5:return Y5.COMPRESSED_RGBA_ASTC_6x5_KHR;case ui.ASTC_RGBA_6X6:return Y5.COMPRESSED_RGBA_ASTC_6x6_KHR;case ui.ASTC_RGBA_8X5:return Y5.COMPRESSED_RGBA_ASTC_8x5_KHR;case ui.ASTC_RGBA_8X6:return Y5.COMPRESSED_RGBA_ASTC_8x6_KHR;case ui.ASTC_RGBA_8X8:return Y5.COMPRESSED_RGBA_ASTC_8x8_KHR;case ui.ASTC_RGBA_10X5:return Y5.COMPRESSED_RGBA_ASTC_10x5_KHR;case ui.ASTC_RGBA_10X6:return Y5.COMPRESSED_RGBA_ASTC_10x6_KHR;case ui.ASTC_RGBA_10X8:return Y5.COMPRESSED_RGBA_ASTC_10x8_KHR;case ui.ASTC_RGBA_10X10:return Y5.COMPRESSED_RGBA_ASTC_10x10_KHR;case ui.ASTC_RGBA_12X10:return Y5.COMPRESSED_RGBA_ASTC_12x10_KHR;case ui.ASTC_RGBA_12X12:return Y5.COMPRESSED_RGBA_ASTC_12x12_KHR;case ui.ASTC_SRGBA_4X4:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case ui.ASTC_SRGBA_5X4:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case ui.ASTC_SRGBA_5X5:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case ui.ASTC_SRGBA_6X5:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case ui.ASTC_SRGBA_6X6:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case ui.ASTC_SRGBA_8X5:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case ui.ASTC_SRGBA_8X6:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case ui.ASTC_SRGBA_8X8:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case ui.ASTC_SRGBA_10X5:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case ui.ASTC_SRGBA_10X6:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case ui.ASTC_SRGBA_10X8:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case ui.ASTC_SRGBA_10X10:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case ui.ASTC_SRGBA_12X10:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case ui.ASTC_SRGBA_12X12:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),e.RGBA}}(e.format,n),e.glFormat=function(t,e){switch(t){case ui.A8:return e.ALPHA;case ui.L8:return e.LUMINANCE;case ui.LA8:return e.LUMINANCE_ALPHA;case ui.R8:case ui.R8SN:return e.RED;case ui.R8UI:case ui.R8I:return e.RED;case ui.RG8:case ui.RG8SN:case ui.RG8UI:case ui.RG8I:return e.RG;case ui.RGB8:case ui.RGB8SN:case ui.RGB8UI:case ui.RGB8I:return e.RGB;case ui.BGRA8:case ui.RGBA8:case ui.RGBA8SN:case ui.RGBA8UI:case ui.RGBA8I:return e.RGBA;case ui.R16UI:case ui.R16I:case ui.R16F:return e.RED;case ui.RG16UI:case ui.RG16I:case ui.RG16F:return e.RG;case ui.RGB16UI:case ui.RGB16I:case ui.RGB16F:return e.RGB;case ui.RGBA16UI:case ui.RGBA16I:case ui.RGBA16F:return e.RGBA;case ui.R32UI:case ui.R32I:case ui.R32F:return e.RED;case ui.RG32UI:case ui.RG32I:case ui.RG32F:return e.RG;case ui.RGB32UI:case ui.RGB32I:case ui.RGB32F:return e.RGB;case ui.RGBA32UI:case ui.RGBA32I:case ui.RGBA32F:case ui.RGB10A2:return e.RGBA;case ui.R11G11B10F:case ui.R5G6B5:return e.RGB;case ui.RGB5A1:case ui.RGBA4:return e.RGBA;case ui.SRGB8:return e.RGB;case ui.SRGB8_A8:return e.RGBA;case ui.DEPTH:return e.DEPTH_COMPONENT;case ui.DEPTH_STENCIL:return e.DEPTH_STENCIL;case ui.BC1:return Y5.COMPRESSED_RGB_S3TC_DXT1_EXT;case ui.BC1_ALPHA:return Y5.COMPRESSED_RGBA_S3TC_DXT1_EXT;case ui.BC1_SRGB:return Y5.COMPRESSED_SRGB_S3TC_DXT1_EXT;case ui.BC1_SRGB_ALPHA:return Y5.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case ui.BC2:return Y5.COMPRESSED_RGBA_S3TC_DXT3_EXT;case ui.BC2_SRGB:return Y5.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case ui.BC3:return Y5.COMPRESSED_RGBA_S3TC_DXT5_EXT;case ui.BC3_SRGB:return Y5.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case ui.ETC_RGB8:return Y5.COMPRESSED_RGB_ETC1_WEBGL;case ui.ETC2_RGB8:return Y5.COMPRESSED_RGB8_ETC2;case ui.ETC2_SRGB8:return Y5.COMPRESSED_SRGB8_ETC2;case ui.ETC2_RGB8_A1:return Y5.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case ui.ETC2_SRGB8_A1:return Y5.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case ui.ETC2_RGBA8:return Y5.COMPRESSED_RGBA8_ETC2_EAC;case ui.ETC2_SRGB8_A8:return Y5.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case ui.EAC_R11:return Y5.COMPRESSED_R11_EAC;case ui.EAC_R11SN:return Y5.COMPRESSED_SIGNED_R11_EAC;case ui.EAC_RG11:return Y5.COMPRESSED_RG11_EAC;case ui.EAC_RG11SN:return Y5.COMPRESSED_SIGNED_RG11_EAC;case ui.PVRTC_RGB2:return Y5.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case ui.PVRTC_RGBA2:return Y5.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case ui.PVRTC_RGB4:return Y5.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case ui.PVRTC_RGBA4:return Y5.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case ui.ASTC_RGBA_4X4:return Y5.COMPRESSED_RGBA_ASTC_4x4_KHR;case ui.ASTC_RGBA_5X4:return Y5.COMPRESSED_RGBA_ASTC_5x4_KHR;case ui.ASTC_RGBA_5X5:return Y5.COMPRESSED_RGBA_ASTC_5x5_KHR;case ui.ASTC_RGBA_6X5:return Y5.COMPRESSED_RGBA_ASTC_6x5_KHR;case ui.ASTC_RGBA_6X6:return Y5.COMPRESSED_RGBA_ASTC_6x6_KHR;case ui.ASTC_RGBA_8X5:return Y5.COMPRESSED_RGBA_ASTC_8x5_KHR;case ui.ASTC_RGBA_8X6:return Y5.COMPRESSED_RGBA_ASTC_8x6_KHR;case ui.ASTC_RGBA_8X8:return Y5.COMPRESSED_RGBA_ASTC_8x8_KHR;case ui.ASTC_RGBA_10X5:return Y5.COMPRESSED_RGBA_ASTC_10x5_KHR;case ui.ASTC_RGBA_10X6:return Y5.COMPRESSED_RGBA_ASTC_10x6_KHR;case ui.ASTC_RGBA_10X8:return Y5.COMPRESSED_RGBA_ASTC_10x8_KHR;case ui.ASTC_RGBA_10X10:return Y5.COMPRESSED_RGBA_ASTC_10x10_KHR;case ui.ASTC_RGBA_12X10:return Y5.COMPRESSED_RGBA_ASTC_12x10_KHR;case ui.ASTC_RGBA_12X12:return Y5.COMPRESSED_RGBA_ASTC_12x12_KHR;case ui.ASTC_SRGBA_4X4:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case ui.ASTC_SRGBA_5X4:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case ui.ASTC_SRGBA_5X5:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case ui.ASTC_SRGBA_6X5:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case ui.ASTC_SRGBA_6X6:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case ui.ASTC_SRGBA_8X5:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case ui.ASTC_SRGBA_8X6:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case ui.ASTC_SRGBA_8X8:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case ui.ASTC_SRGBA_10X5:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case ui.ASTC_SRGBA_10X6:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case ui.ASTC_SRGBA_10X8:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case ui.ASTC_SRGBA_10X10:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case ui.ASTC_SRGBA_12X10:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case ui.ASTC_SRGBA_12X12:return Y5.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),e.RGBA}}(e.format,n),e.glType=$5(e.format,n);var i=e.width,r=e.height;switch(e.type){case vi.TEX2D:if(e.glTarget=n.TEXTURE_2D,e.isSwapchainTexture)break;var o=Math.max(i,r);if(o>t.capabilities.maxTextureSize&&D(9100,o,t.capabilities.maxTextureSize),e.samples===xi.ONE){if(e.glTexture=n.createTexture(),e.size>0){var a=t.stateCache.glTexUnits[t.stateCache.texUnit];if(a.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_2D,e.glTexture),a.glTexture=e.glTexture),Jr[e.format].isCompressed)for(var s=0;s<e.mipLevel;++s){var c=eo(e.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,e.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else n.texStorage2D(n.TEXTURE_2D,e.mipLevel,e.glInternalFmt,i,r)}}else e.glRenderbuffer=n.createRenderbuffer(),e.size>0&&(t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,e.samples,e.glInternalFmt,e.width,e.height));break;case vi.CUBE:e.glTarget=n.TEXTURE_CUBE_MAP;var u=Math.max(i,r);if(u>t.capabilities.maxCubeMapTextureSize&&D(9100,u,t.capabilities.maxTextureSize),e.glTexture=n.createTexture(),e.size>0){var h=t.stateCache.glTexUnits[t.stateCache.texUnit];if(h.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,e.glTexture),h.glTexture=e.glTexture),Jr[e.format].isCompressed)for(var _=0;_<e.mipLevel;++_){for(var f=eo(e.format,i,r,1),p=new Uint8Array(f),d=0;d<6;++d)n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+d,_,e.glInternalFmt,i,r,0,p);i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else n.texStorage2D(n.TEXTURE_CUBE_MAP,e.mipLevel,e.glInternalFmt,i,r)}break;default:console.error("Unsupported TextureType, create texture failed."),e.type=vi.TEX2D,e.glTarget=n.TEXTURE_2D}}function g8(t,e){var n=t.gl;if(e.glTexture){var i=t.stateCache.glTexUnits,r=t.stateCache.texUnit;n.deleteTexture(e.glTexture);for(var o=0;o<i.length;++o)i[o].glTexture===e.glTexture&&(n.activeTexture(n.TEXTURE0+o),r=o,n.bindTexture(e.glTarget,null),i[o].glTexture=null);t.stateCache.texUnit=r,e.glTexture=null}if(e.glRenderbuffer){var a=t.stateCache.glRenderbuffer;n.deleteRenderbuffer(e.glRenderbuffer),a===e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,null),a=null),e.glRenderbuffer=null}}var y8={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0,invalidateAttachments:[]};function x8(t,e,n,i,r,o,a){var s=t.gl,c=t.stateCache,l=0;if(n&&e){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height),y8.invalidateAttachments.length=0;for(var u=0;u<r.length;++u){var h=e.colorAttachments[u];if(h.format!==ui.UNKNOWN)switch(h.loadOp){case Ri.LOAD:break;case Ri.CLEAR:if(c.bs.targets[0].blendColorMask!==Pi.ALL&&s.colorMask(!0,!0,!0,!0),n.isOffscreen)Z5[0]=r[u].x,Z5[1]=r[u].y,Z5[2]=r[u].z,Z5[3]=r[u].w,s.clearBufferfv(s.COLOR,u,Z5);else{var _=r[0];s.clearColor(_.x,_.y,_.z,_.w),l|=s.COLOR_BUFFER_BIT}break;case Ri.DISCARD:y8.invalidateAttachments.push(s.COLOR_ATTACHMENT0+u)}}if(e.depthStencilAttachment&&e.depthStencilAttachment.format!==ui.UNKNOWN){switch(e.depthStencilAttachment.depthLoadOp){case Ri.LOAD:break;case Ri.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(o),l|=s.DEPTH_BUFFER_BIT;break;case Ri.DISCARD:y8.invalidateAttachments.push(s.DEPTH_ATTACHMENT)}if(Jr[e.depthStencilAttachment.format].hasStencil)switch(e.depthStencilAttachment.stencilLoadOp){case Ri.LOAD:break;case Ri.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(a),l|=s.STENCIL_BUFFER_BIT;break;case Ri.DISCARD:y8.invalidateAttachments.push(s.STENCIL_ATTACHMENT)}}if(n.glFramebuffer&&y8.invalidateAttachments.length&&s.invalidateFramebuffer(s.FRAMEBUFFER,y8.invalidateAttachments),l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var f=c.bs.targets[0].blendColorMask;if(f!==Pi.ALL){var p=(f&Pi.R)!==Pi.NONE,d=(f&Pi.G)!==Pi.NONE,m=(f&Pi.B)!==Pi.NONE,v=(f&Pi.A)!==Pi.NONE;s.colorMask(p,d,m,v)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function S8(t,e,n,i,r,o){var a=t.gl,s=t.stateCache,c=e&&e.gpuShader,l=!1;if(e&&y8.gpuPipelineState!==e){if(y8.gpuPipelineState=e,y8.glPrimitive=e.glPrimitive,c){var u=c.glProgram;s.glProgram!==u&&(a.useProgram(u),s.glProgram=u,l=!0)}var h=e.rs;if(h){if(s.rs.cullMode!==h.cullMode){switch(h.cullMode){case zi.NONE:a.disable(a.CULL_FACE);break;case zi.FRONT:a.enable(a.CULL_FACE),a.cullFace(a.FRONT);break;case zi.BACK:a.enable(a.CULL_FACE),a.cullFace(a.BACK)}t.stateCache.rs.cullMode=h.cullMode}var _=h.isFrontFaceCCW;t.stateCache.rs.isFrontFaceCCW!==_&&(a.frontFace(_?a.CCW:a.CW),t.stateCache.rs.isFrontFaceCCW=_),t.stateCache.rs.depthBias===h.depthBias&&t.stateCache.rs.depthBiasSlop===h.depthBiasSlop||(a.polygonOffset(h.depthBias,h.depthBiasSlop),t.stateCache.rs.depthBias=h.depthBias,t.stateCache.rs.depthBiasSlop=h.depthBiasSlop),t.stateCache.rs.lineWidth!==h.lineWidth&&(a.lineWidth(h.lineWidth),t.stateCache.rs.lineWidth=h.lineWidth)}var f=e.dss;f&&(s.dss.depthTest!==f.depthTest&&(f.depthTest?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST),s.dss.depthTest=f.depthTest),s.dss.depthWrite!==f.depthWrite&&(a.depthMask(f.depthWrite),s.dss.depthWrite=f.depthWrite),s.dss.depthFunc!==f.depthFunc&&(a.depthFunc(o8[f.depthFunc]),s.dss.depthFunc=f.depthFunc),s.dss.stencilTestFront===f.stencilTestFront&&s.dss.stencilTestBack===f.stencilTestBack||(f.stencilTestFront||f.stencilTestBack?a.enable(a.STENCIL_TEST):a.disable(a.STENCIL_TEST),s.dss.stencilTestFront=f.stencilTestFront,s.dss.stencilTestBack=f.stencilTestBack),s.dss.stencilFuncFront===f.stencilFuncFront&&s.dss.stencilRefFront===f.stencilRefFront&&s.dss.stencilReadMaskFront===f.stencilReadMaskFront||(a.stencilFuncSeparate(a.FRONT,o8[f.stencilFuncFront],f.stencilRefFront,f.stencilReadMaskFront),s.dss.stencilFuncFront=f.stencilFuncFront,s.dss.stencilRefFront=f.stencilRefFront,s.dss.stencilReadMaskFront=f.stencilReadMaskFront),s.dss.stencilFailOpFront===f.stencilFailOpFront&&s.dss.stencilZFailOpFront===f.stencilZFailOpFront&&s.dss.stencilPassOpFront===f.stencilPassOpFront||(a.stencilOpSeparate(a.FRONT,a8[f.stencilFailOpFront],a8[f.stencilZFailOpFront],a8[f.stencilPassOpFront]),s.dss.stencilFailOpFront=f.stencilFailOpFront,s.dss.stencilZFailOpFront=f.stencilZFailOpFront,s.dss.stencilPassOpFront=f.stencilPassOpFront),s.dss.stencilWriteMaskFront!==f.stencilWriteMaskFront&&(a.stencilMaskSeparate(a.FRONT,f.stencilWriteMaskFront),s.dss.stencilWriteMaskFront=f.stencilWriteMaskFront),s.dss.stencilFuncBack===f.stencilFuncBack&&s.dss.stencilRefBack===f.stencilRefBack&&s.dss.stencilReadMaskBack===f.stencilReadMaskBack||(a.stencilFuncSeparate(a.BACK,o8[f.stencilFuncBack],f.stencilRefBack,f.stencilReadMaskBack),s.dss.stencilFuncBack=f.stencilFuncBack,s.dss.stencilRefBack=f.stencilRefBack,s.dss.stencilReadMaskBack=f.stencilReadMaskBack),s.dss.stencilFailOpBack===f.stencilFailOpBack&&s.dss.stencilZFailOpBack===f.stencilZFailOpBack&&s.dss.stencilPassOpBack===f.stencilPassOpBack||(a.stencilOpSeparate(a.BACK,a8[f.stencilFailOpBack],a8[f.stencilZFailOpBack],a8[f.stencilPassOpBack]),s.dss.stencilFailOpBack=f.stencilFailOpBack,s.dss.stencilZFailOpBack=f.stencilZFailOpBack,s.dss.stencilPassOpBack=f.stencilPassOpBack),s.dss.stencilWriteMaskBack!==f.stencilWriteMaskBack&&(a.stencilMaskSeparate(a.BACK,f.stencilWriteMaskBack),s.dss.stencilWriteMaskBack=f.stencilWriteMaskBack));var p=e.bs;if(p){s.bs.isA2C!==p.isA2C&&(p.isA2C?a.enable(a.SAMPLE_ALPHA_TO_COVERAGE):a.disable(a.SAMPLE_ALPHA_TO_COVERAGE),s.bs.isA2C=p.isA2C),s.bs.blendColor.x===p.blendColor.x&&s.bs.blendColor.y===p.blendColor.y&&s.bs.blendColor.z===p.blendColor.z&&s.bs.blendColor.w===p.blendColor.w||(a.blendColor(p.blendColor.x,p.blendColor.y,p.blendColor.z,p.blendColor.w),s.bs.blendColor.x=p.blendColor.x,s.bs.blendColor.y=p.blendColor.y,s.bs.blendColor.z=p.blendColor.z,s.bs.blendColor.w=p.blendColor.w);var d=p.targets[0],m=s.bs.targets[0];m.blend!==d.blend&&(d.blend?a.enable(a.BLEND):a.disable(a.BLEND),m.blend=d.blend),m.blendEq===d.blendEq&&m.blendAlphaEq===d.blendAlphaEq||(a.blendEquationSeparate(s8[d.blendEq],s8[d.blendAlphaEq]),m.blendEq=d.blendEq,m.blendAlphaEq=d.blendAlphaEq),m.blendSrc===d.blendSrc&&m.blendDst===d.blendDst&&m.blendSrcAlpha===d.blendSrcAlpha&&m.blendDstAlpha===d.blendDstAlpha||(a.blendFuncSeparate(c8[d.blendSrc],c8[d.blendDst],c8[d.blendSrcAlpha],c8[d.blendDstAlpha]),m.blendSrc=d.blendSrc,m.blendDst=d.blendDst,m.blendSrcAlpha=d.blendSrcAlpha,m.blendDstAlpha=d.blendDstAlpha),m.blendColorMask!==d.blendColorMask&&(a.colorMask((d.blendColorMask&Pi.R)!==Pi.NONE,(d.blendColorMask&Pi.G)!==Pi.NONE,(d.blendColorMask&Pi.B)!==Pi.NONE,(d.blendColorMask&Pi.A)!==Pi.NONE),m.blendColorMask=d.blendColorMask)}}if(e&&e.gpuPipelineLayout&&c){for(var v=c.glBlocks.length,g=e.gpuPipelineLayout.dynamicOffsetIndices,y=0;y<v;y++){var S=c.glBlocks[y],C=i[S.set],A=C&&C.descriptorIndices[S.binding],b=A>=0&&C.gpuDescriptors[A];if(b&&b.gpuBuffer){var T=g[S.set],E=T&&T[S.binding],w=b.gpuBuffer.glOffset;E>=0&&(w+=r[E]),s.glBindUBOs[S.glBinding]===b.gpuBuffer.glBuffer&&s.glBindUBOOffsets[S.glBinding]===w||(w?a.bindBufferRange(a.UNIFORM_BUFFER,S.glBinding,b.gpuBuffer.glBuffer,w,b.gpuBuffer.size):a.bindBufferBase(a.UNIFORM_BUFFER,S.glBinding,b.gpuBuffer.glBuffer),s.glUniformBuffer=s.glBindUBOs[S.glBinding]=b.gpuBuffer.glBuffer,s.glBindUBOOffsets[S.glBinding]=w)}else x("Buffer binding '"+S.name+"' at set "+S.set+" binding "+S.binding+" is not bounded")}for(var P=c.glSamplerTextures.length,I=0;I<P;I++)for(var R=c.glSamplerTextures[I],D=i[R.set],B=D&&D.descriptorIndices[R.binding],M=B>=0&&D.gpuDescriptors[B],O=0;O<R.units.length;O++){var N=R.units[O],L=s.glTexUnits[N];if(M&&M.gpuTexture&&M.gpuSampler){if(M.gpuTexture&&M.gpuTexture.size>0){var F=M.gpuTexture;L.glTexture!==F.glTexture&&(s.texUnit!==N&&(a.activeTexture(a.TEXTURE0+N),s.texUnit=N),F.glTexture?a.bindTexture(F.glTarget,F.glTexture):a.bindTexture(F.glTarget,t.nullTex2D.gpuTexture.glTexture),L.glTexture=F.glTexture);var z=M.gpuSampler;s.glSamplerUnits[N]!==z.glSampler&&(a.bindSampler(N,z.glSampler),s.glSamplerUnits[N]=z.glSampler)}M=D.gpuDescriptors[++B]}else x("Sampler binding '"+R.name+"' at set "+R.set+" binding "+R.binding+" index "+O+" is not bounded")}}if(n&&c&&(l||y8.gpuInputAssembler!==n))if(y8.gpuInputAssembler=n,t.extensions.useVAO){var G=n.glVAOs.get(c.glProgram);if(!G){var V;G=a.createVertexArray(),n.glVAOs.set(c.glProgram,G),a.bindVertexArray(G),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null;for(var U=0;U<c.glInputs.length;U++){var k=c.glInputs[U];V=null;for(var H=0;H<n.glAttribs.length;H++){var j=n.glAttribs[H];if(j.name===k.name){V=j;break}}if(V){s.glArrayBuffer!==V.glBuffer&&(a.bindBuffer(a.ARRAY_BUFFER,V.glBuffer),s.glArrayBuffer=V.glBuffer);for(var W=0;W<V.componentCount;++W){var q=k.glLoc+W,X=V.offset+V.size*W;a.enableVertexAttribArray(q),s.glCurrentAttribLocs[q]=!0,a.vertexAttribPointer(q,V.count,V.glType,V.isNormalized,V.stride,X),a.vertexAttribDivisor(q,V.isInstanced?1:0)}}}var Y=n.gpuIndexBuffer;Y&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,Y.glBuffer),a.bindVertexArray(null),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null}s.glVAO!==G&&(a.bindVertexArray(G),s.glVAO=G)}else{for(var K=0;K<t.capabilities.maxVertexAttributes;++K)s.glCurrentAttribLocs[K]=!1;for(var J=0;J<c.glInputs.length;J++){for(var Q=c.glInputs[J],Z=null,$=0;$<n.glAttribs.length;$++){var tt=n.glAttribs[$];if(tt.name===Q.name){Z=tt;break}}if(Z){s.glArrayBuffer!==Z.glBuffer&&(a.bindBuffer(a.ARRAY_BUFFER,Z.glBuffer),s.glArrayBuffer=Z.glBuffer);for(var et=0;et<Z.componentCount;++et){var nt=Q.glLoc+et,it=Z.offset+Z.size*et;!s.glEnabledAttribLocs[nt]&&nt>=0&&(a.enableVertexAttribArray(nt),s.glEnabledAttribLocs[nt]=!0),s.glCurrentAttribLocs[nt]=!0,a.vertexAttribPointer(nt,Z.count,Z.glType,Z.isNormalized,Z.stride,it),a.vertexAttribDivisor(nt,Z.isInstanced?1:0)}}}var rt=n.gpuIndexBuffer;rt&&s.glElementArrayBuffer!==rt.glBuffer&&(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,rt.glBuffer),s.glElementArrayBuffer=rt.glBuffer);for(var ot=0;ot<t.capabilities.maxVertexAttributes;++ot)s.glEnabledAttribLocs[ot]!==s.glCurrentAttribLocs[ot]&&(a.disableVertexAttribArray(ot),s.glEnabledAttribLocs[ot]=!1)}if(e&&e.dynamicStates.length)for(var at=e.dynamicStates.length,st=0;st<at;st++)switch(e.dynamicStates[st]){case Gi.LINE_WIDTH:s.rs.lineWidth!==o.lineWidth&&(a.lineWidth(o.lineWidth),s.rs.lineWidth=o.lineWidth);break;case Gi.DEPTH_BIAS:s.rs.depthBias===o.depthBiasConstant&&s.rs.depthBiasSlop===o.depthBiasSlope||(a.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),s.rs.depthBias=o.depthBiasConstant,s.rs.depthBiasSlop=o.depthBiasSlope);break;case Gi.BLEND_CONSTANTS:var ct=o.blendConstant;s.bs.blendColor.x===ct.x&&s.bs.blendColor.y===ct.y&&s.bs.blendColor.z===ct.z&&s.bs.blendColor.w===ct.w||(a.blendColor(ct.x,ct.y,ct.z,ct.w),s.bs.blendColor.copy(ct));break;case Gi.STENCIL_WRITE_MASK:var lt=o.stencilStatesFront,ut=o.stencilStatesBack;s.dss.stencilWriteMaskFront!==lt.writeMask&&(a.stencilMaskSeparate(a.FRONT,lt.writeMask),s.dss.stencilWriteMaskFront=lt.writeMask),s.dss.stencilWriteMaskBack!==ut.writeMask&&(a.stencilMaskSeparate(a.BACK,ut.writeMask),s.dss.stencilWriteMaskBack=ut.writeMask);break;case Gi.STENCIL_COMPARE_MASK:var ht=o.stencilStatesFront,_t=o.stencilStatesBack;s.dss.stencilRefFront===ht.reference&&s.dss.stencilReadMaskFront===ht.compareMask||(a.stencilFuncSeparate(a.FRONT,o8[s.dss.stencilFuncFront],ht.reference,ht.compareMask),s.dss.stencilRefFront=ht.reference,s.dss.stencilReadMaskFront=ht.compareMask),s.dss.stencilRefBack===_t.reference&&s.dss.stencilReadMaskBack===_t.compareMask||(a.stencilFuncSeparate(a.BACK,o8[s.dss.stencilFuncBack],_t.reference,_t.compareMask),s.dss.stencilRefBack=_t.reference,s.dss.stencilReadMaskBack=_t.compareMask)}}function C8(t,e){var n=t.gl,i=y8.gpuInputAssembler,r=y8.glPrimitive,o=t.extensions.WEBGL_multi_draw;if(i){var a=i.gpuIndexBuffer;if(i.gpuIndirectBuffer){var s=i.gpuIndirectBuffer.indirects;if(s.drawByIndex){for(var c=0;c<s.drawCount;c++)s.byteOffsets[c]=s.offsets[c]*a.stride;if(o)s.instancedDraw?o.multiDrawElementsInstancedWEBGL(r,s.counts,0,i.glIndexType,s.byteOffsets,0,s.instances,0,s.drawCount):o.multiDrawElementsWEBGL(r,s.counts,0,i.glIndexType,s.byteOffsets,0,s.drawCount);else for(var l=0;l<s.drawCount;l++)s.instances[l]?n.drawElementsInstanced(r,s.counts[l],i.glIndexType,s.byteOffsets[l],s.instances[l]):n.drawElements(r,s.counts[l],i.glIndexType,s.byteOffsets[l])}else if(o)s.instancedDraw?o.multiDrawArraysInstancedWEBGL(r,s.offsets,0,s.counts,0,s.instances,0,s.drawCount):o.multiDrawArraysWEBGL(r,s.offsets,0,s.counts,0,s.drawCount);else for(var u=0;u<s.drawCount;u++)s.instances[u]?n.drawArraysInstanced(r,s.offsets[u],s.counts[u],s.instances[u]):n.drawArrays(r,s.offsets[u],s.counts[u])}else if(e.instanceCount)if(a){if(e.indexCount>0){var h=e.firstIndex*a.stride;n.drawElementsInstanced(r,e.indexCount,i.glIndexType,h,e.instanceCount)}}else e.vertexCount>0&&n.drawArraysInstanced(r,e.firstVertex,e.vertexCount,e.instanceCount);else if(a){if(e.indexCount>0){var _=e.firstIndex*a.stride;n.drawElements(r,e.indexCount,i.glIndexType,_)}}else e.vertexCount>0&&n.drawArrays(r,e.firstVertex,e.vertexCount)}}var A8=new Array(r8.COUNT);function b8(t,e){A8.fill(0);for(var n=0;n<e.cmds.length;++n){var i=e.cmds.array[n],r=A8[i]++;switch(i){case r8.BEGIN_RENDER_PASS:var o=e.beginRenderPassCmds.array[r];x8(t,o.gpuRenderPass,o.gpuFramebuffer,o.renderArea,o.clearColors,o.clearDepth,o.clearStencil);break;case r8.BIND_STATES:var a=e.bindStatesCmds.array[r];S8(t,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case r8.DRAW:C8(t,e.drawCmds.array[r].drawInfo);break;case r8.UPDATE_BUFFER:var s=e.updateBufferCmds.array[r];m8(t,s.gpuBuffer,s.buffer,s.offset,s.size);break;case r8.COPY_BUFFER_TO_TEXTURE:var c=e.copyBufferToTextureCmds.array[r];T8(t,c.buffers,c.gpuTexture,c.regions)}}}function T8(t,e,n,i){var r=t.gl,o=t.stateCache.glTexUnits[t.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=1,c=1,l=0,u=Jr[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];s=_.texExtent.width,c=_.texExtent.height;var f=e[a++];u?n.glInternalFmt!==Y5.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,f):r.compressedTexImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,n.glInternalFmt,s,c,0,f):r.texSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,n.glType,f)}break;case r.TEXTURE_CUBE_MAP:for(var p=0;p<i.length;p++){var d=i[p],m=d.texSubres.baseArrayLayer+d.texSubres.layerCount;for(l=d.texSubres.baseArrayLayer;l<m;++l){s=d.texExtent.width,c=d.texExtent.height;var v=e[a++];u?n.glInternalFmt!==Y5.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,v):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&yi.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var E8=function(){function t(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var e=t.prototype;return e.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},e.setDrawInfo=function(t,e){this._ensureCapacity(t),this.drawByIndex=e.indexCount>0,this.instancedDraw=!!e.instanceCount,this.drawCount=Math.max(t+1,this.drawCount),this.drawByIndex?(this.counts[t]=e.indexCount,this.offsets[t]=e.firstIndex):(this.counts[t]=e.vertexCount,this.offsets[t]=e.firstVertex),this.instances[t]=Math.max(1,e.instanceCount)},e._ensureCapacity=function(t){if(!(this._capacity>t)){this._capacity=r(t);var e=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),e.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=e,this.offsets=n,this.instances=i}},t}(),w8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuBuffer=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){if("buffer"in t){this._isBufferView=!0;var e=t.buffer;this._usage=e.usage,this._memUsage=e.memUsage,this._size=this._stride=t.range,this._count=1,this._flags=e.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:e.gpuBuffer.indirects,glTarget:e.gpuBuffer.glTarget,glBuffer:e.gpuBuffer.glBuffer,glOffset:t.offset}}else this._usage=t.usage,this._memUsage=t.memUsage,this._size=t.size,this._stride=Math.max(t.stride||this._size,1),this._count=this._size/this._stride,this._flags=t.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:new E8,glTarget:0,glBuffer:null,glOffset:0},function(t,e){var n=t.gl,i=t.stateCache,r=e.memUsage&mi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(e.usage&fi.VERTEX){e.glTarget=n.ARRAY_BUFFER;var o=n.createBuffer();o&&(e.glBuffer=o,e.size>0&&(t.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),y8.gpuInputAssembler=null,t.stateCache.glArrayBuffer!==e.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer),n.bufferData(n.ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null))}else if(e.usage&fi.INDEX){e.glTarget=n.ELEMENT_ARRAY_BUFFER;var a=n.createBuffer();a&&(e.glBuffer=a,e.size>0&&(t.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),y8.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null))}else if(e.usage&fi.UNIFORM){e.glTarget=n.UNIFORM_BUFFER;var s=n.createBuffer();s&&e.size>0&&(e.glBuffer=s,t.stateCache.glUniformBuffer!==e.glBuffer&&(n.bindBuffer(n.UNIFORM_BUFFER,e.glBuffer),t.stateCache.glUniformBuffer=e.glBuffer),n.bufferData(n.UNIFORM_BUFFER,e.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),t.stateCache.glUniformBuffer=null)}else e.usage&fi.INDIRECT||e.usage&fi.TRANSFER_DST||e.usage&fi.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=n.NONE}(J5.instance,this._gpuBuffer),J5.instance.memoryStatus.bufferSize+=this._size},n.destroy=function(){this._gpuBuffer&&(this._isBufferView||(function(t,e){var n=t.gl,i=t.stateCache;if(e.glBuffer){switch(e.glTarget){case n.ARRAY_BUFFER:t.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),t.stateCache.glVAO=null),y8.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:t.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),t.stateCache.glVAO=null),y8.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null;break;case n.UNIFORM_BUFFER:n.bindBuffer(n.UNIFORM_BUFFER,null),t.stateCache.glUniformBuffer=null}n.deleteBuffer(e.glBuffer),e.glBuffer=null}}(J5.instance,this._gpuBuffer),J5.instance.memoryStatus.bufferSize-=this._size),this._gpuBuffer=null)},n.resize=function(t){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var e=this._size;e!==t&&(this._size=t,this._count=this._size/this._stride,this._gpuBuffer&&(this._gpuBuffer.size=t,t>0&&(function(t,e){var n=t.gl,i=t.stateCache,r=e.memUsage&mi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;e.usage&fi.VERTEX?(t.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),y8.gpuInputAssembler=null,i.glArrayBuffer!==e.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,e.glBuffer),e.buffer?n.bufferData(n.ARRAY_BUFFER,e.buffer,r):n.bufferData(n.ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),i.glArrayBuffer=null):e.usage&fi.INDEX?(t.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),y8.gpuInputAssembler=null,t.stateCache.glElementArrayBuffer!==e.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.glBuffer),e.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):e.usage&fi.UNIFORM?(t.stateCache.glUniformBuffer!==e.glBuffer&&n.bindBuffer(n.UNIFORM_BUFFER,e.glBuffer),n.bufferData(n.UNIFORM_BUFFER,e.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),t.stateCache.glUniformBuffer=null):(e.usage&fi.INDIRECT||e.usage&fi.TRANSFER_DST||e.usage&fi.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=n.NONE)}(J5.instance,this._gpuBuffer),J5.instance.memoryStatus.bufferSize-=e,J5.instance.memoryStatus.bufferSize+=t)))}},n.update=function(t,e){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==e?e:this._usage&fi.INDIRECT?0:t.byteLength,m8(J5.instance,this._gpuBuffer,t,0,n))},K(e,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),e}(so),P8=function(){function t(t,e){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(e),this._freeCmds=new kl(e);for(var n=0;n<e;++n)this._frees[n]=new t;this._freeIdx=e-1}var e=t.prototype;return e.alloc=function(t){if(this._freeIdx<0){var e=2*this._frees.length,n=this._frees;this._frees=new Array(e);for(var i=e-n.length,r=0;r<i;++r)this._frees[r]=new t;for(var o=i,a=0;o<e;++o,++a)this._frees[o]=n[a];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},e.free=function(t){0==--t.refCount&&this._freeCmds.push(t)},e.freeCmds=function(t){for(var e=0;e<t.length;++e)0==--t.array[e].refCount&&this._freeCmds.push(t.array[e])},e.release=function(){for(var t=0;t<this._freeCmds.length;++t){var e=this._freeCmds.array[t];e.clear(),this._frees[++this._freeIdx]=e}this._freeCmds.clear()},t}(),I8=function(){function t(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new P8(u8,1),this.bindStatesCmdPool=new P8(h8,1),this.drawCmdPool=new P8(_8,1),this.updateBufferCmdPool=new P8(f8,1),this.copyBufferToTextureCmdPool=new P8(p8,1)}var e=t.prototype;return e.clearCmds=function(t){t.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(t.beginRenderPassCmds),t.beginRenderPassCmds.clear()),t.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(t.bindStatesCmds),t.bindStatesCmds.clear()),t.drawCmds.length&&(this.drawCmdPool.freeCmds(t.drawCmds),t.drawCmds.clear()),t.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(t.updateBufferCmds),t.updateBufferCmds.clear()),t.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(t.copyBufferToTextureCmds),t.copyBufferToTextureCmds.clear()),t.cmds.clear()},e.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},t}(),R8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).cmdPackage=new d8,e._cmdAllocator=new I8,e._isInRenderPass=!1,e._curGPUPipelineState=null,e._curGPUDescriptorSets=[],e._curGPUInputAssembler=null,e._curDynamicOffsets=Array(8).fill(0),e._curDynamicStates=new Yr,e._isStateInvalied=!1,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._type=t.type,this._queue=t.queue;for(var e=J5.instance.bindingMappingInfo.bufferOffsets.length,n=0;n<e;n++)this._curGPUDescriptorSets.push(null)},n.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},n.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(t,e,n,i,r,o){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(u8);a.gpuRenderPass=t.gpuRenderPass,a.gpuFramebuffer=e.gpuFramebuffer,a.renderArea=n;for(var s=0;s<i.length;++s)a.clearColors[s]=i[s];a.clearDepth=r,a.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(r8.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(t){var e=t.gpuPipelineState;e!==this._curGPUPipelineState&&(this._curGPUPipelineState=e,this._isStateInvalied=!0)},n.bindDescriptorSet=function(t,e,n){var i=e.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[t]&&(this._curGPUDescriptorSets[t]=i,this._isStateInvalied=!0),n){var r,o=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(o){for(var a=this._curDynamicOffsets,s=o.dynamicOffsetOffsets[t],c=0;c<n.length;c++)a[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(t){var e=t.gpuInputAssembler;this._curGPUInputAssembler=e,this._isStateInvalied=!0},n.setViewport=function(t){var e=this._curDynamicStates.viewport;e.left===t.left&&e.top===t.top&&e.width===t.width&&e.height===t.height&&e.minDepth===t.minDepth&&e.maxDepth===t.maxDepth||(e.left=t.left,e.top=t.top,e.width=t.width,e.height=t.height,e.minDepth=t.minDepth,e.maxDepth=t.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(t){var e=this._curDynamicStates.scissor;e.x===t.x&&e.y===t.y&&e.width===t.width&&e.height===t.height||(e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,this._isStateInvalied=!0)},n.setLineWidth=function(t){this._curDynamicStates.lineWidth!==t&&(this._curDynamicStates.lineWidth=t,this._isStateInvalied=!0)},n.setDepthBias=function(t,e,n){var i=this._curDynamicStates;i.depthBiasConstant===t&&i.depthBiasClamp===e&&i.depthBiasSlope===n||(i.depthBiasConstant=t,i.depthBiasClamp=e,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(t){var e=this._curDynamicStates.blendConstant;e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w||(e.copy(t),this._isStateInvalied=!0)},n.setDepthBound=function(t,e){var n=this._curDynamicStates;n.depthMinBounds===t&&n.depthMaxBounds===e||(n.depthMinBounds=t,n.depthMaxBounds=e,this._isStateInvalied=!0)},n.setStencilWriteMask=function(t,e){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;t&Vi.FRONT&&n.writeMask!==e&&(n.writeMask=e,this._isStateInvalied=!0),t&Vi.BACK&&i.writeMask!==e&&(i.writeMask=e,this._isStateInvalied=!0)},n.setStencilCompareMask=function(t,e,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;t&Vi.FRONT&&(i.compareMask===n&&i.reference===e||(i.reference=e,i.compareMask=n,this._isStateInvalied=!0)),t&Vi.BACK&&(r.compareMask===n&&r.reference===e||(r.reference=e,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(t){if(this._type===ji.PRIMARY&&this._isInRenderPass||this._type===ji.SECONDARY){this._isStateInvalied&&this.bindStates();var e="drawInfo"in t?t.drawInfo:t,n=this._cmdAllocator.drawCmdPool.alloc(_8);n.drawInfo.copy(e),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push(r8.DRAW),++this._numDrawCalls,this._numInstances+=e.instanceCount;var i=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(t,e,n){if(this._type===ji.PRIMARY&&!this._isInRenderPass||this._type===ji.SECONDARY){var i=t.gpuBuffer;if(i){var r,o=this._cmdAllocator.updateBufferCmdPool.alloc(f8),a=0;t.usage&fi.INDIRECT||(a=void 0!==n?n:e.byteLength),r=e,o.gpuBuffer=i,o.buffer=r,o.offset=0,o.size=a,this.cmdPackage.updateBufferCmds.push(o),this.cmdPackage.cmds.push(r8.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(t,e,n){if(this._type===ji.PRIMARY&&!this._isInRenderPass||this._type===ji.SECONDARY){var i=e.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(p8);r.gpuTexture=i,r.regions=n,r.buffers=t,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(r8.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(t,e){for(var n=0;n<e;++n){for(var i=t[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var o=i.cmdPackage.beginRenderPassCmds.array[r];++o.refCount,this.cmdPackage.beginRenderPassCmds.push(o)}for(var a=0;a<i.cmdPackage.bindStatesCmds.length;++a){var s=i.cmdPackage.bindStatesCmds.array[a];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var _=0;_<i.cmdPackage.copyBufferToTextureCmds.length;++_){var f=i.cmdPackage.copyBufferToTextureCmds.array[_];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var t=this._cmdAllocator.bindStatesCmdPool.alloc(h8);t.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(t.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(t.dynamicOffsets,this._curDynamicOffsets),t.gpuInputAssembler=this._curGPUInputAssembler,t.dynamicStates=this._curDynamicStates,this.cmdPackage.bindStatesCmds.push(t),this.cmdPackage.cmds.push(r8.BIND_STATES),this._isStateInvalied=!1},e}(co),D8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuFramebuffer=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._renderPass=t.renderPass,this._colorTextures=t.colorTextures||[],this._depthStencilTexture=t.depthStencilTexture||null;for(var e=[],n=0;n<t.colorTextures.length;n++){var i=t.colorTextures[n];i&&e.push(i.gpuTexture)}var r=null;t.depthStencilTexture&&(r=t.depthStencilTexture.gpuTexture);var o=Number.MAX_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:t.renderPass.gpuRenderPass,gpuColorTextures:e,gpuDepthStencilTexture:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?o:this.gpuColorTextures[0].width},set width(t){o=t},get height(){return this.isOffscreen?a:this.gpuColorTextures[0].height},set height(t){a=t}},function(t,e){for(var n=0;n<e.gpuColorTextures.length;++n)if(e.gpuColorTextures[n].isSwapchainTexture)return void(e.isOffscreen=!1);var i=t.gl,r=[],o=i.createFramebuffer();if(o){e.glFramebuffer=o,t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.glFramebuffer);for(var a=0;a<e.gpuColorTextures.length;++a){var s=e.gpuColorTextures[a];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+a),e.width=Math.min(e.width,s.width),e.height=Math.min(e.height,s.height))}var c=e.gpuDepthStencilTexture;if(c){var l=Jr[c.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,c.glRenderbuffer),e.width=Math.min(e.width,c.width),e.height=Math.min(e.height,c.height)}i.drawBuffers(r);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.stateCache.glFramebuffer)}}(J5.instance,this._gpuFramebuffer)},n.destroy=function(){var t,e;this._gpuFramebuffer&&(t=J5.instance,(e=this._gpuFramebuffer).glFramebuffer&&(t.gl.deleteFramebuffer(e.glFramebuffer),t.stateCache.glFramebuffer===e.glFramebuffer&&(t.gl.bindFramebuffer(t.gl.FRAMEBUFFER,null),t.stateCache.glFramebuffer=null),e.glFramebuffer=null),this._gpuFramebuffer=null)},K(e,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),e}(ho),B8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuInputAssembler=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){if(0!==t.vertexBuffers.length){if(this._attributes=t.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=t.vertexBuffers,t.indexBuffer)this._indexBuffer=t.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var e=this._vertexBuffers[0];this._drawInfo.vertexCount=e.size/e.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=t.indirectBuffer||null;for(var n=new Array(t.vertexBuffers.length),i=0;i<t.vertexBuffers.length;++i){var r=t.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var o=null,a=0;if(t.indexBuffer&&(o=t.indexBuffer.gpuBuffer))switch(o.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Illegal index buffer stride.")}var s=null;t.indirectBuffer&&(s=t.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:t.attributes,gpuVertexBuffers:n,gpuIndexBuffer:o,gpuIndirectBuffer:s,glAttribs:[],glIndexType:a,glVAOs:new Map},function(t,e){var n=t.gl;e.glAttribs=new Array(e.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<e.attributes.length;++r){var o=e.attributes[r],a=void 0!==o.stream?o.stream:0,s=e.gpuVertexBuffers[a],c=$5(o.format,n),l=Jr[o.format].size;e.glAttribs[r]={name:o.name,glBuffer:s.glBuffer,glType:c,size:l,count:Jr[o.format].count,stride:s.stride,componentCount:i8(c,n),isNormalized:void 0!==o.isNormalized&&o.isNormalized,isInstanced:void 0!==o.isInstanced&&o.isInstanced,offset:i[a]},i[a]+=l}}(J5.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},n.destroy=function(){var t=J5.instance;this._gpuInputAssembler&&t.extensions.useVAO&&function(t,e){for(var n=e.glVAOs.values(),i=n.next(),r=t.gl,o=t.stateCache.glVAO;!i.done;)r.deleteVertexArray(i.value),o===i.value&&(r.bindVertexArray(null),o=null),i=n.next();t.stateCache.glVAO=o,e.glVAOs.clear()}(t,this._gpuInputAssembler),this._gpuInputAssembler=null},K(e,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),e}(mo),M8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuDescriptorSetLayout=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){Array.prototype.push.apply(this._bindings,t.bindings);for(var e=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var o=this._bindings[r];i.push(e),e+=o.count,o.binding>n&&(n=o.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var a=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,a[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&$r)for(var _=0;_<h.count;_++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:a,descriptorCount:e}},n.destroy=function(){this._bindings.length=0},K(e,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),e}(go),O8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuPipelineLayout=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){Array.prototype.push.apply(this._setLayouts,t.setLayouts);for(var e=[],n=[],i=0,r=[],o=0;o<this._setLayouts.length;o++){for(var a=this._setLayouts[o],s=a.gpuDescriptorSetLayout.dynamicBindings,c=Array(a.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(a.gpuDescriptorSetLayout),e.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:e,dynamicOffsetCount:i,dynamicOffsetOffsets:r}},n.destroy=function(){this._setLayouts.length=0},K(e,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),e}(yo),N8=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],L8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuPipelineState=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._primitive=t.primitive,this._shader=t.shader,this._pipelineLayout=t.pipelineLayout;var e=this._bs;if(t.blendState){var n=t.blendState,i=n.targets;i&&i.forEach((function(t,n){e.setTarget(n,t)})),void 0!==n.isA2C&&(e.isA2C=n.isA2C),void 0!==n.isIndepend&&(e.isIndepend=n.isIndepend),void 0!==n.blendColor&&(e.blendColor=n.blendColor)}Object.assign(this._rs,t.rasterizerState),Object.assign(this._dss,t.depthStencilState),this._is=t.inputState,this._renderPass=t.renderPass,this._dynamicStates=t.dynamicStates;for(var r=[],o=0;o<31;o++)this._dynamicStates&1<<o&&r.push(1<<o);this._gpuPipelineState={glPrimitive:N8[t.primitive],gpuShader:t.shader.gpuShader,gpuPipelineLayout:t.pipelineLayout.gpuPipelineLayout,rs:t.rasterizerState,dss:t.depthStencilState,bs:t.blendState,gpuRenderPass:t.renderPass.gpuRenderPass,dynamicStates:r}},n.destroy=function(){this._gpuPipelineState=null},K(e,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),e}(To),F8=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.beginRenderPass=function(t,e,n,i,r,o){x8(J5.instance,t.gpuRenderPass,e.gpuFramebuffer,n,i,r,o),this._isInRenderPass=!0},n.draw=function(t){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var e="drawInfo"in t?t.drawInfo:t;C8(J5.instance,e),++this._numDrawCalls,this._numInstances+=e.instanceCount;var n=e.indexCount||e.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(e.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(e.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.setViewport=function(t){var e=J5.instance,n=e.stateCache,i=e.gl;n.viewport.left===t.left&&n.viewport.top===t.top&&n.viewport.width===t.width&&n.viewport.height===t.height||(i.viewport(t.left,t.top,t.width,t.height),n.viewport.left=t.left,n.viewport.top=t.top,n.viewport.width=t.width,n.viewport.height=t.height)},n.setScissor=function(t){var e=J5.instance,n=e.stateCache,i=e.gl;n.scissorRect.x===t.x&&n.scissorRect.y===t.y&&n.scissorRect.width===t.width&&n.scissorRect.height===t.height||(i.scissor(t.x,t.y,t.width,t.height),n.scissorRect.x=t.x,n.scissorRect.y=t.y,n.scissorRect.width=t.width,n.scissorRect.height=t.height)},n.updateBuffer=function(t,e,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=t.gpuBuffer;r&&(i=void 0!==n?n:t.usage&fi.INDIRECT?0:e.byteLength,m8(J5.instance,r,e,0,i))}},n.copyBuffersToTexture=function(t,e,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=e.gpuTexture;i&&T8(J5.instance,t,i,n)}},n.execute=function(t,e){for(var n=0;n<e;++n){var i=t[n];b8(J5.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){S8(J5.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},e}(R8),z8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).numDrawCalls=0,e.numInstances=0,e.numTris=0,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._type=t.type},n.destroy=function(){},n.submit=function(t){for(var e=0;e<t.length;e++){var n=t[e];this.numDrawCalls+=n.numDrawCalls,this.numInstances+=n.numInstances,this.numTris+=n.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},e}(Eo),G8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuRenderPass=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._colorInfos=t.colorAttachments,this._depthStencilInfo=t.depthStencilAttachment,this._subpasses=t.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},K(e,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),e}(wo),V8=function(t){function e(e,n){var i,r,o,a,s;return(i=t.call(this,e,n)||this)._gpuSampler=null,i._gpuSampler={glSampler:null,minFilter:i._info.minFilter,magFilter:i._info.magFilter,mipFilter:i._info.mipFilter,addressU:i._info.addressU,addressV:i._info.addressV,addressW:i._info.addressW,glMinFilter:0,glMagFilter:0,glWrapS:0,glWrapT:0,glWrapR:0},r=J5.instance,o=i._gpuSampler,(s=(a=r.gl).createSampler())&&(o.minFilter===Ci.LINEAR||o.minFilter===Ci.ANISOTROPIC?o.mipFilter===Ci.LINEAR||o.mipFilter===Ci.ANISOTROPIC?o.glMinFilter=a.LINEAR_MIPMAP_LINEAR:o.mipFilter===Ci.POINT?o.glMinFilter=a.LINEAR_MIPMAP_NEAREST:o.glMinFilter=a.LINEAR:o.mipFilter===Ci.LINEAR||o.mipFilter===Ci.ANISOTROPIC?o.glMinFilter=a.NEAREST_MIPMAP_LINEAR:o.mipFilter===Ci.POINT?o.glMinFilter=a.NEAREST_MIPMAP_NEAREST:o.glMinFilter=a.NEAREST,o.magFilter===Ci.LINEAR||o.magFilter===Ci.ANISOTROPIC?o.glMagFilter=a.LINEAR:o.glMagFilter=a.NEAREST,o.glWrapS=Q5[o.addressU],o.glWrapT=Q5[o.addressV],o.glWrapR=Q5[o.addressW],o.glSampler=s,a.samplerParameteri(s,a.TEXTURE_MIN_FILTER,o.glMinFilter),a.samplerParameteri(s,a.TEXTURE_MAG_FILTER,o.glMagFilter),a.samplerParameteri(s,a.TEXTURE_WRAP_S,o.glWrapS),a.samplerParameteri(s,a.TEXTURE_WRAP_T,o.glWrapT),a.samplerParameteri(s,a.TEXTURE_WRAP_R,o.glWrapR),a.samplerParameterf(s,a.TEXTURE_MIN_LOD,0),a.samplerParameterf(s,a.TEXTURE_MAX_LOD,1e3)),i}return Q(e,t),e.prototype.destroy=function(){this._gpuSampler&&(function(t,e){var n=t.gl;if(e.glSampler){n.deleteSampler(e.glSampler);for(var i=t.stateCache.glSamplerUnits,r=0;r<i.length;++r)i[r]===e.glSampler&&(n.bindSampler(r,null),i[r]=null);e.glSampler=null}}(J5.instance,this._gpuSampler),this._gpuSampler=null)},K(e,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),e}(Po),U8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuShader=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._name=t.name,this._stages=t.stages,this._attributes=t.attributes,this._blocks=t.blocks,this._samplers=t.samplers,this._gpuShader={name:t.name,blocks:t.blocks.slice(),samplerTextures:t.samplerTextures.slice(),subpassInputs:t.subpassInputs.slice(),gpuStages:new Array(t.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var e=0;e<t.stages.length;++e){var n=t.stages[e];this._gpuShader.gpuStages[e]={type:n.stage,source:n.source,glShader:null}}!function(t,e){for(var n=t.gl,i=function(t){var i=e.gpuStages[t],r=0,o="",a=1;switch(i.type){case Ii.VERTEX:o="VertexShader",r=n.VERTEX_SHADER;break;case Ii.FRAGMENT:o="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,"#version 300 es\n"+i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(o+" in '"+e.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+a+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<e.gpuStages.length;c++){var l=e.gpuStages[t];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<e.gpuStages.length;r++){var o=i(r);if("object"==typeof o)return o.v}var a=n.createProgram();if(a){e.glProgram=a;for(var s=0;s<e.gpuStages.length;s++){var c=e.gpuStages[s];n.attachShader(e.glProgram,c.glShader)}n.linkProgram(e.glProgram);for(var l=0;l<e.gpuStages.length;l++){var u=e.gpuStages[l];u.glShader&&(n.detachShader(e.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(e.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+e.name+"'."),void console.error(n.getProgramInfoLog(e.glProgram));C("Shader '"+e.name+"' compilation succeeded.");var h=n.getProgramParameter(e.glProgram,n.ACTIVE_ATTRIBUTES);e.glInputs=new Array(h);for(var _=0;_<h;++_){var f=n.getActiveAttrib(e.glProgram,_);if(f){var p,d=f.name.indexOf("[");p=-1!==d?f.name.substr(0,d):f.name;var m=n.getAttribLocation(e.glProgram,p),v=e8(f.type,n),g=n8(f.type,n);e.glInputs[_]={name:p,type:v,stride:g,count:f.size,size:g*f.size,glType:f.type,glLoc:m}}}var y,S,A,b,T=n.getProgramParameter(e.glProgram,n.ACTIVE_UNIFORM_BLOCKS);if(T){e.glBlocks=new Array(T);for(var E=0;E<T;++E){var w=(y=n.getActiveUniformBlockName(e.glProgram,E)).indexOf("[");-1!==w&&(y=y.substr(0,w)),b=null;for(var P=0;P<e.blocks.length;P++)if(e.blocks[P].name===y){b=e.blocks[P];break}if(b){S=E,A=n.getActiveUniformBlockParameter(e.glProgram,S,n.UNIFORM_BLOCK_DATA_SIZE);var I=b.binding+(t.bindingMappingInfo.bufferOffsets[b.set]||0);n.uniformBlockBinding(e.glProgram,S,I),e.glBlocks[E]={set:b.set,binding:b.binding,idx:S,name:y,size:A,glBinding:I}}else x("Block '"+y+"' does not bound")}}for(var R=0;R<e.subpassInputs.length;++R){var D=e.subpassInputs[R];e.samplerTextures.push(new yr(D.set,D.binding,D.name,_i.SAMPLER2D,D.count))}if(e.samplerTextures.length>0){e.glSamplerTextures=new Array(e.samplerTextures.length);for(var B=0;B<e.samplerTextures.length;++B){var M=e.samplerTextures[B];e.glSamplerTextures[B]={set:M.set,binding:M.binding,name:M.name,type:M.type,count:M.count,units:[],glUnits:null,glType:t8(M.type,n),glLoc:null}}}for(var O=[],N=[],L=t.stateCache.texUnitCacheMap,F=0,z=0;z<e.blocks.length;++z)e.blocks[z].set===t.bindingMappingInfo.flexibleSet&&F++;for(var G=0,V=0;V<e.samplerTextures.length;++V){var U=e.samplerTextures[V],k=n.getUniformLocation(e.glProgram,U.name);if(k&&-1!==k.id&&(O.push(e.glSamplerTextures[V]),N.push(k)),void 0===L[U.name]){var H=U.binding+t.bindingMappingInfo.samplerOffsets[U.set]+G;U.set===t.bindingMappingInfo.flexibleSet&&(H-=F),L[U.name]=H%t.capabilities.maxTextureUnits,G+=U.count-1}}if(O.length){for(var j=[],W=0;W<O.length;++W){var q=O[W],X=L[q.name];if(void 0!==X){q.glLoc=N[W];for(var Y=0;Y<q.count;++Y){for(;j[X];)X=(X+1)%t.capabilities.maxTextureUnits;q.units.push(X),j[X]=!0}}}for(var K=0,J=0;J<O.length;++J){var Q=O[J];if(!Q.glLoc){for(Q.glLoc=N[J];j[K];)K++;for(var Z=0;Z<Q.count;++Z){for(;j[K];)K=(K+1)%t.capabilities.maxTextureUnits;void 0===L[Q.name]&&(L[Q.name]=K),Q.units.push(K),j[K]=!0}}}t.stateCache.glProgram!==e.glProgram&&n.useProgram(e.glProgram);for(var $=0;$<O.length;$++){var tt=O[$];tt.glUnits=new Int32Array(tt.units),n.uniform1iv(tt.glLoc,tt.glUnits)}t.stateCache.glProgram!==e.glProgram&&n.useProgram(t.stateCache.glProgram)}e.glSamplerTextures=O}}(J5.instance,this._gpuShader)},n.destroy=function(){var t,e;this._gpuShader&&(t=J5.instance,(e=this._gpuShader).glProgram&&(t.gl.deleteProgram(e.glProgram),t.stateCache.glProgram===e.glProgram&&(t.gl.useProgram(null),t.stateCache.glProgram=null),e.glProgram=null),this._gpuShader=null)},K(e,[{key:"gpuShader",get:function(){return this._gpuShader}}]),e}(Io),k8=function(){function t(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=[],this.glBindUBOOffsets=[],this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glSamplerUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=new rr,this.scissorRect=new Qi(0,0,0,0),this.rs=new xo,this.dss=new So,this.bs=new Ao,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return t.prototype.initialize=function(t,e,n){for(var i=0;i<t;++i)this.glTexUnits.push({glTexture:null});this.glSamplerUnits.length=t,this.glSamplerUnits.fill(null),this.glBindUBOs.length=e,this.glBindUBOs.fill(null),this.glBindUBOOffsets.length=e,this.glBindUBOOffsets.fill(0),this.glEnabledAttribLocs.length=n,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=n,this.glCurrentAttribLocs.fill(!1)},t}(),H8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._gpuTexture=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t,e){"texture"in t?console.log("WebGL2 does not support texture view."):(this._type=t.type,this._usage=t.usage,this._format=t.format,this._width=t.width,this._height=t.height,this._depth=t.depth,this._layerCount=t.layerCount,this._levelCount=t.levelCount,this._samples=t.samples,this._flags=t.flags,this._isPowerOf2=to(this._width)&&to(this._height),this._size=no(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:e||!1},v8(J5.instance,this._gpuTexture),J5.instance.memoryStatus.textureSize+=this._size)},n.destroy=function(){this._gpuTexture&&(g8(J5.instance,this._gpuTexture),J5.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(t,e){var n=this._size;this._width=t,this._height=e,this._size=no(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=t,this._gpuTexture.height=e,this._gpuTexture.size=this._size,function(t,e){if(e.size){var n=t.gl,i=e.width,r=e.height;switch(e.type){case vi.TEX2D:e.glTarget=n.TEXTURE_2D;var o=Math.max(i,r);if(o>t.capabilities.maxTextureSize&&D(9100,o,t.capabilities.maxTextureSize),e.samples===xi.ONE){var a=t.stateCache.glTexUnits[t.stateCache.texUnit];if(a.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_2D,e.glTexture),a.glTexture=e.glTexture),Jr[e.format].isCompressed)for(var s=0;s<e.mipLevel;++s){var c=eo(e.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,e.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else g8(t,e),v8(t,e)}else e.glRenderbuffer&&(t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,e.samples,e.glInternalFmt,e.width,e.height));break;case vi.CUBE:e.type=vi.CUBE,e.glTarget=n.TEXTURE_CUBE_MAP;var u=Math.max(i,r);u>t.capabilities.maxCubeMapTextureSize&&D(9100,u,t.capabilities.maxTextureSize);var h=t.stateCache.glTexUnits[t.stateCache.texUnit];if(h.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,e.glTexture),h.glTexture=e.glTexture),Jr[e.format].isCompressed)for(var _=0;_<6;++_){i=e.width,r=e.height;for(var f=0;f<e.mipLevel;++f){var p=eo(e.format,i,r,1),d=new Uint8Array(p);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+_,f,e.glInternalFmt,i,r,0,d),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else g8(t,e),v8(t,e);break;default:console.error("Unsupported TextureType, create texture failed."),e.type=vi.TEX2D,e.glTarget=n.TEXTURE_2D}}}(J5.instance,this._gpuTexture),J5.instance.memoryStatus.textureSize-=n,J5.instance.memoryStatus.textureSize+=this._size)},n.initAsSwapchainTexture=function(t){var e=new pr;e.format=t.format,e.usage=Jr[t.format].hasDepth?gi.DEPTH_STENCIL_ATTACHMENT:gi.COLOR_ATTACHMENT,e.width=t.width,e.height=t.height,this.initialize(e,!0)},K(e,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),e}(Ro),j8="webglcontextlost";function W8(t,e){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=t.getExtension(n[i]+e);if(r)return r}return null}function q8(t){var e={EXT_texture_filter_anisotropic:W8(t,"EXT_texture_filter_anisotropic"),EXT_color_buffer_half_float:W8(t,"EXT_color_buffer_half_float"),EXT_color_buffer_float:W8(t,"EXT_color_buffer_float"),WEBGL_compressed_texture_etc1:W8(t,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:W8(t,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:W8(t,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_astc:W8(t,"WEBGL_compressed_texture_astc"),WEBGL_compressed_texture_s3tc:W8(t,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:W8(t,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:W8(t,"WEBGL_debug_shaders"),WEBGL_lose_context:W8(t,"WEBGL_lose_context"),WEBGL_debug_renderer_info:W8(t,"WEBGL_debug_renderer_info"),OES_texture_half_float_linear:W8(t,"OES_texture_half_float_linear"),OES_texture_float_linear:W8(t,"OES_texture_float_linear"),WEBGL_multi_draw:null,useVAO:!0};return hu.os!==nu.ANDROID&&hu.os!==nu.IOS&&(e.WEBGL_multi_draw=W8(t,"WEBGL_multi_draw")),e}var X8=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).stateCache=new k8,e.nullTex2D=null,e.nullTexCube=null,e._canvas=null,e._webGL2ContextLostHandler=null,e._extensions=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){this._canvas=t.windowHandle,this._webGL2ContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(j8,this._onWebGLContextLost);var e=J5.instance.gl;this.stateCache.initialize(J5.instance.capabilities.maxTextureUnits,J5.instance.capabilities.maxUniformBufferBindings,J5.instance.capabilities.maxVertexAttributes),this._extensions=q8(e),function(t){t.activeTexture(t.TEXTURE0),t.pixelStorei(t.PACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.bindFramebuffer(t.FRAMEBUFFER,null),t.enable(t.SCISSOR_TEST),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.frontFace(t.CCW),t.polygonOffset(0,0),t.enable(t.DEPTH_TEST),t.depthMask(!0),t.depthFunc(t.LESS),t.stencilFuncSeparate(t.FRONT,t.ALWAYS,1,65535),t.stencilOpSeparate(t.FRONT,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.FRONT,65535),t.stencilFuncSeparate(t.BACK,t.ALWAYS,1,65535),t.stencilOpSeparate(t.BACK,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.BACK,65535),t.disable(t.STENCIL_TEST),t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.BLEND),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ZERO,t.ONE,t.ZERO),t.colorMask(!0,!0,!0,!0),t.blendColor(0,0,0,0)}(e);var n=ui.RGBA8,i=ui.DEPTH_STENCIL,r=e.getParameter(e.DEPTH_BITS),o=e.getParameter(e.STENCIL_BITS);r&&o?i=ui.DEPTH_STENCIL:r&&(i=ui.DEPTH),this._colorTexture=new H8,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:t.width,height:t.height}),this._depthStencilTexture=new H8,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:t.width,height:t.height}),this.nullTex2D=J5.instance.createTexture(new pr(vi.TEX2D,gi.SAMPLED,ui.RGBA8,2,2,yi.NONE)),this.nullTexCube=J5.instance.createTexture(new pr(vi.CUBE,gi.SAMPLED,ui.RGBA8,2,2,yi.NONE,6));var a=new ir;a.texExtent.width=2,a.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),J5.instance.copyBuffersToTexture([s],this.nullTex2D,[a]),a.texSubres.layerCount=6,J5.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[a])},n.destroy=function(){this._canvas&&this._webGL2ContextLostHandler&&(this._canvas.removeEventListener(j8,this._webGL2ContextLostHandler),this._webGL2ContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},n.resize=function(t,e){this._colorTexture.width===t&&this._colorTexture.height===e||(C("Resizing swapchain: "+t+"x"+e),this._canvas.width=t,this._canvas.height=e,this._colorTexture.resize(t,e),this._depthStencilTexture.resize(t,e))},n._onWebGLContextLost=function(t){I(11e3),y(t)},K(e,[{key:"extensions",get:function(){return this._extensions}}]),e}(uo),Y8=t("WebGL2Device",function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._swapchain=null,e._context=null,e}Q(e,t);var n=e.prototype;return n.initialize=function(t){J5.setInstance(this),this._gfxAPI=si.WEBGL2,this._bindingMappingInfo=t.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);var e=this._context=function(t){var e=null;try{var n={alpha:ce.ENABLE_TRANSPARENT_CANVAS,antialias:ce.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};e=t.getContext("webgl2",n)}catch(t){return null}return e}(lo.canvas);if(!e)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new Hr(ki.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new kr(this._queue)),this._caps.maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxUniformBufferBindings=e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS),this._caps.maxUniformBlockSize=e.getParameter(e.MAX_UNIFORM_BLOCK_SIZE),this._caps.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.uboOffsetAlignment=e.getParameter(e.UNIFORM_BUFFER_OFFSET_ALIGNMENT);var n=e.getSupportedExtensions(),i="";if(n)for(var r,o=ot(n);!(r=o()).done;)i+=r.value+" ";var a=q8(e);a.WEBGL_debug_renderer_info?(this._renderer=e.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=e.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=e.getParameter(e.RENDERER),this._vendor=e.getParameter(e.VENDOR));var s=e.getParameter(e.VERSION);this._features.fill(!1),this._features[li.TEXTURE_FLOAT]=!0,this._features[li.TEXTURE_HALF_FLOAT]=!0,this._features[li.FORMAT_R11G11B10F]=!0,this._features[li.FORMAT_SRGB]=!0,this._features[li.FORMAT_RGB8]=!0,this._features[li.ELEMENT_INDEX_UINT]=!0,this._features[li.INSTANCED_ARRAYS]=!0,this._features[li.MULTIPLE_RENDER_TARGETS]=!0,this._features[li.BLEND_MINMAX]=!0,a.EXT_color_buffer_float&&(this._features[li.COLOR_FLOAT]=!0,this._features[li.COLOR_HALF_FLOAT]=!0),a.OES_texture_float_linear&&(this._features[li.TEXTURE_FLOAT_LINEAR]=!0),a.OES_texture_half_float_linear&&(this._features[li.TEXTURE_HALF_FLOAT_LINEAR]=!0);var c="";return a.WEBGL_compressed_texture_etc1&&(this._features[li.FORMAT_ETC1]=!0,c+="etc1 "),a.WEBGL_compressed_texture_etc&&(this._features[li.FORMAT_ETC2]=!0,c+="etc2 "),a.WEBGL_compressed_texture_s3tc&&(this._features[li.FORMAT_DXT]=!0,c+="dxt "),a.WEBGL_compressed_texture_pvrtc&&(this._features[li.FORMAT_PVRTC]=!0,c+="pvrtc "),a.WEBGL_compressed_texture_astc&&(this._features[li.FORMAT_ASTC]=!0,c+="astc "),C("WebGL2 device initialized."),C("RENDERER: "+this._renderer),C("VENDOR: "+this._vendor),C("VERSION: "+s),C("COMPRESSED_FORMAT: "+c),C("EXTENSIONS: "+i),!0},n.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null);for(var t=this._samplers.values(),e=t.next();!e.done;)e.value.destroy(),e=t.next();this._swapchain=null},n.flushCommands=function(){},n.acquire=function(){},n.present=function(){var t=this._queue;this._numDrawCalls=t.numDrawCalls,this._numInstances=t.numInstances,this._numTris=t.numTris,t.clear()},n.createCommandBuffer=function(t){var e=new(t.type===ji.PRIMARY?F8:R8);return e.initialize(t),e},n.createSwapchain=function(t){var e=new X8;return this._swapchain=e,e.initialize(t),e},n.createBuffer=function(t){var e=new w8;return e.initialize(t),e},n.createTexture=function(t){var e=new H8;return e.initialize(t),e},n.createDescriptorSet=function(t){var e=new K5;return e.initialize(t),e},n.createShader=function(t){var e=new U8;return e.initialize(t),e},n.createInputAssembler=function(t){var e=new B8;return e.initialize(t),e},n.createRenderPass=function(t){var e=new G8;return e.initialize(t),e},n.createFramebuffer=function(t){var e=new D8;return e.initialize(t),e},n.createDescriptorSetLayout=function(t){var e=new M8;return e.initialize(t),e},n.createPipelineLayout=function(t){var e=new O8;return e.initialize(t),e},n.createPipelineState=function(t){var e=new L8;return e.initialize(t),e},n.createQueue=function(t){var e=new z8;return e.initialize(t),e},n.getSampler=function(t){var e=Po.computeHash(t);return this._samplers.has(e)||this._samplers.set(e,new V8(t,e)),this._samplers.get(e)},n.getGlobalBarrier=function(t){var e=Do.computeHash(t);return this._globalBarriers.has(e)||this._globalBarriers.set(e,new Do(t,e)),this._globalBarriers.get(e)},n.getTextureBarrier=function(t){var e=Bo.computeHash(t);return this._textureBarriers.has(e)||this._textureBarriers.set(e,new Bo(t,e)),this._textureBarriers.get(e)},n.copyBuffersToTexture=function(t,e,n){T8(this,t,e.gpuTexture,n)},n.copyTextureToBuffers=function(t,e,n){!function(t,e,n,i){var r=t.gl,o=t.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var s=0,c=0,l=1,u=1;switch(e.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,e.glTarget,e.glTexture,_.texSubres.mipLevel),s=_.texOffset.x,c=_.texOffset.y,l=_.texExtent.width,u=_.texExtent.height,r.readPixels(s,c,l,u,e.glFormat,e.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),o.glFramebuffer=null,r.deleteFramebuffer(a)}(this,t.gpuTexture,e,n)},n.copyTexImagesToTexture=function(t,e,n){!function(t,e,n,i){var r=t.gl,o=t.stateCache.glTexUnits[t.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,e[a++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],_=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<_;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,e[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&yi.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}(this,t,e.gpuTexture,n)},K(e,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}}]),e}(lo));function K8(t,e,n,i){var r=(i.x-n.x)*(t.y-n.y)-(i.y-n.y)*(t.x-n.x),o=(e.x-t.x)*(t.y-n.y)-(e.y-t.y)*(t.x-n.x),a=(i.y-n.y)*(e.x-t.x)-(i.x-n.x)*(e.y-t.y);if(0!==a){var s=r/a,c=o/a;if(s>=0&&s<=1&&c>=0&&c<=1)return!0}return!1}c.WebGL2Device=Y8;var J8=new Wn,Q8=new Wn,Z8=new Wn,$8=new Wn;function t6(t,e,n){for(var i=n.length,r=0;r<i;++r)if(K8(t,e,n[r],n[(r+1)%i]))return!0;return!1}function e6(t,e){for(var n=!1,i=t.x,r=t.y,o=e.length,a=0,s=o-1;a<o;s=a++){var c=e[a].x,l=e[a].y,u=e[s].x,h=e[s].y;l>r!=h>r&&i<(u-c)*(r-l)/(h-l)+c&&(n=!n)}return n}function n6(t,e,n,i){var r,o=n.x-e.x,a=n.y-e.y,s=o*o+a*a,c=((t.x-e.x)*o+(t.y-e.y)*a)/s;return r=i?s?c<0?e:c>1?n:J8.set(e.x+c*o,e.y+c*a):e:J8.set(e.x+c*o,e.y+c*a),o=t.x-r.x,a=t.y-r.y,Math.sqrt(o*o+a*a)}var i6,r6,o6=t("Intersection2D",(function(){}));o6.lineLine=K8,o6.lineRect=function(t,e,n){var i=J8.set(n.x,n.y),r=Q8.set(n.x,n.yMax),o=Z8.set(n.xMax,n.yMax),a=$8.set(n.xMax,n.y);return!!(K8(t,e,i,r)||K8(t,e,r,o)||K8(t,e,o,a)||K8(t,e,a,i))},o6.linePolygon=t6,o6.rectRect=function(t,e){var n=t.x,i=t.y,r=t.x+t.width,o=t.y+t.height,a=e.x,s=e.y,c=e.x+e.width,l=e.y+e.height;return n<=c&&r>=a&&i<=l&&o>=s},o6.rectPolygon=function(t,e){var n=J8.set(t.x,t.y),i=Q8.set(t.x,t.yMax),r=Z8.set(t.xMax,t.yMax),o=$8.set(t.xMax,t.y);if(t6(n,i,e))return!0;if(t6(i,r,e))return!0;if(t6(r,o,e))return!0;if(t6(o,n,e))return!0;for(var a=0,s=e.length;a<s;++a)if(t.contains(e[a]))return!0;return!!(e6(n,e)||e6(i,e)||e6(r,e)||e6(o,e))},o6.rectCircle=function(t,e,n){var i=e.x,r=e.y,o=t.x,a=t.y,s=t.width,c=t.height,l=i,u=r;i<o?l=o:i>o+s&&(l=o+s),r<a?u=a:r>a+c&&(u=a+c);var h=i-l,_=r-u;return Math.sqrt(h*h+_*_)<=n},o6.polygonPolygon=function(t,e){var n,i;for(n=0,i=t.length;n<i;++n)if(t6(t[n],t[(n+1)%i],e))return!0;for(n=0,i=e.length;n<i;++n)if(e6(e[n],t))return!0;for(n=0,i=t.length;n<i;++n)if(e6(t[n],e))return!0;return!1},o6.circleCircle=function(t,e,n,i){return Wn.distance(t,n)<e+i},o6.polygonCircle=function(t,e,n){var i=e;if(e6(i,t))return!0;for(var r=0,o=t.length;r<o;r++)if(n6(i,0===r?t[t.length-1]:t[r-1],t[r],!0)<n)return!0;return!1},o6.pointInPolygon=e6,o6.pointLineDistance=n6,"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var a6,s6=function(t,e){return function(t,e){!function(t){function e(t){if(!t){for(var e=arguments.length,n=new Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];throw et(Error,n)}}function n(t,e){return void 0!==t?t:e}var i=1e37,r=1e-5,o=r*r,a=3.14159265359,s=2,c=8,l=.1,u=2,h=.008,_=2/180*a,f=2*h,p=8,d=32,m=1,v=.2,g=8/180*a,y=2,x=y*y,S=.5*a,C=S*S,A=.2,b=.75,T=-1,E=2147483647,w=.75,P=1,I=.25,R=.5,D=2,B=D*D,M=256,O=2.5,N=.5,L=.01,F=2/180*a;function z(){return null}function G(){}function V(){}var U=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this.major=0,this.minor=0,this.revision=0,this.major=t,this.minor=e,this.revision=n}return t.prototype.toString=function(){return this.major+"."+this.minor+"."+this.revision},t}(),k=new U(2,3,2),H="master",j="fbf51801d80fc389d43dc46524520e89043b6faf";function W(t){return parseInt(t,10)}function q(t){return Math.abs(parseInt(t,10))}function X(t,e){for(var n=new Array(t),i=0;i<t;++i)n[i]=e(i);return n}function Y(t){for(var e=new Array(t),n=0;n<t;++n)e[n]=null;return e}function J(t,e){void 0===e&&(e=0);for(var n=new Array(t),i=0;i<t;++i)n[i]=e;return n}var Z=a/180,$=180/a,tt=2*a,nt=Math.abs;function it(t,e){return t<e?t:e}function rt(t,e){return t>e?t:e}function at(t,e,n){return t<e?e:t>n?n:t}function st(t,e){var n=t[0];t[0]=e[0],e[0]=n}var ct=isFinite;function lt(t){return t*t}function ut(t){return 1/Math.sqrt(t)}var ht=Math.sqrt,_t=Math.pow;function ft(t){return t*Z}function pt(t){return t*$}var dt=Math.cos,mt=Math.sin,vt=Math.acos,gt=Math.asin,yt=Math.atan2;function xt(t){return t|=t>>1&2147483647,t|=t>>2&1073741823,t|=t>>4&268435455,1+((t|=t>>8&16777215)|t>>16&65535)}function St(t){return t>0&&0==(t&t-1)}function Ct(){return 2*Math.random()-1}function At(t,e){return(e-t)*Math.random()+t}var bt=function(){function t(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(e[0]instanceof Float32Array){if(2!==e[0].length)throw new Error;this.data=e[0]}else{var i="number"==typeof e[0]?e[0]:0,r="number"==typeof e[1]?e[1]:0;this.data=new Float32Array([i,r])}}var e=t.prototype;return e.Clone=function(){return new t(this.x,this.y)},e.SetZero=function(){return this.x=0,this.y=0,this},e.Set=function(t,e){return this.x=t,this.y=e,this},e.Copy=function(t){return this.x=t.x,this.y=t.y,this},e.SelfAdd=function(t){return this.x+=t.x,this.y+=t.y,this},e.SelfAddXY=function(t,e){return this.x+=t,this.y+=e,this},e.SelfSub=function(t){return this.x-=t.x,this.y-=t.y,this},e.SelfSubXY=function(t,e){return this.x-=t,this.y-=e,this},e.SelfMul=function(t){return this.x*=t,this.y*=t,this},e.SelfMulAdd=function(t,e){return this.x+=t*e.x,this.y+=t*e.y,this},e.SelfMulSub=function(t,e){return this.x-=t*e.x,this.y-=t*e.y,this},e.Dot=function(t){return this.x*t.x+this.y*t.y},e.Cross=function(t){return this.x*t.y-this.y*t.x},e.Length=function(){var t=this.x,e=this.y;return Math.sqrt(t*t+e*e)},e.LengthSquared=function(){var t=this.x,e=this.y;return t*t+e*e},e.Normalize=function(){var t=this.Length();if(t>=r){var e=1/t;this.x*=e,this.y*=e}return t},e.SelfNormalize=function(){var t=this.Length();if(t>=r){var e=1/t;this.x*=e,this.y*=e}return this},e.SelfRotate=function(t){var e=Math.cos(t),n=Math.sin(t),i=this.x;return this.x=e*i-n*this.y,this.y=n*i+e*this.y,this},e.SelfRotateCosSin=function(t,e){var n=this.x;return this.x=t*n-e*this.y,this.y=e*n+t*this.y,this},e.IsValid=function(){return isFinite(this.x)&&isFinite(this.y)},e.SelfCrossVS=function(t){var e=this.x;return this.x=t*this.y,this.y=-t*e,this},e.SelfCrossSV=function(t){var e=this.x;return this.x=-t*this.y,this.y=t*e,this},e.SelfMinV=function(t){return this.x=it(this.x,t.x),this.y=it(this.y,t.y),this},e.SelfMaxV=function(t){return this.x=rt(this.x,t.x),this.y=rt(this.y,t.y),this},e.SelfAbs=function(){return this.x=nt(this.x),this.y=nt(this.y),this},e.SelfNeg=function(){return this.x=-this.x,this.y=-this.y,this},e.SelfSkew=function(){var t=this.x;return this.x=-this.y,this.y=t,this},t.MakeArray=function(e){return X(e,(function(){return new t}))},t.AbsV=function(t,e){return e.x=nt(t.x),e.y=nt(t.y),e},t.MinV=function(t,e,n){return n.x=it(t.x,e.x),n.y=it(t.y,e.y),n},t.MaxV=function(t,e,n){return n.x=rt(t.x,e.x),n.y=rt(t.y,e.y),n},t.ClampV=function(t,e,n,i){return i.x=at(t.x,e.x,n.x),i.y=at(t.y,e.y,n.y),i},t.RotateV=function(t,e,n){var i=t.x,r=t.y,o=Math.cos(e),a=Math.sin(e);return n.x=o*i-a*r,n.y=a*i+o*r,n},t.DotVV=function(t,e){return t.x*e.x+t.y*e.y},t.CrossVV=function(t,e){return t.x*e.y-t.y*e.x},t.CrossVS=function(t,e,n){var i=t.x;return n.x=e*t.y,n.y=-e*i,n},t.CrossVOne=function(t,e){var n=t.x;return e.x=t.y,e.y=-n,e},t.CrossSV=function(t,e,n){var i=e.x;return n.x=-t*e.y,n.y=t*i,n},t.CrossOneV=function(t,e){var n=t.x;return e.x=-t.y,e.y=n,e},t.AddVV=function(t,e,n){return n.x=t.x+e.x,n.y=t.y+e.y,n},t.SubVV=function(t,e,n){return n.x=t.x-e.x,n.y=t.y-e.y,n},t.MulSV=function(t,e,n){return n.x=e.x*t,n.y=e.y*t,n},t.MulVS=function(t,e,n){return n.x=t.x*e,n.y=t.y*e,n},t.AddVMulSV=function(t,e,n,i){return i.x=t.x+e*n.x,i.y=t.y+e*n.y,i},t.SubVMulSV=function(t,e,n,i){return i.x=t.x-e*n.x,i.y=t.y-e*n.y,i},t.AddVCrossSV=function(t,e,n,i){var r=n.x;return i.x=t.x-e*n.y,i.y=t.y+e*r,i},t.MidVV=function(t,e,n){return n.x=.5*(t.x+e.x),n.y=.5*(t.y+e.y),n},t.ExtVV=function(t,e,n){return n.x=.5*(e.x-t.x),n.y=.5*(e.y-t.y),n},t.IsEqualToV=function(t,e){return t.x===e.x&&t.y===e.y},t.DistanceVV=function(t,e){var n=t.x-e.x,i=t.y-e.y;return Math.sqrt(n*n+i*i)},t.DistanceSquaredVV=function(t,e){var n=t.x-e.x,i=t.y-e.y;return n*n+i*i},t.NegV=function(t,e){return e.x=-t.x,e.y=-t.y,e},K(t,[{key:"x",get:function(){return this.data[0]},set:function(t){this.data[0]=t}},{key:"y",get:function(){return this.data[1]},set:function(t){this.data[1]=t}}]),t}();bt.ZERO=new bt(0,0),bt.UNITX=new bt(1,0),bt.UNITY=new bt(0,1),bt.s_t0=new bt,bt.s_t1=new bt,bt.s_t2=new bt,bt.s_t3=new bt;var Tt=new bt(0,0),Et=function(){function t(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(e[0]instanceof Float32Array){if(3!==e[0].length)throw new Error;this.data=e[0]}else{var i="number"==typeof e[0]?e[0]:0,r="number"==typeof e[1]?e[1]:0,o="number"==typeof e[2]?e[2]:0;this.data=new Float32Array([i,r,o])}}var e=t.prototype;return e.Clone=function(){return new t(this.x,this.y,this.z)},e.SetZero=function(){return this.x=0,this.y=0,this.z=0,this},e.SetXYZ=function(t,e,n){return this.x=t,this.y=e,this.z=n,this},e.Copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},e.SelfNeg=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},e.SelfAdd=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},e.SelfAddXYZ=function(t,e,n){return this.x+=t,this.y+=e,this.z+=n,this},e.SelfSub=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},e.SelfSubXYZ=function(t,e,n){return this.x-=t,this.y-=e,this.z-=n,this},e.SelfMul=function(t){return this.x*=t,this.y*=t,this.z*=t,this},t.DotV3V3=function(t,e){return t.x*e.x+t.y*e.y+t.z*e.z},t.CrossV3V3=function(t,e,n){var i=t.x,r=t.y,o=t.z,a=e.x,s=e.y,c=e.z;return n.x=r*c-o*s,n.y=o*a-i*c,n.z=i*s-r*a,n},K(t,[{key:"x",get:function(){return this.data[0]},set:function(t){this.data[0]=t}},{key:"y",get:function(){return this.data[1]},set:function(t){this.data[1]=t}},{key:"z",get:function(){return this.data[2]},set:function(t){this.data[2]=t}}]),t}();Et.ZERO=new Et(0,0,0),Et.s_t0=new Et;var wt=function(){function t(){this.data=new Float32Array([1,0,0,1]),this.ex=new bt(this.data.subarray(0,2)),this.ey=new bt(this.data.subarray(2,4))}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},t.FromVV=function(e,n){return(new t).SetVV(e,n)},t.FromSSSS=function(e,n,i,r){return(new t).SetSSSS(e,n,i,r)},t.FromAngle=function(e){return(new t).SetAngle(e)},e.SetSSSS=function(t,e,n,i){return this.ex.Set(t,n),this.ey.Set(e,i),this},e.SetVV=function(t,e){return this.ex.Copy(t),this.ey.Copy(e),this},e.SetAngle=function(t){var e=Math.cos(t),n=Math.sin(t);return this.ex.Set(e,n),this.ey.Set(-n,e),this},e.Copy=function(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this},e.SetIdentity=function(){return this.ex.Set(1,0),this.ey.Set(0,1),this},e.SetZero=function(){return this.ex.SetZero(),this.ey.SetZero(),this},e.GetAngle=function(){return Math.atan2(this.ex.y,this.ex.x)},e.GetInverse=function(t){var e=this.ex.x,n=this.ey.x,i=this.ex.y,r=this.ey.y,o=e*r-n*i;return 0!==o&&(o=1/o),t.ex.x=o*r,t.ey.x=-o*n,t.ex.y=-o*i,t.ey.y=o*e,t},e.Solve=function(t,e,n){var i=this.ex.x,r=this.ey.x,o=this.ex.y,a=this.ey.y,s=i*a-r*o;return 0!==s&&(s=1/s),n.x=s*(a*t-r*e),n.y=s*(i*e-o*t),n},e.SelfAbs=function(){return this.ex.SelfAbs(),this.ey.SelfAbs(),this},e.SelfInv=function(){return this.GetInverse(this),this},e.SelfAddM=function(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this},e.SelfSubM=function(t){return this.ex.SelfSub(t.ex),this.ey.SelfSub(t.ey),this},t.AbsM=function(t,e){var n=t.ex,i=t.ey;return e.ex.x=nt(n.x),e.ex.y=nt(n.y),e.ey.x=nt(i.x),e.ey.y=nt(i.y),e},t.MulMV=function(t,e,n){var i=t.ex,r=t.ey,o=e.x,a=e.y;return n.x=i.x*o+r.x*a,n.y=i.y*o+r.y*a,n},t.MulTMV=function(t,e,n){var i=t.ex,r=t.ey,o=e.x,a=e.y;return n.x=i.x*o+i.y*a,n.y=r.x*o+r.y*a,n},t.AddMM=function(t,e,n){var i=t.ex,r=t.ey,o=e.ex,a=e.ey;return n.ex.x=i.x+o.x,n.ex.y=i.y+o.y,n.ey.x=r.x+a.x,n.ey.y=r.y+a.y,n},t.MulMM=function(t,e,n){var i=t.ex.x,r=t.ex.y,o=t.ey.x,a=t.ey.y,s=e.ex.x,c=e.ex.y,l=e.ey.x,u=e.ey.y;return n.ex.x=i*s+o*c,n.ex.y=r*s+a*c,n.ey.x=i*l+o*u,n.ey.y=r*l+a*u,n},t.MulTMM=function(t,e,n){var i=t.ex.x,r=t.ex.y,o=t.ey.x,a=t.ey.y,s=e.ex.x,c=e.ex.y,l=e.ey.x,u=e.ey.y;return n.ex.x=i*s+r*c,n.ex.y=o*s+a*c,n.ey.x=i*l+r*u,n.ey.y=o*l+a*u,n},t}();wt.IDENTITY=new wt;var Pt=function(){function t(){this.data=new Float32Array([1,0,0,0,1,0,0,0,1]),this.ex=new Et(this.data.subarray(0,3)),this.ey=new Et(this.data.subarray(3,6)),this.ez=new Et(this.data.subarray(6,9))}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.SetVVV=function(t,e,n){return this.ex.Copy(t),this.ey.Copy(e),this.ez.Copy(n),this},e.Copy=function(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this.ez.Copy(t.ez),this},e.SetIdentity=function(){return this.ex.SetXYZ(1,0,0),this.ey.SetXYZ(0,1,0),this.ez.SetXYZ(0,0,1),this},e.SetZero=function(){return this.ex.SetZero(),this.ey.SetZero(),this.ez.SetZero(),this},e.SelfAddM=function(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this.ez.SelfAdd(t.ez),this},e.Solve33=function(t,e,n,i){var r=this.ex.x,o=this.ex.y,a=this.ex.z,s=this.ey.x,c=this.ey.y,l=this.ey.z,u=this.ez.x,h=this.ez.y,_=this.ez.z,f=r*(c*_-l*h)+o*(l*u-s*_)+a*(s*h-c*u);return 0!==f&&(f=1/f),i.x=f*(t*(c*_-l*h)+e*(l*u-s*_)+n*(s*h-c*u)),i.y=f*(r*(e*_-n*h)+o*(n*u-t*_)+a*(t*h-e*u)),i.z=f*(r*(c*n-l*e)+o*(l*t-s*n)+a*(s*e-c*t)),i},e.Solve22=function(t,e,n){var i=this.ex.x,r=this.ey.x,o=this.ex.y,a=this.ey.y,s=i*a-r*o;return 0!==s&&(s=1/s),n.x=s*(a*t-r*e),n.y=s*(i*e-o*t),n},e.GetInverse22=function(t){var e=this.ex.x,n=this.ey.x,i=this.ex.y,r=this.ey.y,o=e*r-n*i;0!==o&&(o=1/o),t.ex.x=o*r,t.ey.x=-o*n,t.ex.z=0,t.ex.y=-o*i,t.ey.y=o*e,t.ey.z=0,t.ez.x=0,t.ez.y=0,t.ez.z=0},e.GetSymInverse33=function(t){var e=Et.DotV3V3(this.ex,Et.CrossV3V3(this.ey,this.ez,Et.s_t0));0!==e&&(e=1/e);var n=this.ex.x,i=this.ey.x,r=this.ez.x,o=this.ey.y,a=this.ez.y,s=this.ez.z;t.ex.x=e*(o*s-a*a),t.ex.y=e*(r*a-i*s),t.ex.z=e*(i*a-r*o),t.ey.x=t.ex.y,t.ey.y=e*(n*s-r*r),t.ey.z=e*(r*i-n*a),t.ez.x=t.ex.z,t.ez.y=t.ey.z,t.ez.z=e*(n*o-i*i)},t.MulM33V3=function(t,e,n){var i=e.x,r=e.y,o=e.z;return n.x=t.ex.x*i+t.ey.x*r+t.ez.x*o,n.y=t.ex.y*i+t.ey.y*r+t.ez.y*o,n.z=t.ex.z*i+t.ey.z*r+t.ez.z*o,n},t.MulM33XYZ=function(t,e,n,i,r){return r.x=t.ex.x*e+t.ey.x*n+t.ez.x*i,r.y=t.ex.y*e+t.ey.y*n+t.ez.y*i,r.z=t.ex.z*e+t.ey.z*n+t.ez.z*i,r},t.MulM33V2=function(t,e,n){var i=e.x,r=e.y;return n.x=t.ex.x*i+t.ey.x*r,n.y=t.ex.y*i+t.ey.y*r,n},t.MulM33XY=function(t,e,n,i){return i.x=t.ex.x*e+t.ey.x*n,i.y=t.ex.y*e+t.ey.y*n,i},t}();Pt.IDENTITY=new Pt;var It=function(){function t(t){void 0===t&&(t=0),this.s=0,this.c=1,t&&(this.s=Math.sin(t),this.c=Math.cos(t))}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.Copy=function(t){return this.s=t.s,this.c=t.c,this},e.SetAngle=function(t){return this.s=Math.sin(t),this.c=Math.cos(t),this},e.SetIdentity=function(){return this.s=0,this.c=1,this},e.GetAngle=function(){return Math.atan2(this.s,this.c)},e.GetXAxis=function(t){return t.x=this.c,t.y=this.s,t},e.GetYAxis=function(t){return t.x=-this.s,t.y=this.c,t},t.MulRR=function(t,e,n){var i=t.c,r=t.s,o=e.c,a=e.s;return n.s=r*o+i*a,n.c=i*o-r*a,n},t.MulTRR=function(t,e,n){var i=t.c,r=t.s,o=e.c,a=e.s;return n.s=i*a-r*o,n.c=i*o+r*a,n},t.MulRV=function(t,e,n){var i=t.c,r=t.s,o=e.x,a=e.y;return n.x=i*o-r*a,n.y=r*o+i*a,n},t.MulTRV=function(t,e,n){var i=t.c,r=t.s,o=e.x,a=e.y;return n.x=i*o+r*a,n.y=-r*o+i*a,n},t}();It.IDENTITY=new It;var Rt=function(){function t(){this.p=new bt,this.q=new It}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.Copy=function(t){return this.p.Copy(t.p),this.q.Copy(t.q),this},e.SetIdentity=function(){return this.p.SetZero(),this.q.SetIdentity(),this},e.SetPositionRotation=function(t,e){return this.p.Copy(t),this.q.Copy(e),this},e.SetPositionAngle=function(t,e){return this.p.Copy(t),this.q.SetAngle(e),this},e.SetPosition=function(t){return this.p.Copy(t),this},e.SetPositionXY=function(t,e){return this.p.Set(t,e),this},e.SetRotation=function(t){return this.q.Copy(t),this},e.SetRotationAngle=function(t){return this.q.SetAngle(t),this},e.GetPosition=function(){return this.p},e.GetRotation=function(){return this.q},e.GetRotationAngle=function(){return this.q.GetAngle()},e.GetAngle=function(){return this.q.GetAngle()},t.MulXV=function(t,e,n){var i=t.q.c,r=t.q.s,o=e.x,a=e.y;return n.x=i*o-r*a+t.p.x,n.y=r*o+i*a+t.p.y,n},t.MulTXV=function(t,e,n){var i=t.q.c,r=t.q.s,o=e.x-t.p.x,a=e.y-t.p.y;return n.x=i*o+r*a,n.y=-r*o+i*a,n},t.MulXX=function(t,e,n){return It.MulRR(t.q,e.q,n.q),bt.AddVV(It.MulRV(t.q,e.p,n.p),t.p,n.p),n},t.MulTXX=function(t,e,n){return It.MulTRR(t.q,e.q,n.q),It.MulTRV(t.q,bt.SubVV(e.p,t.p,n.p),n.p),n},t}();Rt.IDENTITY=new Rt;var Dt,Bt=function(){function t(){this.localCenter=new bt,this.c0=new bt,this.c=new bt,this.a0=0,this.a=0,this.alpha0=0}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.Copy=function(t){return this.localCenter.Copy(t.localCenter),this.c0.Copy(t.c0),this.c.Copy(t.c),this.a0=t.a0,this.a=t.a,this.alpha0=t.alpha0,this},e.GetTransform=function(t,e){var n=1-e;t.p.x=n*this.c0.x+e*this.c.x,t.p.y=n*this.c0.y+e*this.c.y;var i=n*this.a0+e*this.a;return t.q.SetAngle(i),t.p.SelfSub(It.MulRV(t.q,this.localCenter,bt.s_t0)),t},e.Advance=function(t){var e=(t-this.alpha0)/(1-this.alpha0),n=1-e;this.c0.x=n*this.c0.x+e*this.c.x,this.c0.y=n*this.c0.y+e*this.c.y,this.a0=n*this.a0+e*this.a,this.alpha0=t},e.Normalize=function(){var t=tt*Math.floor(this.a0/tt);this.a0-=t,this.a-=t},t}(),Mt=function(){function t(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if(e[0]instanceof Float32Array){if(4!==e[0].length)throw new Error;this.data=e[0]}else{var i="number"==typeof e[0]?e[0]:.5,r="number"==typeof e[1]?e[1]:.5,o="number"==typeof e[2]?e[2]:.5,a="number"==typeof e[3]?e[3]:1;this.data=new Float32Array([i,r,o,a])}}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.Copy=function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this},e.IsEqual=function(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a},e.IsZero=function(){return 0===this.r&&0===this.g&&0===this.b&&0===this.a},e.Set=function(t,e,n,i){void 0===i&&(i=this.a),this.SetRGBA(t,e,n,i)},e.SetByteRGB=function(t,e,n){return this.r=t/255,this.g=e/255,this.b=n/255,this},e.SetByteRGBA=function(t,e,n,i){return this.r=t/255,this.g=e/255,this.b=n/255,this.a=i/255,this},e.SetRGB=function(t,e,n){return this.r=t,this.g=e,this.b=n,this},e.SetRGBA=function(t,e,n,i){return this.r=t,this.g=e,this.b=n,this.a=i,this},e.SelfAdd=function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this},e.Add=function(t,e){return e.r=this.r+t.r,e.g=this.g+t.g,e.b=this.b+t.b,e.a=this.a+t.a,e},e.SelfSub=function(t){return this.r-=t.r,this.g-=t.g,this.b-=t.b,this.a-=t.a,this},e.Sub=function(t,e){return e.r=this.r-t.r,e.g=this.g-t.g,e.b=this.b-t.b,e.a=this.a-t.a,e},e.SelfMul=function(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this},e.Mul=function(t,e){return e.r=this.r*t,e.g=this.g*t,e.b=this.b*t,e.a=this.a*t,e},e.Mix=function(e,n){t.MixColors(this,e,n)},t.MixColors=function(t,e,n){var i=n*(e.r-t.r),r=n*(e.g-t.g),o=n*(e.b-t.b),a=n*(e.a-t.a);t.r+=i,t.g+=r,t.b+=o,t.a+=a,e.r-=i,e.g-=r,e.b-=o,e.a-=a},e.MakeStyleString=function(e){return void 0===e&&(e=this.a),t.MakeStyleString(this.r,this.g,this.b,e)},t.MakeStyleString=function(t,e,n,i){return void 0===i&&(i=1),t*=255,e*=255,n*=255,i<1?"rgba("+t+","+e+","+n+","+i+")":"rgb("+t+","+e+","+n+")"},K(t,[{key:"r",get:function(){return this.data[0]},set:function(t){this.data[0]=t}},{key:"g",get:function(){return this.data[1]},set:function(t){this.data[1]=t}},{key:"b",get:function(){return this.data[2]},set:function(t){this.data[2]=t}},{key:"a",get:function(){return this.data[3]},set:function(t){this.data[3]=t}}]),t}();Mt.ZERO=new Mt(0,0,0,0),Mt.RED=new Mt(1,0,0),Mt.GREEN=new Mt(0,1,0),Mt.BLUE=new Mt(0,0,1),(Dt=t.b2DrawFlags||(t.b2DrawFlags={}))[Dt.e_none=0]="e_none",Dt[Dt.e_shapeBit=1]="e_shapeBit",Dt[Dt.e_jointBit=2]="e_jointBit",Dt[Dt.e_aabbBit=4]="e_aabbBit",Dt[Dt.e_pairBit=8]="e_pairBit",Dt[Dt.e_centerOfMassBit=16]="e_centerOfMassBit",Dt[Dt.e_particleBit=32]="e_particleBit",Dt[Dt.e_controllerBit=64]="e_controllerBit",Dt[Dt.e_all=63]="e_all";var Ot=function(){function t(){this.m_drawFlags=0}var e=t.prototype;return e.SetFlags=function(t){this.m_drawFlags=t},e.GetFlags=function(){return this.m_drawFlags},e.AppendFlags=function(t){this.m_drawFlags|=t},e.ClearFlags=function(t){this.m_drawFlags&=~t},t}(),Nt=function(){function t(){this.m_start=Date.now()}var e=t.prototype;return e.Reset=function(){return this.m_start=Date.now(),this},e.GetMilliseconds=function(){return Date.now()-this.m_start},t}(),Lt=function(){function t(){this.m_count=0,this.m_min_count=0,this.m_max_count=0}var e=t.prototype;return e.GetCount=function(){return this.m_count},e.GetMinCount=function(){return this.m_min_count},e.GetMaxCount=function(){return this.m_max_count},e.ResetCount=function(){var t=this.m_count;return this.m_count=0,t},e.ResetMinCount=function(){this.m_min_count=0},e.ResetMaxCount=function(){this.m_max_count=0},e.Increment=function(){this.m_count++,this.m_max_count<this.m_count&&(this.m_max_count=this.m_count)},e.Decrement=function(){this.m_count--,this.m_min_count>this.m_count&&(this.m_min_count=this.m_count)},t}(),Ft=function(){function t(t){this.m_stack=[],this.m_count=0,this.m_stack=X(t,(function(){return null})),this.m_count=0}var e=t.prototype;return e.Reset=function(){return this.m_count=0,this},e.Push=function(t){this.m_stack[this.m_count]=t,this.m_count++},e.Pop=function(){this.m_count--;var t=this.m_stack[this.m_count];if(this.m_stack[this.m_count]=null,null===t)throw new Error;return t},e.GetCount=function(){return this.m_count},t}(),zt=function(){},Gt=function(){},Vt=function(){function t(){this.m_buffer=bt.MakeArray(2),this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0}var e=t.prototype;return e.Copy=function(t){return t.m_vertices===t.m_buffer?(this.m_vertices=this.m_buffer,this.m_buffer[0].Copy(t.m_buffer[0]),this.m_buffer[1].Copy(t.m_buffer[1])):this.m_vertices=t.m_vertices,this.m_count=t.m_count,this.m_radius=t.m_radius,this},e.Reset=function(){return this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0,this},e.SetShape=function(t,e){t.SetupDistanceProxy(this,e)},e.SetVerticesRadius=function(t,e,n){this.m_vertices=t,this.m_count=e,this.m_radius=n},e.GetSupport=function(t){for(var e=0,n=bt.DotVV(this.m_vertices[0],t),i=1;i<this.m_count;++i){var r=bt.DotVV(this.m_vertices[i],t);r>n&&(e=i,n=r)}return e},e.GetSupportVertex=function(t){for(var e=0,n=bt.DotVV(this.m_vertices[0],t),i=1;i<this.m_count;++i){var r=bt.DotVV(this.m_vertices[i],t);r>n&&(e=i,n=r)}return this.m_vertices[e]},e.GetVertexCount=function(){return this.m_count},e.GetVertex=function(t){return this.m_vertices[t]},t}(),Ut=function(){function t(){this.metric=0,this.count=0,this.indexA=[0,0,0],this.indexB=[0,0,0]}return t.prototype.Reset=function(){return this.metric=0,this.count=0,this},t}(),kt=function(){function t(){this.proxyA=new Vt,this.proxyB=new Vt,this.transformA=new Rt,this.transformB=new Rt,this.useRadii=!1}return t.prototype.Reset=function(){return this.proxyA.Reset(),this.proxyB.Reset(),this.transformA.SetIdentity(),this.transformB.SetIdentity(),this.useRadii=!1,this},t}(),Ht=function(){function t(){this.pointA=new bt,this.pointB=new bt,this.distance=0,this.iterations=0}return t.prototype.Reset=function(){return this.pointA.SetZero(),this.pointB.SetZero(),this.distance=0,this.iterations=0,this},t}(),jt=function(){this.proxyA=new Vt,this.proxyB=new Vt,this.transformA=new Rt,this.transformB=new Rt,this.translationB=new bt},Wt=function(){this.point=new bt,this.normal=new bt,this.lambda=0,this.iterations=0};function qt(){t.b2_gjkCalls=0,t.b2_gjkIters=0,t.b2_gjkMaxIters=0}t.b2_gjkCalls=0,t.b2_gjkIters=0,t.b2_gjkMaxIters=0;var Xt=function(){function t(){this.wA=new bt,this.wB=new bt,this.w=new bt,this.a=0,this.indexA=0,this.indexB=0}return t.prototype.Copy=function(t){return this.wA.Copy(t.wA),this.wB.Copy(t.wB),this.w.Copy(t.w),this.a=t.a,this.indexA=t.indexA,this.indexB=t.indexB,this},t}(),Yt=function(){function t(){this.m_v1=new Xt,this.m_v2=new Xt,this.m_v3=new Xt,this.m_vertices=[],this.m_count=0,this.m_vertices[0]=this.m_v1,this.m_vertices[1]=this.m_v2,this.m_vertices[2]=this.m_v3}var e=t.prototype;return e.ReadCache=function(t,e,n,i,o){this.m_count=t.count;for(var a=this.m_vertices,s=0;s<this.m_count;++s){var c=a[s];c.indexA=t.indexA[s],c.indexB=t.indexB[s];var l=e.GetVertex(c.indexA),u=i.GetVertex(c.indexB);Rt.MulXV(n,l,c.wA),Rt.MulXV(o,u,c.wB),bt.SubVV(c.wB,c.wA,c.w),c.a=0}if(this.m_count>1){var h=t.metric,_=this.GetMetric();(_<.5*h||2*h<_||_<r)&&(this.m_count=0)}if(0===this.m_count){var f=a[0];f.indexA=0,f.indexB=0;var p=e.GetVertex(0),d=i.GetVertex(0);Rt.MulXV(n,p,f.wA),Rt.MulXV(o,d,f.wB),bt.SubVV(f.wB,f.wA,f.w),f.a=1,this.m_count=1}},e.WriteCache=function(t){t.metric=this.GetMetric(),t.count=this.m_count;for(var e=this.m_vertices,n=0;n<this.m_count;++n)t.indexA[n]=e[n].indexA,t.indexB[n]=e[n].indexB},e.GetSearchDirection=function(t){switch(this.m_count){case 1:return bt.NegV(this.m_v1.w,t);case 2:var e=bt.SubVV(this.m_v2.w,this.m_v1.w,t);return bt.CrossVV(e,bt.NegV(this.m_v1.w,bt.s_t0))>0?bt.CrossOneV(e,t):bt.CrossVOne(e,t);default:return t.SetZero()}},e.GetClosestPoint=function(t){switch(this.m_count){case 0:return t.SetZero();case 1:return t.Copy(this.m_v1.w);case 2:return t.Set(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y);case 3:default:return t.SetZero()}},e.GetWitnessPoints=function(t,e){switch(this.m_count){case 0:break;case 1:t.Copy(this.m_v1.wA),e.Copy(this.m_v1.wB);break;case 2:t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x,t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y,e.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x,e.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:e.x=t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x,e.y=t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y}},e.GetMetric=function(){switch(this.m_count){case 0:case 1:return 0;case 2:return bt.DistanceVV(this.m_v1.w,this.m_v2.w);case 3:return bt.CrossVV(bt.SubVV(this.m_v2.w,this.m_v1.w,bt.s_t0),bt.SubVV(this.m_v3.w,this.m_v1.w,bt.s_t1));default:return 0}},e.Solve2=function(){var e=this.m_v1.w,n=this.m_v2.w,i=bt.SubVV(n,e,t.s_e12),r=-bt.DotVV(e,i);if(r<=0)return this.m_v1.a=1,void(this.m_count=1);var o=bt.DotVV(n,i);if(o<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);var a=1/(o+r);this.m_v1.a=o*a,this.m_v2.a=r*a,this.m_count=2},e.Solve3=function(){var e=this.m_v1.w,n=this.m_v2.w,i=this.m_v3.w,r=bt.SubVV(n,e,t.s_e12),o=bt.DotVV(e,r),a=bt.DotVV(n,r),s=-o,c=bt.SubVV(i,e,t.s_e13),l=bt.DotVV(e,c),u=bt.DotVV(i,c),h=-l,_=bt.SubVV(i,n,t.s_e23),f=bt.DotVV(n,_),p=bt.DotVV(i,_),d=-f,m=bt.CrossVV(r,c),v=m*bt.CrossVV(n,i),g=m*bt.CrossVV(i,e),y=m*bt.CrossVV(e,n);if(s<=0&&h<=0)return this.m_v1.a=1,void(this.m_count=1);if(a>0&&s>0&&y<=0){var x=1/(a+s);return this.m_v1.a=a*x,this.m_v2.a=s*x,void(this.m_count=2)}if(u>0&&h>0&&g<=0){var S=1/(u+h);return this.m_v1.a=u*S,this.m_v3.a=h*S,this.m_count=2,void this.m_v2.Copy(this.m_v3)}if(a<=0&&d<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);if(u<=0&&p<=0)return this.m_v3.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v3);if(p>0&&d>0&&v<=0){var C=1/(p+d);return this.m_v2.a=p*C,this.m_v3.a=d*C,this.m_count=2,void this.m_v1.Copy(this.m_v3)}var A=1/(v+g+y);this.m_v1.a=v*A,this.m_v2.a=g*A,this.m_v3.a=y*A,this.m_count=3},t}();Yt.s_e12=new bt,Yt.s_e13=new bt,Yt.s_e23=new bt;var Kt=new Yt,Jt=[0,0,0],Qt=[0,0,0],Zt=new bt,$t=new bt,te=new bt,ee=new bt,ne=new bt;function ie(e,n,i){++t.b2_gjkCalls;var a=i.proxyA,s=i.proxyB,c=i.transformA,l=i.transformB,u=Kt;u.ReadCache(n,a,c,s,l);for(var h=u.m_vertices,_=20,f=Jt,p=Qt,d=0,m=0;m<_;){d=u.m_count;for(var v=0;v<d;++v)f[v]=h[v].indexA,p[v]=h[v].indexB;switch(u.m_count){case 1:break;case 2:u.Solve2();break;case 3:u.Solve3()}if(3===u.m_count)break;var g=u.GetSearchDirection($t);if(g.LengthSquared()<o)break;var y=h[u.m_count];y.indexA=a.GetSupport(It.MulTRV(c.q,bt.NegV(g,bt.s_t0),ee)),Rt.MulXV(c,a.GetVertex(y.indexA),y.wA),y.indexB=s.GetSupport(It.MulTRV(l.q,g,ne)),Rt.MulXV(l,s.GetVertex(y.indexB),y.wB),bt.SubVV(y.wB,y.wA,y.w),++m,++t.b2_gjkIters;for(var x=!1,S=0;S<d;++S)if(y.indexA===f[S]&&y.indexB===p[S]){x=!0;break}if(x)break;++u.m_count}if(t.b2_gjkMaxIters=rt(t.b2_gjkMaxIters,m),u.GetWitnessPoints(e.pointA,e.pointB),e.distance=bt.DistanceVV(e.pointA,e.pointB),e.iterations=m,u.WriteCache(n),i.useRadii){var C=a.m_radius,A=s.m_radius;if(e.distance>C+A&&e.distance>r){e.distance-=C+A;var b=bt.SubVV(e.pointB,e.pointA,te);b.Normalize(),e.pointA.SelfMulAdd(C,b),e.pointB.SelfMulSub(A,b)}else{var T=bt.MidVV(e.pointA,e.pointB,Zt);e.pointA.Copy(T),e.pointB.Copy(T),e.distance=0}}}var re,oe=new bt,ae=new Yt,se=new bt,ce=new bt,le=new bt,ue=new bt,he=new bt,_e=new bt;function fe(t,e){t.iterations=0,t.lambda=1,t.normal.SetZero(),t.point.SetZero();var n=e.proxyA,i=e.proxyB,r=rt(n.m_radius,f)+rt(i.m_radius,f),o=e.transformA,a=e.transformB,s=e.translationB,c=oe.Set(0,0),l=0,u=ae;u.m_count=0;for(var _=u.m_vertices,p=n.GetSupport(It.MulTRV(o.q,bt.NegV(s,bt.s_t1),bt.s_t0)),d=Rt.MulXV(o,n.GetVertex(p),se),m=i.GetSupport(It.MulTRV(a.q,s,bt.s_t0)),v=Rt.MulXV(a,i.GetVertex(m),ce),g=bt.SubVV(d,v,le),y=rt(f,r-f),x=.5*h,S=20,C=0;C<S&&nt(g.Length()-y)>x;){t.iterations+=1,p=n.GetSupport(It.MulTRV(o.q,bt.NegV(g,bt.s_t1),bt.s_t0)),d=Rt.MulXV(o,n.GetVertex(p),se),m=i.GetSupport(It.MulTRV(a.q,g,bt.s_t0)),v=Rt.MulXV(a,i.GetVertex(m),ce);var A=bt.SubVV(d,v,ue);g.Normalize();var b=bt.DotVV(g,A),T=bt.DotVV(g,s);if(b-y>l*T){if(T<=0)return!1;if((l=(b-y)/T)>1)return!1;c.Copy(g).SelfNeg(),u.m_count=0}var E=_[u.m_count];switch(E.indexA=m,E.wA.Copy(v).SelfMulAdd(l,s),E.indexB=p,E.wB.Copy(d),E.w.Copy(E.wB).SelfSub(E.wA),E.a=1,u.m_count+=1,u.m_count){case 1:break;case 2:u.Solve2();break;case 3:u.Solve3()}if(3===u.m_count)return!1;u.GetClosestPoint(g),++C}var w=he,P=_e;return u.GetWitnessPoints(w,P),g.LengthSquared()>0&&(c.Copy(g).SelfNeg(),c.Normalize()),t.normal.Copy(c),t.lambda=l,t.iterations=C,!0}(re=t.b2ContactFeatureType||(t.b2ContactFeatureType={}))[re.e_vertex=0]="e_vertex",re[re.e_face=1]="e_face";var pe,de=function(){function t(){this._key=0,this._key_invalid=!1,this._indexA=0,this._indexB=0,this._typeA=0,this._typeB=0}return K(t,[{key:"key",get:function(){return this._key_invalid&&(this._key_invalid=!1,this._key=this._indexA|this._indexB<<8|this._typeA<<16|this._typeB<<24),this._key},set:function(t){this._key=t,this._key_invalid=!1,this._indexA=255&this._key,this._indexB=this._key>>8&255,this._typeA=this._key>>16&255,this._typeB=this._key>>24&255}},{key:"indexA",get:function(){return this._indexA},set:function(t){this._indexA=t,this._key_invalid=!0}},{key:"indexB",get:function(){return this._indexB},set:function(t){this._indexB=t,this._key_invalid=!0}},{key:"typeA",get:function(){return this._typeA},set:function(t){this._typeA=t,this._key_invalid=!0}},{key:"typeB",get:function(){return this._typeB},set:function(t){this._typeB=t,this._key_invalid=!0}}]),t}(),me=function(){function t(){this.cf=new de}var e=t.prototype;return e.Copy=function(t){return this.key=t.key,this},e.Clone=function(){return(new t).Copy(this)},K(t,[{key:"key",get:function(){return this.cf.key},set:function(t){this.cf.key=t}}]),t}(),ve=function(){function t(){this.localPoint=new bt,this.normalImpulse=0,this.tangentImpulse=0,this.id=new me}t.MakeArray=function(e){return X(e,(function(){return new t}))};var e=t.prototype;return e.Reset=function(){this.localPoint.SetZero(),this.normalImpulse=0,this.tangentImpulse=0,this.id.key=0},e.Copy=function(t){return this.localPoint.Copy(t.localPoint),this.normalImpulse=t.normalImpulse,this.tangentImpulse=t.tangentImpulse,this.id.Copy(t.id),this},t}();(pe=t.b2ManifoldType||(t.b2ManifoldType={}))[pe.e_unknown=-1]="e_unknown",pe[pe.e_circles=0]="e_circles",pe[pe.e_faceA=1]="e_faceA",pe[pe.e_faceB=2]="e_faceB";var ge,ye=function(){function e(){this.points=ve.MakeArray(s),this.localNormal=new bt,this.localPoint=new bt,this.type=t.b2ManifoldType.e_unknown,this.pointCount=0}var n=e.prototype;return n.Reset=function(){for(var e=0;e<s;++e)this.points[e].Reset();this.localNormal.SetZero(),this.localPoint.SetZero(),this.type=t.b2ManifoldType.e_unknown,this.pointCount=0},n.Copy=function(t){this.pointCount=t.pointCount;for(var e=0;e<s;++e)this.points[e].Copy(t.points[e]);return this.localNormal.Copy(t.localNormal),this.localPoint.Copy(t.localPoint),this.type=t.type,this},n.Clone=function(){return(new e).Copy(this)},e}(),xe=function(){function e(){this.normal=new bt,this.points=bt.MakeArray(s),this.separations=J(s)}return e.prototype.Initialize=function(n,i,r,a,s){if(0!==n.pointCount)switch(n.type){case t.b2ManifoldType.e_circles:this.normal.Set(1,0);var c=Rt.MulXV(i,n.localPoint,e.Initialize_s_pointA),l=Rt.MulXV(a,n.points[0].localPoint,e.Initialize_s_pointB);bt.DistanceSquaredVV(c,l)>o&&bt.SubVV(l,c,this.normal).SelfNormalize();var u=bt.AddVMulSV(c,r,this.normal,e.Initialize_s_cA),h=bt.SubVMulSV(l,s,this.normal,e.Initialize_s_cB);bt.MidVV(u,h,this.points[0]),this.separations[0]=bt.DotVV(bt.SubVV(h,u,bt.s_t0),this.normal);break;case t.b2ManifoldType.e_faceA:It.MulRV(i.q,n.localNormal,this.normal);for(var _=Rt.MulXV(i,n.localPoint,e.Initialize_s_planePoint),f=0;f<n.pointCount;++f){var p=Rt.MulXV(a,n.points[f].localPoint,e.Initialize_s_clipPoint),d=r-bt.DotVV(bt.SubVV(p,_,bt.s_t0),this.normal),m=bt.AddVMulSV(p,d,this.normal,e.Initialize_s_cA),v=bt.SubVMulSV(p,s,this.normal,e.Initialize_s_cB);bt.MidVV(m,v,this.points[f]),this.separations[f]=bt.DotVV(bt.SubVV(v,m,bt.s_t0),this.normal)}break;case t.b2ManifoldType.e_faceB:It.MulRV(a.q,n.localNormal,this.normal);for(var g=Rt.MulXV(a,n.localPoint,e.Initialize_s_planePoint),y=0;y<n.pointCount;++y){var x=Rt.MulXV(i,n.points[y].localPoint,e.Initialize_s_clipPoint),S=s-bt.DotVV(bt.SubVV(x,g,bt.s_t0),this.normal),C=bt.AddVMulSV(x,S,this.normal,e.Initialize_s_cB),A=bt.SubVMulSV(x,r,this.normal,e.Initialize_s_cA);bt.MidVV(A,C,this.points[y]),this.separations[y]=bt.DotVV(bt.SubVV(A,C,bt.s_t0),this.normal)}this.normal.SelfNeg()}},e}();function Se(e,n,i,r){var o;for(o=0;o<i.pointCount;++o){var a=i.points[o].id.key;e[o]=t.b2PointState.b2_removeState;for(var c=0,l=r.pointCount;c<l;++c)if(r.points[c].id.key===a){e[o]=t.b2PointState.b2_persistState;break}}for(;o<s;++o)e[o]=t.b2PointState.b2_nullState;for(o=0;o<r.pointCount;++o){var u=r.points[o].id.key;n[o]=t.b2PointState.b2_addState;for(var h=0,_=i.pointCount;h<_;++h)if(i.points[h].id.key===u){n[o]=t.b2PointState.b2_persistState;break}}for(;o<s;++o)n[o]=t.b2PointState.b2_nullState}xe.Initialize_s_pointA=new bt,xe.Initialize_s_pointB=new bt,xe.Initialize_s_cA=new bt,xe.Initialize_s_cB=new bt,xe.Initialize_s_planePoint=new bt,xe.Initialize_s_clipPoint=new bt,(ge=t.b2PointState||(t.b2PointState={}))[ge.b2_nullState=0]="b2_nullState",ge[ge.b2_addState=1]="b2_addState",ge[ge.b2_persistState=2]="b2_persistState",ge[ge.b2_removeState=3]="b2_removeState";var Ce=function(){function t(){this.v=new bt,this.id=new me}return t.MakeArray=function(e){return X(e,(function(){return new t}))},t.prototype.Copy=function(t){return this.v.Copy(t.v),this.id.Copy(t.id),this},t}(),Ae=function(){function t(){this.p1=new bt,this.p2=new bt,this.maxFraction=1}return t.prototype.Copy=function(t){return this.p1.Copy(t.p1),this.p2.Copy(t.p2),this.maxFraction=t.maxFraction,this},t}(),be=function(){function t(){this.normal=new bt,this.fraction=0}return t.prototype.Copy=function(t){return this.normal.Copy(t.normal),this.fraction=t.fraction,this},t}(),Te=function(){function t(){this.lowerBound=new bt,this.upperBound=new bt,this.m_cache_center=new bt,this.m_cache_extent=new bt}var e=t.prototype;return e.Copy=function(t){return this.lowerBound.Copy(t.lowerBound),this.upperBound.Copy(t.upperBound),this},e.IsValid=function(){return!(!this.lowerBound.IsValid()||!this.upperBound.IsValid()||this.upperBound.x<this.lowerBound.x||this.upperBound.y<this.lowerBound.y)},e.GetCenter=function(){return bt.MidVV(this.lowerBound,this.upperBound,this.m_cache_center)},e.GetExtents=function(){return bt.ExtVV(this.lowerBound,this.upperBound,this.m_cache_extent)},e.GetPerimeter=function(){return 2*(this.upperBound.x-this.lowerBound.x+(this.upperBound.y-this.lowerBound.y))},e.Combine1=function(t){return this.lowerBound.x=it(this.lowerBound.x,t.lowerBound.x),this.lowerBound.y=it(this.lowerBound.y,t.lowerBound.y),this.upperBound.x=rt(this.upperBound.x,t.upperBound.x),this.upperBound.y=rt(this.upperBound.y,t.upperBound.y),this},e.Combine2=function(t,e){return this.lowerBound.x=it(t.lowerBound.x,e.lowerBound.x),this.lowerBound.y=it(t.lowerBound.y,e.lowerBound.y),this.upperBound.x=rt(t.upperBound.x,e.upperBound.x),this.upperBound.y=rt(t.upperBound.y,e.upperBound.y),this},t.Combine=function(t,e,n){return n.Combine2(t,e),n},e.Contains=function(t){return!(this.lowerBound.x<=t.lowerBound.x||this.lowerBound.y<=t.lowerBound.y||t.upperBound.x<=this.upperBound.x||t.upperBound.y<=this.upperBound.y)},e.RayCast=function(t,e){var n=-i,o=i,a=e.p1.x,s=e.p1.y,c=e.p2.x-e.p1.x,l=e.p2.y-e.p1.y,u=nt(c),h=nt(l),_=t.normal;if(u<r){if(a<this.lowerBound.x||this.upperBound.x<a)return!1}else{var f=1/c,p=(this.lowerBound.x-a)*f,d=(this.upperBound.x-a)*f,m=-1;if(p>d){var v=p;p=d,d=v,m=1}if(p>n&&(_.x=m,_.y=0,n=p),n>(o=it(o,d)))return!1}if(h<r){if(s<this.lowerBound.y||this.upperBound.y<s)return!1}else{var g=1/l,y=(this.lowerBound.y-s)*g,x=(this.upperBound.y-s)*g,S=-1;if(y>x){var C=y;y=x,x=C,S=1}if(y>n&&(_.x=0,_.y=S,n=y),n>(o=it(o,x)))return!1}return!(n<0||e.maxFraction<n||(t.fraction=n,0))},e.TestContain=function(t){return!(t.x<this.lowerBound.x||this.upperBound.x<t.x||t.y<this.lowerBound.y||this.upperBound.y<t.y)},e.TestOverlap=function(t){return!(this.upperBound.x<t.lowerBound.x||this.upperBound.y<t.lowerBound.y||t.upperBound.x<this.lowerBound.x||t.upperBound.y<this.lowerBound.y)},t}();function Ee(t,e){return!(t.upperBound.x<e.lowerBound.x||t.upperBound.y<e.lowerBound.y||e.upperBound.x<t.lowerBound.x||e.upperBound.y<t.lowerBound.y)}function we(e,n,i,r,o){var a=0,s=n[0],c=n[1],l=bt.DotVV(i,s.v)-r,u=bt.DotVV(i,c.v)-r;if(l<=0&&e[a++].Copy(s),u<=0&&e[a++].Copy(c),l*u<0){var h=l/(l-u),_=e[a].v;_.x=s.v.x+h*(c.v.x-s.v.x),_.y=s.v.y+h*(c.v.y-s.v.y);var f=e[a].id;f.cf.indexA=o,f.cf.indexB=s.id.cf.indexB,f.cf.typeA=t.b2ContactFeatureType.e_vertex,f.cf.typeB=t.b2ContactFeatureType.e_face,++a}return a}var Pe=new kt,Ie=new Ut,Re=new Ht;function De(t,e,n,i,o,a){var s=Pe.Reset();s.proxyA.SetShape(t,e),s.proxyB.SetShape(n,i),s.transformA.Copy(o),s.transformB.Copy(a),s.useRadii=!0;var c=Ie.Reset();c.count=0;var l=Re.Reset();return ie(l,c,s),l.distance<10*r}function Be(t){if(null===t)throw new Error;return t}var Me=function(){function t(t){void 0===t&&(t=0),this.m_id=0,this.aabb=new Te,this._userData=null,this.parent=null,this.child1=null,this.child2=null,this.height=0,this.m_id=t}var e=t.prototype;return e.Reset=function(){this._userData=null},e.IsLeaf=function(){return null===this.child1},K(t,[{key:"userData",get:function(){if(null===this._userData)throw new Error;return this._userData},set:function(t){if(null!==this._userData)throw new Error;this._userData=t}}]),t}(),Oe=function(){function t(){this.m_root=null,this.m_freeList=null,this.m_path=0,this.m_insertionCount=0,this.m_stack=new Ft(256)}var e=t.prototype;return e.Query=function(t,e){var n=this.m_stack.Reset();for(n.Push(this.m_root);n.GetCount()>0;){var i=n.Pop();if(null!==i&&i.aabb.TestOverlap(t))if(i.IsLeaf()){if(!e(i))return}else n.Push(i.child1),n.Push(i.child2)}},e.QueryPoint=function(t,e){var n=this.m_stack.Reset();for(n.Push(this.m_root);n.GetCount()>0;){var i=n.Pop();if(null!==i&&i.aabb.TestContain(t))if(i.IsLeaf()){if(!e(i))return}else n.Push(i.child1),n.Push(i.child2)}},e.RayCast=function(e,n){var i=e.p1,r=e.p2,o=bt.SubVV(r,i,t.s_r);o.Normalize();var a=bt.CrossOneV(o,t.s_v),s=bt.AbsV(a,t.s_abs_v),c=e.maxFraction,l=t.s_segmentAABB,u=i.x+c*(r.x-i.x),h=i.y+c*(r.y-i.y);l.lowerBound.x=it(i.x,u),l.lowerBound.y=it(i.y,h),l.upperBound.x=rt(i.x,u),l.upperBound.y=rt(i.y,h);var _=this.m_stack.Reset();for(_.Push(this.m_root);_.GetCount()>0;){var f=_.Pop();if(null!==f&&Ee(f.aabb,l)){var p=f.aabb.GetCenter(),d=f.aabb.GetExtents();if(!(nt(bt.DotVV(a,bt.SubVV(i,p,bt.s_t0)))-bt.DotVV(s,d)>0))if(f.IsLeaf()){var m=t.s_subInput;m.p1.Copy(e.p1),m.p2.Copy(e.p2),m.maxFraction=c;var v=n(m,f);if(0===v)return;v>0&&(c=v,u=i.x+c*(r.x-i.x),h=i.y+c*(r.y-i.y),l.lowerBound.x=it(i.x,u),l.lowerBound.y=it(i.y,h),l.upperBound.x=rt(i.x,u),l.upperBound.y=rt(i.y,h))}else _.Push(f.child1),_.Push(f.child2)}}},e.AllocateNode=function(){if(null!==this.m_freeList){var e=this.m_freeList;return this.m_freeList=e.parent,e.parent=null,e.child1=null,e.child2=null,e.height=0,e}return new Me(t.s_node_id++)},e.FreeNode=function(t){t.parent=this.m_freeList,t.child1=null,t.child2=null,t.height=-1,t.Reset(),this.m_freeList=t},e.CreateProxy=function(t,e){var n=this.AllocateNode(),i=l,r=l;return n.aabb.lowerBound.x=t.lowerBound.x-i,n.aabb.lowerBound.y=t.lowerBound.y-r,n.aabb.upperBound.x=t.upperBound.x+i,n.aabb.upperBound.y=t.upperBound.y+r,n.userData=e,n.height=0,this.InsertLeaf(n),n},e.DestroyProxy=function(t){this.RemoveLeaf(t),this.FreeNode(t)},e.MoveProxy=function(t,e,n){if(t.aabb.Contains(e))return!1;this.RemoveLeaf(t);var i=l,r=l;t.aabb.lowerBound.x=e.lowerBound.x-i,t.aabb.lowerBound.y=e.lowerBound.y-r,t.aabb.upperBound.x=e.upperBound.x+i,t.aabb.upperBound.y=e.upperBound.y+r;var o=u*n.x,a=u*n.y;return o<0?t.aabb.lowerBound.x+=o:t.aabb.upperBound.x+=o,a<0?t.aabb.lowerBound.y+=a:t.aabb.upperBound.y+=a,this.InsertLeaf(t),!0},e.InsertLeaf=function(e){if(++this.m_insertionCount,null===this.m_root)return this.m_root=e,void(this.m_root.parent=null);for(var n=e.aabb,i=this.m_root;!i.IsLeaf();){var r=Be(i.child1),o=Be(i.child2),a=i.aabb.GetPerimeter(),s=t.s_combinedAABB;s.Combine2(i.aabb,n);var c=s.GetPerimeter(),l=2*c,u=2*(c-a),h=void 0,_=t.s_aabb,f=void 0;r.IsLeaf()?(_.Combine2(n,r.aabb),h=_.GetPerimeter()+u):(_.Combine2(n,r.aabb),f=r.aabb.GetPerimeter(),h=_.GetPerimeter()-f+u);var p=void 0;if(o.IsLeaf()?(_.Combine2(n,o.aabb),p=_.GetPerimeter()+u):(_.Combine2(n,o.aabb),f=o.aabb.GetPerimeter(),p=_.GetPerimeter()-f+u),l<h&&l<p)break;i=h<p?r:o}var d=i.parent,m=this.AllocateNode();m.parent=d,m.aabb.Combine2(n,i.aabb),m.height=i.height+1,null!==d?(d.child1===i?d.child1=m:d.child2=m,m.child1=i,m.child2=e,i.parent=m,e.parent=m):(m.child1=i,m.child2=e,i.parent=m,e.parent=m,this.m_root=m);for(var v=e.parent;null!==v;){var g=Be((v=this.Balance(v)).child1),y=Be(v.child2);v.height=1+rt(g.height,y.height),v.aabb.Combine2(g.aabb,y.aabb),v=v.parent}},e.RemoveLeaf=function(t){if(t!==this.m_root){var e=Be(t.parent),n=e&&e.parent,i=Be(e.child1===t?e.child2:e.child1);if(null!==n){n.child1===e?n.child1=i:n.child2=i,i.parent=n,this.FreeNode(e);for(var r=n;null!==r;){var o=Be((r=this.Balance(r)).child1),a=Be(r.child2);r.aabb.Combine2(o.aabb,a.aabb),r.height=1+rt(o.height,a.height),r=r.parent}}else this.m_root=i,i.parent=null,this.FreeNode(e)}else this.m_root=null},e.Balance=function(t){if(t.IsLeaf()||t.height<2)return t;var e=Be(t.child1),n=Be(t.child2),i=n.height-e.height;if(i>1){var r=Be(n.child1),o=Be(n.child2);return n.child1=t,n.parent=t.parent,t.parent=n,null!==n.parent?n.parent.child1===t?n.parent.child1=n:n.parent.child2=n:this.m_root=n,r.height>o.height?(n.child2=r,t.child2=o,o.parent=t,t.aabb.Combine2(e.aabb,o.aabb),n.aabb.Combine2(t.aabb,r.aabb),t.height=1+rt(e.height,o.height),n.height=1+rt(t.height,r.height)):(n.child2=o,t.child2=r,r.parent=t,t.aabb.Combine2(e.aabb,r.aabb),n.aabb.Combine2(t.aabb,o.aabb),t.height=1+rt(e.height,r.height),n.height=1+rt(t.height,o.height)),n}if(i<-1){var a=Be(e.child1),s=Be(e.child2);return e.child1=t,e.parent=t.parent,t.parent=e,null!==e.parent?e.parent.child1===t?e.parent.child1=e:e.parent.child2=e:this.m_root=e,a.height>s.height?(e.child2=a,t.child1=s,s.parent=t,t.aabb.Combine2(n.aabb,s.aabb),e.aabb.Combine2(t.aabb,a.aabb),t.height=1+rt(n.height,s.height),e.height=1+rt(t.height,a.height)):(e.child2=s,t.child1=a,a.parent=t,t.aabb.Combine2(n.aabb,a.aabb),e.aabb.Combine2(t.aabb,s.aabb),t.height=1+rt(n.height,a.height),e.height=1+rt(t.height,s.height)),e}return t},e.GetHeight=function(){return null===this.m_root?0:this.m_root.height},t.GetAreaNode=function(e){if(null===e)return 0;if(e.IsLeaf())return 0;var n=e.aabb.GetPerimeter();return(n+=t.GetAreaNode(e.child1))+t.GetAreaNode(e.child2)},e.GetAreaRatio=function(){if(null===this.m_root)return 0;var e=this.m_root.aabb.GetPerimeter();return t.GetAreaNode(this.m_root)/e},t.ComputeHeightNode=function(e){return null===e||e.IsLeaf()?0:1+rt(t.ComputeHeightNode(e.child1),t.ComputeHeightNode(e.child2))},e.ComputeHeight=function(){return t.ComputeHeightNode(this.m_root)},e.ValidateStructure=function(t){if(null!==t&&(this.m_root,!t.IsLeaf())){var e=Be(t.child1),n=Be(t.child2);this.ValidateStructure(e),this.ValidateStructure(n)}},e.ValidateMetrics=function(e){if(null!==e&&!e.IsLeaf()){var n=Be(e.child1),i=Be(e.child2);t.s_aabb.Combine2(n.aabb,i.aabb),this.ValidateMetrics(n),this.ValidateMetrics(i)}},e.Validate=function(){},t.GetMaxBalanceNode=function(t,e){if(null===t)return e;if(t.height<=1)return e;var n=Be(t.child1),i=Be(t.child2);return rt(e,nt(i.height-n.height))},e.GetMaxBalance=function(){return t.GetMaxBalanceNode(this.m_root,0)},e.RebuildBottomUp=function(){this.Validate()},t.ShiftOriginNode=function(e,n){if(null!==e&&!(e.height<=1)){var i=e.child1,r=e.child2;t.ShiftOriginNode(i,n),t.ShiftOriginNode(r,n),e.aabb.lowerBound.SelfSub(n),e.aabb.upperBound.SelfSub(n)}},e.ShiftOrigin=function(e){t.ShiftOriginNode(this.m_root,e)},t}();function Ne(t,e,n){var i=t[e];t[e]=t[n],t[n]=i}function Le(t,e){return t<e}function Fe(t,e,n,i){void 0===e&&(e=0),void 0===n&&(n=t.length-e),void 0===i&&(i=Le);for(var r=e,o=[],a=0;;){for(;r+1<n;n++){var s=t[r+Math.floor(Math.random()*(n-r))];o[a++]=n;for(var c=r-1;;){for(;i(t[++c],s););for(;i(s,t[--n]););if(c>=n)break;Ne(t,c,n)}}if(0===a)break;r=n,n=o[--a]}return t}Oe.s_r=new bt,Oe.s_v=new bt,Oe.s_abs_v=new bt,Oe.s_segmentAABB=new Te,Oe.s_subInput=new Ae,Oe.s_combinedAABB=new Te,Oe.s_aabb=new Te,Oe.s_node_id=0;var ze=function(t,e){this.proxyA=t,this.proxyB=e},Ge=function(){function t(){this.m_tree=new Oe,this.m_proxyCount=0,this.m_moveCount=0,this.m_moveBuffer=[],this.m_pairCount=0,this.m_pairBuffer=[]}var e=t.prototype;return e.CreateProxy=function(t,e){var n=this.m_tree.CreateProxy(t,e);return++this.m_proxyCount,this.BufferMove(n),n},e.DestroyProxy=function(t){this.UnBufferMove(t),--this.m_proxyCount,this.m_tree.DestroyProxy(t)},e.MoveProxy=function(t,e,n){this.m_tree.MoveProxy(t,e,n)&&this.BufferMove(t)},e.TouchProxy=function(t){this.BufferMove(t)},e.GetProxyCount=function(){return this.m_proxyCount},e.UpdatePairs=function(t){var e=this;this.m_pairCount=0;for(var n=function(t){var n=e.m_moveBuffer[t];if(null===n)return"continue";var i=n.aabb;e.m_tree.Query(i,(function(t){if(t.m_id===n.m_id)return!0;var i,r;if(t.m_id<n.m_id?(i=t,r=n):(i=n,r=t),e.m_pairCount===e.m_pairBuffer.length)e.m_pairBuffer[e.m_pairCount]=new ze(i,r);else{var o=e.m_pairBuffer[e.m_pairCount];o.proxyA=i,o.proxyB=r}return++e.m_pairCount,!0}))},i=0;i<this.m_moveCount;++i)n(i);this.m_moveCount=0,Fe(this.m_pairBuffer,0,this.m_pairCount,Ve);for(var r=0;r<this.m_pairCount;){var o=this.m_pairBuffer[r];for(t(o.proxyA.userData,o.proxyB.userData),++r;r<this.m_pairCount;){var a=this.m_pairBuffer[r];if(a.proxyA.m_id!==o.proxyA.m_id||a.proxyB.m_id!==o.proxyB.m_id)break;++r}}},e.Query=function(t,e){this.m_tree.Query(t,e)},e.QueryPoint=function(t,e){this.m_tree.QueryPoint(t,e)},e.RayCast=function(t,e){this.m_tree.RayCast(t,e)},e.GetTreeHeight=function(){return this.m_tree.GetHeight()},e.GetTreeBalance=function(){return this.m_tree.GetMaxBalance()},e.GetTreeQuality=function(){return this.m_tree.GetAreaRatio()},e.ShiftOrigin=function(t){this.m_tree.ShiftOrigin(t)},e.BufferMove=function(t){this.m_moveBuffer[this.m_moveCount]=t,++this.m_moveCount},e.UnBufferMove=function(t){var e=this.m_moveBuffer.indexOf(t);this.m_moveBuffer[e]=null},t}();function Ve(t,e){return t.proxyA.m_id<e.proxyA.m_id||t.proxyA.m_id===e.proxyA.m_id&&t.proxyB.m_id<e.proxyB.m_id}function Ue(){t.b2_toiTime=0,t.b2_toiMaxTime=0,t.b2_toiCalls=0,t.b2_toiIters=0,t.b2_toiMaxIters=0,t.b2_toiRootIters=0,t.b2_toiMaxRootIters=0}t.b2_toiTime=0,t.b2_toiMaxTime=0,t.b2_toiCalls=0,t.b2_toiIters=0,t.b2_toiMaxIters=0,t.b2_toiRootIters=0,t.b2_toiMaxRootIters=0;var ke,He=new Rt,je=new Rt,We=new bt,qe=new bt,Xe=new bt,Ye=new bt,Ke=new bt,Je=function(){this.proxyA=new Vt,this.proxyB=new Vt,this.sweepA=new Bt,this.sweepB=new Bt,this.tMax=0};(ke=t.b2TOIOutputState||(t.b2TOIOutputState={}))[ke.e_unknown=0]="e_unknown",ke[ke.e_failed=1]="e_failed",ke[ke.e_overlapped=2]="e_overlapped",ke[ke.e_touching=3]="e_touching",ke[ke.e_separated=4]="e_separated";var Qe,Ze=function(){this.state=t.b2TOIOutputState.e_unknown,this.t=0};(Qe=t.b2SeparationFunctionType||(t.b2SeparationFunctionType={}))[Qe.e_unknown=-1]="e_unknown",Qe[Qe.e_points=0]="e_points",Qe[Qe.e_faceA=1]="e_faceA",Qe[Qe.e_faceB=2]="e_faceB";var $e=function(){function e(){this.m_sweepA=new Bt,this.m_sweepB=new Bt,this.m_type=t.b2SeparationFunctionType.e_unknown,this.m_localPoint=new bt,this.m_axis=new bt}var n=e.prototype;return n.Initialize=function(e,n,i,r,o,a){this.m_proxyA=n,this.m_proxyB=r;var s=e.count;this.m_sweepA.Copy(i),this.m_sweepB.Copy(o);var c=He,l=je;if(this.m_sweepA.GetTransform(c,a),this.m_sweepB.GetTransform(l,a),1===s){this.m_type=t.b2SeparationFunctionType.e_points;var u=this.m_proxyA.GetVertex(e.indexA[0]),h=this.m_proxyB.GetVertex(e.indexB[0]),_=Rt.MulXV(c,u,We),f=Rt.MulXV(l,h,qe);bt.SubVV(f,_,this.m_axis);var p=this.m_axis.Normalize();return this.m_localPoint.SetZero(),p}if(e.indexA[0]===e.indexA[1]){this.m_type=t.b2SeparationFunctionType.e_faceB;var d=this.m_proxyB.GetVertex(e.indexB[0]),m=this.m_proxyB.GetVertex(e.indexB[1]);bt.CrossVOne(bt.SubVV(m,d,bt.s_t0),this.m_axis).SelfNormalize();var v=It.MulRV(l.q,this.m_axis,Xe);bt.MidVV(d,m,this.m_localPoint);var g=Rt.MulXV(l,this.m_localPoint,qe),y=this.m_proxyA.GetVertex(e.indexA[0]),x=Rt.MulXV(c,y,We),S=bt.DotVV(bt.SubVV(x,g,bt.s_t0),v);return S<0&&(this.m_axis.SelfNeg(),S=-S),S}this.m_type=t.b2SeparationFunctionType.e_faceA;var C=this.m_proxyA.GetVertex(e.indexA[0]),A=this.m_proxyA.GetVertex(e.indexA[1]);bt.CrossVOne(bt.SubVV(A,C,bt.s_t0),this.m_axis).SelfNormalize();var b=It.MulRV(c.q,this.m_axis,Xe);bt.MidVV(C,A,this.m_localPoint);var T=Rt.MulXV(c,this.m_localPoint,We),E=this.m_proxyB.GetVertex(e.indexB[0]),w=Rt.MulXV(l,E,qe),P=bt.DotVV(bt.SubVV(w,T,bt.s_t0),b);return P<0&&(this.m_axis.SelfNeg(),P=-P),P},n.FindMinSeparation=function(e,n,i){var r=He,o=je;switch(this.m_sweepA.GetTransform(r,i),this.m_sweepB.GetTransform(o,i),this.m_type){case t.b2SeparationFunctionType.e_points:var a=It.MulTRV(r.q,this.m_axis,Ye),s=It.MulTRV(o.q,bt.NegV(this.m_axis,bt.s_t0),Ke);e[0]=this.m_proxyA.GetSupport(a),n[0]=this.m_proxyB.GetSupport(s);var c=this.m_proxyA.GetVertex(e[0]),l=this.m_proxyB.GetVertex(n[0]),u=Rt.MulXV(r,c,We),h=Rt.MulXV(o,l,qe);return bt.DotVV(bt.SubVV(h,u,bt.s_t0),this.m_axis);case t.b2SeparationFunctionType.e_faceA:var _=It.MulRV(r.q,this.m_axis,Xe),f=Rt.MulXV(r,this.m_localPoint,We),p=It.MulTRV(o.q,bt.NegV(_,bt.s_t0),Ke);e[0]=-1,n[0]=this.m_proxyB.GetSupport(p);var d=this.m_proxyB.GetVertex(n[0]),m=Rt.MulXV(o,d,qe);return bt.DotVV(bt.SubVV(m,f,bt.s_t0),_);case t.b2SeparationFunctionType.e_faceB:var v=It.MulRV(o.q,this.m_axis,Xe),g=Rt.MulXV(o,this.m_localPoint,qe),y=It.MulTRV(r.q,bt.NegV(v,bt.s_t0),Ye);n[0]=-1,e[0]=this.m_proxyA.GetSupport(y);var x=this.m_proxyA.GetVertex(e[0]),S=Rt.MulXV(r,x,We);return bt.DotVV(bt.SubVV(S,g,bt.s_t0),v);default:return e[0]=-1,n[0]=-1,0}},n.Evaluate=function(e,n,i){var r=He,o=je;switch(this.m_sweepA.GetTransform(r,i),this.m_sweepB.GetTransform(o,i),this.m_type){case t.b2SeparationFunctionType.e_points:var a=this.m_proxyA.GetVertex(e),s=this.m_proxyB.GetVertex(n),c=Rt.MulXV(r,a,We),l=Rt.MulXV(o,s,qe);return bt.DotVV(bt.SubVV(l,c,bt.s_t0),this.m_axis);case t.b2SeparationFunctionType.e_faceA:var u=It.MulRV(r.q,this.m_axis,Xe),h=Rt.MulXV(r,this.m_localPoint,We),_=this.m_proxyB.GetVertex(n),f=Rt.MulXV(o,_,qe);return bt.DotVV(bt.SubVV(f,h,bt.s_t0),u);case t.b2SeparationFunctionType.e_faceB:var p=It.MulRV(o.q,this.m_axis,Xe),d=Rt.MulXV(o,this.m_localPoint,qe),m=this.m_proxyA.GetVertex(e),v=Rt.MulXV(r,m,We);return bt.DotVV(bt.SubVV(v,d,bt.s_t0),p);default:return 0}},e}(),tn=new Nt,en=new Ut,nn=new kt,rn=new Ht,on=new $e,an=[0],sn=[0],cn=new Bt,ln=new Bt;function un(e,n){var i=tn.Reset();++t.b2_toiCalls,e.state=t.b2TOIOutputState.e_unknown,e.t=n.tMax;var r=n.proxyA,o=n.proxyB,a=rt(c,rt(r.m_count,o.m_count)),s=cn.Copy(n.sweepA),l=ln.Copy(n.sweepB);s.Normalize(),l.Normalize();var u=n.tMax,_=r.m_radius+o.m_radius,f=rt(h,_-3*h),p=.25*h,d=0,m=20,v=0,g=en;g.count=0;var y=nn;for(y.proxyA.Copy(n.proxyA),y.proxyB.Copy(n.proxyB),y.useRadii=!1;;){var x=He,S=je;s.GetTransform(x,d),l.GetTransform(S,d),y.transformA.Copy(x),y.transformB.Copy(S);var C=rn;if(ie(C,g,y),C.distance<=0){e.state=t.b2TOIOutputState.e_overlapped,e.t=0;break}if(C.distance<f+p){e.state=t.b2TOIOutputState.e_touching,e.t=d;break}var A=on;A.Initialize(g,r,s,o,l,d);for(var b=!1,T=u,E=0;;){var w=an,P=sn,I=A.FindMinSeparation(w,P,T);if(I>f+p){e.state=t.b2TOIOutputState.e_separated,e.t=u,b=!0;break}if(I>f-p){d=T;break}var R=A.Evaluate(w[0],P[0],d);if(R<f-p){e.state=t.b2TOIOutputState.e_failed,e.t=d,b=!0;break}if(R<=f+p){e.state=t.b2TOIOutputState.e_touching,e.t=d,b=!0;break}for(var D=0,B=d,M=T;;){var O=0;O=1&D?B+(f-R)*(M-B)/(I-R):.5*(B+M),++D,++t.b2_toiRootIters;var N=A.Evaluate(w[0],P[0],O);if(nt(N-f)<p){T=O;break}if(N>f?(B=O,R=N):(M=O,I=N),50===D)break}if(t.b2_toiMaxRootIters=rt(t.b2_toiMaxRootIters,D),++E===a)break}if(++v,++t.b2_toiIters,b)break;if(v===m){e.state=t.b2TOIOutputState.e_failed,e.t=d;break}}t.b2_toiMaxIters=rt(t.b2_toiMaxIters,v);var L=i.GetMilliseconds();t.b2_toiMaxTime=rt(t.b2_toiMaxTime,L),t.b2_toiTime+=L}var hn=new bt,_n=new bt;function fn(e,n,i,r,o){e.pointCount=0;var a=Rt.MulXV(i,n.m_p,hn),s=Rt.MulXV(o,r.m_p,_n),c=bt.DistanceSquaredVV(a,s),l=n.m_radius+r.m_radius;c>l*l||(e.type=t.b2ManifoldType.e_circles,e.localPoint.Copy(n.m_p),e.localNormal.SetZero(),e.pointCount=1,e.points[0].localPoint.Copy(r.m_p),e.points[0].id.key=0)}var pn=new bt,dn=new bt,mn=new bt;function vn(e,n,o,a,s){e.pointCount=0;for(var c=Rt.MulXV(s,a.m_p,pn),l=Rt.MulTXV(o,c,dn),u=0,h=-i,_=n.m_radius+a.m_radius,f=n.m_count,p=n.m_vertices,d=n.m_normals,m=0;m<f;++m){var v=bt.DotVV(d[m],bt.SubVV(l,p[m],bt.s_t0));if(v>_)return;v>h&&(h=v,u=m)}var g=u,y=(g+1)%f,x=p[g],S=p[y];if(h<r)return e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(d[u]),bt.MidVV(x,S,e.localPoint),e.points[0].localPoint.Copy(a.m_p),void(e.points[0].id.key=0);var C=bt.DotVV(bt.SubVV(l,x,bt.s_t0),bt.SubVV(S,x,bt.s_t1)),A=bt.DotVV(bt.SubVV(l,S,bt.s_t0),bt.SubVV(x,S,bt.s_t1));if(C<=0){if(bt.DistanceSquaredVV(l,x)>_*_)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,bt.SubVV(l,x,e.localNormal).SelfNormalize(),e.localPoint.Copy(x),e.points[0].localPoint.Copy(a.m_p),e.points[0].id.key=0}else if(A<=0){if(bt.DistanceSquaredVV(l,S)>_*_)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,bt.SubVV(l,S,e.localNormal).SelfNormalize(),e.localPoint.Copy(S),e.points[0].localPoint.Copy(a.m_p),e.points[0].id.key=0}else{var b=bt.MidVV(x,S,mn);if(bt.DotVV(bt.SubVV(l,b,bt.s_t1),d[g])>_)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(d[g]).SelfNormalize(),e.localPoint.Copy(b),e.points[0].localPoint.Copy(a.m_p),e.points[0].id.key=0}}var gn=new bt,yn=new bt,xn=new bt,Sn=new bt;function Cn(t,e,n,r,o){for(var a=t.m_vertices,s=t.m_normals,c=r.m_count,l=r.m_vertices,u=It.MulRV(e.q,s[n],gn),h=It.MulTRV(o.q,u,yn),_=0,f=i,p=0;p<c;++p){var d=bt.DotVV(l[p],h);d<f&&(f=d,_=p)}var m=Rt.MulXV(e,a[n],xn),v=Rt.MulXV(o,l[_],Sn);return bt.DotVV(bt.SubVV(v,m,bt.s_t0),u)}var An=new bt,bn=new bt;function Tn(t,e,n,r,o){for(var a=e.m_count,s=e.m_normals,c=bt.SubVV(Rt.MulXV(o,r.m_centroid,bt.s_t0),Rt.MulXV(n,e.m_centroid,bt.s_t1),An),l=It.MulTRV(n.q,c,bn),u=0,h=-i,_=0;_<a;++_){var f=bt.DotVV(s[_],l);f>h&&(h=f,u=_)}var p=Cn(e,n,u,r,o),d=(u+a-1)%a,m=Cn(e,n,d,r,o),v=(u+1)%a,g=Cn(e,n,v,r,o),y=0,x=0,S=0;if(m>p&&m>g)S=-1,y=d,x=m;else{if(!(g>p))return t[0]=u,p;S=1,y=v,x=g}for(;(p=Cn(e,n,u=-1===S?(y+a-1)%a:(y+1)%a,r,o))>x;)y=u,x=p;return t[0]=y,x}var En=new bt;function wn(e,n,r,o,a,s){for(var c=n.m_normals,l=a.m_count,u=a.m_vertices,h=a.m_normals,_=It.MulTRV(s.q,It.MulRV(r.q,c[o],bt.s_t0),En),f=0,p=i,d=0;d<l;++d){var m=bt.DotVV(_,h[d]);m<p&&(p=m,f=d)}var v=f,g=(v+1)%l,y=e[0];Rt.MulXV(s,u[v],y.v);var x=y.id.cf;x.indexA=o,x.indexB=v,x.typeA=t.b2ContactFeatureType.e_face,x.typeB=t.b2ContactFeatureType.e_vertex;var S=e[1];Rt.MulXV(s,u[g],S.v);var C=S.id.cf;C.indexA=o,C.indexB=g,C.typeA=t.b2ContactFeatureType.e_face,C.typeB=t.b2ContactFeatureType.e_vertex}var Pn=Ce.MakeArray(2),In=Ce.MakeArray(2),Rn=Ce.MakeArray(2),Dn=[0],Bn=[0],Mn=new bt,On=new bt,Nn=new bt,Ln=new bt,Fn=new bt,zn=new bt,Gn=new bt,Vn=new bt;function Un(e,n,i,r,o){e.pointCount=0;var a=n.m_radius+r.m_radius,c=Dn;c[0]=0;var l=Tn(c,n,i,r,o);if(!(l>a)){var u=Bn;u[0]=0;var h=Tn(u,r,o,n,i);if(!(h>a)){var _,f,p,d,m=0,v=0;h>.98*l+.001?(_=r,f=n,p=o,d=i,m=u[0],e.type=t.b2ManifoldType.e_faceB,v=1):(_=n,f=r,p=i,d=o,m=c[0],e.type=t.b2ManifoldType.e_faceA,v=0);var g=Pn;wn(g,_,p,m,f,d);var y=_.m_count,x=_.m_vertices,S=m,C=(m+1)%y,A=x[S],b=x[C],T=bt.SubVV(b,A,Mn);T.Normalize();var E=bt.CrossVOne(T,On),w=bt.MidVV(A,b,Nn),P=It.MulRV(p.q,T,Fn),I=bt.CrossVOne(P,Ln),R=Rt.MulXV(p,A,Gn),D=Rt.MulXV(p,b,Vn),B=bt.DotVV(I,R),M=-bt.DotVV(P,R)+a,O=bt.DotVV(P,D)+a,N=In,L=Rn;if(!(we(N,g,bt.NegV(P,zn),M,S)<2||we(L,N,P,O,C)<2)){e.localNormal.Copy(E),e.localPoint.Copy(w);for(var F=0,z=0;z<s;++z){var G=L[z];if(bt.DotVV(I,G.v)-B<=a){var V=e.points[F];if(Rt.MulTXV(d,G.v,V.localPoint),V.id.Copy(G.id),v){var U=V.id.cf;V.id.cf.indexA=U.indexB,V.id.cf.indexB=U.indexA,V.id.cf.typeA=U.typeB,V.id.cf.typeB=U.typeA}++F}}e.pointCount=F}}}}var kn,Hn=new bt,jn=new bt,Wn=new bt,qn=new bt,Xn=new bt,Yn=new bt,Kn=new bt,Jn=new me;function Qn(e,n,i,r,o){e.pointCount=0;var a=Rt.MulTXV(i,Rt.MulXV(o,r.m_p,bt.s_t0),Hn),s=n.m_vertex1,c=n.m_vertex2,l=bt.SubVV(c,s,jn),u=bt.DotVV(l,bt.SubVV(c,a,bt.s_t0)),h=bt.DotVV(l,bt.SubVV(a,s,bt.s_t0)),_=n.m_radius+r.m_radius,f=Jn;if(f.cf.indexB=0,f.cf.typeB=t.b2ContactFeatureType.e_vertex,h<=0){var p=s,d=bt.SubVV(a,p,Wn);if(bt.DotVV(d,d)>_*_)return;if(n.m_hasVertex0){var m=n.m_vertex0,v=s,g=bt.SubVV(v,m,qn);if(bt.DotVV(g,bt.SubVV(v,a,bt.s_t0))>0)return}return f.cf.indexA=0,f.cf.typeA=t.b2ContactFeatureType.e_vertex,e.pointCount=1,e.type=t.b2ManifoldType.e_circles,e.localNormal.SetZero(),e.localPoint.Copy(p),e.points[0].id.Copy(f),void e.points[0].localPoint.Copy(r.m_p)}if(u<=0){var y=c,x=bt.SubVV(a,y,Wn);if(bt.DotVV(x,x)>_*_)return;if(n.m_hasVertex3){var S=n.m_vertex3,C=c,A=bt.SubVV(S,C,Xn);if(bt.DotVV(A,bt.SubVV(a,C,bt.s_t0))>0)return}return f.cf.indexA=1,f.cf.typeA=t.b2ContactFeatureType.e_vertex,e.pointCount=1,e.type=t.b2ManifoldType.e_circles,e.localNormal.SetZero(),e.localPoint.Copy(y),e.points[0].id.Copy(f),void e.points[0].localPoint.Copy(r.m_p)}var b=bt.DotVV(l,l),T=Yn;T.x=1/b*(u*s.x+h*c.x),T.y=1/b*(u*s.y+h*c.y);var E=bt.SubVV(a,T,Wn);if(!(bt.DotVV(E,E)>_*_)){var w=Kn.Set(-l.y,l.x);bt.DotVV(w,bt.SubVV(a,s,bt.s_t0))<0&&w.Set(-w.x,-w.y),w.Normalize(),f.cf.indexA=0,f.cf.typeA=t.b2ContactFeatureType.e_face,e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(w),e.localPoint.Copy(s),e.points[0].id.Copy(f),e.points[0].localPoint.Copy(r.m_p)}}!function(t){t[t.e_unknown=0]="e_unknown",t[t.e_edgeA=1]="e_edgeA",t[t.e_edgeB=2]="e_edgeB"}(kn||(kn={}));var Zn,$n=function(){this.type=kn.e_unknown,this.index=0,this.separation=0},ti=function(){this.vertices=[],this.normals=[],this.count=0},ei=function(){this.i1=0,this.i2=0,this.v1=new bt,this.v2=new bt,this.normal=new bt,this.sideNormal1=new bt,this.sideOffset1=0,this.sideNormal2=new bt,this.sideOffset2=0};!function(t){t[t.e_isolated=0]="e_isolated",t[t.e_concave=1]="e_concave",t[t.e_convex=2]="e_convex"}(Zn||(Zn={}));var ni=function(){function e(){this.m_polygonB=new ti,this.m_xf=new Rt,this.m_centroidB=new bt,this.m_v0=new bt,this.m_v1=new bt,this.m_v2=new bt,this.m_v3=new bt,this.m_normal0=new bt,this.m_normal1=new bt,this.m_normal2=new bt,this.m_normal=new bt,this.m_type1=Zn.e_isolated,this.m_type2=Zn.e_isolated,this.m_lowerLimit=new bt,this.m_upperLimit=new bt,this.m_radius=0,this.m_front=!1}var n=e.prototype;return n.Collide=function(n,i,r,o,a){Rt.MulTXX(r,a,this.m_xf),Rt.MulXV(this.m_xf,o.m_centroid,this.m_centroidB),this.m_v0.Copy(i.m_vertex0),this.m_v1.Copy(i.m_vertex1),this.m_v2.Copy(i.m_vertex2),this.m_v3.Copy(i.m_vertex3);var c=i.m_hasVertex0,l=i.m_hasVertex3,u=bt.SubVV(this.m_v2,this.m_v1,e.s_edge1);u.Normalize(),this.m_normal1.Set(u.y,-u.x);var h=bt.DotVV(this.m_normal1,bt.SubVV(this.m_centroidB,this.m_v1,bt.s_t0)),_=0,f=0,p=!1,d=!1;if(c){var m=bt.SubVV(this.m_v1,this.m_v0,e.s_edge0);m.Normalize(),this.m_normal0.Set(m.y,-m.x),p=bt.CrossVV(m,u)>=0,_=bt.DotVV(this.m_normal0,bt.SubVV(this.m_centroidB,this.m_v0,bt.s_t0))}if(l){var v=bt.SubVV(this.m_v3,this.m_v2,e.s_edge2);v.Normalize(),this.m_normal2.Set(v.y,-v.x),d=bt.CrossVV(u,v)>0,f=bt.DotVV(this.m_normal2,bt.SubVV(this.m_centroidB,this.m_v2,bt.s_t0))}c&&l?p&&d?(this.m_front=_>=0||h>=0||f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):p?(this.m_front=_>=0||h>=0&&f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):d?(this.m_front=f>=0||_>=0&&h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):(this.m_front=_>=0&&h>=0&&f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):c?p?(this.m_front=_>=0||h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):(this.m_front=_>=0&&h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):l?d?(this.m_front=h>=0||f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=h>=0&&f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1))),this.m_polygonB.count=o.m_count;for(var g=0;g<o.m_count;++g)this.m_polygonB.vertices.length<=g&&this.m_polygonB.vertices.push(new bt),this.m_polygonB.normals.length<=g&&this.m_polygonB.normals.push(new bt),Rt.MulXV(this.m_xf,o.m_vertices[g],this.m_polygonB.vertices[g]),It.MulRV(this.m_xf.q,o.m_normals[g],this.m_polygonB.normals[g]);this.m_radius=o.m_radius+i.m_radius,n.pointCount=0;var y=this.ComputeEdgeSeparation(e.s_edgeAxis);if(y.type!==kn.e_unknown&&!(y.separation>this.m_radius)){var x=this.ComputePolygonSeparation(e.s_polygonAxis);if(!(x.type!==kn.e_unknown&&x.separation>this.m_radius)){var S,C=.98,A=.001;S=x.type===kn.e_unknown?y:x.separation>C*y.separation+A?x:y;var b=e.s_ie,T=e.s_rf;if(S.type===kn.e_edgeA){n.type=t.b2ManifoldType.e_faceA;for(var E=0,w=bt.DotVV(this.m_normal,this.m_polygonB.normals[0]),P=1;P<this.m_polygonB.count;++P){var I=bt.DotVV(this.m_normal,this.m_polygonB.normals[P]);I<w&&(w=I,E=P)}var R=E,D=(R+1)%this.m_polygonB.count,B=b[0];B.v.Copy(this.m_polygonB.vertices[R]),B.id.cf.indexA=0,B.id.cf.indexB=R,B.id.cf.typeA=t.b2ContactFeatureType.e_face,B.id.cf.typeB=t.b2ContactFeatureType.e_vertex;var M=b[1];M.v.Copy(this.m_polygonB.vertices[D]),M.id.cf.indexA=0,M.id.cf.indexB=D,M.id.cf.typeA=t.b2ContactFeatureType.e_face,M.id.cf.typeB=t.b2ContactFeatureType.e_vertex,this.m_front?(T.i1=0,T.i2=1,T.v1.Copy(this.m_v1),T.v2.Copy(this.m_v2),T.normal.Copy(this.m_normal1)):(T.i1=1,T.i2=0,T.v1.Copy(this.m_v2),T.v2.Copy(this.m_v1),T.normal.Copy(this.m_normal1).SelfNeg())}else{n.type=t.b2ManifoldType.e_faceB;var O=b[0];O.v.Copy(this.m_v1),O.id.cf.indexA=0,O.id.cf.indexB=S.index,O.id.cf.typeA=t.b2ContactFeatureType.e_vertex,O.id.cf.typeB=t.b2ContactFeatureType.e_face;var N=b[1];N.v.Copy(this.m_v2),N.id.cf.indexA=0,N.id.cf.indexB=S.index,N.id.cf.typeA=t.b2ContactFeatureType.e_vertex,N.id.cf.typeB=t.b2ContactFeatureType.e_face,T.i1=S.index,T.i2=(T.i1+1)%this.m_polygonB.count,T.v1.Copy(this.m_polygonB.vertices[T.i1]),T.v2.Copy(this.m_polygonB.vertices[T.i2]),T.normal.Copy(this.m_polygonB.normals[T.i1])}T.sideNormal1.Set(T.normal.y,-T.normal.x),T.sideNormal2.Copy(T.sideNormal1).SelfNeg(),T.sideOffset1=bt.DotVV(T.sideNormal1,T.v1),T.sideOffset2=bt.DotVV(T.sideNormal2,T.v2);var L=e.s_clipPoints1,F=e.s_clipPoints2;if(!(we(L,b,T.sideNormal1,T.sideOffset1,T.i1)<s||we(F,L,T.sideNormal2,T.sideOffset2,T.i2)<s)){S.type===kn.e_edgeA?(n.localNormal.Copy(T.normal),n.localPoint.Copy(T.v1)):(n.localNormal.Copy(o.m_normals[T.i1]),n.localPoint.Copy(o.m_vertices[T.i1]));for(var z=0,G=0;G<s;++G)if(bt.DotVV(T.normal,bt.SubVV(F[G].v,T.v1,bt.s_t0))<=this.m_radius){var V=n.points[z];S.type===kn.e_edgeA?(Rt.MulTXV(this.m_xf,F[G].v,V.localPoint),V.id.Copy(F[G].id)):(V.localPoint.Copy(F[G].v),V.id.cf.typeA=F[G].id.cf.typeB,V.id.cf.typeB=F[G].id.cf.typeA,V.id.cf.indexA=F[G].id.cf.indexB,V.id.cf.indexB=F[G].id.cf.indexA),++z}n.pointCount=z}}}},n.ComputeEdgeSeparation=function(t){var e=t;e.type=kn.e_edgeA,e.index=this.m_front?0:1,e.separation=i;for(var n=0;n<this.m_polygonB.count;++n){var r=bt.DotVV(this.m_normal,bt.SubVV(this.m_polygonB.vertices[n],this.m_v1,bt.s_t0));r<e.separation&&(e.separation=r)}return e},n.ComputePolygonSeparation=function(t){var n=t;n.type=kn.e_unknown,n.index=-1,n.separation=-i;for(var r=e.s_perp.Set(-this.m_normal.y,this.m_normal.x),o=0;o<this.m_polygonB.count;++o){var a=bt.NegV(this.m_polygonB.normals[o],e.s_n),s=it(bt.DotVV(a,bt.SubVV(this.m_polygonB.vertices[o],this.m_v1,bt.s_t0)),bt.DotVV(a,bt.SubVV(this.m_polygonB.vertices[o],this.m_v2,bt.s_t0)));if(s>this.m_radius)return n.type=kn.e_edgeB,n.index=o,n.separation=s,n;if(bt.DotVV(a,r)>=0){if(bt.DotVV(bt.SubVV(a,this.m_upperLimit,bt.s_t0),this.m_normal)<-_)continue}else if(bt.DotVV(bt.SubVV(a,this.m_lowerLimit,bt.s_t0),this.m_normal)<-_)continue;s>n.separation&&(n.type=kn.e_edgeB,n.index=o,n.separation=s)}return n},e}();ni.s_edge1=new bt,ni.s_edge0=new bt,ni.s_edge2=new bt,ni.s_ie=Ce.MakeArray(2),ni.s_rf=new ei,ni.s_clipPoints1=Ce.MakeArray(2),ni.s_clipPoints2=Ce.MakeArray(2),ni.s_edgeAxis=new $n,ni.s_polygonAxis=new $n,ni.s_n=new bt,ni.s_perp=new bt;var ii=new ni;function ri(t,e,n,i,r){ii.Collide(t,e,n,i,r)}var oi,ai=function(){this.mass=0,this.center=new bt(0,0),this.I=0};(oi=t.b2ShapeType||(t.b2ShapeType={}))[oi.e_unknown=-1]="e_unknown",oi[oi.e_circleShape=0]="e_circleShape",oi[oi.e_edgeShape=1]="e_edgeShape",oi[oi.e_polygonShape=2]="e_polygonShape",oi[oi.e_chainShape=3]="e_chainShape",oi[oi.e_shapeTypeCount=4]="e_shapeTypeCount";var si=function(){function e(e,n){this.m_type=t.b2ShapeType.e_unknown,this.m_radius=0,this.m_type=e,this.m_radius=n}var n=e.prototype;return n.Copy=function(t){return this.m_radius=t.m_radius,this},n.GetType=function(){return this.m_type},e}(),ci=function(e){function n(n){var i;return void 0===n&&(n=0),(i=e.call(this,t.b2ShapeType.e_circleShape,n)||this).m_p=new bt,i}Q(n,e);var i=n.prototype;return i.Set=function(t,e){return void 0===e&&(e=this.m_radius),this.m_p.Copy(t),this.m_radius=e,this},i.Clone=function(){return(new n).Copy(this)},i.Copy=function(t){return e.prototype.Copy.call(this,t),this.m_p.Copy(t.m_p),this},i.GetChildCount=function(){return 1},i.TestPoint=function(t,e){var i=Rt.MulXV(t,this.m_p,n.TestPoint_s_center),r=bt.SubVV(e,i,n.TestPoint_s_d);return bt.DotVV(r,r)<=lt(this.m_radius)},i.ComputeDistance=function(t,e,i){var r=Rt.MulXV(t,this.m_p,n.ComputeDistance_s_center);return bt.SubVV(e,r,i),i.Normalize()-this.m_radius},i.RayCast=function(t,e,i){var o=Rt.MulXV(i,this.m_p,n.RayCast_s_position),a=bt.SubVV(e.p1,o,n.RayCast_s_s),s=bt.DotVV(a,a)-lt(this.m_radius),c=bt.SubVV(e.p2,e.p1,n.RayCast_s_r),l=bt.DotVV(a,c),u=bt.DotVV(c,c),h=l*l-u*s;if(h<0||u<r)return!1;var _=-(l+ht(h));return 0<=_&&_<=e.maxFraction*u&&(_/=u,t.fraction=_,bt.AddVMulSV(a,_,c,t.normal).SelfNormalize(),!0)},i.ComputeAABB=function(t,e){var i=Rt.MulXV(e,this.m_p,n.ComputeAABB_s_p);t.lowerBound.Set(i.x-this.m_radius,i.y-this.m_radius),t.upperBound.Set(i.x+this.m_radius,i.y+this.m_radius)},i.ComputeMass=function(t,e){var n=lt(this.m_radius);t.mass=e*a*n,t.center.Copy(this.m_p),t.I=t.mass*(.5*n+bt.DotVV(this.m_p,this.m_p))},i.SetupDistanceProxy=function(t){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_p),t.m_count=1,t.m_radius=this.m_radius},i.ComputeSubmergedArea=function(t,e,n,i){var o=Rt.MulXV(n,this.m_p,new bt),s=-(bt.DotVV(t,o)-e);if(s<-this.m_radius+r)return 0;if(s>this.m_radius)return i.Copy(o),a*this.m_radius*this.m_radius;var c=this.m_radius*this.m_radius,l=s*s,u=c*(gt(s/this.m_radius)+a/2)+s*ht(c-l),h=-2/3*_t(c-l,1.5)/u;return i.x=o.x+t.x*h,i.y=o.y+t.y*h,u},i.Dump=function(t){t("    const shape: b2CircleShape = new b2CircleShape();\n"),t("    shape.m_radius = %.15f;\n",this.m_radius),t("    shape.m_p.Set(%.15f, %.15f);\n",this.m_p.x,this.m_p.y)},n}(si);ci.TestPoint_s_center=new bt,ci.TestPoint_s_d=new bt,ci.ComputeDistance_s_center=new bt,ci.RayCast_s_position=new bt,ci.RayCast_s_s=new bt,ci.RayCast_s_r=new bt,ci.ComputeAABB_s_p=new bt;var li=function(e){function n(){var n;return(n=e.call(this,t.b2ShapeType.e_polygonShape,f)||this).m_centroid=new bt(0,0),n.m_vertices=[],n.m_normals=[],n.m_count=0,n}Q(n,e);var o=n.prototype;return o.Clone=function(){return(new n).Copy(this)},o.Copy=function(t){e.prototype.Copy.call(this,t),this.m_centroid.Copy(t.m_centroid),this.m_count=t.m_count,this.m_vertices=bt.MakeArray(this.m_count),this.m_normals=bt.MakeArray(this.m_count);for(var n=0;n<this.m_count;++n)this.m_vertices[n].Copy(t.m_vertices[n]),this.m_normals[n].Copy(t.m_normals[n]);return this},o.GetChildCount=function(){return 1},o.Set=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if("number"==typeof e[0][0]){var i=e[0];if(i.length%2!=0)throw new Error;return this._Set((function(t){return{x:i[2*t],y:i[2*t+1]}}),i.length/2)}var r=e[0],o=e[1]||r.length;return this._Set((function(t){return r[t]}),o)},o._Set=function(t,e){if(e<3)return this.SetAsBox(1,1);for(var i=e,r=[],o=0;o<i;++o){for(var a=t(o),s=!0,c=0;c<r.length;++c)if(bt.DistanceSquaredVV(a,r[c])<.25*h*h){s=!1;break}s&&r.push(a)}if((i=r.length)<3)return this.SetAsBox(1,1);for(var l=0,u=r[0].x,_=1;_<i;++_){var f=r[_].x;(f>u||f===u&&r[_].y<r[l].y)&&(l=_,u=f)}for(var p=[],d=0,m=l;;){p[d]=m;for(var v=0,g=1;g<i;++g)if(v!==m){var y=bt.SubVV(r[v],r[p[d]],n.Set_s_r),x=bt.SubVV(r[g],r[p[d]],n.Set_s_v),S=bt.CrossVV(y,x);S<0&&(v=g),0===S&&x.LengthSquared()>y.LengthSquared()&&(v=g)}else v=g;if(++d,m=v,v===l)break}this.m_count=d,this.m_vertices=bt.MakeArray(this.m_count),this.m_normals=bt.MakeArray(this.m_count);for(var C=0;C<d;++C)this.m_vertices[C].Copy(r[p[C]]);for(var A=0;A<d;++A){var b=this.m_vertices[A],T=this.m_vertices[(A+1)%d],E=bt.SubVV(T,b,bt.s_t0);bt.CrossVOne(E,this.m_normals[A]).SelfNormalize()}return n.ComputeCentroid(this.m_vertices,d,this.m_centroid),this},o.SetAsBox=function(t,e,n,i){if(void 0===i&&(i=0),this.m_count=4,this.m_vertices=bt.MakeArray(this.m_count),this.m_normals=bt.MakeArray(this.m_count),this.m_vertices[0].Set(-t,-e),this.m_vertices[1].Set(t,-e),this.m_vertices[2].Set(t,e),this.m_vertices[3].Set(-t,e),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid.SetZero(),n){this.m_centroid.Copy(n);var r=new Rt;r.SetPosition(n),r.SetRotationAngle(i);for(var o=0;o<this.m_count;++o)Rt.MulXV(r,this.m_vertices[o],this.m_vertices[o]),It.MulRV(r.q,this.m_normals[o],this.m_normals[o])}return this},o.TestPoint=function(t,e){for(var i=Rt.MulTXV(t,e,n.TestPoint_s_pLocal),r=0;r<this.m_count;++r)if(bt.DotVV(this.m_normals[r],bt.SubVV(i,this.m_vertices[r],bt.s_t0))>0)return!1;return!0},o.ComputeDistance=function(t,e,r){for(var o=Rt.MulTXV(t,e,n.ComputeDistance_s_pLocal),a=-i,s=n.ComputeDistance_s_normalForMaxDistance.Copy(o),c=0;c<this.m_count;++c){var l=bt.DotVV(this.m_normals[c],bt.SubVV(o,this.m_vertices[c],bt.s_t0));l>a&&(a=l,s.Copy(this.m_normals[c]))}if(a>0){for(var u=n.ComputeDistance_s_minDistance.Copy(s),h=a*a,_=0;_<this.m_count;++_){var f=bt.SubVV(o,this.m_vertices[_],n.ComputeDistance_s_distance),p=f.LengthSquared();h>p&&(u.Copy(f),h=p)}return It.MulRV(t.q,u,r),r.Normalize(),Math.sqrt(h)}return It.MulRV(t.q,s,r),a},o.RayCast=function(t,e,i){for(var r=Rt.MulTXV(i,e.p1,n.RayCast_s_p1),o=Rt.MulTXV(i,e.p2,n.RayCast_s_p2),a=bt.SubVV(o,r,n.RayCast_s_d),s=0,c=e.maxFraction,l=-1,u=0;u<this.m_count;++u){var h=bt.DotVV(this.m_normals[u],bt.SubVV(this.m_vertices[u],r,bt.s_t0)),_=bt.DotVV(this.m_normals[u],a);if(0===_){if(h<0)return!1}else _<0&&h<s*_?(s=h/_,l=u):_>0&&h<c*_&&(c=h/_);if(c<s)return!1}return l>=0&&(t.fraction=s,It.MulRV(i.q,this.m_normals[l],t.normal),!0)},o.ComputeAABB=function(t,e){for(var i=Rt.MulXV(e,this.m_vertices[0],t.lowerBound),r=t.upperBound.Copy(i),o=0;o<this.m_count;++o){var a=Rt.MulXV(e,this.m_vertices[o],n.ComputeAABB_s_v);bt.MinV(a,i,i),bt.MaxV(a,r,r)}var s=this.m_radius;i.SelfSubXY(s,s),r.SelfAddXY(s,s)},o.ComputeMass=function(t,e){for(var i=n.ComputeMass_s_center.SetZero(),r=0,o=0,a=n.ComputeMass_s_s.SetZero(),s=0;s<this.m_count;++s)a.SelfAdd(this.m_vertices[s]);a.SelfMul(1/this.m_count);for(var c=1/3,l=0;l<this.m_count;++l){var u=bt.SubVV(this.m_vertices[l],a,n.ComputeMass_s_e1),h=bt.SubVV(this.m_vertices[(l+1)%this.m_count],a,n.ComputeMass_s_e2),_=bt.CrossVV(u,h),f=.5*_;r+=f,i.SelfAdd(bt.MulSV(f*c,bt.AddVV(u,h,bt.s_t0),bt.s_t1));var p=u.x,d=u.y,m=h.x,v=h.y;o+=.25*c*_*(p*p+m*p+m*m+d*d+v*d+v*v)}t.mass=e*r,i.SelfMul(1/r),bt.AddVV(i,a,t.center),t.I=e*o,t.I+=t.mass*(bt.DotVV(t.center,t.center)-bt.DotVV(i,i))},o.Validate=function(){for(var t=0;t<this.m_count;++t)for(var e=t,i=(t+1)%this.m_count,r=this.m_vertices[e],o=bt.SubVV(this.m_vertices[i],r,n.Validate_s_e),a=0;a<this.m_count;++a)if(a!==e&&a!==i){var s=bt.SubVV(this.m_vertices[a],r,n.Validate_s_v);if(bt.CrossVV(o,s)<0)return!1}return!0},o.SetupDistanceProxy=function(t){t.m_vertices=this.m_vertices,t.m_count=this.m_count,t.m_radius=this.m_radius},o.ComputeSubmergedArea=function(t,e,i,o){for(var a=It.MulTRV(i.q,t,n.ComputeSubmergedArea_s_normalL),s=e-bt.DotVV(t,i.p),c=[],l=0,u=-1,h=-1,_=!1,f=0;f<this.m_count;++f){c[f]=bt.DotVV(a,this.m_vertices[f])-s;var p=c[f]<-r;f>0&&(p?_||(u=f-1,l++):_&&(h=f-1,l++)),_=p}switch(l){case 0:if(_){var d=n.ComputeSubmergedArea_s_md;return this.ComputeMass(d,1),Rt.MulXV(i,d.center,o),d.mass}return 0;case 1:-1===u?u=this.m_count-1:h=this.m_count-1}for(var m,v=(u+1)%this.m_count,g=(h+1)%this.m_count,y=(0-c[u])/(c[v]-c[u]),x=(0-c[h])/(c[g]-c[h]),S=n.ComputeSubmergedArea_s_intoVec.Set(this.m_vertices[u].x*(1-y)+this.m_vertices[v].x*y,this.m_vertices[u].y*(1-y)+this.m_vertices[v].y*y),C=n.ComputeSubmergedArea_s_outoVec.Set(this.m_vertices[h].x*(1-x)+this.m_vertices[g].x*x,this.m_vertices[h].y*(1-x)+this.m_vertices[g].y*x),A=0,b=n.ComputeSubmergedArea_s_center.SetZero(),T=this.m_vertices[v],E=v;E!==g;){m=(E=(E+1)%this.m_count)===g?C:this.m_vertices[E];var w=.5*((T.x-S.x)*(m.y-S.y)-(T.y-S.y)*(m.x-S.x));A+=w,b.x+=w*(S.x+T.x+m.x)/3,b.y+=w*(S.y+T.y+m.y)/3,T=m}return b.SelfMul(1/A),Rt.MulXV(i,b,o),A},o.Dump=function(t){t("    const shape: b2PolygonShape = new b2PolygonShape();\n"),t("    const vs: b2Vec2[] = [];\n");for(var e=0;e<this.m_count;++e)t("    vs[%d] = new b2Vec2(%.15f, %.15f);\n",e,this.m_vertices[e].x,this.m_vertices[e].y);t("    shape.Set(vs, %d);\n",this.m_count)},n.ComputeCentroid=function(t,e,i){var r=i;r.SetZero();for(var o=0,a=n.ComputeCentroid_s_pRef.SetZero(),s=1/3,c=0;c<e;++c){var l=a,u=t[c],h=t[(c+1)%e],_=bt.SubVV(u,l,n.ComputeCentroid_s_e1),f=bt.SubVV(h,l,n.ComputeCentroid_s_e2),p=.5*bt.CrossVV(_,f);o+=p,r.x+=p*s*(l.x+u.x+h.x),r.y+=p*s*(l.y+u.y+h.y)}return r.SelfMul(1/o),r},n}(si);li.Set_s_r=new bt,li.Set_s_v=new bt,li.TestPoint_s_pLocal=new bt,li.ComputeDistance_s_pLocal=new bt,li.ComputeDistance_s_normalForMaxDistance=new bt,li.ComputeDistance_s_minDistance=new bt,li.ComputeDistance_s_distance=new bt,li.RayCast_s_p1=new bt,li.RayCast_s_p2=new bt,li.RayCast_s_d=new bt,li.ComputeAABB_s_v=new bt,li.ComputeMass_s_center=new bt,li.ComputeMass_s_s=new bt,li.ComputeMass_s_e1=new bt,li.ComputeMass_s_e2=new bt,li.Validate_s_e=new bt,li.Validate_s_v=new bt,li.ComputeSubmergedArea_s_normalL=new bt,li.ComputeSubmergedArea_s_md=new ai,li.ComputeSubmergedArea_s_intoVec=new bt,li.ComputeSubmergedArea_s_outoVec=new bt,li.ComputeSubmergedArea_s_center=new bt,li.ComputeCentroid_s_pRef=new bt,li.ComputeCentroid_s_e1=new bt,li.ComputeCentroid_s_e2=new bt;var ui=function(e){function n(){var n;return(n=e.call(this,t.b2ShapeType.e_edgeShape,f)||this).m_vertex1=new bt,n.m_vertex2=new bt,n.m_vertex0=new bt,n.m_vertex3=new bt,n.m_hasVertex0=!1,n.m_hasVertex3=!1,n}Q(n,e);var i=n.prototype;return i.Set=function(t,e){return this.m_vertex1.Copy(t),this.m_vertex2.Copy(e),this.m_hasVertex0=!1,this.m_hasVertex3=!1,this},i.Clone=function(){return(new n).Copy(this)},i.Copy=function(t){return e.prototype.Copy.call(this,t),this.m_vertex1.Copy(t.m_vertex1),this.m_vertex2.Copy(t.m_vertex2),this.m_vertex0.Copy(t.m_vertex0),this.m_vertex3.Copy(t.m_vertex3),this.m_hasVertex0=t.m_hasVertex0,this.m_hasVertex3=t.m_hasVertex3,this},i.GetChildCount=function(){return 1},i.TestPoint=function(){return!1},i.ComputeDistance=function(t,e,i){var r=Rt.MulXV(t,this.m_vertex1,n.ComputeDistance_s_v1),o=Rt.MulXV(t,this.m_vertex2,n.ComputeDistance_s_v2),a=bt.SubVV(e,r,n.ComputeDistance_s_d),s=bt.SubVV(o,r,n.ComputeDistance_s_s),c=bt.DotVV(a,s);if(c>0){var l=bt.DotVV(s,s);c>l?bt.SubVV(e,o,a):a.SelfMulSub(c/l,s)}return i.Copy(a),i.Normalize()},i.RayCast=function(t,e,i){var r=Rt.MulTXV(i,e.p1,n.RayCast_s_p1),o=Rt.MulTXV(i,e.p2,n.RayCast_s_p2),a=bt.SubVV(o,r,n.RayCast_s_d),s=this.m_vertex1,c=this.m_vertex2,l=bt.SubVV(c,s,n.RayCast_s_e),u=t.normal.Set(l.y,-l.x).SelfNormalize(),h=bt.DotVV(u,bt.SubVV(s,r,bt.s_t0)),_=bt.DotVV(u,a);if(0===_)return!1;var f=h/_;if(f<0||e.maxFraction<f)return!1;var p=bt.AddVMulSV(r,f,a,n.RayCast_s_q),d=bt.SubVV(c,s,n.RayCast_s_r),m=bt.DotVV(d,d);if(0===m)return!1;var v=bt.DotVV(bt.SubVV(p,s,bt.s_t0),d)/m;return!(v<0||1<v||(t.fraction=f,It.MulRV(i.q,t.normal,t.normal),h>0&&t.normal.SelfNeg(),0))},i.ComputeAABB=function(t,e){var i=Rt.MulXV(e,this.m_vertex1,n.ComputeAABB_s_v1),r=Rt.MulXV(e,this.m_vertex2,n.ComputeAABB_s_v2);bt.MinV(i,r,t.lowerBound),bt.MaxV(i,r,t.upperBound);var o=this.m_radius;t.lowerBound.SelfSubXY(o,o),t.upperBound.SelfAddXY(o,o)},i.ComputeMass=function(t){t.mass=0,bt.MidVV(this.m_vertex1,this.m_vertex2,t.center),t.I=0},i.SetupDistanceProxy=function(t){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertex1),t.m_vertices[1].Copy(this.m_vertex2),t.m_count=2,t.m_radius=this.m_radius},i.ComputeSubmergedArea=function(t,e,n,i){return i.SetZero(),0},i.Dump=function(t){t("    const shape: b2EdgeShape = new b2EdgeShape();\n"),t("    shape.m_radius = %.15f;\n",this.m_radius),t("    shape.m_vertex0.Set(%.15f, %.15f);\n",this.m_vertex0.x,this.m_vertex0.y),t("    shape.m_vertex1.Set(%.15f, %.15f);\n",this.m_vertex1.x,this.m_vertex1.y),t("    shape.m_vertex2.Set(%.15f, %.15f);\n",this.m_vertex2.x,this.m_vertex2.y),t("    shape.m_vertex3.Set(%.15f, %.15f);\n",this.m_vertex3.x,this.m_vertex3.y),t("    shape.m_hasVertex0 = %s;\n",this.m_hasVertex0),t("    shape.m_hasVertex3 = %s;\n",this.m_hasVertex3)},n}(si);ui.ComputeDistance_s_v1=new bt,ui.ComputeDistance_s_v2=new bt,ui.ComputeDistance_s_d=new bt,ui.ComputeDistance_s_s=new bt,ui.RayCast_s_p1=new bt,ui.RayCast_s_p2=new bt,ui.RayCast_s_d=new bt,ui.RayCast_s_e=new bt,ui.RayCast_s_q=new bt,ui.RayCast_s_r=new bt,ui.ComputeAABB_s_v1=new bt,ui.ComputeAABB_s_v2=new bt;var hi=function(e){function n(){var n;return(n=e.call(this,t.b2ShapeType.e_chainShape,f)||this).m_vertices=[],n.m_count=0,n.m_prevVertex=new bt,n.m_nextVertex=new bt,n.m_hasPrevVertex=!1,n.m_hasNextVertex=!1,n}Q(n,e);var i=n.prototype;return i.CreateLoop=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if("number"==typeof e[0][0]){var i=e[0];if(i.length%2!=0)throw new Error;return this._CreateLoop((function(t){return{x:i[2*t],y:i[2*t+1]}}),i.length/2)}var r=e[0],o=e[1]||r.length;return this._CreateLoop((function(t){return r[t]}),o)},i._CreateLoop=function(t,e){if(e<3)return this;this.m_count=e+1,this.m_vertices=bt.MakeArray(this.m_count);for(var n=0;n<e;++n)this.m_vertices[n].Copy(t(n));return this.m_vertices[e].Copy(this.m_vertices[0]),this.m_prevVertex.Copy(this.m_vertices[this.m_count-2]),this.m_nextVertex.Copy(this.m_vertices[1]),this.m_hasPrevVertex=!0,this.m_hasNextVertex=!0,this},i.CreateChain=function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];if("number"==typeof e[0][0]){var i=e[0];if(i.length%2!=0)throw new Error;return this._CreateChain((function(t){return{x:i[2*t],y:i[2*t+1]}}),i.length/2)}var r=e[0],o=e[1]||r.length;return this._CreateChain((function(t){return r[t]}),o)},i._CreateChain=function(t,e){this.m_count=e,this.m_vertices=bt.MakeArray(e);for(var n=0;n<e;++n)this.m_vertices[n].Copy(t(n));return this.m_hasPrevVertex=!1,this.m_hasNextVertex=!1,this.m_prevVertex.SetZero(),this.m_nextVertex.SetZero(),this},i.SetPrevVertex=function(t){return this.m_prevVertex.Copy(t),this.m_hasPrevVertex=!0,this},i.SetNextVertex=function(t){return this.m_nextVertex.Copy(t),this.m_hasNextVertex=!0,this},i.Clone=function(){return(new n).Copy(this)},i.Copy=function(t){return e.prototype.Copy.call(this,t),this._CreateChain((function(e){return t.m_vertices[e]}),t.m_count),this.m_prevVertex.Copy(t.m_prevVertex),this.m_nextVertex.Copy(t.m_nextVertex),this.m_hasPrevVertex=t.m_hasPrevVertex,this.m_hasNextVertex=t.m_hasNextVertex,this},i.GetChildCount=function(){return this.m_count-1},i.GetChildEdge=function(t,e){t.m_radius=this.m_radius,t.m_vertex1.Copy(this.m_vertices[e]),t.m_vertex2.Copy(this.m_vertices[e+1]),e>0?(t.m_vertex0.Copy(this.m_vertices[e-1]),t.m_hasVertex0=!0):(t.m_vertex0.Copy(this.m_prevVertex),t.m_hasVertex0=this.m_hasPrevVertex),e<this.m_count-2?(t.m_vertex3.Copy(this.m_vertices[e+2]),t.m_hasVertex3=!0):(t.m_vertex3.Copy(this.m_nextVertex),t.m_hasVertex3=this.m_hasNextVertex)},i.TestPoint=function(){return!1},i.ComputeDistance=function(t,e,i,r){var o=n.ComputeDistance_s_edgeShape;return this.GetChildEdge(o,r),o.ComputeDistance(t,e,i,0)},i.RayCast=function(t,e,i,r){var o=n.RayCast_s_edgeShape;return o.m_vertex1.Copy(this.m_vertices[r]),o.m_vertex2.Copy(this.m_vertices[(r+1)%this.m_count]),o.RayCast(t,e,i,0)},i.ComputeAABB=function(t,e,i){var r=this.m_vertices[i],o=this.m_vertices[(i+1)%this.m_count],a=Rt.MulXV(e,r,n.ComputeAABB_s_v1),s=Rt.MulXV(e,o,n.ComputeAABB_s_v2);bt.MinV(a,s,t.lowerBound),bt.MaxV(a,s,t.upperBound)},i.ComputeMass=function(t){t.mass=0,t.center.SetZero(),t.I=0},i.SetupDistanceProxy=function(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertices[e]),e+1<this.m_count?t.m_vertices[1].Copy(this.m_vertices[e+1]):t.m_vertices[1].Copy(this.m_vertices[0]),t.m_count=2,t.m_radius=this.m_radius},i.ComputeSubmergedArea=function(t,e,n,i){return i.SetZero(),0},i.Dump=function(t){t("    const shape: b2ChainShape = new b2ChainShape();\n"),t("    const vs: b2Vec2[] = [];\n");for(var e=0;e<this.m_count;++e)t("    vs[%d] = new bVec2(%.15f, %.15f);\n",e,this.m_vertices[e].x,this.m_vertices[e].y);t("    shape.CreateChain(vs, %d);\n",this.m_count),t("    shape.m_prevVertex.Set(%.15f, %.15f);\n",this.m_prevVertex.x,this.m_prevVertex.y),t("    shape.m_nextVertex.Set(%.15f, %.15f);\n",this.m_nextVertex.x,this.m_nextVertex.y),t("    shape.m_hasPrevVertex = %s;\n",this.m_hasPrevVertex?"true":"false"),t("    shape.m_hasNextVertex = %s;\n",this.m_hasNextVertex?"true":"false")},n}(si);hi.ComputeDistance_s_edgeShape=new ui,hi.RayCast_s_edgeShape=new ui,hi.ComputeAABB_s_v1=new bt,hi.ComputeAABB_s_v2=new bt;var _i=function(){function t(){this.categoryBits=1,this.maskBits=65535,this.groupIndex=0}var e=t.prototype;return e.Clone=function(){return(new t).Copy(this)},e.Copy=function(t){return this.categoryBits=t.categoryBits,this.maskBits=t.maskBits,this.groupIndex=t.groupIndex||0,this},t}();_i.DEFAULT=new _i;var fi=function(){this.userData=null,this.friction=.2,this.restitution=0,this.density=0,this.isSensor=!1,this.filter=new _i},pi=function(){function t(t,e){this.aabb=new Te,this.childIndex=0,this.fixture=t,this.childIndex=e,this.fixture.m_shape.ComputeAABB(this.aabb,this.fixture.m_body.GetTransform(),e),this.treeNode=this.fixture.m_body.m_world.m_contactManager.m_broadPhase.CreateProxy(this.aabb,this)}var e=t.prototype;return e.Reset=function(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.DestroyProxy(this.treeNode)},e.Touch=function(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.TouchProxy(this.treeNode)},e.Synchronize=function(e,n,i){if(e===n)this.fixture.m_shape.ComputeAABB(this.aabb,e,this.childIndex),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,i);else{var r=t.Synchronize_s_aabb1,o=t.Synchronize_s_aabb2;this.fixture.m_shape.ComputeAABB(r,e,this.childIndex),this.fixture.m_shape.ComputeAABB(o,n,this.childIndex),this.aabb.Combine2(r,o),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,i)}},t}();pi.Synchronize_s_aabb1=new Te,pi.Synchronize_s_aabb2=new Te;var di,mi=function(){function t(t,e){this.m_density=0,this.m_next=null,this.m_friction=0,this.m_restitution=0,this.m_proxies=[],this.m_filter=new _i,this.m_isSensor=!1,this.m_userData=null,this.m_body=t,this.m_shape=e.shape.Clone(),this.m_userData=n(e.userData,null),this.m_friction=n(e.friction,.2),this.m_restitution=n(e.restitution,0),this.m_filter.Copy(n(e.filter,_i.DEFAULT)),this.m_isSensor=n(e.isSensor,!1),this.m_density=n(e.density,0)}var e=t.prototype;return e.Reset=function(){},e.GetType=function(){return this.m_shape.GetType()},e.GetShape=function(){return this.m_shape},e.SetSensor=function(t){t!==this.m_isSensor&&(this.m_body.SetAwake(!0),this.m_isSensor=t)},e.IsSensor=function(){return this.m_isSensor},e.SetFilterData=function(t){this.m_filter.Copy(t),this.Refilter()},e.GetFilterData=function(){return this.m_filter},e.Refilter=function(){for(var t=this.m_body.GetContactList();t;){var e=t.contact,n=e.GetFixtureA(),i=e.GetFixtureB();n!==this&&i!==this||e.FlagForFiltering(),t=t.next}this.TouchProxies()},e.GetBody=function(){return this.m_body},e.GetNext=function(){return this.m_next},e.GetUserData=function(){return this.m_userData},e.SetUserData=function(t){this.m_userData=t},e.TestPoint=function(t){return this.m_shape.TestPoint(this.m_body.GetTransform(),t)},e.ComputeDistance=function(t,e,n){return this.m_shape.ComputeDistance(this.m_body.GetTransform(),t,e,n)},e.RayCast=function(t,e,n){return this.m_shape.RayCast(t,e,this.m_body.GetTransform(),n)},e.GetMassData=function(t){return void 0===t&&(t=new ai),this.m_shape.ComputeMass(t,this.m_density),t},e.SetDensity=function(t){this.m_density=t},e.GetDensity=function(){return this.m_density},e.GetFriction=function(){return this.m_friction},e.SetFriction=function(t){this.m_friction=t},e.GetRestitution=function(){return this.m_restitution},e.SetRestitution=function(t){this.m_restitution=t},e.GetAABB=function(t){return this.m_proxies[t].aabb},e.Dump=function(t,e){t("    const fd: b2FixtureDef = new b2FixtureDef();\n"),t("    fd.friction = %.15f;\n",this.m_friction),t("    fd.restitution = %.15f;\n",this.m_restitution),t("    fd.density = %.15f;\n",this.m_density),t("    fd.isSensor = %s;\n",this.m_isSensor?"true":"false"),t("    fd.filter.categoryBits = %d;\n",this.m_filter.categoryBits),t("    fd.filter.maskBits = %d;\n",this.m_filter.maskBits),t("    fd.filter.groupIndex = %d;\n",this.m_filter.groupIndex),this.m_shape.Dump(t),t("\n"),t("    fd.shape = shape;\n"),t("\n"),t("    bodies[%d].CreateFixture(fd);\n",e)},e.CreateProxies=function(){if(0!==this.m_proxies.length)throw new Error;for(var t=0;t<this.m_shape.GetChildCount();++t)this.m_proxies[t]=new pi(this,t)},e.DestroyProxies=function(){for(var t,e=ot(this.m_proxies);!(t=e()).done;)t.value.Reset();this.m_proxies.length=0},e.TouchProxies=function(){for(var t,e=ot(this.m_proxies);!(t=e()).done;)t.value.Touch()},e.SynchronizeProxies=function(t,e,n){for(var i,r=ot(this.m_proxies);!(i=r()).done;)i.value.Synchronize(t,e,n)},K(t,[{key:"m_proxyCount",get:function(){return this.m_proxies.length}}]),t}();(di=t.b2BodyType||(t.b2BodyType={}))[di.b2_unknown=-1]="b2_unknown",di[di.b2_staticBody=0]="b2_staticBody",di[di.b2_kinematicBody=1]="b2_kinematicBody",di[di.b2_dynamicBody=2]="b2_dynamicBody";var vi,gi,yi=function(){this.type=t.b2BodyType.b2_staticBody,this.position=new bt(0,0),this.angle=0,this.linearVelocity=new bt(0,0),this.angularVelocity=0,this.linearDamping=0,this.angularDamping=0,this.allowSleep=!0,this.awake=!0,this.fixedRotation=!1,this.bullet=!1,this.active=!0,this.userData=null,this.gravityScale=1},xi=function(){function e(e,i){this.m_type=t.b2BodyType.b2_staticBody,this.m_islandFlag=!1,this.m_awakeFlag=!1,this.m_autoSleepFlag=!1,this.m_bulletFlag=!1,this.m_fixedRotationFlag=!1,this.m_activeFlag=!1,this.m_toiFlag=!1,this.m_islandIndex=0,this.m_xf=new Rt,this.m_xf0=new Rt,this.m_sweep=new Bt,this.m_linearVelocity=new bt,this.m_angularVelocity=0,this.m_force=new bt,this.m_torque=0,this.m_prev=null,this.m_next=null,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_jointList=null,this.m_contactList=null,this.m_mass=1,this.m_invMass=1,this.m_I=0,this.m_invI=0,this.m_linearDamping=0,this.m_angularDamping=0,this.m_gravityScale=1,this.m_sleepTime=0,this.m_userData=null,this.m_controllerList=null,this.m_controllerCount=0,this.m_bulletFlag=n(e.bullet,!1),this.m_fixedRotationFlag=n(e.fixedRotation,!1),this.m_autoSleepFlag=n(e.allowSleep,!0),this.m_awakeFlag=n(e.awake,!0),this.m_activeFlag=n(e.active,!0),this.m_world=i,this.m_xf.p.Copy(n(e.position,bt.ZERO)),this.m_xf.q.SetAngle(n(e.angle,0)),this.m_xf0.Copy(this.m_xf),this.m_sweep.localCenter.SetZero(),this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),this.m_sweep.a0=this.m_sweep.a=this.m_xf.q.GetAngle(),this.m_sweep.alpha0=0,this.m_linearVelocity.Copy(n(e.linearVelocity,bt.ZERO)),this.m_angularVelocity=n(e.angularVelocity,0),this.m_linearDamping=n(e.linearDamping,0),this.m_angularDamping=n(e.angularDamping,0),this.m_gravityScale=n(e.gravityScale,1),this.m_force.SetZero(),this.m_torque=0,this.m_sleepTime=0,this.m_type=n(e.type,t.b2BodyType.b2_staticBody),e.type===t.b2BodyType.b2_dynamicBody?(this.m_mass=1,this.m_invMass=1):(this.m_mass=0,this.m_invMass=0),this.m_I=0,this.m_invI=0,this.m_userData=e.userData,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_controllerList=null,this.m_controllerCount=0}var i=e.prototype;return i.CreateFixture=function(t,e){return void 0===e&&(e=0),t instanceof si?this.CreateFixtureShapeDensity(t,e):this.CreateFixtureDef(t)},i.CreateFixtureDef=function(t){if(this.m_world.IsLocked())throw new Error;var e=new mi(this,t);return this.m_activeFlag&&e.CreateProxies(),e.m_next=this.m_fixtureList,this.m_fixtureList=e,++this.m_fixtureCount,e.m_density>0&&this.ResetMassData(),this.m_world.m_newFixture=!0,e},i.CreateFixtureShapeDensity=function(t,n){void 0===n&&(n=0);var i=e.CreateFixtureShapeDensity_s_def;return i.shape=t,i.density=n,this.CreateFixtureDef(i)},i.DestroyFixture=function(t){if(this.m_world.IsLocked())throw new Error;for(var e=this.m_fixtureList,n=null;null!==e;){if(e===t){n?n.m_next=t.m_next:this.m_fixtureList=t.m_next;break}n=e,e=e.m_next}for(var i=this.m_contactList;i;){var r=i.contact;i=i.next;var o=r.GetFixtureA(),a=r.GetFixtureB();t!==o&&t!==a||this.m_world.m_contactManager.Destroy(r)}this.m_activeFlag&&t.DestroyProxies(),t.m_next=null,t.Reset(),--this.m_fixtureCount,this.ResetMassData()},i.SetTransformVec=function(t,e){this.SetTransformXY(t.x,t.y,e)},i.SetTransformXY=function(t,e,n){if(this.m_world.IsLocked())throw new Error;this.m_xf.q.SetAngle(n),this.m_xf.p.Set(t,e),this.m_xf0.Copy(this.m_xf),Rt.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.a=n,this.m_sweep.c0.Copy(this.m_sweep.c),this.m_sweep.a0=n;for(var i=this.m_fixtureList;i;i=i.m_next)i.SynchronizeProxies(this.m_xf,this.m_xf,bt.ZERO);this.m_world.m_contactManager.FindNewContacts()},i.SetTransform=function(t){this.SetTransformVec(t.p,t.GetAngle())},i.GetTransform=function(){return this.m_xf},i.GetPosition=function(){return this.m_xf.p},i.SetPosition=function(t){this.SetTransformVec(t,this.GetAngle())},i.SetPositionXY=function(t,e){this.SetTransformXY(t,e,this.GetAngle())},i.GetAngle=function(){return this.m_sweep.a},i.SetAngle=function(t){this.SetTransformVec(this.GetPosition(),t)},i.GetWorldCenter=function(){return this.m_sweep.c},i.GetLocalCenter=function(){return this.m_sweep.localCenter},i.SetLinearVelocity=function(e){this.m_type!==t.b2BodyType.b2_staticBody&&(bt.DotVV(e,e)>0&&this.SetAwake(!0),this.m_linearVelocity.Copy(e))},i.GetLinearVelocity=function(){return this.m_linearVelocity},i.SetAngularVelocity=function(e){this.m_type!==t.b2BodyType.b2_staticBody&&(e*e>0&&this.SetAwake(!0),this.m_angularVelocity=e)},i.GetAngularVelocity=function(){return this.m_angularVelocity},i.GetDefinition=function(t){return t.type=this.GetType(),t.allowSleep=this.m_autoSleepFlag,t.angle=this.GetAngle(),t.angularDamping=this.m_angularDamping,t.gravityScale=this.m_gravityScale,t.angularVelocity=this.m_angularVelocity,t.fixedRotation=this.m_fixedRotationFlag,t.bullet=this.m_bulletFlag,t.awake=this.m_awakeFlag,t.linearDamping=this.m_linearDamping,t.linearVelocity.Copy(this.GetLinearVelocity()),t.position.Copy(this.GetPosition()),t.userData=this.GetUserData(),t},i.ApplyForce=function(e,n,i){void 0===i&&(i=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=e.x,this.m_force.y+=e.y,this.m_torque+=(n.x-this.m_sweep.c.x)*e.y-(n.y-this.m_sweep.c.y)*e.x))},i.ApplyForceToCenter=function(e,n){void 0===n&&(n=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=e.x,this.m_force.y+=e.y))},i.ApplyTorque=function(e,n){void 0===n&&(n=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_torque+=e))},i.ApplyLinearImpulse=function(e,n,i){void 0===i&&(i=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*e.x,this.m_linearVelocity.y+=this.m_invMass*e.y,this.m_angularVelocity+=this.m_invI*((n.x-this.m_sweep.c.x)*e.y-(n.y-this.m_sweep.c.y)*e.x)))},i.ApplyLinearImpulseToCenter=function(e,n){void 0===n&&(n=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*e.x,this.m_linearVelocity.y+=this.m_invMass*e.y))},i.ApplyAngularImpulse=function(e,n){void 0===n&&(n=!0),this.m_type===t.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_angularVelocity+=this.m_invI*e))},i.GetMass=function(){return this.m_mass},i.GetInertia=function(){return this.m_I+this.m_mass*bt.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter)},i.GetMassData=function(t){return t.mass=this.m_mass,t.I=this.m_I+this.m_mass*bt.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter),t.center.Copy(this.m_sweep.localCenter),t},i.SetMassData=function(n){if(this.m_world.IsLocked())throw new Error;if(this.m_type===t.b2BodyType.b2_dynamicBody){this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=n.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,n.I>0&&!this.m_fixedRotationFlag&&(this.m_I=n.I-this.m_mass*bt.DotVV(n.center,n.center),this.m_invI=1/this.m_I);var i=e.SetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(n.center),Rt.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),bt.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,bt.SubVV(this.m_sweep.c,i,bt.s_t0),this.m_linearVelocity)}},i.ResetMassData=function(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_sweep.localCenter.SetZero(),this.m_type===t.b2BodyType.b2_staticBody||this.m_type===t.b2BodyType.b2_kinematicBody)return this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),void(this.m_sweep.a0=this.m_sweep.a);for(var n=e.ResetMassData_s_localCenter.SetZero(),i=this.m_fixtureList;i;i=i.m_next)if(0!==i.m_density){var r=i.GetMassData(e.ResetMassData_s_massData);this.m_mass+=r.mass,n.x+=r.center.x*r.mass,n.y+=r.center.y*r.mass,this.m_I+=r.I}this.m_mass>0?(this.m_invMass=1/this.m_mass,n.x*=this.m_invMass,n.y*=this.m_invMass):(this.m_mass=1,this.m_invMass=1),this.m_I>0&&!this.m_fixedRotationFlag?(this.m_I-=this.m_mass*bt.DotVV(n,n),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0);var o=e.ResetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(n),Rt.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),bt.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,bt.SubVV(this.m_sweep.c,o,bt.s_t0),this.m_linearVelocity)},i.GetWorldPoint=function(t,e){return Rt.MulXV(this.m_xf,t,e)},i.GetWorldVector=function(t,e){return It.MulRV(this.m_xf.q,t,e)},i.GetLocalPoint=function(t,e){return Rt.MulTXV(this.m_xf,t,e)},i.GetLocalVector=function(t,e){return It.MulTRV(this.m_xf.q,t,e)},i.GetLinearVelocityFromWorldPoint=function(t,e){return bt.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,bt.SubVV(t,this.m_sweep.c,bt.s_t0),e)},i.GetLinearVelocityFromLocalPoint=function(t,e){return this.GetLinearVelocityFromWorldPoint(this.GetWorldPoint(t,e),e)},i.GetLinearDamping=function(){return this.m_linearDamping},i.SetLinearDamping=function(t){this.m_linearDamping=t},i.GetAngularDamping=function(){return this.m_angularDamping},i.SetAngularDamping=function(t){this.m_angularDamping=t},i.GetGravityScale=function(){return this.m_gravityScale},i.SetGravityScale=function(t){this.m_gravityScale=t},i.SetType=function(e){if(this.m_world.IsLocked())throw new Error;if(this.m_type!==e){this.m_type=e,this.ResetMassData(),this.m_type===t.b2BodyType.b2_staticBody&&(this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_sweep.a0=this.m_sweep.a,this.m_sweep.c0.Copy(this.m_sweep.c),this.SynchronizeFixtures()),this.SetAwake(!0),this.m_force.SetZero(),this.m_torque=0;for(var n=this.m_contactList;n;){var i=n;n=n.next,this.m_world.m_contactManager.Destroy(i.contact)}this.m_contactList=null;for(var r=this.m_fixtureList;r;r=r.m_next)r.TouchProxies()}},i.GetType=function(){return this.m_type},i.SetBullet=function(t){this.m_bulletFlag=t},i.IsBullet=function(){return this.m_bulletFlag},i.SetSleepingAllowed=function(t){this.m_autoSleepFlag=t,t||this.SetAwake(!0)},i.IsSleepingAllowed=function(){return this.m_autoSleepFlag},i.SetAwake=function(t){t?(this.m_awakeFlag=!0,this.m_sleepTime=0):(this.m_awakeFlag=!1,this.m_sleepTime=0,this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_force.SetZero(),this.m_torque=0)},i.IsAwake=function(){return this.m_awakeFlag},i.SetActive=function(t){if(this.m_world.IsLocked())throw new Error;if(t!==this.IsActive())if(this.m_activeFlag=t,t)for(var e=this.m_fixtureList;e;e=e.m_next)e.CreateProxies();else{for(var n=this.m_fixtureList;n;n=n.m_next)n.DestroyProxies();for(var i=this.m_contactList;i;){var r=i;i=i.next,this.m_world.m_contactManager.Destroy(r.contact)}this.m_contactList=null}},i.IsActive=function(){return this.m_activeFlag},i.SetFixedRotation=function(t){this.m_fixedRotationFlag!==t&&(this.m_fixedRotationFlag=t,this.m_angularVelocity=0,this.ResetMassData())},i.IsFixedRotation=function(){return this.m_fixedRotationFlag},i.GetFixtureList=function(){return this.m_fixtureList},i.GetJointList=function(){return this.m_jointList},i.GetContactList=function(){return this.m_contactList},i.GetNext=function(){return this.m_next},i.GetUserData=function(){return this.m_userData},i.SetUserData=function(t){this.m_userData=t},i.GetWorld=function(){return this.m_world},i.Dump=function(e){var n=this.m_islandIndex;e("{\n"),e("  const bd: b2BodyDef = new b2BodyDef();\n");var i="";switch(this.m_type){case t.b2BodyType.b2_staticBody:i="b2BodyType.b2_staticBody";break;case t.b2BodyType.b2_kinematicBody:i="b2BodyType.b2_kinematicBody";break;case t.b2BodyType.b2_dynamicBody:i="b2BodyType.b2_dynamicBody"}e("  bd.type = %s;\n",i),e("  bd.position.Set(%.15f, %.15f);\n",this.m_xf.p.x,this.m_xf.p.y),e("  bd.angle = %.15f;\n",this.m_sweep.a),e("  bd.linearVelocity.Set(%.15f, %.15f);\n",this.m_linearVelocity.x,this.m_linearVelocity.y),e("  bd.angularVelocity = %.15f;\n",this.m_angularVelocity),e("  bd.linearDamping = %.15f;\n",this.m_linearDamping),e("  bd.angularDamping = %.15f;\n",this.m_angularDamping),e("  bd.allowSleep = %s;\n",this.m_autoSleepFlag?"true":"false"),e("  bd.awake = %s;\n",this.m_awakeFlag?"true":"false"),e("  bd.fixedRotation = %s;\n",this.m_fixedRotationFlag?"true":"false"),e("  bd.bullet = %s;\n",this.m_bulletFlag?"true":"false"),e("  bd.active = %s;\n",this.m_activeFlag?"true":"false"),e("  bd.gravityScale = %.15f;\n",this.m_gravityScale),e("\n"),e("  bodies[%d] = this.m_world.CreateBody(bd);\n",this.m_islandIndex),e("\n");for(var r=this.m_fixtureList;r;r=r.m_next)e("  {\n"),r.Dump(e,n),e("  }\n");e("}\n")},i.SynchronizeFixtures=function(){var t=e.SynchronizeFixtures_s_xf1;t.q.SetAngle(this.m_sweep.a0),It.MulRV(t.q,this.m_sweep.localCenter,t.p),bt.SubVV(this.m_sweep.c0,t.p,t.p);for(var n=bt.SubVV(this.m_sweep.c,this.m_sweep.c0,e.SynchronizeFixtures_s_displacement),i=this.m_fixtureList;i;i=i.m_next)i.SynchronizeProxies(t,this.m_xf,n)},i.SynchronizeTransform=function(){this.m_xf.q.SetAngle(this.m_sweep.a),It.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),bt.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)},i.ShouldCollide=function(e){return(this.m_type!==t.b2BodyType.b2_staticBody||e.m_type!==t.b2BodyType.b2_staticBody)&&this.ShouldCollideConnected(e)},i.ShouldCollideConnected=function(t){for(var e=this.m_jointList;e;e=e.next)if(e.other===t&&!e.joint.m_collideConnected)return!1;return!0},i.Advance=function(t){this.m_sweep.Advance(t),this.m_sweep.c.Copy(this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.m_xf.q.SetAngle(this.m_sweep.a),It.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),bt.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)},i.GetControllerList=function(){return this.m_controllerList},i.GetControllerCount=function(){return this.m_controllerCount},e}();xi.CreateFixtureShapeDensity_s_def=new fi,xi.SetMassData_s_oldCenter=new bt,xi.ResetMassData_s_localCenter=new bt,xi.ResetMassData_s_oldCenter=new bt,xi.ResetMassData_s_massData=new ai,xi.SynchronizeFixtures_s_xf1=new Rt,xi.SynchronizeFixtures_s_displacement=new bt,(gi=t.b2JointType||(t.b2JointType={}))[gi.e_unknownJoint=0]="e_unknownJoint",gi[gi.e_revoluteJoint=1]="e_revoluteJoint",gi[gi.e_prismaticJoint=2]="e_prismaticJoint",gi[gi.e_distanceJoint=3]="e_distanceJoint",gi[gi.e_pulleyJoint=4]="e_pulleyJoint",gi[gi.e_mouseJoint=5]="e_mouseJoint",gi[gi.e_gearJoint=6]="e_gearJoint",gi[gi.e_wheelJoint=7]="e_wheelJoint",gi[gi.e_weldJoint=8]="e_weldJoint",gi[gi.e_frictionJoint=9]="e_frictionJoint",gi[gi.e_ropeJoint=10]="e_ropeJoint",gi[gi.e_motorJoint=11]="e_motorJoint",gi[gi.e_areaJoint=12]="e_areaJoint",(vi=t.b2LimitState||(t.b2LimitState={}))[vi.e_inactiveLimit=0]="e_inactiveLimit",vi[vi.e_atLowerLimit=1]="e_atLowerLimit",vi[vi.e_atUpperLimit=2]="e_atUpperLimit",vi[vi.e_equalLimits=3]="e_equalLimits";var Si=function(){function t(){this.linear=new bt,this.angularA=0,this.angularB=0}var e=t.prototype;return e.SetZero=function(){return this.linear.SetZero(),this.angularA=0,this.angularB=0,this},e.Set=function(t,e,n){return this.linear.Copy(t),this.angularA=e,this.angularB=n,this},t}(),Ci=function(){function t(t){this._other=null,this.prev=null,this.next=null,this.joint=t}return t.prototype.Reset=function(){this._other=null,this.prev=null,this.next=null},K(t,[{key:"other",get:function(){if(null===this._other)throw new Error;return this._other},set:function(t){if(null!==this._other)throw new Error;this._other=t}}]),t}(),Ai=function(e){this.type=t.b2JointType.e_unknownJoint,this.userData=null,this.collideConnected=!1,this.type=e},bi=function(){function e(e){this.m_type=t.b2JointType.e_unknownJoint,this.m_prev=null,this.m_next=null,this.m_edgeA=new Ci(this),this.m_edgeB=new Ci(this),this.m_index=0,this.m_islandFlag=!1,this.m_collideConnected=!1,this.m_userData=null,this.m_type=e.type,this.m_edgeA.other=e.bodyB,this.m_edgeB.other=e.bodyA,this.m_bodyA=e.bodyA,this.m_bodyB=e.bodyB,this.m_collideConnected=n(e.collideConnected,!1),this.m_userData=n(e.userData,null)}var i=e.prototype;return i.GetType=function(){return this.m_type},i.GetBodyA=function(){return this.m_bodyA},i.GetBodyB=function(){return this.m_bodyB},i.GetNext=function(){return this.m_next},i.GetUserData=function(){return this.m_userData},i.SetUserData=function(t){this.m_userData=t},i.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()},i.GetCollideConnected=function(){return this.m_collideConnected},i.Dump=function(t){t("// Dump is not supported for this joint type.\n")},i.ShiftOrigin=function(){},e}(),Ti=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_distanceJoint)||this).localAnchorA=new bt,n.localAnchorB=new bt,n.length=1,n.frequencyHz=0,n.dampingRatio=0,n}return Q(n,e),n.prototype.Initialize=function(t,e,n,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.length=bt.DistanceVV(n,i),this.frequencyHz=0,this.dampingRatio=0},n}(Ai),Ei=function(t){function e(e){var i;return(i=t.call(this,e)||this).m_frequencyHz=0,i.m_dampingRatio=0,i.m_bias=0,i.m_localAnchorA=new bt,i.m_localAnchorB=new bt,i.m_gamma=0,i.m_impulse=0,i.m_length=0,i.m_indexA=0,i.m_indexB=0,i.m_u=new bt,i.m_rA=new bt,i.m_rB=new bt,i.m_localCenterA=new bt,i.m_localCenterB=new bt,i.m_invMassA=0,i.m_invMassB=0,i.m_invIA=0,i.m_invIB=0,i.m_mass=0,i.m_qA=new It,i.m_qB=new It,i.m_lalcA=new bt,i.m_lalcB=new bt,i.m_frequencyHz=n(e.frequencyHz,0),i.m_dampingRatio=n(e.dampingRatio,0),i.m_localAnchorA.Copy(e.localAnchorA),i.m_localAnchorB.Copy(e.localAnchorB),i.m_length=e.length,i}Q(e,t);var i=e.prototype;return i.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},i.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},i.GetReactionForce=function(t,e){return e.x=t*this.m_impulse*this.m_u.x,e.y=t*this.m_impulse*this.m_u.y,e},i.GetReactionTorque=function(){return 0},i.GetLocalAnchorA=function(){return this.m_localAnchorA},i.GetLocalAnchorB=function(){return this.m_localAnchorB},i.SetLength=function(t){this.m_length=t},i.Length=function(){return this.m_length},i.SetFrequency=function(t){this.m_frequencyHz=t},i.GetFrequency=function(){return this.m_frequencyHz},i.SetDampingRatio=function(t){this.m_dampingRatio=t},i.GetDampingRatio=function(){return this.m_dampingRatio},i.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2DistanceJointDef = new b2DistanceJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.length = %.15f;\n",this.m_length),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,r=t.velocities[this.m_indexA].v,o=t.velocities[this.m_indexA].w,s=t.positions[this.m_indexB].c,c=t.positions[this.m_indexB].a,l=t.velocities[this.m_indexB].v,u=t.velocities[this.m_indexB].w,_=this.m_qA.SetAngle(i),f=this.m_qB.SetAngle(c);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),It.MulRV(_,this.m_lalcA,this.m_rA),bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),It.MulRV(f,this.m_lalcB,this.m_rB),this.m_u.x=s.x+this.m_rB.x-n.x-this.m_rA.x,this.m_u.y=s.y+this.m_rB.y-n.y-this.m_rA.y;var p=this.m_u.Length();p>h?this.m_u.SelfMul(1/p):this.m_u.SetZero();var d=bt.CrossVV(this.m_rA,this.m_u),m=bt.CrossVV(this.m_rB,this.m_u),v=this.m_invMassA+this.m_invIA*d*d+this.m_invMassB+this.m_invIB*m*m;if(this.m_mass=0!==v?1/v:0,this.m_frequencyHz>0){var g=p-this.m_length,y=2*a*this.m_frequencyHz,x=2*this.m_mass*this.m_dampingRatio*y,S=this.m_mass*y*y,C=t.step.dt;this.m_gamma=C*(x+C*S),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=g*C*S*this.m_gamma,v+=this.m_gamma,this.m_mass=0!==v?1/v:0}else this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;var A=bt.MulSV(this.m_impulse,this.m_u,e.InitVelocityConstraints_s_P);r.SelfMulSub(this.m_invMassA,A),o-=this.m_invIA*bt.CrossVV(this.m_rA,A),l.SelfMulAdd(this.m_invMassB,A),u+=this.m_invIB*bt.CrossVV(this.m_rB,A)}else this.m_impulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=u},i.SolveVelocityConstraints=function(t){var n=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,a=bt.AddVCrossSV(n,i,this.m_rA,e.SolveVelocityConstraints_s_vpA),s=bt.AddVCrossSV(r,o,this.m_rB,e.SolveVelocityConstraints_s_vpB),c=bt.DotVV(this.m_u,bt.SubVV(s,a,bt.s_t0)),l=-this.m_mass*(c+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=l;var u=bt.MulSV(l,this.m_u,e.SolveVelocityConstraints_s_P);n.SelfMulSub(this.m_invMassA,u),i-=this.m_invIA*bt.CrossVV(this.m_rA,u),r.SelfMulAdd(this.m_invMassB,u),o+=this.m_invIB*bt.CrossVV(this.m_rB,u),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o},i.SolvePositionConstraints=function(t){if(this.m_frequencyHz>0)return!0;var n=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=this.m_qA.SetAngle(i),s=this.m_qB.SetAngle(o),c=It.MulRV(a,this.m_lalcA,this.m_rA),l=It.MulRV(s,this.m_lalcB,this.m_rB),u=this.m_u;u.x=r.x+l.x-n.x-c.x,u.y=r.y+l.y-n.y-c.y;var _=this.m_u.Normalize()-this.m_length;_=at(_,-v,v);var f=-this.m_mass*_,p=bt.MulSV(f,u,e.SolvePositionConstraints_s_P);return n.SelfMulSub(this.m_invMassA,p),i-=this.m_invIA*bt.CrossVV(c,p),r.SelfMulAdd(this.m_invMassB,p),o+=this.m_invIB*bt.CrossVV(l,p),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,nt(_)<h},e}(bi);Ei.InitVelocityConstraints_s_P=new bt,Ei.SolveVelocityConstraints_s_vpA=new bt,Ei.SolveVelocityConstraints_s_vpB=new bt,Ei.SolveVelocityConstraints_s_P=new bt,Ei.SolvePositionConstraints_s_P=new bt;var wi=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_areaJoint)||this).bodies=[],n.frequencyHz=0,n.dampingRatio=0,n}return Q(n,e),n.prototype.AddBody=function(t){this.bodies.push(t),1===this.bodies.length?this.bodyA=t:2===this.bodies.length&&(this.bodyB=t)},n}(Ai),Pi=function(t){function e(e){var i;(i=t.call(this,e)||this).m_frequencyHz=0,i.m_dampingRatio=0,i.m_impulse=0,i.m_targetArea=0,i.m_delta=new bt,i.m_bodies=e.bodies,i.m_frequencyHz=n(e.frequencyHz,0),i.m_dampingRatio=n(e.dampingRatio,0),i.m_targetLengths=J(e.bodies.length),i.m_normals=bt.MakeArray(e.bodies.length),i.m_joints=[],i.m_deltas=bt.MakeArray(e.bodies.length);var r=new Ti;r.frequencyHz=i.m_frequencyHz,r.dampingRatio=i.m_dampingRatio,i.m_targetArea=0;for(var o=0;o<i.m_bodies.length;++o){var a=i.m_bodies[o],s=i.m_bodies[(o+1)%i.m_bodies.length],c=a.GetWorldCenter(),l=s.GetWorldCenter();i.m_targetLengths[o]=bt.DistanceVV(c,l),i.m_targetArea+=bt.CrossVV(c,l),r.Initialize(a,s,c,l),i.m_joints[o]=a.GetWorld().CreateJoint(r)}return i.m_targetArea*=.5,i}Q(e,t);var i=e.prototype;return i.GetAnchorA=function(t){return t},i.GetAnchorB=function(t){return t},i.GetReactionForce=function(t,e){return e},i.GetReactionTorque=function(){return 0},i.SetFrequency=function(t){this.m_frequencyHz=t;for(var e=0;e<this.m_joints.length;++e)this.m_joints[e].SetFrequency(t)},i.GetFrequency=function(){return this.m_frequencyHz},i.SetDampingRatio=function(t){this.m_dampingRatio=t;for(var e=0;e<this.m_joints.length;++e)this.m_joints[e].SetDampingRatio(t)},i.GetDampingRatio=function(){return this.m_dampingRatio},i.Dump=function(t){t("Area joint dumping is not supported.\n")},i.InitVelocityConstraints=function(t){for(var e=0;e<this.m_bodies.length;++e){var n=this.m_bodies[(e+this.m_bodies.length-1)%this.m_bodies.length],i=this.m_bodies[(e+1)%this.m_bodies.length],r=t.positions[n.m_islandIndex].c,o=t.positions[i.m_islandIndex].c,a=this.m_deltas[e];bt.SubVV(o,r,a)}if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;for(var s=0;s<this.m_bodies.length;++s){var c=this.m_bodies[s],l=t.velocities[c.m_islandIndex].v,u=this.m_deltas[s];l.x+=c.m_invMass*u.y*.5*this.m_impulse,l.y+=c.m_invMass*-u.x*.5*this.m_impulse}}else this.m_impulse=0},i.SolveVelocityConstraints=function(t){for(var e=0,n=0,i=0;i<this.m_bodies.length;++i){var r=this.m_bodies[i],o=t.velocities[r.m_islandIndex].v,a=this.m_deltas[i];e+=a.LengthSquared()/r.GetMass(),n+=bt.CrossVV(o,a)}var s=-2*n/e;this.m_impulse+=s;for(var c=0;c<this.m_bodies.length;++c){var l=this.m_bodies[c],u=t.velocities[l.m_islandIndex].v,h=this.m_deltas[c];u.x+=l.m_invMass*h.y*.5*s,u.y+=l.m_invMass*-h.x*.5*s}},i.SolvePositionConstraints=function(t){for(var e=0,n=0,i=0;i<this.m_bodies.length;++i){var o=this.m_bodies[i],a=this.m_bodies[(i+1)%this.m_bodies.length],s=t.positions[o.m_islandIndex].c,c=t.positions[a.m_islandIndex].c,l=bt.SubVV(c,s,this.m_delta),u=l.Length();u<r&&(u=1),this.m_normals[i].x=l.y/u,this.m_normals[i].y=-l.x/u,e+=u,n+=bt.CrossVV(s,c)}n*=.5;for(var _=.5*(this.m_targetArea-n)/e,f=!0,p=0;p<this.m_bodies.length;++p){var d=this.m_bodies[p],m=t.positions[d.m_islandIndex].c,g=(p+1)%this.m_bodies.length,y=bt.AddVV(this.m_normals[p],this.m_normals[g],this.m_delta);y.SelfMul(_);var x=y.LengthSquared();x>lt(v)&&y.SelfMul(v/ht(x)),x>lt(h)&&(f=!1),m.x+=y.x,m.y+=y.y}return f},e}(bi),Ii=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_frictionJoint)||this).localAnchorA=new bt,n.localAnchorB=new bt,n.maxForce=0,n.maxTorque=0,n}return Q(n,e),n.prototype.Initialize=function(t,e,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB)},n}(Ai),Ri=function(t){function e(e){var i;return(i=t.call(this,e)||this).m_localAnchorA=new bt,i.m_localAnchorB=new bt,i.m_linearImpulse=new bt,i.m_angularImpulse=0,i.m_maxForce=0,i.m_maxTorque=0,i.m_indexA=0,i.m_indexB=0,i.m_rA=new bt,i.m_rB=new bt,i.m_localCenterA=new bt,i.m_localCenterB=new bt,i.m_invMassA=0,i.m_invMassB=0,i.m_invIA=0,i.m_invIB=0,i.m_linearMass=new wt,i.m_angularMass=0,i.m_qA=new It,i.m_qB=new It,i.m_lalcA=new bt,i.m_lalcB=new bt,i.m_K=new wt,i.m_localAnchorA.Copy(e.localAnchorA),i.m_localAnchorB.Copy(e.localAnchorB),i.m_linearImpulse.SetZero(),i.m_maxForce=n(e.maxForce,0),i.m_maxTorque=n(e.maxTorque,0),i.m_linearMass.SetZero(),i}Q(e,t);var i=e.prototype;return i.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,r=t.positions[this.m_indexB].a,o=t.velocities[this.m_indexB].v,a=t.velocities[this.m_indexB].w,s=this.m_qA.SetAngle(e),c=this.m_qB.SetAngle(r);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var l=It.MulRV(s,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var u=It.MulRV(c,this.m_lalcB,this.m_rB),h=this.m_invMassA,_=this.m_invMassB,f=this.m_invIA,p=this.m_invIB,d=this.m_K;if(d.ex.x=h+_+f*l.y*l.y+p*u.y*u.y,d.ex.y=-f*l.x*l.y-p*u.x*u.y,d.ey.x=d.ex.y,d.ey.y=h+_+f*l.x*l.x+p*u.x*u.x,d.GetInverse(this.m_linearMass),this.m_angularMass=f+p,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;var m=this.m_linearImpulse;n.SelfMulSub(h,m),i-=f*(bt.CrossVV(this.m_rA,m)+this.m_angularImpulse),o.SelfMulAdd(_,m),a+=p*(bt.CrossVV(this.m_rB,m)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=a},i.SolveVelocityConstraints=function(t){var n=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,a=this.m_invMassA,s=this.m_invMassB,c=this.m_invIA,l=this.m_invIB,u=t.step.dt,h=o-i,_=-this.m_angularMass*h,f=this.m_angularImpulse,p=u*this.m_maxTorque;this.m_angularImpulse=at(this.m_angularImpulse+_,-p,p),i-=c*(_=this.m_angularImpulse-f),o+=l*_;var d=bt.SubVV(bt.AddVCrossSV(r,o,this.m_rB,bt.s_t0),bt.AddVCrossSV(n,i,this.m_rA,bt.s_t1),e.SolveVelocityConstraints_s_Cdot_v2),m=wt.MulMV(this.m_linearMass,d,e.SolveVelocityConstraints_s_impulseV).SelfNeg(),v=e.SolveVelocityConstraints_s_oldImpulseV.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(m);var g=u*this.m_maxForce;this.m_linearImpulse.LengthSquared()>g*g&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(g)),bt.SubVV(this.m_linearImpulse,v,m),n.SelfMulSub(a,m),i-=c*bt.CrossVV(this.m_rA,m),r.SelfMulAdd(s,m),o+=l*bt.CrossVV(this.m_rB,m),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o},i.SolvePositionConstraints=function(){return!0},i.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},i.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},i.GetReactionForce=function(t,e){return e.x=t*this.m_linearImpulse.x,e.y=t*this.m_linearImpulse.y,e},i.GetReactionTorque=function(t){return t*this.m_angularImpulse},i.GetLocalAnchorA=function(){return this.m_localAnchorA},i.GetLocalAnchorB=function(){return this.m_localAnchorB},i.SetMaxForce=function(t){this.m_maxForce=t},i.GetMaxForce=function(){return this.m_maxForce},i.SetMaxTorque=function(t){this.m_maxTorque=t},i.GetMaxTorque=function(){return this.m_maxTorque},i.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2FrictionJointDef = new b2FrictionJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},e}(bi);Ri.SolveVelocityConstraints_s_Cdot_v2=new bt,Ri.SolveVelocityConstraints_s_impulseV=new bt,Ri.SolveVelocityConstraints_s_oldImpulseV=new bt;var Di=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_gearJoint)||this).ratio=1,n}return Q(n,e),n}(Ai),Bi=function(e){function i(i){var r,o,a;(r=e.call(this,i)||this).m_typeA=t.b2JointType.e_unknownJoint,r.m_typeB=t.b2JointType.e_unknownJoint,r.m_localAnchorA=new bt,r.m_localAnchorB=new bt,r.m_localAnchorC=new bt,r.m_localAnchorD=new bt,r.m_localAxisC=new bt,r.m_localAxisD=new bt,r.m_referenceAngleA=0,r.m_referenceAngleB=0,r.m_constant=0,r.m_ratio=0,r.m_impulse=0,r.m_indexA=0,r.m_indexB=0,r.m_indexC=0,r.m_indexD=0,r.m_lcA=new bt,r.m_lcB=new bt,r.m_lcC=new bt,r.m_lcD=new bt,r.m_mA=0,r.m_mB=0,r.m_mC=0,r.m_mD=0,r.m_iA=0,r.m_iB=0,r.m_iC=0,r.m_iD=0,r.m_JvAC=new bt,r.m_JvBD=new bt,r.m_JwA=0,r.m_JwB=0,r.m_JwC=0,r.m_JwD=0,r.m_mass=0,r.m_qA=new It,r.m_qB=new It,r.m_qC=new It,r.m_qD=new It,r.m_lalcA=new bt,r.m_lalcB=new bt,r.m_lalcC=new bt,r.m_lalcD=new bt,r.m_joint1=i.joint1,r.m_joint2=i.joint2,r.m_typeA=r.m_joint1.GetType(),r.m_typeB=r.m_joint2.GetType(),r.m_bodyC=r.m_joint1.GetBodyA(),r.m_bodyA=r.m_joint1.GetBodyB();var s=r.m_bodyA.m_xf,c=r.m_bodyA.m_sweep.a,l=r.m_bodyC.m_xf,u=r.m_bodyC.m_sweep.a;if(r.m_typeA===t.b2JointType.e_revoluteJoint){var h=i.joint1;r.m_localAnchorC.Copy(h.m_localAnchorA),r.m_localAnchorA.Copy(h.m_localAnchorB),r.m_referenceAngleA=h.m_referenceAngle,r.m_localAxisC.SetZero(),o=c-u-r.m_referenceAngleA}else{var _=i.joint1;r.m_localAnchorC.Copy(_.m_localAnchorA),r.m_localAnchorA.Copy(_.m_localAnchorB),r.m_referenceAngleA=_.m_referenceAngle,r.m_localAxisC.Copy(_.m_localXAxisA);var f=r.m_localAnchorC,p=It.MulTRV(l.q,bt.AddVV(It.MulRV(s.q,r.m_localAnchorA,bt.s_t0),bt.SubVV(s.p,l.p,bt.s_t1),bt.s_t0),bt.s_t0);o=bt.DotVV(bt.SubVV(p,f,bt.s_t0),r.m_localAxisC)}r.m_bodyD=r.m_joint2.GetBodyA(),r.m_bodyB=r.m_joint2.GetBodyB();var d=r.m_bodyB.m_xf,m=r.m_bodyB.m_sweep.a,v=r.m_bodyD.m_xf,g=r.m_bodyD.m_sweep.a;if(r.m_typeB===t.b2JointType.e_revoluteJoint){var y=i.joint2;r.m_localAnchorD.Copy(y.m_localAnchorA),r.m_localAnchorB.Copy(y.m_localAnchorB),r.m_referenceAngleB=y.m_referenceAngle,r.m_localAxisD.SetZero(),a=m-g-r.m_referenceAngleB}else{var x=i.joint2;r.m_localAnchorD.Copy(x.m_localAnchorA),r.m_localAnchorB.Copy(x.m_localAnchorB),r.m_referenceAngleB=x.m_referenceAngle,r.m_localAxisD.Copy(x.m_localXAxisA);var S=r.m_localAnchorD,C=It.MulTRV(v.q,bt.AddVV(It.MulRV(d.q,r.m_localAnchorB,bt.s_t0),bt.SubVV(d.p,v.p,bt.s_t1),bt.s_t0),bt.s_t0);a=bt.DotVV(bt.SubVV(C,S,bt.s_t0),r.m_localAxisD)}return r.m_ratio=n(i.ratio,1),r.m_constant=o+r.m_ratio*a,r.m_impulse=0,r}Q(i,e);var r=i.prototype;return r.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_indexC=this.m_bodyC.m_islandIndex,this.m_indexD=this.m_bodyD.m_islandIndex,this.m_lcA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_lcB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_lcC.Copy(this.m_bodyC.m_sweep.localCenter),this.m_lcD.Copy(this.m_bodyD.m_sweep.localCenter),this.m_mA=this.m_bodyA.m_invMass,this.m_mB=this.m_bodyB.m_invMass,this.m_mC=this.m_bodyC.m_invMass,this.m_mD=this.m_bodyD.m_invMass,this.m_iA=this.m_bodyA.m_invI,this.m_iB=this.m_bodyB.m_invI,this.m_iC=this.m_bodyC.m_invI,this.m_iD=this.m_bodyD.m_invI;var n=e.positions[this.m_indexA].a,r=e.velocities[this.m_indexA].v,o=e.velocities[this.m_indexA].w,a=e.positions[this.m_indexB].a,s=e.velocities[this.m_indexB].v,c=e.velocities[this.m_indexB].w,l=e.positions[this.m_indexC].a,u=e.velocities[this.m_indexC].v,h=e.velocities[this.m_indexC].w,_=e.positions[this.m_indexD].a,f=e.velocities[this.m_indexD].v,p=e.velocities[this.m_indexD].w,d=this.m_qA.SetAngle(n),m=this.m_qB.SetAngle(a),v=this.m_qC.SetAngle(l),g=this.m_qD.SetAngle(_);if(this.m_mass=0,this.m_typeA===t.b2JointType.e_revoluteJoint)this.m_JvAC.SetZero(),this.m_JwA=1,this.m_JwC=1,this.m_mass+=this.m_iA+this.m_iC;else{var y=It.MulRV(v,this.m_localAxisC,i.InitVelocityConstraints_s_u);bt.SubVV(this.m_localAnchorC,this.m_lcC,this.m_lalcC);var x=It.MulRV(v,this.m_lalcC,i.InitVelocityConstraints_s_rC);bt.SubVV(this.m_localAnchorA,this.m_lcA,this.m_lalcA);var S=It.MulRV(d,this.m_lalcA,i.InitVelocityConstraints_s_rA);this.m_JvAC.Copy(y),this.m_JwC=bt.CrossVV(x,y),this.m_JwA=bt.CrossVV(S,y),this.m_mass+=this.m_mC+this.m_mA+this.m_iC*this.m_JwC*this.m_JwC+this.m_iA*this.m_JwA*this.m_JwA}if(this.m_typeB===t.b2JointType.e_revoluteJoint)this.m_JvBD.SetZero(),this.m_JwB=this.m_ratio,this.m_JwD=this.m_ratio,this.m_mass+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD);else{var C=It.MulRV(g,this.m_localAxisD,i.InitVelocityConstraints_s_u);bt.SubVV(this.m_localAnchorD,this.m_lcD,this.m_lalcD);var A=It.MulRV(g,this.m_lalcD,i.InitVelocityConstraints_s_rD);bt.SubVV(this.m_localAnchorB,this.m_lcB,this.m_lalcB);var b=It.MulRV(m,this.m_lalcB,i.InitVelocityConstraints_s_rB);bt.MulSV(this.m_ratio,C,this.m_JvBD),this.m_JwD=this.m_ratio*bt.CrossVV(A,C),this.m_JwB=this.m_ratio*bt.CrossVV(b,C),this.m_mass+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*this.m_JwD*this.m_JwD+this.m_iB*this.m_JwB*this.m_JwB}this.m_mass=this.m_mass>0?1/this.m_mass:0,e.step.warmStarting?(r.SelfMulAdd(this.m_mA*this.m_impulse,this.m_JvAC),o+=this.m_iA*this.m_impulse*this.m_JwA,s.SelfMulAdd(this.m_mB*this.m_impulse,this.m_JvBD),c+=this.m_iB*this.m_impulse*this.m_JwB,u.SelfMulSub(this.m_mC*this.m_impulse,this.m_JvAC),h-=this.m_iC*this.m_impulse*this.m_JwC,f.SelfMulSub(this.m_mD*this.m_impulse,this.m_JvBD),p-=this.m_iD*this.m_impulse*this.m_JwD):this.m_impulse=0,e.velocities[this.m_indexA].w=o,e.velocities[this.m_indexB].w=c,e.velocities[this.m_indexC].w=h,e.velocities[this.m_indexD].w=p},r.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,i=t.velocities[this.m_indexB].v,r=t.velocities[this.m_indexB].w,o=t.velocities[this.m_indexC].v,a=t.velocities[this.m_indexC].w,s=t.velocities[this.m_indexD].v,c=t.velocities[this.m_indexD].w,l=bt.DotVV(this.m_JvAC,bt.SubVV(e,o,bt.s_t0))+bt.DotVV(this.m_JvBD,bt.SubVV(i,s,bt.s_t0));l+=this.m_JwA*n-this.m_JwC*a+(this.m_JwB*r-this.m_JwD*c);var u=-this.m_mass*l;this.m_impulse+=u,e.SelfMulAdd(this.m_mA*u,this.m_JvAC),n+=this.m_iA*u*this.m_JwA,i.SelfMulAdd(this.m_mB*u,this.m_JvBD),r+=this.m_iB*u*this.m_JwB,o.SelfMulSub(this.m_mC*u,this.m_JvAC),a-=this.m_iC*u*this.m_JwC,s.SelfMulSub(this.m_mD*u,this.m_JvBD),c-=this.m_iD*u*this.m_JwD,t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=r,t.velocities[this.m_indexC].w=a,t.velocities[this.m_indexD].w=c},r.SolvePositionConstraints=function(e){var n,r,o,a,s,c,l=e.positions[this.m_indexA].c,u=e.positions[this.m_indexA].a,_=e.positions[this.m_indexB].c,f=e.positions[this.m_indexB].a,p=e.positions[this.m_indexC].c,d=e.positions[this.m_indexC].a,m=e.positions[this.m_indexD].c,v=e.positions[this.m_indexD].a,g=this.m_qA.SetAngle(u),y=this.m_qB.SetAngle(f),x=this.m_qC.SetAngle(d),S=this.m_qD.SetAngle(v),C=0,A=this.m_JvAC,b=this.m_JvBD,T=0;if(this.m_typeA===t.b2JointType.e_revoluteJoint)A.SetZero(),o=1,s=1,T+=this.m_iA+this.m_iC,n=u-d-this.m_referenceAngleA;else{var E=It.MulRV(x,this.m_localAxisC,i.SolvePositionConstraints_s_u),w=It.MulRV(x,this.m_lalcC,i.SolvePositionConstraints_s_rC),P=It.MulRV(g,this.m_lalcA,i.SolvePositionConstraints_s_rA);A.Copy(E),s=bt.CrossVV(w,E),o=bt.CrossVV(P,E),T+=this.m_mC+this.m_mA+this.m_iC*s*s+this.m_iA*o*o;var I=this.m_lalcC,R=It.MulTRV(x,bt.AddVV(P,bt.SubVV(l,p,bt.s_t0),bt.s_t0),bt.s_t0);n=bt.DotVV(bt.SubVV(R,I,bt.s_t0),this.m_localAxisC)}if(this.m_typeB===t.b2JointType.e_revoluteJoint)b.SetZero(),a=this.m_ratio,c=this.m_ratio,T+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD),r=f-v-this.m_referenceAngleB;else{var D=It.MulRV(S,this.m_localAxisD,i.SolvePositionConstraints_s_u),B=It.MulRV(S,this.m_lalcD,i.SolvePositionConstraints_s_rD),M=It.MulRV(y,this.m_lalcB,i.SolvePositionConstraints_s_rB);bt.MulSV(this.m_ratio,D,b),c=this.m_ratio*bt.CrossVV(B,D),a=this.m_ratio*bt.CrossVV(M,D),T+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*c*c+this.m_iB*a*a;var O=this.m_lalcD,N=It.MulTRV(S,bt.AddVV(M,bt.SubVV(_,m,bt.s_t0),bt.s_t0),bt.s_t0);r=bt.DotVV(bt.SubVV(N,O,bt.s_t0),this.m_localAxisD)}var L=n+this.m_ratio*r-this.m_constant,F=0;return T>0&&(F=-L/T),l.SelfMulAdd(this.m_mA*F,A),u+=this.m_iA*F*o,_.SelfMulAdd(this.m_mB*F,b),f+=this.m_iB*F*a,p.SelfMulSub(this.m_mC*F,A),d-=this.m_iC*F*s,m.SelfMulSub(this.m_mD*F,b),v-=this.m_iD*F*c,e.positions[this.m_indexA].a=u,e.positions[this.m_indexB].a=f,e.positions[this.m_indexC].a=d,e.positions[this.m_indexD].a=v,C<h},r.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},r.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},r.GetReactionForce=function(t,e){return bt.MulSV(t*this.m_impulse,this.m_JvAC,e)},r.GetReactionTorque=function(t){return t*this.m_impulse*this.m_JwA},r.GetJoint1=function(){return this.m_joint1},r.GetJoint2=function(){return this.m_joint2},r.GetRatio=function(){return this.m_ratio},r.SetRatio=function(t){this.m_ratio=t},r.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex,i=this.m_joint1.m_index,r=this.m_joint2.m_index;t("  const jd: b2GearJointDef = new b2GearJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.joint1 = joints[%d];\n",i),t("  jd.joint2 = joints[%d];\n",r),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i}(bi);Bi.InitVelocityConstraints_s_u=new bt,Bi.InitVelocityConstraints_s_rA=new bt,Bi.InitVelocityConstraints_s_rB=new bt,Bi.InitVelocityConstraints_s_rC=new bt,Bi.InitVelocityConstraints_s_rD=new bt,Bi.SolvePositionConstraints_s_u=new bt,Bi.SolvePositionConstraints_s_rA=new bt,Bi.SolvePositionConstraints_s_rB=new bt,Bi.SolvePositionConstraints_s_rC=new bt,Bi.SolvePositionConstraints_s_rD=new bt;var Mi=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_motorJoint)||this).linearOffset=new bt(0,0),n.angularOffset=0,n.maxForce=1,n.maxTorque=1,n.correctionFactor=.3,n}return Q(n,e),n.prototype.Initialize=function(t,e){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(this.bodyB.GetPosition(),this.linearOffset);var n=this.bodyA.GetAngle(),i=this.bodyB.GetAngle();this.angularOffset=i-n},n}(Ai),Oi=function(t){function e(e){var i;return(i=t.call(this,e)||this).m_linearOffset=new bt,i.m_angularOffset=0,i.m_linearImpulse=new bt,i.m_angularImpulse=0,i.m_maxForce=0,i.m_maxTorque=0,i.m_correctionFactor=.3,i.m_indexA=0,i.m_indexB=0,i.m_rA=new bt,i.m_rB=new bt,i.m_localCenterA=new bt,i.m_localCenterB=new bt,i.m_linearError=new bt,i.m_angularError=0,i.m_invMassA=0,i.m_invMassB=0,i.m_invIA=0,i.m_invIB=0,i.m_linearMass=new wt,i.m_angularMass=0,i.m_qA=new It,i.m_qB=new It,i.m_K=new wt,i.m_linearOffset.Copy(n(e.linearOffset,bt.ZERO)),i.m_linearImpulse.SetZero(),i.m_maxForce=n(e.maxForce,0),i.m_maxTorque=n(e.maxTorque,0),i.m_correctionFactor=n(e.correctionFactor,.3),i}Q(e,t);var i=e.prototype;return i.GetAnchorA=function(t){var e=this.m_bodyA.GetPosition();return t.x=e.x,t.y=e.y,t},i.GetAnchorB=function(t){var e=this.m_bodyB.GetPosition();return t.x=e.x,t.y=e.y,t},i.GetReactionForce=function(t,e){return bt.MulSV(t,this.m_linearImpulse,e)},i.GetReactionTorque=function(t){return t*this.m_angularImpulse},i.SetLinearOffset=function(t){bt.IsEqualToV(t,this.m_linearOffset)||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_linearOffset.Copy(t))},i.GetLinearOffset=function(){return this.m_linearOffset},i.SetAngularOffset=function(t){t!==this.m_angularOffset&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_angularOffset=t)},i.GetAngularOffset=function(){return this.m_angularOffset},i.SetMaxForce=function(t){this.m_maxForce=t},i.GetMaxForce=function(){return this.m_maxForce},i.SetMaxTorque=function(t){this.m_maxTorque=t},i.GetMaxTorque=function(){return this.m_maxTorque},i.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexA].c,n=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v,r=t.velocities[this.m_indexA].w,o=t.positions[this.m_indexB].c,a=t.positions[this.m_indexB].a,s=t.velocities[this.m_indexB].v,c=t.velocities[this.m_indexB].w,l=this.m_qA.SetAngle(n),u=this.m_qB.SetAngle(a),h=It.MulRV(l,bt.SubVV(this.m_linearOffset,this.m_localCenterA,bt.s_t0),this.m_rA),_=It.MulRV(u,bt.NegV(this.m_localCenterB,bt.s_t0),this.m_rB),f=this.m_invMassA,p=this.m_invMassB,d=this.m_invIA,m=this.m_invIB,v=this.m_K;if(v.ex.x=f+p+d*h.y*h.y+m*_.y*_.y,v.ex.y=-d*h.x*h.y-m*_.x*_.y,v.ey.x=v.ex.y,v.ey.y=f+p+d*h.x*h.x+m*_.x*_.x,v.GetInverse(this.m_linearMass),this.m_angularMass=d+m,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),bt.SubVV(bt.AddVV(o,_,bt.s_t0),bt.AddVV(e,h,bt.s_t1),this.m_linearError),this.m_angularError=a-n-this.m_angularOffset,t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;var g=this.m_linearImpulse;i.SelfMulSub(f,g),r-=d*(bt.CrossVV(h,g)+this.m_angularImpulse),s.SelfMulAdd(p,g),c+=m*(bt.CrossVV(_,g)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=r,t.velocities[this.m_indexB].w=c},i.SolveVelocityConstraints=function(t){var n=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,a=this.m_invMassA,s=this.m_invMassB,c=this.m_invIA,l=this.m_invIB,u=t.step.dt,h=t.step.inv_dt,_=o-i+h*this.m_correctionFactor*this.m_angularError,f=-this.m_angularMass*_,p=this.m_angularImpulse,d=u*this.m_maxTorque;this.m_angularImpulse=at(this.m_angularImpulse+f,-d,d),i-=c*(f=this.m_angularImpulse-p),o+=l*f;var m=this.m_rA,v=this.m_rB,g=bt.AddVV(bt.SubVV(bt.AddVV(r,bt.CrossSV(o,v,bt.s_t0),bt.s_t0),bt.AddVV(n,bt.CrossSV(i,m,bt.s_t1),bt.s_t1),bt.s_t2),bt.MulSV(h*this.m_correctionFactor,this.m_linearError,bt.s_t3),e.SolveVelocityConstraints_s_Cdot_v2),y=wt.MulMV(this.m_linearMass,g,e.SolveVelocityConstraints_s_impulse_v2).SelfNeg(),x=e.SolveVelocityConstraints_s_oldImpulse_v2.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(y);var S=u*this.m_maxForce;this.m_linearImpulse.LengthSquared()>S*S&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(S)),bt.SubVV(this.m_linearImpulse,x,y),n.SelfMulSub(a,y),i-=c*bt.CrossVV(m,y),r.SelfMulAdd(s,y),o+=l*bt.CrossVV(v,y),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o},i.SolvePositionConstraints=function(){return!0},i.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2MotorJointDef = new b2MotorJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.linearOffset.Set(%.15f, %.15f);\n",this.m_linearOffset.x,this.m_linearOffset.y),t("  jd.angularOffset = %.15f;\n",this.m_angularOffset),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  jd.correctionFactor = %.15f;\n",this.m_correctionFactor),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},e}(bi);Oi.SolveVelocityConstraints_s_Cdot_v2=new bt,Oi.SolveVelocityConstraints_s_impulse_v2=new bt,Oi.SolveVelocityConstraints_s_oldImpulse_v2=new bt;var Ni=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_mouseJoint)||this).target=new bt,n.maxForce=0,n.frequencyHz=5,n.dampingRatio=.7,n}return Q(n,e),n}(Ai),Li=function(t){function e(e){var i;return(i=t.call(this,e)||this).m_localAnchorB=new bt,i.m_targetA=new bt,i.m_frequencyHz=0,i.m_dampingRatio=0,i.m_beta=0,i.m_impulse=new bt,i.m_maxForce=0,i.m_gamma=0,i.m_indexA=0,i.m_indexB=0,i.m_rB=new bt,i.m_localCenterB=new bt,i.m_invMassB=0,i.m_invIB=0,i.m_mass=new wt,i.m_C=new bt,i.m_qB=new It,i.m_lalcB=new bt,i.m_K=new wt,i.m_targetA.Copy(n(e.target,bt.ZERO)),Rt.MulTXV(i.m_bodyB.GetTransform(),i.m_targetA,i.m_localAnchorB),i.m_maxForce=n(e.maxForce,0),i.m_impulse.SetZero(),i.m_frequencyHz=n(e.frequencyHz,0),i.m_dampingRatio=n(e.dampingRatio,0),i.m_beta=0,i.m_gamma=0,i}Q(e,t);var i=e.prototype;return i.SetTarget=function(t){this.m_bodyB.IsAwake()||this.m_bodyB.SetAwake(!0),this.m_targetA.Copy(t)},i.GetTarget=function(){return this.m_targetA},i.SetMaxForce=function(t){this.m_maxForce=t},i.GetMaxForce=function(){return this.m_maxForce},i.SetFrequency=function(t){this.m_frequencyHz=t},i.GetFrequency=function(){return this.m_frequencyHz},i.SetDampingRatio=function(t){this.m_dampingRatio=t},i.GetDampingRatio=function(){return this.m_dampingRatio},i.InitVelocityConstraints=function(t){this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIB=this.m_bodyB.m_invI;var e=t.positions[this.m_indexB].c,n=t.positions[this.m_indexB].a,i=t.velocities[this.m_indexB].v,r=t.velocities[this.m_indexB].w,o=this.m_qB.SetAngle(n),s=this.m_bodyB.GetMass(),c=2*a*this.m_frequencyHz,l=2*s*this.m_dampingRatio*c,u=s*c*c,h=t.step.dt;this.m_gamma=h*(l+h*u),0!==this.m_gamma&&(this.m_gamma=1/this.m_gamma),this.m_beta=h*u*this.m_gamma,bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),It.MulRV(o,this.m_lalcB,this.m_rB);var _=this.m_K;_.ex.x=this.m_invMassB+this.m_invIB*this.m_rB.y*this.m_rB.y+this.m_gamma,_.ex.y=-this.m_invIB*this.m_rB.x*this.m_rB.y,_.ey.x=_.ex.y,_.ey.y=this.m_invMassB+this.m_invIB*this.m_rB.x*this.m_rB.x+this.m_gamma,_.GetInverse(this.m_mass),this.m_C.x=e.x+this.m_rB.x-this.m_targetA.x,this.m_C.y=e.y+this.m_rB.y-this.m_targetA.y,this.m_C.SelfMul(this.m_beta),r*=.98,t.step.warmStarting?(this.m_impulse.SelfMul(t.step.dtRatio),i.x+=this.m_invMassB*this.m_impulse.x,i.y+=this.m_invMassB*this.m_impulse.y,r+=this.m_invIB*bt.CrossVV(this.m_rB,this.m_impulse)):this.m_impulse.SetZero(),t.velocities[this.m_indexB].w=r},i.SolveVelocityConstraints=function(t){var n=t.velocities[this.m_indexB].v,i=t.velocities[this.m_indexB].w,r=bt.AddVCrossSV(n,i,this.m_rB,e.SolveVelocityConstraints_s_Cdot),o=wt.MulMV(this.m_mass,bt.AddVV(r,bt.AddVV(this.m_C,bt.MulSV(this.m_gamma,this.m_impulse,bt.s_t0),bt.s_t0),bt.s_t0).SelfNeg(),e.SolveVelocityConstraints_s_impulse),a=e.SolveVelocityConstraints_s_oldImpulse.Copy(this.m_impulse);this.m_impulse.SelfAdd(o);var s=t.step.dt*this.m_maxForce;this.m_impulse.LengthSquared()>s*s&&this.m_impulse.SelfMul(s/this.m_impulse.Length()),bt.SubVV(this.m_impulse,a,o),n.SelfMulAdd(this.m_invMassB,o),i+=this.m_invIB*bt.CrossVV(this.m_rB,o),t.velocities[this.m_indexB].w=i},i.SolvePositionConstraints=function(){return!0},i.GetAnchorA=function(t){return t.x=this.m_targetA.x,t.y=this.m_targetA.y,t},i.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},i.GetReactionForce=function(t,e){return bt.MulSV(t,this.m_impulse,e)},i.GetReactionTorque=function(){return 0},i.Dump=function(t){t("Mouse joint dumping is not supported.\n")},i.ShiftOrigin=function(t){this.m_targetA.SelfSub(t)},e}(bi);Li.SolveVelocityConstraints_s_Cdot=new bt,Li.SolveVelocityConstraints_s_impulse=new bt,Li.SolveVelocityConstraints_s_oldImpulse=new bt;var Fi=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_prismaticJoint)||this).localAnchorA=new bt,n.localAnchorB=new bt,n.localAxisA=new bt(1,0),n.referenceAngle=0,n.enableLimit=!1,n.lowerTranslation=0,n.upperTranslation=0,n.enableMotor=!1,n.maxMotorForce=0,n.motorSpeed=0,n}return Q(n,e),n.prototype.Initialize=function(t,e,n,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.bodyA.GetLocalVector(i,this.localAxisA),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},n}(Ai),zi=function(e){function i(i){var r;return(r=e.call(this,i)||this).m_localAnchorA=new bt,r.m_localAnchorB=new bt,r.m_localXAxisA=new bt,r.m_localYAxisA=new bt,r.m_referenceAngle=0,r.m_impulse=new Et(0,0,0),r.m_motorImpulse=0,r.m_lowerTranslation=0,r.m_upperTranslation=0,r.m_maxMotorForce=0,r.m_motorSpeed=0,r.m_enableLimit=!1,r.m_enableMotor=!1,r.m_limitState=t.b2LimitState.e_inactiveLimit,r.m_indexA=0,r.m_indexB=0,r.m_localCenterA=new bt,r.m_localCenterB=new bt,r.m_invMassA=0,r.m_invMassB=0,r.m_invIA=0,r.m_invIB=0,r.m_axis=new bt(0,0),r.m_perp=new bt(0,0),r.m_s1=0,r.m_s2=0,r.m_a1=0,r.m_a2=0,r.m_K=new Pt,r.m_K3=new Pt,r.m_K2=new wt,r.m_motorMass=0,r.m_qA=new It,r.m_qB=new It,r.m_lalcA=new bt,r.m_lalcB=new bt,r.m_rA=new bt,r.m_rB=new bt,r.m_localAnchorA.Copy(n(i.localAnchorA,bt.ZERO)),r.m_localAnchorB.Copy(n(i.localAnchorB,bt.ZERO)),r.m_localXAxisA.Copy(n(i.localAxisA,new bt(1,0))).SelfNormalize(),bt.CrossOneV(r.m_localXAxisA,r.m_localYAxisA),r.m_referenceAngle=n(i.referenceAngle,0),r.m_lowerTranslation=n(i.lowerTranslation,0),r.m_upperTranslation=n(i.upperTranslation,0),r.m_maxMotorForce=n(i.maxMotorForce,0),r.m_motorSpeed=n(i.motorSpeed,0),r.m_enableLimit=n(i.enableLimit,!1),r.m_enableMotor=n(i.enableMotor,!1),r}Q(i,e);var r=i.prototype;return r.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=e.positions[this.m_indexA].c,r=e.positions[this.m_indexA].a,o=e.velocities[this.m_indexA].v,a=e.velocities[this.m_indexA].w,s=e.positions[this.m_indexB].c,c=e.positions[this.m_indexB].a,l=e.velocities[this.m_indexB].v,u=e.velocities[this.m_indexB].w,_=this.m_qA.SetAngle(r),f=this.m_qB.SetAngle(c);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var p=It.MulRV(_,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var d=It.MulRV(f,this.m_lalcB,this.m_rB),m=bt.AddVV(bt.SubVV(s,n,bt.s_t0),bt.SubVV(d,p,bt.s_t1),i.InitVelocityConstraints_s_d),v=this.m_invMassA,g=this.m_invMassB,y=this.m_invIA,x=this.m_invIB;if(It.MulRV(_,this.m_localXAxisA,this.m_axis),this.m_a1=bt.CrossVV(bt.AddVV(m,p,bt.s_t0),this.m_axis),this.m_a2=bt.CrossVV(d,this.m_axis),this.m_motorMass=v+g+y*this.m_a1*this.m_a1+x*this.m_a2*this.m_a2,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),It.MulRV(_,this.m_localYAxisA,this.m_perp),this.m_s1=bt.CrossVV(bt.AddVV(m,p,bt.s_t0),this.m_perp),this.m_s2=bt.CrossVV(d,this.m_perp),this.m_K.ex.x=v+g+y*this.m_s1*this.m_s1+x*this.m_s2*this.m_s2,this.m_K.ex.y=y*this.m_s1+x*this.m_s2,this.m_K.ex.z=y*this.m_s1*this.m_a1+x*this.m_s2*this.m_a2,this.m_K.ey.x=this.m_K.ex.y,this.m_K.ey.y=y+x,0===this.m_K.ey.y&&(this.m_K.ey.y=1),this.m_K.ey.z=y*this.m_a1+x*this.m_a2,this.m_K.ez.x=this.m_K.ex.z,this.m_K.ez.y=this.m_K.ey.z,this.m_K.ez.z=v+g+y*this.m_a1*this.m_a1+x*this.m_a2*this.m_a2,this.m_enableLimit){var S=bt.DotVV(this.m_axis,m);nt(this.m_upperTranslation-this.m_lowerTranslation)<2*h?this.m_limitState=t.b2LimitState.e_equalLimits:S<=this.m_lowerTranslation?this.m_limitState!==t.b2LimitState.e_atLowerLimit&&(this.m_limitState=t.b2LimitState.e_atLowerLimit,this.m_impulse.z=0):S>=this.m_upperTranslation?this.m_limitState!==t.b2LimitState.e_atUpperLimit&&(this.m_limitState=t.b2LimitState.e_atUpperLimit,this.m_impulse.z=0):(this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0;if(this.m_enableMotor||(this.m_motorImpulse=0),e.step.warmStarting){this.m_impulse.SelfMul(e.step.dtRatio),this.m_motorImpulse*=e.step.dtRatio;var C=bt.AddVV(bt.MulSV(this.m_impulse.x,this.m_perp,bt.s_t0),bt.MulSV(this.m_motorImpulse+this.m_impulse.z,this.m_axis,bt.s_t1),i.InitVelocityConstraints_s_P),A=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,b=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;o.SelfMulSub(v,C),a-=y*A,l.SelfMulAdd(g,C),u+=x*b}else this.m_impulse.SetZero(),this.m_motorImpulse=0;e.velocities[this.m_indexA].w=a,e.velocities[this.m_indexB].w=u},r.SolveVelocityConstraints=function(e){var n=e.velocities[this.m_indexA].v,r=e.velocities[this.m_indexA].w,o=e.velocities[this.m_indexB].v,a=e.velocities[this.m_indexB].w,s=this.m_invMassA,c=this.m_invMassB,l=this.m_invIA,u=this.m_invIB;if(this.m_enableMotor&&this.m_limitState!==t.b2LimitState.e_equalLimits){var h=bt.DotVV(this.m_axis,bt.SubVV(o,n,bt.s_t0))+this.m_a2*a-this.m_a1*r,_=this.m_motorMass*(this.m_motorSpeed-h),f=this.m_motorImpulse,p=e.step.dt*this.m_maxMotorForce;this.m_motorImpulse=at(this.m_motorImpulse+_,-p,p),_=this.m_motorImpulse-f;var d=bt.MulSV(_,this.m_axis,i.SolveVelocityConstraints_s_P),m=_*this.m_a1,v=_*this.m_a2;n.SelfMulSub(s,d),r-=l*m,o.SelfMulAdd(c,d),a+=u*v}var g=bt.DotVV(this.m_perp,bt.SubVV(o,n,bt.s_t0))+this.m_s2*a-this.m_s1*r,y=a-r;if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit){var x=bt.DotVV(this.m_axis,bt.SubVV(o,n,bt.s_t0))+this.m_a2*a-this.m_a1*r,S=i.SolveVelocityConstraints_s_f1.Copy(this.m_impulse),C=this.m_K.Solve33(-g,-y,-x,i.SolveVelocityConstraints_s_df3);this.m_impulse.SelfAdd(C),this.m_limitState===t.b2LimitState.e_atLowerLimit?this.m_impulse.z=rt(this.m_impulse.z,0):this.m_limitState===t.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=it(this.m_impulse.z,0));var A=-g-(this.m_impulse.z-S.z)*this.m_K.ez.x,b=-y-(this.m_impulse.z-S.z)*this.m_K.ez.y,T=this.m_K.Solve22(A,b,i.SolveVelocityConstraints_s_f2r);T.x+=S.x,T.y+=S.y,this.m_impulse.x=T.x,this.m_impulse.y=T.y,C.x=this.m_impulse.x-S.x,C.y=this.m_impulse.y-S.y,C.z=this.m_impulse.z-S.z;var E=bt.AddVV(bt.MulSV(C.x,this.m_perp,bt.s_t0),bt.MulSV(C.z,this.m_axis,bt.s_t1),i.SolveVelocityConstraints_s_P),w=C.x*this.m_s1+C.y+C.z*this.m_a1,P=C.x*this.m_s2+C.y+C.z*this.m_a2;n.SelfMulSub(s,E),r-=l*w,o.SelfMulAdd(c,E),a+=u*P}else{var I=this.m_K.Solve22(-g,-y,i.SolveVelocityConstraints_s_df2);this.m_impulse.x+=I.x,this.m_impulse.y+=I.y;var R=bt.MulSV(I.x,this.m_perp,i.SolveVelocityConstraints_s_P),D=I.x*this.m_s1+I.y,B=I.x*this.m_s2+I.y;n.SelfMulSub(s,R),r-=l*D,o.SelfMulAdd(c,R),a+=u*B}e.velocities[this.m_indexA].w=r,e.velocities[this.m_indexB].w=a},r.SolvePositionConstraints=function(t){var e=t.positions[this.m_indexA].c,n=t.positions[this.m_indexA].a,r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=this.m_qA.SetAngle(n),s=this.m_qB.SetAngle(o),c=this.m_invMassA,l=this.m_invMassB,u=this.m_invIA,f=this.m_invIB,p=It.MulRV(a,this.m_lalcA,this.m_rA),d=It.MulRV(s,this.m_lalcB,this.m_rB),m=bt.SubVV(bt.AddVV(r,d,bt.s_t0),bt.AddVV(e,p,bt.s_t1),i.SolvePositionConstraints_s_d),g=It.MulRV(a,this.m_localXAxisA,this.m_axis),y=bt.CrossVV(bt.AddVV(m,p,bt.s_t0),g),x=bt.CrossVV(d,g),S=It.MulRV(a,this.m_localYAxisA,this.m_perp),C=bt.CrossVV(bt.AddVV(m,p,bt.s_t0),S),A=bt.CrossVV(d,S),b=i.SolvePositionConstraints_s_impulse,T=bt.DotVV(S,m),E=o-n-this.m_referenceAngle,w=nt(T),P=nt(E),I=!1,R=0;if(this.m_enableLimit){var D=bt.DotVV(g,m);nt(this.m_upperTranslation-this.m_lowerTranslation)<2*h?(R=at(D,-v,v),w=rt(w,nt(D)),I=!0):D<=this.m_lowerTranslation?(R=at(D-this.m_lowerTranslation+h,-v,0),w=rt(w,this.m_lowerTranslation-D),I=!0):D>=this.m_upperTranslation&&(R=at(D-this.m_upperTranslation-h,0,v),w=rt(w,D-this.m_upperTranslation),I=!0)}if(I){var B=c+l+u*C*C+f*A*A,M=u*C+f*A,O=u*C*y+f*A*x,N=u+f;0===N&&(N=1);var L=u*y+f*x,F=c+l+u*y*y+f*x*x,z=this.m_K3;z.ex.SetXYZ(B,M,O),z.ey.SetXYZ(M,N,L),z.ez.SetXYZ(O,L,F),b=z.Solve33(-T,-E,-R,b)}else{var G=c+l+u*C*C+f*A*A,V=u*C+f*A,U=u+f;0===U&&(U=1);var k=this.m_K2;k.ex.Set(G,V),k.ey.Set(V,U);var H=k.Solve(-T,-E,i.SolvePositionConstraints_s_impulse1);b.x=H.x,b.y=H.y,b.z=0}var j=bt.AddVV(bt.MulSV(b.x,S,bt.s_t0),bt.MulSV(b.z,g,bt.s_t1),i.SolvePositionConstraints_s_P),W=b.x*C+b.y+b.z*y,q=b.x*A+b.y+b.z*x;return e.SelfMulSub(c,j),n-=u*W,r.SelfMulAdd(l,j),o+=f*q,t.positions[this.m_indexA].a=n,t.positions[this.m_indexB].a=o,w<=h&&P<=_},r.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},r.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},r.GetReactionForce=function(t,e){return e.x=t*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x),e.y=t*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y),e},r.GetReactionTorque=function(t){return t*this.m_impulse.y},r.GetLocalAnchorA=function(){return this.m_localAnchorA},r.GetLocalAnchorB=function(){return this.m_localAnchorB},r.GetLocalAxisA=function(){return this.m_localXAxisA},r.GetReferenceAngle=function(){return this.m_referenceAngle},r.GetJointTranslation=function(){var t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,i.GetJointTranslation_s_pA),e=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,i.GetJointTranslation_s_pB),n=bt.SubVV(e,t,i.GetJointTranslation_s_d),r=this.m_bodyA.GetWorldVector(this.m_localXAxisA,i.GetJointTranslation_s_axis);return bt.DotVV(n,r)},r.GetJointSpeed=function(){var t=this.m_bodyA,e=this.m_bodyB;bt.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);var n=It.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);var i=It.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),r=bt.AddVV(t.m_sweep.c,n,bt.s_t0),o=bt.AddVV(e.m_sweep.c,i,bt.s_t1),a=bt.SubVV(o,r,bt.s_t2),s=t.GetWorldVector(this.m_localXAxisA,this.m_axis),c=t.m_linearVelocity,l=e.m_linearVelocity,u=t.m_angularVelocity,h=e.m_angularVelocity;return bt.DotVV(a,bt.CrossSV(u,s,bt.s_t0))+bt.DotVV(s,bt.SubVV(bt.AddVCrossSV(l,h,i,bt.s_t0),bt.AddVCrossSV(c,u,n,bt.s_t1),bt.s_t0))},r.IsLimitEnabled=function(){return this.m_enableLimit},r.EnableLimit=function(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)},r.GetLowerLimit=function(){return this.m_lowerTranslation},r.GetUpperLimit=function(){return this.m_upperTranslation},r.SetLimits=function(t,e){t===this.m_lowerTranslation&&e===this.m_upperTranslation||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e,this.m_impulse.z=0)},r.IsMotorEnabled=function(){return this.m_enableMotor},r.EnableMotor=function(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)},r.SetMotorSpeed=function(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)},r.GetMotorSpeed=function(){return this.m_motorSpeed},r.SetMaxMotorForce=function(t){t!==this.m_maxMotorForce&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t)},r.GetMaxMotorForce=function(){return this.m_maxMotorForce},r.GetMotorForce=function(t){return t*this.m_motorImpulse},r.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2PrismaticJointDef = new b2PrismaticJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerTranslation = %.15f;\n",this.m_lowerTranslation),t("  jd.upperTranslation = %.15f;\n",this.m_upperTranslation),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorForce = %.15f;\n",this.m_maxMotorForce),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i}(bi);zi.InitVelocityConstraints_s_d=new bt,zi.InitVelocityConstraints_s_P=new bt,zi.SolveVelocityConstraints_s_P=new bt,zi.SolveVelocityConstraints_s_f2r=new bt,zi.SolveVelocityConstraints_s_f1=new Et,zi.SolveVelocityConstraints_s_df3=new Et,zi.SolveVelocityConstraints_s_df2=new bt,zi.SolvePositionConstraints_s_d=new bt,zi.SolvePositionConstraints_s_impulse=new Et,zi.SolvePositionConstraints_s_impulse1=new bt,zi.SolvePositionConstraints_s_P=new bt,zi.GetJointTranslation_s_pA=new bt,zi.GetJointTranslation_s_pB=new bt,zi.GetJointTranslation_s_d=new bt,zi.GetJointTranslation_s_axis=new bt;var Gi=2,Vi=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_pulleyJoint)||this).groundAnchorA=new bt(-1,1),n.groundAnchorB=new bt(1,1),n.localAnchorA=new bt(-1,0),n.localAnchorB=new bt(1,0),n.lengthA=0,n.lengthB=0,n.ratio=1,n.collideConnected=!0,n}return Q(n,e),n.prototype.Initialize=function(t,e,n,i,r,o,a){this.bodyA=t,this.bodyB=e,this.groundAnchorA.Copy(n),this.groundAnchorB.Copy(i),this.bodyA.GetLocalPoint(r,this.localAnchorA),this.bodyB.GetLocalPoint(o,this.localAnchorB),this.lengthA=bt.DistanceVV(r,n),this.lengthB=bt.DistanceVV(o,i),this.ratio=a},n}(Ai),Ui=function(t){function e(e){var i;return(i=t.call(this,e)||this).m_groundAnchorA=new bt,i.m_groundAnchorB=new bt,i.m_lengthA=0,i.m_lengthB=0,i.m_localAnchorA=new bt,i.m_localAnchorB=new bt,i.m_constant=0,i.m_ratio=0,i.m_impulse=0,i.m_indexA=0,i.m_indexB=0,i.m_uA=new bt,i.m_uB=new bt,i.m_rA=new bt,i.m_rB=new bt,i.m_localCenterA=new bt,i.m_localCenterB=new bt,i.m_invMassA=0,i.m_invMassB=0,i.m_invIA=0,i.m_invIB=0,i.m_mass=0,i.m_qA=new It,i.m_qB=new It,i.m_lalcA=new bt,i.m_lalcB=new bt,i.m_groundAnchorA.Copy(n(e.groundAnchorA,new bt(-1,1))),i.m_groundAnchorB.Copy(n(e.groundAnchorB,new bt(1,0))),i.m_localAnchorA.Copy(n(e.localAnchorA,new bt(-1,0))),i.m_localAnchorB.Copy(n(e.localAnchorB,new bt(1,0))),i.m_lengthA=n(e.lengthA,0),i.m_lengthB=n(e.lengthB,0),i.m_ratio=n(e.ratio,1),i.m_constant=n(e.lengthA,0)+i.m_ratio*n(e.lengthB,0),i.m_impulse=0,i}Q(e,t);var i=e.prototype;return i.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,r=t.velocities[this.m_indexA].v,o=t.velocities[this.m_indexA].w,a=t.positions[this.m_indexB].c,s=t.positions[this.m_indexB].a,c=t.velocities[this.m_indexB].v,l=t.velocities[this.m_indexB].w,u=this.m_qA.SetAngle(i),_=this.m_qB.SetAngle(s);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),It.MulRV(u,this.m_lalcA,this.m_rA),bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),It.MulRV(_,this.m_lalcB,this.m_rB),this.m_uA.Copy(n).SelfAdd(this.m_rA).SelfSub(this.m_groundAnchorA),this.m_uB.Copy(a).SelfAdd(this.m_rB).SelfSub(this.m_groundAnchorB);var f=this.m_uA.Length(),p=this.m_uB.Length();f>10*h?this.m_uA.SelfMul(1/f):this.m_uA.SetZero(),p>10*h?this.m_uB.SelfMul(1/p):this.m_uB.SetZero();var d=bt.CrossVV(this.m_rA,this.m_uA),m=bt.CrossVV(this.m_rB,this.m_uB),v=this.m_invMassA+this.m_invIA*d*d,g=this.m_invMassB+this.m_invIB*m*m;if(this.m_mass=v+this.m_ratio*this.m_ratio*g,this.m_mass>0&&(this.m_mass=1/this.m_mass),t.step.warmStarting){this.m_impulse*=t.step.dtRatio;var y=bt.MulSV(-this.m_impulse,this.m_uA,e.InitVelocityConstraints_s_PA),x=bt.MulSV(-this.m_ratio*this.m_impulse,this.m_uB,e.InitVelocityConstraints_s_PB);r.SelfMulAdd(this.m_invMassA,y),o+=this.m_invIA*bt.CrossVV(this.m_rA,y),c.SelfMulAdd(this.m_invMassB,x),l+=this.m_invIB*bt.CrossVV(this.m_rB,x)}else this.m_impulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=l},i.SolveVelocityConstraints=function(t){var n=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,a=bt.AddVCrossSV(n,i,this.m_rA,e.SolveVelocityConstraints_s_vpA),s=bt.AddVCrossSV(r,o,this.m_rB,e.SolveVelocityConstraints_s_vpB),c=-bt.DotVV(this.m_uA,a)-this.m_ratio*bt.DotVV(this.m_uB,s),l=-this.m_mass*c;this.m_impulse+=l;var u=bt.MulSV(-l,this.m_uA,e.SolveVelocityConstraints_s_PA),h=bt.MulSV(-this.m_ratio*l,this.m_uB,e.SolveVelocityConstraints_s_PB);n.SelfMulAdd(this.m_invMassA,u),i+=this.m_invIA*bt.CrossVV(this.m_rA,u),r.SelfMulAdd(this.m_invMassB,h),o+=this.m_invIB*bt.CrossVV(this.m_rB,h),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o},i.SolvePositionConstraints=function(t){var n=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=this.m_qA.SetAngle(i),s=this.m_qB.SetAngle(o);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var c=It.MulRV(a,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var l=It.MulRV(s,this.m_lalcB,this.m_rB),u=this.m_uA.Copy(n).SelfAdd(c).SelfSub(this.m_groundAnchorA),_=this.m_uB.Copy(r).SelfAdd(l).SelfSub(this.m_groundAnchorB),f=u.Length(),p=_.Length();f>10*h?u.SelfMul(1/f):u.SetZero(),p>10*h?_.SelfMul(1/p):_.SetZero();var d=bt.CrossVV(c,u),m=bt.CrossVV(l,_),v=this.m_invMassA+this.m_invIA*d*d,g=this.m_invMassB+this.m_invIB*m*m,y=v+this.m_ratio*this.m_ratio*g;y>0&&(y=1/y);var x=this.m_constant-f-this.m_ratio*p,S=nt(x),C=-y*x,A=bt.MulSV(-C,u,e.SolvePositionConstraints_s_PA),b=bt.MulSV(-this.m_ratio*C,_,e.SolvePositionConstraints_s_PB);return n.SelfMulAdd(this.m_invMassA,A),i+=this.m_invIA*bt.CrossVV(c,A),r.SelfMulAdd(this.m_invMassB,b),o+=this.m_invIB*bt.CrossVV(l,b),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,S<h},i.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},i.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},i.GetReactionForce=function(t,e){return e.x=t*this.m_impulse*this.m_uB.x,e.y=t*this.m_impulse*this.m_uB.y,e},i.GetReactionTorque=function(){return 0},i.GetGroundAnchorA=function(){return this.m_groundAnchorA},i.GetGroundAnchorB=function(){return this.m_groundAnchorB},i.GetLengthA=function(){return this.m_lengthA},i.GetLengthB=function(){return this.m_lengthB},i.GetRatio=function(){return this.m_ratio},i.GetCurrentLengthA=function(){var t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,e.GetCurrentLengthA_s_p),n=this.m_groundAnchorA;return bt.DistanceVV(t,n)},i.GetCurrentLengthB=function(){var t=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,e.GetCurrentLengthB_s_p),n=this.m_groundAnchorB;return bt.DistanceVV(t,n)},i.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2PulleyJointDef = new b2PulleyJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.groundAnchorA.Set(%.15f, %.15f);\n",this.m_groundAnchorA.x,this.m_groundAnchorA.y),t("  jd.groundAnchorB.Set(%.15f, %.15f);\n",this.m_groundAnchorB.x,this.m_groundAnchorB.y),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.lengthA = %.15f;\n",this.m_lengthA),t("  jd.lengthB = %.15f;\n",this.m_lengthB),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i.ShiftOrigin=function(t){this.m_groundAnchorA.SelfSub(t),this.m_groundAnchorB.SelfSub(t)},e}(bi);Ui.InitVelocityConstraints_s_PA=new bt,Ui.InitVelocityConstraints_s_PB=new bt,Ui.SolveVelocityConstraints_s_vpA=new bt,Ui.SolveVelocityConstraints_s_vpB=new bt,Ui.SolveVelocityConstraints_s_PA=new bt,Ui.SolveVelocityConstraints_s_PB=new bt,Ui.SolvePositionConstraints_s_PA=new bt,Ui.SolvePositionConstraints_s_PB=new bt,Ui.GetCurrentLengthA_s_p=new bt,Ui.GetCurrentLengthB_s_p=new bt;var ki=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_revoluteJoint)||this).localAnchorA=new bt(0,0),n.localAnchorB=new bt(0,0),n.referenceAngle=0,n.enableLimit=!1,n.lowerAngle=0,n.upperAngle=0,n.enableMotor=!1,n.motorSpeed=0,n.maxMotorTorque=0,n}return Q(n,e),n.prototype.Initialize=function(t,e,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},n}(Ai),Hi=function(e){function i(i){var r;return(r=e.call(this,i)||this).m_localAnchorA=new bt,r.m_localAnchorB=new bt,r.m_impulse=new Et,r.m_motorImpulse=0,r.m_enableMotor=!1,r.m_maxMotorTorque=0,r.m_motorSpeed=0,r.m_enableLimit=!1,r.m_referenceAngle=0,r.m_lowerAngle=0,r.m_upperAngle=0,r.m_indexA=0,r.m_indexB=0,r.m_rA=new bt,r.m_rB=new bt,r.m_localCenterA=new bt,r.m_localCenterB=new bt,r.m_invMassA=0,r.m_invMassB=0,r.m_invIA=0,r.m_invIB=0,r.m_mass=new Pt,r.m_motorMass=0,r.m_limitState=t.b2LimitState.e_inactiveLimit,r.m_qA=new It,r.m_qB=new It,r.m_lalcA=new bt,r.m_lalcB=new bt,r.m_K=new wt,r.m_localAnchorA.Copy(n(i.localAnchorA,bt.ZERO)),r.m_localAnchorB.Copy(n(i.localAnchorB,bt.ZERO)),r.m_referenceAngle=n(i.referenceAngle,0),r.m_impulse.SetZero(),r.m_motorImpulse=0,r.m_lowerAngle=n(i.lowerAngle,0),r.m_upperAngle=n(i.upperAngle,0),r.m_maxMotorTorque=n(i.maxMotorTorque,0),r.m_motorSpeed=n(i.motorSpeed,0),r.m_enableLimit=n(i.enableLimit,!1),r.m_enableMotor=n(i.enableMotor,!1),r.m_limitState=t.b2LimitState.e_inactiveLimit,r}Q(i,e);var r=i.prototype;return r.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=e.positions[this.m_indexA].a,r=e.velocities[this.m_indexA].v,o=e.velocities[this.m_indexA].w,a=e.positions[this.m_indexB].a,s=e.velocities[this.m_indexB].v,c=e.velocities[this.m_indexB].w,l=this.m_qA.SetAngle(n),u=this.m_qB.SetAngle(a);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),It.MulRV(l,this.m_lalcA,this.m_rA),bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),It.MulRV(u,this.m_lalcB,this.m_rB);var h=this.m_invMassA,f=this.m_invMassB,p=this.m_invIA,d=this.m_invIB,m=p+d===0;if(this.m_mass.ex.x=h+f+this.m_rA.y*this.m_rA.y*p+this.m_rB.y*this.m_rB.y*d,this.m_mass.ey.x=-this.m_rA.y*this.m_rA.x*p-this.m_rB.y*this.m_rB.x*d,this.m_mass.ez.x=-this.m_rA.y*p-this.m_rB.y*d,this.m_mass.ex.y=this.m_mass.ey.x,this.m_mass.ey.y=h+f+this.m_rA.x*this.m_rA.x*p+this.m_rB.x*this.m_rB.x*d,this.m_mass.ez.y=this.m_rA.x*p+this.m_rB.x*d,this.m_mass.ex.z=this.m_mass.ez.x,this.m_mass.ey.z=this.m_mass.ez.y,this.m_mass.ez.z=p+d,this.m_motorMass=p+d,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),this.m_enableMotor&&!m||(this.m_motorImpulse=0),this.m_enableLimit&&!m){var v=a-n-this.m_referenceAngle;nt(this.m_upperAngle-this.m_lowerAngle)<2*_?this.m_limitState=t.b2LimitState.e_equalLimits:v<=this.m_lowerAngle?(this.m_limitState!==t.b2LimitState.e_atLowerLimit&&(this.m_impulse.z=0),this.m_limitState=t.b2LimitState.e_atLowerLimit):v>=this.m_upperAngle?(this.m_limitState!==t.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=0),this.m_limitState=t.b2LimitState.e_atUpperLimit):(this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=t.b2LimitState.e_inactiveLimit;if(e.step.warmStarting){this.m_impulse.SelfMul(e.step.dtRatio),this.m_motorImpulse*=e.step.dtRatio;var g=i.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);r.SelfMulSub(h,g),o-=p*(bt.CrossVV(this.m_rA,g)+this.m_motorImpulse+this.m_impulse.z),s.SelfMulAdd(f,g),c+=d*(bt.CrossVV(this.m_rB,g)+this.m_motorImpulse+this.m_impulse.z)}else this.m_impulse.SetZero(),this.m_motorImpulse=0;e.velocities[this.m_indexA].w=o,e.velocities[this.m_indexB].w=c},r.SolveVelocityConstraints=function(e){var n=e.velocities[this.m_indexA].v,r=e.velocities[this.m_indexA].w,o=e.velocities[this.m_indexB].v,a=e.velocities[this.m_indexB].w,s=this.m_invMassA,c=this.m_invMassB,l=this.m_invIA,u=this.m_invIB,h=l+u===0;if(this.m_enableMotor&&this.m_limitState!==t.b2LimitState.e_equalLimits&&!h){var _=a-r-this.m_motorSpeed,f=-this.m_motorMass*_,p=this.m_motorImpulse,d=e.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=at(this.m_motorImpulse+f,-d,d),r-=l*(f=this.m_motorImpulse-p),a+=u*f}if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit&&!h){var m=bt.SubVV(bt.AddVCrossSV(o,a,this.m_rB,bt.s_t0),bt.AddVCrossSV(n,r,this.m_rA,bt.s_t1),i.SolveVelocityConstraints_s_Cdot1),v=a-r,g=this.m_mass.Solve33(m.x,m.y,v,i.SolveVelocityConstraints_s_impulse_v3).SelfNeg();if(this.m_limitState===t.b2LimitState.e_equalLimits)this.m_impulse.SelfAdd(g);else if(this.m_limitState===t.b2LimitState.e_atLowerLimit)if(this.m_impulse.z+g.z<0){var y=-m.x+this.m_impulse.z*this.m_mass.ez.x,x=-m.y+this.m_impulse.z*this.m_mass.ez.y,S=this.m_mass.Solve22(y,x,i.SolveVelocityConstraints_s_reduced_v2);g.x=S.x,g.y=S.y,g.z=-this.m_impulse.z,this.m_impulse.x+=S.x,this.m_impulse.y+=S.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(g);else if(this.m_limitState===t.b2LimitState.e_atUpperLimit)if(this.m_impulse.z+g.z>0){var C=-m.x+this.m_impulse.z*this.m_mass.ez.x,A=-m.y+this.m_impulse.z*this.m_mass.ez.y,b=this.m_mass.Solve22(C,A,i.SolveVelocityConstraints_s_reduced_v2);g.x=b.x,g.y=b.y,g.z=-this.m_impulse.z,this.m_impulse.x+=b.x,this.m_impulse.y+=b.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(g);var T=i.SolveVelocityConstraints_s_P.Set(g.x,g.y);n.SelfMulSub(s,T),r-=l*(bt.CrossVV(this.m_rA,T)+g.z),o.SelfMulAdd(c,T),a+=u*(bt.CrossVV(this.m_rB,T)+g.z)}else{var E=bt.SubVV(bt.AddVCrossSV(o,a,this.m_rB,bt.s_t0),bt.AddVCrossSV(n,r,this.m_rA,bt.s_t1),i.SolveVelocityConstraints_s_Cdot_v2),w=this.m_mass.Solve22(-E.x,-E.y,i.SolveVelocityConstraints_s_impulse_v2);this.m_impulse.x+=w.x,this.m_impulse.y+=w.y,n.SelfMulSub(s,w),r-=l*bt.CrossVV(this.m_rA,w),o.SelfMulAdd(c,w),a+=u*bt.CrossVV(this.m_rB,w)}e.velocities[this.m_indexA].w=r,e.velocities[this.m_indexB].w=a},r.SolvePositionConstraints=function(e){var n=e.positions[this.m_indexA].c,r=e.positions[this.m_indexA].a,o=e.positions[this.m_indexB].c,a=e.positions[this.m_indexB].a,s=this.m_qA.SetAngle(r),c=this.m_qB.SetAngle(a),l=0,u=0,f=this.m_invIA+this.m_invIB===0;if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit&&!f){var p=a-r-this.m_referenceAngle,d=0;if(this.m_limitState===t.b2LimitState.e_equalLimits){var m=at(p-this.m_lowerAngle,-g,g);d=-this.m_motorMass*m,l=nt(m)}else if(this.m_limitState===t.b2LimitState.e_atLowerLimit){var v=p-this.m_lowerAngle;l=-v,v=at(v+_,-g,0),d=-this.m_motorMass*v}else if(this.m_limitState===t.b2LimitState.e_atUpperLimit){var y=p-this.m_upperAngle;l=y,y=at(y-_,0,g),d=-this.m_motorMass*y}r-=this.m_invIA*d,a+=this.m_invIB*d}s.SetAngle(r),c.SetAngle(a),bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var x=It.MulRV(s,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var S=It.MulRV(c,this.m_lalcB,this.m_rB),C=bt.SubVV(bt.AddVV(o,S,bt.s_t0),bt.AddVV(n,x,bt.s_t1),i.SolvePositionConstraints_s_C_v2);u=C.Length();var A=this.m_invMassA,b=this.m_invMassB,T=this.m_invIA,E=this.m_invIB,w=this.m_K;w.ex.x=A+b+T*x.y*x.y+E*S.y*S.y,w.ex.y=-T*x.x*x.y-E*S.x*S.y,w.ey.x=w.ex.y,w.ey.y=A+b+T*x.x*x.x+E*S.x*S.x;var P=w.Solve(C.x,C.y,i.SolvePositionConstraints_s_impulse).SelfNeg();return n.SelfMulSub(A,P),r-=T*bt.CrossVV(x,P),o.SelfMulAdd(b,P),a+=E*bt.CrossVV(S,P),e.positions[this.m_indexA].a=r,e.positions[this.m_indexB].a=a,u<=h&&l<=_},r.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},r.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},r.GetReactionForce=function(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e},r.GetReactionTorque=function(t){return t*this.m_impulse.z},r.GetLocalAnchorA=function(){return this.m_localAnchorA},r.GetLocalAnchorB=function(){return this.m_localAnchorB},r.GetReferenceAngle=function(){return this.m_referenceAngle},r.GetJointAngle=function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle},r.GetJointSpeed=function(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity},r.IsMotorEnabled=function(){return this.m_enableMotor},r.EnableMotor=function(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)},r.GetMotorTorque=function(t){return t*this.m_motorImpulse},r.GetMotorSpeed=function(){return this.m_motorSpeed},r.SetMaxMotorTorque=function(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)},r.GetMaxMotorTorque=function(){return this.m_maxMotorTorque},r.IsLimitEnabled=function(){return this.m_enableLimit},r.EnableLimit=function(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)},r.GetLowerLimit=function(){return this.m_lowerAngle},r.GetUpperLimit=function(){return this.m_upperAngle},r.SetLimits=function(t,e){t===this.m_lowerAngle&&e===this.m_upperAngle||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_impulse.z=0,this.m_lowerAngle=t,this.m_upperAngle=e)},r.SetMotorSpeed=function(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)},r.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2RevoluteJointDef = new b2RevoluteJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerAngle = %.15f;\n",this.m_lowerAngle),t("  jd.upperAngle = %.15f;\n",this.m_upperAngle),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i}(bi);Hi.InitVelocityConstraints_s_P=new bt,Hi.SolveVelocityConstraints_s_P=new bt,Hi.SolveVelocityConstraints_s_Cdot_v2=new bt,Hi.SolveVelocityConstraints_s_Cdot1=new bt,Hi.SolveVelocityConstraints_s_impulse_v3=new Et,Hi.SolveVelocityConstraints_s_reduced_v2=new bt,Hi.SolveVelocityConstraints_s_impulse_v2=new bt,Hi.SolvePositionConstraints_s_C_v2=new bt,Hi.SolvePositionConstraints_s_impulse=new bt;var ji=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_ropeJoint)||this).localAnchorA=new bt(-1,0),n.localAnchorB=new bt(1,0),n.maxLength=0,n}return Q(n,e),n}(Ai),Wi=function(e){function i(i){var r;return(r=e.call(this,i)||this).m_localAnchorA=new bt,r.m_localAnchorB=new bt,r.m_maxLength=0,r.m_length=0,r.m_impulse=0,r.m_indexA=0,r.m_indexB=0,r.m_u=new bt,r.m_rA=new bt,r.m_rB=new bt,r.m_localCenterA=new bt,r.m_localCenterB=new bt,r.m_invMassA=0,r.m_invMassB=0,r.m_invIA=0,r.m_invIB=0,r.m_mass=0,r.m_state=t.b2LimitState.e_inactiveLimit,r.m_qA=new It,r.m_qB=new It,r.m_lalcA=new bt,r.m_lalcB=new bt,r.m_localAnchorA.Copy(n(i.localAnchorA,new bt(-1,0))),r.m_localAnchorB.Copy(n(i.localAnchorB,new bt(1,0))),r.m_maxLength=n(i.maxLength,0),r}Q(i,e);var r=i.prototype;return r.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=e.positions[this.m_indexA].c,r=e.positions[this.m_indexA].a,o=e.velocities[this.m_indexA].v,a=e.velocities[this.m_indexA].w,s=e.positions[this.m_indexB].c,c=e.positions[this.m_indexB].a,l=e.velocities[this.m_indexB].v,u=e.velocities[this.m_indexB].w,_=this.m_qA.SetAngle(r),f=this.m_qB.SetAngle(c);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),It.MulRV(_,this.m_lalcA,this.m_rA),bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),It.MulRV(f,this.m_lalcB,this.m_rB),this.m_u.Copy(s).SelfAdd(this.m_rB).SelfSub(n).SelfSub(this.m_rA),this.m_length=this.m_u.Length();var p=this.m_length-this.m_maxLength;if(this.m_state=p>0?t.b2LimitState.e_atUpperLimit:t.b2LimitState.e_inactiveLimit,!(this.m_length>h))return this.m_u.SetZero(),this.m_mass=0,void(this.m_impulse=0);this.m_u.SelfMul(1/this.m_length);var d=bt.CrossVV(this.m_rA,this.m_u),m=bt.CrossVV(this.m_rB,this.m_u),v=this.m_invMassA+this.m_invIA*d*d+this.m_invMassB+this.m_invIB*m*m;if(this.m_mass=0!==v?1/v:0,e.step.warmStarting){this.m_impulse*=e.step.dtRatio;var g=bt.MulSV(this.m_impulse,this.m_u,i.InitVelocityConstraints_s_P);o.SelfMulSub(this.m_invMassA,g),a-=this.m_invIA*bt.CrossVV(this.m_rA,g),l.SelfMulAdd(this.m_invMassB,g),u+=this.m_invIB*bt.CrossVV(this.m_rB,g)}else this.m_impulse=0;e.velocities[this.m_indexA].w=a,e.velocities[this.m_indexB].w=u},r.SolveVelocityConstraints=function(t){var e=t.velocities[this.m_indexA].v,n=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,a=bt.AddVCrossSV(e,n,this.m_rA,i.SolveVelocityConstraints_s_vpA),s=bt.AddVCrossSV(r,o,this.m_rB,i.SolveVelocityConstraints_s_vpB),c=this.m_length-this.m_maxLength,l=bt.DotVV(this.m_u,bt.SubVV(s,a,bt.s_t0));c<0&&(l+=t.step.inv_dt*c);var u=-this.m_mass*l,h=this.m_impulse;this.m_impulse=it(0,this.m_impulse+u),u=this.m_impulse-h;var _=bt.MulSV(u,this.m_u,i.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,_),n-=this.m_invIA*bt.CrossVV(this.m_rA,_),r.SelfMulAdd(this.m_invMassB,_),o+=this.m_invIB*bt.CrossVV(this.m_rB,_),t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=o},r.SolvePositionConstraints=function(t){var e=t.positions[this.m_indexA].c,n=t.positions[this.m_indexA].a,r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=this.m_qA.SetAngle(n),s=this.m_qB.SetAngle(o);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var c=It.MulRV(a,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var l=It.MulRV(s,this.m_lalcB,this.m_rB),u=this.m_u.Copy(r).SelfAdd(l).SelfSub(e).SelfSub(c),_=u.Normalize(),f=_-this.m_maxLength;f=at(f,0,v);var p=-this.m_mass*f,d=bt.MulSV(p,u,i.SolvePositionConstraints_s_P);return e.SelfMulSub(this.m_invMassA,d),n-=this.m_invIA*bt.CrossVV(c,d),r.SelfMulAdd(this.m_invMassB,d),o+=this.m_invIB*bt.CrossVV(l,d),t.positions[this.m_indexA].a=n,t.positions[this.m_indexB].a=o,_-this.m_maxLength<h},r.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},r.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},r.GetReactionForce=function(t,e){return bt.MulSV(t*this.m_impulse,this.m_u,e)},r.GetReactionTorque=function(){return 0},r.GetLocalAnchorA=function(){return this.m_localAnchorA},r.GetLocalAnchorB=function(){return this.m_localAnchorB},r.SetMaxLength=function(t){this.m_maxLength=t},r.GetMaxLength=function(){return this.m_maxLength},r.GetLimitState=function(){return this.m_state},r.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2RopeJointDef = new b2RopeJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.maxLength = %.15f;\n",this.m_maxLength),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i}(bi);Wi.InitVelocityConstraints_s_P=new bt,Wi.SolveVelocityConstraints_s_vpA=new bt,Wi.SolveVelocityConstraints_s_vpB=new bt,Wi.SolveVelocityConstraints_s_P=new bt,Wi.SolvePositionConstraints_s_P=new bt;var qi=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_weldJoint)||this).localAnchorA=new bt,n.localAnchorB=new bt,n.referenceAngle=0,n.frequencyHz=0,n.dampingRatio=0,n}return Q(n,e),n.prototype.Initialize=function(t,e,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},n}(Ai),Xi=function(t){function e(e){var i;return(i=t.call(this,e)||this).m_frequencyHz=0,i.m_dampingRatio=0,i.m_bias=0,i.m_localAnchorA=new bt,i.m_localAnchorB=new bt,i.m_referenceAngle=0,i.m_gamma=0,i.m_impulse=new Et(0,0,0),i.m_indexA=0,i.m_indexB=0,i.m_rA=new bt,i.m_rB=new bt,i.m_localCenterA=new bt,i.m_localCenterB=new bt,i.m_invMassA=0,i.m_invMassB=0,i.m_invIA=0,i.m_invIB=0,i.m_mass=new Pt,i.m_qA=new It,i.m_qB=new It,i.m_lalcA=new bt,i.m_lalcB=new bt,i.m_K=new Pt,i.m_frequencyHz=n(e.frequencyHz,0),i.m_dampingRatio=n(e.dampingRatio,0),i.m_localAnchorA.Copy(n(e.localAnchorA,bt.ZERO)),i.m_localAnchorB.Copy(n(e.localAnchorB,bt.ZERO)),i.m_referenceAngle=n(e.referenceAngle,0),i.m_impulse.SetZero(),i}Q(e,t);var i=e.prototype;return i.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v,r=t.velocities[this.m_indexA].w,o=t.positions[this.m_indexB].a,s=t.velocities[this.m_indexB].v,c=t.velocities[this.m_indexB].w,l=this.m_qA.SetAngle(n),u=this.m_qB.SetAngle(o);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),It.MulRV(l,this.m_lalcA,this.m_rA),bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),It.MulRV(u,this.m_lalcB,this.m_rB);var h=this.m_invMassA,_=this.m_invMassB,f=this.m_invIA,p=this.m_invIB,d=this.m_K;if(d.ex.x=h+_+this.m_rA.y*this.m_rA.y*f+this.m_rB.y*this.m_rB.y*p,d.ey.x=-this.m_rA.y*this.m_rA.x*f-this.m_rB.y*this.m_rB.x*p,d.ez.x=-this.m_rA.y*f-this.m_rB.y*p,d.ex.y=d.ey.x,d.ey.y=h+_+this.m_rA.x*this.m_rA.x*f+this.m_rB.x*this.m_rB.x*p,d.ez.y=this.m_rA.x*f+this.m_rB.x*p,d.ex.z=d.ez.x,d.ey.z=d.ez.y,d.ez.z=f+p,this.m_frequencyHz>0){d.GetInverse22(this.m_mass);var m=f+p,v=m>0?1/m:0,g=o-n-this.m_referenceAngle,y=2*a*this.m_frequencyHz,x=2*v*this.m_dampingRatio*y,S=v*y*y,C=t.step.dt;this.m_gamma=C*(x+C*S),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=g*C*S*this.m_gamma,m+=this.m_gamma,this.m_mass.ez.z=0!==m?1/m:0}else d.GetSymInverse33(this.m_mass),this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio);var A=e.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);i.SelfMulSub(h,A),r-=f*(bt.CrossVV(this.m_rA,A)+this.m_impulse.z),s.SelfMulAdd(_,A),c+=p*(bt.CrossVV(this.m_rB,A)+this.m_impulse.z)}else this.m_impulse.SetZero();t.velocities[this.m_indexA].w=r,t.velocities[this.m_indexB].w=c},i.SolveVelocityConstraints=function(t){var n=t.velocities[this.m_indexA].v,i=t.velocities[this.m_indexA].w,r=t.velocities[this.m_indexB].v,o=t.velocities[this.m_indexB].w,a=this.m_invMassA,s=this.m_invMassB,c=this.m_invIA,l=this.m_invIB;if(this.m_frequencyHz>0){var u=o-i,h=-this.m_mass.ez.z*(u+this.m_bias+this.m_gamma*this.m_impulse.z);this.m_impulse.z+=h,i-=c*h,o+=l*h;var _=bt.SubVV(bt.AddVCrossSV(r,o,this.m_rB,bt.s_t0),bt.AddVCrossSV(n,i,this.m_rA,bt.s_t1),e.SolveVelocityConstraints_s_Cdot1),f=Pt.MulM33XY(this.m_mass,_.x,_.y,e.SolveVelocityConstraints_s_impulse1).SelfNeg();this.m_impulse.x+=f.x,this.m_impulse.y+=f.y;var p=f;n.SelfMulSub(a,p),i-=c*bt.CrossVV(this.m_rA,p),r.SelfMulAdd(s,p),o+=l*bt.CrossVV(this.m_rB,p)}else{var d=bt.SubVV(bt.AddVCrossSV(r,o,this.m_rB,bt.s_t0),bt.AddVCrossSV(n,i,this.m_rA,bt.s_t1),e.SolveVelocityConstraints_s_Cdot1),m=o-i,v=Pt.MulM33XYZ(this.m_mass,d.x,d.y,m,e.SolveVelocityConstraints_s_impulse).SelfNeg();this.m_impulse.SelfAdd(v);var g=e.SolveVelocityConstraints_s_P.Set(v.x,v.y);n.SelfMulSub(a,g),i-=c*(bt.CrossVV(this.m_rA,g)+v.z),r.SelfMulAdd(s,g),o+=l*(bt.CrossVV(this.m_rB,g)+v.z)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=o},i.SolvePositionConstraints=function(t){var n=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=this.m_qA.SetAngle(i),s=this.m_qB.SetAngle(o),c=this.m_invMassA,l=this.m_invMassB,u=this.m_invIA,f=this.m_invIB;bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var p=It.MulRV(a,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var d,m,v=It.MulRV(s,this.m_lalcB,this.m_rB),g=this.m_K;if(g.ex.x=c+l+p.y*p.y*u+v.y*v.y*f,g.ey.x=-p.y*p.x*u-v.y*v.x*f,g.ez.x=-p.y*u-v.y*f,g.ex.y=g.ey.x,g.ey.y=c+l+p.x*p.x*u+v.x*v.x*f,g.ez.y=p.x*u+v.x*f,g.ex.z=g.ez.x,g.ey.z=g.ez.y,g.ez.z=u+f,this.m_frequencyHz>0){var y=bt.SubVV(bt.AddVV(r,v,bt.s_t0),bt.AddVV(n,p,bt.s_t1),e.SolvePositionConstraints_s_C1);d=y.Length(),m=0;var x=g.Solve22(y.x,y.y,e.SolvePositionConstraints_s_P).SelfNeg();n.SelfMulSub(c,x),i-=u*bt.CrossVV(p,x),r.SelfMulAdd(l,x),o+=f*bt.CrossVV(v,x)}else{var S=bt.SubVV(bt.AddVV(r,v,bt.s_t0),bt.AddVV(n,p,bt.s_t1),e.SolvePositionConstraints_s_C1),C=o-i-this.m_referenceAngle;d=S.Length(),m=nt(C);var A=g.Solve33(S.x,S.y,C,e.SolvePositionConstraints_s_impulse).SelfNeg(),b=e.SolvePositionConstraints_s_P.Set(A.x,A.y);n.SelfMulSub(c,b),i-=u*(bt.CrossVV(this.m_rA,b)+A.z),r.SelfMulAdd(l,b),o+=f*(bt.CrossVV(this.m_rB,b)+A.z)}return t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,d<=h&&m<=_},i.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},i.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},i.GetReactionForce=function(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e},i.GetReactionTorque=function(t){return t*this.m_impulse.z},i.GetLocalAnchorA=function(){return this.m_localAnchorA},i.GetLocalAnchorB=function(){return this.m_localAnchorB},i.GetReferenceAngle=function(){return this.m_referenceAngle},i.SetFrequency=function(t){this.m_frequencyHz=t},i.GetFrequency=function(){return this.m_frequencyHz},i.SetDampingRatio=function(t){this.m_dampingRatio=t},i.GetDampingRatio=function(){return this.m_dampingRatio},i.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2WeldJointDef = new b2WeldJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},e}(bi);Xi.InitVelocityConstraints_s_P=new bt,Xi.SolveVelocityConstraints_s_Cdot1=new bt,Xi.SolveVelocityConstraints_s_impulse1=new bt,Xi.SolveVelocityConstraints_s_impulse=new Et,Xi.SolveVelocityConstraints_s_P=new bt,Xi.SolvePositionConstraints_s_C1=new bt,Xi.SolvePositionConstraints_s_P=new bt,Xi.SolvePositionConstraints_s_impulse=new Et;var Yi=function(e){function n(){var n;return(n=e.call(this,t.b2JointType.e_wheelJoint)||this).localAnchorA=new bt(0,0),n.localAnchorB=new bt(0,0),n.localAxisA=new bt(1,0),n.enableMotor=!1,n.maxMotorTorque=0,n.motorSpeed=0,n.frequencyHz=2,n.dampingRatio=.7,n}return Q(n,e),n.prototype.Initialize=function(t,e,n,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.bodyA.GetLocalVector(i,this.localAxisA)},n}(Ai),Ki=function(t){function e(e){var i;return(i=t.call(this,e)||this).m_frequencyHz=0,i.m_dampingRatio=0,i.m_localAnchorA=new bt,i.m_localAnchorB=new bt,i.m_localXAxisA=new bt,i.m_localYAxisA=new bt,i.m_impulse=0,i.m_motorImpulse=0,i.m_springImpulse=0,i.m_maxMotorTorque=0,i.m_motorSpeed=0,i.m_enableMotor=!1,i.m_indexA=0,i.m_indexB=0,i.m_localCenterA=new bt,i.m_localCenterB=new bt,i.m_invMassA=0,i.m_invMassB=0,i.m_invIA=0,i.m_invIB=0,i.m_ax=new bt,i.m_ay=new bt,i.m_sAx=0,i.m_sBx=0,i.m_sAy=0,i.m_sBy=0,i.m_mass=0,i.m_motorMass=0,i.m_springMass=0,i.m_bias=0,i.m_gamma=0,i.m_qA=new It,i.m_qB=new It,i.m_lalcA=new bt,i.m_lalcB=new bt,i.m_rA=new bt,i.m_rB=new bt,i.m_frequencyHz=n(e.frequencyHz,2),i.m_dampingRatio=n(e.dampingRatio,.7),i.m_localAnchorA.Copy(n(e.localAnchorA,bt.ZERO)),i.m_localAnchorB.Copy(n(e.localAnchorB,bt.ZERO)),i.m_localXAxisA.Copy(n(e.localAxisA,bt.UNITX)),bt.CrossOneV(i.m_localXAxisA,i.m_localYAxisA),i.m_maxMotorTorque=n(e.maxMotorTorque,0),i.m_motorSpeed=n(e.motorSpeed,0),i.m_enableMotor=n(e.enableMotor,!1),i.m_ax.SetZero(),i.m_ay.SetZero(),i}Q(e,t);var i=e.prototype;return i.GetMotorSpeed=function(){return this.m_motorSpeed},i.GetMaxMotorTorque=function(){return this.m_maxMotorTorque},i.SetSpringFrequencyHz=function(t){this.m_frequencyHz=t},i.GetSpringFrequencyHz=function(){return this.m_frequencyHz},i.SetSpringDampingRatio=function(t){this.m_dampingRatio=t},i.GetSpringDampingRatio=function(){return this.m_dampingRatio},i.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=this.m_invMassA,i=this.m_invMassB,r=this.m_invIA,o=this.m_invIB,s=t.positions[this.m_indexA].c,c=t.positions[this.m_indexA].a,l=t.velocities[this.m_indexA].v,u=t.velocities[this.m_indexA].w,h=t.positions[this.m_indexB].c,_=t.positions[this.m_indexB].a,f=t.velocities[this.m_indexB].v,p=t.velocities[this.m_indexB].w,d=this.m_qA.SetAngle(c),m=this.m_qB.SetAngle(_);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var v=It.MulRV(d,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var g=It.MulRV(m,this.m_lalcB,this.m_rB),y=bt.SubVV(bt.AddVV(h,g,bt.s_t0),bt.AddVV(s,v,bt.s_t1),e.InitVelocityConstraints_s_d);if(It.MulRV(d,this.m_localYAxisA,this.m_ay),this.m_sAy=bt.CrossVV(bt.AddVV(y,v,bt.s_t0),this.m_ay),this.m_sBy=bt.CrossVV(g,this.m_ay),this.m_mass=n+i+r*this.m_sAy*this.m_sAy+o*this.m_sBy*this.m_sBy,this.m_mass>0&&(this.m_mass=1/this.m_mass),this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_frequencyHz>0){It.MulRV(d,this.m_localXAxisA,this.m_ax),this.m_sAx=bt.CrossVV(bt.AddVV(y,v,bt.s_t0),this.m_ax),this.m_sBx=bt.CrossVV(g,this.m_ax);var x=n+i+r*this.m_sAx*this.m_sAx+o*this.m_sBx*this.m_sBx;if(x>0){this.m_springMass=1/x;var S=bt.DotVV(y,this.m_ax),C=2*a*this.m_frequencyHz,A=2*this.m_springMass*this.m_dampingRatio*C,b=this.m_springMass*C*C,T=t.step.dt;this.m_gamma=T*(A+T*b),this.m_gamma>0&&(this.m_gamma=1/this.m_gamma),this.m_bias=S*T*b*this.m_gamma,this.m_springMass=x+this.m_gamma,this.m_springMass>0&&(this.m_springMass=1/this.m_springMass)}}else this.m_springImpulse=0;if(this.m_enableMotor?(this.m_motorMass=r+o,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass)):(this.m_motorMass=0,this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse*=t.step.dtRatio,this.m_springImpulse*=t.step.dtRatio,this.m_motorImpulse*=t.step.dtRatio;var E=bt.AddVV(bt.MulSV(this.m_impulse,this.m_ay,bt.s_t0),bt.MulSV(this.m_springImpulse,this.m_ax,bt.s_t1),e.InitVelocityConstraints_s_P),w=this.m_impulse*this.m_sAy+this.m_springImpulse*this.m_sAx+this.m_motorImpulse,P=this.m_impulse*this.m_sBy+this.m_springImpulse*this.m_sBx+this.m_motorImpulse;l.SelfMulSub(this.m_invMassA,E),u-=this.m_invIA*w,f.SelfMulAdd(this.m_invMassB,E),p+=this.m_invIB*P}else this.m_impulse=0,this.m_springImpulse=0,this.m_motorImpulse=0;t.velocities[this.m_indexA].w=u,t.velocities[this.m_indexB].w=p},i.SolveVelocityConstraints=function(t){var n=this.m_invMassA,i=this.m_invMassB,r=this.m_invIA,o=this.m_invIB,a=t.velocities[this.m_indexA].v,s=t.velocities[this.m_indexA].w,c=t.velocities[this.m_indexB].v,l=t.velocities[this.m_indexB].w,u=bt.DotVV(this.m_ax,bt.SubVV(c,a,bt.s_t0))+this.m_sBx*l-this.m_sAx*s,h=-this.m_springMass*(u+this.m_bias+this.m_gamma*this.m_springImpulse);this.m_springImpulse+=h;var _=bt.MulSV(h,this.m_ax,e.SolveVelocityConstraints_s_P),f=h*this.m_sAx,p=h*this.m_sBx;a.SelfMulSub(n,_),s-=r*f,c.SelfMulAdd(i,_);var d=(l+=o*p)-s-this.m_motorSpeed,m=-this.m_motorMass*d,v=this.m_motorImpulse,g=t.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=at(this.m_motorImpulse+m,-g,g),s-=r*(m=this.m_motorImpulse-v),l+=o*m;var y=bt.DotVV(this.m_ay,bt.SubVV(c,a,bt.s_t0))+this.m_sBy*l-this.m_sAy*s,x=-this.m_mass*y;this.m_impulse+=x;var S=bt.MulSV(x,this.m_ay,e.SolveVelocityConstraints_s_P),C=x*this.m_sAy,A=x*this.m_sBy;a.SelfMulSub(n,S),s-=r*C,c.SelfMulAdd(i,S),l+=o*A,t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=l},i.SolvePositionConstraints=function(t){var n=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=this.m_qA.SetAngle(i),s=this.m_qB.SetAngle(o);bt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var c=It.MulRV(a,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var l,u=It.MulRV(s,this.m_lalcB,this.m_rB),_=bt.AddVV(bt.SubVV(r,n,bt.s_t0),bt.SubVV(u,c,bt.s_t1),e.SolvePositionConstraints_s_d),f=It.MulRV(a,this.m_localYAxisA,this.m_ay),p=bt.CrossVV(bt.AddVV(_,c,bt.s_t0),f),d=bt.CrossVV(u,f),m=bt.DotVV(_,this.m_ay),v=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_sAy*this.m_sAy+this.m_invIB*this.m_sBy*this.m_sBy;l=0!==v?-m/v:0;var g=bt.MulSV(l,f,e.SolvePositionConstraints_s_P),y=l*p,x=l*d;return n.SelfMulSub(this.m_invMassA,g),i-=this.m_invIA*y,r.SelfMulAdd(this.m_invMassB,g),o+=this.m_invIB*x,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=o,nt(m)<=h},i.GetDefinition=function(t){return t},i.GetAnchorA=function(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)},i.GetAnchorB=function(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)},i.GetReactionForce=function(t,e){return e.x=t*(this.m_impulse*this.m_ay.x+this.m_springImpulse*this.m_ax.x),e.y=t*(this.m_impulse*this.m_ay.y+this.m_springImpulse*this.m_ax.y),e},i.GetReactionTorque=function(t){return t*this.m_motorImpulse},i.GetLocalAnchorA=function(){return this.m_localAnchorA},i.GetLocalAnchorB=function(){return this.m_localAnchorB},i.GetLocalAxisA=function(){return this.m_localXAxisA},i.GetJointTranslation=function(){return this.GetPrismaticJointTranslation()},i.GetJointLinearSpeed=function(){return this.GetPrismaticJointSpeed()},i.GetJointAngle=function(){return this.GetRevoluteJointAngle()},i.GetJointAngularSpeed=function(){return this.GetRevoluteJointSpeed()},i.GetPrismaticJointTranslation=function(){var t=this.m_bodyA,e=this.m_bodyB,n=t.GetWorldPoint(this.m_localAnchorA,new bt),i=e.GetWorldPoint(this.m_localAnchorB,new bt),r=bt.SubVV(i,n,new bt),o=t.GetWorldVector(this.m_localXAxisA,new bt);return bt.DotVV(r,o)},i.GetPrismaticJointSpeed=function(){var t=this.m_bodyA,e=this.m_bodyB;bt.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);var n=It.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);bt.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);var i=It.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),r=bt.AddVV(t.m_sweep.c,n,bt.s_t0),o=bt.AddVV(e.m_sweep.c,i,bt.s_t1),a=bt.SubVV(o,r,bt.s_t2),s=t.GetWorldVector(this.m_localXAxisA,new bt),c=t.m_linearVelocity,l=e.m_linearVelocity,u=t.m_angularVelocity,h=e.m_angularVelocity;return bt.DotVV(a,bt.CrossSV(u,s,bt.s_t0))+bt.DotVV(s,bt.SubVV(bt.AddVCrossSV(l,h,i,bt.s_t0),bt.AddVCrossSV(c,u,n,bt.s_t1),bt.s_t0))},i.GetRevoluteJointAngle=function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a},i.GetRevoluteJointSpeed=function(){var t=this.m_bodyA.m_angularVelocity;return this.m_bodyB.m_angularVelocity-t},i.IsMotorEnabled=function(){return this.m_enableMotor},i.EnableMotor=function(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)},i.SetMotorSpeed=function(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)},i.SetMaxMotorTorque=function(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)},i.GetMotorTorque=function(t){return t*this.m_motorImpulse},i.Dump=function(t){var e=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;t("  const jd: b2WheelJointDef = new b2WheelJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",n),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},e}(bi);function Ji(t,e){return ht(t*e)}function Qi(t,e){return t>e?t:e}Ki.InitVelocityConstraints_s_d=new bt,Ki.InitVelocityConstraints_s_P=new bt,Ki.SolveVelocityConstraints_s_P=new bt,Ki.SolvePositionConstraints_s_d=new bt,Ki.SolvePositionConstraints_s_P=new bt;var Zi=function(){function t(t){this._other=null,this.prev=null,this.next=null,this.contact=t}return t.prototype.Reset=function(){this._other=null,this.prev=null,this.next=null},K(t,[{key:"other",get:function(){if(null===this._other)throw new Error;return this._other},set:function(t){if(null!==this._other)throw new Error;this._other=t}}]),t}(),$i=function(){function t(){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_prev=null,this.m_next=null,this.m_nodeA=new Zi(this),this.m_nodeB=new Zi(this),this.m_indexA=0,this.m_indexB=0,this.m_manifold=new ye,this.m_toiCount=0,this.m_toi=0,this.m_friction=0,this.m_restitution=0,this.m_tangentSpeed=0,this.m_oldManifold=new ye}var e=t.prototype;return e.GetManifold=function(){return this.m_manifold},e.GetWorldManifold=function(t){var e=this.m_fixtureA.GetBody(),n=this.m_fixtureB.GetBody(),i=this.GetShapeA(),r=this.GetShapeB();t.Initialize(this.m_manifold,e.GetTransform(),i.m_radius,n.GetTransform(),r.m_radius)},e.IsTouching=function(){return this.m_touchingFlag},e.SetEnabled=function(t){this.m_enabledFlag=t},e.IsEnabled=function(){return this.m_enabledFlag},e.GetNext=function(){return this.m_next},e.GetFixtureA=function(){return this.m_fixtureA},e.GetChildIndexA=function(){return this.m_indexA},e.GetShapeA=function(){return this.m_fixtureA.GetShape()},e.GetFixtureB=function(){return this.m_fixtureB},e.GetChildIndexB=function(){return this.m_indexB},e.GetShapeB=function(){return this.m_fixtureB.GetShape()},e.FlagForFiltering=function(){this.m_filterFlag=!0},e.SetFriction=function(t){this.m_friction=t},e.GetFriction=function(){return this.m_friction},e.ResetFriction=function(){this.m_friction=Ji(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction)},e.SetRestitution=function(t){this.m_restitution=t},e.GetRestitution=function(){return this.m_restitution},e.ResetRestitution=function(){this.m_restitution=Qi(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)},e.SetTangentSpeed=function(t){this.m_tangentSpeed=t},e.GetTangentSpeed=function(){return this.m_tangentSpeed},e.Reset=function(t,e,n,i){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!0,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_fixtureA=t,this.m_fixtureB=n,this.m_indexA=e,this.m_indexB=i,this.m_manifold.pointCount=0,this.m_prev=null,this.m_next=null,this.m_nodeA.Reset(),this.m_nodeB.Reset(),this.m_toiCount=0,this.m_friction=Ji(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction),this.m_restitution=Qi(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)},e.Update=function(t){var e=this.m_oldManifold;this.m_oldManifold=this.m_manifold,this.m_manifold=e,this.m_enabledFlag=!0;var n=!1,i=this.m_touchingFlag,r=this.m_fixtureA.IsSensor(),o=this.m_fixtureB.IsSensor(),a=r||o,s=this.m_fixtureA.GetBody(),c=this.m_fixtureB.GetBody(),l=s.GetTransform(),u=c.GetTransform();if(a){var h=this.GetShapeA(),_=this.GetShapeB();n=De(h,this.m_indexA,_,this.m_indexB,l,u),this.m_manifold.pointCount=0}else{this.Evaluate(this.m_manifold,l,u),n=this.m_manifold.pointCount>0;for(var f=0;f<this.m_manifold.pointCount;++f){var p=this.m_manifold.points[f];p.normalImpulse=0,p.tangentImpulse=0;for(var d=p.id,m=0;m<this.m_oldManifold.pointCount;++m){var v=this.m_oldManifold.points[m];if(v.id.key===d.key){p.normalImpulse=v.normalImpulse,p.tangentImpulse=v.tangentImpulse;break}}}n!==i&&(s.SetAwake(!0),c.SetAwake(!0))}this.m_touchingFlag=n,!i&&n&&t&&t.BeginContact(this),i&&!n&&t&&t.EndContact(this),!a&&n&&t&&t.PreSolve(this,this.m_oldManifold)},e.ComputeTOI=function(e,n){var i=t.ComputeTOI_s_input;i.proxyA.SetShape(this.GetShapeA(),this.m_indexA),i.proxyB.SetShape(this.GetShapeB(),this.m_indexB),i.sweepA.Copy(e),i.sweepB.Copy(n),i.tMax=h;var r=t.ComputeTOI_s_output;return un(r,i),r.t},t}();$i.ComputeTOI_s_input=new Je,$i.ComputeTOI_s_output=new Ze;var tr=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,e,n){fn(t,this.GetShapeA(),e,this.GetShapeB(),n)},e}($i),er=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,e,n){Un(t,this.GetShapeA(),e,this.GetShapeB(),n)},e}($i),nr=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,e,n){vn(t,this.GetShapeA(),e,this.GetShapeB(),n)},e}($i),ir=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,e,n){Qn(t,this.GetShapeA(),e,this.GetShapeB(),n)},e}($i),rr=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,e,n){ri(t,this.GetShapeA(),e,this.GetShapeB(),n)},e}($i),or=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,n,i){var r=e.Evaluate_s_edge;this.GetShapeA().GetChildEdge(r,this.m_indexA),Qn(t,r,n,this.GetShapeB(),i)},e}($i);or.Evaluate_s_edge=new ui;var ar=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e.Create=function(){return new e},e.Destroy=function(){},e.prototype.Evaluate=function(t,n,i){var r=e.Evaluate_s_edge;this.GetShapeA().GetChildEdge(r,this.m_indexA),ri(t,r,n,this.GetShapeB(),i)},e}($i);ar.Evaluate_s_edge=new ui;var sr=function(){this.pool=[],this.createFcn=null,this.destroyFcn=null,this.primary=!1},cr=function(){function e(){this.m_registers=[],this.InitializeRegisters()}var n=e.prototype;return n.AddType=function(t,e,n,i){var r=[];function o(){return r.pop()||t()}function a(t){r.push(t)}this.m_registers[n][i].pool=r,this.m_registers[n][i].createFcn=o,this.m_registers[n][i].destroyFcn=a,this.m_registers[n][i].primary=!0,n!==i&&(this.m_registers[i][n].pool=r,this.m_registers[i][n].createFcn=o,this.m_registers[i][n].destroyFcn=a,this.m_registers[i][n].primary=!1)},n.InitializeRegisters=function(){for(var e=0;e<t.b2ShapeType.e_shapeTypeCount;e++){this.m_registers[e]=[];for(var n=0;n<t.b2ShapeType.e_shapeTypeCount;n++)this.m_registers[e][n]=new sr}this.AddType(tr.Create,tr.Destroy,t.b2ShapeType.e_circleShape,t.b2ShapeType.e_circleShape),this.AddType(nr.Create,nr.Destroy,t.b2ShapeType.e_polygonShape,t.b2ShapeType.e_circleShape),this.AddType(er.Create,er.Destroy,t.b2ShapeType.e_polygonShape,t.b2ShapeType.e_polygonShape),this.AddType(ir.Create,ir.Destroy,t.b2ShapeType.e_edgeShape,t.b2ShapeType.e_circleShape),this.AddType(rr.Create,rr.Destroy,t.b2ShapeType.e_edgeShape,t.b2ShapeType.e_polygonShape),this.AddType(or.Create,or.Destroy,t.b2ShapeType.e_chainShape,t.b2ShapeType.e_circleShape),this.AddType(ar.Create,ar.Destroy,t.b2ShapeType.e_chainShape,t.b2ShapeType.e_polygonShape)},n.Create=function(t,e,n,i){var r=t.GetType(),o=n.GetType(),a=this.m_registers[r][o];if(a.createFcn){var s=a.createFcn();return a.primary?s.Reset(t,e,n,i):s.Reset(n,i,t,e),s}return null},n.Destroy=function(t){var e=t.m_fixtureA.GetType(),n=t.m_fixtureB.GetType(),i=this.m_registers[e][n];i.destroyFcn&&i.destroyFcn(t)},e}(),lr=function(){function t(){}var e=t.prototype;return e.SayGoodbyeJoint=function(){},e.SayGoodbyeFixture=function(){},e.SayGoodbyeParticleGroup=function(){},e.SayGoodbyeParticle=function(){},t}(),ur=function(){function e(){}var n=e.prototype;return n.ShouldCollide=function(e,n){var i=e.GetBody(),r=n.GetBody();if(r.GetType()===t.b2BodyType.b2_staticBody&&i.GetType()===t.b2BodyType.b2_staticBody)return!1;if(!r.ShouldCollideConnected(i))return!1;var o=e.GetFilterData(),a=n.GetFilterData();return o.groupIndex===a.groupIndex&&0!==o.groupIndex?o.groupIndex>0:0!=(o.maskBits&a.categoryBits)&&0!=(o.categoryBits&a.maskBits)},n.ShouldCollideFixtureParticle=function(){return!0},n.ShouldCollideParticleParticle=function(){return!0},e}();ur.b2_defaultFilter=new ur;var hr=function(){this.normalImpulses=J(s),this.tangentImpulses=J(s),this.count=0},_r=function(){function t(){}var e=t.prototype;return e.BeginContact=function(){},e.EndContact=function(){},e.BeginContactFixtureParticle=function(){},e.EndContactFixtureParticle=function(){},e.BeginContactParticleParticle=function(){},e.EndContactParticleParticle=function(){},e.PreSolve=function(){},e.PostSolve=function(){},t}();_r.b2_defaultListener=new _r;var fr=function(){function t(){}var e=t.prototype;return e.ReportFixture=function(){return!0},e.ReportParticle=function(){return!1},e.ShouldQueryParticleSystem=function(){return!0},t}(),pr=function(){function t(){}var e=t.prototype;return e.ReportFixture=function(t,e,n,i){return i},e.ReportParticle=function(){return 0},e.ShouldQueryParticleSystem=function(){return!0},t}(),dr=function(){function e(){this.m_broadPhase=new Ge,this.m_contactList=null,this.m_contactCount=0,this.m_contactFilter=ur.b2_defaultFilter,this.m_contactListener=_r.b2_defaultListener,this.m_contactFactory=new cr}var n=e.prototype;return n.AddPair=function(t,e){var n=t.fixture,i=e.fixture,r=t.childIndex,o=e.childIndex,a=n.GetBody(),s=i.GetBody();if(a!==s){for(var c=s.GetContactList();c;){if(c.other===a){var l=c.contact.GetFixtureA(),u=c.contact.GetFixtureB(),h=c.contact.GetChildIndexA(),_=c.contact.GetChildIndexB();if(l===n&&u===i&&h===r&&_===o)return;if(l===i&&u===n&&h===o&&_===r)return}c=c.next}if(!this.m_contactFilter||this.m_contactFilter.ShouldCollide(n,i)){var f=this.m_contactFactory.Create(n,r,i,o);null!==f&&(n=f.GetFixtureA(),i=f.GetFixtureB(),r=f.GetChildIndexA(),o=f.GetChildIndexB(),a=n.m_body,s=i.m_body,f.m_prev=null,f.m_next=this.m_contactList,null!==this.m_contactList&&(this.m_contactList.m_prev=f),this.m_contactList=f,f.m_nodeA.other=s,f.m_nodeA.prev=null,f.m_nodeA.next=a.m_contactList,null!==a.m_contactList&&(a.m_contactList.prev=f.m_nodeA),a.m_contactList=f.m_nodeA,f.m_nodeB.other=a,f.m_nodeB.prev=null,f.m_nodeB.next=s.m_contactList,null!==s.m_contactList&&(s.m_contactList.prev=f.m_nodeB),s.m_contactList=f.m_nodeB,n.IsSensor()||i.IsSensor()||(a.SetAwake(!0),s.SetAwake(!0)),++this.m_contactCount)}}},n.FindNewContacts=function(){var t=this;this.m_broadPhase.UpdatePairs((function(e,n){t.AddPair(e,n)}))},n.Destroy=function(t){var e=t.GetFixtureA(),n=t.GetFixtureB(),i=e.GetBody(),r=n.GetBody();this.m_contactListener&&t.IsTouching()&&this.m_contactListener.EndContact(t),t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_contactList&&(this.m_contactList=t.m_next),t.m_nodeA.prev&&(t.m_nodeA.prev.next=t.m_nodeA.next),t.m_nodeA.next&&(t.m_nodeA.next.prev=t.m_nodeA.prev),t.m_nodeA===i.m_contactList&&(i.m_contactList=t.m_nodeA.next),t.m_nodeB.prev&&(t.m_nodeB.prev.next=t.m_nodeB.next),t.m_nodeB.next&&(t.m_nodeB.next.prev=t.m_nodeB.prev),t.m_nodeB===r.m_contactList&&(r.m_contactList=t.m_nodeB.next),t.m_manifold.pointCount>0&&!e.IsSensor()&&!n.IsSensor()&&(e.GetBody().SetAwake(!0),n.GetBody().SetAwake(!0)),this.m_contactFactory.Destroy(t),--this.m_contactCount},n.Collide=function(){for(var e=this.m_contactList;e;){var n=e.GetFixtureA(),i=e.GetFixtureB(),r=e.GetChildIndexA(),o=e.GetChildIndexB(),a=n.GetBody(),s=i.GetBody();if(e.m_filterFlag){if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(n,i)){var c=e;e=c.m_next,this.Destroy(c);continue}e.m_filterFlag=!1}var l=a.IsAwake()&&a.m_type!==t.b2BodyType.b2_staticBody,u=s.IsAwake()&&s.m_type!==t.b2BodyType.b2_staticBody;if(l||u){var h=n.m_proxies[r].treeNode,_=i.m_proxies[o].treeNode;if(Ee(h.aabb,_.aabb))e.Update(this.m_contactListener),e=e.m_next;else{var f=e;e=f.m_next,this.Destroy(f)}}else e=e.m_next}},e}(),mr=function(){function t(){this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0}return t.prototype.Reset=function(){return this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0,this},t}(),vr=function(){function t(){this.dt=0,this.inv_dt=0,this.dtRatio=0,this.velocityIterations=0,this.positionIterations=0,this.particleIterations=0,this.warmStarting=!1}return t.prototype.Copy=function(t){return this.dt=t.dt,this.inv_dt=t.inv_dt,this.dtRatio=t.dtRatio,this.positionIterations=t.positionIterations,this.velocityIterations=t.velocityIterations,this.particleIterations=t.particleIterations,this.warmStarting=t.warmStarting,this},t}(),gr=function(){function t(){this.c=new bt,this.a=0}return t.MakeArray=function(e){return X(e,(function(){return new t}))},t}(),yr=function(){function t(){this.v=new bt,this.w=0}return t.MakeArray=function(e){return X(e,(function(){return new t}))},t}(),xr=function(){this.step=new vr},Sr=!1,Cr=function(){function t(){this.rA=new bt,this.rB=new bt,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0}return t.MakeArray=function(e){return X(e,(function(){return new t}))},t}(),Ar=function(){function t(){this.points=Cr.MakeArray(s),this.normal=new bt,this.tangent=new bt,this.normalMass=new wt,this.K=new wt,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.invIA=0,this.invIB=0,this.friction=0,this.restitution=0,this.tangentSpeed=0,this.pointCount=0,this.contactIndex=0}return t.MakeArray=function(e){return X(e,(function(){return new t}))},t}(),br=function(){function e(){this.localPoints=bt.MakeArray(s),this.localNormal=new bt,this.localPoint=new bt,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.localCenterA=new bt,this.localCenterB=new bt,this.invIA=0,this.invIB=0,this.type=t.b2ManifoldType.e_unknown,this.radiusA=0,this.radiusB=0,this.pointCount=0}return e.MakeArray=function(t){return X(t,(function(){return new e}))},e}(),Tr=function(){this.step=new vr,this.count=0},Er=function(){function e(){this.normal=new bt,this.point=new bt,this.separation=0}return e.prototype.Initialize=function(n,i,r,o){var a=e.Initialize_s_pointA,s=e.Initialize_s_pointB,c=e.Initialize_s_planePoint,l=e.Initialize_s_clipPoint;switch(n.type){case t.b2ManifoldType.e_circles:Rt.MulXV(i,n.localPoint,a),Rt.MulXV(r,n.localPoints[0],s),bt.SubVV(s,a,this.normal).SelfNormalize(),bt.MidVV(a,s,this.point),this.separation=bt.DotVV(bt.SubVV(s,a,bt.s_t0),this.normal)-n.radiusA-n.radiusB;break;case t.b2ManifoldType.e_faceA:It.MulRV(i.q,n.localNormal,this.normal),Rt.MulXV(i,n.localPoint,c),Rt.MulXV(r,n.localPoints[o],l),this.separation=bt.DotVV(bt.SubVV(l,c,bt.s_t0),this.normal)-n.radiusA-n.radiusB,this.point.Copy(l);break;case t.b2ManifoldType.e_faceB:It.MulRV(r.q,n.localNormal,this.normal),Rt.MulXV(r,n.localPoint,c),Rt.MulXV(i,n.localPoints[o],l),this.separation=bt.DotVV(bt.SubVV(l,c,bt.s_t0),this.normal)-n.radiusA-n.radiusB,this.point.Copy(l),this.normal.SelfNeg()}},e}();Er.Initialize_s_pointA=new bt,Er.Initialize_s_pointB=new bt,Er.Initialize_s_planePoint=new bt,Er.Initialize_s_clipPoint=new bt;var wr=function(){function t(){this.m_step=new vr,this.m_positionConstraints=br.MakeArray(1024),this.m_velocityConstraints=Ar.MakeArray(1024),this.m_count=0}var e=t.prototype;return e.Initialize=function(t){if(this.m_step.Copy(t.step),this.m_count=t.count,this.m_positionConstraints.length<this.m_count)for(var e=rt(2*this.m_positionConstraints.length,this.m_count);this.m_positionConstraints.length<e;)this.m_positionConstraints[this.m_positionConstraints.length]=new br;if(this.m_velocityConstraints.length<this.m_count)for(var n=rt(2*this.m_velocityConstraints.length,this.m_count);this.m_velocityConstraints.length<n;)this.m_velocityConstraints[this.m_velocityConstraints.length]=new Ar;this.m_positions=t.positions,this.m_velocities=t.velocities,this.m_contacts=t.contacts;for(var i=0;i<this.m_count;++i){var r=this.m_contacts[i],o=r.m_fixtureA,a=r.m_fixtureB,s=o.GetShape(),c=a.GetShape(),l=s.m_radius,u=c.m_radius,h=o.GetBody(),_=a.GetBody(),f=r.GetManifold(),p=f.pointCount,d=this.m_velocityConstraints[i];d.friction=r.m_friction,d.restitution=r.m_restitution,d.tangentSpeed=r.m_tangentSpeed,d.indexA=h.m_islandIndex,d.indexB=_.m_islandIndex,d.invMassA=h.m_invMass,d.invMassB=_.m_invMass,d.invIA=h.m_invI,d.invIB=_.m_invI,d.contactIndex=i,d.pointCount=p,d.K.SetZero(),d.normalMass.SetZero();var m=this.m_positionConstraints[i];m.indexA=h.m_islandIndex,m.indexB=_.m_islandIndex,m.invMassA=h.m_invMass,m.invMassB=_.m_invMass,m.localCenterA.Copy(h.m_sweep.localCenter),m.localCenterB.Copy(_.m_sweep.localCenter),m.invIA=h.m_invI,m.invIB=_.m_invI,m.localNormal.Copy(f.localNormal),m.localPoint.Copy(f.localPoint),m.pointCount=p,m.radiusA=l,m.radiusB=u,m.type=f.type;for(var v=0;v<p;++v){var g=f.points[v],y=d.points[v];this.m_step.warmStarting?(y.normalImpulse=this.m_step.dtRatio*g.normalImpulse,y.tangentImpulse=this.m_step.dtRatio*g.tangentImpulse):(y.normalImpulse=0,y.tangentImpulse=0),y.rA.SetZero(),y.rB.SetZero(),y.normalMass=0,y.tangentMass=0,y.velocityBias=0,m.localPoints[v].Copy(g.localPoint)}}return this},e.InitializeVelocityConstraints=function(){for(var e=t.InitializeVelocityConstraints_s_xfA,n=t.InitializeVelocityConstraints_s_xfB,i=t.InitializeVelocityConstraints_s_worldManifold,r=1e3,o=0;o<this.m_count;++o){var a=this.m_velocityConstraints[o],s=this.m_positionConstraints[o],c=s.radiusA,l=s.radiusB,u=this.m_contacts[a.contactIndex].GetManifold(),h=a.indexA,_=a.indexB,f=a.invMassA,p=a.invMassB,d=a.invIA,v=a.invIB,g=s.localCenterA,y=s.localCenterB,x=this.m_positions[h].c,S=this.m_positions[h].a,C=this.m_velocities[h].v,A=this.m_velocities[h].w,b=this.m_positions[_].c,T=this.m_positions[_].a,E=this.m_velocities[_].v,w=this.m_velocities[_].w;e.q.SetAngle(S),n.q.SetAngle(T),bt.SubVV(x,It.MulRV(e.q,g,bt.s_t0),e.p),bt.SubVV(b,It.MulRV(n.q,y,bt.s_t0),n.p),i.Initialize(u,e,c,n,l),a.normal.Copy(i.normal),bt.CrossVOne(a.normal,a.tangent);for(var P=a.pointCount,I=0;I<P;++I){var R=a.points[I];bt.SubVV(i.points[I],x,R.rA),bt.SubVV(i.points[I],b,R.rB);var D=bt.CrossVV(R.rA,a.normal),B=bt.CrossVV(R.rB,a.normal),M=f+p+d*D*D+v*B*B;R.normalMass=M>0?1/M:0;var O=a.tangent,N=bt.CrossVV(R.rA,O),L=bt.CrossVV(R.rB,O),F=f+p+d*N*N+v*L*L;R.tangentMass=F>0?1/F:0,R.velocityBias=0;var z=bt.DotVV(a.normal,bt.SubVV(bt.AddVCrossSV(E,w,R.rB,bt.s_t0),bt.AddVCrossSV(C,A,R.rA,bt.s_t1),bt.s_t0));z<-m&&(R.velocityBias+=-a.restitution*z)}if(2===a.pointCount&&Sr){var G=a.points[0],V=a.points[1],U=bt.CrossVV(G.rA,a.normal),k=bt.CrossVV(G.rB,a.normal),H=bt.CrossVV(V.rA,a.normal),j=bt.CrossVV(V.rB,a.normal),W=f+p+d*U*U+v*k*k,q=f+p+d*H*H+v*j*j,X=f+p+d*U*H+v*k*j;W*W<r*(W*q-X*X)?(a.K.ex.Set(W,X),a.K.ey.Set(X,q),a.K.GetInverse(a.normalMass)):a.pointCount=1}}},e.WarmStart=function(){for(var e=t.WarmStart_s_P,n=0;n<this.m_count;++n){for(var i=this.m_velocityConstraints[n],r=i.indexA,o=i.indexB,a=i.invMassA,s=i.invIA,c=i.invMassB,l=i.invIB,u=i.pointCount,h=this.m_velocities[r].v,_=this.m_velocities[r].w,f=this.m_velocities[o].v,p=this.m_velocities[o].w,d=i.normal,m=i.tangent,v=0;v<u;++v){var g=i.points[v];bt.AddVV(bt.MulSV(g.normalImpulse,d,bt.s_t0),bt.MulSV(g.tangentImpulse,m,bt.s_t1),e),_-=s*bt.CrossVV(g.rA,e),h.SelfMulSub(a,e),p+=l*bt.CrossVV(g.rB,e),f.SelfMulAdd(c,e)}this.m_velocities[r].w=_,this.m_velocities[o].w=p}},e.SolveVelocityConstraints=function(){for(var e=t.SolveVelocityConstraints_s_dv,n=t.SolveVelocityConstraints_s_dv1,i=t.SolveVelocityConstraints_s_dv2,r=t.SolveVelocityConstraints_s_P,o=t.SolveVelocityConstraints_s_a,a=t.SolveVelocityConstraints_s_b,s=t.SolveVelocityConstraints_s_x,c=t.SolveVelocityConstraints_s_d,l=t.SolveVelocityConstraints_s_P1,u=t.SolveVelocityConstraints_s_P2,h=t.SolveVelocityConstraints_s_P1P2,_=0;_<this.m_count;++_){for(var f=this.m_velocityConstraints[_],p=f.indexA,d=f.indexB,m=f.invMassA,v=f.invIA,g=f.invMassB,y=f.invIB,x=f.pointCount,S=this.m_velocities[p].v,C=this.m_velocities[p].w,A=this.m_velocities[d].v,b=this.m_velocities[d].w,T=f.normal,E=f.tangent,w=f.friction,P=0;P<x;++P){var I=f.points[P];bt.SubVV(bt.AddVCrossSV(A,b,I.rB,bt.s_t0),bt.AddVCrossSV(S,C,I.rA,bt.s_t1),e);var R=bt.DotVV(e,E)-f.tangentSpeed,D=I.tangentMass*-R,B=w*I.normalImpulse,M=at(I.tangentImpulse+D,-B,B);D=M-I.tangentImpulse,I.tangentImpulse=M,bt.MulSV(D,E,r),S.SelfMulSub(m,r),C-=v*bt.CrossVV(I.rA,r),A.SelfMulAdd(g,r),b+=y*bt.CrossVV(I.rB,r)}if(1===f.pointCount||!1===Sr)for(var O=0;O<x;++O){var N=f.points[O];bt.SubVV(bt.AddVCrossSV(A,b,N.rB,bt.s_t0),bt.AddVCrossSV(S,C,N.rA,bt.s_t1),e);var L=bt.DotVV(e,T),F=-N.normalMass*(L-N.velocityBias),z=rt(N.normalImpulse+F,0);F=z-N.normalImpulse,N.normalImpulse=z,bt.MulSV(F,T,r),S.SelfMulSub(m,r),C-=v*bt.CrossVV(N.rA,r),A.SelfMulAdd(g,r),b+=y*bt.CrossVV(N.rB,r)}else{var G=f.points[0],V=f.points[1];o.Set(G.normalImpulse,V.normalImpulse),bt.SubVV(bt.AddVCrossSV(A,b,G.rB,bt.s_t0),bt.AddVCrossSV(S,C,G.rA,bt.s_t1),n),bt.SubVV(bt.AddVCrossSV(A,b,V.rB,bt.s_t0),bt.AddVCrossSV(S,C,V.rA,bt.s_t1),i);var U=bt.DotVV(n,T),k=bt.DotVV(i,T);for(a.x=U-G.velocityBias,a.y=k-V.velocityBias,a.SelfSub(wt.MulMV(f.K,o,bt.s_t0));;){if(wt.MulMV(f.normalMass,a,s).SelfNeg(),s.x>=0&&s.y>=0){bt.SubVV(s,o,c),bt.MulSV(c.x,T,l),bt.MulSV(c.y,T,u),bt.AddVV(l,u,h),S.SelfMulSub(m,h),C-=v*(bt.CrossVV(G.rA,l)+bt.CrossVV(V.rA,u)),A.SelfMulAdd(g,h),b+=y*(bt.CrossVV(G.rB,l)+bt.CrossVV(V.rB,u)),G.normalImpulse=s.x,V.normalImpulse=s.y;break}if(s.x=-G.normalMass*a.x,s.y=0,U=0,k=f.K.ex.y*s.x+a.y,s.x>=0&&k>=0){bt.SubVV(s,o,c),bt.MulSV(c.x,T,l),bt.MulSV(c.y,T,u),bt.AddVV(l,u,h),S.SelfMulSub(m,h),C-=v*(bt.CrossVV(G.rA,l)+bt.CrossVV(V.rA,u)),A.SelfMulAdd(g,h),b+=y*(bt.CrossVV(G.rB,l)+bt.CrossVV(V.rB,u)),G.normalImpulse=s.x,V.normalImpulse=s.y;break}if(s.x=0,s.y=-V.normalMass*a.y,U=f.K.ey.x*s.y+a.x,k=0,s.y>=0&&U>=0){bt.SubVV(s,o,c),bt.MulSV(c.x,T,l),bt.MulSV(c.y,T,u),bt.AddVV(l,u,h),S.SelfMulSub(m,h),C-=v*(bt.CrossVV(G.rA,l)+bt.CrossVV(V.rA,u)),A.SelfMulAdd(g,h),b+=y*(bt.CrossVV(G.rB,l)+bt.CrossVV(V.rB,u)),G.normalImpulse=s.x,V.normalImpulse=s.y;break}if(s.x=0,s.y=0,U=a.x,k=a.y,U>=0&&k>=0){bt.SubVV(s,o,c),bt.MulSV(c.x,T,l),bt.MulSV(c.y,T,u),bt.AddVV(l,u,h),S.SelfMulSub(m,h),C-=v*(bt.CrossVV(G.rA,l)+bt.CrossVV(V.rA,u)),A.SelfMulAdd(g,h),b+=y*(bt.CrossVV(G.rB,l)+bt.CrossVV(V.rB,u)),G.normalImpulse=s.x,V.normalImpulse=s.y;break}break}}this.m_velocities[p].w=C,this.m_velocities[d].w=b}},e.StoreImpulses=function(){for(var t=0;t<this.m_count;++t)for(var e=this.m_velocityConstraints[t],n=this.m_contacts[e.contactIndex].GetManifold(),i=0;i<e.pointCount;++i)n.points[i].normalImpulse=e.points[i].normalImpulse,n.points[i].tangentImpulse=e.points[i].tangentImpulse},e.SolvePositionConstraints=function(){for(var e=t.SolvePositionConstraints_s_xfA,n=t.SolvePositionConstraints_s_xfB,i=t.SolvePositionConstraints_s_psm,r=t.SolvePositionConstraints_s_rA,o=t.SolvePositionConstraints_s_rB,a=t.SolvePositionConstraints_s_P,s=0,c=0;c<this.m_count;++c){for(var l=this.m_positionConstraints[c],u=l.indexA,_=l.indexB,f=l.localCenterA,p=l.invMassA,d=l.invIA,m=l.localCenterB,g=l.invMassB,y=l.invIB,x=l.pointCount,S=this.m_positions[u].c,C=this.m_positions[u].a,b=this.m_positions[_].c,T=this.m_positions[_].a,E=0;E<x;++E){e.q.SetAngle(C),n.q.SetAngle(T),bt.SubVV(S,It.MulRV(e.q,f,bt.s_t0),e.p),bt.SubVV(b,It.MulRV(n.q,m,bt.s_t0),n.p),i.Initialize(l,e,n,E);var w=i.normal,P=i.point,I=i.separation;bt.SubVV(P,S,r),bt.SubVV(P,b,o),s=it(s,I);var R=at(A*(I+h),-v,0),D=bt.CrossVV(r,w),B=bt.CrossVV(o,w),M=p+g+d*D*D+y*B*B,O=M>0?-R/M:0;bt.MulSV(O,w,a),S.SelfMulSub(p,a),C-=d*bt.CrossVV(r,a),b.SelfMulAdd(g,a),T+=y*bt.CrossVV(o,a)}this.m_positions[u].a=C,this.m_positions[_].a=T}return s>-3*h},e.SolveTOIPositionConstraints=function(e,n){for(var i=t.SolveTOIPositionConstraints_s_xfA,r=t.SolveTOIPositionConstraints_s_xfB,o=t.SolveTOIPositionConstraints_s_psm,a=t.SolveTOIPositionConstraints_s_rA,s=t.SolveTOIPositionConstraints_s_rB,c=t.SolveTOIPositionConstraints_s_P,l=0,u=0;u<this.m_count;++u){var _=this.m_positionConstraints[u],f=_.indexA,p=_.indexB,d=_.localCenterA,m=_.localCenterB,g=_.pointCount,y=0,x=0;f!==e&&f!==n||(y=_.invMassA,x=_.invIA);var S=0,C=0;p!==e&&p!==n||(S=_.invMassB,C=_.invIB);for(var A=this.m_positions[f].c,T=this.m_positions[f].a,E=this.m_positions[p].c,w=this.m_positions[p].a,P=0;P<g;++P){i.q.SetAngle(T),r.q.SetAngle(w),bt.SubVV(A,It.MulRV(i.q,d,bt.s_t0),i.p),bt.SubVV(E,It.MulRV(r.q,m,bt.s_t0),r.p),o.Initialize(_,i,r,P);var I=o.normal,R=o.point,D=o.separation;bt.SubVV(R,A,a),bt.SubVV(R,E,s),l=it(l,D);var B=at(b*(D+h),-v,0),M=bt.CrossVV(a,I),O=bt.CrossVV(s,I),N=y+S+x*M*M+C*O*O,L=N>0?-B/N:0;bt.MulSV(L,I,c),A.SelfMulSub(y,c),T-=x*bt.CrossVV(a,c),E.SelfMulAdd(S,c),w+=C*bt.CrossVV(s,c)}this.m_positions[f].a=T,this.m_positions[p].a=w}return l>=-1.5*h},t}();wr.InitializeVelocityConstraints_s_xfA=new Rt,wr.InitializeVelocityConstraints_s_xfB=new Rt,wr.InitializeVelocityConstraints_s_worldManifold=new xe,wr.WarmStart_s_P=new bt,wr.SolveVelocityConstraints_s_dv=new bt,wr.SolveVelocityConstraints_s_dv1=new bt,wr.SolveVelocityConstraints_s_dv2=new bt,wr.SolveVelocityConstraints_s_P=new bt,wr.SolveVelocityConstraints_s_a=new bt,wr.SolveVelocityConstraints_s_b=new bt,wr.SolveVelocityConstraints_s_x=new bt,wr.SolveVelocityConstraints_s_d=new bt,wr.SolveVelocityConstraints_s_P1=new bt,wr.SolveVelocityConstraints_s_P2=new bt,wr.SolveVelocityConstraints_s_P1P2=new bt,wr.SolvePositionConstraints_s_xfA=new Rt,wr.SolvePositionConstraints_s_xfB=new Rt,wr.SolvePositionConstraints_s_psm=new Er,wr.SolvePositionConstraints_s_rA=new bt,wr.SolvePositionConstraints_s_rB=new bt,wr.SolvePositionConstraints_s_P=new bt,wr.SolveTOIPositionConstraints_s_xfA=new Rt,wr.SolveTOIPositionConstraints_s_xfB=new Rt,wr.SolveTOIPositionConstraints_s_psm=new Er,wr.SolveTOIPositionConstraints_s_rA=new bt,wr.SolveTOIPositionConstraints_s_rB=new bt,wr.SolveTOIPositionConstraints_s_P=new bt;var Pr,Ir=function(){function e(){this.m_bodies=[],this.m_contacts=[],this.m_joints=[],this.m_positions=gr.MakeArray(1024),this.m_velocities=yr.MakeArray(1024),this.m_bodyCount=0,this.m_jointCount=0,this.m_contactCount=0,this.m_bodyCapacity=0,this.m_contactCapacity=0,this.m_jointCapacity=0}var n=e.prototype;return n.Initialize=function(t,e,n,i){if(this.m_bodyCapacity=t,this.m_contactCapacity=e,this.m_jointCapacity=n,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_listener=i,this.m_positions.length<t)for(var r=rt(2*this.m_positions.length,t);this.m_positions.length<r;)this.m_positions[this.m_positions.length]=new gr;if(this.m_velocities.length<t)for(var o=rt(2*this.m_velocities.length,t);this.m_velocities.length<o;)this.m_velocities[this.m_velocities.length]=new yr},n.Clear=function(){this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0},n.AddBody=function(t){t.m_islandIndex=this.m_bodyCount,this.m_bodies[this.m_bodyCount++]=t},n.AddContact=function(t){this.m_contacts[this.m_contactCount++]=t},n.AddJoint=function(t){this.m_joints[this.m_jointCount++]=t},n.Solve=function(n,r,o,a){for(var s=e.s_timer.Reset(),c=r.dt,l=0;l<this.m_bodyCount;++l){var u=this.m_bodies[l];this.m_positions[l].c.Copy(u.m_sweep.c);var h=u.m_sweep.a,_=this.m_velocities[l].v.Copy(u.m_linearVelocity),f=u.m_angularVelocity;u.m_sweep.c0.Copy(u.m_sweep.c),u.m_sweep.a0=u.m_sweep.a,u.m_type===t.b2BodyType.b2_dynamicBody&&(_.x+=c*(u.m_gravityScale*o.x+u.m_invMass*u.m_force.x),_.y+=c*(u.m_gravityScale*o.y+u.m_invMass*u.m_force.y),f+=c*u.m_invI*u.m_torque,_.SelfMul(1/(1+c*u.m_linearDamping)),f*=1/(1+c*u.m_angularDamping)),this.m_positions[l].a=h,this.m_velocities[l].w=f}s.Reset();var p=e.s_solverData;p.step.Copy(r),p.positions=this.m_positions,p.velocities=this.m_velocities;var d=e.s_contactSolverDef;d.step.Copy(r),d.contacts=this.m_contacts,d.count=this.m_contactCount,d.positions=this.m_positions,d.velocities=this.m_velocities;var m=e.s_contactSolver.Initialize(d);m.InitializeVelocityConstraints(),r.warmStarting&&m.WarmStart();for(var v=0;v<this.m_jointCount;++v)this.m_joints[v].InitVelocityConstraints(p);n.solveInit=s.GetMilliseconds(),s.Reset();for(var g=0;g<r.velocityIterations;++g){for(var A=0;A<this.m_jointCount;++A)this.m_joints[A].SolveVelocityConstraints(p);m.SolveVelocityConstraints()}m.StoreImpulses(),n.solveVelocity=s.GetMilliseconds();for(var b=0;b<this.m_bodyCount;++b){var T=this.m_positions[b].c,E=this.m_positions[b].a,w=this.m_velocities[b].v,P=this.m_velocities[b].w,I=bt.MulSV(c,w,e.s_translation);if(bt.DotVV(I,I)>x){var R=y/I.Length();w.SelfMul(R)}var D=c*P;D*D>C&&(P*=S/nt(D)),T.x+=c*w.x,T.y+=c*w.y,E+=c*P,this.m_positions[b].a=E,this.m_velocities[b].w=P}s.Reset();for(var B=!1,M=0;M<r.positionIterations;++M){for(var O=m.SolvePositionConstraints(),z=!0,G=0;G<this.m_jointCount;++G){var V=this.m_joints[G].SolvePositionConstraints(p);z=z&&V}if(O&&z){B=!0;break}}for(var U=0;U<this.m_bodyCount;++U){var k=this.m_bodies[U];k.m_sweep.c.Copy(this.m_positions[U].c),k.m_sweep.a=this.m_positions[U].a,k.m_linearVelocity.Copy(this.m_velocities[U].v),k.m_angularVelocity=this.m_velocities[U].w,k.SynchronizeTransform()}if(n.solvePosition=s.GetMilliseconds(),this.Report(m.m_velocityConstraints),a){for(var H=i,j=L*L,W=F*F,q=0;q<this.m_bodyCount;++q){var X=this.m_bodies[q];X.GetType()!==t.b2BodyType.b2_staticBody&&(!X.m_autoSleepFlag||X.m_angularVelocity*X.m_angularVelocity>W||bt.DotVV(X.m_linearVelocity,X.m_linearVelocity)>j?(X.m_sleepTime=0,H=0):(X.m_sleepTime+=c,H=it(H,X.m_sleepTime)))}if(H>=N&&B)for(var Y=0;Y<this.m_bodyCount;++Y)this.m_bodies[Y].SetAwake(!1)}},n.SolveTOI=function(t,n,i){for(var r=0;r<this.m_bodyCount;++r){var o=this.m_bodies[r];this.m_positions[r].c.Copy(o.m_sweep.c),this.m_positions[r].a=o.m_sweep.a,this.m_velocities[r].v.Copy(o.m_linearVelocity),this.m_velocities[r].w=o.m_angularVelocity}var a=e.s_contactSolverDef;a.contacts=this.m_contacts,a.count=this.m_contactCount,a.step.Copy(t),a.positions=this.m_positions,a.velocities=this.m_velocities;for(var s=e.s_contactSolver.Initialize(a),c=0;c<t.positionIterations&&!s.SolveTOIPositionConstraints(n,i);++c);this.m_bodies[n].m_sweep.c0.Copy(this.m_positions[n].c),this.m_bodies[n].m_sweep.a0=this.m_positions[n].a,this.m_bodies[i].m_sweep.c0.Copy(this.m_positions[i].c),this.m_bodies[i].m_sweep.a0=this.m_positions[i].a,s.InitializeVelocityConstraints();for(var l=0;l<t.velocityIterations;++l)s.SolveVelocityConstraints();for(var u=t.dt,h=0;h<this.m_bodyCount;++h){var _=this.m_positions[h].c,f=this.m_positions[h].a,p=this.m_velocities[h].v,d=this.m_velocities[h].w,m=bt.MulSV(u,p,e.s_translation);if(bt.DotVV(m,m)>x){var v=y/m.Length();p.SelfMul(v)}var g=u*d;g*g>C&&(d*=S/nt(g)),_.SelfMulAdd(u,p),f+=u*d,this.m_positions[h].a=f,this.m_velocities[h].w=d;var A=this.m_bodies[h];A.m_sweep.c.Copy(_),A.m_sweep.a=f,A.m_linearVelocity.Copy(p),A.m_angularVelocity=d,A.SynchronizeTransform()}this.Report(s.m_velocityConstraints)},n.Report=function(t){if(null!==this.m_listener)for(var n=0;n<this.m_contactCount;++n){var i=this.m_contacts[n];if(i){var r=t[n],o=e.s_impulse;o.count=r.pointCount;for(var a=0;a<r.pointCount;++a)o.normalImpulses[a]=r.points[a].normalImpulse,o.tangentImpulses[a]=r.points[a].tangentImpulse;this.m_listener.PostSolve(i,o)}}},e}();Ir.s_timer=new Nt,Ir.s_solverData=new xr,Ir.s_contactSolverDef=new Tr,Ir.s_contactSolver=new wr,Ir.s_translation=new bt,Ir.s_impulse=new hr,(Pr=t.b2ParticleFlag||(t.b2ParticleFlag={}))[Pr.b2_waterParticle=0]="b2_waterParticle",Pr[Pr.b2_zombieParticle=2]="b2_zombieParticle",Pr[Pr.b2_wallParticle=4]="b2_wallParticle",Pr[Pr.b2_springParticle=8]="b2_springParticle",Pr[Pr.b2_elasticParticle=16]="b2_elasticParticle",Pr[Pr.b2_viscousParticle=32]="b2_viscousParticle",Pr[Pr.b2_powderParticle=64]="b2_powderParticle",Pr[Pr.b2_tensileParticle=128]="b2_tensileParticle",Pr[Pr.b2_colorMixingParticle=256]="b2_colorMixingParticle",Pr[Pr.b2_destructionListenerParticle=512]="b2_destructionListenerParticle",Pr[Pr.b2_barrierParticle=1024]="b2_barrierParticle",Pr[Pr.b2_staticPressureParticle=2048]="b2_staticPressureParticle",Pr[Pr.b2_reactiveParticle=4096]="b2_reactiveParticle",Pr[Pr.b2_repulsiveParticle=8192]="b2_repulsiveParticle",Pr[Pr.b2_fixtureContactListenerParticle=16384]="b2_fixtureContactListenerParticle",Pr[Pr.b2_particleContactListenerParticle=32768]="b2_particleContactListenerParticle",Pr[Pr.b2_fixtureContactFilterParticle=65536]="b2_fixtureContactFilterParticle",Pr[Pr.b2_particleContactFilterParticle=131072]="b2_particleContactFilterParticle";var Rr=function(){this.flags=0,this.position=new bt,this.velocity=new bt,this.color=new Mt(0,0,0,0),this.lifetime=0,this.userData=null,this.group=null};function Dr(t,e,n){var i=8,r=.01;return at(Math.ceil(Math.sqrt(t/(r*e))*n),1,i)}var Br,Mr=function(){function t(){this.m_index=T}var e=t.prototype;return e.GetIndex=function(){return this.m_index},e.SetIndex=function(t){this.m_index=t},t}();(Br=t.b2ParticleGroupFlag||(t.b2ParticleGroupFlag={}))[Br.b2_solidParticleGroup=1]="b2_solidParticleGroup",Br[Br.b2_rigidParticleGroup=2]="b2_rigidParticleGroup",Br[Br.b2_particleGroupCanBeEmpty=4]="b2_particleGroupCanBeEmpty",Br[Br.b2_particleGroupWillBeDestroyed=8]="b2_particleGroupWillBeDestroyed",Br[Br.b2_particleGroupNeedsUpdateDepth=16]="b2_particleGroupNeedsUpdateDepth",Br[Br.b2_particleGroupInternalMask=24]="b2_particleGroupInternalMask";var Or=function(){this.flags=0,this.groupFlags=0,this.position=new bt,this.angle=0,this.linearVelocity=new bt,this.angularVelocity=0,this.color=new Mt,this.strength=1,this.shapeCount=0,this.stride=0,this.particleCount=0,this.lifetime=0,this.userData=null,this.group=null},Nr=function(){function e(t){this.m_firstIndex=0,this.m_lastIndex=0,this.m_groupFlags=0,this.m_strength=1,this.m_prev=null,this.m_next=null,this.m_timestamp=-1,this.m_mass=0,this.m_inertia=0,this.m_center=new bt,this.m_linearVelocity=new bt,this.m_angularVelocity=0,this.m_transform=new Rt,this.m_userData=null,this.m_system=t}var n=e.prototype;return n.GetNext=function(){return this.m_next},n.GetParticleSystem=function(){return this.m_system},n.GetParticleCount=function(){return this.m_lastIndex-this.m_firstIndex},n.GetBufferIndex=function(){return this.m_firstIndex},n.ContainsParticle=function(t){return this.m_firstIndex<=t&&t<this.m_lastIndex},n.GetAllParticleFlags=function(){if(!this.m_system.m_flagsBuffer.data)throw new Error;for(var t=0,e=this.m_firstIndex;e<this.m_lastIndex;e++)t|=this.m_system.m_flagsBuffer.data[e];return t},n.GetGroupFlags=function(){return this.m_groupFlags},n.SetGroupFlags=function(e){e|=this.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupInternalMask,this.m_system.SetGroupFlags(this,e)},n.GetMass=function(){return this.UpdateStatistics(),this.m_mass},n.GetInertia=function(){return this.UpdateStatistics(),this.m_inertia},n.GetCenter=function(){return this.UpdateStatistics(),this.m_center},n.GetLinearVelocity=function(){return this.UpdateStatistics(),this.m_linearVelocity},n.GetAngularVelocity=function(){return this.UpdateStatistics(),this.m_angularVelocity},n.GetTransform=function(){return this.m_transform},n.GetPosition=function(){return this.m_transform.p},n.GetAngle=function(){return this.m_transform.q.GetAngle()},n.GetLinearVelocityFromWorldPoint=function(t,n){var i=e.GetLinearVelocityFromWorldPoint_s_t0;return this.UpdateStatistics(),bt.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,bt.SubVV(t,this.m_center,i),n)},n.GetUserData=function(){return this.m_userData},n.SetUserData=function(t){this.m_userData=t},n.ApplyForce=function(t){this.m_system.ApplyForce(this.m_firstIndex,this.m_lastIndex,t)},n.ApplyLinearImpulse=function(t){this.m_system.ApplyLinearImpulse(this.m_firstIndex,this.m_lastIndex,t)},n.DestroyParticles=function(t){if(this.m_system.m_world.IsLocked())throw new Error;for(var e=this.m_firstIndex;e<this.m_lastIndex;e++)this.m_system.DestroyParticle(e,t)},n.UpdateStatistics=function(){if(!this.m_system.m_positionBuffer.data)throw new Error;if(!this.m_system.m_velocityBuffer.data)throw new Error;var t=new bt,e=new bt;if(this.m_timestamp!==this.m_system.m_timestamp){var n=this.m_system.GetParticleMass();this.m_mass=n*(this.m_lastIndex-this.m_firstIndex),this.m_center.SetZero(),this.m_linearVelocity.SetZero();for(var i=this.m_firstIndex;i<this.m_lastIndex;i++)this.m_center.SelfMulAdd(n,this.m_system.m_positionBuffer.data[i]),this.m_linearVelocity.SelfMulAdd(n,this.m_system.m_velocityBuffer.data[i]);if(this.m_mass>0){var r=1/this.m_mass;this.m_center.SelfMul(r),this.m_linearVelocity.SelfMul(r)}this.m_inertia=0,this.m_angularVelocity=0;for(var o=this.m_firstIndex;o<this.m_lastIndex;o++)bt.SubVV(this.m_system.m_positionBuffer.data[o],this.m_center,t),bt.SubVV(this.m_system.m_velocityBuffer.data[o],this.m_linearVelocity,e),this.m_inertia+=n*bt.DotVV(t,t),this.m_angularVelocity+=n*bt.CrossVV(t,e);this.m_inertia>0&&(this.m_angularVelocity*=1/this.m_inertia),this.m_timestamp=this.m_system.m_timestamp}},e}();Nr.GetLinearVelocityFromWorldPoint_s_t0=new bt;var Lr=function(){function t(t){this.m_buffer=[],this.m_front=0,this.m_back=0,this.m_buffer.fill(null,0,t)}var e=t.prototype;return e.Push=function(t){if(this.m_back>=this.m_capacity){for(var e=this.m_front;e<this.m_back;e++)this.m_buffer[e-this.m_front]=this.m_buffer[e];this.m_back-=this.m_front,this.m_front=0}this.m_buffer[this.m_back]=t,this.m_back++},e.Pop=function(){this.m_buffer[this.m_front]=null,this.m_front++},e.Empty=function(){return this.m_front===this.m_back},e.Front=function(){var t=this.m_buffer[this.m_front];if(!t)throw new Error;return t},K(t,[{key:"m_capacity",get:function(){return this.m_buffer.length}}]),t}(),Fr=function(){function t(t){this.m_generatorCapacity=0,this.m_generatorCount=0,this.m_countX=0,this.m_countY=0,this.m_diagram=[],this.m_generatorBuffer=X(t,(function(){return new zr})),this.m_generatorCapacity=t}var e=t.prototype;return e.AddGenerator=function(t,e,n){var i=this.m_generatorBuffer[this.m_generatorCount++];i.center.Copy(t),i.tag=e,i.necessary=n},e.Generate=function(t,e){for(var n=1/t,r=new bt(+i,+i),o=new bt(-i,-i),a=0,s=0;s<this.m_generatorCount;s++){var c=this.m_generatorBuffer[s];c.necessary&&(bt.MinV(r,c.center,r),bt.MaxV(o,c.center,o),++a)}if(0===a)return this.m_countX=0,void(this.m_countY=0);r.x-=e,r.y-=e,o.x+=e,o.y+=e,this.m_countX=1+Math.floor(n*(o.x-r.x)),this.m_countY=1+Math.floor(n*(o.y-r.y)),this.m_diagram=[];for(var l=new Lr(4*this.m_countX*this.m_countY),u=0;u<this.m_generatorCount;u++){var h=this.m_generatorBuffer[u];h.center.SelfSub(r).SelfMul(n);var _=Math.floor(h.center.x),f=Math.floor(h.center.y);_>=0&&f>=0&&_<this.m_countX&&f<this.m_countY&&l.Push(new Gr(_,f,_+f*this.m_countX,h))}for(;!l.Empty();){var p=l.Front(),d=p.m_x,m=p.m_y,v=p.m_i,g=p.m_generator;l.Pop(),this.m_diagram[v]||(this.m_diagram[v]=g,d>0&&l.Push(new Gr(d-1,m,v-1,g)),m>0&&l.Push(new Gr(d,m-1,v-this.m_countX,g)),d<this.m_countX-1&&l.Push(new Gr(d+1,m,v+1,g)),m<this.m_countY-1&&l.Push(new Gr(d,m+1,v+this.m_countX,g)))}for(var y=0;y<this.m_countY;y++)for(var x=0;x<this.m_countX-1;x++){var S=x+y*this.m_countX,C=this.m_diagram[S],A=this.m_diagram[S+1];C!==A&&(l.Push(new Gr(x,y,S,A)),l.Push(new Gr(x+1,y,S+1,C)))}for(var b=0;b<this.m_countY-1;b++)for(var T=0;T<this.m_countX;T++){var E=T+b*this.m_countX,w=this.m_diagram[E],P=this.m_diagram[E+this.m_countX];w!==P&&(l.Push(new Gr(T,b,E,P)),l.Push(new Gr(T,b+1,E+this.m_countX,w)))}for(;!l.Empty();){var I=l.Front(),R=I.m_x,D=I.m_y,B=I.m_i,M=I.m_generator;l.Pop();var O=this.m_diagram[B],N=M;if(O!==N){var L=O.center.x-R,F=O.center.y-D,z=N.center.x-R,G=N.center.y-D;L*L+F*F>z*z+G*G&&(this.m_diagram[B]=N,R>0&&l.Push(new Gr(R-1,D,B-1,N)),D>0&&l.Push(new Gr(R,D-1,B-this.m_countX,N)),R<this.m_countX-1&&l.Push(new Gr(R+1,D,B+1,N)),D<this.m_countY-1&&l.Push(new Gr(R,D+1,B+this.m_countX,N)))}}},e.GetNodes=function(t){for(var e=0;e<this.m_countY-1;e++)for(var n=0;n<this.m_countX-1;n++){var i=n+e*this.m_countX,r=this.m_diagram[i],o=this.m_diagram[i+1],a=this.m_diagram[i+this.m_countX],s=this.m_diagram[i+1+this.m_countX];o!==a&&(r!==o&&r!==a&&(r.necessary||o.necessary||a.necessary)&&t(r.tag,o.tag,a.tag),s!==o&&s!==a&&(r.necessary||o.necessary||a.necessary)&&t(o.tag,s.tag,a.tag))}},t}(),zr=function(){this.center=new bt,this.tag=0,this.necessary=!1},Gr=function(t,e,n,i){this.m_x=t,this.m_y=e,this.m_i=n,this.m_generator=i};function Vr(t,e,n){var i=t[e];t[e]=t[n],t[n]=i}function Ur(t,e){return t<e}function kr(t,e,n,i){void 0===e&&(e=0),void 0===n&&(n=t.length-e),void 0===i&&(i=Ur);for(var r=e,o=[],a=0;;){for(;r+1<n;n++){var s=t[r+Math.floor(Math.random()*(n-r))];o[a++]=n;for(var c=r-1;;){for(;i(t[++c],s););for(;i(s,t[--n]););if(c>=n)break;Vr(t,c,n)}}if(0===a)break;r=n,n=o[--a]}return t}function Hr(t,e,n,i){return void 0===e&&(e=0),void 0===n&&(n=t.length-e),void 0===i&&(i=Ur),kr(t,e,n,i)}function jr(t,e,n){void 0===n&&(n=t.length);for(var i=0,r=0;r<n;++r)e(t[r])||(r!==i?Vr(t,i++,r):++i);return i}function Wr(t,e,n,i,r){for(var o=n-e;o>0;){var a=Math.floor(o/2),s=e+a;r(t[s],i)?(e=++s,o-=a+1):o=a}return e}function qr(t,e,n,i,r){for(var o=n-e;o>0;){var a=Math.floor(o/2),s=e+a;r(i,t[s])?o=a:(e=++s,o-=a+1)}return e}function Xr(t,e,n,i){for(var r=n;e!==r;)Vr(t,e++,r++),r===i?r=n:e===n&&(n=r)}function Yr(t,e,n,i){if(e===n)return n;for(var r=e;++e!==n;)i(t[r],t[e])||Vr(t,++r,e);return++r}var Kr=function(){function t(t){this.data=[],this.count=0,this.capacity=0,this.allocator=t}var e=t.prototype;return e.Append=function(){return this.count>=this.capacity&&this.Grow(),this.count++},e.Reserve=function(t){if(!(this.capacity>=t)){for(var e=this.capacity;e<t;++e)this.data[e]=this.allocator();this.capacity=t}},e.Grow=function(){var t=this.capacity?2*this.capacity:M;this.Reserve(t)},e.Free=function(){0!==this.data.length&&(this.data=[],this.capacity=0,this.count=0)},e.Shorten=function(){},e.Data=function(){return this.data},e.GetCount=function(){return this.count},e.SetCount=function(t){this.count=t},e.GetCapacity=function(){return this.capacity},e.RemoveIf=function(t){this.count=jr(this.data,t,this.count)},e.Unique=function(t){this.count=Yr(this.data,0,this.count,t)},t}(),Jr=function(t){function e(e){var n;return(n=t.call(this)||this).m_system=e,n}Q(e,t);var n=e.prototype;return n.ShouldQueryParticleSystem=function(){return!1},n.ReportFixture=function(t){if(t.IsSensor())return!0;for(var e=t.GetShape().GetChildCount(),n=0;n<e;n++)for(var i=t.GetAABB(n),r=this.m_system.GetInsideBoundsEnumerator(i),o=void 0;(o=r.GetNext())>=0;)this.ReportFixtureAndParticle(t,n,o);return!0},n.ReportParticle=function(){return!1},n.ReportFixtureAndParticle=function(){},e}(fr),Qr=function(){function t(){this.indexA=0,this.indexB=0,this.weight=0,this.normal=new bt,this.flags=0}var e=t.prototype;return e.SetIndices=function(t,e){this.indexA=t,this.indexB=e},e.SetWeight=function(t){this.weight=t},e.SetNormal=function(t){this.normal.Copy(t)},e.SetFlags=function(t){this.flags=t},e.GetIndexA=function(){return this.indexA},e.GetIndexB=function(){return this.indexB},e.GetWeight=function(){return this.weight},e.GetNormal=function(){return this.normal},e.GetFlags=function(){return this.flags},e.IsEqual=function(t){return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&this.weight===t.weight&&this.normal.x===t.normal.x&&this.normal.y===t.normal.y},e.IsNotEqual=function(t){return!this.IsEqual(t)},e.ApproximatelyEqual=function(t){var e=.01,n=1e-4;return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&nt(this.weight-t.weight)<e&&bt.DistanceSquaredVV(this.normal,t.normal)<n},t}(),Zr=function(){this.index=0,this.weight=0,this.normal=new bt,this.mass=0},$r=function(){this.indexA=0,this.indexB=0,this.flags=0,this.strength=0,this.distance=0},to=function(){this.indexA=0,this.indexB=0,this.indexC=0,this.flags=0,this.strength=0,this.pa=new bt(0,0),this.pb=new bt(0,0),this.pc=new bt(0,0),this.ka=0,this.kb=0,this.kc=0,this.s=0},eo=function(){function t(){this.strictContactCheck=!1,this.density=1,this.gravityScale=1,this.radius=1,this.maxCount=0,this.pressureStrength=.005,this.dampingStrength=1,this.elasticStrength=.25,this.springStrength=.25,this.viscousStrength=.25,this.surfaceTensionPressureStrength=.2,this.surfaceTensionNormalStrength=.2,this.repulsiveStrength=1,this.powderStrength=.5,this.ejectionStrength=.5,this.staticPressureStrength=.2,this.staticPressureRelaxation=.2,this.staticPressureIterations=8,this.colorMixingStrength=.5,this.destroyByAge=!0,this.lifetimeGranularity=1/60}var e=t.prototype;return e.Copy=function(t){return this.strictContactCheck=t.strictContactCheck,this.density=t.density,this.gravityScale=t.gravityScale,this.radius=t.radius,this.maxCount=t.maxCount,this.pressureStrength=t.pressureStrength,this.dampingStrength=t.dampingStrength,this.elasticStrength=t.elasticStrength,this.springStrength=t.springStrength,this.viscousStrength=t.viscousStrength,this.surfaceTensionPressureStrength=t.surfaceTensionPressureStrength,this.surfaceTensionNormalStrength=t.surfaceTensionNormalStrength,this.repulsiveStrength=t.repulsiveStrength,this.powderStrength=t.powderStrength,this.ejectionStrength=t.ejectionStrength,this.staticPressureStrength=t.staticPressureStrength,this.staticPressureRelaxation=t.staticPressureRelaxation,this.staticPressureIterations=t.staticPressureIterations,this.colorMixingStrength=t.colorMixingStrength,this.destroyByAge=t.destroyByAge,this.lifetimeGranularity=t.lifetimeGranularity,this},e.Clone=function(){return(new t).Copy(this)},t}(),no=function(){function e(t,e){this.m_paused=!1,this.m_timestamp=0,this.m_allParticleFlags=0,this.m_needsUpdateAllParticleFlags=!1,this.m_allGroupFlags=0,this.m_needsUpdateAllGroupFlags=!1,this.m_hasForce=!1,this.m_iterationIndex=0,this.m_inverseDensity=0,this.m_particleDiameter=0,this.m_inverseDiameter=0,this.m_squaredDiameter=0,this.m_count=0,this.m_internalAllocatedCapacity=0,this.m_handleIndexBuffer=new io,this.m_flagsBuffer=new io,this.m_positionBuffer=new io,this.m_velocityBuffer=new io,this.m_forceBuffer=[],this.m_weightBuffer=[],this.m_staticPressureBuffer=[],this.m_accumulationBuffer=[],this.m_accumulation2Buffer=[],this.m_depthBuffer=[],this.m_colorBuffer=new io,this.m_groupBuffer=[],this.m_userDataBuffer=new io,this.m_stuckThreshold=0,this.m_lastBodyContactStepBuffer=new io,this.m_bodyContactCountBuffer=new io,this.m_consecutiveContactStepsBuffer=new io,this.m_stuckParticleBuffer=new Kr((function(){return 0})),this.m_proxyBuffer=new Kr((function(){return new ro})),this.m_contactBuffer=new Kr((function(){return new Qr})),this.m_bodyContactBuffer=new Kr((function(){return new Zr})),this.m_pairBuffer=new Kr((function(){return new $r})),this.m_triadBuffer=new Kr((function(){return new to})),this.m_expirationTimeBuffer=new io,this.m_indexByExpirationTimeBuffer=new io,this.m_timeElapsed=0,this.m_expirationTimeBufferRequiresSorting=!1,this.m_groupCount=0,this.m_groupList=null,this.m_def=new eo,this.m_prev=null,this.m_next=null,this.UpdateBodyContacts_callback=null,this.SolveCollision_callback=null,this.SetStrictContactCheck(t.strictContactCheck),this.SetDensity(t.density),this.SetGravityScale(t.gravityScale),this.SetRadius(t.radius),this.SetMaxParticleCount(t.maxCount),this.m_def=t.Clone(),this.m_world=e,this.SetDestructionByAge(this.m_def.destroyByAge)}e.computeTag=function(t,n){return(n+e.yOffset>>>0<<e.yShift)+(e.xScale*t+e.xOffset>>>0)>>>0},e.computeRelativeTag=function(t,n,i){return t+(i<<e.yShift)+(n<<e.xShift)>>>0};var r=e.prototype;return r.Drop=function(){for(;this.m_groupList;)this.DestroyParticleGroup(this.m_groupList);this.FreeUserOverridableBuffer(this.m_handleIndexBuffer),this.FreeUserOverridableBuffer(this.m_flagsBuffer),this.FreeUserOverridableBuffer(this.m_lastBodyContactStepBuffer),this.FreeUserOverridableBuffer(this.m_bodyContactCountBuffer),this.FreeUserOverridableBuffer(this.m_consecutiveContactStepsBuffer),this.FreeUserOverridableBuffer(this.m_positionBuffer),this.FreeUserOverridableBuffer(this.m_velocityBuffer),this.FreeUserOverridableBuffer(this.m_colorBuffer),this.FreeUserOverridableBuffer(this.m_userDataBuffer),this.FreeUserOverridableBuffer(this.m_expirationTimeBuffer),this.FreeUserOverridableBuffer(this.m_indexByExpirationTimeBuffer),this.FreeBuffer(this.m_forceBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_weightBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_staticPressureBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulationBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulation2Buffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_depthBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_groupBuffer,this.m_internalAllocatedCapacity)},r.CreateParticle=function(t){if(this.m_world.IsLocked())throw new Error;if(this.m_count>=this.m_internalAllocatedCapacity){var e=this.m_count?2*this.m_count:M;this.ReallocateInternalAllocatedBuffers(e)}if(this.m_count>=this.m_internalAllocatedCapacity){if(!this.m_def.destroyByAge)return T;this.DestroyOldestParticle(0,!1),this.SolveZombie()}var i=this.m_count++;this.m_flagsBuffer.data[i]=0,this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[i]=0),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[i]=0),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[i]=0),this.m_positionBuffer.data[i]=(this.m_positionBuffer.data[i]||new bt).Copy(n(t.position,bt.ZERO)),this.m_velocityBuffer.data[i]=(this.m_velocityBuffer.data[i]||new bt).Copy(n(t.velocity,bt.ZERO)),this.m_weightBuffer[i]=0,this.m_forceBuffer[i]=(this.m_forceBuffer[i]||new bt).SetZero(),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[i]=0),this.m_depthBuffer&&(this.m_depthBuffer[i]=0);var r=(new Mt).Copy(n(t.color,Mt.ZERO));!this.m_colorBuffer.data&&r.IsZero()||(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data[i]=(this.m_colorBuffer.data[i]||new Mt).Copy(r)),(this.m_userDataBuffer.data||t.userData)&&(this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data[i]=t.userData),this.m_handleIndexBuffer.data&&(this.m_handleIndexBuffer.data[i]=null);var o=this.m_proxyBuffer.data[this.m_proxyBuffer.Append()],a=n(t.lifetime,0),s=a>0;(this.m_expirationTimeBuffer.data||s)&&(this.SetParticleLifetime(i,s?a:this.ExpirationTimeToLifetime(-this.GetQuantizedTimeElapsed())),this.m_indexByExpirationTimeBuffer.data[i]=i),o.index=i;var c=n(t.group,null);return this.m_groupBuffer[i]=c,c&&(c.m_firstIndex<c.m_lastIndex?(this.RotateBuffer(c.m_firstIndex,c.m_lastIndex,i),c.m_lastIndex=i+1):(c.m_firstIndex=i,c.m_lastIndex=i+1)),this.SetParticleFlags(i,n(t.flags,0)),i},r.GetParticleHandleFromIndex=function(t){this.m_handleIndexBuffer.data=this.RequestBuffer(this.m_handleIndexBuffer.data);var e=this.m_handleIndexBuffer.data[t];return e||((e=new Mr).SetIndex(t),this.m_handleIndexBuffer.data[t]=e,e)},r.DestroyParticle=function(e,n){void 0===n&&(n=!1);var i=t.b2ParticleFlag.b2_zombieParticle;n&&(i|=t.b2ParticleFlag.b2_destructionListenerParticle),this.SetParticleFlags(e,this.m_flagsBuffer.data[e]|i)},r.DestroyOldestParticle=function(t,e){void 0===e&&(e=!1);var n=this.GetParticleCount(),i=this.m_indexByExpirationTimeBuffer.data[n-(t+1)],r=this.m_indexByExpirationTimeBuffer.data[t];this.DestroyParticle(this.m_expirationTimeBuffer.data[i]>0?i:r,e)},r.DestroyParticlesInShape=function(t,n,i){void 0===i&&(i=!1);var r=e.DestroyParticlesInShape_s_aabb;if(this.m_world.IsLocked())throw new Error;var o=new fo(this,t,n,i),a=r;return t.ComputeAABB(a,n,0),this.m_world.QueryAABB(o,a),o.Destroyed()},r.CreateParticleGroup=function(t){var i=e.CreateParticleGroup_s_transform;if(this.m_world.IsLocked())throw new Error;var r=i;r.SetPositionAngle(n(t.position,bt.ZERO),n(t.angle,0));var o=this.m_count;if(t.shape&&this.CreateParticlesWithShapeForGroup(t.shape,t,r),t.shapes&&this.CreateParticlesWithShapesForGroup(t.shapes,n(t.shapeCount,t.shapes.length),t,r),t.positionData)for(var a=n(t.particleCount,t.positionData.length),s=0;s<a;s++){var c=t.positionData[s];this.CreateParticleForGroup(t,r,c)}var l=this.m_count,u=new Nr(this);u.m_firstIndex=o,u.m_lastIndex=l,u.m_strength=n(t.strength,1),u.m_userData=t.userData,u.m_transform.Copy(r),u.m_prev=null,u.m_next=this.m_groupList,this.m_groupList&&(this.m_groupList.m_prev=u),this.m_groupList=u,++this.m_groupCount;for(var h=o;h<l;h++)this.m_groupBuffer[h]=u;this.SetGroupFlags(u,n(t.groupFlags,0));var _=new _o;return this.UpdateContacts(!0),this.UpdatePairsAndTriads(o,l,_),t.group&&(this.JoinParticleGroups(t.group,u),u=t.group),u},r.JoinParticleGroups=function(t,e){if(this.m_world.IsLocked())throw new Error;this.RotateBuffer(e.m_firstIndex,e.m_lastIndex,this.m_count),this.RotateBuffer(t.m_firstIndex,t.m_lastIndex,e.m_firstIndex);var n=new po(e.m_firstIndex);this.UpdateContacts(!0),this.UpdatePairsAndTriads(t.m_firstIndex,e.m_lastIndex,n);for(var i=e.m_firstIndex;i<e.m_lastIndex;i++)this.m_groupBuffer[i]=t;var r=t.m_groupFlags|e.m_groupFlags;this.SetGroupFlags(t,r),t.m_lastIndex=e.m_lastIndex,e.m_firstIndex=e.m_lastIndex,this.DestroyParticleGroup(e)},r.SplitParticleGroup=function(t){this.UpdateContacts(!0);var n=X(t.GetParticleCount(),(function(){return new ao}));e.InitializeParticleLists(t,n),this.MergeParticleListsInContact(t,n);var i=e.FindLongestParticleList(t,n);this.MergeZombieParticleListNodes(t,n,i),this.CreateParticleGroupsFromParticleList(t,n,i),this.UpdatePairsAndTriadsWithParticleList(t,n)},r.GetParticleGroupList=function(){return this.m_groupList},r.GetParticleGroupCount=function(){return this.m_groupCount},r.GetParticleCount=function(){return this.m_count},r.GetMaxParticleCount=function(){return this.m_def.maxCount},r.SetMaxParticleCount=function(t){this.m_def.maxCount=t},r.GetAllParticleFlags=function(){return this.m_allParticleFlags},r.GetAllGroupFlags=function(){return this.m_allGroupFlags},r.SetPaused=function(t){this.m_paused=t},r.GetPaused=function(){return this.m_paused},r.SetDensity=function(t){this.m_def.density=t,this.m_inverseDensity=1/this.m_def.density},r.GetDensity=function(){return this.m_def.density},r.SetGravityScale=function(t){this.m_def.gravityScale=t},r.GetGravityScale=function(){return this.m_def.gravityScale},r.SetDamping=function(t){this.m_def.dampingStrength=t},r.GetDamping=function(){return this.m_def.dampingStrength},r.SetStaticPressureIterations=function(t){this.m_def.staticPressureIterations=t},r.GetStaticPressureIterations=function(){return this.m_def.staticPressureIterations},r.SetRadius=function(t){this.m_particleDiameter=2*t,this.m_squaredDiameter=this.m_particleDiameter*this.m_particleDiameter,this.m_inverseDiameter=1/this.m_particleDiameter},r.GetRadius=function(){return this.m_particleDiameter/2},r.GetPositionBuffer=function(){return this.m_positionBuffer.data},r.GetVelocityBuffer=function(){return this.m_velocityBuffer.data},r.GetColorBuffer=function(){return this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data},r.GetGroupBuffer=function(){return this.m_groupBuffer},r.GetWeightBuffer=function(){return this.m_weightBuffer},r.GetUserDataBuffer=function(){return this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data},r.GetFlagsBuffer=function(){return this.m_flagsBuffer.data},r.SetParticleFlags=function(e,n){this.m_flagsBuffer.data[e]&~n&&(this.m_needsUpdateAllParticleFlags=!0),~this.m_allParticleFlags&n&&(n&t.b2ParticleFlag.b2_tensileParticle&&(this.m_accumulation2Buffer=this.RequestBuffer(this.m_accumulation2Buffer)),n&t.b2ParticleFlag.b2_colorMixingParticle&&(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data)),this.m_allParticleFlags|=n),this.m_flagsBuffer.data[e]=n},r.GetParticleFlags=function(t){return this.m_flagsBuffer.data[t]},r.SetFlagsBuffer=function(t){this.SetUserOverridableBuffer(this.m_flagsBuffer,t)},r.SetPositionBuffer=function(t){if(t instanceof Float32Array){if(t.length%2!=0)throw new Error;for(var e=t.length/2,n=new Array(e),i=0;i<e;++i)n[i]=new bt(t.subarray(2*i,2*i+2));t=n}this.SetUserOverridableBuffer(this.m_positionBuffer,t)},r.SetVelocityBuffer=function(t){if(t instanceof Float32Array){if(t.length%2!=0)throw new Error;for(var e=t.length/2,n=new Array(e),i=0;i<e;++i)n[i]=new bt(t.subarray(2*i,2*i+2));t=n}this.SetUserOverridableBuffer(this.m_velocityBuffer,t)},r.SetColorBuffer=function(t){if(t instanceof Float32Array){if(t.length%4!=0)throw new Error;for(var e=t.length/4,n=new Array(e),i=0;i<e;++i)n[i]=new Mt(t.subarray(4*i,4*i+4));t=n}this.SetUserOverridableBuffer(this.m_colorBuffer,t)},r.SetUserDataBuffer=function(t){this.SetUserOverridableBuffer(this.m_userDataBuffer,t)},r.GetContacts=function(){return this.m_contactBuffer.data},r.GetContactCount=function(){return this.m_contactBuffer.count},r.GetBodyContacts=function(){return this.m_bodyContactBuffer.data},r.GetBodyContactCount=function(){return this.m_bodyContactBuffer.count},r.GetPairs=function(){return this.m_pairBuffer.data},r.GetPairCount=function(){return this.m_pairBuffer.count},r.GetTriads=function(){return this.m_triadBuffer.data},r.GetTriadCount=function(){return this.m_triadBuffer.count},r.SetStuckThreshold=function(t){this.m_stuckThreshold=t,t>0&&(this.m_lastBodyContactStepBuffer.data=this.RequestBuffer(this.m_lastBodyContactStepBuffer.data),this.m_bodyContactCountBuffer.data=this.RequestBuffer(this.m_bodyContactCountBuffer.data),this.m_consecutiveContactStepsBuffer.data=this.RequestBuffer(this.m_consecutiveContactStepsBuffer.data))},r.GetStuckCandidates=function(){return this.m_stuckParticleBuffer.Data()},r.GetStuckCandidateCount=function(){return this.m_stuckParticleBuffer.GetCount()},r.ComputeCollisionEnergy=function(){for(var t=e.ComputeCollisionEnergy_s_v,n=this.m_velocityBuffer.data,i=0,r=0;r<this.m_contactBuffer.count;r++){var o=this.m_contactBuffer.data[r],a=o.indexA,s=o.indexB,c=o.normal,l=bt.SubVV(n[s],n[a],t),u=bt.DotVV(l,c);u<0&&(i+=u*u)}return.5*this.GetParticleMass()*i},r.SetStrictContactCheck=function(t){this.m_def.strictContactCheck=t},r.GetStrictContactCheck=function(){return this.m_def.strictContactCheck},r.SetParticleLifetime=function(t,e){var n=null===this.m_indexByExpirationTimeBuffer.data;if(this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),n)for(var i=this.GetParticleCount(),r=0;r<i;++r)this.m_indexByExpirationTimeBuffer.data[r]=r;var o=e/this.m_def.lifetimeGranularity,a=o>0?this.GetQuantizedTimeElapsed()+o:o;a!==this.m_expirationTimeBuffer.data[t]&&(this.m_expirationTimeBuffer.data[t]=a,this.m_expirationTimeBufferRequiresSorting=!0)},r.GetParticleLifetime=function(t){return this.ExpirationTimeToLifetime(this.GetExpirationTimeBuffer()[t])},r.SetDestructionByAge=function(t){t&&this.GetExpirationTimeBuffer(),this.m_def.destroyByAge=t},r.GetDestructionByAge=function(){return this.m_def.destroyByAge},r.GetExpirationTimeBuffer=function(){return this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_expirationTimeBuffer.data},r.ExpirationTimeToLifetime=function(t){return(t>0?t-this.GetQuantizedTimeElapsed():t)*this.m_def.lifetimeGranularity},r.GetIndexByExpirationTimeBuffer=function(){return this.GetParticleCount()?this.SetParticleLifetime(0,this.GetParticleLifetime(0)):this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data},r.ParticleApplyLinearImpulse=function(t,e){this.ApplyLinearImpulse(t,t+1,e)},r.ApplyLinearImpulse=function(t,e,n){for(var i=this.m_velocityBuffer.data,r=(e-t)*this.GetParticleMass(),o=(new bt).Copy(n).SelfMul(1/r),a=t;a<e;a++)i[a].SelfAdd(o)},e.IsSignificantForce=function(t){return 0!==t.x||0!==t.y},r.ParticleApplyForce=function(t,n){e.IsSignificantForce(n)&&this.ForceCanBeApplied(this.m_flagsBuffer.data[t])&&(this.PrepareForceBuffer(),this.m_forceBuffer[t].SelfAdd(n))},r.ApplyForce=function(t,n,i){var r=(new bt).Copy(i).SelfMul(1/(n-t));if(e.IsSignificantForce(r)){this.PrepareForceBuffer();for(var o=t;o<n;o++)this.m_forceBuffer[o].SelfAdd(r)}},r.GetNext=function(){return this.m_next},r.QueryAABB=function(t,n){if(0!==this.m_proxyBuffer.count)for(var i=0,r=this.m_proxyBuffer.count,o=Wr(this.m_proxyBuffer.data,i,r,e.computeTag(this.m_inverseDiameter*n.lowerBound.x,this.m_inverseDiameter*n.lowerBound.y),ro.CompareProxyTag),a=qr(this.m_proxyBuffer.data,o,r,e.computeTag(this.m_inverseDiameter*n.upperBound.x,this.m_inverseDiameter*n.upperBound.y),ro.CompareTagProxy),s=this.m_positionBuffer.data,c=o;c<a;++c){var l=this.m_proxyBuffer.data[c].index,u=s[l];if(n.lowerBound.x<u.x&&u.x<n.upperBound.x&&n.lowerBound.y<u.y&&u.y<n.upperBound.y&&!t.ReportParticle(this,l))break}},r.QueryShapeAABB=function(t,n,i,r){void 0===r&&(r=0);var o=e.QueryShapeAABB_s_aabb;n.ComputeAABB(o,i,r),this.QueryAABB(t,o)},r.QueryPointAABB=function(t,n,i){void 0===i&&(i=h);var r=e.QueryPointAABB_s_aabb;r.lowerBound.Set(n.x-i,n.y-i),r.upperBound.Set(n.x+i,n.y+i),this.QueryAABB(t,r)},r.RayCast=function(t,n,i){var r=e.RayCast_s_aabb,o=e.RayCast_s_p,a=e.RayCast_s_v,s=e.RayCast_s_n,c=e.RayCast_s_point;if(0!==this.m_proxyBuffer.count){var l=this.m_positionBuffer.data,u=r;bt.MinV(n,i,u.lowerBound),bt.MaxV(n,i,u.upperBound);for(var h,_=1,f=bt.SubVV(i,n,a),p=bt.DotVV(f,f),d=this.GetInsideBoundsEnumerator(u);(h=d.GetNext())>=0;){var m=bt.SubVV(n,l[h],o),v=bt.DotVV(m,f),g=v*v-p*(bt.DotVV(m,m)-this.m_squaredDiameter);if(g>=0){var y=ht(g),x=(-v-y)/p;if(x>_)continue;if(x<0&&((x=(-v+y)/p)<0||x>_))continue;var S=bt.AddVMulSV(m,x,f,s);if(S.Normalize(),(_=it(_,t.ReportParticle(this,h,bt.AddVMulSV(n,x,f,c),S,x)))<=0)break}}}},r.ComputeAABB=function(t){var e=this.GetParticleCount();t.lowerBound.x=+i,t.lowerBound.y=+i,t.upperBound.x=-i,t.upperBound.y=-i;for(var n=this.m_positionBuffer.data,r=0;r<e;r++){var o=n[r];bt.MinV(t.lowerBound,o,t.lowerBound),bt.MaxV(t.upperBound,o,t.upperBound)}t.lowerBound.x-=this.m_particleDiameter,t.lowerBound.y-=this.m_particleDiameter,t.upperBound.x+=this.m_particleDiameter,t.upperBound.y+=this.m_particleDiameter},r.FreeBuffer=function(t){null!==t&&(t.length=0)},r.FreeUserOverridableBuffer=function(t){0===t.userSuppliedCapacity&&this.FreeBuffer(t.data,this.m_internalAllocatedCapacity)},r.ReallocateBuffer3=function(t,e,n){if(n<=e)throw new Error;var i=t?t.slice():[];return i.length=n,i},r.ReallocateBuffer5=function(t,e,n,i,r){if(i<=n)throw new Error;if(e&&!(i<=e))throw new Error;return r&&!t||e||(t=this.ReallocateBuffer3(t,n,i)),t},r.ReallocateBuffer4=function(t,e,n,i){return this.ReallocateBuffer5(t.data,t.userSuppliedCapacity,e,n,i)},r.RequestBuffer=function(t){return t||(0===this.m_internalAllocatedCapacity&&this.ReallocateInternalAllocatedBuffers(M),(t=[]).length=this.m_internalAllocatedCapacity),t},r.ReallocateHandleBuffers=function(t){this.m_handleIndexBuffer.data=this.ReallocateBuffer4(this.m_handleIndexBuffer,this.m_internalAllocatedCapacity,t,!0)},r.ReallocateInternalAllocatedBuffers=function(t){function e(t,e){return e&&t>e?e:t}if(t=e(t,this.m_def.maxCount),t=e(t,this.m_flagsBuffer.userSuppliedCapacity),t=e(t,this.m_positionBuffer.userSuppliedCapacity),t=e(t,this.m_velocityBuffer.userSuppliedCapacity),t=e(t,this.m_colorBuffer.userSuppliedCapacity),t=e(t,this.m_userDataBuffer.userSuppliedCapacity),this.m_internalAllocatedCapacity<t){this.ReallocateHandleBuffers(t),this.m_flagsBuffer.data=this.ReallocateBuffer4(this.m_flagsBuffer,this.m_internalAllocatedCapacity,t,!1);var n=this.m_stuckThreshold>0;this.m_lastBodyContactStepBuffer.data=this.ReallocateBuffer4(this.m_lastBodyContactStepBuffer,this.m_internalAllocatedCapacity,t,n),this.m_bodyContactCountBuffer.data=this.ReallocateBuffer4(this.m_bodyContactCountBuffer,this.m_internalAllocatedCapacity,t,n),this.m_consecutiveContactStepsBuffer.data=this.ReallocateBuffer4(this.m_consecutiveContactStepsBuffer,this.m_internalAllocatedCapacity,t,n),this.m_positionBuffer.data=this.ReallocateBuffer4(this.m_positionBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_velocityBuffer.data=this.ReallocateBuffer4(this.m_velocityBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_forceBuffer=this.ReallocateBuffer5(this.m_forceBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_weightBuffer=this.ReallocateBuffer5(this.m_weightBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_staticPressureBuffer=this.ReallocateBuffer5(this.m_staticPressureBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_accumulationBuffer=this.ReallocateBuffer5(this.m_accumulationBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_accumulation2Buffer=this.ReallocateBuffer5(this.m_accumulation2Buffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_depthBuffer=this.ReallocateBuffer5(this.m_depthBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_colorBuffer.data=this.ReallocateBuffer4(this.m_colorBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_groupBuffer=this.ReallocateBuffer5(this.m_groupBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_userDataBuffer.data=this.ReallocateBuffer4(this.m_userDataBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_expirationTimeBuffer.data=this.ReallocateBuffer4(this.m_expirationTimeBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_indexByExpirationTimeBuffer.data=this.ReallocateBuffer4(this.m_indexByExpirationTimeBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_internalAllocatedCapacity=t}},r.CreateParticleForGroup=function(t,e,i){var r=new Rr;r.flags=n(t.flags,0),Rt.MulXV(e,i,r.position),bt.AddVV(n(t.linearVelocity,bt.ZERO),bt.CrossSV(n(t.angularVelocity,0),bt.SubVV(r.position,n(t.position,bt.ZERO),bt.s_t0),bt.s_t0),r.velocity),r.color.Copy(n(t.color,Mt.ZERO)),r.lifetime=n(t.lifetime,0),r.userData=t.userData,this.CreateParticle(r)},r.CreateParticlesStrokeShapeForGroup=function(i,r,o){var a=e.CreateParticlesStrokeShapeForGroup_s_edge,s=e.CreateParticlesStrokeShapeForGroup_s_d,c=e.CreateParticlesStrokeShapeForGroup_s_p,l=n(r.stride,0);0===l&&(l=this.GetParticleStride());for(var u=0,h=i.GetChildCount(),_=0;_<h;_++){var f=null;i.GetType()===t.b2ShapeType.e_edgeShape?f=i:(f=a,i.GetChildEdge(f,_));for(var p=bt.SubVV(f.m_vertex2,f.m_vertex1,s),d=p.Length();u<d;){var m=bt.AddVMulSV(f.m_vertex1,u/d,p,c);this.CreateParticleForGroup(r,o,m),u+=l}u-=d}},r.CreateParticlesFillShapeForGroup=function(t,i,r){var o=e.CreateParticlesFillShapeForGroup_s_aabb,a=e.CreateParticlesFillShapeForGroup_s_p,s=n(i.stride,0);0===s&&(s=this.GetParticleStride());var c=Rt.IDENTITY,l=o;t.ComputeAABB(l,c,0);for(var u=Math.floor(l.lowerBound.y/s)*s;u<l.upperBound.y;u+=s)for(var h=Math.floor(l.lowerBound.x/s)*s;h<l.upperBound.x;h+=s){var _=a.Set(h,u);t.TestPoint(c,_)&&this.CreateParticleForGroup(i,r,_)}},r.CreateParticlesWithShapeForGroup=function(e,n,i){switch(e.GetType()){case t.b2ShapeType.e_edgeShape:case t.b2ShapeType.e_chainShape:this.CreateParticlesStrokeShapeForGroup(e,n,i);break;case t.b2ShapeType.e_polygonShape:case t.b2ShapeType.e_circleShape:this.CreateParticlesFillShapeForGroup(e,n,i)}},r.CreateParticlesWithShapesForGroup=function(t,e,n,i){var r=new mo(t,e);this.CreateParticlesFillShapeForGroup(r,n,i)},r.CloneParticle=function(t,e){var n=new Rr;n.flags=this.m_flagsBuffer.data[t],n.position.Copy(this.m_positionBuffer.data[t]),n.velocity.Copy(this.m_velocityBuffer.data[t]),this.m_colorBuffer.data&&n.color.Copy(this.m_colorBuffer.data[t]),this.m_userDataBuffer.data&&(n.userData=this.m_userDataBuffer.data[t]),n.group=e;var i=this.CreateParticle(n);if(this.m_handleIndexBuffer.data){var r=this.m_handleIndexBuffer.data[t];r&&r.SetIndex(i),this.m_handleIndexBuffer.data[i]=r,this.m_handleIndexBuffer.data[t]=null}return this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[i]=this.m_lastBodyContactStepBuffer.data[t]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[i]=this.m_bodyContactCountBuffer.data[t]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[i]=this.m_consecutiveContactStepsBuffer.data[t]),this.m_hasForce&&this.m_forceBuffer[i].Copy(this.m_forceBuffer[t]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[i]=this.m_staticPressureBuffer[t]),this.m_depthBuffer&&(this.m_depthBuffer[i]=this.m_depthBuffer[t]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[i]=this.m_expirationTimeBuffer.data[t]),i},r.DestroyParticlesInGroup=function(t,e){void 0===e&&(e=!1);for(var n=t.m_firstIndex;n<t.m_lastIndex;n++)this.DestroyParticle(n,e)},r.DestroyParticleGroup=function(t){this.m_world.m_destructionListener&&this.m_world.m_destructionListener.SayGoodbyeParticleGroup(t),this.SetGroupFlags(t,0);for(var e=t.m_firstIndex;e<t.m_lastIndex;e++)this.m_groupBuffer[e]=null;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_groupList&&(this.m_groupList=t.m_next),--this.m_groupCount},e.ParticleCanBeConnected=function(e,n){return 0!=(e&(t.b2ParticleFlag.b2_wallParticle|t.b2ParticleFlag.b2_springParticle|t.b2ParticleFlag.b2_elasticParticle))||null!==n&&0!=(n.GetGroupFlags()&t.b2ParticleGroupFlag.b2_rigidParticleGroup)},r.UpdatePairsAndTriads=function(n,i,r){for(var o=e.UpdatePairsAndTriads_s_dab,a=e.UpdatePairsAndTriads_s_dbc,s=e.UpdatePairsAndTriads_s_dca,c=this.m_positionBuffer.data,l=0,u=n;u<i;u++)l|=this.m_flagsBuffer.data[u];if(l&e.k_pairFlags)for(var h=0;h<this.m_contactBuffer.count;h++){var _=this.m_contactBuffer.data[h],f=_.indexA,p=_.indexB,d=this.m_flagsBuffer.data[f],m=this.m_flagsBuffer.data[p],v=this.m_groupBuffer[f],g=this.m_groupBuffer[p];if(f>=n&&f<i&&p>=n&&p<i&&!((d|m)&t.b2ParticleFlag.b2_zombieParticle)&&(d|m)&e.k_pairFlags&&(r.IsNecessary(f)||r.IsNecessary(p))&&e.ParticleCanBeConnected(d,v)&&e.ParticleCanBeConnected(m,g)&&r.ShouldCreatePair(f,p)){var y=this.m_pairBuffer.data[this.m_pairBuffer.Append()];y.indexA=f,y.indexB=p,y.flags=_.flags,y.strength=it(v?v.m_strength:1,g?g.m_strength:1),y.distance=bt.DistanceVV(c[f],c[p])}Hr(this.m_pairBuffer.data,0,this.m_pairBuffer.count,e.ComparePairIndices),this.m_pairBuffer.Unique(e.MatchPairIndices)}if(l&e.k_triadFlags){for(var x=new Fr(i-n),S=n;S<i;S++){var C=this.m_flagsBuffer.data[S],A=this.m_groupBuffer[S];C&t.b2ParticleFlag.b2_zombieParticle||!e.ParticleCanBeConnected(C,A)||x.AddGenerator(c[S],S,r.IsNecessary(S))}var b=this.GetParticleStride();x.Generate(b/2,2*b);var T=this,E=function(t,n,i){var l=T.m_flagsBuffer.data[t],u=T.m_flagsBuffer.data[n],h=T.m_flagsBuffer.data[i];if((l|u|h)&e.k_triadFlags&&r.ShouldCreateTriad(t,n,i)){var _=c[t],f=c[n],p=c[i],d=bt.SubVV(_,f,o),m=bt.SubVV(f,p,a),v=bt.SubVV(p,_,s),g=B*T.m_squaredDiameter;if(bt.DotVV(d,d)>g||bt.DotVV(m,m)>g||bt.DotVV(v,v)>g)return;var y=T.m_groupBuffer[t],x=T.m_groupBuffer[n],S=T.m_groupBuffer[i],C=T.m_triadBuffer.data[T.m_triadBuffer.Append()];C.indexA=t,C.indexB=n,C.indexC=i,C.flags=l|u|h,C.strength=it(it(y?y.m_strength:1,x?x.m_strength:1),S?S.m_strength:1);var A=(_.x+f.x+p.x)/3,b=(_.y+f.y+p.y)/3;C.pa.x=_.x-A,C.pa.y=_.y-b,C.pb.x=f.x-A,C.pb.y=f.y-b,C.pc.x=p.x-A,C.pc.y=p.y-b,C.ka=-bt.DotVV(v,d),C.kb=-bt.DotVV(d,m),C.kc=-bt.DotVV(m,v),C.s=bt.CrossVV(_,f)+bt.CrossVV(f,p)+bt.CrossVV(p,_)}};x.GetNodes(E),Hr(this.m_triadBuffer.data,0,this.m_triadBuffer.count,e.CompareTriadIndices),this.m_triadBuffer.Unique(e.MatchTriadIndices)}},r.UpdatePairsAndTriadsWithReactiveParticles=function(){var e=new vo(this.m_flagsBuffer);this.UpdatePairsAndTriads(0,this.m_count,e);for(var n=0;n<this.m_count;n++)this.m_flagsBuffer.data[n]&=~t.b2ParticleFlag.b2_reactiveParticle;this.m_allParticleFlags&=~t.b2ParticleFlag.b2_reactiveParticle},e.ComparePairIndices=function(t,e){var n=t.indexA-e.indexA;return 0!==n?n<0:t.indexB<e.indexB},e.MatchPairIndices=function(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB},e.CompareTriadIndices=function(t,e){var n=t.indexA-e.indexA;if(0!==n)return n<0;var i=t.indexB-e.indexB;return 0!==i?i<0:t.indexC<e.indexC},e.MatchTriadIndices=function(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB&&t.indexC===e.indexC},e.InitializeParticleLists=function(t,e){for(var n=t.GetBufferIndex(),i=t.GetParticleCount(),r=0;r<i;r++){var o=e[r];o.list=o,o.next=null,o.count=1,o.index=r+n}},r.MergeParticleListsInContact=function(t,n){for(var i=t.GetBufferIndex(),r=0;r<this.m_contactBuffer.count;r++){var o=this.m_contactBuffer.data[r],a=o.indexA,s=o.indexB;if(t.ContainsParticle(a)&&t.ContainsParticle(s)){var c=n[a-i].list,l=n[s-i].list;if(c!==l){if(c.count<l.count){var u=c;c=l,l=u}e.MergeParticleLists(c,l)}}}},e.MergeParticleLists=function(t,e){for(var n=e;;){n.list=t;var i=n.next;if(!i){n.next=t.next;break}n=i}t.next=e,t.count+=e.count,e.count=0},e.FindLongestParticleList=function(t,e){for(var n=t.GetParticleCount(),i=e[0],r=0;r<n;r++){var o=e[r];i.count<o.count&&(i=o)}return i},r.MergeZombieParticleListNodes=function(n,i,r){for(var o=n.GetParticleCount(),a=0;a<o;a++){var s=i[a];s!==r&&this.m_flagsBuffer.data[s.index]&t.b2ParticleFlag.b2_zombieParticle&&e.MergeParticleListAndNode(r,s)}},e.MergeParticleListAndNode=function(t,e){e.list=t,e.next=t.next,t.next=e,t.count++,e.count=0},r.CreateParticleGroupsFromParticleList=function(e,n,i){var r=e.GetParticleCount(),o=new Or;o.groupFlags=e.GetGroupFlags(),o.userData=e.GetUserData();for(var a=0;a<r;a++){var s=n[a];if(s.count&&s!==i)for(var c=this.CreateParticleGroup(o),l=s;l;l=l.next){var u=l.index,h=this.CloneParticle(u,c);this.m_flagsBuffer.data[u]|=t.b2ParticleFlag.b2_zombieParticle,l.index=h}}},r.UpdatePairsAndTriadsWithParticleList=function(t,e){for(var n=t.GetBufferIndex(),i=0;i<this.m_pairBuffer.count;i++){var r=this.m_pairBuffer.data[i],o=r.indexA,a=r.indexB;t.ContainsParticle(o)&&(r.indexA=e[o-n].index),t.ContainsParticle(a)&&(r.indexB=e[a-n].index)}for(var s=0;s<this.m_triadBuffer.count;s++){var c=this.m_triadBuffer.data[s],l=c.indexA,u=c.indexB,h=c.indexC;t.ContainsParticle(l)&&(c.indexA=e[l-n].index),t.ContainsParticle(u)&&(c.indexB=e[u-n].index),t.ContainsParticle(h)&&(c.indexC=e[h-n].index)}},r.ComputeDepth=function(){for(var e=[],n=0,r=0;r<this.m_contactBuffer.count;r++){var o=this.m_contactBuffer.data[r],a=o.indexA,s=o.indexB,c=this.m_groupBuffer[a],l=this.m_groupBuffer[s];c&&c===l&&c.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&(e[n++]=o)}for(var u=[],h=0,_=this.m_groupList;_;_=_.GetNext())if(_.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth){u[h++]=_,this.SetGroupFlags(_,_.m_groupFlags&~t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth);for(var f=_.m_firstIndex;f<_.m_lastIndex;f++)this.m_accumulationBuffer[f]=0}for(var p=0;p<n;p++){var d=e[p],m=d.indexA,v=d.indexB,g=d.weight;this.m_accumulationBuffer[m]+=g,this.m_accumulationBuffer[v]+=g}for(var y=0;y<h;y++)for(var x=u[y],S=x.m_firstIndex;S<x.m_lastIndex;S++){var C=this.m_accumulationBuffer[S];this.m_depthBuffer[S]=C<.8?0:i}for(var A=ht(this.m_count)>>0,b=0;b<A;b++){for(var T=!1,E=0;E<n;E++){var w=e[E],P=w.indexA,I=w.indexB,R=1-w.weight,D=this.m_depthBuffer[P],B=this.m_depthBuffer[I],M=B+R,O=D+R;D>M&&(this.m_depthBuffer[P]=M,T=!0),B>O&&(this.m_depthBuffer[I]=O,T=!0)}if(!T)break}for(var N=0;N<h;N++)for(var L=u[N],F=L.m_firstIndex;F<L.m_lastIndex;F++)this.m_depthBuffer[F]<i?this.m_depthBuffer[F]*=this.m_particleDiameter:this.m_depthBuffer[F]=0},r.GetInsideBoundsEnumerator=function(t){var n=e.computeTag(this.m_inverseDiameter*t.lowerBound.x-1,this.m_inverseDiameter*t.lowerBound.y-1),i=e.computeTag(this.m_inverseDiameter*t.upperBound.x+1,this.m_inverseDiameter*t.upperBound.y+1),r=0,o=this.m_proxyBuffer.count,a=Wr(this.m_proxyBuffer.data,r,o,n,ro.CompareProxyTag),s=qr(this.m_proxyBuffer.data,r,o,i,ro.CompareTagProxy);return new oo(this,n,i,a,s)},r.UpdateAllParticleFlags=function(){this.m_allParticleFlags=0;for(var t=0;t<this.m_count;t++)this.m_allParticleFlags|=this.m_flagsBuffer.data[t];this.m_needsUpdateAllParticleFlags=!1},r.UpdateAllGroupFlags=function(){this.m_allGroupFlags=0;for(var t=this.m_groupList;t;t=t.GetNext())this.m_allGroupFlags|=t.m_groupFlags;this.m_needsUpdateAllGroupFlags=!1},r.AddContact=function(t,n){var i=this.m_flagsBuffer.data,r=this.m_positionBuffer.data,o=bt.SubVV(r[n],r[t],e.AddContact_s_d),a=bt.DotVV(o,o);if(0<a&&a<this.m_squaredDiameter){var s=ut(a),c=this.m_contactBuffer.data[this.m_contactBuffer.Append()];c.indexA=t,c.indexB=n,c.flags=i[t]|i[n],c.weight=1-a*s*this.m_inverseDiameter,c.normal.x=s*o.x,c.normal.y=s*o.y}},r.FindContacts_Reference=function(){var t=0,n=this.m_proxyBuffer.count;this.m_contactBuffer.count=0;for(var i=t,r=t;i<n;i++){for(var o=e.computeRelativeTag(this.m_proxyBuffer.data[i].tag,1,0),a=i+1;a<n&&!(o<this.m_proxyBuffer.data[a].tag);a++)this.AddContact(this.m_proxyBuffer.data[i].index,this.m_proxyBuffer.data[a].index,this.m_contactBuffer);for(var s=e.computeRelativeTag(this.m_proxyBuffer.data[i].tag,-1,1);r<n&&!(s<=this.m_proxyBuffer.data[r].tag);r++);for(var c=e.computeRelativeTag(this.m_proxyBuffer.data[i].tag,1,1),l=r;l<n&&!(c<this.m_proxyBuffer.data[l].tag);l++)this.AddContact(this.m_proxyBuffer.data[i].index,this.m_proxyBuffer.data[l].index,this.m_contactBuffer)}},r.FindContacts=function(t){this.FindContacts_Reference(t)},r.UpdateProxies_Reference=function(){for(var t=this.m_positionBuffer.data,n=this.m_inverseDiameter,i=0;i<this.m_proxyBuffer.count;++i){var r=this.m_proxyBuffer.data[i],o=t[r.index];r.tag=e.computeTag(n*o.x,n*o.y)}},r.UpdateProxies=function(t){this.UpdateProxies_Reference(t)},r.SortProxies=function(){kr(this.m_proxyBuffer.data,0,this.m_proxyBuffer.count,ro.CompareProxyProxy)},r.FilterContacts=function(){var e=this.GetParticleContactFilter();if(null!==e){var n=this,i=function(i){return 0!=(i.flags&t.b2ParticleFlag.b2_particleContactFilterParticle)&&!e.ShouldCollideParticleParticle(n,i.indexA,i.indexB)};this.m_contactBuffer.RemoveIf(i)}},r.NotifyContactListenerPreContact=function(t){if(null!==this.GetParticleContactListener())throw t.Initialize(this.m_contactBuffer,this.m_flagsBuffer),new Error},r.NotifyContactListenerPostContact=function(){var t=this.GetParticleContactListener();if(null!==t){for(var e=0;e<this.m_contactBuffer.count;++e){var n=this.m_contactBuffer.data[e];t.BeginContactParticleParticle(this,n)}throw new Error}},e.b2ParticleContactIsZombie=function(e){return(e.flags&t.b2ParticleFlag.b2_zombieParticle)===t.b2ParticleFlag.b2_zombieParticle},r.UpdateContacts=function(t){this.UpdateProxies(this.m_proxyBuffer),this.SortProxies(this.m_proxyBuffer);var n=new ho;this.NotifyContactListenerPreContact(n),this.FindContacts(this.m_contactBuffer),this.FilterContacts(this.m_contactBuffer),this.NotifyContactListenerPostContact(n),t&&this.m_contactBuffer.RemoveIf(e.b2ParticleContactIsZombie)},r.NotifyBodyContactListenerPreContact=function(t){if(null!==this.GetFixtureContactListener())throw t.Initialize(this.m_bodyContactBuffer,this.m_flagsBuffer),new Error},r.NotifyBodyContactListenerPostContact=function(){var t=this.GetFixtureContactListener();if(null!==t){for(var e=0;e<this.m_bodyContactBuffer.count;e++){var n=this.m_bodyContactBuffer.data[e];t.BeginContactFixtureParticle(this,n)}throw new Error}},r.UpdateBodyContacts=function(){var t=e.UpdateBodyContacts_s_aabb,n=new lo;if(this.NotifyBodyContactListenerPreContact(n),this.m_stuckThreshold>0)for(var i=this.GetParticleCount(),r=0;r<i;r++)this.m_bodyContactCountBuffer.data[r]=0,this.m_timestamp>this.m_lastBodyContactStepBuffer.data[r]+1&&(this.m_consecutiveContactStepsBuffer.data[r]=0);this.m_bodyContactBuffer.SetCount(0),this.m_stuckParticleBuffer.SetCount(0);var o=t;this.ComputeAABB(o),null===this.UpdateBodyContacts_callback&&(this.UpdateBodyContacts_callback=new go(this));var a=this.UpdateBodyContacts_callback;a.m_contactFilter=this.GetFixtureContactFilter(),this.m_world.QueryAABB(a,o),this.m_def.strictContactCheck&&this.RemoveSpuriousBodyContacts(),this.NotifyBodyContactListenerPostContact(n)},r.Solve=function(n){var i=e.Solve_s_subStep;if(0!==this.m_count&&(this.m_expirationTimeBuffer.data&&this.SolveLifetimes(n),this.m_allParticleFlags&t.b2ParticleFlag.b2_zombieParticle&&this.SolveZombie(),this.m_needsUpdateAllParticleFlags&&this.UpdateAllParticleFlags(),this.m_needsUpdateAllGroupFlags&&this.UpdateAllGroupFlags(),!this.m_paused))for(this.m_iterationIndex=0;this.m_iterationIndex<n.particleIterations;this.m_iterationIndex++){++this.m_timestamp;var r=i.Copy(n);r.dt/=n.particleIterations,r.inv_dt*=n.particleIterations,this.UpdateContacts(!1),this.UpdateBodyContacts(),this.ComputeWeight(),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&this.ComputeDepth(),this.m_allParticleFlags&t.b2ParticleFlag.b2_reactiveParticle&&this.UpdatePairsAndTriadsWithReactiveParticles(),this.m_hasForce&&this.SolveForce(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_viscousParticle&&this.SolveViscous(),this.m_allParticleFlags&t.b2ParticleFlag.b2_repulsiveParticle&&this.SolveRepulsive(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_powderParticle&&this.SolvePowder(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_tensileParticle&&this.SolveTensile(r),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SolveSolid(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_colorMixingParticle&&this.SolveColorMixing(),this.SolveGravity(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_staticPressureParticle&&this.SolveStaticPressure(r),this.SolvePressure(r),this.SolveDamping(r),this.m_allParticleFlags&e.k_extraDampingFlags&&this.SolveExtraDamping(),this.m_allParticleFlags&t.b2ParticleFlag.b2_elasticParticle&&this.SolveElastic(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_springParticle&&this.SolveSpring(r),this.LimitVelocity(r),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigidDamping(),this.m_allParticleFlags&t.b2ParticleFlag.b2_barrierParticle&&this.SolveBarrier(r),this.SolveCollision(r),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigid(r),this.m_allParticleFlags&t.b2ParticleFlag.b2_wallParticle&&this.SolveWall();for(var o=0;o<this.m_count;o++)this.m_positionBuffer.data[o].SelfMulAdd(r.dt,this.m_velocityBuffer.data[o])}},r.SolveCollision=function(t){var n=e.SolveCollision_s_aabb,r=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,a=n;a.lowerBound.x=+i,a.lowerBound.y=+i,a.upperBound.x=-i,a.upperBound.y=-i;for(var s=0;s<this.m_count;s++){var c=o[s],l=r[s],u=l.x+t.dt*c.x,h=l.y+t.dt*c.y;a.lowerBound.x=it(a.lowerBound.x,it(l.x,u)),a.lowerBound.y=it(a.lowerBound.y,it(l.y,h)),a.upperBound.x=rt(a.upperBound.x,rt(l.x,u)),a.upperBound.y=rt(a.upperBound.y,rt(l.y,h))}null===this.SolveCollision_callback&&(this.SolveCollision_callback=new yo(this,t));var _=this.SolveCollision_callback;_.m_step=t,this.m_world.QueryAABB(_,a)},r.LimitVelocity=function(t){for(var e=this.m_velocityBuffer.data,n=this.GetCriticalVelocitySquared(t),i=0;i<this.m_count;i++){var r=e[i],o=bt.DotVV(r,r);o>n&&r.SelfMul(ht(n/o))}},r.SolveGravity=function(t){for(var n=e.SolveGravity_s_gravity,i=this.m_velocityBuffer.data,r=bt.MulSV(t.dt*this.m_def.gravityScale,this.m_world.GetGravity(),n),o=0;o<this.m_count;o++)i[o].SelfAdd(r)},r.SolveBarrier=function(n){for(var i=e.SolveBarrier_s_aabb,r=e.SolveBarrier_s_va,o=e.SolveBarrier_s_vb,a=e.SolveBarrier_s_pba,s=e.SolveBarrier_s_vba,c=e.SolveBarrier_s_vc,l=e.SolveBarrier_s_pca,u=e.SolveBarrier_s_vca,h=e.SolveBarrier_s_qba,_=e.SolveBarrier_s_qca,f=e.SolveBarrier_s_dv,p=e.SolveBarrier_s_f,d=this.m_positionBuffer.data,m=this.m_velocityBuffer.data,v=0;v<this.m_count;v++)0!=(this.m_flagsBuffer.data[v]&e.k_barrierWallFlags)&&m[v].SetZero();for(var g=O*n.dt,y=this.GetParticleMass(),x=0;x<this.m_pairBuffer.count;x++){var S=this.m_pairBuffer.data[x];if(S.flags&t.b2ParticleFlag.b2_barrierParticle){var C=S.indexA,A=S.indexB,b=d[C],T=d[A],E=i;bt.MinV(b,T,E.lowerBound),bt.MaxV(b,T,E.upperBound);for(var w=this.m_groupBuffer[C],P=this.m_groupBuffer[A],I=this.GetLinearVelocity(w,C,b,r),R=this.GetLinearVelocity(P,A,T,o),D=bt.SubVV(T,b,a),B=bt.SubVV(R,I,s),M=this.GetInsideBoundsEnumerator(E),N=void 0;(N=M.GetNext())>=0;){var L=d[N],F=this.m_groupBuffer[N];if(w!==F&&P!==F){var z=this.GetLinearVelocity(F,N,L,c),G=bt.SubVV(L,b,l),V=bt.SubVV(z,I,u),U=bt.CrossVV(B,V),k=bt.CrossVV(D,V)-bt.CrossVV(G,B),H=bt.CrossVV(D,G),j=void 0,W=void 0,q=h,X=_;if(0===U){if(0===k)continue;if(!((W=-H/k)>=0&&W<g))continue;if(bt.AddVMulSV(D,W,B,q),bt.AddVMulSV(G,W,V,X),!((j=bt.DotVV(q,X)/bt.DotVV(q,q))>=0&&j<=1))continue}else{var Y=k*k-4*H*U;if(Y<0)continue;var K=ht(Y),J=(-k-K)/(2*U),Q=(-k+K)/(2*U);if(J>Q){var Z=J;J=Q,Q=Z}if(W=J,bt.AddVMulSV(D,W,B,q),bt.AddVMulSV(G,W,V,X),j=bt.DotVV(q,X)/bt.DotVV(q,q),!(W>=0&&W<g&&j>=0&&j<=1)){if(!((W=Q)>=0&&W<g))continue;if(bt.AddVMulSV(D,W,B,q),bt.AddVMulSV(G,W,V,X),!((j=bt.DotVV(q,X)/bt.DotVV(q,q))>=0&&j<=1))continue}}var $=f;$.x=I.x+j*B.x-z.x,$.y=I.y+j*B.y-z.y;var tt=bt.MulSV(y,$,p);if(F&&this.IsRigidGroup(F)){var et=F.GetMass(),nt=F.GetInertia();et>0&&F.m_linearVelocity.SelfMulAdd(1/et,tt),nt>0&&(F.m_angularVelocity+=bt.CrossVV(bt.SubVV(L,F.GetCenter(),bt.s_t0),tt)/nt)}else m[N].SelfAdd($);this.ParticleApplyForce(N,tt.SelfMul(-n.inv_dt))}}}}},r.SolveStaticPressure=function(e){this.m_staticPressureBuffer=this.RequestBuffer(this.m_staticPressureBuffer);for(var n=this.GetCriticalPressure(e),i=this.m_def.staticPressureStrength*n,r=I*n,o=this.m_def.staticPressureRelaxation,a=0;a<this.m_def.staticPressureIterations;a++){for(var s=0;s<this.m_count;s++)this.m_accumulationBuffer[s]=0;for(var c=0;c<this.m_contactBuffer.count;c++){var l=this.m_contactBuffer.data[c];if(l.flags&t.b2ParticleFlag.b2_staticPressureParticle){var u=l.indexA,h=l.indexB,_=l.weight;this.m_accumulationBuffer[u]+=_*this.m_staticPressureBuffer[h],this.m_accumulationBuffer[h]+=_*this.m_staticPressureBuffer[u]}}for(var f=0;f<this.m_count;f++){var p=this.m_weightBuffer[f];if(this.m_flagsBuffer.data[f]&t.b2ParticleFlag.b2_staticPressureParticle){var d=(this.m_accumulationBuffer[f]+i*(p-P))/(p+o);this.m_staticPressureBuffer[f]=at(d,0,r)}else this.m_staticPressureBuffer[f]=0}}},r.ComputeWeight=function(){for(var t=0;t<this.m_count;t++)this.m_weightBuffer[t]=0;for(var e=0;e<this.m_bodyContactBuffer.count;e++){var n=this.m_bodyContactBuffer.data[e],i=n.index,r=n.weight;this.m_weightBuffer[i]+=r}for(var o=0;o<this.m_contactBuffer.count;o++){var a=this.m_contactBuffer.data[o],s=a.indexA,c=a.indexB,l=a.weight;this.m_weightBuffer[s]+=l,this.m_weightBuffer[c]+=l}},r.SolvePressure=function(n){for(var i=e.SolvePressure_s_f,r=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,a=this.GetCriticalPressure(n),s=this.m_def.pressureStrength*a,c=I*a,l=0;l<this.m_count;l++){var u=s*rt(0,this.m_weightBuffer[l]-P);this.m_accumulationBuffer[l]=it(u,c)}if(this.m_allParticleFlags&e.k_noPressureFlags)for(var h=0;h<this.m_count;h++)this.m_flagsBuffer.data[h]&e.k_noPressureFlags&&(this.m_accumulationBuffer[h]=0);if(this.m_allParticleFlags&t.b2ParticleFlag.b2_staticPressureParticle)for(var _=0;_<this.m_count;_++)this.m_flagsBuffer.data[_]&t.b2ParticleFlag.b2_staticPressureParticle&&(this.m_accumulationBuffer[_]+=this.m_staticPressureBuffer[_]);for(var f=n.dt/(this.m_def.density*this.m_particleDiameter),p=this.GetParticleInvMass(),d=0;d<this.m_bodyContactBuffer.count;d++){var m=this.m_bodyContactBuffer.data[d],v=m.index,g=m.body,y=m.weight,x=m.mass,S=m.normal,C=r[v],A=this.m_accumulationBuffer[v]+s*y,b=bt.MulSV(f*y*x*A,S,i);o[v].SelfMulSub(p,b),g.ApplyLinearImpulse(b,C,!0)}for(var T=0;T<this.m_contactBuffer.count;T++){var E=this.m_contactBuffer.data[T],w=E.indexA,R=E.indexB,D=E.weight,B=E.normal,M=this.m_accumulationBuffer[w]+this.m_accumulationBuffer[R],O=bt.MulSV(f*D*M,B,i);o[w].SelfSub(O),o[R].SelfAdd(O)}},r.SolveDamping=function(t){for(var n=e.SolveDamping_s_v,i=e.SolveDamping_s_f,r=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,a=this.m_def.dampingStrength,s=1/this.GetCriticalVelocity(t),c=this.GetParticleInvMass(),l=0;l<this.m_bodyContactBuffer.count;l++){var u=this.m_bodyContactBuffer.data[l],h=u.index,_=u.body,f=u.weight,p=u.mass,d=u.normal,m=r[h],v=bt.SubVV(_.GetLinearVelocityFromWorldPoint(m,bt.s_t0),o[h],n),g=bt.DotVV(v,d);if(g<0){var y=rt(a*f,it(-s*g,.5)),x=bt.MulSV(y*p*g,d,i);o[h].SelfMulAdd(c,x),_.ApplyLinearImpulse(x.SelfNeg(),m,!0)}}for(var S=0;S<this.m_contactBuffer.count;S++){var C=this.m_contactBuffer.data[S],A=C.indexA,b=C.indexB,T=C.weight,E=C.normal,w=bt.SubVV(o[b],o[A],n),P=bt.DotVV(w,E);if(P<0){var I=rt(a*T,it(-s*P,.5)),R=bt.MulSV(I*P,E,i);o[A].SelfAdd(R),o[b].SelfSub(R)}}},r.SolveRigidDamping=function(){for(var t=e.SolveRigidDamping_s_t0,n=e.SolveRigidDamping_s_t1,i=e.SolveRigidDamping_s_p,r=e.SolveRigidDamping_s_v,o=[0],a=[0],s=[0],c=[0],l=[0],u=[0],h=this.m_positionBuffer.data,_=this.m_def.dampingStrength,f=0;f<this.m_bodyContactBuffer.count;f++){var p=this.m_bodyContactBuffer.data[f],d=p.index,m=this.m_groupBuffer[d];if(m&&this.IsRigidGroup(m)){var v=p.body,g=p.normal,y=p.weight,x=h[d],S=bt.SubVV(v.GetLinearVelocityFromWorldPoint(x,t),m.GetLinearVelocityFromWorldPoint(x,n),r),C=bt.DotVV(S,g);if(C<0){this.InitDampingParameterWithRigidGroupOrParticle(o,a,s,!0,m,d,x,g),this.InitDampingParameter(c,l,u,v.GetMass(),v.GetInertia()-v.GetMass()*v.GetLocalCenter().LengthSquared(),v.GetWorldCenter(),x,g);var A=_*it(y,1)*this.ComputeDampingImpulse(o[0],a[0],s[0],c[0],l[0],u[0],C);this.ApplyDamping(o[0],a[0],s[0],!0,m,d,A,g),v.ApplyLinearImpulse(bt.MulSV(-A,g,bt.s_t0),x,!0)}}}for(var b=0;b<this.m_contactBuffer.count;b++){var T=this.m_contactBuffer.data[b],E=T.indexA,w=T.indexB,P=T.normal,I=T.weight,R=this.m_groupBuffer[E],D=this.m_groupBuffer[w],B=this.IsRigidGroup(R),M=this.IsRigidGroup(D);if(R!==D&&(B||M)){var O=bt.MidVV(h[E],h[w],i),N=bt.SubVV(this.GetLinearVelocity(D,w,O,t),this.GetLinearVelocity(R,E,O,n),r),L=bt.DotVV(N,P);if(L<0){this.InitDampingParameterWithRigidGroupOrParticle(o,a,s,B,R,E,O,P),this.InitDampingParameterWithRigidGroupOrParticle(c,l,u,M,D,w,O,P);var F=_*I*this.ComputeDampingImpulse(o[0],a[0],s[0],c[0],l[0],u[0],L);this.ApplyDamping(o[0],a[0],s[0],B,R,E,F,P),this.ApplyDamping(c[0],l[0],u[0],M,D,w,-F,P)}}}},r.SolveExtraDamping=function(){for(var t=e.SolveExtraDamping_s_v,n=e.SolveExtraDamping_s_f,i=this.m_velocityBuffer.data,r=this.m_positionBuffer.data,o=this.GetParticleInvMass(),a=0;a<this.m_bodyContactBuffer.count;a++){var s=this.m_bodyContactBuffer.data[a],c=s.index;if(this.m_flagsBuffer.data[c]&e.k_extraDampingFlags){var l=s.body,u=s.mass,h=s.normal,_=r[c],f=bt.SubVV(l.GetLinearVelocityFromWorldPoint(_,bt.s_t0),i[c],t),p=bt.DotVV(f,h);if(p<0){var d=bt.MulSV(.5*u*p,h,n);i[c].SelfMulAdd(o,d),l.ApplyLinearImpulse(d.SelfNeg(),_,!0)}}}},r.SolveWall=function(){for(var e=this.m_velocityBuffer.data,n=0;n<this.m_count;n++)this.m_flagsBuffer.data[n]&t.b2ParticleFlag.b2_wallParticle&&e[n].SetZero()},r.SolveRigid=function(n){for(var i=e.SolveRigid_s_position,r=e.SolveRigid_s_rotation,o=e.SolveRigid_s_transform,a=e.SolveRigid_s_velocityTransform,s=this.m_positionBuffer.data,c=this.m_velocityBuffer.data,l=this.m_groupList;l;l=l.GetNext())if(l.m_groupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup){l.UpdateStatistics();var u=r;u.SetAngle(n.dt*l.m_angularVelocity);var h=bt.AddVV(l.m_center,bt.SubVV(bt.MulSV(n.dt,l.m_linearVelocity,bt.s_t0),It.MulRV(u,l.m_center,bt.s_t1),bt.s_t0),i),_=o;_.SetPositionRotation(h,u),Rt.MulXX(_,l.m_transform,l.m_transform);var f=a;f.p.x=n.inv_dt*_.p.x,f.p.y=n.inv_dt*_.p.y,f.q.s=n.inv_dt*_.q.s,f.q.c=n.inv_dt*(_.q.c-1);for(var p=l.m_firstIndex;p<l.m_lastIndex;p++)Rt.MulXV(f,s[p],c[p])}},r.SolveElastic=function(n){for(var i=e.SolveElastic_s_pa,r=e.SolveElastic_s_pb,o=e.SolveElastic_s_pc,a=e.SolveElastic_s_r,s=e.SolveElastic_s_t0,c=this.m_positionBuffer.data,l=this.m_velocityBuffer.data,u=n.inv_dt*this.m_def.elasticStrength,h=0;h<this.m_triadBuffer.count;h++){var _=this.m_triadBuffer.data[h];if(_.flags&t.b2ParticleFlag.b2_elasticParticle){var f=_.indexA,p=_.indexB,d=_.indexC,m=_.pa,v=_.pb,g=_.pc,y=i.Copy(c[f]),x=r.Copy(c[p]),S=o.Copy(c[d]),C=l[f],A=l[p],b=l[d];y.SelfMulAdd(n.dt,C),x.SelfMulAdd(n.dt,A),S.SelfMulAdd(n.dt,b);var T=(y.x+x.x+S.x)/3,E=(y.y+x.y+S.y)/3;y.x-=T,y.y-=E,x.x-=T,x.y-=E,S.x-=T,S.y-=E;var w=a;w.s=bt.CrossVV(m,y)+bt.CrossVV(v,x)+bt.CrossVV(g,S),w.c=bt.DotVV(m,y)+bt.DotVV(v,x)+bt.DotVV(g,S);var P=ut(w.s*w.s+w.c*w.c);isFinite(P)||(P=198177537e11),w.s*=P,w.c*=P;var I=u*_.strength;It.MulRV(w,m,s),bt.SubVV(s,y,s),bt.MulSV(I,s,s),C.SelfAdd(s),It.MulRV(w,v,s),bt.SubVV(s,x,s),bt.MulSV(I,s,s),A.SelfAdd(s),It.MulRV(w,g,s),bt.SubVV(s,S,s),bt.MulSV(I,s,s),b.SelfAdd(s)}}},r.SolveSpring=function(n){for(var i=e.SolveSpring_s_pa,r=e.SolveSpring_s_pb,o=e.SolveSpring_s_d,a=e.SolveSpring_s_f,s=this.m_positionBuffer.data,c=this.m_velocityBuffer.data,l=n.inv_dt*this.m_def.springStrength,u=0;u<this.m_pairBuffer.count;u++){var h=this.m_pairBuffer.data[u];if(h.flags&t.b2ParticleFlag.b2_springParticle){var _=h.indexA,f=h.indexB,p=i.Copy(s[_]),d=r.Copy(s[f]),m=c[_],v=c[f];p.SelfMulAdd(n.dt,m),d.SelfMulAdd(n.dt,v);var g=bt.SubVV(d,p,o),y=h.distance,x=g.Length(),S=l*h.strength,C=bt.MulSV(S*(y-x)/x,g,a);m.SelfSub(C),v.SelfAdd(C)}}},r.SolveTensile=function(n){for(var i=e.SolveTensile_s_weightedNormal,r=e.SolveTensile_s_s,o=e.SolveTensile_s_f,a=this.m_velocityBuffer.data,s=0;s<this.m_count;s++)this.m_accumulation2Buffer[s]=new bt,this.m_accumulation2Buffer[s].SetZero();for(var c=0;c<this.m_contactBuffer.count;c++){var l=this.m_contactBuffer.data[c];if(l.flags&t.b2ParticleFlag.b2_tensileParticle){var u=l.indexA,h=l.indexB,_=l.weight,f=l.normal,p=bt.MulSV((1-_)*_,f,i);this.m_accumulation2Buffer[u].SelfSub(p),this.m_accumulation2Buffer[h].SelfAdd(p)}}for(var d=this.GetCriticalVelocity(n),m=this.m_def.surfaceTensionPressureStrength*d,v=this.m_def.surfaceTensionNormalStrength*d,g=R*d,y=0;y<this.m_contactBuffer.count;y++){var x=this.m_contactBuffer.data[y];if(x.flags&t.b2ParticleFlag.b2_tensileParticle){var S=x.indexA,C=x.indexB,A=x.weight,b=x.normal,T=this.m_weightBuffer[S]+this.m_weightBuffer[C],E=bt.SubVV(this.m_accumulation2Buffer[C],this.m_accumulation2Buffer[S],r),w=it(m*(T-2)+v*bt.DotVV(E,b),g)*A,P=bt.MulSV(w,b,o);a[S].SelfSub(P),a[C].SelfAdd(P)}}},r.SolveViscous=function(){for(var n=e.SolveViscous_s_v,i=e.SolveViscous_s_f,r=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,a=this.m_def.viscousStrength,s=this.GetParticleInvMass(),c=0;c<this.m_bodyContactBuffer.count;c++){var l=this.m_bodyContactBuffer.data[c],u=l.index;if(this.m_flagsBuffer.data[u]&t.b2ParticleFlag.b2_viscousParticle){var h=l.body,_=l.weight,f=l.mass,p=r[u],d=bt.SubVV(h.GetLinearVelocityFromWorldPoint(p,bt.s_t0),o[u],n),m=bt.MulSV(a*f*_,d,i);o[u].SelfMulAdd(s,m),h.ApplyLinearImpulse(m.SelfNeg(),p,!0)}}for(var v=0;v<this.m_contactBuffer.count;v++){var g=this.m_contactBuffer.data[v];if(g.flags&t.b2ParticleFlag.b2_viscousParticle){var y=g.indexA,x=g.indexB,S=g.weight,C=bt.SubVV(o[x],o[y],n),A=bt.MulSV(a*S,C,i);o[y].SelfAdd(A),o[x].SelfSub(A)}}},r.SolveRepulsive=function(n){for(var i=e.SolveRepulsive_s_f,r=this.m_velocityBuffer.data,o=this.m_def.repulsiveStrength*this.GetCriticalVelocity(n),a=0;a<this.m_contactBuffer.count;a++){var s=this.m_contactBuffer.data[a];if(s.flags&t.b2ParticleFlag.b2_repulsiveParticle){var c=s.indexA,l=s.indexB;if(this.m_groupBuffer[c]!==this.m_groupBuffer[l]){var u=s.weight,h=s.normal,_=bt.MulSV(o*u,h,i);r[c].SelfSub(_),r[l].SelfAdd(_)}}}},r.SolvePowder=function(n){for(var i=e.SolvePowder_s_f,r=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,a=this.m_def.powderStrength*this.GetCriticalVelocity(n),s=1-w,c=this.GetParticleInvMass(),l=0;l<this.m_bodyContactBuffer.count;l++){var u=this.m_bodyContactBuffer.data[l],h=u.index;if(this.m_flagsBuffer.data[h]&t.b2ParticleFlag.b2_powderParticle){var _=u.weight;if(_>s){var f=u.body,p=u.mass,d=r[h],m=u.normal,v=bt.MulSV(a*p*(_-s),m,i);o[h].SelfMulSub(c,v),f.ApplyLinearImpulse(v,d,!0)}}}for(var g=0;g<this.m_contactBuffer.count;g++){var y=this.m_contactBuffer.data[g];if(y.flags&t.b2ParticleFlag.b2_powderParticle){var x=y.weight;if(x>s){var S=y.indexA,C=y.indexB,A=y.normal,b=bt.MulSV(a*(x-s),A,i);o[S].SelfSub(b),o[C].SelfAdd(b)}}}},r.SolveSolid=function(t){var n=e.SolveSolid_s_f,i=this.m_velocityBuffer.data;this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer);for(var r=t.inv_dt*this.m_def.ejectionStrength,o=0;o<this.m_contactBuffer.count;o++){var a=this.m_contactBuffer.data[o],s=a.indexA,c=a.indexB;if(this.m_groupBuffer[s]!==this.m_groupBuffer[c]){var l=a.weight,u=a.normal,h=this.m_depthBuffer[s]+this.m_depthBuffer[c],_=bt.MulSV(r*h*l,u,n);i[s].SelfSub(_),i[c].SelfAdd(_)}}},r.SolveForce=function(t){for(var e=this.m_velocityBuffer.data,n=t.dt*this.GetParticleInvMass(),i=0;i<this.m_count;i++)e[i].SelfMulAdd(n,this.m_forceBuffer[i]);this.m_hasForce=!1},r.SolveColorMixing=function(){var e=.5*this.m_def.colorMixingStrength;if(e)for(var n=0;n<this.m_contactBuffer.count;n++){var i=this.m_contactBuffer.data[n],r=i.indexA,o=i.indexB;if(this.m_flagsBuffer.data[r]&this.m_flagsBuffer.data[o]&t.b2ParticleFlag.b2_colorMixingParticle){var a=this.m_colorBuffer.data[r],s=this.m_colorBuffer.data[o];Mt.MixColors(a,s,e)}}},r.SolveZombie=function(){for(var e=0,n=[],i=0;i<this.m_count;i++)n[i]=T;for(var r=0,o=0;o<this.m_count;o++){var a=this.m_flagsBuffer.data[o];if(a&t.b2ParticleFlag.b2_zombieParticle){var s=this.m_world.m_destructionListener;if(a&t.b2ParticleFlag.b2_destructionListenerParticle&&s&&s.SayGoodbyeParticle(this,o),this.m_handleIndexBuffer.data){var c=this.m_handleIndexBuffer.data[o];c&&(c.SetIndex(T),this.m_handleIndexBuffer.data[o]=null)}n[o]=T}else{if(n[o]=e,o!==e){if(this.m_handleIndexBuffer.data){var l=this.m_handleIndexBuffer.data[o];l&&l.SetIndex(e),this.m_handleIndexBuffer.data[e]=l}this.m_flagsBuffer.data[e]=this.m_flagsBuffer.data[o],this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[e]=this.m_lastBodyContactStepBuffer.data[o]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[e]=this.m_bodyContactCountBuffer.data[o]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[e]=this.m_consecutiveContactStepsBuffer.data[o]),this.m_positionBuffer.data[e].Copy(this.m_positionBuffer.data[o]),this.m_velocityBuffer.data[e].Copy(this.m_velocityBuffer.data[o]),this.m_groupBuffer[e]=this.m_groupBuffer[o],this.m_hasForce&&this.m_forceBuffer[e].Copy(this.m_forceBuffer[o]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[e]=this.m_staticPressureBuffer[o]),this.m_depthBuffer&&(this.m_depthBuffer[e]=this.m_depthBuffer[o]),this.m_colorBuffer.data&&this.m_colorBuffer.data[e].Copy(this.m_colorBuffer.data[o]),this.m_userDataBuffer.data&&(this.m_userDataBuffer.data[e]=this.m_userDataBuffer.data[o]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[e]=this.m_expirationTimeBuffer.data[o])}e++,r|=a}}for(var u={IsProxyInvalid:function(t){return t.index<0},IsContactInvalid:function(t){return t.indexA<0||t.indexB<0},IsBodyContactInvalid:function(t){return t.index<0},IsPairInvalid:function(t){return t.indexA<0||t.indexB<0},IsTriadInvalid:function(t){return t.indexA<0||t.indexB<0||t.indexC<0}},h=0;h<this.m_proxyBuffer.count;h++){var _=this.m_proxyBuffer.data[h];_.index=n[_.index]}this.m_proxyBuffer.RemoveIf(u.IsProxyInvalid);for(var f=0;f<this.m_contactBuffer.count;f++){var p=this.m_contactBuffer.data[f];p.indexA=n[p.indexA],p.indexB=n[p.indexB]}this.m_contactBuffer.RemoveIf(u.IsContactInvalid);for(var d=0;d<this.m_bodyContactBuffer.count;d++){var m=this.m_bodyContactBuffer.data[d];m.index=n[m.index]}this.m_bodyContactBuffer.RemoveIf(u.IsBodyContactInvalid);for(var v=0;v<this.m_pairBuffer.count;v++){var g=this.m_pairBuffer.data[v];g.indexA=n[g.indexA],g.indexB=n[g.indexB]}this.m_pairBuffer.RemoveIf(u.IsPairInvalid);for(var y=0;y<this.m_triadBuffer.count;y++){var x=this.m_triadBuffer.data[y];x.indexA=n[x.indexA],x.indexB=n[x.indexB],x.indexC=n[x.indexC]}if(this.m_triadBuffer.RemoveIf(u.IsTriadInvalid),this.m_indexByExpirationTimeBuffer.data)for(var S=0,C=0;C<this.m_count;C++){var A=n[this.m_indexByExpirationTimeBuffer.data[C]];A!==T&&(this.m_indexByExpirationTimeBuffer.data[S++]=A)}for(var b=this.m_groupList;b;b=b.GetNext()){for(var E=e,w=0,P=!1,I=b.m_firstIndex;I<b.m_lastIndex;I++){var R=n[I];R>=0?(E=it(E,R),w=rt(w,R+1)):P=!0}E<w?(b.m_firstIndex=E,b.m_lastIndex=w,P&&b.m_groupFlags&t.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SetGroupFlags(b,b.m_groupFlags|t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth)):(b.m_firstIndex=0,b.m_lastIndex=0,b.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupCanBeEmpty||this.SetGroupFlags(b,b.m_groupFlags|t.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed))}this.m_count=e,this.m_allParticleFlags=r,this.m_needsUpdateAllParticleFlags=!1;for(var D=this.m_groupList;D;){var B=D.GetNext();D.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed&&this.DestroyParticleGroup(D),D=B}},r.SolveLifetimes=function(t){this.m_timeElapsed=this.LifetimeToExpirationTime(t.dt);var e=this.GetQuantizedTimeElapsed(),n=this.m_expirationTimeBuffer.data,i=this.m_indexByExpirationTimeBuffer.data,r=this.GetParticleCount();this.m_expirationTimeBufferRequiresSorting&&(kr(i,0,r,(function(t,e){var i=n[t],r=n[e],o=i<=0;return o===r<=0?i>r:o})),this.m_expirationTimeBufferRequiresSorting=!1);for(var o=r-1;o>=0;--o){var a=i[o],s=n[a];if(e<s||s<=0)break;this.DestroyParticle(a)}},r.RotateBuffer=function(t,e,n){if(t!==e&&e!==n){if(Xr(this.m_flagsBuffer.data,t,e,n),this.m_lastBodyContactStepBuffer.data&&Xr(this.m_lastBodyContactStepBuffer.data,t,e,n),this.m_bodyContactCountBuffer.data&&Xr(this.m_bodyContactCountBuffer.data,t,e,n),this.m_consecutiveContactStepsBuffer.data&&Xr(this.m_consecutiveContactStepsBuffer.data,t,e,n),Xr(this.m_positionBuffer.data,t,e,n),Xr(this.m_velocityBuffer.data,t,e,n),Xr(this.m_groupBuffer,t,e,n),this.m_hasForce&&Xr(this.m_forceBuffer,t,e,n),this.m_staticPressureBuffer&&Xr(this.m_staticPressureBuffer,t,e,n),this.m_depthBuffer&&Xr(this.m_depthBuffer,t,e,n),this.m_colorBuffer.data&&Xr(this.m_colorBuffer.data,t,e,n),this.m_userDataBuffer.data&&Xr(this.m_userDataBuffer.data,t,e,n),this.m_handleIndexBuffer.data){Xr(this.m_handleIndexBuffer.data,t,e,n);for(var i=t;i<n;++i){var r=this.m_handleIndexBuffer.data[i];r&&r.SetIndex(y(r.GetIndex()))}}if(this.m_expirationTimeBuffer.data){Xr(this.m_expirationTimeBuffer.data,t,e,n);for(var o=this.GetParticleCount(),a=this.m_indexByExpirationTimeBuffer.data,s=0;s<o;++s)a[s]=y(a[s])}for(var c=0;c<this.m_proxyBuffer.count;c++){var l=this.m_proxyBuffer.data[c];l.index=y(l.index)}for(var u=0;u<this.m_contactBuffer.count;u++){var h=this.m_contactBuffer.data[u];h.indexA=y(h.indexA),h.indexB=y(h.indexB)}for(var _=0;_<this.m_bodyContactBuffer.count;_++){var f=this.m_bodyContactBuffer.data[_];f.index=y(f.index)}for(var p=0;p<this.m_pairBuffer.count;p++){var d=this.m_pairBuffer.data[p];d.indexA=y(d.indexA),d.indexB=y(d.indexB)}for(var m=0;m<this.m_triadBuffer.count;m++){var v=this.m_triadBuffer.data[m];v.indexA=y(v.indexA),v.indexB=y(v.indexB),v.indexC=y(v.indexC)}for(var g=this.m_groupList;g;g=g.GetNext())g.m_firstIndex=y(g.m_firstIndex),g.m_lastIndex=y(g.m_lastIndex-1)+1}function y(i){return i<t?i:i<e?i+n-e:i<n?i+t-e:i}},r.GetCriticalVelocity=function(t){return this.m_particleDiameter*t.inv_dt},r.GetCriticalVelocitySquared=function(t){var e=this.GetCriticalVelocity(t);return e*e},r.GetCriticalPressure=function(t){return this.m_def.density*this.GetCriticalVelocitySquared(t)},r.GetParticleStride=function(){return w*this.m_particleDiameter},r.GetParticleMass=function(){var t=this.GetParticleStride();return this.m_def.density*t*t},r.GetParticleInvMass=function(){var t=this.m_inverseDiameter*(1/w);return this.m_inverseDensity*t*t},r.GetFixtureContactFilter=function(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_fixtureContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null},r.GetParticleContactFilter=function(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_particleContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null},r.GetFixtureContactListener=function(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_fixtureContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null},r.GetParticleContactListener=function(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_particleContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null},r.SetUserOverridableBuffer=function(t,e){t.data=e,t.userSuppliedCapacity=e.length},r.SetGroupFlags=function(e,n){var i=e.m_groupFlags;(i^n)&t.b2ParticleGroupFlag.b2_solidParticleGroup&&(n|=t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth),i&~n&&(this.m_needsUpdateAllGroupFlags=!0),~this.m_allGroupFlags&n&&(n&t.b2ParticleGroupFlag.b2_solidParticleGroup&&(this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer)),this.m_allGroupFlags|=n),e.m_groupFlags=n},e.BodyContactCompare=function(t,e){return t.index===e.index?t.weight>e.weight:t.index<e.index},r.RemoveSpuriousBodyContacts=function(){kr(this.m_bodyContactBuffer.data,0,this.m_bodyContactBuffer.count,e.BodyContactCompare);var t=e.RemoveSpuriousBodyContacts_s_n,n=e.RemoveSpuriousBodyContacts_s_pos,i=e.RemoveSpuriousBodyContacts_s_normal,r=3,o=this,a=-1,s=0,c=function(e){if(e.index!==a&&(s=0,a=e.index),s++>r)return!0;var c=t.Copy(e.normal);c.SelfMul(o.m_particleDiameter*(1-e.weight));var l=bt.AddVV(o.m_positionBuffer.data[e.index],c,n);if(!e.fixture.TestPoint(l)){for(var u=e.fixture.GetShape().GetChildCount(),_=0;_<u;_++){var f=i;if(e.fixture.ComputeDistance(l,f,_)<h)return!1}return!0}return!1};this.m_bodyContactBuffer.count=jr(this.m_bodyContactBuffer.data,c,this.m_bodyContactBuffer.count)},r.DetectStuckParticle=function(t){this.m_stuckThreshold<=0||(++this.m_bodyContactCountBuffer.data[t],2===this.m_bodyContactCountBuffer.data[t]&&(++this.m_consecutiveContactStepsBuffer.data[t],this.m_consecutiveContactStepsBuffer.data[t]>this.m_stuckThreshold&&(this.m_stuckParticleBuffer.data[this.m_stuckParticleBuffer.Append()]=t)),this.m_lastBodyContactStepBuffer.data[t]=this.m_timestamp)},r.ValidateParticleIndex=function(t){return t>=0&&t<this.GetParticleCount()&&t!==T},r.GetQuantizedTimeElapsed=function(){return Math.floor(this.m_timeElapsed/4294967296)},r.LifetimeToExpirationTime=function(t){return this.m_timeElapsed+Math.floor(t/this.m_def.lifetimeGranularity*4294967296)},r.ForceCanBeApplied=function(e){return!(e&t.b2ParticleFlag.b2_wallParticle)},r.PrepareForceBuffer=function(){if(!this.m_hasForce){for(var t=0;t<this.m_count;t++)this.m_forceBuffer[t].SetZero();this.m_hasForce=!0}},r.IsRigidGroup=function(e){return null!==e&&0!=(e.m_groupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup)},r.GetLinearVelocity=function(t,e,n,i){return t&&this.IsRigidGroup(t)?t.GetLinearVelocityFromWorldPoint(n,i):i.Copy(this.m_velocityBuffer.data[e])},r.InitDampingParameter=function(t,e,n,i,r,o,a,s){t[0]=i>0?1/i:0,e[0]=r>0?1/r:0,n[0]=bt.CrossVV(bt.SubVV(a,o,bt.s_t0),s)},r.InitDampingParameterWithRigidGroupOrParticle=function(e,n,i,r,o,a,s,c){if(o&&r)this.InitDampingParameter(e,n,i,o.GetMass(),o.GetInertia(),o.GetCenter(),s,c);else{var l=this.m_flagsBuffer.data[a];this.InitDampingParameter(e,n,i,l&t.b2ParticleFlag.b2_wallParticle?0:this.GetParticleMass(),0,s,s,c)}},r.ComputeDampingImpulse=function(t,e,n,i,r,o,a){var s=t+e*n*n+i+r*o*o;return s>0?a/s:0},r.ApplyDamping=function(t,e,n,i,r,o,a,s){r&&i?(r.m_linearVelocity.SelfMulAdd(a*t,s),r.m_angularVelocity+=a*n*e):this.m_velocityBuffer.data[o].SelfMulAdd(a*t,s)},e}();no.xTruncBits=12,no.yTruncBits=12,no.tagBits=32,no.yOffset=1<<no.yTruncBits-1,no.yShift=no.tagBits-no.yTruncBits,no.xShift=no.tagBits-no.yTruncBits-no.xTruncBits,no.xScale=1<<no.xShift,no.xOffset=no.xScale*(1<<no.xTruncBits-1),no.yMask=(1<<no.yTruncBits)-1<<no.yShift,no.xMask=~no.yMask,no.DestroyParticlesInShape_s_aabb=new Te,no.CreateParticleGroup_s_transform=new Rt,no.ComputeCollisionEnergy_s_v=new bt,no.QueryShapeAABB_s_aabb=new Te,no.QueryPointAABB_s_aabb=new Te,no.RayCast_s_aabb=new Te,no.RayCast_s_p=new bt,no.RayCast_s_v=new bt,no.RayCast_s_n=new bt,no.RayCast_s_point=new bt,no.k_pairFlags=t.b2ParticleFlag.b2_springParticle,no.k_triadFlags=t.b2ParticleFlag.b2_elasticParticle,no.k_noPressureFlags=t.b2ParticleFlag.b2_powderParticle|t.b2ParticleFlag.b2_tensileParticle,no.k_extraDampingFlags=t.b2ParticleFlag.b2_staticPressureParticle,no.k_barrierWallFlags=t.b2ParticleFlag.b2_barrierParticle|t.b2ParticleFlag.b2_wallParticle,no.CreateParticlesStrokeShapeForGroup_s_edge=new ui,no.CreateParticlesStrokeShapeForGroup_s_d=new bt,no.CreateParticlesStrokeShapeForGroup_s_p=new bt,no.CreateParticlesFillShapeForGroup_s_aabb=new Te,no.CreateParticlesFillShapeForGroup_s_p=new bt,no.UpdatePairsAndTriads_s_dab=new bt,no.UpdatePairsAndTriads_s_dbc=new bt,no.UpdatePairsAndTriads_s_dca=new bt,no.AddContact_s_d=new bt,no.UpdateBodyContacts_s_aabb=new Te,no.Solve_s_subStep=new vr,no.SolveCollision_s_aabb=new Te,no.SolveGravity_s_gravity=new bt,no.SolveBarrier_s_aabb=new Te,no.SolveBarrier_s_va=new bt,no.SolveBarrier_s_vb=new bt,no.SolveBarrier_s_pba=new bt,no.SolveBarrier_s_vba=new bt,no.SolveBarrier_s_vc=new bt,no.SolveBarrier_s_pca=new bt,no.SolveBarrier_s_vca=new bt,no.SolveBarrier_s_qba=new bt,no.SolveBarrier_s_qca=new bt,no.SolveBarrier_s_dv=new bt,no.SolveBarrier_s_f=new bt,no.SolvePressure_s_f=new bt,no.SolveDamping_s_v=new bt,no.SolveDamping_s_f=new bt,no.SolveRigidDamping_s_t0=new bt,no.SolveRigidDamping_s_t1=new bt,no.SolveRigidDamping_s_p=new bt,no.SolveRigidDamping_s_v=new bt,no.SolveExtraDamping_s_v=new bt,no.SolveExtraDamping_s_f=new bt,no.SolveRigid_s_position=new bt,no.SolveRigid_s_rotation=new It,no.SolveRigid_s_transform=new Rt,no.SolveRigid_s_velocityTransform=new Rt,no.SolveElastic_s_pa=new bt,no.SolveElastic_s_pb=new bt,no.SolveElastic_s_pc=new bt,no.SolveElastic_s_r=new It,no.SolveElastic_s_t0=new bt,no.SolveSpring_s_pa=new bt,no.SolveSpring_s_pb=new bt,no.SolveSpring_s_d=new bt,no.SolveSpring_s_f=new bt,no.SolveTensile_s_weightedNormal=new bt,no.SolveTensile_s_s=new bt,no.SolveTensile_s_f=new bt,no.SolveViscous_s_v=new bt,no.SolveViscous_s_f=new bt,no.SolveRepulsive_s_f=new bt,no.SolvePowder_s_f=new bt,no.SolveSolid_s_f=new bt,no.RemoveSpuriousBodyContacts_s_n=new bt,no.RemoveSpuriousBodyContacts_s_pos=new bt,no.RemoveSpuriousBodyContacts_s_normal=new bt;var io=function(){function t(){this._data=null,this.userSuppliedCapacity=0}return K(t,[{key:"data",get:function(){return this._data},set:function(t){this._data=t}}]),t}(),ro=function(){function t(){this.index=T,this.tag=0}return t.CompareProxyProxy=function(t,e){return t.tag<e.tag},t.CompareTagProxy=function(t,e){return t<e.tag},t.CompareProxyTag=function(t,e){return t.tag<e},t}(),oo=function(){function t(t,e,n,i,r){this.m_system=t,this.m_xLower=(e&no.xMask)>>>0,this.m_xUpper=(n&no.xMask)>>>0,this.m_yLower=(e&no.yMask)>>>0,this.m_yUpper=(n&no.yMask)>>>0,this.m_first=i,this.m_last=r}return t.prototype.GetNext=function(){for(;this.m_first<this.m_last;){var t=(this.m_system.m_proxyBuffer.data[this.m_first].tag&no.xMask)>>>0;if(t>=this.m_xLower&&t<=this.m_xUpper)return this.m_system.m_proxyBuffer.data[this.m_first++].index;this.m_first++}return T},t}(),ao=function(){this.next=null,this.count=0,this.index=0},so=function(){function t(){}var e=t.prototype;return e.Allocate=function(t,e){return e},e.Clear=function(){},e.GetCount=function(){return 0},e.Invalidate=function(){},e.GetValidBuffer=function(){return[]},e.GetBuffer=function(){return[]},e.SetCount=function(){},t}(),co=function(t,e){this.second=T,this.first=t,this.second=e},lo=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.Initialize=function(){},n.Find=function(){return T},e}(so),uo=function(t,e){this.first=T,this.second=T,this.first=t,this.second=e},ho=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.Initialize=function(){},n.Find=function(){return T},e}(so),_o=function(){function t(){}var e=t.prototype;return e.IsNecessary=function(){return!0},e.ShouldCreatePair=function(){return!0},e.ShouldCreateTriad=function(){return!0},t}(),fo=function(t){function e(e,n,i,r){var o;return(o=t.call(this)||this).m_callDestructionListener=!1,o.m_destroyed=0,o.m_system=e,o.m_shape=n,o.m_xf=i,o.m_callDestructionListener=r,o.m_destroyed=0,o}Q(e,t);var n=e.prototype;return n.ReportFixture=function(){return!1},n.ReportParticle=function(t,e){return t===this.m_system&&(this.m_shape.TestPoint(this.m_xf,this.m_system.m_positionBuffer.data[e])&&(this.m_system.DestroyParticle(e,this.m_callDestructionListener),this.m_destroyed++),!0)},n.Destroyed=function(){return this.m_destroyed},e}(fr),po=function(t){function e(e){var n;return(n=t.call(this)||this).m_threshold=0,n.m_threshold=e,n}Q(e,t);var n=e.prototype;return n.ShouldCreatePair=function(t,e){return t<this.m_threshold&&this.m_threshold<=e||e<this.m_threshold&&this.m_threshold<=t},n.ShouldCreateTriad=function(t,e,n){return(t<this.m_threshold||e<this.m_threshold||n<this.m_threshold)&&(this.m_threshold<=t||this.m_threshold<=e||this.m_threshold<=n)},e}(_o),mo=function(e){function n(n,i){var r;return void 0===i&&(i=n.length),(r=e.call(this,t.b2ShapeType.e_unknown,0)||this).m_shapeCount=0,r.m_shapes=n,r.m_shapeCount=i,r}Q(n,e);var r=n.prototype;return r.Clone=function(){throw new Error},r.GetChildCount=function(){return 1},r.TestPoint=function(t,e){for(var n=0;n<this.m_shapeCount;n++)if(this.m_shapes[n].TestPoint(t,e))return!0;return!1},r.ComputeDistance=function(){return 0},r.RayCast=function(){return!1},r.ComputeAABB=function(t,e){var n=new Te;t.lowerBound.x=+i,t.lowerBound.y=+i,t.upperBound.x=-i,t.upperBound.y=-i;for(var r=0;r<this.m_shapeCount;r++)for(var o=this.m_shapes[r].GetChildCount(),a=0;a<o;a++){var s=n;this.m_shapes[r].ComputeAABB(s,e,a),t.Combine1(s)}},r.ComputeMass=function(){},r.SetupDistanceProxy=function(){},r.ComputeSubmergedArea=function(){return 0},r.Dump=function(){},n}(si),vo=function(e){function n(t){var n;return(n=e.call(this)||this).m_flagsBuffer=t,n}return Q(n,e),n.prototype.IsNecessary=function(e){return 0!=(this.m_flagsBuffer.data[e]&t.b2ParticleFlag.b2_reactiveParticle)},n}(_o),go=function(e){function n(t,n){var i;return void 0===n&&(n=null),(i=e.call(this,t)||this).m_contactFilter=null,i.m_contactFilter=n,i}Q(n,e);var i=n.prototype;return i.ShouldCollideFixtureParticle=function(e,n,i){return!(this.m_contactFilter&&this.m_system.GetFlagsBuffer()[i]&t.b2ParticleFlag.b2_fixtureContactFilterParticle)||this.m_contactFilter.ShouldCollideFixtureParticle(e,this.m_system,i)},i.ReportFixtureAndParticle=function(e,i,r){var o=n.ReportFixtureAndParticle_s_n,a=n.ReportFixtureAndParticle_s_rp,s=this.m_system.m_positionBuffer.data[r],c=o,l=e.ComputeDistance(s,c,i);if(l<this.m_system.m_particleDiameter&&this.ShouldCollideFixtureParticle(e,this.m_system,r)){var u=e.GetBody(),h=u.GetWorldCenter(),_=u.GetMass(),f=u.GetInertia()-_*u.GetLocalCenter().LengthSquared(),p=_>0?1/_:0,d=f>0?1/f:0,m=this.m_system.m_flagsBuffer.data[r]&t.b2ParticleFlag.b2_wallParticle?0:this.m_system.GetParticleInvMass(),v=bt.SubVV(s,h,a),g=bt.CrossVV(v,c),y=m+p+d*g*g,x=this.m_system.m_bodyContactBuffer.data[this.m_system.m_bodyContactBuffer.Append()];x.index=r,x.body=u,x.fixture=e,x.weight=1-l*this.m_system.m_inverseDiameter,x.normal.Copy(c.SelfNeg()),x.mass=y>0?1/y:0,this.m_system.DetectStuckParticle(r)}},n}(Jr);go.ReportFixtureAndParticle_s_n=new bt,go.ReportFixtureAndParticle_s_rp=new bt;var yo=function(e){function n(t,n){var i;return(i=e.call(this,t)||this).m_step=n,i}Q(n,e);var i=n.prototype;return i.ReportFixtureAndParticle=function(e,i,r){var o=n.ReportFixtureAndParticle_s_p1,a=n.ReportFixtureAndParticle_s_output,s=n.ReportFixtureAndParticle_s_input,c=n.ReportFixtureAndParticle_s_p,l=n.ReportFixtureAndParticle_s_v,u=n.ReportFixtureAndParticle_s_f,_=e.GetBody(),f=this.m_system.m_positionBuffer.data[r],p=this.m_system.m_velocityBuffer.data[r],d=a,m=s;if(0===this.m_system.m_iterationIndex){var v=Rt.MulTXV(_.m_xf0,f,o);e.GetShape().GetType()===t.b2ShapeType.e_circleShape&&(v.SelfSub(_.GetLocalCenter()),It.MulRV(_.m_xf0.q,v,v),It.MulTRV(_.m_xf.q,v,v),v.SelfAdd(_.GetLocalCenter())),Rt.MulXV(_.m_xf,v,m.p1)}else m.p1.Copy(f);if(bt.AddVMulSV(f,this.m_step.dt,p,m.p2),m.maxFraction=1,e.RayCast(d,m,i)){var g=d.normal,y=c;y.x=(1-d.fraction)*m.p1.x+d.fraction*m.p2.x+h*g.x,y.y=(1-d.fraction)*m.p1.y+d.fraction*m.p2.y+h*g.y;var x=l;x.x=this.m_step.inv_dt*(y.x-f.x),x.y=this.m_step.inv_dt*(y.y-f.y),this.m_system.m_velocityBuffer.data[r].Copy(x);var S=u;S.x=this.m_step.inv_dt*this.m_system.GetParticleMass()*(p.x-x.x),S.y=this.m_step.inv_dt*this.m_system.GetParticleMass()*(p.y-x.y),this.m_system.ParticleApplyForce(r,S)}},i.ReportParticle=function(){return!1},n}(Jr);yo.ReportFixtureAndParticle_s_p1=new bt,yo.ReportFixtureAndParticle_s_output=new be,yo.ReportFixtureAndParticle_s_input=new Ae,yo.ReportFixtureAndParticle_s_p=new bt,yo.ReportFixtureAndParticle_s_v=new bt,yo.ReportFixtureAndParticle_s_f=new bt;var xo=function(){function e(t){this.m_newFixture=!1,this.m_locked=!1,this.m_clearForces=!0,this.m_contactManager=new dr,this.m_bodyList=null,this.m_jointList=null,this.m_particleSystemList=null,this.m_bodyCount=0,this.m_jointCount=0,this.m_gravity=new bt,this.m_allowSleep=!0,this.m_destructionListener=null,this.m_debugDraw=null,this.m_inv_dt0=0,this.m_warmStarting=!0,this.m_continuousPhysics=!0,this.m_subStepping=!1,this.m_stepComplete=!0,this.m_profile=new mr,this.m_island=new Ir,this.s_stack=[],this.m_controllerList=null,this.m_controllerCount=0,this.m_gravity.Copy(t)}var n=e.prototype;return n.SetDestructionListener=function(t){this.m_destructionListener=t},n.SetContactFilter=function(t){this.m_contactManager.m_contactFilter=t},n.SetContactListener=function(t){this.m_contactManager.m_contactListener=t},n.SetDebugDraw=function(t){this.m_debugDraw=t},n.CreateBody=function(t){if(void 0===t&&(t={}),this.IsLocked())throw new Error;var e=new xi(t,this);return e.m_prev=null,e.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=e),this.m_bodyList=e,++this.m_bodyCount,e},n.DestroyBody=function(t){if(this.IsLocked())throw new Error;for(var e=t.m_jointList;e;){var n=e;e=e.next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeJoint(n.joint),this.DestroyJoint(n.joint),t.m_jointList=e}t.m_jointList=null;for(var i=t.m_controllerList;i;){var r=i;i=i.nextController,r.controller.RemoveBody(t)}for(var o=t.m_contactList;o;){var a=o;o=o.next,this.m_contactManager.Destroy(a.contact)}t.m_contactList=null;for(var s=t.m_fixtureList;s;){var c=s;s=s.m_next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeFixture(c),c.DestroyProxies(),c.Reset(),t.m_fixtureList=s,t.m_fixtureCount-=1}t.m_fixtureList=null,t.m_fixtureCount=0,t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_bodyList&&(this.m_bodyList=t.m_next),--this.m_bodyCount},e._Joint_Create=function(e){switch(e.type){case t.b2JointType.e_distanceJoint:return new Ei(e);case t.b2JointType.e_mouseJoint:return new Li(e);case t.b2JointType.e_prismaticJoint:return new zi(e);case t.b2JointType.e_revoluteJoint:return new Hi(e);case t.b2JointType.e_pulleyJoint:return new Ui(e);case t.b2JointType.e_gearJoint:return new Bi(e);case t.b2JointType.e_wheelJoint:return new Ki(e);case t.b2JointType.e_weldJoint:return new Xi(e);case t.b2JointType.e_frictionJoint:return new Ri(e);case t.b2JointType.e_ropeJoint:return new Wi(e);case t.b2JointType.e_motorJoint:return new Oi(e);case t.b2JointType.e_areaJoint:return new Pi(e)}throw new Error},e._Joint_Destroy=function(){},n.CreateJoint=function(t){if(this.IsLocked())throw new Error;var n=e._Joint_Create(t);n.m_prev=null,n.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=n),this.m_jointList=n,++this.m_jointCount,n.m_edgeA.prev=null,n.m_edgeA.next=n.m_bodyA.m_jointList,n.m_bodyA.m_jointList&&(n.m_bodyA.m_jointList.prev=n.m_edgeA),n.m_bodyA.m_jointList=n.m_edgeA,n.m_edgeB.prev=null,n.m_edgeB.next=n.m_bodyB.m_jointList,n.m_bodyB.m_jointList&&(n.m_bodyB.m_jointList.prev=n.m_edgeB),n.m_bodyB.m_jointList=n.m_edgeB;var i=n.m_bodyA,r=n.m_bodyB;if(!n.m_collideConnected)for(var o=r.GetContactList();o;)o.other===i&&o.contact.FlagForFiltering(),o=o.next;return n},n.DestroyJoint=function(t){if(this.IsLocked())throw new Error;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_jointList&&(this.m_jointList=t.m_next);var n=t.m_bodyA,i=t.m_bodyB,r=t.m_collideConnected;if(n.SetAwake(!0),i.SetAwake(!0),t.m_edgeA.prev&&(t.m_edgeA.prev.next=t.m_edgeA.next),t.m_edgeA.next&&(t.m_edgeA.next.prev=t.m_edgeA.prev),t.m_edgeA===n.m_jointList&&(n.m_jointList=t.m_edgeA.next),t.m_edgeA.Reset(),t.m_edgeB.prev&&(t.m_edgeB.prev.next=t.m_edgeB.next),t.m_edgeB.next&&(t.m_edgeB.next.prev=t.m_edgeB.prev),t.m_edgeB===i.m_jointList&&(i.m_jointList=t.m_edgeB.next),t.m_edgeB.Reset(),e._Joint_Destroy(t),--this.m_jointCount,!r)for(var o=i.GetContactList();o;)o.other===n&&o.contact.FlagForFiltering(),o=o.next},n.CreateParticleSystem=function(t){if(this.IsLocked())throw new Error;var e=new no(t,this);return e.m_prev=null,e.m_next=this.m_particleSystemList,this.m_particleSystemList&&(this.m_particleSystemList.m_prev=e),this.m_particleSystemList=e,e},n.DestroyParticleSystem=function(t){if(this.IsLocked())throw new Error;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_particleSystemList&&(this.m_particleSystemList=t.m_next)},n.CalculateReasonableParticleIterations=function(t){if(null===this.m_particleSystemList)return 1;function e(t){for(var e=i,n=t.GetParticleSystemList();null!==n;n=n.m_next)e=it(e,n.GetRadius());return e}return Dr(this.m_gravity.Length(),e(this),t)},n.Step=function(t,n,i,r){void 0===r&&(r=this.CalculateReasonableParticleIterations(t));var o=e.Step_s_stepTimer.Reset();this.m_newFixture&&(this.m_contactManager.FindNewContacts(),this.m_newFixture=!1),this.m_locked=!0;var a=e.Step_s_step;a.dt=t,a.velocityIterations=n,a.positionIterations=i,a.particleIterations=r,a.inv_dt=t>0?1/t:0,a.dtRatio=this.m_inv_dt0*t,a.warmStarting=this.m_warmStarting;var s=e.Step_s_timer.Reset();if(this.m_contactManager.Collide(),this.m_profile.collide=s.GetMilliseconds(),this.m_stepComplete&&a.dt>0){for(var c=e.Step_s_timer.Reset(),l=this.m_particleSystemList;l;l=l.m_next)l.Solve(a);this.Solve(a),this.m_profile.solve=c.GetMilliseconds()}if(this.m_continuousPhysics&&a.dt>0){var u=e.Step_s_timer.Reset();this.SolveTOI(a),this.m_profile.solveTOI=u.GetMilliseconds()}a.dt>0&&(this.m_inv_dt0=a.inv_dt),this.m_clearForces&&this.ClearForces(),this.m_locked=!1,this.m_profile.step=o.GetMilliseconds()},n.ClearForces=function(){for(var t=this.m_bodyList;t;t=t.m_next)t.m_force.SetZero(),t.m_torque=0},n.DrawParticleSystem=function(t){if(null!==this.m_debugDraw){var e=t.GetParticleCount();if(e){var n=t.GetRadius(),i=t.GetPositionBuffer();if(t.m_colorBuffer.data){var r=t.GetColorBuffer();this.m_debugDraw.DrawParticles(i,n,r,e)}else this.m_debugDraw.DrawParticles(i,n,null,e)}}},n.DrawDebugData=function(){if(null!==this.m_debugDraw){var n=this.m_debugDraw.GetFlags(),i=e.DrawDebugData_s_color.SetRGB(0,0,0);if(n&t.b2DrawFlags.e_shapeBit)for(var r=this.m_bodyList;r;r=r.m_next){var o=r.m_xf;this.m_debugDraw.PushTransform(o);for(var a=r.GetFixtureList();a;a=a.m_next)r.IsActive()?r.GetType()===t.b2BodyType.b2_staticBody?(i.SetRGB(.5,.9,.5),this.DrawShape(a,i)):r.GetType()===t.b2BodyType.b2_kinematicBody?(i.SetRGB(.5,.5,.9),this.DrawShape(a,i)):r.IsAwake()?(i.SetRGB(.9,.7,.7),this.DrawShape(a,i)):(i.SetRGB(.6,.6,.6),this.DrawShape(a,i)):(i.SetRGB(.5,.5,.3),this.DrawShape(a,i));this.m_debugDraw.PopTransform(o)}if(n&t.b2DrawFlags.e_particleBit)for(var s=this.m_particleSystemList;s;s=s.m_next)this.DrawParticleSystem(s);if(n&t.b2DrawFlags.e_jointBit)for(var c=this.m_jointList;c;c=c.m_next)this.DrawJoint(c);if(n&t.b2DrawFlags.e_aabbBit){i.SetRGB(.9,.3,.9);for(var l=e.DrawDebugData_s_vs,u=this.m_bodyList;u;u=u.m_next)if(u.IsActive())for(var h=u.GetFixtureList();h;h=h.m_next)for(var _=0;_<h.m_proxyCount;++_){var f=h.m_proxies[_].treeNode.aabb;l[0].Set(f.lowerBound.x,f.lowerBound.y),l[1].Set(f.upperBound.x,f.lowerBound.y),l[2].Set(f.upperBound.x,f.upperBound.y),l[3].Set(f.lowerBound.x,f.upperBound.y),this.m_debugDraw.DrawPolygon(l,4,i)}}if(n&t.b2DrawFlags.e_centerOfMassBit)for(var p=this.m_bodyList;p;p=p.m_next){var d=e.DrawDebugData_s_xf;d.q.Copy(p.m_xf.q),d.p.Copy(p.GetWorldCenter()),this.m_debugDraw.DrawTransform(d)}if(n&t.b2DrawFlags.e_controllerBit)for(var m=this.m_controllerList;m;m=m.m_next)m.Draw(this.m_debugDraw)}},n.QueryAABB=function(){(arguments.length<=0?void 0:arguments[0])instanceof fr?this._QueryAABB(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1]):this._QueryAABB(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1])},n._QueryAABB=function(t,e,n){if(this.m_contactManager.m_broadPhase.Query(e,(function(e){var i=e.userData.fixture;return t?t.ReportFixture(i):!n||n(i)})),t instanceof fr)for(var i=this.m_particleSystemList;i;i=i.m_next)t.ShouldQueryParticleSystem(i)&&i.QueryAABB(t,e)},n.QueryAllAABB=function(t,e){return void 0===e&&(e=[]),this.QueryAABB(t,(function(t){return e.push(t),!0})),e},n.QueryPointAABB=function(){(arguments.length<=0?void 0:arguments[0])instanceof fr?this._QueryPointAABB(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1]):this._QueryPointAABB(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1])},n._QueryPointAABB=function(t,e,n){if(this.m_contactManager.m_broadPhase.QueryPoint(e,(function(e){var i=e.userData.fixture;return t?t.ReportFixture(i):!n||n(i)})),t instanceof fr)for(var i=this.m_particleSystemList;i;i=i.m_next)t.ShouldQueryParticleSystem(i)&&i.QueryPointAABB(t,e)},n.QueryAllPointAABB=function(t,e){return void 0===e&&(e=[]),this.QueryPointAABB(t,(function(t){return e.push(t),!0})),e},n.QueryFixtureShape=function(){(arguments.length<=0?void 0:arguments[0])instanceof fr?this._QueryFixtureShape(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2],arguments.length<=3?void 0:arguments[3]):this._QueryFixtureShape(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2],arguments.length<=3?void 0:arguments[3])},n._QueryFixtureShape=function(t,n,i,r,o){var a=e.QueryFixtureShape_s_aabb;if(n.ComputeAABB(a,r,i),this.m_contactManager.m_broadPhase.Query(a,(function(e){var a=e.userData,s=a.fixture;if(De(n,i,s.GetShape(),a.childIndex,r,s.GetBody().GetTransform())){if(t)return t.ReportFixture(s);if(o)return o(s)}return!0})),t instanceof fr)for(var s=this.m_particleSystemList;s;s=s.m_next)t.ShouldQueryParticleSystem(s)&&s.QueryAABB(t,a)},n.QueryAllFixtureShape=function(t,e,n,i){return void 0===i&&(i=[]),this.QueryFixtureShape(t,e,n,(function(t){return i.push(t),!0})),i},n.QueryFixturePoint=function(){(arguments.length<=0?void 0:arguments[0])instanceof fr?this._QueryFixturePoint(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1]):this._QueryFixturePoint(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1])},n._QueryFixturePoint=function(t,e,n){if(this.m_contactManager.m_broadPhase.QueryPoint(e,(function(i){var r=i.userData.fixture;if(r.TestPoint(e)){if(t)return t.ReportFixture(r);if(n)return n(r)}return!0})),t)for(var i=this.m_particleSystemList;i;i=i.m_next)t.ShouldQueryParticleSystem(i)&&i.QueryPointAABB(t,e)},n.QueryAllFixturePoint=function(t,e){return void 0===e&&(e=[]),this.QueryFixturePoint(t,(function(t){return e.push(t),!0})),e},n.RayCast=function(){(arguments.length<=0?void 0:arguments[0])instanceof pr?this._RayCast(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2]):this._RayCast(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2])},n._RayCast=function(t,n,i,r){var o=e.RayCast_s_input;if(o.maxFraction=1,o.p1.Copy(n),o.p2.Copy(i),this.m_contactManager.m_broadPhase.RayCast(o,(function(o,a){var s=a.userData,c=s.fixture,l=s.childIndex,u=e.RayCast_s_output;if(c.RayCast(u,o,l)){var h=u.fraction,_=e.RayCast_s_point;if(_.Set((1-h)*n.x+h*i.x,(1-h)*n.y+h*i.y),t)return t.ReportFixture(c,_,u.normal,h);if(r)return r(c,_,u.normal,h)}return o.maxFraction})),t)for(var a=this.m_particleSystemList;a;a=a.m_next)t.ShouldQueryParticleSystem(a)&&a.RayCast(t,n,i)},n.RayCastOne=function(t,e){var n=null,i=1;return this.RayCast(t,e,(function(t,e,r,o){return o<i&&(i=o,n=t),i})),n},n.RayCastAll=function(t,e,n){return void 0===n&&(n=[]),this.RayCast(t,e,(function(t){return n.push(t),1})),n},n.GetBodyList=function(){return this.m_bodyList},n.GetJointList=function(){return this.m_jointList},n.GetParticleSystemList=function(){return this.m_particleSystemList},n.GetContactList=function(){return this.m_contactManager.m_contactList},n.SetAllowSleeping=function(t){if(t!==this.m_allowSleep&&(this.m_allowSleep=t,!this.m_allowSleep))for(var e=this.m_bodyList;e;e=e.m_next)e.SetAwake(!0)},n.GetAllowSleeping=function(){return this.m_allowSleep},n.SetWarmStarting=function(t){this.m_warmStarting=t},n.GetWarmStarting=function(){return this.m_warmStarting},n.SetContinuousPhysics=function(t){this.m_continuousPhysics=t},n.GetContinuousPhysics=function(){return this.m_continuousPhysics},n.SetSubStepping=function(t){this.m_subStepping=t},n.GetSubStepping=function(){return this.m_subStepping},n.GetProxyCount=function(){return this.m_contactManager.m_broadPhase.GetProxyCount()},n.GetBodyCount=function(){return this.m_bodyCount},n.GetJointCount=function(){return this.m_jointCount},n.GetContactCount=function(){return this.m_contactManager.m_contactCount},n.GetTreeHeight=function(){return this.m_contactManager.m_broadPhase.GetTreeHeight()},n.GetTreeBalance=function(){return this.m_contactManager.m_broadPhase.GetTreeBalance()},n.GetTreeQuality=function(){return this.m_contactManager.m_broadPhase.GetTreeQuality()},n.SetGravity=function(t,e){if(void 0===e&&(e=!0),!bt.IsEqualToV(this.m_gravity,t)&&(this.m_gravity.Copy(t),e))for(var n=this.m_bodyList;n;n=n.m_next)n.SetAwake(!0)},n.GetGravity=function(){return this.m_gravity},n.IsLocked=function(){return this.m_locked},n.SetAutoClearForces=function(t){this.m_clearForces=t},n.GetAutoClearForces=function(){return this.m_clearForces},n.ShiftOrigin=function(t){if(this.IsLocked())throw new Error;for(var e=this.m_bodyList;e;e=e.m_next)e.m_xf.p.SelfSub(t),e.m_sweep.c0.SelfSub(t),e.m_sweep.c.SelfSub(t);for(var n=this.m_jointList;n;n=n.m_next)n.ShiftOrigin(t);this.m_contactManager.m_broadPhase.ShiftOrigin(t)},n.GetContactManager=function(){return this.m_contactManager},n.GetProfile=function(){return this.m_profile},n.Dump=function(e){if(!this.m_locked){e("const g: b2Vec2 = new b2Vec2(%.15f, %.15f);\n",this.m_gravity.x,this.m_gravity.y),e("this.m_world.SetGravity(g);\n"),e("const bodies: b2Body[] = [];\n"),e("const joints: b2Joint[] = [];\n");for(var n=0,i=this.m_bodyList;i;i=i.m_next)i.m_islandIndex=n,i.Dump(e),++n;n=0;for(var r=this.m_jointList;r;r=r.m_next)r.m_index=n,++n;for(var o=this.m_jointList;o;o=o.m_next)o.m_type!==t.b2JointType.e_gearJoint&&(e("{\n"),o.Dump(e),e("}\n"));for(var a=this.m_jointList;a;a=a.m_next)a.m_type===t.b2JointType.e_gearJoint&&(e("{\n"),a.Dump(e),e("}\n"))}},n.DrawJoint=function(n){if(null!==this.m_debugDraw){var i=n.GetBodyA(),r=n.GetBodyB(),o=i.m_xf,a=r.m_xf,s=o.p,c=a.p,l=n.GetAnchorA(e.DrawJoint_s_p1),u=n.GetAnchorB(e.DrawJoint_s_p2),h=e.DrawJoint_s_color.SetRGB(.5,.8,.8);switch(n.m_type){case t.b2JointType.e_distanceJoint:this.m_debugDraw.DrawSegment(l,u,h);break;case t.b2JointType.e_pulleyJoint:var _=n,f=_.GetGroundAnchorA(),p=_.GetGroundAnchorB();this.m_debugDraw.DrawSegment(f,l,h),this.m_debugDraw.DrawSegment(p,u,h),this.m_debugDraw.DrawSegment(f,p,h);break;case t.b2JointType.e_mouseJoint:var d=e.DrawJoint_s_c;d.Set(0,1,0),this.m_debugDraw.DrawPoint(l,4,d),this.m_debugDraw.DrawPoint(u,4,d),d.Set(.8,.8,.8),this.m_debugDraw.DrawSegment(l,u,d);break;default:this.m_debugDraw.DrawSegment(s,l,h),this.m_debugDraw.DrawSegment(l,u,h),this.m_debugDraw.DrawSegment(c,u,h)}}},n.DrawShape=function(n,i){if(null!==this.m_debugDraw){var r=n.GetShape();switch(r.m_type){case t.b2ShapeType.e_circleShape:var o=r,a=o.m_p,s=o.m_radius,c=bt.UNITX;this.m_debugDraw.DrawSolidCircle(a,s,c,i);break;case t.b2ShapeType.e_edgeShape:var l=r,u=l.m_vertex1,h=l.m_vertex2;this.m_debugDraw.DrawSegment(u,h,i);break;case t.b2ShapeType.e_chainShape:var _=r,f=_.m_count,p=_.m_vertices,d=e.DrawShape_s_ghostColor.SetRGBA(.75*i.r,.75*i.g,.75*i.b,i.a),m=p[0];if(this.m_debugDraw.DrawPoint(m,4,i),_.m_hasPrevVertex){var v=_.m_prevVertex;this.m_debugDraw.DrawSegment(v,m,d),this.m_debugDraw.DrawCircle(v,.1,d)}for(var g=1;g<f;++g){var y=p[g];this.m_debugDraw.DrawSegment(m,y,i),this.m_debugDraw.DrawPoint(y,4,i),m=y}if(_.m_hasNextVertex){var x=_.m_nextVertex;this.m_debugDraw.DrawSegment(x,m,d),this.m_debugDraw.DrawCircle(x,.1,d)}break;case t.b2ShapeType.e_polygonShape:var S=r,C=S.m_count,A=S.m_vertices;this.m_debugDraw.DrawSolidPolygon(A,C,i)}}},n.Solve=function(e){for(var n=this.m_bodyList;n;n=n.m_next)n.m_xf0.Copy(n.m_xf);for(var i=this.m_controllerList;i;i=i.m_next)i.Step(e);this.m_profile.solveInit=0,this.m_profile.solveVelocity=0,this.m_profile.solvePosition=0;var r=this.m_island;r.Initialize(this.m_bodyCount,this.m_contactManager.m_contactCount,this.m_jointCount,this.m_contactManager.m_contactListener);for(var o=this.m_bodyList;o;o=o.m_next)o.m_islandFlag=!1;for(var a=this.m_contactManager.m_contactList;a;a=a.m_next)a.m_islandFlag=!1;for(var s=this.m_jointList;s;s=s.m_next)s.m_islandFlag=!1;for(var c=this.s_stack,l=this.m_bodyList;l;l=l.m_next)if(!l.m_islandFlag&&l.IsAwake()&&l.IsActive()&&l.GetType()!==t.b2BodyType.b2_staticBody){r.Clear();var u=0;for(c[u++]=l,l.m_islandFlag=!0;u>0;){var h=c[--u];if(!h)throw new Error;if(r.AddBody(h),h.m_awakeFlag=!0,h.GetType()!==t.b2BodyType.b2_staticBody){for(var _=h.m_contactList;_;_=_.next){var f=_.contact;if(!f.m_islandFlag&&f.IsEnabled()&&f.IsTouching()){var p=f.m_fixtureA.m_isSensor,d=f.m_fixtureB.m_isSensor;if(!p&&!d){r.AddContact(f),f.m_islandFlag=!0;var m=_.other;m.m_islandFlag||(c[u++]=m,m.m_islandFlag=!0)}}}for(var v=h.m_jointList;v;v=v.next)if(!v.joint.m_islandFlag){var g=v.other;g.IsActive()&&(r.AddJoint(v.joint),v.joint.m_islandFlag=!0,g.m_islandFlag||(c[u++]=g,g.m_islandFlag=!0))}}}var y=new mr;r.Solve(y,e,this.m_gravity,this.m_allowSleep),this.m_profile.solveInit+=y.solveInit,this.m_profile.solveVelocity+=y.solveVelocity,this.m_profile.solvePosition+=y.solvePosition;for(var x=0;x<r.m_bodyCount;++x){var S=r.m_bodies[x];S.GetType()===t.b2BodyType.b2_staticBody&&(S.m_islandFlag=!1)}}for(var C=0;C<c.length&&c[C];++C)c[C]=null;for(var A=new Nt,b=this.m_bodyList;b;b=b.m_next)b.m_islandFlag&&b.GetType()!==t.b2BodyType.b2_staticBody&&b.SynchronizeFixtures();this.m_contactManager.FindNewContacts(),this.m_profile.broadphase=A.GetMilliseconds()},n.SolveTOI=function(n){var i=this.m_island;if(i.Initialize(2*d,d,0,this.m_contactManager.m_contactListener),this.m_stepComplete){for(var o=this.m_bodyList;o;o=o.m_next)o.m_islandFlag=!1,o.m_sweep.alpha0=0;for(var a=this.m_contactManager.m_contactList;a;a=a.m_next)a.m_toiFlag=!1,a.m_islandFlag=!1,a.m_toiCount=0,a.m_toi=1}for(;;){for(var s=null,c=1,l=this.m_contactManager.m_contactList;l;l=l.m_next)if(l.IsEnabled()&&!(l.m_toiCount>p)){var u=1;if(l.m_toiFlag)u=l.m_toi;else{var h=l.GetFixtureA(),_=l.GetFixtureB();if(h.IsSensor()||_.IsSensor())continue;var f=h.GetBody(),m=_.GetBody(),v=f.m_type,g=m.m_type,y=f.IsAwake()&&v!==t.b2BodyType.b2_staticBody,x=m.IsAwake()&&g!==t.b2BodyType.b2_staticBody;if(!y&&!x)continue;var S=f.IsBullet()||v!==t.b2BodyType.b2_dynamicBody,C=m.IsBullet()||g!==t.b2BodyType.b2_dynamicBody;if(!S&&!C)continue;var A=f.m_sweep.alpha0;f.m_sweep.alpha0<m.m_sweep.alpha0?(A=m.m_sweep.alpha0,f.m_sweep.Advance(A)):m.m_sweep.alpha0<f.m_sweep.alpha0&&(A=f.m_sweep.alpha0,m.m_sweep.Advance(A));var b=l.GetChildIndexA(),T=l.GetChildIndexB(),E=e.SolveTOI_s_toi_input;E.proxyA.SetShape(h.GetShape(),b),E.proxyB.SetShape(_.GetShape(),T),E.sweepA.Copy(f.m_sweep),E.sweepB.Copy(m.m_sweep),E.tMax=1;var w=e.SolveTOI_s_toi_output;un(w,E);var P=w.t;u=w.state===t.b2TOIOutputState.e_touching?it(A+(1-A)*P,1):1,l.m_toi=u,l.m_toiFlag=!0}u<c&&(s=l,c=u)}if(null===s||1-10*r<c){this.m_stepComplete=!0;break}var I=s.GetFixtureA(),R=s.GetFixtureB(),D=I.GetBody(),B=R.GetBody(),M=e.SolveTOI_s_backup1.Copy(D.m_sweep),O=e.SolveTOI_s_backup2.Copy(B.m_sweep);if(D.Advance(c),B.Advance(c),s.Update(this.m_contactManager.m_contactListener),s.m_toiFlag=!1,++s.m_toiCount,s.IsEnabled()&&s.IsTouching()){D.SetAwake(!0),B.SetAwake(!0),i.Clear(),i.AddBody(D),i.AddBody(B),i.AddContact(s),D.m_islandFlag=!0,B.m_islandFlag=!0,s.m_islandFlag=!0;for(var N=0;N<2;++N){var L=0===N?D:B;if(L.m_type===t.b2BodyType.b2_dynamicBody)for(var F=L.m_contactList;F&&i.m_bodyCount!==i.m_bodyCapacity&&i.m_contactCount!==i.m_contactCapacity;F=F.next){var z=F.contact;if(!z.m_islandFlag){var G=F.other;if(G.m_type!==t.b2BodyType.b2_dynamicBody||L.IsBullet()||G.IsBullet()){var V=z.m_fixtureA.m_isSensor,U=z.m_fixtureB.m_isSensor;if(!V&&!U){var k=e.SolveTOI_s_backup.Copy(G.m_sweep);G.m_islandFlag||G.Advance(c),z.Update(this.m_contactManager.m_contactListener),z.IsEnabled()&&z.IsTouching()?(z.m_islandFlag=!0,i.AddContact(z),G.m_islandFlag||(G.m_islandFlag=!0,G.m_type!==t.b2BodyType.b2_staticBody&&G.SetAwake(!0),i.AddBody(G))):(G.m_sweep.Copy(k),G.SynchronizeTransform())}}}}}var H=e.SolveTOI_s_subStep;H.dt=(1-c)*n.dt,H.inv_dt=1/H.dt,H.dtRatio=1,H.positionIterations=20,H.velocityIterations=n.velocityIterations,H.particleIterations=n.particleIterations,H.warmStarting=!1,i.SolveTOI(H,D.m_islandIndex,B.m_islandIndex);for(var j=0;j<i.m_bodyCount;++j){var W=i.m_bodies[j];if(W.m_islandFlag=!1,W.m_type===t.b2BodyType.b2_dynamicBody){W.SynchronizeFixtures();for(var q=W.m_contactList;q;q=q.next)q.contact.m_toiFlag=!1,q.contact.m_islandFlag=!1}}if(this.m_contactManager.FindNewContacts(),this.m_subStepping){this.m_stepComplete=!1;break}}else s.SetEnabled(!1),D.m_sweep.Copy(M),B.m_sweep.Copy(O),D.SynchronizeTransform(),B.SynchronizeTransform()}},n.AddController=function(t){return t.m_next=this.m_controllerList,t.m_prev=null,this.m_controllerList&&(this.m_controllerList.m_prev=t),this.m_controllerList=t,++this.m_controllerCount,t},n.RemoveController=function(t){return t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),this.m_controllerList===t&&(this.m_controllerList=t.m_next),--this.m_controllerCount,t.m_prev=null,t.m_next=null,t},e}();xo.Step_s_step=new vr,xo.Step_s_stepTimer=new Nt,xo.Step_s_timer=new Nt,xo.DrawDebugData_s_color=new Mt(0,0,0),xo.DrawDebugData_s_vs=bt.MakeArray(4),xo.DrawDebugData_s_xf=new Rt,xo.QueryFixtureShape_s_aabb=new Te,xo.RayCast_s_input=new Ae,xo.RayCast_s_output=new be,xo.RayCast_s_point=new bt,xo.DrawJoint_s_p1=new bt,xo.DrawJoint_s_p2=new bt,xo.DrawJoint_s_color=new Mt(.5,.8,.8),xo.DrawJoint_s_c=new Mt,xo.DrawShape_s_ghostColor=new Mt,xo.SolveTOI_s_subStep=new vr,xo.SolveTOI_s_backup=new Bt,xo.SolveTOI_s_backup1=new Bt,xo.SolveTOI_s_backup2=new Bt,xo.SolveTOI_s_toi_input=new Je,xo.SolveTOI_s_toi_output=new Ze;var So=function(t,e){this.prevBody=null,this.nextBody=null,this.prevController=null,this.nextController=null,this.controller=t,this.body=e},Co=function(){function t(){this.m_bodyList=null,this.m_bodyCount=0,this.m_prev=null,this.m_next=null}var e=t.prototype;return e.GetNext=function(){return this.m_next},e.GetPrev=function(){return this.m_prev},e.GetBodyList=function(){return this.m_bodyList},e.AddBody=function(t){var e=new So(this,t);e.nextBody=this.m_bodyList,e.prevBody=null,this.m_bodyList&&(this.m_bodyList.prevBody=e),this.m_bodyList=e,++this.m_bodyCount,e.nextController=t.m_controllerList,e.prevController=null,t.m_controllerList&&(t.m_controllerList.prevController=e),t.m_controllerList=e,++t.m_controllerCount},e.RemoveBody=function(t){if(this.m_bodyCount<=0)throw new Error;for(var e=this.m_bodyList;e&&e.body!==t;)e=e.nextBody;if(null===e)throw new Error;e.prevBody&&(e.prevBody.nextBody=e.nextBody),e.nextBody&&(e.nextBody.prevBody=e.prevBody),this.m_bodyList===e&&(this.m_bodyList=e.nextBody),--this.m_bodyCount,e.nextController&&(e.nextController.prevController=e.prevController),e.prevController&&(e.prevController.nextController=e.nextController),t.m_controllerList===e&&(t.m_controllerList=e.nextController),--t.m_controllerCount},e.Clear=function(){for(;this.m_bodyList;)this.RemoveBody(this.m_bodyList.body);this.m_bodyCount=0},t}(),Ao=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).normal=new bt(0,1),e.offset=0,e.density=0,e.velocity=new bt(0,0),e.linearDrag=0,e.angularDrag=0,e.useDensity=!1,e.useWorldGravity=!0,e.gravity=new bt(0,0),e}Q(e,t);var n=e.prototype;return n.Step=function(){if(this.m_bodyList){this.useWorldGravity&&this.gravity.Copy(this.m_bodyList.body.GetWorld().GetGravity());for(var t=this.m_bodyList;t;t=t.nextBody){var e=t.body;if(e.IsAwake()){for(var n=new bt,i=new bt,o=0,a=0,s=e.GetFixtureList();s;s=s.m_next){var c=new bt,l=s.GetShape().ComputeSubmergedArea(this.normal,this.offset,e.GetTransform(),c);o+=l,n.x+=l*c.x,n.y+=l*c.y;var u=0;a+=l*(u=this.useDensity?s.GetDensity():1),i.x+=l*c.x*u,i.y+=l*c.y*u}if(n.x/=o,n.y/=o,i.x/=a,i.y/=a,!(o<r)){var h=this.gravity.Clone().SelfNeg();h.SelfMul(this.density*o),e.ApplyForce(h,i);var _=e.GetLinearVelocityFromWorldPoint(n,new bt);_.SelfSub(this.velocity),_.SelfMul(-this.linearDrag*o),e.ApplyForce(_,n),e.ApplyTorque(-e.GetInertia()/e.GetMass()*o*e.GetAngularVelocity()*this.angularDrag)}}}}},n.Draw=function(t){var e=100,n=new bt,i=new bt;n.x=this.normal.x*this.offset+this.normal.y*e,n.y=this.normal.y*this.offset-this.normal.x*e,i.x=this.normal.x*this.offset-this.normal.y*e,i.y=this.normal.y*this.offset+this.normal.x*e;var r=new Mt(0,0,.8);t.DrawSegment(n,i,r)},e}(Co),bo=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).A=new bt(0,0),e}Q(e,t);var n=e.prototype;return n.Step=function(t){for(var n=bt.MulSV(t.dt,this.A,e.Step_s_dtA),i=this.m_bodyList;i;i=i.nextBody){var r=i.body;r.IsAwake()&&r.SetLinearVelocity(bt.AddVV(r.GetLinearVelocity(),n,bt.s_t0))}},n.Draw=function(){},e}(Co);bo.Step_s_dtA=new bt;var To=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).F=new bt(0,0),e}Q(e,t);var n=e.prototype;return n.Step=function(){for(var t=this.m_bodyList;t;t=t.nextBody){var e=t.body;e.IsAwake()&&e.ApplyForce(this.F,e.GetWorldCenter())}},n.Draw=function(){},e}(Co),Eo=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).G=1,e.invSqr=!0,e}Q(e,t);var n=e.prototype;return n.Step=function(){if(this.invSqr)for(var t=this.m_bodyList;t;t=t.nextBody)for(var n=t.body,i=n.GetWorldCenter(),o=n.GetMass(),a=this.m_bodyList;a&&a!==t;a=a.nextBody){var s=a.body,c=s.GetWorldCenter(),l=s.GetMass(),u=c.x-i.x,h=c.y-i.y,_=u*u+h*h;if(!(_<r)){var f=e.Step_s_f.Set(u,h);f.SelfMul(this.G/_/ht(_)*o*l),n.IsAwake()&&n.ApplyForce(f,i),s.IsAwake()&&s.ApplyForce(f.SelfMul(-1),c)}}else for(var p=this.m_bodyList;p;p=p.nextBody)for(var d=p.body,m=d.GetWorldCenter(),v=d.GetMass(),g=this.m_bodyList;g&&g!==p;g=g.nextBody){var y=g.body,x=y.GetWorldCenter(),S=y.GetMass(),C=x.x-m.x,A=x.y-m.y,b=C*C+A*A;if(!(b<r)){var T=e.Step_s_f.Set(C,A);T.SelfMul(this.G/b*v*S),d.IsAwake()&&d.ApplyForce(T,m),y.IsAwake()&&y.ApplyForce(T.SelfMul(-1),x)}}},n.Draw=function(){},e}(Co);Eo.Step_s_f=new bt;var wo=function(t){function e(){var e;return(e=t.apply(this,arguments)||this).T=new wt,e.maxTimestep=0,e}Q(e,t);var n=e.prototype;return n.Step=function(t){var n=t.dt;if(!(n<=r)){n>this.maxTimestep&&this.maxTimestep>0&&(n=this.maxTimestep);for(var i=this.m_bodyList;i;i=i.nextBody){var o=i.body;if(o.IsAwake()){var a=o.GetWorldVector(wt.MulMV(this.T,o.GetLocalVector(o.GetLinearVelocity(),bt.s_t0),bt.s_t1),e.Step_s_damping);o.SetLinearVelocity(bt.AddVV(o.GetLinearVelocity(),bt.MulSV(n,a,bt.s_t0),bt.s_t1))}}}},n.Draw=function(){},n.SetAxisAligned=function(t,e){this.T.ex.x=-t,this.T.ex.y=0,this.T.ey.x=0,this.T.ey.y=-e,this.maxTimestep=t>0||e>0?1/rt(t,e):0},e}(Co);wo.Step_s_damping=new bt;var Po=function(){this.vertices=[],this.count=0,this.masses=[],this.gravity=new bt(0,0),this.damping=.1,this.k2=.9,this.k3=.1},Io=function(){function t(){this.m_count=0,this.m_ps=[],this.m_p0s=[],this.m_vs=[],this.m_ims=[],this.m_Ls=[],this.m_as=[],this.m_gravity=new bt,this.m_damping=0,this.m_k2=1,this.m_k3=.1}var e=t.prototype;return e.GetVertexCount=function(){return this.m_count},e.GetVertices=function(){return this.m_ps},e.Initialize=function(t){this.m_count=t.count,this.m_ps=bt.MakeArray(this.m_count),this.m_p0s=bt.MakeArray(this.m_count),this.m_vs=bt.MakeArray(this.m_count),this.m_ims=J(this.m_count);for(var e=0;e<this.m_count;++e){this.m_ps[e].Copy(t.vertices[e]),this.m_p0s[e].Copy(t.vertices[e]),this.m_vs[e].SetZero();var n=t.masses[e];this.m_ims[e]=n>0?1/n:0}var i=this.m_count-1,r=this.m_count-2;this.m_Ls=J(i),this.m_as=J(r);for(var o=0;o<i;++o){var a=this.m_ps[o],s=this.m_ps[o+1];this.m_Ls[o]=bt.DistanceVV(a,s)}for(var c=0;c<r;++c){var l=this.m_ps[c],u=this.m_ps[c+1],h=this.m_ps[c+2],_=bt.SubVV(u,l,bt.s_t0),f=bt.SubVV(h,u,bt.s_t1),p=bt.CrossVV(_,f),d=bt.DotVV(_,f);this.m_as[c]=yt(p,d)}this.m_gravity.Copy(t.gravity),this.m_damping=t.damping,this.m_k2=t.k2,this.m_k3=t.k3},e.Step=function(t,e){if(0!==t){for(var n=Math.exp(-t*this.m_damping),i=0;i<this.m_count;++i)this.m_p0s[i].Copy(this.m_ps[i]),this.m_ims[i]>0&&this.m_vs[i].SelfMulAdd(t,this.m_gravity),this.m_vs[i].SelfMul(n),this.m_ps[i].SelfMulAdd(t,this.m_vs[i]);for(var r=0;r<e;++r)this.SolveC2(),this.SolveC3(),this.SolveC2();for(var o=1/t,a=0;a<this.m_count;++a)bt.MulSV(o,bt.SubVV(this.m_ps[a],this.m_p0s[a],bt.s_t0),this.m_vs[a])}},e.SolveC2=function(){for(var e=this.m_count-1,n=0;n<e;++n){var i=this.m_ps[n],r=this.m_ps[n+1],o=bt.SubVV(r,i,t.s_d),a=o.Normalize(),s=this.m_ims[n],c=this.m_ims[n+1];if(s+c!==0){var l=s/(s+c),u=c/(s+c);i.SelfMulSub(this.m_k2*l*(this.m_Ls[n]-a),o),r.SelfMulAdd(this.m_k2*u*(this.m_Ls[n]-a),o)}}},e.SetAngle=function(t){for(var e=this.m_count-2,n=0;n<e;++n)this.m_as[n]=t},e.SolveC3=function(){for(var e=this.m_count-2,n=0;n<e;++n){var i=this.m_ps[n],r=this.m_ps[n+1],o=this.m_ps[n+2],s=this.m_ims[n],c=this.m_ims[n+1],l=this.m_ims[n+2],u=bt.SubVV(r,i,t.s_d1),h=bt.SubVV(o,r,t.s_d2),_=u.LengthSquared(),f=h.LengthSquared();if(_*f!=0){var p=bt.CrossVV(u,h),d=bt.DotVV(u,h),m=yt(p,d),v=bt.MulSV(-1/_,u.SelfSkew(),t.s_Jd1),g=bt.MulSV(1/f,h.SelfSkew(),t.s_Jd2),y=bt.NegV(v,t.s_J1),x=bt.SubVV(v,g,t.s_J2),S=g,C=s*bt.DotVV(y,y)+c*bt.DotVV(x,x)+l*bt.DotVV(S,S);if(0!==C){C=1/C;for(var A=m-this.m_as[n];A>a;)A=(m-=2*a)-this.m_as[n];for(;A<-a;)A=(m+=2*a)-this.m_as[n];var b=-this.m_k3*C*A;i.SelfMulAdd(s*b,y),r.SelfMulAdd(c*b,x),o.SelfMulAdd(l*b,S)}}}},e.Draw=function(t){for(var e=new Mt(.4,.5,.7),n=0;n<this.m_count-1;++n)t.DrawSegment(this.m_ps[n],this.m_ps[n+1],e)},t}();Io.s_d=new bt,Io.s_d1=new bt,Io.s_d2=new bt,Io.s_Jd1=new bt,Io.s_Jd2=new bt,Io.s_J1=new bt,Io.s_J2=new bt,t.b2AABB=Te,t.b2Abs=nt,t.b2Acos=vt,t.b2Alloc=z,t.b2AreaJoint=Pi,t.b2AreaJointDef=wi,t.b2Asin=gt,t.b2Assert=e,t.b2Atan2=yt,t.b2BlockAllocator=zt,t.b2Body=xi,t.b2BodyDef=yi,t.b2BroadPhase=Ge,t.b2BuoyancyController=Ao,t.b2CalculateParticleIterations=Dr,t.b2ChainAndCircleContact=or,t.b2ChainAndPolygonContact=ar,t.b2ChainShape=hi,t.b2CircleContact=tr,t.b2CircleShape=ci,t.b2Clamp=at,t.b2ClipSegmentToLine=we,t.b2ClipVertex=Ce,t.b2CollideCircles=fn,t.b2CollideEdgeAndCircle=Qn,t.b2CollideEdgeAndPolygon=ri,t.b2CollidePolygonAndCircle=vn,t.b2CollidePolygons=Un,t.b2Color=Mt,t.b2ConstantAccelController=bo,t.b2ConstantForceController=To,t.b2Contact=$i,t.b2ContactEdge=Zi,t.b2ContactFactory=cr,t.b2ContactFeature=de,t.b2ContactFilter=ur,t.b2ContactID=me,t.b2ContactImpulse=hr,t.b2ContactListener=_r,t.b2ContactManager=dr,t.b2ContactPositionConstraint=br,t.b2ContactRegister=sr,t.b2ContactSolver=wr,t.b2ContactSolverDef=Tr,t.b2ContactVelocityConstraint=Ar,t.b2Controller=Co,t.b2ControllerEdge=So,t.b2Cos=dt,t.b2Counter=Lt,t.b2DegToRad=ft,t.b2DestructionListener=lr,t.b2Distance=ie,t.b2DistanceInput=kt,t.b2DistanceJoint=Ei,t.b2DistanceJointDef=Ti,t.b2DistanceOutput=Ht,t.b2DistanceProxy=Vt,t.b2Draw=Ot,t.b2DynamicTree=Oe,t.b2EdgeAndCircleContact=ir,t.b2EdgeAndPolygonContact=rr,t.b2EdgeShape=ui,t.b2Filter=_i,t.b2Fixture=mi,t.b2FixtureDef=fi,t.b2FixtureParticleQueryCallback=Jr,t.b2FixtureProxy=pi,t.b2Free=G,t.b2FrictionJoint=Ri,t.b2FrictionJointDef=Ii,t.b2GearJoint=Bi,t.b2GearJointDef=Di,t.b2GetPointStates=Se,t.b2GravityController=Eo,t.b2GrowableBuffer=Kr,t.b2GrowableStack=Ft,t.b2InvSqrt=ut,t.b2IsPowerOfTwo=St,t.b2IsValid=ct,t.b2Island=Ir,t.b2Jacobian=Si,t.b2Joint=bi,t.b2JointDef=Ai,t.b2JointEdge=Ci,t.b2Log=V,t.b2MakeArray=X,t.b2MakeNullArray=Y,t.b2MakeNumberArray=J,t.b2Manifold=ye,t.b2ManifoldPoint=ve,t.b2MassData=ai,t.b2Mat22=wt,t.b2Mat33=Pt,t.b2Max=rt,t.b2Maybe=n,t.b2Min=it,t.b2MixFriction=Ji,t.b2MixRestitution=Qi,t.b2MotorJoint=Oi,t.b2MotorJointDef=Mi,t.b2MouseJoint=Li,t.b2MouseJointDef=Ni,t.b2NextPowerOfTwo=xt,t.b2Pair=ze,t.b2PairLessThan=Ve,t.b2ParseInt=W,t.b2ParseUInt=q,t.b2ParticleBodyContact=Zr,t.b2ParticleContact=Qr,t.b2ParticleDef=Rr,t.b2ParticleGroup=Nr,t.b2ParticleGroupDef=Or,t.b2ParticleHandle=Mr,t.b2ParticlePair=$r,t.b2ParticlePairSet=ho,t.b2ParticleSystem=no,t.b2ParticleSystemDef=eo,t.b2ParticleSystem_CompositeShape=mo,t.b2ParticleSystem_ConnectionFilter=_o,t.b2ParticleSystem_DestroyParticlesInShapeCallback=fo,t.b2ParticleSystem_FixedSetAllocator=so,t.b2ParticleSystem_FixtureParticle=co,t.b2ParticleSystem_FixtureParticleSet=lo,t.b2ParticleSystem_InsideBoundsEnumerator=oo,t.b2ParticleSystem_JoinParticleGroupsFilter=po,t.b2ParticleSystem_ParticleListNode=ao,t.b2ParticleSystem_ParticlePair=uo,t.b2ParticleSystem_Proxy=ro,t.b2ParticleSystem_ReactiveFilter=vo,t.b2ParticleSystem_SolveCollisionCallback=yo,t.b2ParticleSystem_UpdateBodyContactsCallback=go,t.b2ParticleSystem_UserOverridableBuffer=io,t.b2ParticleTriad=to,t.b2PolygonAndCircleContact=nr,t.b2PolygonContact=er,t.b2PolygonShape=li,t.b2Position=gr,t.b2PositionSolverManifold=Er,t.b2Pow=_t,t.b2PrismaticJoint=zi,t.b2PrismaticJointDef=Fi,t.b2Profile=mr,t.b2PulleyJoint=Ui,t.b2PulleyJointDef=Vi,t.b2QueryCallback=fr,t.b2RadToDeg=pt,t.b2Random=Ct,t.b2RandomRange=At,t.b2RayCastCallback=pr,t.b2RayCastInput=Ae,t.b2RayCastOutput=be,t.b2RevoluteJoint=Hi,t.b2RevoluteJointDef=ki,t.b2Rope=Io,t.b2RopeDef=Po,t.b2RopeJoint=Wi,t.b2RopeJointDef=ji,t.b2Rot=It,t.b2SeparationFunction=$e,t.b2Shape=si,t.b2ShapeCast=fe,t.b2ShapeCastInput=jt,t.b2ShapeCastOutput=Wt,t.b2Simplex=Yt,t.b2SimplexCache=Ut,t.b2SimplexVertex=Xt,t.b2Sin=mt,t.b2SolverData=xr,t.b2Sq=lt,t.b2Sqrt=ht,t.b2StackAllocator=Gt,t.b2Swap=st,t.b2Sweep=Bt,t.b2TOIInput=Je,t.b2TOIOutput=Ze,t.b2TensorDampingController=wo,t.b2TestOverlapAABB=Ee,t.b2TestOverlapShape=De,t.b2TimeOfImpact=un,t.b2TimeStep=vr,t.b2Timer=Nt,t.b2Transform=Rt,t.b2TreeNode=Me,t.b2Vec2=bt,t.b2Vec2_zero=Tt,t.b2Vec3=Et,t.b2Velocity=yr,t.b2VelocityConstraintPoint=Cr,t.b2Version=U,t.b2WeldJoint=Xi,t.b2WeldJointDef=qi,t.b2WheelJoint=Ki,t.b2WheelJointDef=Yi,t.b2World=xo,t.b2WorldManifold=xe,t.b2_180_over_pi=$,t.b2_aabbExtension=l,t.b2_aabbMultiplier=u,t.b2_angularSleepTolerance=F,t.b2_angularSlop=_,t.b2_barrierCollisionTime=O,t.b2_baumgarte=A,t.b2_branch=H,t.b2_commit=j,t.b2_epsilon=r,t.b2_epsilon_sq=o,t.b2_gjk_reset=qt,t.b2_invalidParticleIndex=T,t.b2_linearSleepTolerance=L,t.b2_linearSlop=h,t.b2_maxAngularCorrection=g,t.b2_maxFloat=i,t.b2_maxLinearCorrection=v,t.b2_maxManifoldPoints=s,t.b2_maxParticleForce=R,t.b2_maxParticleIndex=E,t.b2_maxParticlePressure=I,t.b2_maxPolygonVertices=c,t.b2_maxRotation=S,t.b2_maxRotationSquared=C,t.b2_maxSubSteps=p,t.b2_maxTOIContacts=d,t.b2_maxTranslation=y,t.b2_maxTranslationSquared=x,t.b2_maxTriadDistance=D,t.b2_maxTriadDistanceSquared=B,t.b2_minParticleSystemBufferCapacity=M,t.b2_minParticleWeight=P,t.b2_minPulleyLength=Gi,t.b2_particleStride=w,t.b2_pi=a,t.b2_pi_over_180=Z,t.b2_polygonRadius=f,t.b2_timeToSleep=N,t.b2_toiBaumgarte=b,t.b2_toi_reset=Ue,t.b2_two_pi=tt,t.b2_velocityThreshold=m,t.b2_version=k,t.g_blockSolve=Sr,Object.defineProperty(t,"__esModule",{value:!0})}(e)}(e={exports:{}},e.exports),e.exports}();(a6=s6)&&a6.__esModule&&Object.prototype.hasOwnProperty.call(a6,"default")&&a6.default;var c6={};for(var l6 in s6)-1===l6.indexOf("b2_")&&(c6[l6.replace("b2","")]=s6[l6]);var u6,h6,_6,f6,p6,d6=c6;!function(t){t[t.Static=0]="Static",t[t.Kinematic=1]="Kinematic",t[t.Dynamic=2]="Dynamic",t[t.Animated=3]="Animated"}(u6||(u6=t("ERigidBody2DType",{}))),ie(u6),function(t){t[t.None=0]="None",t[t.BOX=1]="BOX",t[t.CIRCLE=2]="CIRCLE",t[t.POLYGON=3]="POLYGON"}(h6||(h6=t("ECollider2DType",{}))),ie(h6),function(t){t[t.None=0]="None",t[t.DISTANCE=1]="DISTANCE",t[t.SPRING=2]="SPRING",t[t.WHEEL=3]="WHEEL",t[t.MOUSE=4]="MOUSE",t[t.FIXED=5]="FIXED",t[t.SLIDER=6]="SLIDER",t[t.RELATIVE=7]="RELATIVE",t[t.HINGE=8]="HINGE"}(_6||(_6=t("EJoint2DType",{}))),ie(_6),function(t){t[t.DEFAULT=1]="DEFAULT"}(f6||(f6=t("PhysicsGroup",{}))),ie(f6),function(t){t[t.Closest=0]="Closest",t[t.Any=1]="Any",t[t.AllClosest=2]="AllClosest",t[t.All=3]="All"}(p6||(p6=t("ERaycast2DType",{})));var m6,v6=t("Contact2DType",{None:"none-contact",BEGIN_CONTACT:"begin-contact",END_CONTACT:"end-contact",PRE_SOLVE:"pre-solve",POST_SOLVE:"post-solve"});!function(t){t[t.None=0]="None",t[t.Shape=1]="Shape",t[t.Joint=2]="Joint",t[t.Aabb=4]="Aabb",t[t.Pair=8]="Pair",t[t.CenterOfMass=16]="CenterOfMass",t[t.Particle=32]="Particle",t[t.Controller=64]="Controller",t[t.All=63]="All"}(m6||(m6=t("EPhysics2DDrawFlags",{})));var g6=t("PHYSICS_2D_PTM_RATIO",32),y6=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._contactFixtures=[],e._BeginContact=null,e._EndContact=null,e._PreSolve=null,e._PostSolve=null,e}Q(e,t);var n=e.prototype;return n.setBeginContact=function(t){this._BeginContact=t},n.setEndContact=function(t){this._EndContact=t},n.setPreSolve=function(t){this._PreSolve=t},n.setPostSolve=function(t){this._PostSolve=t},n.BeginContact=function(t){if(this._BeginContact){var e=t.GetFixtureA(),n=t.GetFixtureB(),i=this._contactFixtures;t._shouldReport=!1,-1===i.indexOf(e)&&-1===i.indexOf(n)||(t._shouldReport=!0,this._BeginContact(t))}},n.EndContact=function(t){this._EndContact&&t._shouldReport&&(t._shouldReport=!1,this._EndContact(t))},n.PreSolve=function(t,e){this._PreSolve&&t._shouldReport&&this._PreSolve(t,e)},n.PostSolve=function(t,e){this._PostSolve&&t._shouldReport&&this._PostSolve(t,e)},n.registerContactFixture=function(t){this._contactFixtures.push(t)},n.unregisterContactFixture=function(t){ht(this._contactFixtures,t)},e}(d6.ContactListener),x6=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._point=new d6.Vec2,e._isPoint=!1,e._fixtures=[],e}Q(e,t);var n=e.prototype;return n.init=function(t){t?(this._isPoint=!0,this._point.x=t.x,this._point.y=t.y):this._isPoint=!1,this._fixtures.length=0},n.ReportFixture=function(t){return this._isPoint?t.TestPoint(this._point)&&this._fixtures.push(t):this._fixtures.push(t),!0},n.getFixture=function(){return this._fixtures[0]},n.getFixtures=function(){return this._fixtures},e}(d6.QueryCallback);function S6(t,e){var n=e.length;return e[t<0?n- -t%n:t%n]}function C6(t,e,n){for(var i=[];e<t;)e+=n.length;for(;t<=e;++t)i.push(S6(t,n));return i}function A6(t){D6(t);for(var e,n,i,r,o,a,s=[],c=new Wn,l=new Wn,u=0,h=0,_=0;_<t.length;++_)if(T6(_,t)){n=i=1e8;for(var f=0;f<t.length;++f)w6(S6(_-1,t),S6(_,t),S6(f,t))&&I6(S6(_-1,t),S6(_,t),S6(f-1,t))&&(r=M6(S6(_-1,t),S6(_,t),S6(f,t),S6(f-1,t)),E6(S6(_+1,t),S6(_,t),r)&&(e=R6(S6(_,t),r))<n&&(n=e,c=r,u=f)),w6(S6(_+1,t),S6(_,t),S6(f+1,t))&&I6(S6(_+1,t),S6(_,t),S6(f,t))&&(r=M6(S6(_+1,t),S6(_,t),S6(f,t),S6(f+1,t)),w6(S6(_-1,t),S6(_,t),r)&&(e=R6(S6(_,t),r))<i&&(i=e,h=f,l=r));if(u==(h+1)%t.length){var p=c.add(l).multiplyScalar(.5);(o=C6(_,h,t)).push(p),(a=C6(u,_,t)).push(p)}else{for(var d=0,m=u;h<u;)h+=t.length;for(var v=u;v<=h;++v)if(b6(_,v,t)){var g=1/(R6(S6(_,t),S6(v,t))+1);T6(v,t)?I6(S6(v-1,t),S6(v,t),S6(_,t))&&P6(S6(v+1,t),S6(v,t),S6(_,t))?g+=3:g+=2:g+=1,g>d&&(m=v,d=g)}o=C6(_,m,t),a=C6(m,_,t)}return(s=s.concat(A6(o))).concat(A6(a))}s.push(t);for(var y=s.length-1;y>=0;y--)0==s[y].length&&s.splice(y,0);return s}function b6(t,e,n){if(T6(t,n)){if(P6(S6(t,n),S6(t-1,n),S6(e,n))&&I6(S6(t,n),S6(t+1,n),S6(e,n)))return!1}else if(I6(S6(t,n),S6(t+1,n),S6(e,n))||P6(S6(t,n),S6(t-1,n),S6(e,n)))return!1;if(T6(e,n)){if(P6(S6(e,n),S6(e-1,n),S6(t,n))&&I6(S6(e,n),S6(e+1,n),S6(t,n)))return!1}else if(I6(S6(e,n),S6(e+1,n),S6(t,n))||P6(S6(e,n),S6(e-1,n),S6(t,n)))return!1;for(var i=0;i<n.length;++i)if((i+1)%n.length!=t&&i!=t&&(i+1)%n.length!=e&&i!=e){var r=new Wn;if(O6(S6(t,n),S6(e,n),S6(i,n),S6(i+1,n),r))return!1}return!0}function T6(t,e){return E6(t,e)}function E6(t,e,n){if(void 0===n){var i=t,r=e;t=S6(i-1,r),e=S6(i,r),n=S6(i+1,r)}return N6(t,e,n)<0}function w6(t,e,n){return N6(t,e,n)>0}function P6(t,e,n){return N6(t,e,n)>=0}function I6(t,e,n){return N6(t,e,n)<=0}function R6(t,e){var n=e.x-t.x,i=e.y-t.y;return n*n+i*i}function D6(t){B6(t)||t.reverse()}function B6(t){return t.length<3||function(t){var e,n=0;for(e=0;e<t.length;e++){var i=(e+1)%t.length;n+=t[e].x*t[i].y,n-=t[e].y*t[i].x}return n/2}(t)>0}function M6(t,e,n,i){var r,o=new Wn,a=e.y-t.y,s=t.x-e.x,c=a*t.x+s*t.y,l=i.y-n.y,u=n.x-i.x,h=l*n.x+u*n.y,_=a*u-l*s;return r=_,0,Math.abs(r-0)<=1e-6||(o.x=(u*c-s*h)/_,o.y=(a*h-l*c)/_),o}function O6(t,e,n,i,r){if(t==n||t==i||e==n||e==i)return!1;var o=t.x,a=t.y,s=e.x,c=e.y,l=n.x,u=n.y,h=i.x,_=i.y;if(Math.max(o,s)<Math.min(l,h)||Math.max(l,h)<Math.min(o,s))return!1;if(Math.max(a,c)<Math.min(u,_)||Math.max(u,_)<Math.min(a,c))return!1;var f=(h-l)*(a-u)-(_-u)*(o-l),p=(s-o)*(a-u)-(c-a)*(o-l),d=(_-u)*(s-o)-(h-l)*(c-a);return!(Math.abs(d)<1e-6)&&(p/=d,(f/=d)>0&&f<1&&p>0&&p<1&&(r.x=o+f*(s-o),r.y=a+f*(c-a),!0))}function N6(t,e,n){return t.x*(e.y-n.y)+e.x*(n.y-t.y)+n.x*(t.y-e.y)}var L6=Object.freeze({__proto__:null,ConvexPartition:A6,ForceCounterClockWise:D6,IsCounterClockWise:B6}),F6=function(){return 0},z6={impl:null,rigidBody:null,isAwake:!1,isSleeping:!1,initialize:F6,setType:F6,setLinearDamping:F6,setAngularDamping:F6,setGravityScale:F6,setFixedRotation:F6,setAllowSleep:F6,isActive:F6,setActive:F6,wakeUp:F6,sleep:F6,getMass:F6,getInertia:F6,getLinearVelocity:F6,setLinearVelocity:F6,getLinearVelocityFromWorldPoint:F6,getAngularVelocity:F6,setAngularVelocity:F6,getLocalVector:F6,getWorldVector:F6,getLocalPoint:F6,getWorldPoint:F6,getLocalCenter:F6,getWorldCenter:F6,applyForce:F6,applyForceToCenter:F6,applyTorque:F6,applyLinearImpulse:F6,applyLinearImpulseToCenter:F6,applyAngularImpulse:F6,onEnable:F6,onDisable:F6,onDestroy:F6},G6={INITED:!1};var V6,U6,k6,H6,j6,W6,q6={INITED:!1},X6={impl:null,initialize:F6,setDampingRatio:F6,setFrequency:F6,setMaxForce:F6,setTarget:F6,setDistance:F6,setAngularOffset:F6,setCorrectionFactor:F6,setLinearOffset:F6,setMaxLength:F6,setMaxTorque:F6,setLowerLimit:F6,setUpperLimit:F6,setMaxMotorForce:F6,setMaxMotorTorque:F6,setMotorSpeed:F6,enableLimit:F6,enableMotor:F6,setLowerAngle:F6,setUpperAngle:F6};!function(t){t[t.DYNAMIC=1]="DYNAMIC",t[t.STATIC=2]="STATIC",t[t.KINEMATIC=4]="KINEMATIC"}(V6||(V6={})),ie(V6),function(t){t[t.X_AXIS=0]="X_AXIS",t[t.Y_AXIS=1]="Y_AXIS",t[t.Z_AXIS=2]="Z_AXIS"}(U6||(U6={})),ie(U6),function(t){t[t.VERTEX=1]="VERTEX",t[t.LINE=2]="LINE",t[t.TRIANGLE=3]="TRIANGLE",t[t.TETRAHEDRON=4]="TETRAHEDRON"}(k6||(k6={})),ie(k6),function(t){t[t.BOX=0]="BOX",t[t.SPHERE=1]="SPHERE",t[t.CAPSULE=2]="CAPSULE",t[t.CYLINDER=3]="CYLINDER",t[t.CONE=4]="CONE",t[t.MESH=5]="MESH",t[t.PLANE=6]="PLANE",t[t.SIMPLEX=7]="SIMPLEX",t[t.TERRAIN=8]="TERRAIN"}(H6||(H6={})),ie(H6),function(t){t[t.POINT_TO_POINT=0]="POINT_TO_POINT",t[t.HINGE=1]="HINGE",t[t.CONE_TWIST=2]="CONE_TWIST"}(j6||(j6={})),ie(j6),function(t){t[t.DEFAULT=1]="DEFAULT"}(W6||(W6={})),ie(W6);var Y6,K6,J6,Q6,Z6,$6,t7,e7,n7,i7,r7,o7,a7,s7,c7,l7,u7,h7,_7,f7=function(t){if(1===t){for(var e=this,n=function(t){var n="_"+(1<<t);e[n]=0,e.updateArray=[],Object.defineProperty(e,1<<t,{get:function(){return this[n]},set:function(e){this[n]!==e&&(this[n]=e,this.updateArray.indexOf(t)<0&&this.updateArray.push(t))}})},i=0;i<32;i++)n(i);this._1=W6.DEFAULT}else{for(var r=0;r<32;r++)this[""+(1<<r)]=0;this[1]=W6.DEFAULT}},p7=null,d7=t("PhysicsSystem2D",function(t){function e(){var e;(e=t.call(this)||this).velocityIterations=10,e.positionIterations=10,e.physicsWorld=void 0,e.collisionMatrix=new f7,e._enable=!0,e._allowSleep=!0,e._maxSubSteps=1,e._fixedTimeStep=1/60,e._autoSimulation=!0,e._accumulator=0,e._steping=!1,e._gravity=new Wn(0,-10*g6),e._delayEvents=[];var n=LM.config?LM.config.physics:null;if(n){if(Wn.copy(e._gravity,n.gravity),e._gravity.multiplyScalar(g6),e._allowSleep=n.allowSleep,e._fixedTimeStep=n.fixedTimeStep,e._maxSubSteps=n.maxSubSteps,e._autoSimulation=n.autoSimulation,n.collisionMatrix)for(var i in n.collisionMatrix){var r=parseInt(i),o=1<<parseInt(i);e.collisionMatrix[""+o]=n.collisionMatrix[r]}if(n.collisionGroups){var a=n.collisionGroups;a instanceof Array&&(a.forEach((function(t){f6[t.name]=1<<t.index})),ie.update(f6))}}return e.physicsWorld=new i6.PhysicsWorld,e.gravity=e._gravity,e.allowSleep=e._allowSleep,e}Q(e,t);var n=e.prototype;return n.postUpdate=function(t){if(this._enable&&this._autoSimulation){zM.emit(FM.EVENT_BEFORE_PHYSICS),this._steping=!0;var e=this._fixedTimeStep,n=this.velocityIterations,i=this.positionIterations;this._accumulator+=t;for(var r=0;r++<this._maxSubSteps&&this._accumulator>e;)this.physicsWorld.step(e,n,i),this._accumulator-=e;for(var o=this._delayEvents,a=0,s=o.length;a<s;a++){var c=o[a];c.func.call(c.target)}o.length=0,this.physicsWorld.syncPhysicsToScene(),this.debugDrawFlags&&this.physicsWorld.drawDebug(),this._steping=!1,zM.emit(FM.EVENT_AFTER_PHYSICS)}},n._callAfterStep=function(t,e){this._steping?this._delayEvents.push({target:t,func:e}):e.call(t)},n.resetAccumulator=function(t){void 0===t&&(t=0),this._accumulator=t},n.step=function(t){this.physicsWorld.step(t,this.velocityIterations,this.positionIterations)},n.raycast=function(t,e,n,i){return void 0===n&&(n=p6.Closest),void 0===i&&(i=4294967295),this.physicsWorld.raycast(t,e,n,i)},n.testPoint=function(t){return this.physicsWorld.testPoint(t)},n.testAABB=function(t){return this.physicsWorld.testAABB(t)},K(e,[{key:"enable",get:function(){return this._enable},set:function(t){this._enable=t}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(t){this._allowSleep=t,this.physicsWorld.setAllowSleep(t)}},{key:"gravity",get:function(){return this._gravity},set:function(t){this._gravity.set(t),this.physicsWorld.setGravity(new Wn(t.x/g6,t.y/g6))}},{key:"maxSubSteps",get:function(){return this._maxSubSteps},set:function(t){this._maxSubSteps=t}},{key:"fixedTimeStep",get:function(){return this._fixedTimeStep},set:function(t){this._fixedTimeStep=t}},{key:"autoSimulation",get:function(){return this._autoSimulation},set:function(t){this._autoSimulation=t}},{key:"debugDrawFlags",get:function(){return this.physicsWorld.debugDrawFlags},set:function(t){this.physicsWorld.debugDrawFlags=t}},{key:"stepping",get:function(){return this._steping}}],[{key:"PHYSICS_NONE",get:function(){return!r6}},{key:"PHYSICS_BUILTIN",get:function(){return"builtin"===r6}},{key:"PHYSICS_BOX2D",get:function(){return"box2d"===r6}},{key:"PhysicsGroup",get:function(){return f6}},{key:"instance",get:function(){return p7||(p7=new e),p7}}]),e}(Jl(bM)));d7.ID="PHYSICS_2D",zM.once(FM.EVENT_INIT,(function(){d7.PHYSICS_NONE||zM.registerSystem(d7.ID,d7.instance,bM.Priority.LOW)})),function(t){t[t.Circles=0]="Circles",t[t.FaceA=1]="FaceA",t[t.FaceB=2]="FaceB"}(Y6||(Y6=t("Physics2DManifoldType",{})));var m7,v7,g7,y7,x7,S7,C7,A7,b7,T7,E7,w7,P7,I7,R7,D7,B7,M7,O7,N7,L7,F7,z7,G7,V7,U7,k7,H7,j7,W7,q7,X7,Y7,K7,J7,Q7,Z7,$7,t9,e9,n9,i9,r9,o9,a9,s9,c9,l9,u9,h9,_9,f9,p9,d9,m9,v9,g9,y9,x9,S9,C9,A9,b9,T9,E9,w9,P9,I9,R9,D9,B9,M9,O9,N9,L9,F9,z9,G9,V9,U9,k9,H9,j9,W9,q9,X9,Y9,K9,J9,Q9,Z9,$9,ttt=dc,ett=Wc,ntt=Ac,itt=t("RigidBody2D",(K6=hc("cc.RigidBody2D"),J6=ntt(),Q6=ett(W6),Z6=ett(u6),K6($6=J6((st((t7=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"enabledContactListener",e7,it(e)),at(e,"bullet",n7,it(e)),at(e,"awakeOnLoad",i7,it(e)),e._body=null,at(e,"_group",r7,it(e)),at(e,"_type",o7,it(e)),at(e,"_allowSleep",a7,it(e)),at(e,"_gravityScale",s7,it(e)),at(e,"_linearDamping",c7,it(e)),at(e,"_angularDamping",l7,it(e)),at(e,"_linearVelocity",u7,it(e)),at(e,"_angularVelocity",h7,it(e)),at(e,"_fixedRotation",_7,it(e)),e}Q(e,t);var n=e.prototype;return n.isAwake=function(){return!!this._body&&this._body.isAwake},n.wakeUp=function(){this._body&&this._body.wakeUp()},n.sleep=function(){this._body&&this._body.sleep()},n.getMass=function(){return this._body?this._body.getMass():0},n.applyForce=function(t,e,n){this._body&&this._body.applyForce(t,e,n)},n.applyForceToCenter=function(t,e){this._body&&this._body.applyForceToCenter(t,e)},n.applyTorque=function(t,e){this._body&&this._body.applyTorque(t,e)},n.applyLinearImpulse=function(t,e,n){this._body&&this._body.applyLinearImpulse(t,e,n)},n.applyLinearImpulseToCenter=function(t,e){this._body&&this._body.applyLinearImpulseToCenter(t,e)},n.applyAngularImpulse=function(t,e){this._body&&this._body.applyAngularImpulse(t,e)},n.getLinearVelocityFromWorldPoint=function(t,e){return this._body?this._body.getLinearVelocityFromWorldPoint(t,e):e},n.getLocalVector=function(t,e){return this._body?this._body.getLocalVector(t,e):e},n.getWorldVector=function(t,e){return this._body?this._body.getWorldVector(t,e):e},n.getLocalPoint=function(t,e){return this._body?this._body.getLocalPoint(t,e):e},n.getWorldPoint=function(t,e){return this._body?this._body.getWorldPoint(t,e):e},n.getLocalCenter=function(t){return this._body?this._body.getLocalCenter(t):t},n.getWorldCenter=function(t){return this._body?this._body.getWorldCenter(t):t},n.getInertia=function(){return this._body&&this._body.getInertia(),0},n.onLoad=function(){this._body=c._global.CC_PHYSICS_2D_BUILTIN?z6:new i6.RigidBody,this._body.initialize(this)},n.onEnable=function(){this._body&&this._body.onEnable()},n.onDisable=function(){this._body&&this._body.onDisable()},n.onDestroy=function(){this._body&&this._body.onDestroy()},K(e,[{key:"group",get:function(){return this._group},set:function(t){this._group=t}},{key:"type",get:function(){return this._type},set:function(t){this._type=t,this._body&&(t===u6.Animated?this._body.setType(u6.Kinematic):this._body.setType(t))}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(t){this._allowSleep=t,this._body&&this._body.setAllowSleep(t)}},{key:"gravityScale",get:function(){return this._gravityScale},set:function(t){this._gravityScale=t,this._body&&this._body.setGravityScale(t)}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(t){this._linearDamping=t,this._body&&this._body.setLinearDamping(t)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(t){this._angularDamping=t,this._body&&this._body.setAngularDamping(t)}},{key:"linearVelocity",get:function(){return this._body&&this._body.getLinearVelocity(this._linearVelocity),this._linearVelocity},set:function(t){this._linearVelocity=t,this._body&&this._body.setLinearVelocity(t)}},{key:"angularVelocity",get:function(){return this._body&&(this._angularVelocity=this._body.getAngularVelocity()),this._angularVelocity},set:function(t){this._angularVelocity=t,this._body&&this._body.setAngularVelocity(t)}},{key:"fixedRotation",get:function(){return this._fixedRotation},set:function(t){this._fixedRotation=t,this._body&&this._body.setFixedRotation(t)}},{key:"impl",get:function(){return this._body}}]),e}(Ku)).prototype,"group",[Q6],Object.getOwnPropertyDescriptor(t7.prototype,"group"),t7.prototype),e7=st(t7.prototype,"enabledContactListener",[ttt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),n7=st(t7.prototype,"bullet",[ttt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),st(t7.prototype,"type",[Z6],Object.getOwnPropertyDescriptor(t7.prototype,"type"),t7.prototype),st(t7.prototype,"allowSleep",[ttt],Object.getOwnPropertyDescriptor(t7.prototype,"allowSleep"),t7.prototype),st(t7.prototype,"gravityScale",[ttt],Object.getOwnPropertyDescriptor(t7.prototype,"gravityScale"),t7.prototype),st(t7.prototype,"linearDamping",[ttt],Object.getOwnPropertyDescriptor(t7.prototype,"linearDamping"),t7.prototype),st(t7.prototype,"angularDamping",[ttt],Object.getOwnPropertyDescriptor(t7.prototype,"angularDamping"),t7.prototype),st(t7.prototype,"linearVelocity",[ttt],Object.getOwnPropertyDescriptor(t7.prototype,"linearVelocity"),t7.prototype),st(t7.prototype,"angularVelocity",[ttt],Object.getOwnPropertyDescriptor(t7.prototype,"angularVelocity"),t7.prototype),st(t7.prototype,"fixedRotation",[ttt],Object.getOwnPropertyDescriptor(t7.prototype,"fixedRotation"),t7.prototype),i7=st(t7.prototype,"awakeOnLoad",[ttt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),r7=st(t7.prototype,"_group",[ttt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return W6.DEFAULT}}),o7=st(t7.prototype,"_type",[ttt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return u6.Dynamic}}),a7=st(t7.prototype,"_allowSleep",[ttt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),s7=st(t7.prototype,"_gravityScale",[ttt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),c7=st(t7.prototype,"_linearDamping",[ttt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),l7=st(t7.prototype,"_angularDamping",[ttt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),u7=st(t7.prototype,"_linearVelocity",[ttt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wn}}),h7=st(t7.prototype,"_angularVelocity",[ttt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_7=st(t7.prototype,"_fixedRotation",[ttt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$6=t7))||$6)||$6)),rtt=t("Collider2D",(m7=hc("cc.Collider2D"),v7=Wc(W6),m7((P7=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"editing",x7,it(e)),at(e,"tag",S7,it(e)),e.TYPE=h6.None,e._shape=null,e._body=null,at(e,"_group",C7,it(e)),at(e,"_density",A7,it(e)),at(e,"_sensor",b7,it(e)),at(e,"_friction",T7,it(e)),at(e,"_restitution",E7,it(e)),at(e,"_offset",w7,it(e)),e}Q(e,t);var n=e.prototype;return n.onLoad=function(){this._shape=function(t){return G6.INITED||(G6.INITED=!0,G6[h6.BOX]=function(){return new i6.BoxShape},G6[h6.CIRCLE]=function(){return new i6.CircleShape},G6[h6.POLYGON]=function(){return new i6.PolygonShape}),G6[t]()}(this.TYPE),this._shape.initialize(this),this._shape.onLoad&&this._shape.onLoad(),this._body=this.getComponent(itt)},n.onEnable=function(){this._shape&&this._shape.onEnable()},n.onDisable=function(){this._shape&&this._shape.onDisable&&this._shape.onDisable()},n.onDestroy=function(){this._shape&&this._shape.onDestroy&&this._shape.onDestroy()},n.apply=function(){this._shape&&this._shape.apply&&this._shape.apply()},K(e,[{key:"group",get:function(){return this._group},set:function(t){this._group=t,this._shape&&this._shape.onGroupChanged&&this._shape.onGroupChanged()}},{key:"density",get:function(){return this._density},set:function(t){this._density=t}},{key:"sensor",get:function(){return this._sensor},set:function(t){this._sensor=t}},{key:"friction",get:function(){return this._friction},set:function(t){this._friction=t}},{key:"restitution",get:function(){return this._restitution},set:function(t){this._restitution=t}},{key:"offset",get:function(){return this._offset},set:function(t){this._offset=t}},{key:"body",get:function(){return this._body}},{key:"impl",get:function(){return this._shape}},{key:"worldAABB",get:function(){return this._shape?this._shape.worldAABB:new ti}}]),e}(Jl(Ku)),x7=st((y7=P7).prototype,"editing",[Pc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),S7=st(y7.prototype,"tag",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),st(y7.prototype,"group",[v7],Object.getOwnPropertyDescriptor(y7.prototype,"group"),y7.prototype),st(y7.prototype,"density",[dc],Object.getOwnPropertyDescriptor(y7.prototype,"density"),y7.prototype),st(y7.prototype,"sensor",[dc],Object.getOwnPropertyDescriptor(y7.prototype,"sensor"),y7.prototype),st(y7.prototype,"friction",[dc],Object.getOwnPropertyDescriptor(y7.prototype,"friction"),y7.prototype),st(y7.prototype,"restitution",[dc],Object.getOwnPropertyDescriptor(y7.prototype,"restitution"),y7.prototype),st(y7.prototype,"offset",[dc],Object.getOwnPropertyDescriptor(y7.prototype,"offset"),y7.prototype),C7=st(y7.prototype,"_group",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return W6.DEFAULT}}),A7=st(y7.prototype,"_density",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),b7=st(y7.prototype,"_sensor",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),T7=st(y7.prototype,"_friction",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.2}}),E7=st(y7.prototype,"_restitution",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),w7=st(y7.prototype,"_offset",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wn}}),g7=y7))||g7)),ott=(t("BoxCollider2D",hc("cc.BoxCollider2D")(I7=Ac()((B7=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_size",D7,it(e)),e.TYPE=h6.BOX,e}return Q(e,t),K(e,[{key:"size",get:function(){return this._size},set:function(t){this._size=t}},{key:"worldPoints",get:function(){return this._shape?this._shape.worldPoints:[]}}]),e}(rtt),D7=st((R7=B7).prototype,"_size",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zn(1,1)}}),st(R7.prototype,"size",[dc],Object.getOwnPropertyDescriptor(R7.prototype,"size"),R7.prototype),I7=R7))||I7)||I7),t("CircleCollider2D",hc("cc.CircleCollider2D")(M7=Ac()((L7=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_radius",N7,it(e)),e.TYPE=h6.CIRCLE,e}return Q(e,t),K(e,[{key:"radius",get:function(){return this._radius},set:function(t){this._radius=t<0?0:t}},{key:"worldPosition",get:function(){return this._shape?this._shape.worldPosition:new Wn}},{key:"worldRadius",get:function(){return this._shape?this._shape.worldRadius:0}}]),e}(rtt),N7=st((O7=L7).prototype,"_radius",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),st(O7.prototype,"radius",[dc],Object.getOwnPropertyDescriptor(O7.prototype,"radius"),O7.prototype),M7=O7))||M7)||M7),t("PolygonCollider2D",(F7=hc("cc.PolygonCollider2D"),z7=Ac(),G7=dc({serializable:!1,displayOrder:0}),V7=dc({type:Wn}),F7(U7=z7((W7=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"threshold",H7,it(e)),at(e,"_points",j7,it(e)),e.TYPE=h6.POLYGON,e}return Q(e,t),K(e,[{key:"points",get:function(){return this._points},set:function(t){this._points=t}},{key:"worldPoints",get:function(){return this._shape?this._shape.worldPoints:[]}}]),e}(rtt),H7=st((k7=W7).prototype,"threshold",[G7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),j7=st(k7.prototype,"_points",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new Wn(-1,-1),new Wn(1,-1),new Wn(1,1),new Wn(-1,1)]}}),st(k7.prototype,"points",[V7],Object.getOwnPropertyDescriptor(k7.prototype,"points"),k7.prototype),U7=k7))||U7)||U7)),t("Joint2D",(q7=hc("cc.Joint2D"),X7=Wc(itt),q7((t9=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"anchor",J7,it(e)),at(e,"connectedAnchor",Q7,it(e)),at(e,"collideConnected",Z7,it(e)),at(e,"connectedBody",$7,it(e)),e._body=null,e._joint=null,e.TYPE=_6.None,e}Q(e,t);var n=e.prototype;return n.onLoad=function(){this._joint=function(t){return function(){if(!q6.INITED){q6.INITED=!0;var t=c._global.CC_PHYSICS_2D_BUILTIN;q6[_6.SPRING]=function(){return t?X6:new i6.SpringJoint},q6[_6.DISTANCE]=function(){return t?X6:new i6.DistanceJoint},q6[_6.FIXED]=function(){return t?X6:new i6.FixedJoint},q6[_6.MOUSE]=function(){return t?X6:new i6.MouseJoint},q6[_6.RELATIVE]=function(){return t?X6:new i6.RelativeJoint},q6[_6.SLIDER]=function(){return t?X6:new i6.SliderJoint},q6[_6.WHEEL]=function(){return t?X6:new i6.WheelJoint},q6[_6.HINGE]=function(){return t?X6:new i6.HingeJoint}}}(),q6[t]()}(this.TYPE),this._joint.initialize(this),this._body=this.getComponent(itt)},n.onEnable=function(){this._joint&&this._joint.onEnable&&this._joint.onEnable()},n.onDisable=function(){this._joint&&this._joint.onDisable&&this._joint.onDisable()},n.start=function(){this._joint&&this._joint.start&&this._joint.start()},n.onDestroy=function(){this._joint&&this._joint.onDestroy&&this._joint.onDestroy()},K(e,[{key:"body",get:function(){return this._body}},{key:"impl",get:function(){return this._joint}}]),e}(Ku),J7=st((K7=t9).prototype,"anchor",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wn}}),Q7=st(K7.prototype,"connectedAnchor",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wn}}),Z7=st(K7.prototype,"collideConnected",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$7=st(K7.prototype,"connectedBody",[X7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Y7=K7))||Y7))),att=(t("DistanceJoint2D",hc("cc.DistanceJoint2D")(e9=Ac()((st((n9=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).TYPE=_6.DISTANCE,at(e,"_maxLength",i9,it(e)),at(e,"_autoCalcDistance",r9,it(e)),e}return Q(e,t),K(e,[{key:"maxLength",get:function(){return this._autoCalcDistance&&this.connectedBody?En.distance(this.node.worldPosition,this.connectedBody.node.worldPosition):this._maxLength},set:function(t){this._maxLength=t,this._joint&&this._joint.setMaxLength(t)}},{key:"autoCalcDistance",get:function(){return this._autoCalcDistance},set:function(t){this._autoCalcDistance=t}}]),e}(ott)).prototype,"maxLength",[dc],Object.getOwnPropertyDescriptor(n9.prototype,"maxLength"),n9.prototype),st(n9.prototype,"autoCalcDistance",[dc],Object.getOwnPropertyDescriptor(n9.prototype,"autoCalcDistance"),n9.prototype),i9=st(n9.prototype,"_maxLength",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),r9=st(n9.prototype,"_autoCalcDistance",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),e9=n9))||e9)||e9),t("SpringJoint2D",hc("cc.SpringJoint2D")(o9=Ac()((st((a9=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).TYPE=_6.SPRING,at(e,"_frequency",s9,it(e)),at(e,"_dampingRatio",c9,it(e)),at(e,"_distance",l9,it(e)),at(e,"_autoCalcDistance",u9,it(e)),e}return Q(e,t),K(e,[{key:"frequency",get:function(){return this._frequency},set:function(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}},{key:"distance",get:function(){return this._autoCalcDistance&&this.connectedBody?En.distance(this.node.worldPosition,this.connectedBody.node.worldPosition):this._distance},set:function(t){this._distance=t,this._joint&&this._joint.setDistance(t)}},{key:"autoCalcDistance",get:function(){return this._autoCalcDistance},set:function(t){this._autoCalcDistance=t}}]),e}(ott)).prototype,"frequency",[dc],Object.getOwnPropertyDescriptor(a9.prototype,"frequency"),a9.prototype),st(a9.prototype,"dampingRatio",[dc],Object.getOwnPropertyDescriptor(a9.prototype,"dampingRatio"),a9.prototype),st(a9.prototype,"distance",[dc],Object.getOwnPropertyDescriptor(a9.prototype,"distance"),a9.prototype),st(a9.prototype,"autoCalcDistance",[dc],Object.getOwnPropertyDescriptor(a9.prototype,"autoCalcDistance"),a9.prototype),s9=st(a9.prototype,"_frequency",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),c9=st(a9.prototype,"_dampingRatio",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),l9=st(a9.prototype,"_distance",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),u9=st(a9.prototype,"_autoCalcDistance",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),o9=a9))||o9)||o9),t("MouseJoint2D",hc("cc.MouseJoint2D")(h9=Ac()((st((_9=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).TYPE=_6.MOUSE,at(e,"_maxForce",f9,it(e)),at(e,"_dampingRatio",p9,it(e)),at(e,"_frequency",d9,it(e)),e._target=new Wn,e}return Q(e,t),e.prototype.update=function(t){this._joint.update(t)},K(e,[{key:"target",get:function(){return this._target},set:function(t){this._target=t,this._joint&&this._joint.setTarget(t)}},{key:"frequency",get:function(){return this._frequency},set:function(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}},{key:"maxForce",get:function(){return this._maxForce},set:function(t){this._maxForce=t,this._joint&&this._joint.setMaxForce(t)}}]),e}(ott)).prototype,"frequency",[dc],Object.getOwnPropertyDescriptor(_9.prototype,"frequency"),_9.prototype),st(_9.prototype,"dampingRatio",[dc],Object.getOwnPropertyDescriptor(_9.prototype,"dampingRatio"),_9.prototype),st(_9.prototype,"maxForce",[dc],Object.getOwnPropertyDescriptor(_9.prototype,"maxForce"),_9.prototype),f9=st(_9.prototype,"_maxForce",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),p9=st(_9.prototype,"_dampingRatio",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),d9=st(_9.prototype,"_frequency",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),h9=_9))||h9)||h9),new En),stt=new En,ctt=(t("RelativeJoint2D",hc("cc.RelativeJoint2D")(m9=Ac()((st((v9=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).TYPE=_6.RELATIVE,at(e,"_maxForce",g9,it(e)),at(e,"_maxTorque",y9,it(e)),at(e,"_correctionFactor",x9,it(e)),at(e,"_angularOffset",S9,it(e)),at(e,"_linearOffset",C9,it(e)),at(e,"_autoCalcOffset",A9,it(e)),e}return Q(e,t),K(e,[{key:"maxForce",get:function(){return this._maxForce},set:function(t){this._maxForce=t,this._joint&&this._joint.setMaxForce(t)}},{key:"maxTorque",get:function(){return this._maxTorque},set:function(t){this._maxTorque=t,this._joint&&this._joint.setMaxTorque(t)}},{key:"correctionFactor",get:function(){return this._correctionFactor},set:function(t){this._correctionFactor=t,this._joint&&this._joint.setCorrectionFactor(t)}},{key:"linearOffset",get:function(){return this._autoCalcOffset&&this.connectedBody?Wn.subtract(this._linearOffset,this.connectedBody.node.worldPosition,this.node.worldPosition):this._linearOffset},set:function(t){this._linearOffset.set(t),this._joint&&this._joint.setLinearOffset(t)}},{key:"angularOffset",get:function(){return this._autoCalcOffset&&this.connectedBody&&(Mn.toEuler(att,this.node.worldRotation),Mn.toEuler(stt,this.connectedBody.node.worldRotation),this._angularOffset=stt.z-att.z),this._angularOffset},set:function(t){this._angularOffset=t,this._joint&&this._joint.setAngularOffset(t)}},{key:"autoCalcOffset",get:function(){return this._autoCalcOffset},set:function(t){this._autoCalcOffset=t}}]),e}(ott)).prototype,"maxForce",[dc],Object.getOwnPropertyDescriptor(v9.prototype,"maxForce"),v9.prototype),st(v9.prototype,"maxTorque",[dc],Object.getOwnPropertyDescriptor(v9.prototype,"maxTorque"),v9.prototype),st(v9.prototype,"correctionFactor",[dc],Object.getOwnPropertyDescriptor(v9.prototype,"correctionFactor"),v9.prototype),st(v9.prototype,"linearOffset",[dc],Object.getOwnPropertyDescriptor(v9.prototype,"linearOffset"),v9.prototype),st(v9.prototype,"angularOffset",[dc],Object.getOwnPropertyDescriptor(v9.prototype,"angularOffset"),v9.prototype),st(v9.prototype,"autoCalcOffset",[dc],Object.getOwnPropertyDescriptor(v9.prototype,"autoCalcOffset"),v9.prototype),g9=st(v9.prototype,"_maxForce",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),y9=st(v9.prototype,"_maxTorque",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),x9=st(v9.prototype,"_correctionFactor",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),S9=st(v9.prototype,"_angularOffset",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),C9=st(v9.prototype,"_linearOffset",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Wn}}),A9=st(v9.prototype,"_autoCalcOffset",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),m9=v9))||m9)||m9),new Wn),ltt=(t("SliderJoint2D",hc("cc.SliderJoint2D")(b9=Ac()((st((T9=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).TYPE=_6.SLIDER,at(e,"_angle",E9,it(e)),at(e,"_autoCalcAngle",w9,it(e)),at(e,"_enableMotor",P9,it(e)),at(e,"_maxMotorForce",I9,it(e)),at(e,"_motorSpeed",R9,it(e)),at(e,"_enableLimit",D9,it(e)),at(e,"_lowerLimit",B9,it(e)),at(e,"_upperLimit",M9,it(e)),e}return Q(e,t),K(e,[{key:"angle",get:function(){return this._autoCalcAngle&&this.connectedBody&&(Wn.subtract(ctt,this.connectedBody.node.worldPosition,this.node.worldPosition),this._angle=ln(Math.atan2(ctt.y,ctt.x))),this._angle},set:function(t){this._angle=t}},{key:"autoCalcAngle",get:function(){return this._autoCalcAngle},set:function(t){this._autoCalcAngle=t}},{key:"enableMotor",get:function(){return this._enableMotor},set:function(t){this._enableMotor=t}},{key:"maxMotorForce",get:function(){return this._maxMotorForce},set:function(t){this._maxMotorForce=t,this._joint&&this._joint.setMaxMotorForce(t)}},{key:"motorSpeed",get:function(){return this._motorSpeed},set:function(t){this._motorSpeed=t,this._joint&&this._joint.setMotorSpeed(t)}},{key:"enableLimit",get:function(){return this._enableLimit},set:function(t){this._enableLimit=t}},{key:"lowerLimit",get:function(){return this._lowerLimit},set:function(t){this._lowerLimit=t,this._joint&&this._joint.setLowerLimit(t)}},{key:"upperLimit",get:function(){return this._upperLimit},set:function(t){this._upperLimit=t,this._joint&&this._joint.setUpperLimit(t)}}]),e}(ott)).prototype,"angle",[dc],Object.getOwnPropertyDescriptor(T9.prototype,"angle"),T9.prototype),st(T9.prototype,"autoCalcAngle",[dc],Object.getOwnPropertyDescriptor(T9.prototype,"autoCalcAngle"),T9.prototype),st(T9.prototype,"enableMotor",[dc],Object.getOwnPropertyDescriptor(T9.prototype,"enableMotor"),T9.prototype),st(T9.prototype,"maxMotorForce",[dc],Object.getOwnPropertyDescriptor(T9.prototype,"maxMotorForce"),T9.prototype),st(T9.prototype,"motorSpeed",[dc],Object.getOwnPropertyDescriptor(T9.prototype,"motorSpeed"),T9.prototype),st(T9.prototype,"enableLimit",[dc],Object.getOwnPropertyDescriptor(T9.prototype,"enableLimit"),T9.prototype),st(T9.prototype,"lowerLimit",[dc],Object.getOwnPropertyDescriptor(T9.prototype,"lowerLimit"),T9.prototype),st(T9.prototype,"upperLimit",[dc],Object.getOwnPropertyDescriptor(T9.prototype,"upperLimit"),T9.prototype),E9=st(T9.prototype,"_angle",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),w9=st(T9.prototype,"_autoCalcAngle",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),P9=st(T9.prototype,"_enableMotor",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),I9=st(T9.prototype,"_maxMotorForce",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),R9=st(T9.prototype,"_motorSpeed",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),D9=st(T9.prototype,"_enableLimit",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),B9=st(T9.prototype,"_lowerLimit",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),M9=st(T9.prototype,"_upperLimit",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),b9=T9))||b9)||b9),t("FixedJoint2D",hc("cc.FixedJoint2D")(O9=Ac()((st((N9=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).TYPE=_6.FIXED,at(e,"_frequency",L9,it(e)),at(e,"_dampingRatio",F9,it(e)),e}return Q(e,t),K(e,[{key:"frequency",get:function(){return this._frequency},set:function(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}}]),e}(ott)).prototype,"frequency",[dc],Object.getOwnPropertyDescriptor(N9.prototype,"frequency"),N9.prototype),st(N9.prototype,"dampingRatio",[dc],Object.getOwnPropertyDescriptor(N9.prototype,"dampingRatio"),N9.prototype),L9=st(N9.prototype,"_frequency",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),F9=st(N9.prototype,"_dampingRatio",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),O9=N9))||O9)||O9),t("WheelJoint2D",hc("cc.WheelJoint2D")(z9=Ac()((st((G9=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).TYPE=_6.WHEEL,at(e,"_angle",V9,it(e)),at(e,"_enableMotor",U9,it(e)),at(e,"_maxMotorTorque",k9,it(e)),at(e,"_motorSpeed",H9,it(e)),at(e,"_frequency",j9,it(e)),at(e,"_dampingRatio",W9,it(e)),e}return Q(e,t),K(e,[{key:"angle",get:function(){return this._angle},set:function(t){this._angle=t}},{key:"enableMotor",get:function(){return this._enableMotor},set:function(t){this._enableMotor=t,this._joint&&this._joint.enableMotor(t)}},{key:"maxMotorTorque",get:function(){return this._maxMotorTorque},set:function(t){this._maxMotorTorque=t,this._joint&&this._joint.setMaxMotorTorque(t)}},{key:"motorSpeed",get:function(){return this._motorSpeed},set:function(t){this._motorSpeed=t,this._joint&&this._joint.setMotorSpeed(t)}},{key:"frequency",get:function(){return this._frequency},set:function(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}}]),e}(ott)).prototype,"angle",[dc],Object.getOwnPropertyDescriptor(G9.prototype,"angle"),G9.prototype),st(G9.prototype,"enableMotor",[dc],Object.getOwnPropertyDescriptor(G9.prototype,"enableMotor"),G9.prototype),st(G9.prototype,"maxMotorTorque",[dc],Object.getOwnPropertyDescriptor(G9.prototype,"maxMotorTorque"),G9.prototype),st(G9.prototype,"motorSpeed",[dc],Object.getOwnPropertyDescriptor(G9.prototype,"motorSpeed"),G9.prototype),st(G9.prototype,"frequency",[dc],Object.getOwnPropertyDescriptor(G9.prototype,"frequency"),G9.prototype),st(G9.prototype,"dampingRatio",[dc],Object.getOwnPropertyDescriptor(G9.prototype,"dampingRatio"),G9.prototype),V9=st(G9.prototype,"_angle",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 90}}),U9=st(G9.prototype,"_enableMotor",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),k9=st(G9.prototype,"_maxMotorTorque",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),H9=st(G9.prototype,"_motorSpeed",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),j9=st(G9.prototype,"_frequency",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),W9=st(G9.prototype,"_dampingRatio",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),z9=G9))||z9)||z9),t("HingeJoint2D",hc("cc.HingeJoint2D")(q9=Ac()((st((X9=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this).TYPE=_6.HINGE,at(e,"_enableLimit",Y9,it(e)),at(e,"_lowerAngle",K9,it(e)),at(e,"_upperAngle",J9,it(e)),at(e,"_enableMotor",Q9,it(e)),at(e,"_maxMotorTorque",Z9,it(e)),at(e,"_motorSpeed",$9,it(e)),e}return Q(e,t),K(e,[{key:"enableLimit",get:function(){return this._enableLimit},set:function(t){this._enableLimit=t}},{key:"lowerAngle",get:function(){return this._lowerAngle},set:function(t){this._lowerAngle=t,this._joint&&this._joint.setLowerAngle(t)}},{key:"upperAngle",get:function(){return this._upperAngle},set:function(t){this._upperAngle=t,this._joint&&this._joint.setUpperAngle(t)}},{key:"enableMotor",get:function(){return this._enableMotor},set:function(t){this._enableMotor=t,this._joint&&this._joint.enableMotor(t)}},{key:"maxMotorTorque",get:function(){return this._maxMotorTorque},set:function(t){this._maxMotorTorque=t,this._joint&&this._joint.setMaxMotorTorque(t)}},{key:"motorSpeed",get:function(){return this._motorSpeed},set:function(t){this._motorSpeed=t,this._joint&&this._joint.setMotorSpeed(t)}}]),e}(ott)).prototype,"enableLimit",[dc],Object.getOwnPropertyDescriptor(X9.prototype,"enableLimit"),X9.prototype),st(X9.prototype,"lowerAngle",[dc],Object.getOwnPropertyDescriptor(X9.prototype,"lowerAngle"),X9.prototype),st(X9.prototype,"upperAngle",[dc],Object.getOwnPropertyDescriptor(X9.prototype,"upperAngle"),X9.prototype),st(X9.prototype,"enableMotor",[dc],Object.getOwnPropertyDescriptor(X9.prototype,"enableMotor"),X9.prototype),st(X9.prototype,"maxMotorTorque",[dc],Object.getOwnPropertyDescriptor(X9.prototype,"maxMotorTorque"),X9.prototype),st(X9.prototype,"motorSpeed",[dc],Object.getOwnPropertyDescriptor(X9.prototype,"motorSpeed"),X9.prototype),Y9=st(X9.prototype,"_enableLimit",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),K9=st(X9.prototype,"_lowerAngle",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),J9=st(X9.prototype,"_upperAngle",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Q9=st(X9.prototype,"_enableMotor",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Z9=st(X9.prototype,"_maxMotorTorque",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),$9=st(X9.prototype,"_motorSpeed",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),q9=X9))||q9)||q9),t("Physics2DUtils",{PolygonSeparator:L6}),function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._type=p6.Closest,e._fixtures=[],e._points=[],e._normals=[],e._fractions=[],e._mask=4294967295,e}Q(e,t);var n=e.prototype;return n.init=function(t,e){this._type=t,this._mask=e,this._fixtures.length=0,this._points.length=0,this._normals.length=0,this._fractions.length=0},n.ReportFixture=function(t,e,n,i){return 0==(t.GetFilterData().categoryBits&this._mask)?0:this._type===p6.Closest?(this._fixtures[0]=t,this._points[0]=e,this._normals[0]=n,this._fractions[0]=i,i):(this._fixtures.push(t),this._points.push(new Wn(e.x,e.y)),this._normals.push(new Wn(n.x,n.y)),this._fractions.push(i),this._type===p6.Any?0:this._type>=p6.All?1:i)},n.getFixtures=function(){return this._fixtures},n.getPoints=function(){return this._points},n.getNormals=function(){return this._normals},n.getFractions=function(){return this._fractions},e}(d6.RayCastCallback)),utt=[],htt=[new Wn,new Wn],_tt=new d6.WorldManifold,ftt={points:[],separations:[],normal:new Wn},ptt=function(){this.localPoint=new Wn,this.normalImpulse=0,this.tangentImpulse=0},dtt=[new ptt,new ptt],mtt={type:0,localPoint:new Wn,localNormal:new Wn,points:[]},vtt={normalImpulses:[],tangentImpulses:[]},gtt=function(){function t(){this.colliderA=null,this.colliderB=null,this.disabled=!1,this.disabledOnce=!1,this._impulse=null,this._inverted=!1,this._b2contact=null}t.get=function(e){var n=utt.pop();return n||(n=new t),n.init(e),n},t.put=function(t){var e=t.m_userData;e&&(utt.push(e),e.reset())};var e=t.prototype;return e._setImpulse=function(t){this._impulse=t},e.init=function(t){this.colliderA=t.m_fixtureA.m_userData.collider,this.colliderB=t.m_fixtureB.m_userData.collider,this.disabled=!1,this.disabledOnce=!1,this._impulse=null,this._inverted=!1,this._b2contact=t,t.m_userData=this},e.reset=function(){this.setTangentSpeed(0),this.resetFriction(),this.resetRestitution(),this.colliderA=null,this.colliderB=null,this.disabled=!1,this._impulse=null,this._b2contact.m_userData=null,this._b2contact=null},e.getWorldManifold=function(){var t=ftt.points,e=ftt.separations,n=ftt.normal;this._b2contact.GetWorldManifold(_tt);var i=_tt.points,r=_tt.separations,o=this._b2contact.GetManifold().pointCount;t.length=e.length=o;for(var a=0;a<o;a++){var s=htt[a];s.x=i[a].x*g6,s.y=i[a].y*g6,t[a]=s,e[a]=r[a]*g6}return n.x=_tt.normal.x,n.y=_tt.normal.y,this._inverted&&(n.x*=-1,n.y*=-1),ftt},e.getManifold=function(){for(var t=mtt.points,e=mtt.localNormal,n=mtt.localPoint,i=this._b2contact.GetManifold(),r=i.points,o=t.length=i.pointCount,a=0;a<o;a++){var s=dtt[a],c=r[a];s.localPoint.x=c.localPoint.x*g6,s.localPoint.y=c.localPoint.y*g6,s.normalImpulse=c.normalImpulse*g6,s.tangentImpulse=c.tangentImpulse,t[a]=s}return n.x=i.localPoint.x*g6,n.y=i.localPoint.y*g6,e.x=i.localNormal.x,e.y=i.localNormal.y,mtt.type=i.type,this._inverted&&(e.x*=-1,e.y*=-1),mtt},e.getImpulse=function(){var t=this._impulse;if(!t)return null;for(var e=vtt.normalImpulses,n=vtt.tangentImpulses,i=t.count,r=0;r<i;r++)e[r]=t.normalImpulses[r]*g6,n[r]=t.tangentImpulses[r];return n.length=e.length=i,vtt},e.emit=function(t){var e=this.colliderA,n=this.colliderB,i=e.body,r=n.body;i.enabledContactListener&&(null==e||e.emit(t,e,n,this)),r.enabledContactListener&&(null==n||n.emit(t,n,e,this)),(i.enabledContactListener||r.enabledContactListener)&&d7.instance.emit(t,e,n,this),(this.disabled||this.disabledOnce)&&(this.setEnabled(!1),this.disabledOnce=!1)},e.setEnabled=function(t){this._b2contact.SetEnabled(t)},e.isTouching=function(){return this._b2contact.IsTouching()},e.setTangentSpeed=function(t){this._b2contact.SetTangentSpeed(t)},e.getTangentSpeed=function(){return this._b2contact.GetTangentSpeed()},e.setFriction=function(t){this._b2contact.SetFriction(t)},e.getFriction=function(){return this._b2contact.GetFriction()},e.resetFriction=function(){return this._b2contact.ResetFriction()},e.setRestitution=function(t){this._b2contact.SetRestitution(t)},e.getRestitution=function(){return this._b2contact.GetRestitution()},e.resetRestitution=function(){return this._b2contact.ResetRestitution()},t}(),ytt=new d6.Vec2,xtt=new bn,Stt=bn.GREEN,Ctt=bn.RED,Att=function(t){function e(e){var n;return(n=t.call(this)||this)._drawer=null,n._xf=new d6.Transform,n._dxf=new d6.Transform,n._drawer=e,n}Q(e,t);var n=e.prototype;return n._DrawPolygon=function(t,e){for(var n=this._drawer,i=0;i<e;i++){d6.Transform.MulXV(this._xf,t[i],ytt);var r=ytt.x*g6,o=ytt.y*g6;0===i?n.moveTo(r,o):n.lineTo(r,o)}n.close()},n.DrawPolygon=function(t,e,n){this._applyStrokeColor(n),this._DrawPolygon(t,e),this._drawer.stroke()},n.DrawSolidPolygon=function(t,e,n){this._applyFillColor(n),this._DrawPolygon(t,e),this._drawer.fill(),this._drawer.stroke()},n._DrawCircle=function(t,e){var n=this._xf.p;this._drawer.circle((t.x+n.x)*g6,(t.y+n.y)*g6,e*g6)},n.DrawCircle=function(t,e,n){this._applyStrokeColor(n),this._DrawCircle(t,e),this._drawer.stroke()},n.DrawSolidCircle=function(t,e,n,i){this._applyFillColor(i),this._DrawCircle(t,e),this._drawer.fill()},n.DrawSegment=function(t,e,n){var i=this._drawer;if(t.x===e.x&&t.y===e.y)return this._applyFillColor(n),this._DrawCircle(t,2/g6),void i.fill();this._applyStrokeColor(n),d6.Transform.MulXV(this._xf,t,ytt),i.moveTo(ytt.x*g6,ytt.y*g6),d6.Transform.MulXV(this._xf,e,ytt),i.lineTo(ytt.x*g6,ytt.y*g6),i.stroke()},n.DrawTransform=function(t){var e=this._drawer;e.strokeColor=Ctt,ytt.x=ytt.y=0,d6.Transform.MulXV(t,ytt,ytt),e.moveTo(ytt.x*g6,ytt.y*g6),ytt.x=1,ytt.y=0,d6.Transform.MulXV(t,ytt,ytt),e.lineTo(ytt.x*g6,ytt.y*g6),e.stroke(),e.strokeColor=Stt,ytt.x=ytt.y=0,d6.Transform.MulXV(t,ytt,ytt),e.moveTo(ytt.x*g6,ytt.y*g6),ytt.x=0,ytt.y=1,d6.Transform.MulXV(t,ytt,ytt),e.lineTo(ytt.x*g6,ytt.y*g6),e.stroke()},n.DrawPoint=function(){},n.DrawParticles=function(){},n._applyStrokeColor=function(t){this._drawer.strokeColor=xtt.set(255*t.r,255*t.g,255*t.b,150)},n._applyFillColor=function(t){this._drawer.fillColor=xtt.set(255*t.r,255*t.g,255*t.b,150)},n.PushTransform=function(t){this._xf=t},n.PopTransform=function(){this._xf=this._dxf},e}(d6.Draw),btt=new En,Ttt=new Wn,Ett=new Wn,wtt=new d6.BodyDef,Ptt=new d6.AABB,Itt=[],Rtt=function(){function t(){this._world=void 0,this._bodies=[],this._animatedBodies=[],this._rotationAxis=new En,this._contactListener=void 0,this._aabbQueryCallback=void 0,this._raycastQueryCallback=void 0,this._debugGraphics=null,this._b2DebugDrawer=null,this._debugDrawFlags=0,this._world=new d6.World(new d6.Vec2(0,-10));var t=new y6;t.setBeginContact(this._onBeginContact),t.setEndContact(this._onEndContact),t.setPreSolve(this._onPreSolve),t.setPostSolve(this._onPostSolve),this._world.SetContactListener(t),this._contactListener=t,this._aabbQueryCallback=new x6,this._raycastQueryCallback=new ltt}var e=t.prototype;return e._checkDebugDrawValid=function(){if(!this._debugGraphics||!this._debugGraphics.isValid){var t=vD("Canvas");if(!t){var e=zM.getScene();if(!e)return;(t=new GT("Canvas")).addComponent(nK),t.parent=e}var n=new GT("PHYSICS_2D_DEBUG_DRAW");n.hideFlags|=ul.Flags.DontSave,n.parent=t,n.worldPosition=En.ZERO,n.layer=Rp.Enum.UI_2D,this._debugGraphics=n.addComponent(Fq),this._debugGraphics.lineWidth=2;var i=new Att(this._debugGraphics);this._b2DebugDrawer=i,this._world.SetDebugDraw(i)}var r=this._debugGraphics.node.parent;this._debugGraphics.node.setSiblingIndex(r.children.length-1),this._b2DebugDrawer&&this._b2DebugDrawer.SetFlags(this.debugDrawFlags)},e.setGravity=function(t){this._world.SetGravity(t)},e.setAllowSleep=function(){this._world.SetAllowSleeping(!0)},e.step=function(t,e,n){void 0===e&&(e=10),void 0===n&&(n=10);for(var i=this._animatedBodies,r=0,o=i.length;r<o;r++)i[r].animate(t);this._world.Step(t,e,n)},e.raycast=function(t,e,n,i){if(t.equals(e))return[];n=n||p6.Closest,Ttt.x=t.x/g6,Ttt.y=t.y/g6,Ett.x=e.x/g6,Ett.y=e.y/g6;var r=this._raycastQueryCallback;r.init(n,i),this._world.RayCast(r,Ttt,Ett);var o=r.getFixtures();if(o.length>0){for(var a=r.getPoints(),s=r.getNormals(),c=r.getFractions(),l=[],u=0,h=o.length;u<h;u++){var _=o[u],f=_.m_userData,p=f.collider;if(n===p6.AllClosest){for(var d=void 0,m=0;m<l.length;m++)l[m].collider===p&&(d=l[m]);if(d){c[u]<d.fraction&&(d.fixtureIndex=f.getFixtureIndex(_),d.point.x=a[u].x*g6,d.point.y=a[u].y*g6,d.normal.x=s[u].x,d.normal.y=s[u].y,d.fraction=c[u]);continue}}l.push({collider:p,fixtureIndex:f.getFixtureIndex(_),point:new Wn(a[u].x*g6,a[u].y*g6),normal:new Wn(s[u].x,s[u].y),fraction:c[u]})}return l}return[]},e.syncPhysicsToScene=function(){for(var t=this._bodies,e=0,n=t.length;e<n;e++){var i=t[e],r=i.rigidBody;if(r.type!==u6.Animated){var o=r.node,a=i.impl,s=a.GetPosition();btt.x=s.x*g6,btt.y=s.y*g6,btt.z=0,o.worldPosition=btt;var c=ln(a.GetAngle());o.setWorldRotationFromEuler(0,0,c)}else i.resetVelocity()}},e.syncSceneToPhysics=function(){for(var t=this._bodies,e=0;e<t.length;e++)t[e].syncRotationToPhysics(),t[e].syncPositionToPhysics()},e.addBody=function(t){if(!this._bodies.includes(t)){var e=wtt,n=t.rigidBody;e.allowSleep=n.allowSleep,e.gravityScale=n.gravityScale,e.linearDamping=n.linearDamping,e.angularDamping=n.angularDamping,e.fixedRotation=n.fixedRotation,e.bullet=n.bullet;var i=n.node,r=i.worldPosition;e.position.Set(r.x/g6,r.y/g6),btt.z=Mn.getAxisAngle(this._rotationAxis,i.worldRotation),e.angle=btt.z,e.awake=n.awakeOnLoad,n.type===u6.Animated?(e.type=u6.Kinematic,this._animatedBodies.push(t),t._animatedPos.set(e.position.x,e.position.y),t._animatedAngle=e.angle):e.type=n.type;var o=n,a=o._linearVelocity;e.linearVelocity.Set(a.x,a.y),e.angularVelocity=cn(o._angularVelocity);var s=this._world.CreateBody(e);s.m_userData=t,t._imp=s,this._bodies.push(t)}},e.removeBody=function(t){this._bodies.includes(t)&&(t.impl&&(t.impl.m_userData=null,this._world.DestroyBody(t.impl),t._imp=null),te.remove(this._bodies,t),t.rigidBody.type===u6.Animated&&te.remove(this._animatedBodies,t))},e.registerContactFixture=function(t){this._contactListener.registerContactFixture(t)},e.unregisterContactFixture=function(t){this._contactListener.unregisterContactFixture(t)},e.testPoint=function(t){var e=Ttt.x=t.x/g6,n=Ttt.y=t.y/g6,i=.2/g6;Ptt.lowerBound.x=e-i,Ptt.lowerBound.y=n-i,Ptt.upperBound.x=e+i,Ptt.upperBound.y=n+i;var r=this._aabbQueryCallback;r.init(Ttt),this._world.QueryAABB(r,Ptt);var o=r.getFixtures();Itt.length=0;for(var a=0;a<o.length;a++){var s=o[a].m_userData.collider;Itt.includes(s)||Itt.push(s)}return Itt},e.testAABB=function(t){Ptt.lowerBound.x=t.xMin/g6,Ptt.lowerBound.y=t.yMin/g6,Ptt.upperBound.x=t.xMax/g6,Ptt.upperBound.y=t.yMax/g6;var e=this._aabbQueryCallback;e.init(),this._world.QueryAABB(e,Ptt);var n=e.getFixtures();Itt.length=0;for(var i=0;i<n.length;i++){var r=n[i].m_userData.collider;Itt.includes(r)||Itt.push(r)}return Itt},e.drawDebug=function(){this._checkDebugDrawValid(),this._debugGraphics&&(this._debugGraphics.clear(),this._world.DrawDebugData())},e._onBeginContact=function(t){gtt.get(t).emit(v6.BEGIN_CONTACT)},e._onEndContact=function(t){var e=t.m_userData;e&&(e.emit(v6.END_CONTACT),gtt.put(t))},e._onPreSolve=function(t){var e=t.m_userData;e&&e.emit(v6.PRE_SOLVE)},e._onPostSolve=function(t,e){var n=t.m_userData;n&&(n._setImpulse(e),n.emit(v6.POST_SOLVE),n._setImpulse(null))},K(t,[{key:"impl",get:function(){return this._world}},{key:"debugDrawFlags",get:function(){return this._debugDrawFlags},set:function(t){t||this._debugGraphics&&(this._debugGraphics.node.parent=null),this._debugDrawFlags=t}}]),t}(),Dtt=(new En,new d6.Vec2),Btt=function(){function t(){this._animatedPos=new Wn,this._animatedAngle=0,this._body=null,this._inited=!1}var e=t.prototype;return e.initialize=function(t){this._rigidBody=t,d7.instance._callAfterStep(this,this._init)},e.onDestroy=function(){d7.instance._callAfterStep(this,this._destroy)},e.onEnable=function(){this.setActive(!0)},e.onDisable=function(){this.setActive(!1)},e._registerNodeEvents=function(){this.rigidBody.node.on(FA.TRANSFORM_CHANGED,this._onNodeTransformChanged,this)},e._unregisterNodeEvents=function(){this.rigidBody.node.off(FA.TRANSFORM_CHANGED,this._onNodeTransformChanged,this)},e._onNodeTransformChanged=function(t){if(!d7.instance.stepping){if(t&GT.TransformBit.SCALE)for(var e=this.rigidBody.getComponents(rtt),n=0;n<e.length;n++)e[n].apply();t&GT.TransformBit.POSITION&&this.syncPositionToPhysics(!0),t&GT.TransformBit.ROTATION&&this.syncRotationToPhysics(!0)}},e._init=function(){this._inited||(this._registerNodeEvents(),d7.instance.physicsWorld.addBody(this),this._inited=!0)},e._destroy=function(){this._inited&&(d7.instance.physicsWorld.removeBody(this),this._unregisterNodeEvents(),this._inited=!1)},e.animate=function(t){var e=this._body;if(e){var n=e.GetPosition();e.SetAwake(!0);var i=1/t;Dtt.x=(this._animatedPos.x-n.x)*i,Dtt.y=(this._animatedPos.y-n.y)*i,e.SetLinearVelocity(Dtt);var r=e.GetAngle();e.SetAngularVelocity((this._animatedAngle-r)*i)}},e.syncPositionToPhysics=function(t){void 0===t&&(t=!1);var e=this._body;if(e){var n,i=this._rigidBody.node.worldPosition,r=this._rigidBody.type;(n=r===u6.Animated?e.GetLinearVelocity():e.GetPosition()).x=i.x/g6,n.y=i.y/g6,r===u6.Animated&&t?this._animatedPos.set(n.x,n.y):e.SetTransformVec(n,e.GetAngle())}},e.syncRotationToPhysics=function(t){void 0===t&&(t=!1);var e=this._body;if(e){var n=cn(this._rigidBody.node.eulerAngles.z);this._rigidBody.type===u6.Animated&&t?this._animatedAngle=n:e.SetTransformVec(e.GetPosition(),n)}},e.resetVelocity=function(){var t=this._body;if(t){var e=t.m_linearVelocity;e.Set(0,0),t.SetLinearVelocity(e),t.SetAngularVelocity(0)}},e.setType=function(t){this._body.SetType(t)},e.setLinearDamping=function(t){this._body.SetLinearDamping(t)},e.setAngularDamping=function(t){this._body.SetAngularDamping(t)},e.setGravityScale=function(t){this._body.SetGravityScale(t)},e.setFixedRotation=function(t){this._body.SetFixedRotation(t)},e.setAllowSleep=function(t){this._body.SetSleepingAllowed(t)},e.isActive=function(){return this._body.IsActive()},e.setActive=function(t){this._body.SetActive(t)},e.wakeUp=function(){this._body.SetAwake(!0)},e.sleep=function(){this._body.SetAwake(!1)},e.getMass=function(){return this._body.GetMass()},e.setLinearVelocity=function(t){this._body.SetLinearVelocity(t)},e.getLinearVelocity=function(t){var e=this._body.GetLinearVelocity();return t.x=e.x,t.y=e.y,t},e.getLinearVelocityFromWorldPoint=function(t,e){return Dtt.Set(t.x/g6,t.y/g6),this._body.GetLinearVelocityFromWorldPoint(Dtt,e),e.x*=g6,e.y*=g6,e},e.setAngularVelocity=function(t){this._body.SetAngularVelocity(t)},e.getAngularVelocity=function(){return ln(this._body.GetAngularVelocity())},e.getLocalVector=function(t,e){return e=e||new Wn,Dtt.Set(t.x/g6,t.y/g6),this._body.GetLocalVector(Dtt,e),e.x*=g6,e.y*=g6,e},e.getWorldVector=function(t,e){return Dtt.Set(t.x/g6,t.y/g6),this._body.GetWorldVector(Dtt,e),e.x*=g6,e.y*=g6,e},e.getLocalPoint=function(t,e){return e=e||new Wn,Dtt.Set(t.x/g6,t.y/g6),this._body.GetLocalPoint(Dtt,e),e.x*=g6,e.y*=g6,e},e.getWorldPoint=function(t,e){return e=e||new Wn,Dtt.Set(t.x/g6,t.y/g6),this._body.GetWorldPoint(Dtt,e),e.x*=g6,e.y*=g6,e},e.getLocalCenter=function(t){t=t||new Wn;var e=this._body.GetLocalCenter();return t.x=e.x*g6,t.y=e.y*g6,t},e.getWorldCenter=function(t){t=t||new Wn;var e=this._body.GetWorldCenter();return t.x=e.x*g6,t.y=e.y*g6,t},e.getInertia=function(){return this._body.GetInertia()},e.applyForce=function(t,e,n){this._body&&(Dtt.Set(e.x/g6,e.y/g6),this._body.ApplyForce(t,Dtt,n))},e.applyForceToCenter=function(t,e){this._body&&this._body.ApplyForceToCenter(t,e)},e.applyTorque=function(t,e){this._body&&this._body.ApplyTorque(t,e)},e.applyLinearImpulse=function(t,e,n){this._body&&(Dtt.Set(e.x/g6,e.y/g6),this._body.ApplyLinearImpulse(t,Dtt,n))},e.applyLinearImpulseToCenter=function(t,e){this._body&&this._body.ApplyLinearImpulse(t,this._body.GetPosition(),e)},e.applyAngularImpulse=function(t,e){this._body&&this._body.ApplyAngularImpulse(t,e)},K(t,[{key:"impl",get:function(){return this._body}},{key:"_imp",set:function(t){this._body=t}},{key:"rigidBody",get:function(){return this._rigidBody}},{key:"isAwake",get:function(){return this._body.IsAwake()}},{key:"isSleeping",get:function(){return!this._body.IsAwake()}}]),t}(),Mtt=new d6.Filter;function Ott(t){var e=t.collider;return Mtt.categoryBits=e.group===W6.DEFAULT?e.body.group:e.group,Mtt.maskBits=d7.instance.collisionMatrix[Mtt.categoryBits],Mtt}var Ntt,Ltt=function(){function t(){this._shapes=[],this._fixtures=[],this._collider=null,this._body=null,this._inited=!1,this._rect=new ti}var e=t.prototype;return e.initialize=function(t){this._collider=t},e.onLoad=function(){},e.onEnable=function(){d7.instance._callAfterStep(this,this._init)},e.onDisable=function(){d7.instance._callAfterStep(this,this._destroy)},e.start=function(){},e.onGroupChanged=function(){var t=Ott(this);this._fixtures.forEach((function(e){e.SetFilterData(t)}))},e.apply=function(){this._destroy(),this._init()},e.getFixtureIndex=function(t){return this._fixtures.indexOf(t)},e._createShapes=function(){return[]},e._init=function(){var t;if(!this._inited){var e=this.collider,n=e.getComponent(itt);if(n){var i=null===(t=n.impl)||void 0===t?void 0:t.impl;if(i){for(var r=n.node.worldScale,o=0===r.x&&0===r.y?[]:this._createShapes(r.x,r.y),a=Ott(this),s=0;s<o.length;s++){var c=o[s],l={density:e.density,isSensor:e.sensor,friction:e.friction,restitution:e.restitution,shape:c,filter:a},u=i.CreateFixture(l);u.m_userData=this,n.enabledContactListener&&d7.instance.physicsWorld.registerContactFixture(u),this._shapes.push(c),this._fixtures.push(u)}this._body=i,this._inited=!0}}}},e._destroy=function(){if(this._inited){for(var t=this._fixtures,e=this._body,n=t.length-1;n>=0;n--){var i=t[n];i.m_userData=null,d7.instance.physicsWorld.unregisterContactFixture(i),e&&e.DestroyFixture(i)}this._body=null,this._fixtures.length=0,this._shapes.length=0,this._inited=!1}},K(t,[{key:"impl",get:function(){return this._shapes}},{key:"collider",get:function(){return this._collider}},{key:"worldAABB",get:function(){for(var t=1e7,e=t,n=t,i=-t,r=-t,o=this._fixtures,a=0;a<o.length;a++)for(var s=o[a],c=s.GetShape().GetChildCount(),l=0;l<c;l++){var u=s.GetAABB(l);u.lowerBound.x<e&&(e=u.lowerBound.x),u.lowerBound.y<n&&(n=u.lowerBound.y),u.upperBound.x>i&&(i=u.upperBound.x),u.upperBound.y>r&&(r=u.upperBound.y)}e*=g6,n*=g6,i*=g6,r*=g6;var h=this._rect;return h.x=e,h.y=n,h.width=i-e,h.height=r-n,h}}]),t}(),Ftt=new ti,ztt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._worldPoints=[new Wn,new Wn,new Wn,new Wn],e}return Q(e,t),e.prototype._createShapes=function(t,e){t=Math.abs(t),e=Math.abs(e);var n=this.collider,i=n.size.width/2/g6*t,r=n.size.height/2/g6*e,o=n.offset.x/g6*t,a=n.offset.y/g6*e,s=new d6.PolygonShape;return s.SetAsBox(i,r,new d6.Vec2(o,a),0),[s]},K(e,[{key:"worldPoints",get:function(){var t=Ftt,e=this.collider,n=e.size,i=e.offset;t.x=i.x-n.width/2,t.y=i.y-n.height/2,t.width=n.width,t.height=n.height;var r=this._worldPoints,o=r[0],a=r[1],s=r[2],c=r[3];return t.transformMat4ToPoints(e.node.worldMatrix,o,a,s,c),r}}]),e}(Ltt),Gtt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._worldPosition=new Wn,e}return Q(e,t),e.prototype._createShapes=function(t,e){t=Math.abs(t),e=Math.abs(e);var n=this.collider,i=n.offset.x/g6*t,r=n.offset.y/g6*e,o=new d6.CircleShape;return o.m_radius=n.radius/g6*t,o.m_p.Set(i,r),[o]},K(e,[{key:"worldRadius",get:function(){return this._shapes[0].m_radius*g6}},{key:"worldPosition",get:function(){var t=this._shapes[0].m_p;return this._worldPosition.set(t.x*g6,t.y*g6)}}]),e}(Ltt),Vtt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._worldPoints=[],e}return Q(e,t),e.prototype._createShapes=function(t,e){var n=[],i=this.collider,r=i.points;r.length>0&&r[0].equals(r[r.length-1])&&(r.length-=1);for(var o=A6(r),a=i.offset,s=0;s<o.length;s++){for(var c=o[s],l=null,u=[],h=null,_=0,f=c.length;_<f;_++){l||(l=new d6.PolygonShape);var p=c[_],d=(p.x+a.x)/g6*t,m=(p.y+a.y)/g6*e,v=new d6.Vec2(d,m);u.push(v),h||(h=v),u.length===d6.maxPolygonVertices&&(l.Set(u,u.length),n.push(l),l=null,_<f-1&&(u=[h,u[u.length-1]]))}l&&(l.Set(u,u.length),n.push(l))}return n},K(e,[{key:"worldPoints",get:function(){for(var t=this.collider,e=t.points,n=this._worldPoints,i=t.node.worldMatrix,r=0;r<e.length;r++)n[r]||(n[r]=new Wn),Wn.transformMat4(n[r],e[r],i);return n.length=e.length,this._worldPoints}}]),e}(Ltt),Utt=function(){function t(){this._b2joint=null,this._jointComp=null,this._body=null,this._inited=!1}var e=t.prototype;return e.initialize=function(t){this._jointComp=t},e.onEnable=function(){d7.instance._callAfterStep(this,this._init)},e.onDisable=function(){d7.instance._callAfterStep(this,this._destroy)},e.start=function(){d7.instance._callAfterStep(this,this._init)},e._init=function(){if(!this._inited){var t=this._jointComp;if(t.isValid){this._body=t.getComponent(itt);var e=this._createJointDef();if(e){var n=t.connectedBody;n&&n.enabledInHierarchy&&(e.bodyA=this._body.impl.impl,e.bodyB=n.impl.impl,e.collideConnected=t.collideConnected,this._b2joint=d7.instance.physicsWorld.impl.CreateJoint(e),this._inited=!0)}}}},e._destroy=function(){this._inited&&(d7.instance.physicsWorld.impl.DestroyJoint(this._b2joint),this._b2joint=null,this._inited=!1)},e._createJointDef=function(){return null},e.isValid=function(){return this._b2joint&&this._body&&this._body.impl&&this._jointComp&&this._jointComp.connectedBody&&this._jointComp.connectedBody.impl},K(t,[{key:"impl",get:function(){return this._b2joint}},{key:"comp",get:function(){return this._jointComp}},{key:"body",get:function(){return this._body}}]),t}(),ktt=new d6.Vec2;Ntt={PhysicsWorld:Rtt,RigidBody:Btt,BoxShape:ztt,CircleShape:Gtt,PolygonShape:Vtt,MouseJoint:function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._touchPoint=new Wn,e._isTouched=!1,e}Q(e,t);var n=e.prototype;return n.setTarget=function(t){this._b2joint&&(ktt.x=t.x/g6,ktt.y=t.y/g6,this._b2joint.SetTarget(ktt))},n.setDampingRatio=function(t){this._b2joint&&this._b2joint.SetDampingRatio(t)},n.setFrequency=function(t){this._b2joint&&this._b2joint.SetFrequency(t)},n.setMaxForce=function(t){this._b2joint&&this._b2joint.SetMaxForce(t)},n._createJointDef=function(){var t=new d6.MouseJointDef,e=this._jointComp;return t.target.Set(this._touchPoint.x/g6,this._touchPoint.y/g6),t.maxForce=e.maxForce,t.dampingRatio=e.dampingRatio,t.frequencyHz=e.frequency,t},n.initialize=function(e){t.prototype.initialize.call(this,e);var n=vD("Canvas");n&&(n.on(FA.TOUCH_START,this.onTouchBegan,this),n.on(FA.TOUCH_MOVE,this.onTouchMove,this),n.on(FA.TOUCH_END,this.onTouchEnd,this),n.on(FA.TOUCH_CANCEL,this.onTouchEnd,this))},n.onEnable=function(){},n.start=function(){},n.onTouchBegan=function(t){this._isTouched=!0;var e=this._touchPoint.set(t.getUILocation()),n=d7.instance.physicsWorld.testPoint(e);if(!(n.length<=0)){var i=n[0].body;i.wakeUp();var r=this._jointComp;r.connectedBody=i,this._init(),this.setMaxForce(r.maxForce*i.getMass()),this.setTarget(e)}},n.onTouchMove=function(t){this._touchPoint=t.getUILocation()},n.onTouchEnd=function(){this._destroy(),this._isTouched=!1},n.update=function(){this._isTouched&&this.isValid()&&this.setTarget(this._touchPoint)},e}(Utt),DistanceJoint:function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.setMaxLength=function(t){this._b2joint&&this._b2joint.SetMaxLength(t)},n._createJointDef=function(){var t=this._jointComp,e=new d6.RopeJointDef;return e.localAnchorA.Set(t.anchor.x/g6,t.anchor.y/g6),e.localAnchorB.Set(t.connectedAnchor.x/g6,t.connectedAnchor.y/g6),e.maxLength=t.maxLength/g6,e},e}(Utt),SpringJoint:function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.setDampingRatio=function(t){this._b2joint&&this._b2joint.SetDampingRatio(t)},n.setFrequency=function(t){this._b2joint&&this._b2joint.SetFrequency(t)},n.setDistance=function(t){this._b2joint&&this._b2joint.SetLength(t)},n._createJointDef=function(){var t=this._jointComp,e=new d6.DistanceJointDef;return e.localAnchorA.Set(t.anchor.x/g6,t.anchor.y/g6),e.localAnchorB.Set(t.connectedAnchor.x/g6,t.connectedAnchor.y/g6),e.length=t.distance/g6,e.dampingRatio=t.dampingRatio,e.frequencyHz=t.frequency,e},e}(Utt),RelativeJoint:function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.setMaxForce=function(t){this._b2joint&&this._b2joint.SetMaxForce(t)},n.setAngularOffset=function(t){this._b2joint&&this._b2joint.SetAngularOffset(cn(t))},n.setLinearOffset=function(t){this._b2joint&&this._b2joint.SetLinearOffset(new d6.Vec2(t.x/g6,t.y/g6))},n.setCorrectionFactor=function(t){this._b2joint&&(this._b2joint.m_correctionFactor=t)},n.setMaxTorque=function(t){this._b2joint&&this._b2joint.SetMaxTorque(t)},n._createJointDef=function(){var t=this._jointComp,e=new d6.MotorJointDef;return e.linearOffset.Set(t.linearOffset.x/g6,t.linearOffset.y/g6),e.angularOffset=cn(t.angularOffset),e.maxForce=t.maxForce,e.maxTorque=t.maxTorque,e.correctionFactor=t.correctionFactor,e},e}(Utt),SliderJoint:function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.enableLimit=function(t){this._b2joint&&this._b2joint.EnableLimit(t)},n.setLowerLimit=function(){this.updateLimits()},n.setUpperLimit=function(){this.updateLimits()},n.updateLimits=function(){if(this._b2joint){var t=this._jointComp;this._b2joint.SetLimits(t.lowerLimit/g6,t.upperLimit/g6)}},n.enableMotor=function(t){this._b2joint&&this._b2joint.EnableMotor(t)},n.setMaxMotorForce=function(t){this._b2joint&&this._b2joint.SetMaxMotorForce(t)},n.setMotorSpeed=function(t){this._b2joint&&this._b2joint.SetMotorSpeed(t)},n._createJointDef=function(){var t=this._jointComp,e=new d6.PrismaticJointDef;e.localAnchorA.Set(t.anchor.x/g6,t.anchor.y/g6),e.localAnchorB.Set(t.connectedAnchor.x/g6,t.connectedAnchor.y/g6);var n=cn(t.angle);return e.localAxisA.Set(Math.cos(n),Math.sin(n)),e.referenceAngle=0,e.enableLimit=t.enableLimit,e.lowerTranslation=t.lowerLimit/g6,e.upperTranslation=t.upperLimit/g6,e.enableMotor=t.enableMotor,e.maxMotorForce=t.maxMotorForce,e.motorSpeed=t.motorSpeed,e},e}(Utt),FixedJoint:function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.setFrequency=function(t){this._b2joint&&this._b2joint.SetFrequency(t)},n.setDampingRatio=function(t){this._b2joint&&this._b2joint.SetDampingRatio(t)},n._createJointDef=function(){var t=this._jointComp,e=new d6.WeldJointDef;return e.localAnchorA.Set(t.anchor.x/g6,t.anchor.y/g6),e.localAnchorB.Set(t.connectedAnchor.x/g6,t.connectedAnchor.y/g6),e.referenceAngle=0,e.frequencyHz=t.frequency,e.dampingRatio=t.dampingRatio,e},e}(Utt),WheelJoint:function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.setDampingRatio=function(t){this._b2joint&&this._b2joint.SetSpringDampingRatio(t)},n.setFrequency=function(t){this._b2joint&&this._b2joint.SetSpringFrequencyHz(t)},n.enableMotor=function(t){this._b2joint&&this._b2joint.EnableMotor(t)},n.setMaxMotorTorque=function(t){this._b2joint&&this._b2joint.SetMaxMotorTorque(t)},n.setMotorSpeed=function(t){this._b2joint&&this._b2joint.SetMotorSpeed(t)},n._createJointDef=function(){var t=this._jointComp,e=new d6.WheelJointDef;e.localAnchorA.Set(t.anchor.x/g6,t.anchor.y/g6),e.localAnchorB.Set(t.connectedAnchor.x/g6,t.connectedAnchor.y/g6);var n=cn(t.angle);return e.localAxisA.Set(Math.cos(n),Math.sin(n)),e.maxMotorTorque=t.maxMotorTorque,e.motorSpeed=cn(t.motorSpeed),e.enableMotor=t.enableMotor,e.dampingRatio=t.dampingRatio,e.frequencyHz=t.frequency,e},e}(Utt),HingeJoint:function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.enableLimit=function(t){this._b2joint&&this._b2joint.EnableLimit(t)},n.setLowerAngle=function(){this.updateLimits()},n.setUpperAngle=function(){this.updateLimits()},n.updateLimits=function(){if(this._b2joint){var t=this._jointComp;this._b2joint.SetLimits(cn(t.lowerAngle),cn(t.upperAngle))}},n.enableMotor=function(t){this._b2joint&&this._b2joint.EnableMotor(t)},n.setMaxMotorTorque=function(t){this._b2joint&&this._b2joint.SetMaxMotorTorque(t)},n.setMotorSpeed=function(t){this._b2joint&&this._b2joint.SetMotorSpeed(t)},n._createJointDef=function(){var t=this._jointComp,e=new d6.RevoluteJointDef;return e.localAnchorA.Set(t.anchor.x/g6,t.anchor.y/g6),e.localAnchorB.Set(t.connectedAnchor.x/g6,t.connectedAnchor.y/g6),e.enableMotor=t.enableMotor,e.maxMotorTorque=t.maxMotorTorque,e.motorSpeed=cn(t.motorSpeed),e.enableLimit=t.enableLimit,e.lowerAngle=t.lowerAngle,e.upperAngle=t.upperAngle,e},e}(Utt)},r6="box2d",c._global.CC_PHYSICS_2D_BUILTIN=!1,c._global.CC_PHYSICS_2D_BOX2D=!0,i6=Ntt;var Htt,jtt,Wtt,qtt,Xtt,Ytt,Ktt,Jtt,Qtt,Ztt,$tt,tet,eet,net,iet,ret,oet,aet,set,cet,uet,het,_et,fet,pet,det,met,vet,get,yet,xet,Cet,Aet,bet,Tet,Eet,wet,Pet,Iet,Ret,Det,Bet,Met,Oet,Net,Let,Fet,zet,Get,Vet,Uet,ket,Het,jet,Wet,qet,Xet,Yet,Ket,Jet,Qet,Zet=function(){function t(t,e,n){this._id=void 0,this._opts=void 0,this._accumStart=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=t,this._opts=e,this._accumStart=n}var e=t.prototype;return e.sample=function(t){this._average(this._value,t)},e.human=function(){var t=this._opts,e=t.average,n=t.isInteger,i=e?this._averageValue:this._value;return n?Math.round(i):Math.round(100*i)/100},e.alarm=function(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over},e._average=function(t,e){if(void 0===e&&(e=0),this._opts.average){this._accumValue+=t,++this._accumSamples;var n=e;n-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=n,this._accumSamples=0)}},K(t,[{key:"value",get:function(){return this._value},set:function(t){this._value=t}}]),t}(),$et=hc("cc.PerfCounter")(Htt=function(t){function e(e,n,i){var r;return(r=t.call(this,e,n,i)||this)._time=void 0,r._time=i,r}Q(e,t);var n=e.prototype;return n.start=function(t){void 0===t&&(t=0),this._time=t},n.end=function(t){void 0===t&&(t=0),this._value=t-this._time,this._average(this._value)},n.tick=function(){this.end(),this.start()},n.frame=function(t){var e=t,n=e-this._time;this._total++,n>(this._opts.average||1e3)&&(this._value=1e3*this._total/n,this._total=0,this._time=e,this._average(this._value))},e}(Zet))||Htt,tnt="0123456789. ",ent=500,nnt={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10},int={fps:{desc:"Framerate (FPS)",below:30,average:ent,isInteger:!0},draws:{desc:"Draw call",isInteger:!0},frame:{desc:"Frame time (ms)",min:0,max:50,average:ent},instances:{desc:"Instance Count",isInteger:!0},tricount:{desc:"Triangle",isInteger:!0},logic:{desc:"Game Logic (ms)",min:0,max:50,average:ent,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:ent},render:{desc:"Renderer (ms)",min:0,max:50,average:ent,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}},rnt=t("Profiler",function(){function t(){this._stats=null,this.id="__Profiler__",this._showFPS=!1,this._rootNode=null,this._device=null,this._swapchain=null,this._pipeline=null,this._meshRenderer=null,this._canvas=null,this._ctx=null,this._texture=null,this._region=new ir,this._canvasArr=[],this._regionArr=[this._region],this.digitsData=null,this.offsetData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=256/(Object.keys(int).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0,this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._canvasArr.push(this._canvas)}var e=t.prototype;return e.reset=function(){this._stats=null,this._showFPS=!1,this._rootNode=null,this._device=null,this._swapchain=null,this._pipeline=null,this._meshRenderer&&this._meshRenderer.destroy(),this._meshRenderer=null,this.digitsData=null,this.offsetData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=256/(Object.keys(int).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0},e.isShowingStats=function(){return this._showFPS},e.hideStats=function(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),c.director.off(c.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),c.director.off(c.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),c.director.off(c.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),c.director.off(c.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),c.director.off(c.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),c.director.off(c.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!1,this._pipeline.profiler=null,c.game.config.showFPS=!1)},e.showStats=function(){if(!this._showFPS){if(!this._device){var t=c.director.root;this._device=t.device,this._swapchain=t.mainWindow.swapchain,this._pipeline=t.pipeline}this.generateCanvas(),this.generateStats(),c.game.once(c.Game.EVENT_ENGINE_INITED,this.generateNode,this),this._rootNode&&(this._rootNode.active=!0),c.director.on(c.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),c.director.on(c.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),c.director.on(c.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),c.director.on(c.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),c.director.on(c.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),c.director.on(c.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0,c.game.config.showFPS=!0}},e.generateCanvas=function(){if(!this._canvasDone){this._ctx&&this._canvas&&(this._canvas.width=256,this._canvas.height=256,this._canvas.style.width=""+this._canvas.width,this._canvas.style.height=""+this._canvas.height,this._ctx.font="23px Arial",this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture(new pr(vi.TEX2D,gi.SAMPLED|gi.TRANSFER_DST,ui.RGBA8,256,256)),this._region.texExtent.width=256,this._region.texExtent.height=256)}},e.generateStats=function(){if(!this._statsDone&&this._ctx&&this._canvas){this._stats=null;var t=performance.now();this._ctx.textAlign="left";var e=0;for(var n in int){var i=int[n];this._ctx.fillText(i.desc,0,e*this._lineHeight),i.counter=new $et(n,i,t),e++}this._totalLines=e,this._wordHeight=this._totalLines*this._lineHeight/this._canvas.height;for(var r=0;r<tnt.length;++r){var o=this._ctx.measureText(tnt[r]).width;this._eachNumWidth=Math.max(this._eachNumWidth,o)}for(var a=0;a<tnt.length;++a)this._ctx.fillText(tnt[a],a*this._eachNumWidth,this._totalLines*this._lineHeight);this._eachNumWidth/=this._canvas.width,this._stats=int,this._canvasArr[0]=this._canvas,this._device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}},e.generateNode=function(){if(!this._rootNode||!this._rootNode.isValid){this._rootNode=new GT("PROFILER_NODE"),c.game.addPersistRootNode(this._rootNode);var t=new GT("Profiler_Root");t.parent=this._rootNode;for(var e=.4,n=e/this._totalLines,i=e/this._wordHeight,r=n/23,o=this._eachNumWidth*this._canvas.width*r,a=[0,e,0,i,e,0,i,0,0,0,0,0],s=[0,2,1,0,3,2],l=[0,0,-1,0,1,0,-1,0,1,this._wordHeight,-1,0,0,this._wordHeight,-1,0],u=0,h=0;h<this._totalLines;h++)for(var _=0;_<8;_++){a.push(i+_*o,e-h*n,0),a.push(i+(_+1)*o,e-h*n,0),a.push(i+(_+1)*o,e-(h+1)*n,0),a.push(i+_*o,e-(h+1)*n,0),u=4*(8*h+_+1),s.push(0+u,2+u,1+u,0+u,3+u,2+u);var f=8*h+_,p=Math.floor(f/4),d=f-4*p;l.push(0,this._wordHeight,p,d),l.push(this._eachNumWidth,this._wordHeight,p,d),l.push(this._eachNumWidth,1,p,d),l.push(0,1,p,d)}this._meshRenderer=t.addComponent(C0),this._meshRenderer.mesh=R$({positions:a,indices:s,colors:l});var m=new ig;m.initialize({effectName:"profiler"});var v=this.pass=m.passes[0],g=v.getBinding("mainTexture"),y=v.getBinding("digits"),x=v.getBinding("offset");v.bindTexture(g,this._texture),this.digitsData=v.blocks[y],this.offsetData=v.blocks[x],this.offsetData[3]=-1,this._meshRenderer.material=m,this._meshRenderer.node.layer=Rp.Enum.PROFILER,this._inited=!0}},e.beforeUpdate=function(){if(this._stats){var t=performance.now();this._stats.frame.counter.start(t),this._stats.logic.counter.start(t)}},e.afterUpdate=function(){if(this._stats){var t=performance.now();c.director.isPaused()?this._stats.frame.counter.start(t):this._stats.logic.counter.end(t)}},e.beforePhysics=function(){if(this._stats){var t=performance.now();this._stats.physics.counter.start(t)}},e.afterPhysics=function(){if(this._stats){var t=performance.now();this._stats.physics.counter.end(t)}},e.beforeDraw=function(){if(this._stats&&this._inited){var t=this._swapchain.surfaceTransform,e=this._device.capabilities.clipSpaceSignY;if(t!==this.offsetData[3]){var n=Vn[t],i=-.9*e;this.offsetData[0]=-.9*n[0]+i*n[2],this.offsetData[1]=-.9*n[1]+i*n[3],this.offsetData[2]=this._eachNumWidth,this.offsetData[3]=t}this.pass._setRootBufferDirty(!0),this._meshRenderer.model&&(this._pipeline.profiler=this._meshRenderer.model);var r=performance.now();this._stats.render.counter.start(r)}},e.afterDraw=function(){if(this._stats&&this._inited){var t=performance.now();if(this._stats.frame.counter.end(t),this._stats.fps.counter.frame(t),this._stats.render.counter.end(t),!(t-this.lastTime<ent)){this.lastTime=t;var e=this._device;this._stats.draws.counter.value=e.numDrawCalls,this._stats.instances.counter.value=e.numInstances,this._stats.bufferMemory.counter.value=e.memoryStatus.bufferSize/1048576,this._stats.textureMemory.counter.value=e.memoryStatus.textureSize/1048576,this._stats.tricount.counter.value=e.numTris;var n=0,i=this.digitsData;for(var r in this._stats){var o=this._stats[r];o.counter.sample(t);for(var a=o.counter.human().toString(),s=7;s>=0;s--){var c=8*n+s,l=a[a.length-(8-s)],u=nnt[l];void 0===u&&(u=11),i[c]=u}n++}}}},t}()),ont=t("profiler",new rnt);c.profiler=ont;var ant,snt,cnt,lnt=new bn;!function(t){t[t.NONE=0]="NONE",t[t.COLOR=1]="COLOR",t[t.SPRITE=2]="SPRITE",t[t.SCALE=3]="SCALE"}(ant||(ant={})),ae(ant),function(t){t.NORMAL="normal",t.HOVER="hover",t.PRESSED="pressed",t.DISABLED="disabled"}(snt||(snt={})),function(t){t.CLICK="click"}(cnt||(cnt={}));var unt=function(e){return t({Button:e,ButtonComponent:e}),e}((jtt=hc("cc.Button"),Wtt=wc(),qtt=fc(110),Xtt=Ac(),Ytt=_c(RH),Ktt=Wc(GT),Jtt=zc(),Qtt=Bc(),Ztt=zc(),$tt=Bc(),tet=Wc(ant),eet=zc(),net=Bc(),iet=zc(),ret=Bc(),oet=zc(),aet=Bc(),set=zc(),cet=Bc(),uet=zc(),het=Bc(),_et=Oc(),fet=Nc(),pet=zc(),det=Bc(),met=zc(),vet=Bc(),get=Wc(ik),yet=zc(),xet=Bc(),Cet=Wc(ik),Aet=zc(),bet=Bc(),Tet=Wc(ik),Eet=zc(),wet=Bc(),Pet=Wc(ik),Iet=zc(),Ret=Bc(),Det=Wc([ML]),Bet=zc(),Met=Bc(),jtt(Oet=Wtt(Oet=qtt(Oet=Xtt(Oet=Ytt(Oet=Cc((Qet=Jet=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"clickEvents",Let,it(e)),at(e,"_interactable",Fet,it(e)),at(e,"_transition",zet,it(e)),at(e,"_normalColor",Get,it(e)),at(e,"_hoverColor",Vet,it(e)),at(e,"_pressedColor",Uet,it(e)),at(e,"_disabledColor",ket,it(e)),at(e,"_normalSprite",Het,it(e)),at(e,"_hoverSprite",jet,it(e)),at(e,"_pressedSprite",Wet,it(e)),at(e,"_disabledSprite",qet,it(e)),at(e,"_duration",Xet,it(e)),at(e,"_zoomScale",Yet,it(e)),at(e,"_target",Ket,it(e)),e._pressed=!1,e._hovered=!1,e._fromColor=new bn,e._toColor=new bn,e._time=0,e._transitionFinished=!0,e._fromScale=new En,e._toScale=new En,e._originalScale=null,e._sprite=null,e._targetScale=new En,e}Q(e,t);var n=e.prototype;return n.__preload=function(){this.target||(this.target=this.node);var t=this.node.getComponent(iY);t&&(this._normalSprite=t.spriteFrame),this._applyTarget(),this._resetState()},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._resetState(),this._unregisterNodeEvent()},n.onDestroy=function(){this.target.isValid&&this._unregisterTargetEvent(this.target)},n.update=function(t){var e=this.target;if(!this._transitionFinished&&e&&(this._transition===ant.COLOR||this._transition===ant.SCALE)){this._time+=t;var n=1;if(this._duration>0&&(n=this._time/this._duration),n>=1&&(n=1),this._transition===ant.COLOR){var i=e._uiProps.uiComp;bn.lerp(lnt,this._fromColor,this._toColor,n),i&&(i.color=lnt)}else this.transition===ant.SCALE&&(e.getScale(this._targetScale),this._targetScale.x=sn(this._fromScale.x,this._toScale.x,n),this._targetScale.y=sn(this._fromScale.y,this._toScale.y,n),e.setScale(this._targetScale));1===n&&(this._transitionFinished=!0)}},n._resizeNodeToTargetNode=function(){this.target&&this.target._uiProps.uiTransformComp},n._resetState=function(){this._pressed=!1,this._hovered=!1;var t=this.target;if(t){var e=this._transition;if(e===ant.COLOR&&this._interactable){var n=t.getComponent(pW);n&&(n.color=this._normalColor)}else e===ant.SCALE&&this._originalScale&&t.setScale(this._originalScale);this._transitionFinished=!0}},n._registerNodeEvent=function(){this.node.on(FA.TOUCH_START,this._onTouchBegan,this),this.node.on(FA.TOUCH_MOVE,this._onTouchMove,this),this.node.on(FA.TOUCH_END,this._onTouchEnded,this),this.node.on(FA.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(FA.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(FA.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._registerTargetEvent=function(t){t.on(FA.TRANSFORM_CHANGED,this._onTargetTransformChanged,this)},n._unregisterNodeEvent=function(){this.node.off(FA.TOUCH_START,this._onTouchBegan,this),this.node.off(FA.TOUCH_MOVE,this._onTouchMove,this),this.node.off(FA.TOUCH_END,this._onTouchEnded,this),this.node.off(FA.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(FA.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(FA.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._unregisterTargetEvent=function(t){t.off(FA.TRANSFORM_CHANGED)},n._getTargetSprite=function(t){var e=null;return t&&(e=t.getComponent(iY)),e},n._applyTarget=function(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new En),En.copy(this._originalScale,this.target.getScale()),this._registerTargetEvent(this.target))},n._onTargetSpriteFrameChanged=function(t){this._transition===ant.SPRITE&&this._setCurrentStateSpriteFrame(t.spriteFrame)},n._setCurrentStateSpriteFrame=function(t){if(t)switch(this._getButtonState()){case snt.NORMAL:this._normalSprite=t;break;case snt.HOVER:this._hoverSprite=t;break;case snt.PRESSED:this._pressedSprite=t;break;case snt.DISABLED:this._disabledSprite=t}},n._onTargetColorChanged=function(t){this._transition===ant.COLOR&&this._setCurrentStateColor(t)},n._setCurrentStateColor=function(t){switch(this._getButtonState()){case snt.NORMAL:this._normalColor=t;break;case snt.HOVER:this._hoverColor=t;break;case snt.PRESSED:this._pressedColor=t;break;case snt.DISABLED:this._disabledColor=t}},n._onTargetTransformChanged=function(t){t&Zg.SCALE&&this._originalScale&&this._transition===ant.SCALE&&this._transitionFinished&&En.copy(this._originalScale,this.target.getScale())},n._onTouchBegan=function(t){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),t&&(t.propagationStopped=!0))},n._onTouchMove=function(t){if(this._interactable&&this.enabledInHierarchy&&this._pressed&&t){var e=t.touch;if(e){var n,i=this.node._uiProps.uiTransformComp.isHit(e.getUILocation());this._transition===ant.SCALE&&this.target&&this._originalScale?i?(En.copy(this._fromScale,this._originalScale),En.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale)):(n=i?snt.PRESSED:snt.NORMAL,this._applyTransition(n)),t&&(t.propagationStopped=!0)}}},n._onTouchEnded=function(t){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(ML.emitEvents(this.clickEvents,t),this.node.emit(cnt.CLICK,this)),this._pressed=!1,this._updateState(),t&&(t.propagationStopped=!0))},n._onTouchCancel=function(){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())},n._onMouseMoveIn=function(){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==ant.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))},n._onMouseMoveOut=function(){this._hovered&&(this._hovered=!1,this._updateState())},n._updateState=function(){var t=this._getButtonState();this._applyTransition(t)},n._getButtonState=function(){var t=snt.NORMAL;return this._interactable?this._pressed?t=snt.PRESSED:this._hovered&&(t=snt.HOVER):t=snt.DISABLED,t.toString()},n._updateColorTransition=function(t){var e,n=this[t+"Color"],i=null===(e=this.target)||void 0===e?void 0:e.getComponent(pW);i&&(t===snt.DISABLED?i.color=n:(this._fromColor=i.color.clone(),this._toColor=n,this._time=0,this._transitionFinished=!1))},n._updateSpriteTransition=function(t){var e=this[t+"Sprite"];this._sprite&&e&&(this._sprite.spriteFrame=e)},n._updateScaleTransition=function(t){this._interactable&&(t===snt.PRESSED?this._zoomUp():this._zoomBack())},n._zoomUp=function(){this._originalScale&&(En.copy(this._fromScale,this._originalScale),En.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)},n._zoomBack=function(){this.target&&this._originalScale&&(En.copy(this._fromScale,this.target.getScale()),En.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)},n._applyTransition=function(t){var e=this._transition;e===ant.COLOR?this._updateColorTransition(t):e===ant.SPRITE?this._updateSpriteTransition(t):e===ant.SCALE&&this._updateScaleTransition(t)},K(e,[{key:"target",get:function(){return this._target||this.node},set:function(t){this._target!==t&&(this._target&&this._unregisterTargetEvent(this._target),this._target=t,this._applyTarget())}},{key:"interactable",get:function(){return this._interactable},set:function(t){this._interactable=t,this._updateState(),this._interactable||this._resetState()}},{key:"_resizeToTarget",set:function(t){t&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(t){this._transition!==t&&(this._transition===ant.COLOR?this._updateColorTransition(snt.NORMAL):this._transition===ant.SPRITE&&this._updateSpriteTransition(snt.NORMAL),this._transition=t,this._updateState())}},{key:"normalColor",get:function(){return this._normalColor},set:function(t){this._normalColor!==t&&(this._normalColor.set(t),this._updateState())}},{key:"pressedColor",get:function(){return this._pressedColor},set:function(t){this._pressedColor!==t&&this._pressedColor.set(t)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(t){this._hoverColor!==t&&this._hoverColor.set(t)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(t){this._disabledColor!==t&&(this._disabledColor.set(t),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(t){this._duration!==t&&(this._duration=t)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(t){this._zoomScale!==t&&(this._zoomScale=t)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(t){if(this._normalSprite!==t){this._normalSprite=t;var e=this.node.getComponent(iY);e&&(e.spriteFrame=t),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(t){this._pressedSprite!==t&&(this._pressedSprite=t,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(t){this._hoverSprite!==t&&(this._hoverSprite=t,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(t){this._disabledSprite!==t&&(this._disabledSprite=t,this._updateState())}}]),e}(Ku),Jet.Transition=ant,Jet.EventType=cnt,st((Net=Qet).prototype,"target",[Ktt,Jtt,Qtt],Object.getOwnPropertyDescriptor(Net.prototype,"target"),Net.prototype),st(Net.prototype,"interactable",[Ztt,$tt],Object.getOwnPropertyDescriptor(Net.prototype,"interactable"),Net.prototype),st(Net.prototype,"transition",[tet,eet,net],Object.getOwnPropertyDescriptor(Net.prototype,"transition"),Net.prototype),st(Net.prototype,"normalColor",[iet,ret],Object.getOwnPropertyDescriptor(Net.prototype,"normalColor"),Net.prototype),st(Net.prototype,"pressedColor",[oet,aet],Object.getOwnPropertyDescriptor(Net.prototype,"pressedColor"),Net.prototype),st(Net.prototype,"hoverColor",[set,cet],Object.getOwnPropertyDescriptor(Net.prototype,"hoverColor"),Net.prototype),st(Net.prototype,"disabledColor",[uet,het],Object.getOwnPropertyDescriptor(Net.prototype,"disabledColor"),Net.prototype),st(Net.prototype,"duration",[_et,fet,pet,det],Object.getOwnPropertyDescriptor(Net.prototype,"duration"),Net.prototype),st(Net.prototype,"zoomScale",[met,vet],Object.getOwnPropertyDescriptor(Net.prototype,"zoomScale"),Net.prototype),st(Net.prototype,"normalSprite",[get,yet,xet],Object.getOwnPropertyDescriptor(Net.prototype,"normalSprite"),Net.prototype),st(Net.prototype,"pressedSprite",[Cet,Aet,bet],Object.getOwnPropertyDescriptor(Net.prototype,"pressedSprite"),Net.prototype),st(Net.prototype,"hoverSprite",[Tet,Eet,wet],Object.getOwnPropertyDescriptor(Net.prototype,"hoverSprite"),Net.prototype),st(Net.prototype,"disabledSprite",[Pet,Iet,Ret],Object.getOwnPropertyDescriptor(Net.prototype,"disabledSprite"),Net.prototype),Let=st(Net.prototype,"clickEvents",[Det,vc,Bet,Met],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Fet=st(Net.prototype,"_interactable",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),zet=st(Net.prototype,"_transition",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ant.NONE}}),Get=st(Net.prototype,"_normalColor",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bn.WHITE.clone()}}),Vet=st(Net.prototype,"_hoverColor",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new bn(211,211,211,255)}}),Uet=st(Net.prototype,"_pressedColor",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bn.WHITE.clone()}}),ket=st(Net.prototype,"_disabledColor",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new bn(124,124,124,255)}}),Het=st(Net.prototype,"_normalSprite",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jet=st(Net.prototype,"_hoverSprite",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Wet=st(Net.prototype,"_pressedSprite",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qet=st(Net.prototype,"_disabledSprite",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Xet=st(Net.prototype,"_duration",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Yet=st(Net.prototype,"_zoomScale",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),Ket=st(Net.prototype,"_target",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oet=Net))||Oet)||Oet)||Oet)||Oet)||Oet)||Oet));c.Button=unt;var hnt,_nt,fnt,pnt=function(){function t(){}return t.add=function(t){var e=this._tabIndexList;-1===e.indexOf(t)&&e.push(t)},t.remove=function(t){var e=this._tabIndexList,n=e.indexOf(t);-1!==n&&e.splice(n,1)},t.resort=function(){this._tabIndexList.sort((function(t,e){return t._delegate.tabIndex-e._delegate.tabIndex}))},t.next=function(t){var e=this._tabIndexList,n=e.indexOf(t);if(t.setFocus(!1),-1!==n){var i=e[n+1];i&&i._delegate.tabIndex>=0&&i.setFocus(!0)}},t}();pnt._tabIndexList=[],function(t){t[t.DEFAULT=0]="DEFAULT",t[t.DONE=1]="DONE",t[t.SEND=2]="SEND",t[t.SEARCH=3]="SEARCH",t[t.GO=4]="GO",t[t.NEXT=5]="NEXT"}(hnt||(hnt={})),ie(hnt),function(t){t[t.ANY=0]="ANY",t[t.EMAIL_ADDR=1]="EMAIL_ADDR",t[t.NUMERIC=2]="NUMERIC",t[t.PHONE_NUMBER=3]="PHONE_NUMBER",t[t.URL=4]="URL",t[t.DECIMAL=5]="DECIMAL",t[t.SINGLE_LINE=6]="SINGLE_LINE"}(_nt||(_nt={})),ie(_nt),function(t){t[t.PASSWORD=0]="PASSWORD",t[t.SENSITIVE=1]="SENSITIVE",t[t.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",t[t.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",t[t.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",t[t.DEFAULT=5]="DEFAULT"}(fnt||(fnt={})),ie(fnt);var dnt,mnt,vnt,gnt,ynt,xnt,Snt,Cnt,Ant,bnt,Tnt,Ent,wnt,Pnt,Int,Rnt,Dnt,Bnt,Mnt,Ont,Nnt,Lnt,Fnt,znt,Gnt,Vnt,Unt,knt,Hnt,jnt,Wnt,qnt,Xnt,Ynt,Knt,Jnt,Qnt,Znt,$nt,tit,eit,nit,iit,rit,oit,ait,sit,cit,lit,uit,hit,_it,fit,pit,dit,mit,vit,git,yit,xit,Sit,Cit=function(){function t(){this._editing=!1,this._delegate=null}var e=t.prototype;return e.init=function(){},e.onEnable=function(){},e.update=function(){},e.onDisable=function(){this._editing&&this.endEditing()},e.clear=function(){this._delegate=null},e.setTabIndex=function(){},e.setSize=function(){},e.setFocus=function(t){t?this.beginEditing():this.endEditing()},e.isFocused=function(){return this._editing},e.beginEditing=function(){},e.endEditing=function(){},t}(),Ait=new Un,bit=new Un,Tit=new En,Eit=null,wit=0,Pit=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._delegate=null,e._inputMode=-1,e._inputFlag=-1,e._returnType=-1,e.__eventListeners={},e.__autoResize=!1,e.__orientationChanged=void 0,e._edTxt=null,e._isTextArea=!1,e._textLabelFont=null,e._textLabelFontSize=null,e._textLabelFontColor=null,e._textLabelAlign=null,e._placeholderLabelFont=null,e._placeholderLabelFontSize=null,e._placeholderLabelFontColor=null,e._placeholderLabelAlign=null,e._placeholderLineHeight=null,e._placeholderStyleSheet=null,e._domId="EditBoxId_"+ ++wit,e}Q(e,t);var n=e.prototype;return n.init=function(t){t&&(this._delegate=t,t.inputMode===_nt.ANY?this._createTextArea():this._createInput(),pnt.add(this),this.setTabIndex(t.tabIndex),this._initStyleSheet(),this._registerEventListeners(),this._addDomToGameContainer())},n.clear=function(){this._removeEventListeners(),this._removeDomFromGameContainer(),pnt.remove(this),Eit===this&&(Eit=null),this._delegate=null},n.update=function(){this._updateMatrix()},n.setTabIndex=function(t){this._edTxt.tabIndex=t,pnt.resort()},n.setSize=function(t,e){var n=this._edTxt;n&&(n.style.width=t+"px",n.style.height=e+"px")},n.beginEditing=function(){Eit&&Eit!==this&&Eit.setFocus(!1),this._editing=!0,Eit=this,this._delegate._editBoxEditingDidBegan(),this._showDom(),this._edTxt.focus()},n.endEditing=function(){this._edTxt.blur()},n._createInput=function(){this._isTextArea=!1,this._edTxt=document.createElement("input")},n._createTextArea=function(){this._isTextArea=!0,this._edTxt=document.createElement("textarea")},n._addDomToGameContainer=function(){c.GAME_VIEW&&this._edTxt?(c.gameView.container.appendChild(this._edTxt),c.gameView.head.appendChild(this._placeholderStyleSheet)):LM.container&&this._edTxt&&(LM.container.appendChild(this._edTxt),document.head.appendChild(this._placeholderStyleSheet))},n._removeDomFromGameContainer=function(){(c.GAME_VIEW?me(c.gameView.container,this._edTxt):me(LM.container,this._edTxt))&&this._edTxt&&(c.GAME_VIEW?c.gameView.container.removeChild(this._edTxt):LM.container.removeChild(this._edTxt)),(c.GAME_VIEW?me(c.gameView.head,this._placeholderStyleSheet):me(document.head,this._placeholderStyleSheet))&&(c.GAME_VIEW?c.gameView.head.removeChild(this._placeholderStyleSheet):document.head.removeChild(this._placeholderStyleSheet)),this._edTxt=null,this._placeholderStyleSheet=null},n._showDom=function(){this._updateMaxLength(),this._updateInputType(),this._updateStyleSheet(),this._edTxt&&this._delegate&&(this._edTxt.style.display="",this._delegate._hideLabels()),oh.isMobile&&this._showDomOnMobile()},n._hideDom=function(){var t=this._edTxt;t&&this._delegate&&(t.style.display="none",this._delegate._showLabels()),oh.isMobile&&this._hideDomOnMobile()},n._showDomOnMobile=function(){oh.os!==nu.ANDROID&&oh.os!==nu.OHOS||(nh.handleResizeEvent=!1,this._adjustWindowScroll())},n._hideDomOnMobile=function(){oh.os!==nu.ANDROID&&oh.os!==nu.OHOS||(nh.handleResizeEvent=!0),this._scrollBackWindow()},n._adjustWindowScroll=function(){var t=this;setTimeout((function(){window.scrollY<40&&t._edTxt.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}),400)},n._scrollBackWindow=function(){setTimeout((function(){oh.browserType!==$l.WECHAT||oh.os!==nu.IOS?window.scrollTo(0,0):window.top&&window.top.scrollTo(0,0)}),400)},n._updateMatrix=function(){if(this._edTxt){var t=this._delegate.node,e=YM.getScaleX(),n=YM.getScaleY(),i=1,r=1;c.GAME_VIEW&&(i=c.gameView.canvas.width/c.game.canvas.width,r=c.gameView.canvas.height/c.game.canvas.height),e*=i,n*=r;var o=YM.getViewportRect(),a=nh.devicePixelRatio;t.getWorldMatrix(Ait);var s=t._uiProps.uiTransformComp;if(s&&En.set(Tit,-s.anchorX*s.width,-s.anchorY*s.height,Tit.z),Un.transform(Ait,Ait,Tit),t._uiProps.uiTransformComp){var l=zM.root.batcher2D.getFirstRenderCamera(t);if(l){l.node.getWorldRT(bit);var u=bit.m12,h=bit.m13,_=UM.center;bit.m12=_.x-(bit.m00*u+bit.m04*h),bit.m13=_.y-(bit.m01*u+bit.m05*h),Un.multiply(bit,bit,Ait),e/=a,n/=a;var f=c.GAME_VIEW?c.gameView.container:LM.container,p=bit.m00*e,d=Ait.m01,m=Ait.m04,v=bit.m05*n,g=parseInt(f&&f.style.paddingLeft||"0");g+=o.x*i/a;var y=parseInt(f&&f.style.paddingBottom||"0");y+=o.y/a;var x="matrix("+p+","+-d+","+-m+","+v+","+(bit.m12*e+g)+","+-(bit.m13*n+y)+")";this._edTxt.style.transform=x,this._edTxt.style["-webkit-transform"]=x,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}},n._updateInputType=function(){var t=this._delegate,e=t.inputMode,n=t.inputFlag,i=t.returnType,r=this._edTxt;if(this._inputMode!==e||this._inputFlag!==n||this._returnType!==i){if(this._inputMode=e,this._inputFlag=n,this._returnType=i,this._isTextArea){var o="none";return n===fnt.INITIAL_CAPS_ALL_CHARACTERS?o="uppercase":n===fnt.INITIAL_CAPS_WORD&&(o="capitalize"),void(r.style.textTransform=o)}if(r=r,n===fnt.PASSWORD)return r.type="password",void(r.style.textTransform="none");var a=r.type;e===_nt.EMAIL_ADDR?a="email":e===_nt.NUMERIC||e===_nt.DECIMAL?a="number":e===_nt.PHONE_NUMBER?(a="number",r.pattern="[0-9]*",r.addEventListener("wheel",(function(){return!1}))):e===_nt.URL?a="url":(a="text",i===hnt.SEARCH&&(a="search")),r.type=a;var s="none";n===fnt.INITIAL_CAPS_ALL_CHARACTERS?s="uppercase":n===fnt.INITIAL_CAPS_WORD&&(s="capitalize"),r.style.textTransform=s}},n._updateMaxLength=function(){var t=this._delegate.maxLength;t<0&&(t=65535),this._edTxt.maxLength=t},n._initStyleSheet=function(){if(this._edTxt){var t=this._edTxt;t.style.color="#000000",t.style.border="0px",t.style.background="transparent",t.style.width="100%",t.style.height="100%",t.style.outline="medium",t.style.padding="0",t.style.textTransform="none",t.style.display="none",t.style.position="absolute",t.style.bottom="0px",t.style.left="2px",t.className="cocosEditBox",t.style.fontFamily="Arial",t.id=this._domId,this._isTextArea?(t.style.resize="none",t.style.overflowY="scroll"):((t=t).type="text",t.style["-moz-appearance"]="textfield"),this._placeholderStyleSheet=document.createElement("style")}},n._updateStyleSheet=function(){var t=this._delegate,e=this._edTxt;e&&t&&(e.value=t.string,e.placeholder=t.placeholder,this._updateTextLabel(t.textLabel),this._updatePlaceholderLabel(t.placeholderLabel))},n._updateTextLabel=function(t){if(t){var e=t.font;e=!e||e instanceof bk?t.fontFamily:e._fontFamily;var n=t.fontSize*t.node.scale.y;if((this._textLabelFont!==e||this._textLabelFontSize!==n||this._textLabelFontColor!==t.fontColor||this._textLabelAlign!==t.horizontalAlign)&&(this._textLabelFont=e,this._textLabelFontSize=n,this._textLabelFontColor=t.fontColor,this._textLabelAlign=t.horizontalAlign,this._edTxt)){var i=this._edTxt;switch(i.style.fontSize=n+"px",i.style.color=t.color.toCSS(),i.style.fontFamily=e,t.horizontalAlign){case dW.HorizontalAlign.LEFT:i.style.textAlign="left";break;case dW.HorizontalAlign.CENTER:i.style.textAlign="center";break;case dW.HorizontalAlign.RIGHT:i.style.textAlign="right"}}}},n._updatePlaceholderLabel=function(t){if(t){var e=t.font;e=!e||e instanceof bk?t.fontFamily:t.font._fontFamily;var n=t.fontSize*t.node.scale.y;if(this._placeholderLabelFont!==e||this._placeholderLabelFontSize!==n||this._placeholderLabelFontColor!==t.fontColor||this._placeholderLabelAlign!==t.horizontalAlign||this._placeholderLineHeight!==t.fontSize){this._placeholderLabelFont=e,this._placeholderLabelFontSize=n,this._placeholderLabelFontColor=t.fontColor,this._placeholderLabelAlign=t.horizontalAlign,this._placeholderLineHeight=t.fontSize;var i=this._placeholderStyleSheet,r=t.color.toCSS(),o=t.fontSize,a="";switch(t.horizontalAlign){case dW.HorizontalAlign.LEFT:a="left";break;case dW.HorizontalAlign.CENTER:a="center";break;case dW.HorizontalAlign.RIGHT:a="right"}i.innerHTML="#"+this._domId+"::-webkit-input-placeholder{text-transform: initial;-family: "+e+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-moz-placeholder{text-transform: initial;-family: "+e+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-ms-input-placeholder{text-transform: initial;-family: "+e+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}",oh.browserType===$l.EDGE&&(i.innerHTML+="#"+this._domId+"::-ms-clear{display: none;}")}}},n._registerEventListeners=function(){var t=this;if(this._edTxt){var e=this._edTxt,n=!1,i=this.__eventListeners;i.compositionStart=function(){n=!0},i.compositionEnd=function(){n=!1,t._delegate._editBoxTextChanged(e.value)},i.onInput=function(){if(!n){var i=t._delegate,r=i.maxLength;r>=0&&(e.value=e.value.slice(0,r)),i._editBoxTextChanged(e.value)}},i.onClick=function(){t._editing&&oh.isMobile&&t._adjustWindowScroll()},i.onKeydown=function(n){n.keyCode===HR.ENTER?(n.propagationStopped=!0,t._delegate._editBoxEditingReturn(),t._isTextArea||e.blur()):n.keyCode===HR.TAB&&(n.propagationStopped=!0,n.preventDefault(),pnt.next(t))},i.onBlur=function(){oh.isMobile&&n&&i.compositionEnd(),t._editing=!1,Eit=null,t._hideDom(),t._delegate._editBoxEditingDidEnded()},e.addEventListener("compositionstart",i.compositionStart),e.addEventListener("compositionend",i.compositionEnd),e.addEventListener("input",i.onInput),e.addEventListener("keydown",i.onKeydown),e.addEventListener("blur",i.onBlur),e.addEventListener("touchstart",i.onClick)}},n._removeEventListeners=function(){if(this._edTxt){var t=this._edTxt,e=this.__eventListeners;t.removeEventListener("compositionstart",e.compositionStart),t.removeEventListener("compositionend",e.compositionEnd),t.removeEventListener("input",e.onInput),t.removeEventListener("keydown",e.onKeydown),t.removeEventListener("blur",e.onBlur),t.removeEventListener("touchstart",e.onClick),e.compositionStart=null,e.compositionEnd=null,e.onInput=null,e.onKeydown=null,e.onBlur=null,e.onClick=null}},e}(Cit);!function(t){t.EDITING_DID_BEGAN="editing-did-began",t.EDITING_DID_ENDED="editing-did-ended",t.TEXT_CHANGED="text-changed",t.EDITING_RETURN="editing-return"}(Sit||(Sit={}));var Iit,Rit,Dit,Bit,Mit,Oit,Nit,Lit,Fit,zit,Git,Vit,Uit,kit,Hit,jit,Wit,qit,Xit,Yit,Kit,Jit,Qit,Zit,$it,trt,ert,nrt,irt,rrt,ort,art,srt,crt,lrt,urt,hrt,_rt,frt,prt,drt,mrt,vrt,grt,yrt,xrt,Srt,Crt,Art,brt,Trt,Ert,wrt,Prt,Irt,Rrt,Drt,Brt,Mrt,Ort,Nrt,Lrt=function(e){return t({EditBox:e,EditBoxComponent:e}),e}((dnt=hc("cc.EditBox"),mnt=wc(),vnt=fc(110),gnt=Ac(),ynt=_c(RH),xnt=zc(),Snt=Bc(),Cnt=zc(),Ant=Bc(),bnt=Wc(dW),Tnt=zc(),Ent=Bc(),wnt=Wc(dW),Pnt=zc(),Int=Bc(),Rnt=Wc(ik),Dnt=zc(),Bnt=Bc(),Mnt=Wc(fnt),Ont=zc(),Nnt=Bc(),Lnt=Wc(_nt),Fnt=zc(),znt=Bc(),Gnt=Wc(hnt),Vnt=zc(),Unt=Bc(),knt=zc(),Hnt=Bc(),jnt=zc(),Wnt=Bc(),qnt=Wc([ML]),Xnt=zc(),Ynt=Bc(),Knt=Wc([ML]),Jnt=zc(),Qnt=Bc(),Znt=Wc([ML]),$nt=zc(),tit=Bc(),eit=Wc([ML]),nit=zc(),iit=Bc(),dnt(rit=mnt(rit=vnt(rit=gnt(rit=ynt(rit=Cc((xit=yit=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"editingDidBegan",ait,it(e)),at(e,"textChanged",sit,it(e)),at(e,"editingDidEnded",cit,it(e)),at(e,"editingReturn",lit,it(e)),e._impl=null,e._background=null,at(e,"_textLabel",uit,it(e)),at(e,"_placeholderLabel",hit,it(e)),at(e,"_returnType",_it,it(e)),at(e,"_string",fit,it(e)),at(e,"_tabIndex",pit,it(e)),at(e,"_backgroundImage",dit,it(e)),at(e,"_inputFlag",mit,it(e)),at(e,"_inputMode",vit,it(e)),at(e,"_maxLength",git,it(e)),e._isLabelVisible=!1,e}Q(e,t);var n=e.prototype;return n.__preload=function(){this._init()},n.onEnable=function(){this._registerEvent(),this._ensureBackgroundSprite(),this._impl&&this._impl.onEnable()},n.update=function(){this._impl&&this._impl.update()},n.onDisable=function(){this._unregisterEvent(),this._unregisterBackgroundEvent(),this._impl&&this._impl.onDisable()},n.onDestroy=function(){this._impl&&this._impl.clear()},n.setFocus=function(){this._impl&&this._impl.setFocus(!0)},n.focus=function(){this._impl&&this._impl.setFocus(!0)},n.blur=function(){this._impl&&this._impl.setFocus(!1)},n.isFocused=function(){return!!this._impl&&this._impl.isFocused()},n._editBoxEditingDidBegan=function(){ML.emitEvents(this.editingDidBegan,this),this.node.emit(Sit.EDITING_DID_BEGAN,this)},n._editBoxEditingDidEnded=function(){ML.emitEvents(this.editingDidEnded,this),this.node.emit(Sit.EDITING_DID_ENDED,this)},n._editBoxTextChanged=function(t){t=this._updateLabelStringStyle(t,!0),this.string=t,ML.emitEvents(this.textChanged,t,this),this.node.emit(Sit.TEXT_CHANGED,this)},n._editBoxEditingReturn=function(){ML.emitEvents(this.editingReturn,this),this.node.emit(Sit.EDITING_RETURN,this)},n._showLabels=function(){this._isLabelVisible=!0,this._updateLabels()},n._hideLabels=function(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)},n._onTouchBegan=function(t){t.propagationStopped=!0},n._onTouchCancel=function(t){t.propagationStopped=!0},n._onTouchEnded=function(t){this._impl&&this._impl.beginEditing(),t.propagationStopped=!0},n._init=function(){this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(FA.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new e._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()},n._ensureBackgroundSprite=function(){if(!this._background){var t=this.node.getComponent(iY);t||(t=this.node.addComponent(iY)),t!==this._background&&(t.type=iY.Type.SLICED,t.spriteFrame=this._backgroundImage,this._background=t,this._registerBackgroundEvent())}},n._updateTextLabel=function(){var t=this._textLabel;if(!t){var e=this.node.getChildByName("TEXT_LABEL");e||((e=new GT("TEXT_LABEL")).layer=this.node.layer),(t=e.getComponent(dW))||(t=e.addComponent(dW)),e.parent=this.node,this._textLabel=t}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),t.overflow=dW.Overflow.CLAMP,this._inputMode===_nt.ANY?(t.verticalAlign=hW.TOP,t.enableWrapText=!0):t.enableWrapText=!1,t.string=this._updateLabelStringStyle(this._string)},n._updatePlaceholderLabel=function(){var t=this._placeholderLabel;if(!t){var e=this.node.getChildByName("PLACEHOLDER_LABEL");e||((e=new GT("PLACEHOLDER_LABEL")).layer=this.node.layer),(t=e.getComponent(dW))||(t=e.addComponent(dW)),e.parent=this.node,this._placeholderLabel=t}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),t.overflow=dW.Overflow.CLAMP,this._inputMode===_nt.ANY?(t.verticalAlign=hW.TOP,t.enableWrapText=!0):t.enableWrapText=!1,t.string=this.placeholder},n._syncSize=function(){var t=this.node._uiProps.uiTransformComp,e=t.contentSize;if(this._background){var n=this._background.node._uiProps.uiTransformComp;n.anchorPoint=t.anchorPoint,n.setContentSize(e)}this._updateLabelPosition(e),this._impl&&this._impl.setSize(e.width,e.height)},n._updateLabels=function(){if(this._isLabelVisible){var t=this._string;this._textLabel&&(this._textLabel.node.active=""!==t),this._placeholderLabel&&(this._placeholderLabel.node.active=""===t)}},n._updateString=function(t){var e=this._textLabel;if(e){var n=t;n&&(n=this._updateLabelStringStyle(n)),e.string=n,this._updateLabels()}},n._updateLabelStringStyle=function(t,e){void 0===e&&(e=!1);var n,i=this._inputFlag;if(e||i!==fnt.PASSWORD)i===fnt.INITIAL_CAPS_ALL_CHARACTERS?t=t.toUpperCase():i===fnt.INITIAL_CAPS_WORD?t=t.replace(/(?:^|\s)\S/g,(function(t){return t.toUpperCase()})):i===fnt.INITIAL_CAPS_SENTENCE&&(t=(n=t).charAt(0).toUpperCase()+n.slice(1));else{for(var r="",o=t.length,a=0;a<o;++a)r+="●";t=r}return t},n._registerEvent=function(){this.node.on(FA.TOUCH_START,this._onTouchBegan,this),this.node.on(FA.TOUCH_END,this._onTouchEnded,this)},n._unregisterEvent=function(){this.node.off(FA.TOUCH_START,this._onTouchBegan,this),this.node.off(FA.TOUCH_END,this._onTouchEnded,this)},n._onBackgroundSpriteFrameChanged=function(){this._background&&(this.backgroundImage=this._background.spriteFrame)},n._registerBackgroundEvent=function(){var t=this._background&&this._background.node;null==t||t.on(iY.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._unregisterBackgroundEvent=function(){var t=this._background&&this._background.node;null==t||t.off(iY.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._updateLabelPosition=function(t){var e=this.node._uiProps.uiTransformComp,n=-e.anchorX*e.width,i=-e.anchorY*e.height,r=this._placeholderLabel,o=this._textLabel;o&&(o.node._uiProps.uiTransformComp.setContentSize(t.width-2,t.height),o.node.setPosition(n+2,i+t.height,o.node.position.z),this._inputMode===_nt.ANY&&(o.verticalAlign=hW.TOP),o.enableWrapText=this._inputMode===_nt.ANY),r&&(r.node._uiProps.uiTransformComp.setContentSize(t.width-2,t.height),r.lineHeight=t.height,r.node.setPosition(n+2,i+t.height,r.node.position.z),this._inputMode===_nt.ANY&&(r.verticalAlign=hW.TOP),r.enableWrapText=this._inputMode===_nt.ANY)},n._resizeChildNodes=function(){var t=this.node._uiProps.uiTransformComp,e=this._textLabel&&this._textLabel.node;e&&(e.setPosition(-t.width/2,t.height/2,e.position.z),e._uiProps.uiTransformComp.setContentSize(t.contentSize));var n=this._placeholderLabel&&this._placeholderLabel.node;n&&(n.setPosition(-t.width/2,t.height/2,n.position.z),n._uiProps.uiTransformComp.setContentSize(t.contentSize));var i=this._background&&this._background.node;i&&i._uiProps.uiTransformComp.setContentSize(t.contentSize),this._syncSize()},K(e,[{key:"string",get:function(){return this._string},set:function(t){this._maxLength>=0&&t.length>=this._maxLength&&(t=t.slice(0,this._maxLength)),this._string=t,this._updateString(t)}},{key:"placeholder",get:function(){return this._placeholderLabel?this._placeholderLabel.string:""},set:function(t){this._placeholderLabel&&(this._placeholderLabel.string=t)}},{key:"textLabel",get:function(){return this._textLabel},set:function(t){this._textLabel!==t&&(this._textLabel=t,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}},{key:"placeholderLabel",get:function(){return this._placeholderLabel},set:function(t){this._placeholderLabel!==t&&(this._placeholderLabel=t,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(t){this._backgroundImage!==t&&(this._backgroundImage=t,this._ensureBackgroundSprite(),this._background.spriteFrame=t)}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(t){this._inputFlag=t,this._updateString(this._string)}},{key:"inputMode",get:function(){return this._inputMode},set:function(t){this._inputMode!==t&&(this._inputMode=t,this._updateTextLabel(),this._updatePlaceholderLabel())}},{key:"returnType",get:function(){return this._returnType},set:function(t){this._returnType=t}},{key:"maxLength",get:function(){return this._maxLength},set:function(t){this._maxLength=t}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(t){this._tabIndex!==t&&(this._tabIndex=t,this._impl&&this._impl.setTabIndex(t))}}]),e}(Ku),yit._EditBoxImpl=Cit,yit.KeyboardReturnType=hnt,yit.InputFlag=fnt,yit.InputMode=_nt,yit.EventType=Sit,st((oit=xit).prototype,"string",[xnt,Snt],Object.getOwnPropertyDescriptor(oit.prototype,"string"),oit.prototype),st(oit.prototype,"placeholder",[Cnt,Ant],Object.getOwnPropertyDescriptor(oit.prototype,"placeholder"),oit.prototype),st(oit.prototype,"textLabel",[bnt,Tnt,Ent],Object.getOwnPropertyDescriptor(oit.prototype,"textLabel"),oit.prototype),st(oit.prototype,"placeholderLabel",[wnt,Pnt,Int],Object.getOwnPropertyDescriptor(oit.prototype,"placeholderLabel"),oit.prototype),st(oit.prototype,"backgroundImage",[Rnt,Dnt,Bnt],Object.getOwnPropertyDescriptor(oit.prototype,"backgroundImage"),oit.prototype),st(oit.prototype,"inputFlag",[Mnt,Ont,Nnt],Object.getOwnPropertyDescriptor(oit.prototype,"inputFlag"),oit.prototype),st(oit.prototype,"inputMode",[Lnt,Fnt,znt],Object.getOwnPropertyDescriptor(oit.prototype,"inputMode"),oit.prototype),st(oit.prototype,"returnType",[Gnt,Vnt,Unt],Object.getOwnPropertyDescriptor(oit.prototype,"returnType"),oit.prototype),st(oit.prototype,"maxLength",[knt,Hnt],Object.getOwnPropertyDescriptor(oit.prototype,"maxLength"),oit.prototype),st(oit.prototype,"tabIndex",[jnt,Wnt],Object.getOwnPropertyDescriptor(oit.prototype,"tabIndex"),oit.prototype),ait=st(oit.prototype,"editingDidBegan",[qnt,vc,Xnt,Ynt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sit=st(oit.prototype,"textChanged",[Knt,vc,Jnt,Qnt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cit=st(oit.prototype,"editingDidEnded",[Znt,vc,$nt,tit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lit=st(oit.prototype,"editingReturn",[eit,vc,nit,iit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),uit=st(oit.prototype,"_textLabel",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hit=st(oit.prototype,"_placeholderLabel",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_it=st(oit.prototype,"_returnType",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hnt.DEFAULT}}),fit=st(oit.prototype,"_string",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),pit=st(oit.prototype,"_tabIndex",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dit=st(oit.prototype,"_backgroundImage",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mit=st(oit.prototype,"_inputFlag",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fnt.DEFAULT}}),vit=st(oit.prototype,"_inputMode",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _nt.ANY}}),git=st(oit.prototype,"_maxLength",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),rit=oit))||rit)||rit)||rit)||rit)||rit)||rit));"object"==typeof window&&"object"==typeof document&&(Lrt._EditBoxImpl=Pit),c.internal.EditBox=Lrt,function(t){t[t.NONE=0]="NONE",t[t.HORIZONTAL=1]="HORIZONTAL",t[t.VERTICAL=2]="VERTICAL",t[t.GRID=3]="GRID"}(Rrt||(Rrt={})),ae(Rrt),function(t){t[t.NONE=0]="NONE",t[t.CONTAINER=1]="CONTAINER",t[t.CHILDREN=2]="CHILDREN"}(Drt||(Drt={})),ae(Drt),function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(Brt||(Brt={})),ae(Brt),function(t){t[t.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",t[t.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(Mrt||(Mrt={})),ae(Mrt),function(t){t[t.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",t[t.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(Ort||(Ort={})),ae(Ort),function(t){t[t.NONE=0]="NONE",t[t.FIXED_ROW=1]="FIXED_ROW",t[t.FIXED_COL=2]="FIXED_COL"}(Nrt||(Nrt={})),ae(Nrt);var Frt,zrt,Grt,Vrt,Urt,krt,Hrt,jrt,Wrt,qrt,Xrt,Yrt,Krt,Jrt,Qrt,Zrt,$rt,tot,eot,not,iot,rot,oot,aot=new En,sot=function(e){return t({Layout:e,LayoutComponent:e}),e}((Iit=hc("cc.Layout"),Rit=wc(),Dit=fc(110),Bit=Ac(),Mit=_c(RH),Oit=Ic(),Nit=Bc(),Lit=Ic(),Fit=Bc(),zit=Wc(Rrt),Git=zc(),Vit=Bc(),Uit=Wc(Drt),kit=Ic(),Hit=Bc(),jit=Ic(),Wit=Bc(),qit=Wc(Brt),Xit=Bc(),Yit=Bc(),Kit=Bc(),Jit=Bc(),Qit=Bc(),Zit=Bc(),$it=Bc(),trt=Wc(Mrt),ert=Bc(),nrt=Wc(Ort),irt=Bc(),rrt=Wc(Nrt),ort=Ic(),art=Bc(),srt=Ic(),crt=Bc(),lrt=Bc(),Iit(urt=Rit(urt=Dit(urt=Bit(urt=Mit(urt=Cc((Irt=Prt=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_resizeMode",_rt,it(e)),at(e,"_layoutType",frt,it(e)),at(e,"_cellSize",prt,it(e)),at(e,"_startAxis",drt,it(e)),at(e,"_paddingLeft",mrt,it(e)),at(e,"_paddingRight",vrt,it(e)),at(e,"_paddingTop",grt,it(e)),at(e,"_paddingBottom",yrt,it(e)),at(e,"_spacingX",xrt,it(e)),at(e,"_spacingY",Srt,it(e)),at(e,"_verticalDirection",Crt,it(e)),at(e,"_horizontalDirection",Art,it(e)),at(e,"_constraint",brt,it(e)),at(e,"_constraintNum",Trt,it(e)),at(e,"_affectedByScale",Ert,it(e)),at(e,"_isAlign",wrt,it(e)),e._layoutSize=new Zn(300,200),e._layoutDirty=!0,e._childrenDirty=!1,e._usefulLayoutObj=[],e._init=!1,e}Q(e,t);var n=e.prototype;return n.updateLayout=function(t){void 0===t&&(t=!1),(this._layoutDirty||t)&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)},n.onEnable=function(){this._addEventListeners();var t=this.node._uiProps.uiTransformComp;t.contentSize.equals(Zn.ZERO)&&t.setContentSize(this._layoutSize),this._childrenChanged()},n.onDisable=function(){this._usefulLayoutObj.length=0,this._removeEventListeners()},n._checkUsefulObj=function(){this._usefulLayoutObj.length=0;for(var t=this.node.children,e=0;e<t.length;++e){var n=t[e],i=n._uiProps.uiTransformComp;n.activeInHierarchy&&i&&this._usefulLayoutObj.push(i)}},n._addEventListeners=function(){zM.on(FM.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(FA.SIZE_CHANGED,this._resized,this),this.node.on(FA.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(FA.CHILD_ADDED,this._childAdded,this),this.node.on(FA.CHILD_REMOVED,this._childRemoved,this),this.node.on(FA.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.on("childrenSiblingOrderChanged",this.updateLayout,this),this._addChildrenEventListeners()},n._removeEventListeners=function(){zM.off(FM.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(FA.SIZE_CHANGED,this._resized,this),this.node.off(FA.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(FA.CHILD_ADDED,this._childAdded,this),this.node.off(FA.CHILD_REMOVED,this._childRemoved,this),this.node.off(FA.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.off("childrenSiblingOrderChanged",this.updateLayout,this),this._removeChildrenEventListeners()},n._addChildrenEventListeners=function(){for(var t=this.node.children,e=0;e<t.length;++e){var n=t[e];n.on(FA.SIZE_CHANGED,this._doLayoutDirty,this),n.on(FA.TRANSFORM_CHANGED,this._transformDirty,this),n.on(FA.ANCHOR_CHANGED,this._doLayoutDirty,this),n.on(FA.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._removeChildrenEventListeners=function(){for(var t=this.node.children,e=0;e<t.length;++e){var n=t[e];n.off(FA.SIZE_CHANGED,this._doLayoutDirty,this),n.off(FA.TRANSFORM_CHANGED,this._transformDirty,this),n.off(FA.ANCHOR_CHANGED,this._doLayoutDirty,this),n.off(FA.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._childAdded=function(t){t.on(FA.SIZE_CHANGED,this._doLayoutDirty,this),t.on(FA.TRANSFORM_CHANGED,this._transformDirty,this),t.on(FA.ANCHOR_CHANGED,this._doLayoutDirty,this),t.on(FA.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._childRemoved=function(t){t.off(FA.SIZE_CHANGED,this._doLayoutDirty,this),t.off(FA.TRANSFORM_CHANGED,this._transformDirty,this),t.off(FA.ANCHOR_CHANGED,this._doLayoutDirty,this),t.off(FA.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._resized=function(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()},n._doLayoutHorizontally=function(t,e,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingLeft;this._horizontalDirection===Ort.RIGHT_TO_LEFT&&(a=-1,s=this._paddingRight);var c=(this._horizontalDirection-r.x)*t+a*s,l=c-a*this._spacingX,u=0,h=0,_=0,f=0,p=!1,d=this._usefulLayoutObj.length,m=this._cellSize.width,v=this._getPaddingH();this._layoutType!==Rrt.GRID&&this._resizeMode===Drt.CHILDREN&&(m=(t-v-(d-1)*this._spacingX)/d);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var x=g[y],S=x.node,C=S.scale,A=this._getUsedScaleValue(C.x),b=this._getUsedScaleValue(C.y);this._resizeMode===Drt.CHILDREN&&(x.width=m/A,this._layoutType===Rrt.GRID&&(x.height=this._cellSize.height/b));var T=Math.abs(this._horizontalDirection-x.anchorX),E=x.width*A,w=x.height*b;w>_&&(f=Math.max(_,f),h=_||w,_=w),l+=a*(T*E+this._spacingX);var P=a*(1-T)*E;if(e){if(o>0)(p=y/o>0&&y%o==0)&&(h=_>w?_:h);else if(E>t-v)l>c+a*T*E&&(p=!0);else{var I=(1-this._horizontalDirection-r.x)*t,R=l+P+a*(a>0?this._paddingRight:this._paddingLeft);p=Math.abs(R)>Math.abs(I)}p&&(l=c+a*T*E,w!==_&&(h=_),u+=h+this._spacingY,h=_=w)}var D=n(S,x,u);i&&S.setPosition(l,D),l+=P}return h=Math.max(h,_),Math.max(f,u+h)+this._getPaddingV()},n._doLayoutVertically=function(t,e,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingBottom;this._verticalDirection===Mrt.TOP_TO_BOTTOM&&(a=-1,s=this._paddingTop);var c=(this._verticalDirection-r.y)*t+a*s,l=c-a*this._spacingY,u=0,h=0,_=0,f=0,p=!1,d=this._usefulLayoutObj.length,m=this._cellSize.height,v=this._getPaddingV();this._layoutType!==Rrt.GRID&&this._resizeMode===Drt.CHILDREN&&(m=(t-v-(d-1)*this._spacingY)/d);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var x=g[y],S=x.node,C=S.scale,A=this._getUsedScaleValue(C.x),b=this._getUsedScaleValue(C.y);this._resizeMode===Drt.CHILDREN&&(x.height=m/b,this._layoutType===Rrt.GRID&&(x.width=this._cellSize.width/A));var T=Math.abs(this._verticalDirection-x.anchorY),E=x.width*A,w=x.height*b;E>u&&(h=Math.max(u,h),_=u||E,u=E),l+=a*(T*w+this._spacingY);var P=a*(1-T)*w;if(e){if(o>0)(p=y/o>0&&y%o==0)&&(_=u>w?u:_);else if(w>t-v)l>c+a*T*w&&(p=!0);else{var I=(1-this._verticalDirection-r.y)*t,R=l+P+a*(a>0?this._paddingTop:this._paddingBottom);p=Math.abs(R)>Math.abs(I)}p&&(l=c+a*T*w,E!==u&&(_=u),f+=_+this._spacingX,_=u=E)}var D=n(S,x,f);i&&(S.getPosition(aot),S.setPosition(D,l,aot.z)),l+=P}return _=Math.max(_,u),Math.max(h,f+_)+this._getPaddingH()},n._doLayoutGridAxisHorizontal=function(t,e){var n=this,i=e.width,r=1,o=-t.y*e.height,a=this._paddingBottom;this._verticalDirection===Mrt.TOP_TO_BOTTOM&&(r=-1,o=(1-t.y)*e.height,a=this._paddingTop);var s=function(t,e,i){return o+r*(i+(1-e.anchorY)*e.height*n._getUsedScaleValue(t.scale.y)+a)},c=0;this._resizeMode===Drt.CONTAINER&&(c=this._doLayoutHorizontally(i,!0,s,!1),o=-t.y*c,this._verticalDirection===Mrt.TOP_TO_BOTTOM&&(r=-1,o=(1-t.y)*c)),this._doLayoutHorizontally(i,!0,s,!0),this._resizeMode===Drt.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(i,c)},n._doLayoutGridAxisVertical=function(t,e){var n=this,i=e.height,r=1,o=-t.x*e.width,a=this._paddingLeft;this._horizontalDirection===Ort.RIGHT_TO_LEFT&&(r=-1,o=(1-t.x)*e.width,a=this._paddingRight);var s=function(t,e,i){return o+r*(i+(1-e.anchorX)*e.width*n._getUsedScaleValue(t.scale.x)+a)},c=0;this._resizeMode===Drt.CONTAINER&&(c=this._doLayoutVertically(i,!0,s,!1),o=-t.x*c,this._horizontalDirection===Ort.RIGHT_TO_LEFT&&(r=-1,o=(1-t.x)*c)),this._doLayoutVertically(i,!0,s,!0),this._resizeMode===Drt.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(c,i)},n._doLayoutGrid=function(){var t=this.node._uiProps.uiTransformComp,e=t.anchorPoint,n=t.contentSize;this.startAxis===Brt.HORIZONTAL?this._doLayoutGridAxisHorizontal(e,n):this.startAxis===Brt.VERTICAL&&this._doLayoutGridAxisVertical(e,n)},n._getHorizontalBaseWidth=function(){var t=this._usefulLayoutObj,e=0,n=t.length;if(this._resizeMode===Drt.CONTAINER){for(var i=0;i<t.length;++i){var r=t[i],o=r.node.scale;e+=r.width*this._getUsedScaleValue(o.x)}e+=(n-1)*this._spacingX+this._getPaddingH()}else e=this.node._uiProps.uiTransformComp.width;return e},n._getVerticalBaseHeight=function(){var t=this._usefulLayoutObj,e=0,n=t.length;if(this._resizeMode===Drt.CONTAINER){for(var i=0;i<t.length;++i){var r=t[i],o=r.node.scale;e+=r.height*this._getUsedScaleValue(o.y)}e+=(n-1)*this._spacingY+this._getPaddingV()}else e=this.node._uiProps.uiTransformComp.height;return e},n._doLayout=function(){var t=this;if(this._init&&!this._childrenDirty||(this._checkUsefulObj(),this._init=!0,this._childrenDirty=!1),this._layoutType===Rrt.HORIZONTAL){var e=this._getHorizontalBaseWidth();this._doLayoutHorizontally(e,!1,(function(e){return(t._isAlign?En.ZERO:e.position).y}),!0),this.node._uiProps.uiTransformComp.width=e}else if(this._layoutType===Rrt.VERTICAL){var n=this._getVerticalBaseHeight();this._doLayoutVertically(n,!1,(function(e){return(t._isAlign?En.ZERO:e.position).x}),!0),this.node._uiProps.uiTransformComp.height=n}else this._layoutType===Rrt.GRID&&this._doLayoutGrid()},n._getUsedScaleValue=function(t){return this._affectedByScale?Math.abs(t):1},n._transformDirty=function(t){t&Zg.SCALE&&t&Zg.POSITION&&this._affectedByScale&&this._doLayoutDirty()},n._doLayoutDirty=function(){this._layoutDirty=!0},n._childrenChanged=function(){this._childrenDirty=!0,this._doLayoutDirty()},n._getPaddingH=function(){return this._paddingLeft+this._paddingRight},n._getPaddingV=function(){return this._paddingTop+this._paddingBottom},n._getFixedBreakingNum=function(){if(this._layoutType!==Rrt.GRID||this._constraint===Nrt.NONE||this._constraintNum<=0)return 0;var t=this._constraint===Nrt.FIXED_ROW?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum;return this._startAxis===Brt.VERTICAL&&(t=this._constraint===Nrt.FIXED_COL?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum),t},K(e,[{key:"alignHorizontal",get:function(){return this._isAlign},set:function(t){this._layoutType===Rrt.HORIZONTAL&&(this._isAlign=t,this._doLayoutDirty())}},{key:"alignVertical",get:function(){return this._isAlign},set:function(t){this._layoutType===Rrt.VERTICAL&&(this._isAlign=t,this._doLayoutDirty())}},{key:"type",get:function(){return this._layoutType},set:function(t){this._layoutType=t,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(t){this._layoutType!==Rrt.NONE&&(this._resizeMode=t,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(t){this._cellSize!==t&&(this._cellSize.set(t),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(t){this._startAxis!==t&&(this._startAxis=t,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(t){this._paddingLeft!==t&&(this._paddingLeft=t,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(t){this._paddingRight!==t&&(this._paddingRight=t,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(t){this._paddingTop!==t&&(this._paddingTop=t,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(t){this._paddingBottom!==t&&(this._paddingBottom=t,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(t){this._spacingX!==t&&(this._spacingX=t,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(t){this._spacingY!==t&&(this._spacingY=t,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(t){this._verticalDirection!==t&&(this._verticalDirection=t,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(t){this._horizontalDirection!==t&&(this._horizontalDirection=t,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(t){this.paddingLeft===t&&this._paddingRight===t&&this._paddingTop===t&&this._paddingBottom===t||(this._paddingLeft=this._paddingRight=this._paddingTop=this._paddingBottom=t,this._doLayoutDirty())}},{key:"constraint",get:function(){return this._constraint},set:function(t){this._layoutType!==Rrt.NONE&&this._constraint!==t&&(this._constraint=t,this._doLayoutDirty())}},{key:"constraintNum",get:function(){return this._constraintNum},set:function(t){this._constraint!==Nrt.NONE&&this._constraintNum!==t&&(t<=0&&y("Limit values to be greater than 0"),this._constraintNum=t,this._doLayoutDirty())}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(t){this._affectedByScale=t,this._doLayoutDirty()}}]),e}(Ku),Prt.Type=Rrt,Prt.VerticalDirection=Mrt,Prt.HorizontalDirection=Ort,Prt.ResizeMode=Drt,Prt.AxisDirection=Brt,Prt.Constraint=Nrt,st((hrt=Irt).prototype,"alignHorizontal",[Oit,Nit],Object.getOwnPropertyDescriptor(hrt.prototype,"alignHorizontal"),hrt.prototype),st(hrt.prototype,"alignVertical",[Lit,Fit],Object.getOwnPropertyDescriptor(hrt.prototype,"alignVertical"),hrt.prototype),st(hrt.prototype,"type",[zit,Git,Vit],Object.getOwnPropertyDescriptor(hrt.prototype,"type"),hrt.prototype),st(hrt.prototype,"resizeMode",[Uit,kit,Hit],Object.getOwnPropertyDescriptor(hrt.prototype,"resizeMode"),hrt.prototype),st(hrt.prototype,"cellSize",[jit,Wit],Object.getOwnPropertyDescriptor(hrt.prototype,"cellSize"),hrt.prototype),st(hrt.prototype,"startAxis",[qit,Xit],Object.getOwnPropertyDescriptor(hrt.prototype,"startAxis"),hrt.prototype),st(hrt.prototype,"paddingLeft",[Yit],Object.getOwnPropertyDescriptor(hrt.prototype,"paddingLeft"),hrt.prototype),st(hrt.prototype,"paddingRight",[Kit],Object.getOwnPropertyDescriptor(hrt.prototype,"paddingRight"),hrt.prototype),st(hrt.prototype,"paddingTop",[Jit],Object.getOwnPropertyDescriptor(hrt.prototype,"paddingTop"),hrt.prototype),st(hrt.prototype,"paddingBottom",[Qit],Object.getOwnPropertyDescriptor(hrt.prototype,"paddingBottom"),hrt.prototype),st(hrt.prototype,"spacingX",[Zit],Object.getOwnPropertyDescriptor(hrt.prototype,"spacingX"),hrt.prototype),st(hrt.prototype,"spacingY",[$it],Object.getOwnPropertyDescriptor(hrt.prototype,"spacingY"),hrt.prototype),st(hrt.prototype,"verticalDirection",[trt,ert],Object.getOwnPropertyDescriptor(hrt.prototype,"verticalDirection"),hrt.prototype),st(hrt.prototype,"horizontalDirection",[nrt,irt],Object.getOwnPropertyDescriptor(hrt.prototype,"horizontalDirection"),hrt.prototype),st(hrt.prototype,"constraint",[rrt,ort,art],Object.getOwnPropertyDescriptor(hrt.prototype,"constraint"),hrt.prototype),st(hrt.prototype,"constraintNum",[srt,crt],Object.getOwnPropertyDescriptor(hrt.prototype,"constraintNum"),hrt.prototype),st(hrt.prototype,"affectedByScale",[lrt],Object.getOwnPropertyDescriptor(hrt.prototype,"affectedByScale"),hrt.prototype),_rt=st(hrt.prototype,"_resizeMode",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Drt.NONE}}),frt=st(hrt.prototype,"_layoutType",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rrt.NONE}}),prt=st(hrt.prototype,"_cellSize",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zn(40,40)}}),drt=st(hrt.prototype,"_startAxis",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Brt.HORIZONTAL}}),mrt=st(hrt.prototype,"_paddingLeft",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vrt=st(hrt.prototype,"_paddingRight",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),grt=st(hrt.prototype,"_paddingTop",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yrt=st(hrt.prototype,"_paddingBottom",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xrt=st(hrt.prototype,"_spacingX",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Srt=st(hrt.prototype,"_spacingY",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Crt=st(hrt.prototype,"_verticalDirection",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mrt.TOP_TO_BOTTOM}}),Art=st(hrt.prototype,"_horizontalDirection",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ort.LEFT_TO_RIGHT}}),brt=st(hrt.prototype,"_constraint",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Nrt.NONE}}),Trt=st(hrt.prototype,"_constraintNum",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),Ert=st(hrt.prototype,"_affectedByScale",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wrt=st(hrt.prototype,"_isAlign",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),urt=hrt))||urt)||urt)||urt)||urt)||urt)||urt));c.Layout=sot,function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL",t[t.FILLED=2]="FILLED"}(oot||(oot={})),ie(oot);var cot,lot,uot,hot,_ot,fot,pot,dot,mot,vot,got,yot,xot,Sot,Cot,Aot,bot,Tot,Eot,wot,Pot,Iot,Rot,Dot,Bot=function(e){return t({ProgressBar:e,ProgressBarComponent:e}),e}((Frt=hc("cc.ProgressBar"),zrt=wc(),Grt=fc(110),Vrt=Ac(),Urt=_c(RH),krt=Wc(iY),Hrt=Bc(),jrt=Wc(oot),Wrt=Bc(),qrt=Bc(),Xrt=Mc(),Yrt=Bc(),Krt=Bc(),Frt(Jrt=zrt(Jrt=Grt(Jrt=Vrt(Jrt=Urt((rot=iot=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_barSprite",Zrt,it(e)),at(e,"_mode",$rt,it(e)),at(e,"_totalLength",tot,it(e)),at(e,"_progress",eot,it(e)),at(e,"_reverse",not,it(e)),e}Q(e,t);var n=e.prototype;return n._initBarSprite=function(){if(this._barSprite){var t=this._barSprite.node;if(!t)return;var e=this.node._uiProps.uiTransformComp,n=e.contentSize,i=e.anchorPoint,r=t._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===iY.FillType.RADIAL&&(this._mode=oot.FILLED),this._mode===oot.HORIZONTAL?this.totalLength=r.width:this._mode===oot.VERTICAL?this.totalLength=r.height:this.totalLength=this._barSprite.fillRange,t.parent===this.node){var o=-n.width*i.x;t.setPosition(o,0,0)}}},n._updateBarStatus=function(){if(this._barSprite){var t=this._barSprite.node;if(!t)return;var e=t._uiProps.uiTransformComp,n=e.anchorPoint,i=e.contentSize,r=t.getPosition(),o=new Wn(0,.5),a=an(this._progress),s=this._totalLength*a,c=i,l=0,u=0;switch(this._mode){case oot.HORIZONTAL:this._reverse&&(o=new Wn(1,.5)),c=new Zn(s,i.height),l=this._totalLength,u=i.height;break;case oot.VERTICAL:o=this._reverse?new Wn(.5,1):new Wn(.5,0),c=new Zn(i.width,s),l=i.width,u=this._totalLength}if(this._mode===oot.FILLED)this._barSprite.type!==iY.Type.FILLED?y("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(s*=-1),this._barSprite.fillRange=s);else if(this._barSprite.type!==iY.Type.FILLED){var h=o.x-n.x,_=o.y-n.y,f=new En(l*h,u*_,0);t.setPosition(r.x+f.x,r.y+f.y,r.z),e.setAnchorPoint(o),e.setContentSize(c)}else y("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}},K(e,[{key:"barSprite",get:function(){return this._barSprite},set:function(t){this._barSprite!==t&&(this._barSprite=t,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(t){if(this._mode!==t&&(this._mode=t,this._barSprite)){var e=this._barSprite.node;if(!e)return;var n=e._uiProps.uiTransformComp.contentSize;this._mode===oot.HORIZONTAL?this.totalLength=n.width:this._mode===oot.VERTICAL?this.totalLength=n.height:this._mode===oot.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(t){this._mode===oot.FILLED&&(t=an(t)),this._totalLength=t,this._updateBarStatus()}},{key:"progress",get:function(){return this._progress},set:function(t){this._progress!==t&&(this._progress=t,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(t){this._reverse!==t&&(this._reverse=t,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}}]),e}(Ku),iot.Mode=oot,st((Qrt=rot).prototype,"barSprite",[krt,Hrt],Object.getOwnPropertyDescriptor(Qrt.prototype,"barSprite"),Qrt.prototype),st(Qrt.prototype,"mode",[jrt,Wrt],Object.getOwnPropertyDescriptor(Qrt.prototype,"mode"),Qrt.prototype),st(Qrt.prototype,"totalLength",[qrt],Object.getOwnPropertyDescriptor(Qrt.prototype,"totalLength"),Qrt.prototype),st(Qrt.prototype,"progress",[Xrt,Fc,Yrt],Object.getOwnPropertyDescriptor(Qrt.prototype,"progress"),Qrt.prototype),st(Qrt.prototype,"reverse",[Krt],Object.getOwnPropertyDescriptor(Qrt.prototype,"reverse"),Qrt.prototype),Zrt=st(Qrt.prototype,"_barSprite",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$rt=st(Qrt.prototype,"_mode",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return oot.HORIZONTAL}}),tot=st(Qrt.prototype,"_totalLength",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),eot=st(Qrt.prototype,"_progress",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),not=st(Qrt.prototype,"_reverse",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Jrt=Qrt))||Jrt)||Jrt)||Jrt)||Jrt)||Jrt));c.ProgressBar=Bot;var Mot,Oot=new En,Not=new En,Lot=new En,Fot=new Wn,zot=new bn,Got=new Wn;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(Mot||(Mot={})),ae(Mot);var Vot,Uot=function(e){return t({ScrollBar:e,ScrollBarComponent:e}),e}((cot=hc("cc.ScrollBar"),lot=wc(),uot=fc(110),hot=Ac(),_ot=_c(RH),fot=Wc(iY),pot=zc(),dot=Bc(),mot=Wc(Mot),vot=zc(),got=Bc(),yot=zc(),xot=Bc(),Sot=zc(),Cot=Bc(),cot(Aot=lot(Aot=uot(Aot=hot(Aot=_ot((Dot=Rot=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_scrollView",Tot,it(e)),at(e,"_handle",Eot,it(e)),at(e,"_direction",wot,it(e)),at(e,"_enableAutoHide",Pot,it(e)),at(e,"_autoHideTime",Iot,it(e)),e._touching=!1,e._opacity=255,e._autoHideRemainingTime=0,e}Q(e,t);var n=e.prototype;return n.hide=function(){this._autoHideRemainingTime=0,this._setOpacity(0)},n.show=function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)},n.onScroll=function(t){if(this._scrollView){var e=this._scrollView.content;if(e){var n=e._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize,r=this.node._uiProps.uiTransformComp.contentSize;if(!this._conditionalDisableScrollBar(n,i)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var o=0,a=0,s=0,c=0,l=0,u=Got;u.set(0,0),this._direction===Mot.HORIZONTAL?(o=n.width,a=i.width,l=r.width,s=t.x,this._convertToScrollViewSpace(u,e),c=-u.x):this._direction===Mot.VERTICAL&&(o=n.height,a=i.height,l=r.height,s=t.y,this._convertToScrollViewSpace(u,e),c=-u.y);var h=this._calculateLength(o,a,l,s),_=Got;this._calculatePosition(_,o,a,l,c,s,h),this._updateLength(h),this._updateHandlerPosition(_)}}}},n.setScrollView=function(t){this._scrollView=t},n.onTouchBegan=function(){this._enableAutoHide&&(this._touching=!0)},n.onTouchEnded=function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var t=this._scrollView.content;if(t){var e=t._uiProps.uiTransformComp.contentSize,n=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(e,n))return}}this._autoHideRemainingTime=this._autoHideTime}},n.onEnable=function(){var t=this.node.getComponent(iY);t&&(this._opacity=t.color.a)},n.start=function(){this._enableAutoHide&&this._setOpacity(0)},n.update=function(t){this._processAutoHide(t)},n._convertToScrollViewSpace=function(t,e){var n=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,i=e._uiProps.uiTransformComp;if(n&&i){Oot.set(-i.anchorX*i.width,-i.anchorY*i.height,0),i.convertToWorldSpaceAR(Oot,Not);var r=n.convertToNodeSpaceAR(Not);r.x+=n.anchorX*n.width,r.y+=n.anchorY*n.height,t.set(r.x,r.y)}else t.set(Wn.ZERO)},n._setOpacity=function(t){if(this._handle){var e=this.node.getComponent(iY);e&&(zot.set(e.color),zot.a=t,e.color=zot),(e=this._handle.getComponent(iY))&&(zot.set(e.color),zot.a=t,e.color=zot)}},n._updateHandlerPosition=function(t){if(this._handle){var e=Lot;this._fixupHandlerPosition(e),this._handle.node.setPosition(t.x+e.x,t.y+e.y,e.z)}},n._fixupHandlerPosition=function(t){var e=this.node._uiProps.uiTransformComp,n=e.contentSize,i=e.anchorPoint,r=this.handle.node._uiProps.uiTransformComp.contentSize,o=this.handle.node.parent;En.set(Oot,-n.width*i.x,-n.height*i.y,0);var a=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(Oot,Not),s=t;s.set(0,0,0),o._uiProps.uiTransformComp.convertToNodeSpaceAR(a,s),this.direction===Mot.HORIZONTAL?s.set(s.x,s.y+(n.height-r.height)/2,s.z):this.direction===Mot.VERTICAL&&s.set(s.x+(n.width-r.width)/2,s.y,s.z),this.handle.node.setPosition(s)},n._conditionalDisableScrollBar=function(t,e){return t.width<=e.width&&this._direction===Mot.HORIZONTAL||t.height<=e.height&&this._direction===Mot.VERTICAL},n._calculateLength=function(t,e,n,i){var r=t;return i&&(r+=20*(i>0?i:-i)),n*(e/r)},n._calculatePosition=function(t,e,n,i,r,o,a){var s=e-n;o&&(s+=Math.abs(o));var c=0;s&&(c=an(c=r/s));var l=(i-a)*c;this._direction===Mot.VERTICAL?t.set(0,l):t.set(l,0)},n._updateLength=function(t){if(this._handle){var e=this._handle.node._uiProps.uiTransformComp,n=e.contentSize,i=e.anchorPoint;i.x===Fot.x&&i.y===Fot.y||e.setAnchorPoint(Fot),this._direction===Mot.HORIZONTAL?e.setContentSize(t,n.height):e.setContentSize(n.width,t)}},n._processAutoHide=function(t){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=t,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var e=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(e)}},K(e,[{key:"handle",get:function(){return this._handle},set:function(t){this._handle!==t&&(this._handle=t,this.onScroll(Wn.ZERO))}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(this._direction=t,this.onScroll(Wn.ZERO))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(t){this._enableAutoHide!==t&&(this._enableAutoHide=t,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(t){this._autoHideTime!==t&&(this._autoHideTime=t)}}]),e}(Ku),Rot.Direction=Mot,st((bot=Dot).prototype,"handle",[fot,pot,dot],Object.getOwnPropertyDescriptor(bot.prototype,"handle"),bot.prototype),st(bot.prototype,"direction",[mot,vot,got],Object.getOwnPropertyDescriptor(bot.prototype,"direction"),bot.prototype),st(bot.prototype,"enableAutoHide",[yot,xot],Object.getOwnPropertyDescriptor(bot.prototype,"enableAutoHide"),bot.prototype),st(bot.prototype,"autoHideTime",[Sot,Cot],Object.getOwnPropertyDescriptor(bot.prototype,"autoHideTime"),bot.prototype),Tot=st(bot.prototype,"_scrollView",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Eot=st(bot.prototype,"_handle",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wot=st(bot.prototype,"_direction",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mot.HORIZONTAL}}),Pot=st(bot.prototype,"_enableAutoHide",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Iot=st(bot.prototype,"_autoHideTime",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Aot=bot))||Aot)||Aot)||Aot)||Aot)||Aot));c.ScrollBar=Uot;var kot,Hot,jot,Wot,qot,Xot,Yot,Kot,Jot,Qot,Zot,$ot,tat,eat,nat,iat,rat,oat,aat,sat,cat,lat,uat,hat,_at,fat,pat,dat,mat,vat,gat,yat,xat,Sat,Cat,Aat,bat,Tat,Eat,wat,Pat,Iat,Rat,Dat,Bat,Mat,Oat,Nat,Lat=t("ViewGroup",hc("cc.ViewGroup")(Vot=fc(110)(Vot=function(t){function e(){return t.apply(this,arguments)||this}return Q(e,t),e}(Ku))||Vot)||Vot);c.ViewGroup=Lat;var Fat,zat=1e-4,Gat=new En,Vat=new En,Uat=new Wn,kat=new Wn,Hat=function(){return(new Date).getMilliseconds()},jat={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};!function(t){t.SCROLL_TO_TOP="scroll-to-top",t.SCROLL_TO_BOTTOM="scroll-to-bottom",t.SCROLL_TO_LEFT="scroll-to-left",t.SCROLL_TO_RIGHT="scroll-to-right",t.SCROLL_BEGAN="scroll-began",t.SCROLL_ENDED="scroll-ended",t.BOUNCE_TOP="bounce-top",t.BOUNCE_BOTTOM="bounce-bottom",t.BOUNCE_LEFT="bounce-left",t.BOUNCE_RIGHT="bounce-right",t.SCROLLING="scrolling",t.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",t.TOUCH_UP="touch-up"}(Fat||(Fat={}));var Wat,qat,Xat,Yat,Kat,Jat,Qat,Zat,$at,tst,est,nst,ist,rst,ost,ast,sst,cst,lst,ust,hst,_st=function(e){return t({ScrollView:e,ScrollViewComponent:e}),e}((kot=hc("cc.ScrollView"),Hot=wc(),jot=fc(110),Wot=Ac(),qot=_c(RH),Xot=Mc(),Yot=zc(),Kot=Bc(),Jot=Mc(),Qot=zc(),Zot=Bc(),$ot=zc(),tat=Bc(),eat=zc(),nat=Bc(),iat=Wc(GT),rat=zc(),oat=Bc(),aat=zc(),sat=Bc(),cat=Wc(Uot),lat=zc(),uat=Bc(),hat=zc(),_at=Bc(),fat=Wc(Uot),pat=zc(),dat=Bc(),mat=zc(),vat=Bc(),gat=Wc([ML]),yat=zc(),xat=Bc(),kot(Sat=Hot(Sat=jot(Sat=Wot(Sat=qot((Nat=Oat=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"bounceDuration",Aat,it(e)),at(e,"brake",bat,it(e)),at(e,"elastic",Tat,it(e)),at(e,"inertia",Eat,it(e)),at(e,"horizontal",wat,it(e)),at(e,"vertical",Pat,it(e)),at(e,"cancelInnerEvents",Iat,it(e)),at(e,"scrollEvents",Rat,it(e)),e._autoScrolling=!1,e._scrolling=!1,at(e,"_content",Dat,it(e)),at(e,"_horizontalScrollBar",Bat,it(e)),at(e,"_verticalScrollBar",Mat,it(e)),e._topBoundary=0,e._bottomBoundary=0,e._leftBoundary=0,e._rightBoundary=0,e._touchMoveDisplacements=[],e._touchMoveTimeDeltas=[],e._touchMovePreviousTimestamp=0,e._touchMoved=!1,e._autoScrollAttenuate=!1,e._autoScrollStartPosition=new En,e._autoScrollTargetDelta=new En,e._autoScrollTotalTime=0,e._autoScrollAccumulatedTime=0,e._autoScrollCurrentlyOutOfBoundary=!1,e._autoScrollBraking=!1,e._autoScrollBrakingStartPosition=new En,e._outOfBoundaryAmount=new En,e._outOfBoundaryAmountDirty=!0,e._stopMouseWheel=!1,e._mouseWheelEventElapsedTime=0,e._isScrollEndedWithThresholdEventFired=!1,e._scrollEventEmitMask=0,e._isBouncing=!1,e._contentPos=new En,e._deltaPos=new En,e}Q(e,t);var n=e.prototype;return n.scrollToBottom=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Wn(0,0),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n,!0)},n.scrollToTop=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Wn(0,1),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToLeft=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Wn(0,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToRight=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Wn(1,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToTopLeft=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Wn(0,1),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToTopRight=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Wn(1,1),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToBottomLeft=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Wn(0,0),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToBottomRight=function(t,e){void 0===e&&(e=!0);var n=this._calculateMovePercentDelta({anchor:new Wn(1,0),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)},n.scrollToOffset=function(t,e,n){void 0===n&&(n=!0);var i=this.getMaxScrollOffset(),r=new Wn(0,0);0===i.x?r.x=0:r.x=t.x/i.x,0===i.y?r.y=1:r.y=(i.y-t.y)/i.y,this.scrollTo(r,e,n)},n.getScrollOffset=function(){var t=this._getContentTopBoundary()-this._topBoundary,e=this._getContentLeftBoundary()-this._leftBoundary;return new Wn(e,t)},n.getMaxScrollOffset=function(){if(!this._content||!this.view)return Wn.ZERO;var t=this._content._uiProps.uiTransformComp.contentSize,e=t.width-this.view.width,n=t.height-this.view.height;return new Wn(e=e>=0?e:0,n=n>=0?n:0)},n.scrollToPercentHorizontal=function(t,e,n){var i=this._calculateMovePercentDelta({anchor:new Wn(t,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==n):this._moveContent(i)},n.scrollTo=function(t,e,n){var i=this._calculateMovePercentDelta({anchor:new Wn(t),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,n):this._moveContent(i)},n.scrollToPercentVertical=function(t,e,n){var i=this._calculateMovePercentDelta({anchor:new Wn(0,t),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,n):this._moveContent(i)},n.stopAutoScroll=function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime},n.setContentPosition=function(t){this._setContentPosition(t)},n._setContentPosition=function(t){if(this._content){var e=this._getContentPosition();Math.abs(t.x-e.x)<zat&&Math.abs(t.y-e.y)<zat||(this._content.setPosition(t),this._outOfBoundaryAmountDirty=!0)}},n.getContentPosition=function(){return this._getContentPosition()},n._getContentPosition=function(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):En.ZERO.clone()},n.isScrolling=function(){return this._scrolling},n.isAutoScrolling=function(){return this._autoScrolling},n.getScrollEndedEventTiming=function(){return zat},n.start=function(){this._calculateBoundary(),this._content&&zM.once(FM.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)},n.onEnable=function(){this._registerEvent(),this._content&&(this._content.on(FA.SIZE_CHANGED,this._calculateBoundary,this),this._content.on(FA.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on(FA.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on(FA.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()},n.update=function(t){this._autoScrolling&&this._processAutoScrolling(t)},n.onDisable=function(){this._unregisterEvent(),this._content&&(this._content.off(FA.SIZE_CHANGED,this._calculateBoundary,this),this._content.off(FA.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off(FA.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off(FA.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()},n._registerEvent=function(){this.node.on(FA.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(FA.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(FA.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(FA.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(FA.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._unregisterEvent=function(){this.node.off(FA.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(FA.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(FA.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(FA.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(FA.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._onMouseWheel=function(t,e){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(t,e)){var n=new En,i=t.getScrollY();this.vertical?n.set(0,-.1*i,0):this.horizontal&&n.set(-.1*i,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(n),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(t)}},n._onTouchBegan=function(t,e){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(t,e)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(t)))},n._onTouchMoved=function(t,e){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(t,e)){var n=t.touch;if(this._handleMoveLogic(n),this.cancelInnerEvents){var i=n.getUILocation(Uat);if(i.subtract(n.getUIStartLocation(kat)),i.length()>7&&!this._touchMoved&&t.target!==this.node){var r=new kR(t.getTouches(),t.bubbles,OE.TOUCH_CANCEL);r.touch=t.touch,r.simulate=!0,t.target.dispatchEvent(r),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(t)}}},n._onTouchEnded=function(t,e){if(this.enabledInHierarchy&&this._content&&t&&!this._hasNestedViewGroup(t,e)){this._dispatchEvent(Fat.TOUCH_UP);var n=t.touch;this._handleReleaseLogic(n),this._touchMoved?t.propagationStopped=!0:this._stopPropagationIfTargetIsMe(t)}},n._onTouchCancelled=function(t,e){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(t,e)){if(t&&!t.simulate){var n=t.touch;this._handleReleaseLogic(n)}this._stopPropagationIfTargetIsMe(t)}},n._calculateBoundary=function(){if(this._content&&this.view){var t=this._content.getComponent(sot);t&&t.enabledInHierarchy&&t.updateLayout();var e=this.view,n=e.width*e.anchorX,i=e.height*e.anchorY;this._leftBoundary=-n,this._bottomBoundary=-i,this._rightBoundary=this._leftBoundary+e.width,this._topBoundary=this._bottomBoundary+e.height,this._moveContentToTopLeft(e.contentSize)}},n._hasNestedViewGroup=function(t,e){if(!t||t.eventPhase!==FR.CAPTURING_PHASE)return!1;if(e)for(var n,i=ot(e);!(n=i()).done;){var r=n.value;if(this.node===r)return!(!t.target||!t.target.getComponent(Lat));if(r.getComponent(Lat))return!0}return!1},n._startInertiaScroll=function(t){var e=new En(t);e.multiplyScalar(.7),this._startAttenuatingAutoScroll(e,t)},n._calculateAttenuatedFactor=function(t){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*t+t*t*8e-9))},n._startAttenuatingAutoScroll=function(t,e){var n=t.clone();if(n.normalize(),this._content&&this.view){var i=this._content._uiProps.uiTransformComp.contentSize,r=this.view.contentSize,o=i.width-r.width,a=i.height-r.height,s=this._calculateAttenuatedFactor(o),c=this._calculateAttenuatedFactor(a);n.x=n.x*o*(1-this.brake)*s,n.y=n.y*a*c*(1-this.brake),n.z=0}var l=t.length(),u=n.length()/l;if(n.add(t),this.brake>0&&u>7){u=Math.sqrt(u);var h=t.clone();h.multiplyScalar(u),n.set(h),n.add(t)}var _=this._calculateAutoScrollTimeByInitialSpeed(e.length());this.brake>0&&u>3&&(_*=u=3),0===this.brake&&u>1&&(_*=u),this._startAutoScroll(n,_,!0)},n._calculateAutoScrollTimeByInitialSpeed=function(t){return Math.sqrt(Math.sqrt(t/5))},n._startAutoScroll=function(t,e,n){void 0===n&&(n=!1);var i=this._flattenVectorByDirection(t);this._autoScrolling=!0,this._autoScrollTargetDelta=i,this._autoScrollAttenuate=n,En.copy(this._autoScrollStartPosition,this._getContentPosition()),this._autoScrollTotalTime=e,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition.set(0,0,0),this._getHowMuchOutOfBoundary().equals(En.ZERO,zat)||(this._autoScrollCurrentlyOutOfBoundary=!0)},n._calculateTouchMoveVelocity=function(){var t=new En,e=0;if((e=this._touchMoveTimeDeltas.reduce((function(t,e){return t+e}),e))<=0||e>=.5)t.set(En.ZERO);else{var n=new En;n=this._touchMoveDisplacements.reduce((function(t,e){return t.add(e),t}),n),t.set(n.x*(1-this.brake)/e,n.y*(1-this.brake)/e,n.z)}return t},n._flattenVectorByDirection=function(t){var e=t;return e.x=this.horizontal?e.x:0,e.y=this.vertical?e.y:0,e},n._moveContent=function(t,e){var n=this._flattenVectorByDirection(t);Gat.set(this._getContentPosition()),Gat.add(n),Gat.set(Math.round(1e4*Gat.x)*zat,Math.round(1e4*Gat.y)*zat,Gat.z),this._setContentPosition(Gat);var i=this._getHowMuchOutOfBoundary();Uat.set(i.x,i.y),this._updateScrollBar(Uat),this.elastic&&e&&this._startBounceBackIfNeeded()},n._getContentLeftBoundary=function(){if(!this._content)return-1;var t=this._getContentPosition(),e=this._content._uiProps.uiTransformComp;return t.x-e.anchorX*e.width},n._getContentRightBoundary=function(){if(!this._content)return-1;var t=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+t.width},n._getContentTopBoundary=function(){if(!this._content)return-1;var t=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+t.height},n._getContentBottomBoundary=function(){if(!this._content)return-1;var t=this._getContentPosition(),e=this._content._uiProps.uiTransformComp;return t.y-e.anchorY*e.height},n._getHowMuchOutOfBoundary=function(t){if((t=t||new En).equals(En.ZERO,zat)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var e=new En,n=this._getContentLeftBoundary(),i=this._getContentRightBoundary();n+t.x>this._leftBoundary?e.x=this._leftBoundary-(n+t.x):i+t.x<this._rightBoundary&&(e.x=this._rightBoundary-(i+t.x));var r=this._getContentTopBoundary(),o=this._getContentBottomBoundary();return r+t.y<this._topBoundary?e.y=this._topBoundary-(r+t.y):o+t.y>this._bottomBoundary&&(e.y=this._bottomBoundary-(o+t.y)),t.equals(En.ZERO,zat)&&(this._outOfBoundaryAmount=e,this._outOfBoundaryAmountDirty=!1),this._clampDelta(e),e},n._updateScrollBar=function(t){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(t),this.verticalScrollBar&&this.verticalScrollBar.onScroll(t)},n._onScrollBarTouchBegan=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()},n._onScrollBarTouchEnded=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()},n._dispatchEvent=function(t){if(t===Fat.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(t===Fat.SCROLL_TO_TOP||t===Fat.SCROLL_TO_BOTTOM||t===Fat.SCROLL_TO_LEFT||t===Fat.SCROLL_TO_RIGHT){var e=1<<jat[t];if(this._scrollEventEmitMask&e)return;this._scrollEventEmitMask|=e}ML.emitEvents(this.scrollEvents,this,jat[t]),this.node.emit(t,this)},n._adjustContentOutOfBoundary=function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var t=this._getHowMuchOutOfBoundary();Gat.set(this._getContentPosition()),Gat.add(t),this._content.setPosition(Gat),this._updateScrollBar(Wn.ZERO)}},n._hideScrollBar=function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()},n._updateScrollBarState=function(){if(this._content&&this.view){var t=this.view,e=this._content._uiProps.uiTransformComp;this.verticalScrollBar&&(e.height<t.height?this.verticalScrollBar.hide():this.verticalScrollBar.show()),this.horizontalScrollBar&&(e.width<t.width?this.horizontalScrollBar.hide():this.horizontalScrollBar.show())}},n._stopPropagationIfTargetIsMe=function(t){t.eventPhase===FR.AT_TARGET&&t.target===this.node&&(t.propagationStopped=!0)},n._processDeltaMove=function(t){this._scrollChildren(t),this._gatherTouchMove(t)},n._handleMoveLogic=function(t){this._getLocalAxisAlignDelta(this._deltaPos,t),this._processDeltaMove(this._deltaPos)},n._handleReleaseLogic=function(t){this._getLocalAxisAlignDelta(this._deltaPos,t),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(Fat.SCROLL_ENDED))},n._getLocalAxisAlignDelta=function(t,e){var n=this.node._uiProps.uiTransformComp,i=new En;n&&(e.getUILocation(Uat),e.getUIPreviousLocation(kat),Gat.set(Uat.x,Uat.y,0),Vat.set(kat.x,kat.y,0),n.convertToNodeSpaceAR(Gat,Gat),n.convertToNodeSpaceAR(Vat,Vat),En.subtract(i,Gat,Vat)),t.set(i)},n._scrollChildren=function(t){this._clampDelta(t);var e,n=t;this.elastic&&(e=this._getHowMuchOutOfBoundary(),n.x*=0===e.x?1:.5,n.y*=0===e.y?1:.5),this.elastic||(e=this._getHowMuchOutOfBoundary(n),n.add(e));var i="",r="";if(this._content){var o=this._content._uiProps.uiTransformComp,a=o.anchorX,s=o.anchorY,c=o.width,l=o.height,u=this._content.position||En.ZERO;this.vertical&&(n.y>0?u.y-s*l+n.y>=this._bottomBoundary&&(i=Fat.SCROLL_TO_BOTTOM):n.y<0&&u.y-s*l+l+n.y<=this._topBoundary&&(i=Fat.SCROLL_TO_TOP)),this.horizontal&&(n.x<0?u.x-a*c+c+n.x<=this._rightBoundary&&(r=Fat.SCROLL_TO_RIGHT):n.x>0&&u.x-a*c+n.x>=this._leftBoundary&&(r=Fat.SCROLL_TO_LEFT))}this._moveContent(n,!1),(this.horizontal&&0!==n.x||this.vertical&&0!==n.y)&&(this._scrolling||(this._scrolling=!0,this._dispatchEvent(Fat.SCROLL_BEGAN)),this._dispatchEvent(Fat.SCROLLING)),""!==i&&this._dispatchEvent(i),""!==r&&this._dispatchEvent(r)},n._handlePressLogic=function(){this._autoScrolling&&this._dispatchEvent(Fat.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=Hat(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()},n._clampDelta=function(t){if(this._content&&this.view){var e=this.view.contentSize,n=this._content._uiProps.uiTransformComp;n.width<e.width&&(t.x=0),n.height<e.height&&(t.y=0)}},n._gatherTouchMove=function(t){var e=t.clone();for(this._clampDelta(e);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(e);var n=Hat();this._touchMoveTimeDeltas.push((n-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=n},n._startBounceBackIfNeeded=function(){if(!this.elastic)return!1;var t=this._getHowMuchOutOfBoundary();if(this._clampDelta(t),t.equals(En.ZERO,zat))return!1;var e=Math.max(this.bounceDuration,0);return this._startAutoScroll(t,e,!0),this._isBouncing||(t.y>0&&this._dispatchEvent(Fat.BOUNCE_TOP),t.y<0&&this._dispatchEvent(Fat.BOUNCE_BOTTOM),t.x>0&&this._dispatchEvent(Fat.BOUNCE_RIGHT),t.x<0&&this._dispatchEvent(Fat.BOUNCE_LEFT),this._isBouncing=!0),!0},n._processInertiaScroll=function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var t=this._calculateTouchMoveVelocity();!t.equals(Gat,zat)&&this.brake<1&&this._startInertiaScroll(t)}this._onScrollBarTouchEnded()},n._isOutOfBoundary=function(){return!this._getHowMuchOutOfBoundary().equals(En.ZERO,zat)},n._isNecessaryAutoScrollBrake=function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this._getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1},n._processAutoScrolling=function(t){var e=this._isNecessaryAutoScrollBrake(),n=e?.05:1;this._autoScrollAccumulatedTime+=t*(1/n);var i,r=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(i=r,r=(i-=1)*i*i*i*i+1);var o=this._autoScrollTargetDelta.clone();o.multiplyScalar(r);var a=this._autoScrollStartPosition.clone();a.add(o);var s=Math.abs(r-1)<=zat;if(Math.abs(r-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(Fat.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var c=a.clone();c.subtract(this._autoScrollBrakingStartPosition),e&&c.multiplyScalar(n),a.set(this._autoScrollBrakingStartPosition),a.add(c)}else{var l=a.clone();l.subtract(this.getContentPosition());var u=this._getHowMuchOutOfBoundary(l);u.equals(En.ZERO,zat)||(a.add(u),s=!0)}s&&(this._autoScrolling=!1);var h=a.clone();h.subtract(this._getContentPosition()),this._clampDelta(h),this._moveContent(h,s),this._dispatchEvent(Fat.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(Fat.SCROLL_ENDED))},n._checkMouseWheel=function(t){if(!this._getHowMuchOutOfBoundary().equals(En.ZERO,zat))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(Fat.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=t,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(Fat.SCROLL_ENDED),this._stopMouseWheel=!1)},n._calculateMovePercentDelta=function(t){var e=t.anchor,n=t.applyToHorizontal,i=t.applyToVertical;this._calculateBoundary(),e.clampf(Wn.ZERO,Wn.ONE);var r=this._getContentBottomBoundary()-this._bottomBoundary;r=-r;var o=this._getContentLeftBoundary()-this._leftBoundary;o=-o;var a=new En;if(this._content&&this.view){var s=0,c=this._content._uiProps.uiTransformComp.contentSize,l=this.view.contentSize;n&&(s=c.width-l.width,a.x=o-s*e.x),i&&(s=c.height-l.height,a.y=r-s*e.y)}return a},n._moveContentToTopLeft=function(t){var e=this._getContentBottomBoundary()-this._bottomBoundary;e=-e;var n=new En,i=0,r=this._getContentLeftBoundary()-this._leftBoundary;if(r=-r,this._content){var o=this._content._uiProps.uiTransformComp.contentSize;o.height<t.height&&(i=o.height-t.height,n.y=e-i),o.width<t.width&&(i=o.width-t.width,n.x=r)}this._updateScrollBarState(),this._moveContent(n),this._adjustContentOutOfBoundary()},n._scaleChanged=function(t){t===Zg.SCALE&&this._calculateBoundary()},K(e,[{key:"content",get:function(){return this._content},set:function(t){if(this._content!==t){var e=t&&t.parent&&t.parent._uiProps.uiTransformComp;!t||t&&e?(this._content=t,this._calculateBoundary()):w(4302)}}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(t){this._horizontalScrollBar!==t&&(this._horizontalScrollBar=t,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(Wn.ZERO)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(t){this._verticalScrollBar!==t&&(this._verticalScrollBar=t,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(Wn.ZERO)))}},{key:"view",get:function(){var t=this._content&&this._content.parent;return t?t._uiProps.uiTransformComp:null}}]),e}(Lat),Oat.EventType=Fat,Aat=st((Cat=Nat).prototype,"bounceDuration",[vc,Xot,Yot,Kot],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),bat=st(Cat.prototype,"brake",[vc,Jot,Qot,Zot],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Tat=st(Cat.prototype,"elastic",[vc,$ot,tat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Eat=st(Cat.prototype,"inertia",[vc,eat,nat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),st(Cat.prototype,"content",[iat,rat,oat],Object.getOwnPropertyDescriptor(Cat.prototype,"content"),Cat.prototype),wat=st(Cat.prototype,"horizontal",[vc,aat,sat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),st(Cat.prototype,"horizontalScrollBar",[cat,lat,uat],Object.getOwnPropertyDescriptor(Cat.prototype,"horizontalScrollBar"),Cat.prototype),Pat=st(Cat.prototype,"vertical",[vc,hat,_at],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),st(Cat.prototype,"verticalScrollBar",[fat,pat,dat],Object.getOwnPropertyDescriptor(Cat.prototype,"verticalScrollBar"),Cat.prototype),Iat=st(Cat.prototype,"cancelInnerEvents",[vc,mat,vat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Rat=st(Cat.prototype,"scrollEvents",[gat,vc,yat,xat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Dat=st(Cat.prototype,"_content",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Bat=st(Cat.prototype,"_horizontalScrollBar",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Mat=st(Cat.prototype,"_verticalScrollBar",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Sat=Cat))||Sat)||Sat)||Sat)||Sat)||Sat));c.ScrollView=_st;var fst,pst=new En;!function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(fst||(fst={})),ae(fst);var dst,mst,vst,gst,yst,xst,Sst,Cst,Ast,bst,Tst,Est,wst,Pst,Ist,Rst,Dst,Bst,Mst,Ost,Nst=function(e){return t({Slider:e,SliderComponent:e}),e}((Wat=hc("cc.Slider"),qat=wc(),Xat=fc(110),Yat=Ac(),Kat=_c(RH),Jat=Wc(iY),Qat=Bc(),Zat=Wc(fst),$at=Bc(),tst=Mc(),est=Bc(),nst=Wc([ML]),ist=Bc(),Wat(rst=qat(rst=Xat(rst=Yat(rst=Kat((hst=ust=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"slideEvents",ast,it(e)),at(e,"_handle",sst,it(e)),at(e,"_direction",cst,it(e)),at(e,"_progress",lst,it(e)),e._offset=new En,e._dragging=!1,e._touchHandle=!1,e._handleLocalPos=new En,e._touchPos=new En,e}Q(e,t);var n=e.prototype;return n.__preload=function(){this._updateHandlePosition()},n.onEnable=function(){this._updateHandlePosition(),this.node.on(FA.TOUCH_START,this._onTouchBegan,this),this.node.on(FA.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(FA.TOUCH_END,this._onTouchEnded,this),this.node.on(FA.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(FA.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(FA.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(FA.TOUCH_END,this._onTouchEnded,this))},n.onDisable=function(){this.node.off(FA.TOUCH_START,this._onTouchBegan,this),this.node.off(FA.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(FA.TOUCH_END,this._onTouchEnded,this),this.node.off(FA.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(FA.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(FA.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(FA.TOUCH_END,this._onTouchEnded,this))},n._onHandleDragStart=function(t){if(t&&this._handle&&this._handle.node._uiProps.uiTransformComp){this._dragging=!0,this._touchHandle=!0;var e=t.touch.getUILocation();En.set(this._touchPos,e.x,e.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),t.propagationStopped=!0}},n._onTouchBegan=function(t){this._handle&&t&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(t.touch),t.propagationStopped=!0)},n._onTouchMoved=function(t){this._dragging&&t&&(this._handleSliderLogic(t.touch),t.propagationStopped=!0)},n._onTouchEnded=function(t){this._dragging=!1,this._touchHandle=!1,this._offset=new En,t&&(t.propagationStopped=!0)},n._onTouchCancelled=function(t){this._dragging=!1,t&&(t.propagationStopped=!0)},n._handleSliderLogic=function(t){this._updateProgress(t),this._emitSlideEvent()},n._emitSlideEvent=function(){ML.emitEvents(this.slideEvents,this),this.node.emit("slide",this)},n._updateProgress=function(t){if(this._handle&&t){var e=t.getUILocation();En.set(this._touchPos,e.x,e.y,0);var n=this.node._uiProps.uiTransformComp,i=n.convertToNodeSpaceAR(this._touchPos,pst);this.direction===fst.Horizontal?this.progress=an(.5+(i.x-this._offset.x)/n.width):this.progress=an(.5+(i.y-this._offset.y)/n.height)}},n._updateHandlePosition=function(){if(this._handle){this._handleLocalPos.set(this._handle.node.getPosition());var t=this.node._uiProps.uiTransformComp;this._direction===fst.Horizontal?this._handleLocalPos.x=-t.width*t.anchorX+this.progress*t.width:this._handleLocalPos.y=-t.height*t.anchorY+this.progress*t.height,this._handle.node.setPosition(this._handleLocalPos)}},n._changeLayout=function(){var t=this.node._uiProps.uiTransformComp,e=t.contentSize;if(t.setContentSize(e.height,e.width),this._handle){var n=this._handle.node.position;this._direction===fst.Horizontal?this._handle.node.setPosition(n.x,0,n.z):this._handle.node.setPosition(0,n.y,n.z),this._updateHandlePosition()}},K(e,[{key:"handle",get:function(){return this._handle},set:function(t){this._handle!==t&&(this._handle=t)}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(this._direction=t,this._changeLayout())}},{key:"progress",get:function(){return this._progress},set:function(t){this._progress!==t&&(this._progress=t,this._updateHandlePosition())}}]),e}(Ku),ust.Direction=fst,st((ost=hst).prototype,"handle",[Jat,Qat],Object.getOwnPropertyDescriptor(ost.prototype,"handle"),ost.prototype),st(ost.prototype,"direction",[Zat,$at],Object.getOwnPropertyDescriptor(ost.prototype,"direction"),ost.prototype),st(ost.prototype,"progress",[Fc,tst,est],Object.getOwnPropertyDescriptor(ost.prototype,"progress"),ost.prototype),ast=st(ost.prototype,"slideEvents",[nst,vc,ist],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sst=st(ost.prototype,"_handle",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cst=st(ost.prototype,"_direction",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fst.Horizontal}}),lst=st(ost.prototype,"_progress",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),rst=ost))||rst)||rst)||rst)||rst)||rst));function Lst(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];return Object.assign.apply(Object,[{}].concat(e))}c.Slider=Nst,function(t){t.TOGGLE="toggle"}(Ost||(Ost={}));var Fst,zst,Gst,Vst,Ust,kst,Hst,jst,Wst,qst,Xst,Yst,Kst=function(e){return t({Toggle:e,ToggleComponent:e}),e}((dst=hc("cc.Toggle"),mst=wc(),vst=fc(110),gst=Ac(),yst=_c(RH),xst=zc(),Sst=Bc(),Cst=Wc(iY),Ast=zc(),bst=Bc(),Tst=Wc([ML]),Est=Bc(),dst(wst=mst(wst=vst(wst=gst(wst=yst((Mst=Bst=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"checkEvents",Ist,it(e)),at(e,"_isChecked",Rst,it(e)),at(e,"_checkMark",Dst,it(e)),e}Q(e,t);var n=e.prototype;return n._internalToggle=function(){this.isChecked=!this.isChecked},n._set=function(t,e){if(void 0===e&&(e=!0),this._isChecked!=t){this._isChecked=t;var n=this._toggleContainer;n&&n.enabled&&this.enabled&&(t||!n.anyTogglesChecked()&&!n.allowSwitchOff)&&(this._isChecked=!0,n.notifyToggleCheck(this,e)),this.playEffect(),e&&this._emitToggleEvents()}},n.playEffect=function(){this._checkMark&&(this._checkMark.node.active=this._isChecked)},n.setIsCheckedWithoutNotify=function(t){this._set(t,!1)},n.onEnable=function(){t.prototype.onEnable.call(this),this.playEffect(),this.node.on(e.EventType.CLICK,this._internalToggle,this)},n.onDisable=function(){t.prototype.onDisable.call(this),this.node.off(e.EventType.CLICK,this._internalToggle,this)},n.OnDestroy=function(){var t=this._toggleContainer;t&&t.ensureValidState()},n._emitToggleEvents=function(){this.node.emit(e.EventType.TOGGLE,this),this.checkEvents&&ML.emitEvents(this.checkEvents,this)},K(e,[{key:"isChecked",get:function(){return this._isChecked},set:function(t){this._set(t)}},{key:"checkMark",get:function(){return this._checkMark},set:function(t){this._checkMark!==t&&(this._checkMark=t)}},{key:"_resizeToTarget",set:function(t){t&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){var t=this.node.parent;return c.Node.isNode(t)?t.getComponent("cc.ToggleContainer"):null}}]),e}(unt),Bst.EventType=Lst(Ost,cnt),st((Pst=Mst).prototype,"isChecked",[xst,Sst],Object.getOwnPropertyDescriptor(Pst.prototype,"isChecked"),Pst.prototype),st(Pst.prototype,"checkMark",[Cst,Ast,bst],Object.getOwnPropertyDescriptor(Pst.prototype,"checkMark"),Pst.prototype),Ist=st(Pst.prototype,"checkEvents",[Tst,vc,Est],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Rst=st(Pst.prototype,"_isChecked",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Dst=st(Pst.prototype,"_checkMark",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wst=Pst))||wst)||wst)||wst)||wst)||wst));c.Toggle=Kst;var Jst,Qst,Zst,$st,tct,ect,nct,ict,rct,oct,act,sct,cct,lct,uct,hct,_ct,fct,pct,dct,mct,vct,gct,yct,xct,Sct,Cct,Act,bct,Tct,Ect,wct,Pct,Ict,Rct,Dct,Bct,Mct,Oct,Nct,Lct,Fct,zct,Gct,Vct,Uct=function(e){return t({ToggleContainer:e,ToggleContainerComponent:e}),e}((Fst=hc("cc.ToggleContainer"),zst=wc(),Gst=fc(110),Vst=Ac(),Ust=Bc(),kst=Wc([ML]),Hst=Bc(),Fst(jst=zst(jst=Gst(jst=Vst(jst=Cc((Yst=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"_allowSwitchOff",qst,it(e)),at(e,"checkEvents",Xst,it(e)),e}Q(e,t);var n=e.prototype;return n.onEnable=function(){this.ensureValidState(),this.node.on(FA.CHILD_ADDED,this.ensureValidState,this),this.node.on(FA.CHILD_REMOVED,this.ensureValidState,this)},n.onDisable=function(){this.node.off(FA.CHILD_ADDED,this.ensureValidState,this),this.node.off(FA.CHILD_REMOVED,this.ensureValidState,this)},n.activeToggles=function(){return this.toggleItems.filter((function(t){return t.isChecked}))},n.anyTogglesChecked=function(){return!!this.toggleItems.find((function(t){return t.isChecked}))},n.notifyToggleCheck=function(t,e){if(void 0===e&&(e=!0),this.enabledInHierarchy){for(var n=0;n<this.toggleItems.length;n++){var i=this.toggleItems[n];i!==t&&(e?i.isChecked=!1:i.setIsCheckedWithoutNotify(!1))}this.checkEvents&&c.Component.EventHandler.emitEvents(this.checkEvents,t)}},n.ensureValidState=function(){var t=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==t.length){var e=t[0];e.isChecked=!0,this.notifyToggleCheck(e)}var n=this.activeToggles();if(n.length>1)for(var i=n[0],r=0;r<n.length;++r){var o=n[r];o!==i&&(o.isChecked=!1)}},K(e,[{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(t){this._allowSwitchOff=t}},{key:"toggleItems",get:function(){return this.node.children.map((function(t){var e=t.getComponent("cc.Toggle");return e&&e.enabled?e:null})).filter(Boolean)}}]),e}(Ku),qst=st((Wst=Yst).prototype,"_allowSwitchOff",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),st(Wst.prototype,"allowSwitchOff",[Ust],Object.getOwnPropertyDescriptor(Wst.prototype,"allowSwitchOff"),Wst.prototype),Xst=st(Wst.prototype,"checkEvents",[kst,vc,Hst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jst=Wst))||jst)||jst)||jst)||jst)||jst));c.ToggleContainer=Uct;var kct,Hct,jct=new Wn;function Wct(t){return t instanceof mD?UM:t._uiProps.uiTransformComp?t._uiProps.uiTransformComp.contentSize:Zn.ZERO}function qct(t,e,n,i){t.parent?jct.set(t.parent.getScale().x,t.parent.getScale().y):jct.set(0,0);for(var r=jct.x,o=jct.y,a=0,s=0,c=t.parent;;){if(!c)return n.x=n.y=0,void(i.x=i.y=1);var l=c.getPosition();if(a+=l.x,s+=l.y,(c=c.parent)===e)break;c?jct.set(c.getScale().x,c.getScale().y):jct.set(0,0);var u=jct.x,h=jct.y;a*=u,s*=h,r*=u,o*=h}i.x=0!==r?1/r:1,i.y=0!==o?1/o:1,n.x=-a,n.y=-s}!function(t){t[t.ONCE=0]="ONCE",t[t.ALWAYS=1]="ALWAYS",t[t.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(kct||(kct={})),ae(kct),function(t){t[t.TOP=1]="TOP",t[t.MID=2]="MID",t[t.BOT=4]="BOT",t[t.LEFT=8]="LEFT",t[t.CENTER=16]="CENTER",t[t.RIGHT=32]="RIGHT",t[t.HORIZONTAL=56]="HORIZONTAL",t[t.VERTICAL=7]="VERTICAL"}(Hct||(Hct={}));var Xct,Yct,Kct,Jct,Qct,Zct,$ct,tlt,elt,nlt,ilt,rlt,olt,alt,slt,clt,llt,ult,hlt,_lt=Hct.TOP|Hct.BOT,flt=Hct.LEFT|Hct.RIGHT,plt=function(e){return t({Widget:e,WidgetComponent:e}),e}((Jst=hc("cc.Widget"),Qst=wc(),Zst=fc(110),$st=Ac(),tct=_c(RH),ect=Wc(GT),nct=Bc(),ict=Bc(),rct=Bc(),oct=Bc(),act=Bc(),sct=Bc(),cct=Bc(),lct=Ic(),uct=Ic(),hct=Bc(),_ct=Bc(),fct=Bc(),pct=Bc(),dct=Bc(),mct=Bc(),vct=Wc(kct),gct=Bc(),Jst(yct=Qst(yct=Zst(yct=$st(yct=tct(yct=Cc((Vct=Gct=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(e=t.call.apply(t,[this].concat(i))||this)._lastPos=new En,e._lastSize=new Zn,e._dirty=!0,e._hadAlignOnce=!1,at(e,"_alignFlags",Sct,it(e)),at(e,"_target",Cct,it(e)),at(e,"_left",Act,it(e)),at(e,"_right",bct,it(e)),at(e,"_top",Tct,it(e)),at(e,"_bottom",Ect,it(e)),at(e,"_horizontalCenter",wct,it(e)),at(e,"_verticalCenter",Pct,it(e)),at(e,"_isAbsLeft",Ict,it(e)),at(e,"_isAbsRight",Rct,it(e)),at(e,"_isAbsTop",Dct,it(e)),at(e,"_isAbsBottom",Bct,it(e)),at(e,"_isAbsHorizontalCenter",Mct,it(e)),at(e,"_isAbsVerticalCenter",Oct,it(e)),at(e,"_originalWidth",Nct,it(e)),at(e,"_originalHeight",Lct,it(e)),at(e,"_alignMode",Fct,it(e)),at(e,"_lockFlags",zct,it(e)),e}Q(e,t);var n=e.prototype;return n.updateAlignment=function(){c._widgetManager.updateAlignment(this.node)},n._validateTargetInDEV=function(){},n.setDirty=function(){this._recursiveDirty()},n.onEnable=function(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),c._widgetManager.add(this),this._hadAlignOnce=!1,this._registerEvent(),this._registerTargetEvents()},n.onDisable=function(){c._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()},n.onDestroy=function(){this._removeParentEvent()},n._adjustWidgetToAllowMovingInEditor=function(){},n._adjustWidgetToAllowResizingInEditor=function(){},n._adjustWidgetToAnchorChanged=function(){this.setDirty()},n._adjustTargetToParentChanged=function(t){t&&this._unregisterOldParentEvents(t),this.node.getParent()&&this._registerTargetEvents(),this._setDirtyByMode()},n._registerEvent=function(){this.node.on(FA.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.on(FA.SIZE_CHANGED,this._setDirtyByMode,this),this.node.on(FA.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(FA.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._unregisterEvent=function(){this.node.off(FA.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.off(FA.SIZE_CHANGED,this._setDirtyByMode,this),this.node.off(FA.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)},n._removeParentEvent=function(){this.node.off(FA.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._autoChangedValue=function(t,e){if((this._alignFlags&t)>0){var n=this.node.parent&&this.node.parent._uiProps,i=n&&n.uiTransformComp,r=i?i.contentSize:UM;this.isAlignLeft&&t===Hct.LEFT?this._left=e?this._left*r.width:this._left/r.width:this.isAlignRight&&t===Hct.RIGHT?this._right=e?this._right*r.width:this._right/r.width:this.isAlignHorizontalCenter&&t===Hct.CENTER?this._horizontalCenter=e?this._horizontalCenter*r.width:this._horizontalCenter/r.width:this.isAlignTop&&t===Hct.TOP?this._top=e?this._top*r.height:this._top/r.height:this.isAlignBottom&&t===Hct.BOT?this._bottom=e?this._bottom*r.height:this._bottom/r.height:this.isAbsoluteVerticalCenter&&t===Hct.MID&&(this._verticalCenter=this._verticalCenter/r.height),this._recursiveDirty()}},n._registerTargetEvents=function(){var t=this._target||this.node.parent;t&&t.getComponent(RH)&&(t.on(FA.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.on(FA.SIZE_CHANGED,this._setDirtyByMode,this),t.on(FA.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterTargetEvents=function(){var t=this._target||this.node.parent;t&&(t.off(FA.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.off(FA.SIZE_CHANGED,this._setDirtyByMode,this),t.off(FA.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterOldParentEvents=function(t){var e=this._target||t;e&&(e.off(FA.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.off(FA.SIZE_CHANGED,this._setDirtyByMode,this))},n._setDirtyByMode=function(){this.alignMode===kct.ALWAYS&&this._recursiveDirty()},n._setAlign=function(t,e){if(e!==(this._alignFlags&t)>0){var n=(t&flt)>0,i=this.node._uiProps.uiTransformComp;e?(this._alignFlags|=t,n?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=i.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=i.height))):(n?this.isStretchWidth&&(i.width=this._originalWidth):this.isStretchHeight&&(i.height=this._originalHeight),this._alignFlags&=~t)}},n._recursiveDirty=function(){this._dirty||(this._dirty=!0)},K(e,[{key:"target",get:function(){return this._target},set:function(t){this._target!==t&&(this._unregisterTargetEvents(),this._target=t,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return(this._alignFlags&Hct.TOP)>0},set:function(t){this._setAlign(Hct.TOP,t),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return(this._alignFlags&Hct.BOT)>0},set:function(t){this._setAlign(Hct.BOT,t),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return(this._alignFlags&Hct.LEFT)>0},set:function(t){this._setAlign(Hct.LEFT,t),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return(this._alignFlags&Hct.RIGHT)>0},set:function(t){this._setAlign(Hct.RIGHT,t),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return(this._alignFlags&Hct.MID)>0},set:function(t){t?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=Hct.MID):this._alignFlags&=~Hct.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return(this._alignFlags&Hct.CENTER)>0},set:function(t){t?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=Hct.CENTER):this._alignFlags&=~Hct.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&flt)===flt}},{key:"isStretchHeight",get:function(){return(this._alignFlags&_lt)===_lt}},{key:"top",get:function(){return this._top},set:function(t){this._top=t,this._recursiveDirty()}},{key:"editorTop",get:function(){return this._isAbsTop?this._top:100*this._top},set:function(t){this._top=this._isAbsTop?t:t/100,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(t){this._bottom=t,this._recursiveDirty()}},{key:"editorBottom",get:function(){return this._isAbsBottom?this._bottom:100*this._bottom},set:function(t){this._bottom=this._isAbsBottom?t:t/100,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(t){this._left=t,this._recursiveDirty()}},{key:"editorLeft",get:function(){return this._isAbsLeft?this._left:100*this._left},set:function(t){this._left=this._isAbsLeft?t:t/100,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(t){this._right=t,this._recursiveDirty()}},{key:"editorRight",get:function(){return this._isAbsRight?this._right:100*this._right},set:function(t){this._right=this._isAbsRight?t:t/100,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(t){this._horizontalCenter=t,this._recursiveDirty()}},{key:"editorHorizontalCenter",get:function(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter},set:function(t){this._horizontalCenter=this._isAbsHorizontalCenter?t:t/100,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(t){this._verticalCenter=t,this._recursiveDirty()}},{key:"editorVerticalCenter",get:function(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter},set:function(t){this._verticalCenter=this._isAbsVerticalCenter?t:t/100,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(t){this._isAbsTop!==t&&(this._isAbsTop=t,this._autoChangedValue(Hct.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(t){this._isAbsBottom!==t&&(this._isAbsBottom=t,this._autoChangedValue(Hct.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(t){this._isAbsLeft!==t&&(this._isAbsLeft=t,this._autoChangedValue(Hct.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(t){this._isAbsRight!==t&&(this._isAbsRight=t,this._autoChangedValue(Hct.RIGHT,this._isAbsRight))}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(t){this._isAbsHorizontalCenter!==t&&(this._isAbsHorizontalCenter=t,this._autoChangedValue(Hct.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(t){this._isAbsVerticalCenter!==t&&(this._isAbsVerticalCenter=t,this._autoChangedValue(Hct.MID,this._isAbsVerticalCenter))}},{key:"alignMode",get:function(){return this._alignMode},set:function(t){this._alignMode=t,this._recursiveDirty()}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(t){this._alignFlags!==t&&(this._alignFlags=t,this._recursiveDirty())}}]),e}(Ku),Gct.AlignMode=kct,st((xct=Vct).prototype,"target",[ect,nct],Object.getOwnPropertyDescriptor(xct.prototype,"target"),xct.prototype),st(xct.prototype,"isAlignTop",[ict],Object.getOwnPropertyDescriptor(xct.prototype,"isAlignTop"),xct.prototype),st(xct.prototype,"isAlignBottom",[rct],Object.getOwnPropertyDescriptor(xct.prototype,"isAlignBottom"),xct.prototype),st(xct.prototype,"isAlignLeft",[oct],Object.getOwnPropertyDescriptor(xct.prototype,"isAlignLeft"),xct.prototype),st(xct.prototype,"isAlignRight",[act],Object.getOwnPropertyDescriptor(xct.prototype,"isAlignRight"),xct.prototype),st(xct.prototype,"isAlignVerticalCenter",[sct],Object.getOwnPropertyDescriptor(xct.prototype,"isAlignVerticalCenter"),xct.prototype),st(xct.prototype,"isAlignHorizontalCenter",[cct],Object.getOwnPropertyDescriptor(xct.prototype,"isAlignHorizontalCenter"),xct.prototype),st(xct.prototype,"isStretchWidth",[lct],Object.getOwnPropertyDescriptor(xct.prototype,"isStretchWidth"),xct.prototype),st(xct.prototype,"isStretchHeight",[uct],Object.getOwnPropertyDescriptor(xct.prototype,"isStretchHeight"),xct.prototype),st(xct.prototype,"top",[hct],Object.getOwnPropertyDescriptor(xct.prototype,"top"),xct.prototype),st(xct.prototype,"editorTop",[Pc],Object.getOwnPropertyDescriptor(xct.prototype,"editorTop"),xct.prototype),st(xct.prototype,"bottom",[_ct],Object.getOwnPropertyDescriptor(xct.prototype,"bottom"),xct.prototype),st(xct.prototype,"editorBottom",[Pc],Object.getOwnPropertyDescriptor(xct.prototype,"editorBottom"),xct.prototype),st(xct.prototype,"left",[fct],Object.getOwnPropertyDescriptor(xct.prototype,"left"),xct.prototype),st(xct.prototype,"editorLeft",[Pc],Object.getOwnPropertyDescriptor(xct.prototype,"editorLeft"),xct.prototype),st(xct.prototype,"right",[pct],Object.getOwnPropertyDescriptor(xct.prototype,"right"),xct.prototype),st(xct.prototype,"editorRight",[Pc],Object.getOwnPropertyDescriptor(xct.prototype,"editorRight"),xct.prototype),st(xct.prototype,"horizontalCenter",[dct],Object.getOwnPropertyDescriptor(xct.prototype,"horizontalCenter"),xct.prototype),st(xct.prototype,"editorHorizontalCenter",[Pc],Object.getOwnPropertyDescriptor(xct.prototype,"editorHorizontalCenter"),xct.prototype),st(xct.prototype,"verticalCenter",[mct],Object.getOwnPropertyDescriptor(xct.prototype,"verticalCenter"),xct.prototype),st(xct.prototype,"editorVerticalCenter",[Pc],Object.getOwnPropertyDescriptor(xct.prototype,"editorVerticalCenter"),xct.prototype),st(xct.prototype,"isAbsoluteTop",[Pc],Object.getOwnPropertyDescriptor(xct.prototype,"isAbsoluteTop"),xct.prototype),st(xct.prototype,"isAbsoluteBottom",[Pc],Object.getOwnPropertyDescriptor(xct.prototype,"isAbsoluteBottom"),xct.prototype),st(xct.prototype,"isAbsoluteLeft",[Pc],Object.getOwnPropertyDescriptor(xct.prototype,"isAbsoluteLeft"),xct.prototype),st(xct.prototype,"isAbsoluteRight",[Pc],Object.getOwnPropertyDescriptor(xct.prototype,"isAbsoluteRight"),xct.prototype),st(xct.prototype,"isAbsoluteHorizontalCenter",[Pc],Object.getOwnPropertyDescriptor(xct.prototype,"isAbsoluteHorizontalCenter"),xct.prototype),st(xct.prototype,"isAbsoluteVerticalCenter",[Pc],Object.getOwnPropertyDescriptor(xct.prototype,"isAbsoluteVerticalCenter"),xct.prototype),st(xct.prototype,"alignMode",[vct,gct],Object.getOwnPropertyDescriptor(xct.prototype,"alignMode"),xct.prototype),st(xct.prototype,"alignFlags",[Pc],Object.getOwnPropertyDescriptor(xct.prototype,"alignFlags"),xct.prototype),Sct=st(xct.prototype,"_alignFlags",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Cct=st(xct.prototype,"_target",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Act=st(xct.prototype,"_left",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bct=st(xct.prototype,"_right",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Tct=st(xct.prototype,"_top",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ect=st(xct.prototype,"_bottom",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wct=st(xct.prototype,"_horizontalCenter",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Pct=st(xct.prototype,"_verticalCenter",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ict=st(xct.prototype,"_isAbsLeft",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Rct=st(xct.prototype,"_isAbsRight",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Dct=st(xct.prototype,"_isAbsTop",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Bct=st(xct.prototype,"_isAbsBottom",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Mct=st(xct.prototype,"_isAbsHorizontalCenter",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Oct=st(xct.prototype,"_isAbsVerticalCenter",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Nct=st(xct.prototype,"_originalWidth",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Lct=st(xct.prototype,"_originalHeight",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Fct=st(xct.prototype,"_alignMode",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kct.ON_WINDOW_RESIZE}}),zct=st(xct.prototype,"_lockFlags",[vc,yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yct=xct))||yct)||yct)||yct)||yct)||yct)||yct));c.internal.computeInverseTransForTarget=qct,c.internal.getReadonlyNodeSize=Wct,c.Widget=plt;var dlt,mlt=new bn;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(dlt||(dlt={})),ae(dlt);var vlt,glt,ylt,xlt,Slt,Clt,Alt,blt,Tlt,Elt,wlt,Plt,Ilt,Rlt,Dlt,Blt,Mlt,Olt,Nlt,Llt,Flt,zlt,Glt,Vlt,Ult,klt,Hlt,jlt,Wlt,qlt,Xlt,Ylt,Klt,Jlt,Qlt,Zlt,$lt,tut,eut,nut,iut,rut,out,aut=function(e){return t({PageViewIndicator:e,PageViewIndicatorComponent:e}),e}((Xct=hc("cc.PageViewIndicator"),Yct=wc(),Kct=fc(110),Jct=Ac(),Qct=Wc(ik),Zct=Bc(),$ct=Wc(dlt),tlt=Bc(),elt=Wc(Zn),nlt=Bc(),ilt=Bc(),Xct(rlt=Yct(rlt=Kct(rlt=Jct((hlt=ult=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"spacing",alt,it(e)),at(e,"_spriteFrame",slt,it(e)),at(e,"_direction",clt,it(e)),at(e,"_cellSize",llt,it(e)),e._layout=null,e._pageView=null,e._indicators=[],e}Q(e,t);var n=e.prototype;return n.onLoad=function(){this._updateLayout()},n.setPageView=function(t){this._pageView=t,this._refresh()},n._updateLayout=function(){this._layout=this.getComponent(sot),this._layout||(this._layout=this.addComponent(sot));var t=this._layout;this.direction===dlt.HORIZONTAL?(t.type=sot.Type.HORIZONTAL,t.spacingX=this.spacing):this.direction===dlt.VERTICAL&&(t.type=sot.Type.VERTICAL,t.spacingY=this.spacing),t.resizeMode=sot.ResizeMode.CONTAINER},n._createIndicator=function(){var t=new GT;t.layer=this.node.layer;var e=t.addComponent(iY);return e.spriteFrame=this.spriteFrame,e.sizeMode=iY.SizeMode.CUSTOM,t.parent=this.node,t._uiProps.uiTransformComp.setContentSize(this._cellSize),t},n._changedState=function(){var t=this._indicators;if(0!==t.length&&this._pageView){var e=this._pageView.curPageIdx;if(!(e>=t.length)){for(var n=0;n<t.length;++n){var i=t[n];if(i._uiProps.uiComp){var r=i._uiProps.uiComp;mlt.set(r.color),mlt.a=127.5,r.color=mlt}}if(t[e]._uiProps.uiComp){var o=t[e]._uiProps.uiComp;mlt.set(o.color),mlt.a=255,o.color=mlt}}}},n._refresh=function(){if(this._pageView){var t=this._indicators,e=this._pageView.getPages();if(e.length!==t.length){var n=0;if(e.length>t.length)for(n=0;n<e.length;++n)t[n]||(t[n]=this._createIndicator());else for(n=t.length-e.length;n>0;--n){var i=t[n-1];this.node.removeChild(i),t.splice(n-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}},K(e,[{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(t){this._spriteFrame!==t&&(this._spriteFrame=t)}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(this._direction=t)}},{key:"cellSize",get:function(){return this._cellSize},set:function(t){this._cellSize!==t&&(this._cellSize=t)}}]),e}(Ku),ult.Direction=dlt,st((olt=hlt).prototype,"spriteFrame",[Qct,Zct],Object.getOwnPropertyDescriptor(olt.prototype,"spriteFrame"),olt.prototype),st(olt.prototype,"direction",[$ct,tlt],Object.getOwnPropertyDescriptor(olt.prototype,"direction"),olt.prototype),st(olt.prototype,"cellSize",[elt,nlt],Object.getOwnPropertyDescriptor(olt.prototype,"cellSize"),olt.prototype),alt=st(olt.prototype,"spacing",[vc,ilt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),slt=st(olt.prototype,"_spriteFrame",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),clt=st(olt.prototype,"_direction",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dlt.HORIZONTAL}}),llt=st(olt.prototype,"_cellSize",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zn(20,20)}}),rlt=olt))||rlt)||rlt)||rlt)||rlt));c.PageViewIndicator=aut;var sut,cut,lut,uut=new Wn;!function(t){t[t.Unified=0]="Unified",t[t.Free=1]="Free"}(sut||(sut={})),ae(sut),function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(cut||(cut={})),ae(cut),function(t){t.PAGE_TURNING="page-turning"}(lut||(lut={}));var hut=function(e){return t({PageView:e,PageViewComponent:e}),e}((vlt=hc("cc.PageView"),glt=wc(),ylt=fc(110),xlt=Ac(),Slt=Wc(sut),Clt=Bc(),Alt=Wc(cut),blt=Bc(),Tlt=Mc(),Elt=Bc(),wlt=Mc(),Plt=Bc(),Ilt=Wc(aut),Rlt=Bc(),Dlt=Bc(),Blt=Wc(Uot),Mlt=Ic(),Olt=Wc(Uot),Nlt=Ic(),Llt=Ic(),Flt=Ic(),zlt=Ic(),Glt=Wc([ML]),Vlt=Ic(),Ult=Bc(),klt=Wc([ML]),Hlt=Bc(),vlt(jlt=glt(jlt=ylt(jlt=xlt((out=rut=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"autoPageTurningThreshold",qlt,it(e)),at(e,"horizontal",Xlt,it(e)),at(e,"vertical",Ylt,it(e)),at(e,"cancelInnerEvents",Klt,it(e)),at(e,"scrollEvents",Jlt,it(e)),at(e,"pageTurningSpeed",Qlt,it(e)),at(e,"pageEvents",Zlt,it(e)),at(e,"_sizeMode",$lt,it(e)),at(e,"_direction",tut,it(e)),at(e,"_scrollThreshold",eut,it(e)),at(e,"_pageTurningEventTiming",nut,it(e)),at(e,"_indicator",iut,it(e)),e._curPageIdx=0,e._lastPageIdx=0,e._pages=[],e._initContentPos=new En,e._scrollCenterOffsetX=[],e._scrollCenterOffsetY=[],e._touchBeganPosition=new Wn,e._touchEndPosition=new Wn,e}Q(e,t);var n=e.prototype;return n.onEnable=function(){t.prototype.onEnable.call(this),this.node.on(FA.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.on(e.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onDisable=function(){t.prototype.onDisable.call(this),this.node.off(FA.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.off(e.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onLoad=function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)},n.getCurrentPageIndex=function(){return this._curPageIdx},n.setCurrentPageIndex=function(t){this.scrollToPage(t,1)},n.getPages=function(){return this._pages},n.addPage=function(t){t&&-1===this._pages.indexOf(t)&&this.content&&(t._uiProps.uiTransformComp?(this.content.addChild(t),this._pages.push(t),this._updatePageView()):w(4301))},n.insertPage=function(t,e){if(!(e<0)&&t&&-1===this._pages.indexOf(t)&&this.content)if(e>=this._pages.length)this.addPage(t);else{if(!t._uiProps.uiTransformComp)return void w(4301);this._pages.splice(e,0,t),this.content.insertChild(t,e),this._updatePageView()}},n.removePage=function(t){if(t&&this.content){var e=this._pages.indexOf(t);-1!==e?this.removePageAtIndex(e):I(4300,t.name)}},n.removePageAtIndex=function(t){var e=this._pages;if(!(t<0||t>=e.length)){var n=e[t];n&&this.content&&(this.content.removeChild(n),e.splice(t,1),this._updatePageView())}},n.removeAllPages=function(){if(this.content){for(var t=this._pages,e=0,n=t.length;e<n;e++)this.content.removeChild(t[e]);this._pages.length=0,this._updatePageView()}},n.scrollToPage=function(t,e){void 0===e&&(e=.3),t<0||t>=this._pages.length||(this._curPageIdx=t,this.scrollToOffset(this._moveOffsetValue(t),e,!0),this.indicator&&this.indicator._changedState())},n.getScrollEndedEventTiming=function(){return this.pageTurningEventTiming},n._updatePageView=function(){if(this.content){var t=this.content.getComponent(sot);t&&t.enabled&&t.updateLayout();var e=this._pages.length;this._curPageIdx>=e&&(this._curPageIdx=0===e?0:e-1,this._lastPageIdx=this._curPageIdx);for(var n=this._initContentPos,i=0;i<e;++i){var r=this._pages[i].position;this.direction===cut.Horizontal?this._scrollCenterOffsetX[i]=Math.abs(n.x+r.x):this._scrollCenterOffsetY[i]=Math.abs(n.y+r.y)}this.indicator&&this.indicator._refresh()}},n._updateAllPagesSize=function(){var t=this.view;if(this.content&&t&&this._sizeMode===sut.Unified)for(var e=this._pages,n=t.contentSize,i=0,r=e.length;i<r;i++)e[i]._uiProps.uiTransformComp.setContentSize(n)},n._handleReleaseLogic=function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(e.EventType.SCROLL_ENDED))},n._onTouchBegan=function(e,n){e.touch.getUILocation(uut),Wn.set(this._touchBeganPosition,uut.x,uut.y),t.prototype._onTouchBegan.call(this,e,n)},n._onTouchMoved=function(e,n){t.prototype._onTouchMoved.call(this,e,n)},n._onTouchEnded=function(e,n){e.touch.getUILocation(uut),Wn.set(this._touchEndPosition,uut.x,uut.y),t.prototype._onTouchEnded.call(this,e,n)},n._onTouchCancelled=function(e,n){e.touch.getUILocation(uut),Wn.set(this._touchEndPosition,uut.x,uut.y),t.prototype._onTouchCancelled.call(this,e,n)},n._onMouseWheel=function(){},n._syncScrollDirection=function(){this.horizontal=this.direction===cut.Horizontal,this.vertical=this.direction===cut.Vertical},n._syncSizeMode=function(){var t=this.view;if(this.content&&t){var e=this.content.getComponent(sot);if(e){if(this._sizeMode===sut.Free&&this._pages.length>0){var n=this._pages[0]._uiProps.uiTransformComp,i=this._pages[this._pages.length-1]._uiProps.uiTransformComp;this.direction===cut.Horizontal?(e.paddingLeft=(t.width-n.width)/2,e.paddingRight=(t.width-i.width)/2):this.direction===cut.Vertical&&(e.paddingTop=(t.height-n.height)/2,e.paddingBottom=(t.height-i.height)/2)}e.updateLayout()}}},n._initPages=function(){if(this.content){this._initContentPos=this.content.position;for(var t=this.content.children,e=0;e<t.length;++e){var n=t[e];this._pages.indexOf(n)>=0||this._pages.push(n)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}},n._dispatchPageTurningEvent=function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,ML.emitEvents(this.pageEvents,this,lut.PAGE_TURNING),this.node.emit(lut.PAGE_TURNING,this))},n._isQuicklyScrollable=function(t){if(this.direction===cut.Horizontal){if(Math.abs(t.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===cut.Vertical&&Math.abs(t.y)>this.autoPageTurningThreshold)return!0;return!1},n._moveOffsetValue=function(t){var e=new Wn;if(this._sizeMode===sut.Free)this.direction===cut.Horizontal?e.x=this._scrollCenterOffsetX[t]:this.direction===cut.Vertical&&(e.y=this._scrollCenterOffsetY[t]);else{var n=this.view;if(!n)return e;this.direction===cut.Horizontal?e.x=t*n.width:this.direction===cut.Vertical&&(e.y=t*n.height)}return e},n._getDragDirection=function(t){return this._direction===cut.Horizontal?0===t.x?0:t.x>0?1:-1:0===t.y?0:t.y<0?1:-1},n._isScrollable=function(t,e,n){if(this._sizeMode===sut.Free){var i=0,r=0;if(this.direction===cut.Horizontal)return i=this._scrollCenterOffsetX[e],r=this._scrollCenterOffsetX[n],Math.abs(t.x)>=Math.abs(i-r)*this.scrollThreshold;if(this.direction===cut.Vertical)return i=this._scrollCenterOffsetY[e],r=this._scrollCenterOffsetY[n],Math.abs(t.y)>=Math.abs(i-r)*this.scrollThreshold}else{var o=this.view;if(!o)return!1;if(this.direction===cut.Horizontal)return Math.abs(t.x)>=o.width*this.scrollThreshold;if(this.direction===cut.Vertical)return Math.abs(t.y)>=o.height*this.scrollThreshold}return!1},n._autoScrollToPage=function(){if(this._startBounceBackIfNeeded()){var t=this._getHowMuchOutOfBoundary();this._clampDelta(t),(t.x>0||t.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(t.x<0||t.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{var e=new Wn;Wn.subtract(e,this._touchBeganPosition,this._touchEndPosition);var n=this._curPageIdx,i=n+this._getDragDirection(e),r=this.pageTurningSpeed*Math.abs(n-i);if(i<this._pages.length){if(this._isScrollable(e,n,i))return void this.scrollToPage(i,r);var o=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(o))return void this.scrollToPage(i,r)}this.scrollToPage(n,r)}},K(e,[{key:"sizeMode",get:function(){return this._sizeMode},set:function(t){this._sizeMode!==t&&(this._sizeMode=t,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(t){this._direction!==t&&(this._direction=t,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(t){this._scrollThreshold!==t&&(this._scrollThreshold=t)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(t){this._pageTurningEventTiming!==t&&(this._pageTurningEventTiming=t)}},{key:"indicator",get:function(){return this._indicator},set:function(t){this._indicator!==t&&(this._indicator=t,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return t.prototype.verticalScrollBar},set:function(t){this.verticalScrollBar=t}},{key:"horizontalScrollBar",get:function(){return t.prototype.horizontalScrollBar},set:function(t){this.horizontalScrollBar=t}}]),e}(_st),rut.SizeMode=sut,rut.Direction=cut,rut.EventType=Lst(lut,Fat),st((Wlt=out).prototype,"sizeMode",[Slt,Clt],Object.getOwnPropertyDescriptor(Wlt.prototype,"sizeMode"),Wlt.prototype),st(Wlt.prototype,"direction",[Alt,blt],Object.getOwnPropertyDescriptor(Wlt.prototype,"direction"),Wlt.prototype),st(Wlt.prototype,"scrollThreshold",[Fc,Tlt,Elt],Object.getOwnPropertyDescriptor(Wlt.prototype,"scrollThreshold"),Wlt.prototype),st(Wlt.prototype,"pageTurningEventTiming",[Fc,wlt,Plt],Object.getOwnPropertyDescriptor(Wlt.prototype,"pageTurningEventTiming"),Wlt.prototype),st(Wlt.prototype,"indicator",[Ilt,Rlt],Object.getOwnPropertyDescriptor(Wlt.prototype,"indicator"),Wlt.prototype),qlt=st(Wlt.prototype,"autoPageTurningThreshold",[vc,Dlt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),st(Wlt.prototype,"verticalScrollBar",[Blt,el,Mlt],Object.getOwnPropertyDescriptor(Wlt.prototype,"verticalScrollBar"),Wlt.prototype),st(Wlt.prototype,"horizontalScrollBar",[Olt,el,Nlt],Object.getOwnPropertyDescriptor(Wlt.prototype,"horizontalScrollBar"),Wlt.prototype),Xlt=st(Wlt.prototype,"horizontal",[el,vc,Llt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ylt=st(Wlt.prototype,"vertical",[el,vc,Flt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Klt=st(Wlt.prototype,"cancelInnerEvents",[el,vc,zlt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Jlt=st(Wlt.prototype,"scrollEvents",[Glt,vc,el,Vlt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Qlt=st(Wlt.prototype,"pageTurningSpeed",[vc,Pc,Ult],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),Zlt=st(Wlt.prototype,"pageEvents",[klt,vc,Hlt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$lt=st(Wlt.prototype,"_sizeMode",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sut.Unified}}),tut=st(Wlt.prototype,"_direction",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cut.Horizontal}}),eut=st(Wlt.prototype,"_scrollThreshold",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),nut=st(Wlt.prototype,"_pageTurningEventTiming",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),iut=st(Wlt.prototype,"_indicator",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jlt=Wlt))||jlt)||jlt)||jlt)||jlt));c.PageView=hut;var _ut=new En,fut=new Wn,put=new Wn,dut=new Wn(1,1),mut=new Wn,vut=new Wn;function gut(t,e){if(!e._hadAlignOnce){e.alignMode===kct.ONCE&&(e._hadAlignOnce=!0);var n,i=e.target,r=put,o=dut;i?qct(t,n=i,r,o):n=t.parent;var a=Wct(n),s=n instanceof mD||!n.getComponent(RH),c=s?fut:n.getComponent(RH).anchorPoint,l=s;t.getPosition(_ut);var u=t._uiProps.uiTransformComp,h=_ut.x,_=_ut.y,f=u.anchorPoint,p=t.getScale();if(e.alignFlags&Hct.HORIZONTAL){var d=0,m=0,v=a.width;l?(d=UM.left.x,m=UM.right.x):m=(d=-c.x*v)+v,d+=e.isAbsoluteLeft?e.left:e.left*v,m-=e.isAbsoluteRight?e.right:e.right*v,i&&(d+=r.x,d*=o.x,m+=r.x,m*=o.x);var g=0,y=f.x,x=p.x;if(x<0&&(y=1-y,x=-x),e.isStretchWidth)g=m-d,0!==x&&(u.width=g/x),h=d+y*g;else if(g=u.width*x,e.isAlignHorizontalCenter){var S=e.isAbsoluteHorizontalCenter?e.horizontalCenter:e.horizontalCenter*v,C=(.5-c.x)*a.width;i&&(S*=o.x,C+=r.x,C*=o.x),h=C+(y-.5)*g+S}else h=e.isAlignLeft?d+y*g:m+(y-1)*g;e._lastSize.width=g}if(e.alignFlags&Hct.VERTICAL){var A=0,b=0,T=a.height;l?(b=UM.bottom.y,A=UM.top.y):A=(b=-c.y*T)+T,b+=e.isAbsoluteBottom?e.bottom:e.bottom*T,A-=e.isAbsoluteTop?e.top:e.top*T,i&&(b+=r.y,b*=o.y,A+=r.y,A*=o.y);var E=0,w=f.y,P=p.y;if(P<0&&(w=1-w,P=-P),e.isStretchHeight)E=A-b,0!==P&&(u.height=E/P),_=b+w*E;else if(E=u.height*P,e.isAlignVerticalCenter){var I=e.isAbsoluteVerticalCenter?e.verticalCenter:e.verticalCenter*T,R=(.5-c.y)*a.height;i&&(I*=o.y,R+=r.y,R*=o.y),_=R+(w-.5)*E+I}else _=e.isAlignBottom?b+w*E:A+(w-1)*E;e._lastSize.height=E}t.setPosition(h,_,_ut.z),En.set(e._lastPos,h,_,_ut.z)}}function yut(t){var e=t.getComponent(plt);if(e&&e.enabled){if(!c.isValid(t,!0))return;Cut.push(e)}for(var n,i=ot(t.children);!(n=i()).done;){var r=n.value;r.active&&yut(r)}}function xut(){var t=zM.getScene();if(t){Aut.isAligning=!0,Aut._nodesOrderDirty&&(Cut.length=0,yut(t),Aut._nodesOrderDirty=!1);var e=null,n=Aut._activeWidgetsIterator;for(n.i=0;n.i<Cut.length;++n.i)(e=Cut[n.i])._dirty&&(gut(e.node,e),e._dirty=!1);Aut.isAligning=!1}}var Sut,Cut=[],Aut=t("widgetManager",c._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new te.MutableForwardIterator(Cut),animationState:null,init:function(){zM.on(FM.EVENT_AFTER_SCENE_LAUNCH,xut),zM.on(FM.EVENT_AFTER_UPDATE,xut),jM.instance.on("design-resolution-changed",this.onResized,this);var t=this.onResized.bind(this);jM.instance.on("canvas-resize",t),nh.on("orientation-change",t)},add:function(){this._nodesOrderDirty=!0},remove:function(t){this._activeWidgetsIterator.remove(t)},onResized:function(){var t=zM.getScene();t&&this.refreshWidgetOnResized(t)},refreshWidgetOnResized:function(t){var e=GT.isNode(t)&&t.getComponent(plt);e&&e.enabled&&(e.alignMode===kct.ON_WINDOW_RESIZE||e.alignMode===kct.ALWAYS)&&e.setDirty();for(var n,i=ot(t.children);!(n=i()).done;){var r=n.value;this.refreshWidgetOnResized(r)}},updateOffsetsToStayPut:function(t,e){function n(t,e){return Math.abs(t-e)>1e-10?e:t}var i=t.node,r=i.parent;if(r){var o=mut;o.set(0,0);var a=vut;if(a.set(1,1),t.target&&qct(i,r=t.target,o,a),!e)return;var s=r._uiProps&&r._uiProps.uiTransformComp,c=s?s.anchorPoint:fut,l=i._uiProps.uiTransformComp,u=Wct(r),h=l.anchorPoint,_=i.getPosition(),f=Hct,p=i.getScale(),d=0;if(e&f.LEFT){var m=-c.x*u.width;m+=o.x,m*=a.x,d=_.x-h.x*l.width*p.x-m,t.isAbsoluteLeft||(d/=u.width),d/=a.x,t.left=n(t.left,d)}if(e&f.RIGHT){var v=(1-c.x)*u.width;v+=o.x,d=(v*=a.x)-(_.x+(1-h.x)*l.width*p.x),t.isAbsoluteRight||(d/=u.width),d/=a.x,t.right=n(t.right,d)}if(e&f.TOP){var g=(1-c.y)*u.height;g+=o.y,d=(g*=a.y)-(_.y+(1-h.y)*l.height*p.y),t.isAbsoluteTop||(d/=u.height),d/=a.y,t.top=n(t.top,d)}if(e&f.BOT){var y=-c.y*u.height;y+=o.y,y*=a.y,d=_.y-h.y*l.height*p.y-y,t.isAbsoluteBottom||(d/=u.height),d/=a.y,t.bottom=n(t.bottom,d)}}},updateAlignment:function t(e){var n=e.parent;n&&GT.isNode(n)&&t(n);var i=e.getComponent(plt);i&&n&&gut(e,i)},AlignMode:kct,AlignFlags:Hct});zM.on(FM.EVENT_INIT,(function(){Aut.init()}));var but,Tut,Eut,wut,Put,Iut,Rut,Dut,But,Mut,Out,Nut,Lut,Fut,zut,Gut,Vut,Uut,kut,Hut=function(e){return t({SafeArea:e,SafeAreaComponent:e}),e}(hc("cc.SafeArea")(Sut=wc()(Sut=fc(110)(Sut=Cc(Sut=Ac()(Sut=_c(plt)(Sut=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.onEnable=function(){this.updateArea(),nh.on("window-resize",this.updateArea,this),nh.on("orientation-change",this.updateArea,this)},n.onDisable=function(){nh.off("window-resize",this.updateArea,this),nh.off("orientation-change",this.updateArea,this)},n.updateArea=function(){var t=this.node.getComponent(plt),e=this.node.getComponent(RH);if(t&&e){t.updateAlignment();var n=this.node.position.clone(),i=e.anchorPoint.clone();t.isAlignTop=t.isAlignBottom=t.isAlignLeft=t.isAlignRight=!0;var r=YM.getVisibleSize(),o=r.width,a=r.height,s=oh.getSafeAreaRect();t.top=a-s.y-s.height,t.bottom=s.y,t.left=s.x,t.right=o-s.x-s.width,t.updateAlignment();var c=this.node.position.clone(),l=i.x-(c.x-n.x)/e.width,u=i.y-(c.y-n.y)/e.height;e.setAnchorPoint(l,u),Aut.add(t)}},e}(Ku))||Sut)||Sut)||Sut)||Sut)||Sut)||Sut);c.SafeArea=Hut;var jut,Wut=function(e){return t({UICoordinateTracker:e,UICoordinateTrackerComponent:e}),e}((but=hc("cc.UICoordinateTracker"),Tut=wc(),Eut=Ac(),wut=fc(110),Put=Wc(GT),Iut=Bc(),Rut=Wc(ZL),Dut=Bc(),But=Bc(),Mut=Bc(),Out=Wc([ML]),Nut=Bc(),but(Lut=Tut(Lut=Eut(Lut=wut((st((Fut=function(t){function e(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return at(e=t.call.apply(t,[this].concat(i))||this,"syncEvents",zut,it(e)),at(e,"_target",Gut,it(e)),at(e,"_camera",Vut,it(e)),at(e,"_useScale",Uut,it(e)),at(e,"_distance",kut,it(e)),e._transformPos=new En,e._viewPos=new En,e._canMove=!0,e._lastWPos=new En,e._lastCameraPos=new En,e}Q(e,t);var n=e.prototype;return n.onEnable=function(){this._checkCanMove()},n.update=function(){var t=this.node.worldPosition,e=this._camera;if(this._canMove&&e&&e.camera&&(!this._lastWPos.equals(t)||!this._lastCameraPos.equals(e.node.worldPosition))&&(this._lastWPos.set(t),this._lastCameraPos.set(e.node.worldPosition),e.camera.update(),e.convertToUINode(t,this._target,this._transformPos),this._useScale&&En.transformMat4(this._viewPos,this.node.worldPosition,e.camera.matView),this.syncEvents.length>0)){var n=this._distance/Math.abs(this._viewPos.z);ML.emitEvents(this.syncEvents,this._transformPos,n)}},n._checkCanMove=function(){this._canMove=!(!this._camera||!this._target)},K(e,[{key:"target",get:function(){return this._target},set:function(t){this._target!==t&&(this._target=t,this._checkCanMove())}},{key:"camera",get:function(){return this._camera},set:function(t){this._camera!==t&&(this._camera=t,this._checkCanMove())}},{key:"useScale",get:function(){return this._useScale},set:function(t){this._useScale!==t&&(this._useScale=t)}},{key:"distance",get:function(){return this._distance},set:function(t){this._distance!==t&&(this._distance=t)}}]),e}(Ku)).prototype,"target",[Put,Iut],Object.getOwnPropertyDescriptor(Fut.prototype,"target"),Fut.prototype),st(Fut.prototype,"camera",[Rut,Dut],Object.getOwnPropertyDescriptor(Fut.prototype,"camera"),Fut.prototype),st(Fut.prototype,"useScale",[But],Object.getOwnPropertyDescriptor(Fut.prototype,"useScale"),Fut.prototype),st(Fut.prototype,"distance",[Mut],Object.getOwnPropertyDescriptor(Fut.prototype,"distance"),Fut.prototype),zut=st(Fut.prototype,"syncEvents",[Out,vc,Nut],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Gut=st(Fut.prototype,"_target",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Vut=st(Fut.prototype,"_camera",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Uut=st(Fut.prototype,"_useScale",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),kut=st(Fut.prototype,"_distance",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Lut=Fut))||Lut)||Lut)||Lut)||Lut)),qut=[FA.TOUCH_START,FA.TOUCH_END,FA.TOUCH_MOVE,FA.MOUSE_DOWN,FA.MOUSE_MOVE,FA.MOUSE_UP,FA.MOUSE_ENTER,FA.MOUSE_LEAVE,FA.MOUSE_WHEEL];function Xut(t){t.propagationStopped=!0}var Yut,Kut,Jut,Qut,Zut,$ut,tht,eht,nht,iht,rht,oht,aht=function(e){return t({BlockInputEvents:e,BlockInputEventsComponent:e}),e}(hc("cc.BlockInputEvents")(jut=wc()(jut=Ac()(jut=function(t){function e(){return t.apply(this,arguments)||this}Q(e,t);var n=e.prototype;return n.onEnable=function(){for(var t=0;t<qut.length;t++)this.node.on(qut[t],Xut,this)},n.onDisable=function(){for(var t=0;t<qut.length;t++)this.node.off(qut[t],Xut,this)},e}(Ku))||jut)||jut)||jut),sht={},cht=t("SubContextView",(Yut=hc("cc.SubContextView"),Kut=wc(),Jut=fc(110),Qut=_c(RH),Zut=Ac(),$ut=Bc(),tht=Bc(),Yut(eht=Kut(eht=Jut(eht=Qut(eht=Zut((st((nht=function(t){function e(){var e;return at(e=t.call(this)||this,"_fps",iht,it(e)),e._sprite=void 0,e._imageAsset=void 0,e._texture=void 0,e._updatedTime=0,e._updateInterval=0,e._openDataContext=void 0,e._content=void 0,at(e,"_designResolutionSize",rht,it(e)),e._content=new GT("content"),e._content.hideFlags|=ul.Flags.DontSave|ul.Flags.HideInHierarchy,e._sprite=null,e._imageAsset=new Km,e._openDataContext=null,e._updatedTime=performance.now(),e._texture=new gv,e}Q(e,t);var n=e.prototype;return n.onLoad=function(){sht.getOpenDataContext?(this._updateInterval=1e3/this._fps,this._openDataContext=sht.getOpenDataContext(),this._initSharedCanvas(),this._initContentNode(),this._updateSubContextView(),this._updateContentLayer()):this.enabled=!1},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._unregisterNodeEvent()},n._initSharedCanvas=function(){if(this._openDataContext){var t=this._openDataContext.canvas;t.width=this._designResolutionSize.width,t.height=this._designResolutionSize.height}},n._initContentNode=function(){if(this._openDataContext){var t=this._openDataContext.canvas,e=this._imageAsset;if(e.reset(t),this._texture.image=e,this._texture.create(t.width,t.height),this._sprite=this._content.getComponent(iY),this._sprite||(this._sprite=this._content.addComponent(iY)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._texture;else{var n=new ik;n.texture=this._texture,this._sprite.spriteFrame=n}this._content.parent=this.node}},n._updateSubContextView=function(){if(this._openDataContext){var t=this.node.getComponent(RH),e=this._content.getComponent(RH),n=t.width/e.width,i=t.height/e.height,r=n>i?i:n;e.width*=r,e.height*=r;var o=YM.getViewportRect(),a=e.getBoundingBoxToWorld(),s=YM.getVisibleSize(),c=nh.devicePixelRatio,l=(o.width*(a.x/s.width)+o.x)/c,u=(o.height*(a.y/s.height)+o.y)/c,h=o.width*(a.width/s.width)/c,_=o.height*(a.height/s.height)/c;this._openDataContext.postMessage({fromEngine:!0,type:"engine",event:"viewport",x:l,y:u,width:h,height:_})}},n._updateSubContextTexture=function(){var t=this._imageAsset;if(t&&this._openDataContext&&!(t.width<=0||t.height<=0)){var e=this._openDataContext.canvas;t.reset(e),(e.width>t.width||e.height>t.height)&&this._texture.create(e.width,e.height),this._texture.uploadData(e)}},n._registerNodeEvent=function(){this.node.on(FA.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.on(FA.SIZE_CHANGED,this._updateSubContextView,this),this.node.on(FA.LAYER_CHANGED,this._updateContentLayer,this)},n._unregisterNodeEvent=function(){this.node.off(FA.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.off(FA.SIZE_CHANGED,this._updateSubContextView,this),this.node.off(FA.LAYER_CHANGED,this._updateContentLayer,this)},n._updateContentLayer=function(){this._content.layer=this.node.layer},n.update=function(t){void 0===t?this._updateSubContextTexture():performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture())},n.onDestroy=function(){this._content.destroy(),this._texture.destroy(),this._sprite&&this._sprite.destroy(),this._imageAsset.destroy(),this._openDataContext=null},K(e,[{key:"designResolutionSize",get:function(){return this._designResolutionSize},set:function(){}},{key:"fps",get:function(){return this._fps},set:function(t){this._fps!==t&&(this._fps=t,this._updateInterval=1e3/t)}}]),e}(Ku)).prototype,"designResolutionSize",[$ut],Object.getOwnPropertyDescriptor(nht.prototype,"designResolutionSize"),nht.prototype),st(nht.prototype,"fps",[tht],Object.getOwnPropertyDescriptor(nht.prototype,"fps"),nht.prototype),iht=st(nht.prototype,"_fps",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),rht=st(nht.prototype,"_designResolutionSize",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zn(640,960)}}),eht=nht))||eht)||eht)||eht)||eht)||eht));c.SubContextView=cht;var lht=t("UIReorderComponent",hc("cc.UIReorderComponent")(oht=function(){I(1408,"UIReorderComponent")})||oht);c.UIReorderComponent=lht,c.ButtonComponent=unt,ee.setClassAlias(unt,"cc.ButtonComponent"),c.EditBoxComponent=Lrt,ee.setClassAlias(Lrt,"cc.EditBoxComponent"),c.LayoutComponent=sot,ee.setClassAlias(sot,"cc.LayoutComponent"),c.ProgressBarComponent=Bot,ee.setClassAlias(Bot,"cc.ProgressBarComponent"),c.ScrollViewComponent=_st,ee.setClassAlias(_st,"cc.ScrollViewComponent"),c.ScrollBarComponent=Uot,ee.setClassAlias(Uot,"cc.ScrollBarComponent"),c.SliderComponent=Nst,ee.setClassAlias(Nst,"cc.SliderComponent"),c.ToggleComponent=Kst,ee.setClassAlias(Kst,"cc.ToggleComponent"),c.ToggleContainerComponent=Uct,ee.setClassAlias(Uct,"cc.ToggleContainerComponent"),c.WidgetComponent=plt,ee.setClassAlias(plt,"cc.WidgetComponent"),c.PageViewComponent=hut,ee.setClassAlias(hut,"cc.PageViewComponent"),c.PageViewIndicatorComponent=aut,ee.setClassAlias(aut,"cc.PageViewIndicatorComponent"),c.SafeAreaComponent=Hut,ee.setClassAlias(Hut,"cc.SafeAreaComponent"),ee.setClassAlias(Wut,"cc.UICoordinateTrackerComponent"),c.BlockInputEventsComponent=aht,ee.setClassAlias(aht,"cc.BlockInputEventsComponent")}}}));
